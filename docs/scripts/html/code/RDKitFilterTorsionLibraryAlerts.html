<html>
<head>
<title>MayaChemTools:Code:RDKitFilterTorsionLibraryAlerts.py</title>
<meta http-equiv="content-type" content="text/html;charset=utf-8">
<link rel="stylesheet" type="text/css" href="../../../css/MayaChemToolsPythonCode.css">
</head>
<body leftmargin="20" rightmargin="20" topmargin="10" bottommargin="10">
<br/>
<center>
<a href="http://www.mayachemtools.org" title="MayaChemTools Home"><img src="../../../images/MayaChemToolsLogo.gif" border="0" alt="MayaChemTools"></a>
</center>
<br/>
<pre>
    1 <span class="ch">#!/bin/env python</span>
    2 <span class="c1">#</span>
    3 <span class="c1"># File: RDKitFilterTorsionLibraryAlerts.py</span>
    4 <span class="c1"># Author: Manish Sud &lt;msud@san.rr.com&gt;</span>
    5 <span class="c1">#</span>
    6 <span class="c1"># Collaborator: Pat Walters</span>
    7 <span class="c1">#</span>
    8 <span class="c1"># Acknowledgments: Wolfgang Guba, Patrick Penner, Levi Pierce</span>
    9 <span class="c1">#</span>
   10 <span class="c1"># Copyright (C) 2022 Manish Sud. All rights reserved.</span>
   11 <span class="c1">#</span>
   12 <span class="c1"># This script uses the Torsion Library jointly developed by the University</span>
   13 <span class="c1"># of Hamburg, Center for Bioinformatics, Hamburg, Germany and</span>
   14 <span class="c1"># F. Hoffmann-La-Roche Ltd., Basel, Switzerland.</span>
   15 <span class="c1">#</span>
   16 <span class="c1"># The functionality available in this script is implemented using RDKit, an</span>
   17 <span class="c1"># open source toolkit for cheminformatics developed by Greg Landrum.</span>
   18 <span class="c1">#</span>
   19 <span class="c1"># This file is part of MayaChemTools.</span>
   20 <span class="c1">#</span>
   21 <span class="c1"># MayaChemTools is free software; you can redistribute it and/or modify it under</span>
   22 <span class="c1"># the terms of the GNU Lesser General Public License as published by the Free</span>
   23 <span class="c1"># Software Foundation; either version 3 of the License, or (at your option) any</span>
   24 <span class="c1"># later version.</span>
   25 <span class="c1">#</span>
   26 <span class="c1"># MayaChemTools is distributed in the hope that it will be useful, but without</span>
   27 <span class="c1"># any warranty; without even the implied warranty of merchantability of fitness</span>
   28 <span class="c1"># for a particular purpose.  See the GNU Lesser General Public License for more</span>
   29 <span class="c1"># details.</span>
   30 <span class="c1">#</span>
   31 <span class="c1"># You should have received a copy of the GNU Lesser General Public License</span>
   32 <span class="c1"># along with MayaChemTools; if not, see &lt;http://www.gnu.org/licenses/&gt; or</span>
   33 <span class="c1"># write to the Free Software Foundation Inc., 59 Temple Place, Suite 330,</span>
   34 <span class="c1"># Boston, MA, 02111-1307, USA.</span>
   35 <span class="c1">#</span>
   36 
   37 <span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>
   38 
   39 <span class="c1"># Add local python path to the global path and import standard library modules...</span>
   40 <span class="kn">import</span> <span class="nn">os</span>
   41 <span class="kn">import</span> <span class="nn">sys</span><span class="p">;</span>  <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="s2">&quot;..&quot;</span><span class="p">,</span> <span class="s2">&quot;lib&quot;</span><span class="p">,</span> <span class="s2">&quot;Python&quot;</span><span class="p">))</span>
   42 <span class="kn">import</span> <span class="nn">time</span>
   43 <span class="kn">import</span> <span class="nn">re</span>
   44 <span class="kn">import</span> <span class="nn">glob</span>
   45 <span class="kn">import</span> <span class="nn">multiprocessing</span> <span class="kn">as</span> <span class="nn">mp</span>
   46 <span class="kn">import</span> <span class="nn">math</span>
   47 <span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
   48 
   49 <span class="c1"># RDKit imports...</span>
   50 <span class="k">try</span><span class="p">:</span>
   51     <span class="kn">from</span> <span class="nn">rdkit</span> <span class="kn">import</span> <span class="n">rdBase</span>
   52     <span class="kn">from</span> <span class="nn">rdkit</span> <span class="kn">import</span> <span class="n">Chem</span>
   53     <span class="kn">from</span> <span class="nn">rdkit.Chem</span> <span class="kn">import</span> <span class="n">rdMolTransforms</span>
   54 <span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">ErrMsg</span><span class="p">:</span>
   55     <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Failed to import RDKit module/package: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">ErrMsg</span><span class="p">)</span>
   56     <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Check/update your RDKit environment and try again.</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
   57     <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
   58 
   59 <span class="c1"># MayaChemTools imports...</span>
   60 <span class="k">try</span><span class="p">:</span>
   61     <span class="kn">from</span> <span class="nn">docopt</span> <span class="kn">import</span> <span class="n">docopt</span>
   62     <span class="kn">import</span> <span class="nn">MiscUtil</span>
   63     <span class="kn">import</span> <span class="nn">RDKitUtil</span>
   64     <span class="kn">import</span> <span class="nn">TorsionLibraryUtil</span>
   65 <span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">ErrMsg</span><span class="p">:</span>
   66     <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Failed to import MayaChemTools module/package: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">ErrMsg</span><span class="p">)</span>
   67     <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Check/update your MayaChemTools environment and try again.</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
   68     <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
   69 
   70 <span class="n">ScriptName</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
   71 <span class="n">Options</span> <span class="o">=</span> <span class="p">{}</span>
   72 <span class="n">OptionsInfo</span> <span class="o">=</span> <span class="p">{}</span>
   73 
   74 <span class="n">TorsionLibraryInfo</span> <span class="o">=</span> <span class="p">{}</span>
   75 
   76 <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
   77     <span class="sd">&quot;&quot;&quot;Start execution of the script.&quot;&quot;&quot;</span>
   78     
   79     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">%s</span><span class="s2"> (RDKit v</span><span class="si">%s</span><span class="s2">; MayaChemTools v</span><span class="si">%s</span><span class="s2">; </span><span class="si">%s</span><span class="s2">): Starting...</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ScriptName</span><span class="p">,</span> <span class="n">rdBase</span><span class="o">.</span><span class="n">rdkitVersion</span><span class="p">,</span> <span class="n">MiscUtil</span><span class="o">.</span><span class="n">GetMayaChemToolsVersion</span><span class="p">(),</span> <span class="n">time</span><span class="o">.</span><span class="n">asctime</span><span class="p">()))</span>
   80     
   81     <span class="p">(</span><span class="n">WallClockTime</span><span class="p">,</span> <span class="n">ProcessorTime</span><span class="p">)</span> <span class="o">=</span> <span class="n">MiscUtil</span><span class="o">.</span><span class="n">GetWallClockAndProcessorTime</span><span class="p">()</span>
   82     
   83     <span class="c1"># Retrieve command line arguments and options...</span>
   84     <span class="n">RetrieveOptions</span><span class="p">()</span>
   85     
   86     <span class="k">if</span>  <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--list&quot;</span><span class="p">]:</span>
   87         <span class="c1"># Handle listing of torsion library information...</span>
   88         <span class="n">ProcessListTorsionLibraryOption</span><span class="p">()</span>
   89     <span class="k">else</span><span class="p">:</span>
   90         <span class="c1"># Process and validate command line arguments and options...</span>
   91         <span class="n">ProcessOptions</span><span class="p">()</span>
   92         
   93         <span class="c1"># Perform actions required by the script...</span>
   94         <span class="n">PerformFiltering</span><span class="p">()</span>
   95     
   96     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">%s</span><span class="s2">: Done...</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">ScriptName</span><span class="p">)</span>
   97     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;Total time: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">MiscUtil</span><span class="o">.</span><span class="n">GetFormattedElapsedTime</span><span class="p">(</span><span class="n">WallClockTime</span><span class="p">,</span> <span class="n">ProcessorTime</span><span class="p">))</span>
   98 
   99 <span class="k">def</span> <span class="nf">PerformFiltering</span><span class="p">():</span>
  100     <span class="sd">&quot;&quot;&quot;Filter molecules using SMARTS torsion rules in the torsion library file.&quot;&quot;&quot;</span>
  101 
  102     <span class="c1"># Process torsion library info...</span>
  103     <span class="n">ProcessTorsionLibraryInfo</span><span class="p">()</span>
  104     
  105     <span class="c1"># Set up a pattern molecule for rotatable bonds...</span>
  106     <span class="n">RotBondsPatternMol</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">MolFromSmarts</span><span class="p">(</span><span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;RotBondsSMARTSPattern&quot;</span><span class="p">])</span>
  107     
  108     <span class="c1"># Setup a molecule reader...</span>
  109     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Processing file </span><span class="si">%s</span><span class="s2">...&quot;</span> <span class="o">%</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Infile&quot;</span><span class="p">])</span>
  110     <span class="n">Mols</span>  <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">ReadMolecules</span><span class="p">(</span><span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Infile&quot;</span><span class="p">],</span> <span class="o">**</span><span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;InfileParams&quot;</span><span class="p">])</span>
  111     
  112     <span class="n">MolCount</span><span class="p">,</span> <span class="n">ValidMolCount</span><span class="p">,</span> <span class="n">RemainingMolCount</span><span class="p">,</span> <span class="n">WriteFailedCount</span> <span class="o">=</span> <span class="n">ProcessMolecules</span><span class="p">(</span><span class="n">Mols</span><span class="p">,</span> <span class="n">RotBondsPatternMol</span><span class="p">)</span>
  113 
  114     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Total number of molecules: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">MolCount</span><span class="p">)</span>
  115     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;Number of valid molecules: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">ValidMolCount</span><span class="p">)</span>
  116     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;Number of molecules failed during writing: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">WriteFailedCount</span><span class="p">)</span>
  117     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;Number of ignored molecules: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">MolCount</span> <span class="o">-</span> <span class="n">ValidMolCount</span> <span class="o">+</span> <span class="n">WriteFailedCount</span><span class="p">))</span>
  118 
  119     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Number of remaining molecules: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">RemainingMolCount</span><span class="p">)</span>
  120     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;Number of filtered molecules: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ValidMolCount</span> <span class="o">-</span> <span class="n">RemainingMolCount</span><span class="p">))</span>
  121 
  122 <span class="k">def</span> <span class="nf">ProcessMolecules</span><span class="p">(</span><span class="n">Mols</span><span class="p">,</span> <span class="n">RotBondsPatternMol</span><span class="p">):</span>
  123     <span class="sd">&quot;&quot;&quot;Process and filter molecules.&quot;&quot;&quot;</span>
  124     
  125     <span class="k">if</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;MPMode&quot;</span><span class="p">]:</span>
  126         <span class="k">return</span> <span class="n">ProcessMoleculesUsingMultipleProcesses</span><span class="p">(</span><span class="n">Mols</span><span class="p">,</span> <span class="n">RotBondsPatternMol</span><span class="p">)</span>
  127     <span class="k">else</span><span class="p">:</span>
  128         <span class="k">return</span> <span class="n">ProcessMoleculesUsingSingleProcess</span><span class="p">(</span><span class="n">Mols</span><span class="p">,</span> <span class="n">RotBondsPatternMol</span><span class="p">)</span>
  129 
  130 <span class="k">def</span> <span class="nf">ProcessMoleculesUsingSingleProcess</span><span class="p">(</span><span class="n">Mols</span><span class="p">,</span> <span class="n">RotBondsPatternMol</span><span class="p">):</span>
  131     <span class="sd">&quot;&quot;&quot;Process and filter molecules using a single process.&quot;&quot;&quot;</span>
  132     
  133     <span class="n">SetupTorsionLibraryInfo</span><span class="p">()</span>
  134     
  135     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Filtering molecules...&quot;</span><span class="p">)</span>
  136     
  137     <span class="n">OutfileFilteredMode</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;OutfileFilteredMode&quot;</span><span class="p">]</span>
  138 
  139     <span class="c1"># Set up writers...</span>
  140     <span class="n">OutfilesWriters</span> <span class="o">=</span> <span class="n">SetupOutfilesWriters</span><span class="p">()</span>
  141     
  142     <span class="n">WriterRemaining</span> <span class="o">=</span> <span class="n">OutfilesWriters</span><span class="p">[</span><span class="s2">&quot;WriterRemaining&quot;</span><span class="p">]</span>
  143     <span class="n">WriterFiltered</span> <span class="o">=</span> <span class="n">OutfilesWriters</span><span class="p">[</span><span class="s2">&quot;WriterFiltered&quot;</span><span class="p">]</span>
  144     <span class="n">WriterAlertSummary</span> <span class="o">=</span> <span class="n">OutfilesWriters</span><span class="p">[</span><span class="s2">&quot;WriterAlertSummary&quot;</span><span class="p">]</span>
  145     
  146     <span class="c1"># Initialize alerts summary info...</span>
  147     <span class="n">TorsionAlertsSummaryInfo</span> <span class="o">=</span> <span class="n">InitializeTorsionAlertsSummaryInfo</span><span class="p">()</span>
  148 
  149     <span class="p">(</span><span class="n">MolCount</span><span class="p">,</span> <span class="n">ValidMolCount</span><span class="p">,</span> <span class="n">RemainingMolCount</span><span class="p">,</span> <span class="n">WriteFailedCount</span><span class="p">,</span> <span class="n">FilteredMolWriteCount</span><span class="p">)</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">5</span>
  150     <span class="k">for</span> <span class="n">Mol</span> <span class="ow">in</span> <span class="n">Mols</span><span class="p">:</span>
  151         <span class="n">MolCount</span> <span class="o">+=</span> <span class="mi">1</span>
  152         
  153         <span class="k">if</span> <span class="n">Mol</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
  154             <span class="k">continue</span>
  155         
  156         <span class="k">if</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">IsMolEmpty</span><span class="p">(</span><span class="n">Mol</span><span class="p">):</span>
  157             <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintWarning</span><span class="p">(</span><span class="s2">&quot;Ignoring empty molecule: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">GetMolName</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolCount</span><span class="p">))</span>
  158             <span class="k">continue</span>
  159 
  160         <span class="c1"># Check for 3D flag...</span>
  161         <span class="k">if</span> <span class="ow">not</span> <span class="n">Mol</span><span class="o">.</span><span class="n">GetConformer</span><span class="p">()</span><span class="o">.</span><span class="n">Is3D</span><span class="p">():</span>
  162             <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintWarning</span><span class="p">(</span><span class="s2">&quot;3D tag is not set. Ignoring molecule: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">GetMolName</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolCount</span><span class="p">))</span>
  163             <span class="k">continue</span>
  164         
  165         <span class="n">ValidMolCount</span> <span class="o">+=</span> <span class="mi">1</span>
  166         
  167         <span class="c1"># Identify torsion library alerts for rotatable bonds..</span>
  168         <span class="n">RotBondsAlertsStatus</span><span class="p">,</span> <span class="n">RotBondsAlertsInfo</span> <span class="o">=</span> <span class="n">IdentifyTorsionLibraryAlertsForRotatableBonds</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">RotBondsPatternMol</span><span class="p">)</span>
  169 
  170         <span class="n">TrackTorsionAlertsSummaryInfo</span><span class="p">(</span><span class="n">TorsionAlertsSummaryInfo</span><span class="p">,</span> <span class="n">RotBondsAlertsInfo</span><span class="p">)</span>
  171         
  172         <span class="c1"># Write out filtered and remaining molecules...</span>
  173         <span class="n">WriteStatus</span> <span class="o">=</span> <span class="bp">True</span>
  174         <span class="k">if</span> <span class="n">RotBondsAlertsStatus</span><span class="p">:</span>
  175             <span class="k">if</span> <span class="n">OutfileFilteredMode</span><span class="p">:</span>
  176                 <span class="n">WriteStatus</span> <span class="o">=</span> <span class="n">WriteMolecule</span><span class="p">(</span><span class="n">WriterFiltered</span><span class="p">,</span> <span class="n">Mol</span><span class="p">,</span> <span class="n">RotBondsAlertsInfo</span><span class="p">)</span>
  177                 <span class="k">if</span> <span class="n">WriteStatus</span><span class="p">:</span>
  178                     <span class="n">FilteredMolWriteCount</span> <span class="o">+=</span> <span class="mi">1</span>
  179         <span class="k">else</span><span class="p">:</span>
  180             <span class="n">RemainingMolCount</span> <span class="o">+=</span> <span class="mi">1</span>
  181             <span class="n">WriteStatus</span> <span class="o">=</span> <span class="n">WriteMolecule</span><span class="p">(</span><span class="n">WriterRemaining</span><span class="p">,</span> <span class="n">Mol</span><span class="p">,</span> <span class="n">RotBondsAlertsInfo</span><span class="p">)</span>
  182         
  183         <span class="k">if</span> <span class="ow">not</span> <span class="n">WriteStatus</span><span class="p">:</span>
  184             <span class="n">WriteFailedCount</span> <span class="o">+=</span> <span class="mi">1</span>
  185 
  186     <span class="n">WriteTorsionAlertsSummaryInfo</span><span class="p">(</span><span class="n">WriterAlertSummary</span><span class="p">,</span> <span class="n">TorsionAlertsSummaryInfo</span><span class="p">)</span>
  187     <span class="n">CloseOutfilesWriters</span><span class="p">(</span><span class="n">OutfilesWriters</span><span class="p">)</span>
  188 
  189     <span class="k">if</span> <span class="n">FilteredMolWriteCount</span><span class="p">:</span>
  190         <span class="n">WriteTorsionAlertsFilteredByRulesInfo</span><span class="p">(</span><span class="n">TorsionAlertsSummaryInfo</span><span class="p">)</span>
  191     
  192     <span class="k">return</span> <span class="p">(</span><span class="n">MolCount</span><span class="p">,</span> <span class="n">ValidMolCount</span><span class="p">,</span> <span class="n">RemainingMolCount</span><span class="p">,</span> <span class="n">WriteFailedCount</span><span class="p">)</span>
  193 
  194 <span class="k">def</span> <span class="nf">ProcessMoleculesUsingMultipleProcesses</span><span class="p">(</span><span class="n">Mols</span><span class="p">,</span> <span class="n">RotBondsPatternMol</span><span class="p">):</span>
  195     <span class="sd">&quot;&quot;&quot;Process and filter molecules using multiprocessing.&quot;&quot;&quot;</span>
  196 
  197     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Filtering molecules using multiprocessing...&quot;</span><span class="p">)</span>
  198     
  199     <span class="n">MPParams</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;MPParams&quot;</span><span class="p">]</span>
  200     <span class="n">OutfileFilteredMode</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;OutfileFilteredMode&quot;</span><span class="p">]</span>
  201     
  202     <span class="c1"># Set up writers...</span>
  203     <span class="n">OutfilesWriters</span> <span class="o">=</span> <span class="n">SetupOutfilesWriters</span><span class="p">()</span>
  204     
  205     <span class="n">WriterRemaining</span> <span class="o">=</span> <span class="n">OutfilesWriters</span><span class="p">[</span><span class="s2">&quot;WriterRemaining&quot;</span><span class="p">]</span>
  206     <span class="n">WriterFiltered</span> <span class="o">=</span> <span class="n">OutfilesWriters</span><span class="p">[</span><span class="s2">&quot;WriterFiltered&quot;</span><span class="p">]</span>
  207     <span class="n">WriterAlertSummary</span> <span class="o">=</span> <span class="n">OutfilesWriters</span><span class="p">[</span><span class="s2">&quot;WriterAlertSummary&quot;</span><span class="p">]</span>
  208     
  209     <span class="c1"># Initialize alerts summary info...</span>
  210     <span class="n">TorsionAlertsSummaryInfo</span> <span class="o">=</span> <span class="n">InitializeTorsionAlertsSummaryInfo</span><span class="p">()</span>
  211     
  212     <span class="c1"># Setup data for initializing a worker process...</span>
  213     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;Encoding options info and rotatable bond pattern molecule...&quot;</span><span class="p">)</span>
  214     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;EncodedRotBondsPatternMol&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">MolToBase64EncodedMolString</span><span class="p">(</span><span class="n">RotBondsPatternMol</span><span class="p">)</span>
  215     <span class="n">InitializeWorkerProcessArgs</span> <span class="o">=</span> <span class="p">(</span><span class="n">MiscUtil</span><span class="o">.</span><span class="n">ObjectToBase64EncodedString</span><span class="p">(</span><span class="n">Options</span><span class="p">),</span> <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ObjectToBase64EncodedString</span><span class="p">(</span><span class="n">OptionsInfo</span><span class="p">))</span>
  216 
  217     <span class="c1"># Setup a encoded mols data iterable for a worker process...</span>
  218     <span class="n">WorkerProcessDataIterable</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">GenerateBase64EncodedMolStrings</span><span class="p">(</span><span class="n">Mols</span><span class="p">)</span>
  219     
  220     <span class="c1"># Setup process pool along with data initialization for each process...</span>
  221     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Configuring multiprocessing using </span><span class="si">%s</span><span class="s2"> method...&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s2">&quot;mp.Pool.imap()&quot;</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^Lazy$&quot;</span><span class="p">,</span> <span class="n">MPParams</span><span class="p">[</span><span class="s2">&quot;InputDataMode&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;mp.Pool.map()&quot;</span><span class="p">))</span>
  222     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;NumProcesses: </span><span class="si">%s</span><span class="s2">; InputDataMode: </span><span class="si">%s</span><span class="s2">; ChunkSize: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">MPParams</span><span class="p">[</span><span class="s2">&quot;NumProcesses&quot;</span><span class="p">],</span> <span class="n">MPParams</span><span class="p">[</span><span class="s2">&quot;InputDataMode&quot;</span><span class="p">],</span> <span class="p">(</span><span class="s2">&quot;automatic&quot;</span> <span class="k">if</span> <span class="n">MPParams</span><span class="p">[</span><span class="s2">&quot;ChunkSize&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">MPParams</span><span class="p">[</span><span class="s2">&quot;ChunkSize&quot;</span><span class="p">])))</span>
  223     
  224     <span class="n">ProcessPool</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">MPParams</span><span class="p">[</span><span class="s2">&quot;NumProcesses&quot;</span><span class="p">],</span> <span class="n">InitializeWorkerProcess</span><span class="p">,</span> <span class="n">InitializeWorkerProcessArgs</span><span class="p">)</span>
  225     
  226     <span class="c1"># Start processing...</span>
  227     <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^Lazy$&quot;</span><span class="p">,</span> <span class="n">MPParams</span><span class="p">[</span><span class="s2">&quot;InputDataMode&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
  228         <span class="n">Results</span> <span class="o">=</span> <span class="n">ProcessPool</span><span class="o">.</span><span class="n">imap</span><span class="p">(</span><span class="n">WorkerProcess</span><span class="p">,</span> <span class="n">WorkerProcessDataIterable</span><span class="p">,</span> <span class="n">MPParams</span><span class="p">[</span><span class="s2">&quot;ChunkSize&quot;</span><span class="p">])</span>
  229     <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^InMemory$&quot;</span><span class="p">,</span> <span class="n">MPParams</span><span class="p">[</span><span class="s2">&quot;InputDataMode&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
  230         <span class="n">Results</span> <span class="o">=</span> <span class="n">ProcessPool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">WorkerProcess</span><span class="p">,</span> <span class="n">WorkerProcessDataIterable</span><span class="p">,</span> <span class="n">MPParams</span><span class="p">[</span><span class="s2">&quot;ChunkSize&quot;</span><span class="p">])</span>
  231     <span class="k">else</span><span class="p">:</span>
  232         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintError</span><span class="p">(</span><span class="s2">&quot;The value, </span><span class="si">%s</span><span class="s2">, specified for </span><span class="se">\&quot;</span><span class="s2">--inputDataMode</span><span class="se">\&quot;</span><span class="s2"> is not supported.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">MPParams</span><span class="p">[</span><span class="s2">&quot;InputDataMode&quot;</span><span class="p">]))</span>
  233     
  234     <span class="p">(</span><span class="n">MolCount</span><span class="p">,</span> <span class="n">ValidMolCount</span><span class="p">,</span> <span class="n">RemainingMolCount</span><span class="p">,</span> <span class="n">WriteFailedCount</span><span class="p">,</span> <span class="n">FilteredMolWriteCount</span><span class="p">)</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">5</span>
  235     <span class="k">for</span> <span class="n">Result</span> <span class="ow">in</span> <span class="n">Results</span><span class="p">:</span>
  236         <span class="n">MolCount</span> <span class="o">+=</span> <span class="mi">1</span>
  237         <span class="n">MolIndex</span><span class="p">,</span> <span class="n">EncodedMol</span><span class="p">,</span> <span class="n">RotBondsAlertsStatus</span><span class="p">,</span> <span class="n">RotBondsAlertsInfo</span> <span class="o">=</span> <span class="n">Result</span>
  238         
  239         <span class="k">if</span> <span class="n">EncodedMol</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
  240             <span class="k">continue</span>
  241         <span class="n">ValidMolCount</span> <span class="o">+=</span> <span class="mi">1</span>
  242         
  243         <span class="n">Mol</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">MolFromBase64EncodedMolString</span><span class="p">(</span><span class="n">EncodedMol</span><span class="p">)</span>
  244         
  245         <span class="n">TrackTorsionAlertsSummaryInfo</span><span class="p">(</span><span class="n">TorsionAlertsSummaryInfo</span><span class="p">,</span> <span class="n">RotBondsAlertsInfo</span><span class="p">)</span>
  246         
  247         <span class="c1"># Write out filtered and remaining molecules...</span>
  248         <span class="n">WriteStatus</span> <span class="o">=</span> <span class="bp">True</span>
  249         <span class="k">if</span> <span class="n">RotBondsAlertsStatus</span><span class="p">:</span>
  250             <span class="k">if</span> <span class="n">OutfileFilteredMode</span><span class="p">:</span>
  251                 <span class="n">WriteStatus</span> <span class="o">=</span> <span class="n">WriteMolecule</span><span class="p">(</span><span class="n">WriterFiltered</span><span class="p">,</span> <span class="n">Mol</span><span class="p">,</span> <span class="n">RotBondsAlertsInfo</span><span class="p">)</span>
  252                 <span class="k">if</span> <span class="n">WriteStatus</span><span class="p">:</span>
  253                     <span class="n">FilteredMolWriteCount</span> <span class="o">+=</span> <span class="mi">1</span>
  254         <span class="k">else</span><span class="p">:</span>
  255             <span class="n">RemainingMolCount</span> <span class="o">+=</span> <span class="mi">1</span>
  256             <span class="n">WriteStatus</span> <span class="o">=</span> <span class="n">WriteMolecule</span><span class="p">(</span><span class="n">WriterRemaining</span><span class="p">,</span> <span class="n">Mol</span><span class="p">,</span> <span class="n">RotBondsAlertsInfo</span><span class="p">)</span>
  257         
  258         <span class="k">if</span> <span class="ow">not</span> <span class="n">WriteStatus</span><span class="p">:</span>
  259             <span class="n">WriteFailedCount</span> <span class="o">+=</span> <span class="mi">1</span>
  260     
  261     <span class="n">WriteTorsionAlertsSummaryInfo</span><span class="p">(</span><span class="n">WriterAlertSummary</span><span class="p">,</span> <span class="n">TorsionAlertsSummaryInfo</span><span class="p">)</span>
  262     <span class="n">CloseOutfilesWriters</span><span class="p">(</span><span class="n">OutfilesWriters</span><span class="p">)</span>
  263     
  264     <span class="k">if</span> <span class="n">FilteredMolWriteCount</span><span class="p">:</span>
  265         <span class="n">WriteTorsionAlertsFilteredByRulesInfo</span><span class="p">(</span><span class="n">TorsionAlertsSummaryInfo</span><span class="p">)</span>
  266     
  267     <span class="k">return</span> <span class="p">(</span><span class="n">MolCount</span><span class="p">,</span> <span class="n">ValidMolCount</span><span class="p">,</span> <span class="n">RemainingMolCount</span><span class="p">,</span> <span class="n">WriteFailedCount</span><span class="p">)</span>
  268 
  269 <span class="k">def</span> <span class="nf">InitializeWorkerProcess</span><span class="p">(</span><span class="o">*</span><span class="n">EncodedArgs</span><span class="p">):</span>
  270     <span class="sd">&quot;&quot;&quot;Initialize data for a worker process.&quot;&quot;&quot;</span>
  271     
  272     <span class="k">global</span> <span class="n">Options</span><span class="p">,</span> <span class="n">OptionsInfo</span>
  273 
  274     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;Starting process (PID: </span><span class="si">%s</span><span class="s2">)...&quot;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">())</span>
  275 
  276     <span class="c1"># Decode Options and OptionInfo...</span>
  277     <span class="n">Options</span> <span class="o">=</span> <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ObjectFromBase64EncodedString</span><span class="p">(</span><span class="n">EncodedArgs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
  278     <span class="n">OptionsInfo</span> <span class="o">=</span> <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ObjectFromBase64EncodedString</span><span class="p">(</span><span class="n">EncodedArgs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
  279 
  280     <span class="c1"># Decode RotBondsPatternMol...</span>
  281     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;RotBondsPatternMol&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">MolFromBase64EncodedMolString</span><span class="p">(</span><span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;EncodedRotBondsPatternMol&quot;</span><span class="p">])</span>
  282 
  283     <span class="c1"># Setup torsion library...</span>
  284     <span class="n">RetrieveTorsionLibraryInfo</span><span class="p">(</span><span class="n">Quiet</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
  285     <span class="n">SetupTorsionLibraryInfo</span><span class="p">(</span><span class="n">Quiet</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
  286 
  287 <span class="k">def</span> <span class="nf">WorkerProcess</span><span class="p">(</span><span class="n">EncodedMolInfo</span><span class="p">):</span>
  288     <span class="sd">&quot;&quot;&quot;Process data for a worker process.&quot;&quot;&quot;</span>
  289 
  290     <span class="n">MolIndex</span><span class="p">,</span> <span class="n">EncodedMol</span> <span class="o">=</span> <span class="n">EncodedMolInfo</span>
  291     
  292     <span class="k">if</span> <span class="n">EncodedMol</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
  293         <span class="k">return</span> <span class="p">[</span><span class="n">MolIndex</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="bp">None</span><span class="p">]</span>
  294     
  295     <span class="n">Mol</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">MolFromBase64EncodedMolString</span><span class="p">(</span><span class="n">EncodedMol</span><span class="p">)</span>
  296     <span class="k">if</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">IsMolEmpty</span><span class="p">(</span><span class="n">Mol</span><span class="p">):</span>
  297         <span class="n">MolName</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">GetMolName</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="p">(</span><span class="n">MolIndex</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
  298         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintWarning</span><span class="p">(</span><span class="s2">&quot;Ignoring empty molecule: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">MolName</span><span class="p">)</span>
  299         <span class="k">return</span> <span class="p">[</span><span class="n">MolIndex</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="bp">None</span><span class="p">]</span>
  300         
  301     <span class="c1"># Check for 3D flag...</span>
  302     <span class="k">if</span> <span class="ow">not</span> <span class="n">Mol</span><span class="o">.</span><span class="n">GetConformer</span><span class="p">()</span><span class="o">.</span><span class="n">Is3D</span><span class="p">():</span>
  303         <span class="n">MolName</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">GetMolName</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="p">(</span><span class="n">MolIndex</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
  304         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintWarning</span><span class="p">(</span><span class="s2">&quot;3D tag is not set. Ignoring molecule: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">MolName</span><span class="p">)</span>
  305         <span class="k">return</span> <span class="p">[</span><span class="n">MolIndex</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="bp">None</span><span class="p">]</span>
  306     
  307     <span class="c1"># Identify torsion library alerts for rotatable bonds..</span>
  308     <span class="n">RotBondsAlertsStatus</span><span class="p">,</span> <span class="n">RotBondsAlertsInfo</span> <span class="o">=</span> <span class="n">IdentifyTorsionLibraryAlertsForRotatableBonds</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;RotBondsPatternMol&quot;</span><span class="p">])</span>
  309 
  310     <span class="k">return</span> <span class="p">[</span><span class="n">MolIndex</span><span class="p">,</span> <span class="n">EncodedMol</span><span class="p">,</span> <span class="n">RotBondsAlertsStatus</span><span class="p">,</span> <span class="n">RotBondsAlertsInfo</span><span class="p">]</span>
  311 
  312 <span class="k">def</span>  <span class="nf">IdentifyTorsionLibraryAlertsForRotatableBonds</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">RotBondsPatternMol</span><span class="p">):</span>
  313     <span class="sd">&quot;&quot;&quot;Identify rotatable bonds for torsion library alerts.&quot;&quot;&quot;</span>
  314     
  315     <span class="c1"># Identify rotatable bonds...</span>
  316     <span class="n">RotBondsStatus</span><span class="p">,</span> <span class="n">RotBondsInfo</span> <span class="o">=</span> <span class="n">TorsionLibraryUtil</span><span class="o">.</span><span class="n">IdentifyRotatableBondsForTorsionLibraryMatch</span><span class="p">(</span><span class="n">TorsionLibraryInfo</span><span class="p">,</span> <span class="n">Mol</span><span class="p">,</span> <span class="n">RotBondsPatternMol</span><span class="p">)</span>
  317     <span class="k">if</span> <span class="ow">not</span> <span class="n">RotBondsStatus</span><span class="p">:</span>
  318         <span class="k">return</span> <span class="p">(</span><span class="bp">False</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
  319 
  320     <span class="c1"># Identify alerts for rotatable bonds...</span>
  321     <span class="n">RotBondsAlertsStatus</span><span class="p">,</span> <span class="n">RotBondsAlertsInfo</span> <span class="o">=</span> <span class="n">MatchRotatableBondsToTorsionLibrary</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">RotBondsInfo</span><span class="p">)</span>
  322 
  323     <span class="k">return</span> <span class="p">(</span><span class="n">RotBondsAlertsStatus</span><span class="p">,</span> <span class="n">RotBondsAlertsInfo</span><span class="p">)</span>
  324 
  325 <span class="k">def</span> <span class="nf">MatchRotatableBondsToTorsionLibrary</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">RotBondsInfo</span><span class="p">):</span>
  326     <span class="sd">&quot;&quot;&quot;Match rotatable bond to torsion library.&quot;&quot;&quot;</span>
  327 
  328     <span class="c1"># Initialize...</span>
  329     <span class="n">RotBondsAlertsInfo</span> <span class="o">=</span> <span class="n">InitializeRotatableBondsAlertsInfo</span><span class="p">()</span>
  330     
  331     <span class="c1"># Match rotatable bonds to torsion library...</span>
  332     <span class="k">for</span> <span class="n">ID</span> <span class="ow">in</span> <span class="n">RotBondsInfo</span><span class="p">[</span><span class="s2">&quot;IDs&quot;</span><span class="p">]:</span>
  333         <span class="n">AtomIndices</span> <span class="o">=</span> <span class="n">RotBondsInfo</span><span class="p">[</span><span class="s2">&quot;AtomIndices&quot;</span><span class="p">][</span><span class="n">ID</span><span class="p">]</span>
  334         <span class="n">HierarchyClass</span> <span class="o">=</span> <span class="n">RotBondsInfo</span><span class="p">[</span><span class="s2">&quot;HierarchyClass&quot;</span><span class="p">][</span><span class="n">ID</span><span class="p">]</span>
  335 
  336         <span class="n">MatchStatus</span><span class="p">,</span> <span class="n">MatchInfo</span> <span class="o">=</span> <span class="n">MatchRotatableBondToTorsionLibrary</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">AtomIndices</span><span class="p">,</span> <span class="n">HierarchyClass</span><span class="p">)</span>
  337 
  338         <span class="k">if</span> <span class="n">MatchInfo</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">MatchInfo</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
  339             <span class="n">AlertType</span><span class="p">,</span> <span class="n">TorsionAtomIndices</span><span class="p">,</span> <span class="n">TorsionAngle</span><span class="p">,</span> <span class="n">TorsionAngleViolation</span><span class="p">,</span> <span class="n">HierarchyClassName</span><span class="p">,</span> <span class="n">HierarchySubClassName</span><span class="p">,</span> <span class="n">TorsionRuleNodeID</span><span class="p">,</span> <span class="n">TorsionRulePeaks</span><span class="p">,</span> <span class="n">TorsionRuleTolerances1</span><span class="p">,</span> <span class="n">TorsionRuleTolerances2</span><span class="p">,</span> <span class="n">TorsionRuleSMARTS</span> <span class="o">=</span> <span class="p">[</span><span class="bp">None</span><span class="p">]</span> <span class="o">*</span> <span class="mi">11</span>
  340         <span class="k">else</span><span class="p">:</span>
  341             <span class="n">AlertType</span><span class="p">,</span> <span class="n">TorsionAtomIndices</span><span class="p">,</span> <span class="n">TorsionAngle</span><span class="p">,</span> <span class="n">TorsionAngleViolation</span><span class="p">,</span> <span class="n">HierarchyClassName</span><span class="p">,</span> <span class="n">HierarchySubClassName</span><span class="p">,</span> <span class="n">TorsionRuleNodeID</span><span class="p">,</span> <span class="n">TorsionRulePeaks</span><span class="p">,</span> <span class="n">TorsionRuleTolerances1</span><span class="p">,</span> <span class="n">TorsionRuleTolerances2</span><span class="p">,</span> <span class="n">TorsionRuleSMARTS</span> <span class="o">=</span> <span class="n">MatchInfo</span>
  342 
  343         <span class="c1"># Track alerts information...</span>
  344         <span class="n">RotBondsAlertsInfo</span><span class="p">[</span><span class="s2">&quot;IDs&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ID</span><span class="p">)</span>
  345         <span class="n">RotBondsAlertsInfo</span><span class="p">[</span><span class="s2">&quot;MatchStatus&quot;</span><span class="p">][</span><span class="n">ID</span><span class="p">]</span> <span class="o">=</span> <span class="n">MatchStatus</span>
  346         <span class="n">RotBondsAlertsInfo</span><span class="p">[</span><span class="s2">&quot;AlertTypes&quot;</span><span class="p">][</span><span class="n">ID</span><span class="p">]</span> <span class="o">=</span> <span class="n">AlertType</span>
  347         <span class="n">RotBondsAlertsInfo</span><span class="p">[</span><span class="s2">&quot;AtomIndices&quot;</span><span class="p">][</span><span class="n">ID</span><span class="p">]</span> <span class="o">=</span> <span class="n">AtomIndices</span>
  348         <span class="n">RotBondsAlertsInfo</span><span class="p">[</span><span class="s2">&quot;TorsionAtomIndices&quot;</span><span class="p">][</span><span class="n">ID</span><span class="p">]</span> <span class="o">=</span> <span class="n">TorsionAtomIndices</span>
  349         <span class="n">RotBondsAlertsInfo</span><span class="p">[</span><span class="s2">&quot;TorsionAngles&quot;</span><span class="p">][</span><span class="n">ID</span><span class="p">]</span> <span class="o">=</span> <span class="n">TorsionAngle</span>
  350         <span class="n">RotBondsAlertsInfo</span><span class="p">[</span><span class="s2">&quot;TorsionAngleViolations&quot;</span><span class="p">][</span><span class="n">ID</span><span class="p">]</span> <span class="o">=</span> <span class="n">TorsionAngleViolation</span>
  351         <span class="n">RotBondsAlertsInfo</span><span class="p">[</span><span class="s2">&quot;HierarchyClassNames&quot;</span><span class="p">][</span><span class="n">ID</span><span class="p">]</span> <span class="o">=</span> <span class="n">HierarchyClassName</span>
  352         <span class="n">RotBondsAlertsInfo</span><span class="p">[</span><span class="s2">&quot;HierarchySubClassNames&quot;</span><span class="p">][</span><span class="n">ID</span><span class="p">]</span> <span class="o">=</span> <span class="n">HierarchySubClassName</span>
  353         <span class="n">RotBondsAlertsInfo</span><span class="p">[</span><span class="s2">&quot;TorsionRuleNodeID&quot;</span><span class="p">][</span><span class="n">ID</span><span class="p">]</span> <span class="o">=</span> <span class="n">TorsionRuleNodeID</span>
  354         <span class="n">RotBondsAlertsInfo</span><span class="p">[</span><span class="s2">&quot;TorsionRulePeaks&quot;</span><span class="p">][</span><span class="n">ID</span><span class="p">]</span> <span class="o">=</span> <span class="n">TorsionRulePeaks</span>
  355         <span class="n">RotBondsAlertsInfo</span><span class="p">[</span><span class="s2">&quot;TorsionRuleTolerances1&quot;</span><span class="p">][</span><span class="n">ID</span><span class="p">]</span> <span class="o">=</span> <span class="n">TorsionRuleTolerances1</span>
  356         <span class="n">RotBondsAlertsInfo</span><span class="p">[</span><span class="s2">&quot;TorsionRuleTolerances2&quot;</span><span class="p">][</span><span class="n">ID</span><span class="p">]</span> <span class="o">=</span> <span class="n">TorsionRuleTolerances2</span>
  357         <span class="n">RotBondsAlertsInfo</span><span class="p">[</span><span class="s2">&quot;TorsionRuleSMARTS&quot;</span><span class="p">][</span><span class="n">ID</span><span class="p">]</span> <span class="o">=</span> <span class="n">TorsionRuleSMARTS</span>
  358 
  359         <span class="c1">#  Count alert types...</span>
  360         <span class="k">if</span> <span class="n">AlertType</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
  361             <span class="k">if</span> <span class="n">AlertType</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">RotBondsAlertsInfo</span><span class="p">[</span><span class="s2">&quot;Count&quot;</span><span class="p">]:</span>
  362                 <span class="n">RotBondsAlertsInfo</span><span class="p">[</span><span class="s2">&quot;Count&quot;</span><span class="p">][</span><span class="n">AlertType</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
  363             <span class="n">RotBondsAlertsInfo</span><span class="p">[</span><span class="s2">&quot;Count&quot;</span><span class="p">][</span><span class="n">AlertType</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
  364     
  365     <span class="c1"># Setup alert status for rotatable bonds...</span>
  366     <span class="n">RotBondsAlertsStatus</span> <span class="o">=</span> <span class="bp">False</span>
  367     <span class="n">AlertsCount</span> <span class="o">=</span> <span class="mi">0</span>
  368     <span class="k">for</span> <span class="n">ID</span> <span class="ow">in</span> <span class="n">RotBondsInfo</span><span class="p">[</span><span class="s2">&quot;IDs&quot;</span><span class="p">]:</span>
  369         <span class="k">if</span> <span class="n">RotBondsAlertsInfo</span><span class="p">[</span><span class="s2">&quot;AlertTypes&quot;</span><span class="p">][</span><span class="n">ID</span><span class="p">]</span> <span class="ow">in</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;SpecifiedAlertsModeList&quot;</span><span class="p">]:</span>
  370             <span class="n">AlertsCount</span> <span class="o">+=</span> <span class="mi">1</span>
  371             <span class="k">if</span> <span class="n">AlertsCount</span> <span class="o">&gt;=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;MinAlertsCount&quot;</span><span class="p">]:</span>
  372                 <span class="n">RotBondsAlertsStatus</span> <span class="o">=</span> <span class="bp">True</span>
  373                 <span class="k">break</span>
  374     
  375     <span class="k">return</span> <span class="p">(</span><span class="n">RotBondsAlertsStatus</span><span class="p">,</span> <span class="n">RotBondsAlertsInfo</span><span class="p">)</span>
  376 
  377 <span class="k">def</span> <span class="nf">InitializeRotatableBondsAlertsInfo</span><span class="p">():</span>
  378     <span class="sd">&quot;&quot;&quot;Initialize alerts information for rotatable bonds.&quot;&quot;&quot;</span>
  379     
  380     <span class="n">RotBondsAlertsInfo</span> <span class="o">=</span> <span class="p">{}</span>
  381     <span class="n">RotBondsAlertsInfo</span><span class="p">[</span><span class="s2">&quot;IDs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
  382 
  383     <span class="k">for</span> <span class="n">DataLabel</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;MatchStatus&quot;</span><span class="p">,</span> <span class="s2">&quot;AlertTypes&quot;</span><span class="p">,</span> <span class="s2">&quot;AtomIndices&quot;</span><span class="p">,</span> <span class="s2">&quot;TorsionAtomIndices&quot;</span><span class="p">,</span> <span class="s2">&quot;TorsionAngles&quot;</span><span class="p">,</span> <span class="s2">&quot;TorsionAngleViolations&quot;</span><span class="p">,</span> <span class="s2">&quot;HierarchyClassNames&quot;</span><span class="p">,</span> <span class="s2">&quot;HierarchySubClassNames&quot;</span><span class="p">,</span> <span class="s2">&quot;TorsionRuleNodeID&quot;</span><span class="p">,</span> <span class="s2">&quot;TorsionRulePeaks&quot;</span><span class="p">,</span> <span class="s2">&quot;TorsionRuleTolerances1&quot;</span><span class="p">,</span> <span class="s2">&quot;TorsionRuleTolerances2&quot;</span><span class="p">,</span> <span class="s2">&quot;TorsionRuleSMARTS&quot;</span><span class="p">,</span> <span class="s2">&quot;Count&quot;</span><span class="p">]:</span>
  384         <span class="n">RotBondsAlertsInfo</span><span class="p">[</span><span class="n">DataLabel</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
  385         
  386     <span class="k">return</span> <span class="n">RotBondsAlertsInfo</span>
  387     
  388 <span class="k">def</span> <span class="nf">MatchRotatableBondToTorsionLibrary</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">RotBondAtomIndices</span><span class="p">,</span> <span class="n">RotBondHierarchyClass</span><span class="p">):</span>
  389     <span class="sd">&quot;&quot;&quot;Match rotatable bond to torsion library.&quot;&quot;&quot;</span>
  390 
  391     <span class="k">if</span> <span class="n">TorsionLibraryUtil</span><span class="o">.</span><span class="n">IsSpecificHierarchyClass</span><span class="p">(</span><span class="n">TorsionLibraryInfo</span><span class="p">,</span> <span class="n">RotBondHierarchyClass</span><span class="p">):</span>
  392         <span class="n">MatchStatus</span><span class="p">,</span> <span class="n">MatchInfo</span> <span class="o">=</span> <span class="n">MatchRotatableBondAgainstSpecificHierarchyClass</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">RotBondAtomIndices</span><span class="p">,</span> <span class="n">RotBondHierarchyClass</span><span class="p">)</span>
  393         <span class="k">if</span> <span class="ow">not</span> <span class="n">MatchStatus</span><span class="p">:</span>
  394             <span class="n">MatchStatus</span><span class="p">,</span> <span class="n">MatchInfo</span> <span class="o">=</span> <span class="n">MatchRotatableBondAgainstGenericHierarchyClass</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">RotBondAtomIndices</span><span class="p">,</span> <span class="n">RotBondHierarchyClass</span><span class="p">)</span>
  395     <span class="k">else</span><span class="p">:</span>
  396         <span class="n">MatchStatus</span><span class="p">,</span> <span class="n">MatchInfo</span> <span class="o">=</span> <span class="n">MatchRotatableBondAgainstGenericHierarchyClass</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">RotBondAtomIndices</span><span class="p">,</span> <span class="n">RotBondHierarchyClass</span><span class="p">)</span>
  397 
  398     <span class="k">return</span> <span class="p">(</span><span class="n">MatchStatus</span><span class="p">,</span> <span class="n">MatchInfo</span><span class="p">)</span>
  399 
  400 <span class="k">def</span> <span class="nf">MatchRotatableBondAgainstSpecificHierarchyClass</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">RotBondAtomIndices</span><span class="p">,</span> <span class="n">RotBondHierarchyClass</span><span class="p">):</span>
  401     <span class="sd">&quot;&quot;&quot;Match rotatable bond against a specific hierarchy class.&quot;&quot;&quot;</span>
  402 
  403     <span class="n">HierarchyClassElementNode</span> <span class="o">=</span> <span class="bp">None</span>
  404     <span class="k">if</span> <span class="n">RotBondHierarchyClass</span> <span class="ow">in</span> <span class="n">TorsionLibraryInfo</span><span class="p">[</span><span class="s2">&quot;SpecificClasses&quot;</span><span class="p">][</span><span class="s2">&quot;ElementNode&quot;</span><span class="p">]:</span>
  405         <span class="n">HierarchyClassElementNode</span> <span class="o">=</span> <span class="n">TorsionLibraryInfo</span><span class="p">[</span><span class="s2">&quot;SpecificClasses&quot;</span><span class="p">][</span><span class="s2">&quot;ElementNode&quot;</span><span class="p">][</span><span class="n">RotBondHierarchyClass</span><span class="p">]</span>
  406     
  407     <span class="k">if</span> <span class="n">HierarchyClassElementNode</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
  408         <span class="k">return</span> <span class="p">(</span><span class="bp">False</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
  409 
  410     <span class="n">TorsionLibraryUtil</span><span class="o">.</span><span class="n">TrackHierarchyClassElementNode</span><span class="p">(</span><span class="n">TorsionLibraryInfo</span><span class="p">,</span> <span class="n">HierarchyClassElementNode</span><span class="p">)</span>
  411     <span class="n">MatchStatus</span><span class="p">,</span> <span class="n">MatchInfo</span> <span class="o">=</span> <span class="n">ProcessElementForRotatableBondMatch</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">RotBondAtomIndices</span><span class="p">,</span> <span class="n">HierarchyClassElementNode</span><span class="p">)</span>
  412     <span class="n">TorsionLibraryUtil</span><span class="o">.</span><span class="n">RemoveLastHierarchyClassElementNodeFromTracking</span><span class="p">(</span><span class="n">TorsionLibraryInfo</span><span class="p">)</span>
  413     
  414     <span class="k">return</span> <span class="p">(</span><span class="n">MatchStatus</span><span class="p">,</span> <span class="n">MatchInfo</span><span class="p">)</span>
  415 
  416 <span class="k">def</span> <span class="nf">MatchRotatableBondAgainstGenericHierarchyClass</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">RotBondAtomIndices</span><span class="p">,</span> <span class="n">RotBondHierarchyClass</span><span class="p">):</span>
  417     <span class="sd">&quot;&quot;&quot;Match rotatable bond against a generic hierarchy class.&quot;&quot;&quot;</span>
  418     
  419     <span class="n">HierarchyClassElementNode</span> <span class="o">=</span> <span class="n">TorsionLibraryUtil</span><span class="o">.</span><span class="n">GetGenericHierarchyClassElementNode</span><span class="p">(</span><span class="n">TorsionLibraryInfo</span><span class="p">)</span>
  420     <span class="k">if</span> <span class="n">HierarchyClassElementNode</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
  421         <span class="k">return</span> <span class="p">(</span><span class="bp">False</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
  422 
  423     <span class="n">TorsionLibraryUtil</span><span class="o">.</span><span class="n">TrackHierarchyClassElementNode</span><span class="p">(</span><span class="n">TorsionLibraryInfo</span><span class="p">,</span> <span class="n">HierarchyClassElementNode</span><span class="p">)</span>
  424     
  425     <span class="c1">#  Match hierarchy subclasses before matching torsion rules...</span>
  426     <span class="n">MatchStatus</span><span class="p">,</span> <span class="n">MatchInfo</span> <span class="o">=</span> <span class="n">MatchRotatableBondAgainstGenericHierarchySubClasses</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">RotBondAtomIndices</span><span class="p">,</span> <span class="n">HierarchyClassElementNode</span><span class="p">)</span>
  427     
  428     <span class="k">if</span> <span class="ow">not</span> <span class="n">MatchStatus</span><span class="p">:</span>
  429         <span class="n">MatchStatus</span><span class="p">,</span> <span class="n">MatchInfo</span> <span class="o">=</span> <span class="n">MatchRotatableBondAgainstGenericHierarchyTorsionRules</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">RotBondAtomIndices</span><span class="p">,</span> <span class="n">HierarchyClassElementNode</span><span class="p">)</span>
  430     
  431     <span class="n">TorsionLibraryUtil</span><span class="o">.</span><span class="n">RemoveLastHierarchyClassElementNodeFromTracking</span><span class="p">(</span><span class="n">TorsionLibraryInfo</span><span class="p">)</span>
  432     
  433     <span class="k">return</span> <span class="p">(</span><span class="n">MatchStatus</span><span class="p">,</span> <span class="n">MatchInfo</span><span class="p">)</span>
  434 
  435 <span class="k">def</span> <span class="nf">MatchRotatableBondAgainstGenericHierarchySubClasses</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">RotBondAtomIndices</span><span class="p">,</span> <span class="n">HierarchyClassElementNode</span><span class="p">):</span>
  436     <span class="sd">&quot;&quot;&quot;Match rotatable bond againat generic hierarchy subclasses.&quot;&quot;&quot;</span>
  437 
  438     <span class="k">for</span> <span class="n">ElementChildNode</span> <span class="ow">in</span> <span class="n">HierarchyClassElementNode</span><span class="p">:</span>
  439         <span class="k">if</span> <span class="n">ElementChildNode</span><span class="o">.</span><span class="n">tag</span> <span class="o">!=</span> <span class="s2">&quot;hierarchySubClass&quot;</span><span class="p">:</span>
  440             <span class="k">continue</span>
  441         
  442         <span class="n">SubClassMatchStatus</span> <span class="o">=</span> <span class="n">ProcessHierarchySubClassElementForRotatableBondMatch</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">RotBondAtomIndices</span><span class="p">,</span> <span class="n">ElementChildNode</span><span class="p">)</span>
  443         
  444         <span class="k">if</span> <span class="n">SubClassMatchStatus</span><span class="p">:</span>
  445             <span class="n">MatchStatus</span><span class="p">,</span> <span class="n">MatchInfo</span> <span class="o">=</span> <span class="n">ProcessElementForRotatableBondMatch</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">RotBondAtomIndices</span><span class="p">,</span> <span class="n">ElementChildNode</span><span class="p">)</span>
  446             
  447             <span class="k">if</span> <span class="n">MatchStatus</span><span class="p">:</span>
  448                 <span class="k">return</span> <span class="p">(</span><span class="n">MatchStatus</span><span class="p">,</span> <span class="n">MatchInfo</span><span class="p">)</span>
  449         
  450     <span class="k">return</span><span class="p">(</span><span class="bp">False</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
  451 
  452 <span class="k">def</span> <span class="nf">MatchRotatableBondAgainstGenericHierarchyTorsionRules</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">RotBondAtomIndices</span><span class="p">,</span> <span class="n">HierarchyClassElementNode</span><span class="p">):</span>
  453     <span class="sd">&quot;&quot;&quot;Match rotatable bond againat torsion rules generic hierarchy class.&quot;&quot;&quot;</span>
  454     
  455     <span class="k">for</span> <span class="n">ElementChildNode</span> <span class="ow">in</span> <span class="n">HierarchyClassElementNode</span><span class="p">:</span>
  456         <span class="k">if</span> <span class="n">ElementChildNode</span><span class="o">.</span><span class="n">tag</span> <span class="o">!=</span> <span class="s2">&quot;torsionRule&quot;</span><span class="p">:</span>
  457             <span class="k">continue</span>
  458         
  459         <span class="n">MatchStatus</span><span class="p">,</span> <span class="n">MatchInfo</span> <span class="o">=</span> <span class="n">ProcessTorsionRuleElementForRotatableBondMatch</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">RotBondAtomIndices</span><span class="p">,</span> <span class="n">ElementChildNode</span><span class="p">)</span>
  460         
  461         <span class="k">if</span> <span class="n">MatchStatus</span><span class="p">:</span>
  462             <span class="k">return</span> <span class="p">(</span><span class="n">MatchStatus</span><span class="p">,</span> <span class="n">MatchInfo</span><span class="p">)</span>
  463 
  464     <span class="k">return</span><span class="p">(</span><span class="bp">False</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
  465     
  466 <span class="k">def</span> <span class="nf">ProcessElementForRotatableBondMatch</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">RotBondAtomIndices</span><span class="p">,</span> <span class="n">ElementNode</span><span class="p">):</span>
  467     <span class="sd">&quot;&quot;&quot;Process element node to recursively match rotatable bond against hierarchy</span>
  468 <span class="sd">    subclasses and torsion rules.&quot;&quot;&quot;</span>
  469     
  470     <span class="k">for</span> <span class="n">ElementChildNode</span> <span class="ow">in</span> <span class="n">ElementNode</span><span class="p">:</span>
  471         <span class="k">if</span> <span class="n">ElementChildNode</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;hierarchySubClass&quot;</span><span class="p">:</span>
  472             <span class="n">SubClassMatchStatus</span> <span class="o">=</span> <span class="n">ProcessHierarchySubClassElementForRotatableBondMatch</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">RotBondAtomIndices</span><span class="p">,</span> <span class="n">ElementChildNode</span><span class="p">)</span>
  473             
  474             <span class="k">if</span> <span class="n">SubClassMatchStatus</span><span class="p">:</span>
  475                 <span class="n">TorsionLibraryUtil</span><span class="o">.</span><span class="n">TrackHierarchySubClassElementNode</span><span class="p">(</span><span class="n">TorsionLibraryInfo</span><span class="p">,</span> <span class="n">ElementChildNode</span><span class="p">)</span>
  476                 
  477                 <span class="n">MatchStatus</span><span class="p">,</span> <span class="n">MatchInfo</span> <span class="o">=</span> <span class="n">ProcessElementForRotatableBondMatch</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">RotBondAtomIndices</span><span class="p">,</span> <span class="n">ElementChildNode</span><span class="p">)</span>
  478                 <span class="k">if</span> <span class="n">MatchStatus</span><span class="p">:</span>
  479                     <span class="n">TorsionLibraryUtil</span><span class="o">.</span><span class="n">RemoveLastHierarchySubClassElementNodeFromTracking</span><span class="p">(</span><span class="n">TorsionLibraryInfo</span><span class="p">)</span>
  480                     <span class="k">return</span> <span class="p">(</span><span class="n">MatchStatus</span><span class="p">,</span> <span class="n">MatchInfo</span><span class="p">)</span>
  481             
  482                 <span class="n">TorsionLibraryUtil</span><span class="o">.</span><span class="n">RemoveLastHierarchySubClassElementNodeFromTracking</span><span class="p">(</span><span class="n">TorsionLibraryInfo</span><span class="p">)</span>
  483             
  484         <span class="k">elif</span> <span class="n">ElementChildNode</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;torsionRule&quot;</span><span class="p">:</span>
  485             <span class="n">MatchStatus</span><span class="p">,</span> <span class="n">MatchInfo</span> <span class="o">=</span> <span class="n">ProcessTorsionRuleElementForRotatableBondMatch</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">RotBondAtomIndices</span><span class="p">,</span> <span class="n">ElementChildNode</span><span class="p">)</span>
  486             
  487             <span class="k">if</span> <span class="n">MatchStatus</span><span class="p">:</span>
  488                 <span class="k">return</span> <span class="p">(</span><span class="n">MatchStatus</span><span class="p">,</span> <span class="n">MatchInfo</span><span class="p">)</span>
  489     
  490     <span class="k">return</span> <span class="p">(</span><span class="bp">False</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
  491 
  492 <span class="k">def</span> <span class="nf">ProcessHierarchySubClassElementForRotatableBondMatch</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">RotBondAtomIndices</span><span class="p">,</span> <span class="n">ElementNode</span><span class="p">):</span>
  493     <span class="sd">&quot;&quot;&quot;Process hierarchy subclass element to match rotatable bond.&quot;&quot;&quot;</span>
  494     
  495     <span class="c1"># Setup subclass SMARTS pattern mol...</span>
  496     <span class="n">SubClassPatternMol</span> <span class="o">=</span> <span class="n">TorsionLibraryUtil</span><span class="o">.</span><span class="n">SetupHierarchySubClassElementPatternMol</span><span class="p">(</span><span class="n">TorsionLibraryInfo</span><span class="p">,</span> <span class="n">ElementNode</span><span class="p">)</span>
  497     <span class="k">if</span> <span class="n">SubClassPatternMol</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
  498         <span class="k">return</span> <span class="bp">False</span>
  499 
  500     <span class="c1"># Match SMARTS pattern...</span>
  501     <span class="n">SubClassPatternMatches</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">FilterSubstructureMatchesByAtomMapNumbers</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">SubClassPatternMol</span><span class="p">,</span> <span class="n">Mol</span><span class="o">.</span><span class="n">GetSubstructMatches</span><span class="p">(</span><span class="n">SubClassPatternMol</span><span class="p">,</span> <span class="n">useChirality</span> <span class="o">=</span> <span class="bp">False</span><span class="p">))</span>
  502     <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">SubClassPatternMatches</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
  503         <span class="k">return</span> <span class="bp">False</span>
  504 
  505     <span class="c1"># Match rotatable bond indices...</span>
  506     <span class="n">RotBondAtomIndex1</span><span class="p">,</span> <span class="n">RotBondAtomIndex2</span> <span class="o">=</span> <span class="n">RotBondAtomIndices</span>
  507     <span class="n">MatchStatus</span> <span class="o">=</span> <span class="bp">False</span>
  508     <span class="k">for</span> <span class="n">SubClassPatternMatch</span> <span class="ow">in</span> <span class="n">SubClassPatternMatches</span><span class="p">:</span>
  509         <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">SubClassPatternMatch</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
  510             <span class="c1"># Matched to pattern containing map atom numbers &quot;:2&quot; and &quot;:3&quot;...</span>
  511             <span class="n">CentralAtomsIndex1</span><span class="p">,</span> <span class="n">CentralAtomsIndex2</span> <span class="o">=</span> <span class="n">SubClassPatternMatch</span>
  512         <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">SubClassPatternMatch</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
  513             <span class="c1"># Matched to pattern containing map atom numbers &quot;:1&quot;, &quot;:2&quot;, &quot;:3&quot; and &quot;:4&quot;...</span>
  514             <span class="n">CentralAtomsIndex1</span> <span class="o">=</span> <span class="n">SubClassPatternMatch</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
  515             <span class="n">CentralAtomsIndex2</span> <span class="o">=</span> <span class="n">SubClassPatternMatch</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
  516         <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">SubClassPatternMatch</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
  517             <span class="n">SubClassSMARTSPattern</span> <span class="o">=</span> <span class="n">ElementNode</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;smarts&quot;</span><span class="p">)</span>
  518             <span class="k">if</span> <span class="n">TorsionLibraryUtil</span><span class="o">.</span><span class="n">DoesSMARTSContainsMappedAtoms</span><span class="p">(</span><span class="n">SubClassSMARTSPattern</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;:2&quot;</span><span class="p">,</span> <span class="s2">&quot;:3&quot;</span><span class="p">,</span> <span class="s2">&quot;:4&quot;</span><span class="p">]):</span>
  519                 <span class="c1"># Matched to pattern containing map atom numbers &quot;:2&quot;, &quot;:3&quot; and &quot;:4&quot;...</span>
  520                 <span class="n">CentralAtomsIndex1</span> <span class="o">=</span> <span class="n">SubClassPatternMatch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
  521                 <span class="n">CentralAtomsIndex2</span> <span class="o">=</span> <span class="n">SubClassPatternMatch</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
  522             <span class="k">else</span><span class="p">:</span>
  523                 <span class="c1"># Matched to pattern containing map atom numbers &quot;:1&quot;, &quot;:2&quot; and &quot;:3&quot;...</span>
  524                 <span class="n">CentralAtomsIndex1</span> <span class="o">=</span> <span class="n">SubClassPatternMatch</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
  525                 <span class="n">CentralAtomsIndex2</span> <span class="o">=</span> <span class="n">SubClassPatternMatch</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
  526         <span class="k">else</span><span class="p">:</span>
  527             <span class="k">continue</span>
  528 
  529         <span class="k">if</span> <span class="n">CentralAtomsIndex1</span> <span class="o">!=</span> <span class="n">CentralAtomsIndex2</span><span class="p">:</span>
  530             <span class="k">if</span> <span class="p">((</span><span class="n">CentralAtomsIndex1</span> <span class="o">==</span> <span class="n">RotBondAtomIndex1</span> <span class="ow">and</span> <span class="n">CentralAtomsIndex2</span> <span class="o">==</span> <span class="n">RotBondAtomIndex2</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">CentralAtomsIndex1</span> <span class="o">==</span> <span class="n">RotBondAtomIndex2</span> <span class="ow">and</span> <span class="n">CentralAtomsIndex2</span> <span class="o">==</span> <span class="n">RotBondAtomIndex1</span><span class="p">)):</span>
  531                 <span class="n">MatchStatus</span> <span class="o">=</span> <span class="bp">True</span>
  532                 <span class="k">break</span>
  533     
  534     <span class="k">return</span> <span class="p">(</span><span class="n">MatchStatus</span><span class="p">)</span>
  535 
  536 <span class="k">def</span> <span class="nf">ProcessTorsionRuleElementForRotatableBondMatch</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">RotBondAtomIndices</span><span class="p">,</span> <span class="n">ElementNode</span><span class="p">):</span>
  537     <span class="sd">&quot;&quot;&quot;Process torsion rule element to match rotatable bond.&quot;&quot;&quot;</span>
  538     
  539     <span class="c1">#  Retrieve torsion matched to rotatable bond...</span>
  540     <span class="n">TorsionAtomIndices</span><span class="p">,</span> <span class="n">TorsionAngle</span> <span class="o">=</span> <span class="n">MatchTorsionRuleToRotatableBond</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">RotBondAtomIndices</span><span class="p">,</span> <span class="n">ElementNode</span><span class="p">)</span>
  541     <span class="k">if</span> <span class="n">TorsionAtomIndices</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
  542         <span class="k">return</span> <span class="p">(</span><span class="bp">False</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
  543     
  544     <span class="c1"># Setup torsion angles info for matched torsion rule...</span>
  545     <span class="n">TorsionAnglesInfo</span> <span class="o">=</span> <span class="n">TorsionLibraryUtil</span><span class="o">.</span><span class="n">SetupTorsionRuleAnglesInfo</span><span class="p">(</span><span class="n">TorsionLibraryInfo</span><span class="p">,</span> <span class="n">ElementNode</span><span class="p">)</span>
  546     <span class="k">if</span> <span class="n">TorsionAnglesInfo</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
  547         <span class="k">return</span> <span class="p">(</span><span class="bp">False</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
  548     
  549     <span class="c1">#   Setup torsion alert type and angle violation...</span>
  550     <span class="n">AlertType</span><span class="p">,</span> <span class="n">TorsionAngleViolation</span> <span class="o">=</span> <span class="n">SetupTorsionAlertTypeForRotatableBond</span><span class="p">(</span><span class="n">TorsionAnglesInfo</span><span class="p">,</span> <span class="n">TorsionAngle</span><span class="p">)</span>
  551 
  552     <span class="c1"># Setup hierarchy class and subclass names...</span>
  553     <span class="n">HierarchyClassName</span><span class="p">,</span> <span class="n">HierarchySubClassName</span> <span class="o">=</span> <span class="n">TorsionLibraryUtil</span><span class="o">.</span><span class="n">SetupHierarchyClassAndSubClassNamesForRotatableBond</span><span class="p">(</span><span class="n">TorsionLibraryInfo</span><span class="p">)</span>
  554     
  555     <span class="c1"># Setup rule node ID...</span>
  556     <span class="n">TorsionRuleNodeID</span> <span class="o">=</span> <span class="n">ElementNode</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;NodeID&quot;</span><span class="p">)</span>
  557     
  558     <span class="c1"># Setup SMARTS...</span>
  559     <span class="n">TorsionRuleSMARTS</span> <span class="o">=</span> <span class="n">ElementNode</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;smarts&quot;</span><span class="p">)</span>
  560     <span class="k">if</span> <span class="s2">&quot; &quot;</span> <span class="ow">in</span> <span class="n">TorsionRuleSMARTS</span><span class="p">:</span>
  561         <span class="n">TorsionRuleSMARTS</span> <span class="o">=</span> <span class="n">TorsionRuleSMARTS</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
  562     
  563     <span class="c1"># Setup torsion peaks and tolerances...</span>
  564     <span class="n">TorsionRulePeaks</span> <span class="o">=</span> <span class="n">TorsionAnglesInfo</span><span class="p">[</span><span class="s2">&quot;ValuesList&quot;</span><span class="p">]</span>
  565     <span class="n">TorsionRuleTolerances1</span> <span class="o">=</span> <span class="n">TorsionAnglesInfo</span><span class="p">[</span><span class="s2">&quot;Tolerances1List&quot;</span><span class="p">]</span>
  566     <span class="n">TorsionRuleTolerances2</span> <span class="o">=</span> <span class="n">TorsionAnglesInfo</span><span class="p">[</span><span class="s2">&quot;Tolerances2List&quot;</span><span class="p">]</span>
  567     
  568     <span class="n">MatchInfo</span> <span class="o">=</span> <span class="p">[</span><span class="n">AlertType</span><span class="p">,</span> <span class="n">TorsionAtomIndices</span><span class="p">,</span> <span class="n">TorsionAngle</span><span class="p">,</span> <span class="n">TorsionAngleViolation</span><span class="p">,</span> <span class="n">HierarchyClassName</span><span class="p">,</span> <span class="n">HierarchySubClassName</span><span class="p">,</span> <span class="n">TorsionRuleNodeID</span><span class="p">,</span> <span class="n">TorsionRulePeaks</span><span class="p">,</span> <span class="n">TorsionRuleTolerances1</span><span class="p">,</span> <span class="n">TorsionRuleTolerances2</span><span class="p">,</span> <span class="n">TorsionRuleSMARTS</span><span class="p">]</span>
  569 
  570     <span class="c1"># Setup match status...</span>
  571     <span class="n">MatchStatus</span> <span class="o">=</span> <span class="bp">True</span>
  572     
  573     <span class="k">return</span> <span class="p">(</span><span class="n">MatchStatus</span><span class="p">,</span> <span class="n">MatchInfo</span><span class="p">)</span>
  574 
  575 <span class="k">def</span> <span class="nf">MatchTorsionRuleToRotatableBond</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">RotBondAtomIndices</span><span class="p">,</span> <span class="n">ElementNode</span><span class="p">):</span>
  576     <span class="sd">&quot;&quot;&quot;Retrieve matched torsion for torsion rule matched to rotatable bond.&quot;&quot;&quot;</span>
  577 
  578     <span class="c1"># Get torsion matches...</span>
  579     <span class="n">TorsionMatches</span> <span class="o">=</span> <span class="n">GetMatchesForTorsionRule</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">ElementNode</span><span class="p">)</span>
  580     <span class="k">if</span> <span class="n">TorsionMatches</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">TorsionMatches</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
  581         <span class="k">return</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
  582 
  583     <span class="c1"># Identify the first torsion match corresponding to central atoms in RotBondAtomIndices...</span>
  584     <span class="n">RotBondAtomIndex1</span><span class="p">,</span> <span class="n">RotBondAtomIndex2</span> <span class="o">=</span> <span class="n">RotBondAtomIndices</span>
  585     <span class="k">for</span> <span class="n">TorsionMatch</span> <span class="ow">in</span> <span class="n">TorsionMatches</span><span class="p">:</span>
  586         <span class="n">CentralAtomIndex1</span> <span class="o">=</span> <span class="n">TorsionMatch</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
  587         <span class="n">CentralAtomIndex2</span> <span class="o">=</span> <span class="n">TorsionMatch</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
  588         
  589         <span class="k">if</span> <span class="p">((</span><span class="n">CentralAtomIndex1</span> <span class="o">==</span> <span class="n">RotBondAtomIndex1</span> <span class="ow">and</span> <span class="n">CentralAtomIndex2</span> <span class="o">==</span> <span class="n">RotBondAtomIndex2</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">CentralAtomIndex1</span> <span class="o">==</span> <span class="n">RotBondAtomIndex2</span> <span class="ow">and</span> <span class="n">CentralAtomIndex2</span> <span class="o">==</span> <span class="n">RotBondAtomIndex1</span><span class="p">)):</span>
  590             <span class="n">TorsionAngle</span> <span class="o">=</span> <span class="n">CalculateTorsionAngle</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">TorsionMatch</span><span class="p">)</span>
  591             
  592             <span class="k">return</span> <span class="p">(</span><span class="n">TorsionMatch</span><span class="p">,</span> <span class="n">TorsionAngle</span><span class="p">)</span>
  593             
  594     <span class="k">return</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
  595 
  596 <span class="k">def</span> <span class="nf">CalculateTorsionAngle</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">TorsionMatch</span><span class="p">):</span>
  597     <span class="sd">&quot;&quot;&quot;Calculate torsion angle.&quot;&quot;&quot;</span>
  598 
  599     <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">TorsionMatch</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
  600         <span class="k">return</span> <span class="n">CalculateTorsionAngleUsingNitrogenLonePairPosition</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">TorsionMatch</span><span class="p">)</span>
  601 
  602     <span class="c1"># Calculate torsion angle using torsion atom indices..</span>
  603     <span class="n">MolConf</span> <span class="o">=</span> <span class="n">Mol</span><span class="o">.</span><span class="n">GetConformer</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
  604     <span class="n">TorsionAngle</span> <span class="o">=</span> <span class="n">rdMolTransforms</span><span class="o">.</span><span class="n">GetDihedralDeg</span><span class="p">(</span><span class="n">MolConf</span><span class="p">,</span> <span class="n">TorsionMatch</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">TorsionMatch</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">TorsionMatch</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">TorsionMatch</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
  605     <span class="n">TorsionAngle</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">TorsionAngle</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
  606     
  607     <span class="k">return</span> <span class="n">TorsionAngle</span>
  608 
  609 <span class="k">def</span> <span class="nf">CalculateTorsionAngleUsingNitrogenLonePairPosition</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">TorsionMatch</span><span class="p">):</span>
  610     <span class="sd">&quot;&quot;&quot;Calculate torsion angle using nitrogen lone pair positon.&quot;&quot;&quot;</span>
  611 
  612     <span class="c1"># Setup a carbon atom as position holder for lone pair position...</span>
  613     <span class="n">TmpMol</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">RWMol</span><span class="p">(</span><span class="n">Mol</span><span class="p">)</span>
  614     <span class="n">LonePairAtomIndex</span> <span class="o">=</span> <span class="n">TmpMol</span><span class="o">.</span><span class="n">AddAtom</span><span class="p">(</span><span class="n">Chem</span><span class="o">.</span><span class="n">Atom</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span>
  615     
  616     <span class="n">TmpMolConf</span> <span class="o">=</span> <span class="n">TmpMol</span><span class="o">.</span><span class="n">GetConformer</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
  617     <span class="n">TmpMolConf</span><span class="o">.</span><span class="n">SetAtomPosition</span><span class="p">(</span><span class="n">LonePairAtomIndex</span><span class="p">,</span> <span class="n">TorsionMatch</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
  618 
  619     <span class="n">TorsionAngle</span> <span class="o">=</span> <span class="n">rdMolTransforms</span><span class="o">.</span><span class="n">GetDihedralDeg</span><span class="p">(</span><span class="n">TmpMolConf</span><span class="p">,</span> <span class="n">TorsionMatch</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">TorsionMatch</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">TorsionMatch</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">LonePairAtomIndex</span><span class="p">)</span>
  620     <span class="n">TorsionAngle</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">TorsionAngle</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
  621 
  622     <span class="k">return</span> <span class="n">TorsionAngle</span>
  623 
  624 <span class="k">def</span> <span class="nf">GetMatchesForTorsionRule</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">ElementNode</span><span class="p">):</span>
  625     <span class="sd">&quot;&quot;&quot;Get matches for torsion rule.&quot;&quot;&quot;</span>
  626 
  627     <span class="c1"># Match torsions...</span>
  628     <span class="n">TorsionMatches</span> <span class="o">=</span> <span class="bp">None</span>
  629     <span class="k">if</span> <span class="n">IsNitogenLonePairTorsionRule</span><span class="p">(</span><span class="n">ElementNode</span><span class="p">):</span>
  630         <span class="n">TorsionMatches</span> <span class="o">=</span> <span class="n">GetSubstructureMatchesForNitrogenLonePairTorsionRule</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">ElementNode</span><span class="p">)</span>
  631     <span class="k">else</span><span class="p">:</span>
  632         <span class="n">TorsionMatches</span> <span class="o">=</span> <span class="n">GetSubstructureMatchesForTorsionRule</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">ElementNode</span><span class="p">)</span>
  633     
  634     <span class="k">if</span> <span class="n">TorsionMatches</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">TorsionMatches</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
  635         <span class="k">return</span> <span class="n">TorsionMatches</span>
  636 
  637     <span class="c1"># Filter torsion matches...</span>
  638     <span class="n">FiltertedTorsionMatches</span> <span class="o">=</span> <span class="p">[]</span>
  639     <span class="k">for</span> <span class="n">TorsionMatch</span> <span class="ow">in</span> <span class="n">TorsionMatches</span><span class="p">:</span>
  640         <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">TorsionMatch</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">:</span>
  641             <span class="k">continue</span>
  642 
  643         <span class="c1"># Ignore matches containing hydrogen atoms as first or last atom...</span>
  644         <span class="k">if</span> <span class="n">Mol</span><span class="o">.</span><span class="n">GetAtomWithIdx</span><span class="p">(</span><span class="n">TorsionMatch</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">GetAtomicNum</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
  645             <span class="k">continue</span>
  646         <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">TorsionMatch</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
  647             <span class="c1"># May contains a list for type two nitrogen lone pair match...</span>
  648             <span class="k">if</span> <span class="n">Mol</span><span class="o">.</span><span class="n">GetAtomWithIdx</span><span class="p">(</span><span class="n">TorsionMatch</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span><span class="o">.</span><span class="n">GetAtomicNum</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
  649                 <span class="k">continue</span>
  650         <span class="n">FiltertedTorsionMatches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TorsionMatch</span><span class="p">)</span>
  651     
  652     <span class="k">return</span> <span class="n">FiltertedTorsionMatches</span>
  653 
  654 <span class="k">def</span> <span class="nf">GetSubstructureMatchesForTorsionRule</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">ElementNode</span><span class="p">):</span>
  655     <span class="sd">&quot;&quot;&quot;Get substructure matches for a torsion rule.&quot;&quot;&quot;</span>
  656     
  657     <span class="c1"># Setup torsion rule SMARTS pattern mol....</span>
  658     <span class="n">TorsionRuleNodeID</span> <span class="o">=</span> <span class="n">ElementNode</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;NodeID&quot;</span><span class="p">)</span>
  659     <span class="n">TorsionSMARTSPattern</span> <span class="o">=</span> <span class="n">ElementNode</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;smarts&quot;</span><span class="p">)</span>
  660     <span class="n">TorsionPatternMol</span> <span class="o">=</span> <span class="n">TorsionLibraryUtil</span><span class="o">.</span><span class="n">SetupTorsionRuleElementPatternMol</span><span class="p">(</span><span class="n">TorsionLibraryInfo</span><span class="p">,</span> <span class="n">ElementNode</span><span class="p">,</span> <span class="n">TorsionRuleNodeID</span><span class="p">,</span> <span class="n">TorsionSMARTSPattern</span><span class="p">)</span>
  661     <span class="k">if</span> <span class="n">TorsionPatternMol</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
  662         <span class="k">return</span> <span class="bp">None</span>
  663     
  664     <span class="c1"># Match torsions...</span>
  665     <span class="n">TorsionMatches</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">FilterSubstructureMatchesByAtomMapNumbers</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">TorsionPatternMol</span><span class="p">,</span> <span class="n">Mol</span><span class="o">.</span><span class="n">GetSubstructMatches</span><span class="p">(</span><span class="n">TorsionPatternMol</span><span class="p">,</span> <span class="n">useChirality</span> <span class="o">=</span> <span class="bp">False</span><span class="p">))</span>
  666     
  667     <span class="k">return</span> <span class="n">TorsionMatches</span>
  668 
  669 <span class="k">def</span> <span class="nf">GetSubstructureMatchesForNitrogenLonePairTorsionRule</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">ElementNode</span><span class="p">):</span>
  670     <span class="sd">&quot;&quot;&quot;Get substructure matches for a torsion rule containing N_lp.&quot;&quot;&quot;</span>
  671 
  672     <span class="k">if</span> <span class="n">IsTypeOneNitogenLonePairTorsionRule</span><span class="p">(</span><span class="n">ElementNode</span><span class="p">):</span>
  673         <span class="k">return</span> <span class="n">GetSubstructureMatchesForTypeOneNitrogenLonePairTorsionRule</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">ElementNode</span><span class="p">)</span>
  674     <span class="k">elif</span> <span class="n">IsTypeTwoNitogenLonePairTorsionRule</span><span class="p">(</span><span class="n">ElementNode</span><span class="p">):</span>
  675         <span class="k">return</span> <span class="n">GetSubstructureMatchesForTypeTwoNitrogenLonePairTorsionRule</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">ElementNode</span><span class="p">)</span>
  676     
  677     <span class="k">return</span> <span class="bp">None</span>
  678 
  679 <span class="k">def</span> <span class="nf">GetSubstructureMatchesForTypeOneNitrogenLonePairTorsionRule</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">ElementNode</span><span class="p">):</span>
  680     <span class="sd">&quot;&quot;&quot;Get substructure matches for a torsion rule containing N_lp and four mapped atoms.&quot;&quot;&quot;</span>
  681 
  682     <span class="c1"># For example:</span>
  683     <span class="c1">#    [CX4:1][CX4H2:2]!@[NX3;&quot;N_lp&quot;:3][CX4:4]</span>
  684     <span class="c1">#    [C:1][CX4H2:2]!@[NX3;&quot;N_lp&quot;:3][C:4]</span>
  685     <span class="c1">#    ... ... ...</span>
  686 
  687     <span class="n">TorsionRuleNodeID</span> <span class="o">=</span> <span class="n">ElementNode</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;NodeID&quot;</span><span class="p">)</span>
  688     <span class="n">TorsionPatternMol</span><span class="p">,</span> <span class="n">LonePairMapNumber</span> <span class="o">=</span> <span class="n">SetupNitrogenLonePairTorsionRuleElementInfo</span><span class="p">(</span><span class="n">ElementNode</span><span class="p">,</span> <span class="n">TorsionRuleNodeID</span><span class="p">)</span>
  689     
  690     <span class="k">if</span> <span class="n">TorsionPatternMol</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
  691         <span class="k">return</span> <span class="bp">None</span>
  692     
  693     <span class="k">if</span> <span class="n">LonePairMapNumber</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
  694         <span class="k">return</span> <span class="bp">None</span>
  695     
  696     <span class="c1"># Match torsions...</span>
  697     <span class="n">TorsionMatches</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">FilterSubstructureMatchesByAtomMapNumbers</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">TorsionPatternMol</span><span class="p">,</span> <span class="n">Mol</span><span class="o">.</span><span class="n">GetSubstructMatches</span><span class="p">(</span><span class="n">TorsionPatternMol</span><span class="p">,</span> <span class="n">useChirality</span> <span class="o">=</span> <span class="bp">False</span><span class="p">))</span>
  698 
  699     <span class="c1"># Filter matches...</span>
  700     <span class="n">FiltertedTorsionMatches</span> <span class="o">=</span> <span class="p">[]</span>
  701     <span class="k">for</span> <span class="n">TorsionMatch</span> <span class="ow">in</span> <span class="n">TorsionMatches</span><span class="p">:</span>
  702         <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">TorsionMatch</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">:</span>
  703             <span class="k">continue</span>
  704         
  705         <span class="c1"># Check for Nitogen atom at LonePairMapNumber...</span>
  706         <span class="n">LonePairNitrogenAtom</span> <span class="o">=</span> <span class="n">Mol</span><span class="o">.</span><span class="n">GetAtomWithIdx</span><span class="p">(</span><span class="n">TorsionMatch</span><span class="p">[</span><span class="n">LonePairMapNumber</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
  707         <span class="k">if</span> <span class="n">LonePairNitrogenAtom</span><span class="o">.</span><span class="n">GetSymbol</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;N&quot;</span><span class="p">:</span>
  708             <span class="k">continue</span>
  709         
  710         <span class="c1"># Make sure LonePairNitrogenAtom is planar...</span>
  711         <span class="c1">#  test</span>
  712         <span class="n">PlanarityStatus</span> <span class="o">=</span> <span class="n">IsLonePairNitrogenAtomPlanar</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">LonePairNitrogenAtom</span><span class="p">)</span>
  713         <span class="k">if</span> <span class="n">PlanarityStatus</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
  714             <span class="k">continue</span>
  715         
  716         <span class="k">if</span>  <span class="ow">not</span> <span class="n">PlanarityStatus</span><span class="p">:</span>
  717             <span class="k">continue</span>
  718         
  719         <span class="n">FiltertedTorsionMatches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TorsionMatch</span><span class="p">)</span>
  720         
  721     <span class="k">return</span> <span class="n">FiltertedTorsionMatches</span>
  722     
  723 <span class="k">def</span> <span class="nf">GetSubstructureMatchesForTypeTwoNitrogenLonePairTorsionRule</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">ElementNode</span><span class="p">):</span>
  724     <span class="sd">&quot;&quot;&quot;Get substructure matches for a torsion rule containing N_lp and three mapped atoms.&quot;&quot;&quot;</span>
  725 
  726     <span class="c1"># For example:</span>
  727     <span class="c1"># [!#1:1][CX4:2]!@[NX3;&quot;N_lp&quot;:3]</span>
  728     <span class="c1"># [!#1:1][$(S(=O)=O):2]!@[&quot;N_lp&quot;:3]@[Cr3]</span>
  729     <span class="c1"># [C:1][$(S(=O)=O):2]!@[&quot;N_lp&quot;:3]</span>
  730     <span class="c1"># [c:1][$(S(=O)=O):2]!@[&quot;N_lp&quot;:3]</span>
  731     <span class="c1"># [!#1:1][$(S(=O)=O):2]!@[&quot;N_lp&quot;:3]</span>
  732     <span class="c1">#    ... ... ...</span>
  733     
  734     <span class="n">TorsionRuleNodeID</span> <span class="o">=</span> <span class="n">ElementNode</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;NodeID&quot;</span><span class="p">)</span>
  735     <span class="n">TorsionPatternMol</span><span class="p">,</span> <span class="n">LonePairMapNumber</span> <span class="o">=</span> <span class="n">SetupNitrogenLonePairTorsionRuleElementInfo</span><span class="p">(</span><span class="n">ElementNode</span><span class="p">,</span> <span class="n">TorsionRuleNodeID</span><span class="p">)</span>
  736     
  737     <span class="k">if</span> <span class="n">TorsionPatternMol</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
  738         <span class="k">return</span> <span class="bp">None</span>
  739     
  740     <span class="k">if</span> <span class="ow">not</span> <span class="n">IsValidTypeTwoNitrogenLonePairMapNumber</span><span class="p">(</span><span class="n">LonePairMapNumber</span><span class="p">):</span>
  741         <span class="k">return</span> <span class="bp">None</span>
  742 
  743     <span class="c1"># Match torsions...</span>
  744     <span class="n">TorsionMatches</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">FilterSubstructureMatchesByAtomMapNumbers</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">TorsionPatternMol</span><span class="p">,</span> <span class="n">Mol</span><span class="o">.</span><span class="n">GetSubstructMatches</span><span class="p">(</span><span class="n">TorsionPatternMol</span><span class="p">,</span> <span class="n">useChirality</span> <span class="o">=</span> <span class="bp">False</span><span class="p">))</span>
  745 
  746     <span class="c1"># Filter matches...</span>
  747     <span class="n">FiltertedTorsionMatches</span> <span class="o">=</span> <span class="p">[]</span>
  748     <span class="k">for</span> <span class="n">TorsionMatch</span> <span class="ow">in</span> <span class="n">TorsionMatches</span><span class="p">:</span>
  749         <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">TorsionMatch</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
  750             <span class="k">continue</span>
  751         
  752         <span class="c1"># Check for Nitogen atom at LonePairMapNumber...</span>
  753         <span class="n">LonePairNitrogenAtom</span> <span class="o">=</span> <span class="n">Mol</span><span class="o">.</span><span class="n">GetAtomWithIdx</span><span class="p">(</span><span class="n">TorsionMatch</span><span class="p">[</span><span class="n">LonePairMapNumber</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
  754         <span class="k">if</span> <span class="n">LonePairNitrogenAtom</span><span class="o">.</span><span class="n">GetSymbol</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;N&quot;</span><span class="p">:</span>
  755             <span class="k">continue</span>
  756 
  757         <span class="c1"># Make sure LonePairNitrogenAtom is not planar...</span>
  758         <span class="n">PlanarityStatus</span> <span class="o">=</span> <span class="n">IsLonePairNitrogenAtomPlanar</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">LonePairNitrogenAtom</span><span class="p">)</span>
  759         
  760         <span class="k">if</span> <span class="n">PlanarityStatus</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
  761             <span class="k">continue</span>
  762         
  763         <span class="k">if</span>  <span class="n">PlanarityStatus</span><span class="p">:</span>
  764             <span class="k">continue</span>
  765         
  766         <span class="c1"># Calculate lone pair coordinates for a non-planar nitrogen...</span>
  767         <span class="n">LonePairPosition</span> <span class="o">=</span> <span class="n">CalculateLonePairCoordinatesForNitrogenAtom</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">LonePairNitrogenAtom</span><span class="p">)</span>
  768         <span class="k">if</span> <span class="n">LonePairPosition</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
  769             <span class="k">continue</span>
  770 
  771         <span class="c1"># Append lone pair coodinate list to list of torsion match containing atom indices...</span>
  772         <span class="n">TorsionMatch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">LonePairPosition</span><span class="p">)</span>
  773 
  774         <span class="c1"># Track torsion matches...</span>
  775         <span class="n">FiltertedTorsionMatches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TorsionMatch</span><span class="p">)</span>
  776         
  777     <span class="k">return</span> <span class="n">FiltertedTorsionMatches</span>
  778 
  779 <span class="k">def</span> <span class="nf">SetupNitrogenLonePairTorsionRuleElementInfo</span><span class="p">(</span><span class="n">ElementNode</span><span class="p">,</span> <span class="n">TorsionRuleNodeID</span><span class="p">):</span>
  780     <span class="sd">&quot;&quot;&quot;Setup pattern molecule and lone pair map number for type one and type</span>
  781 <span class="sd">    two nitrogen lone pair rules.&quot;&quot;&quot;</span>
  782 
  783     <span class="n">TorsionPatternMol</span><span class="p">,</span> <span class="n">LonePairMapNumber</span> <span class="o">=</span> <span class="p">[</span><span class="bp">None</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span>
  784     
  785     <span class="k">if</span> <span class="n">TorsionRuleNodeID</span> <span class="ow">in</span> <span class="n">TorsionLibraryInfo</span><span class="p">[</span><span class="s2">&quot;DataCache&quot;</span><span class="p">][</span><span class="s2">&quot;TorsionRulePatternMol&quot;</span><span class="p">]:</span>
  786         <span class="n">TorsionPatternMol</span> <span class="o">=</span> <span class="n">TorsionLibraryInfo</span><span class="p">[</span><span class="s2">&quot;DataCache&quot;</span><span class="p">][</span><span class="s2">&quot;TorsionRulePatternMol&quot;</span><span class="p">][</span><span class="n">TorsionRuleNodeID</span><span class="p">]</span>
  787         <span class="n">LonePairMapNumber</span> <span class="o">=</span> <span class="n">TorsionLibraryInfo</span><span class="p">[</span><span class="s2">&quot;DataCache&quot;</span><span class="p">][</span><span class="s2">&quot;TorsionRuleLonePairMapNumber&quot;</span><span class="p">][</span><span class="n">TorsionRuleNodeID</span><span class="p">]</span>
  788     <span class="k">else</span><span class="p">:</span>
  789         <span class="c1"># Setup torsion pattern...</span>
  790         <span class="n">TorsionSMARTSPattern</span> <span class="o">=</span> <span class="n">ElementNode</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;smarts&quot;</span><span class="p">)</span>
  791         <span class="n">TorsionSMARTSPattern</span><span class="p">,</span> <span class="n">LonePairMapNumber</span> <span class="o">=</span> <span class="n">ProcessSMARTSForNitrogenLonePairTorsionRule</span><span class="p">(</span><span class="n">TorsionSMARTSPattern</span><span class="p">)</span>
  792         
  793         <span class="c1"># Setup torsion pattern mol...</span>
  794         <span class="n">TorsionPatternMol</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">MolFromSmarts</span><span class="p">(</span><span class="n">TorsionSMARTSPattern</span><span class="p">)</span>
  795         <span class="k">if</span> <span class="n">TorsionPatternMol</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
  796             <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintWarning</span><span class="p">(</span><span class="s2">&quot;Ignoring torsion rule element containing invalid map atoms numbers in SMARTS pattern </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">TorsionSMARTSPattern</span><span class="p">)</span>
  797 
  798         <span class="c1"># Cache data...</span>
  799         <span class="n">TorsionLibraryInfo</span><span class="p">[</span><span class="s2">&quot;DataCache&quot;</span><span class="p">][</span><span class="s2">&quot;TorsionRulePatternMol&quot;</span><span class="p">][</span><span class="n">TorsionRuleNodeID</span><span class="p">]</span> <span class="o">=</span> <span class="n">TorsionPatternMol</span>
  800         <span class="n">TorsionLibraryInfo</span><span class="p">[</span><span class="s2">&quot;DataCache&quot;</span><span class="p">][</span><span class="s2">&quot;TorsionRuleLonePairMapNumber&quot;</span><span class="p">][</span><span class="n">TorsionRuleNodeID</span><span class="p">]</span> <span class="o">=</span> <span class="n">LonePairMapNumber</span>
  801 
  802     <span class="k">return</span> <span class="p">(</span><span class="n">TorsionPatternMol</span><span class="p">,</span> <span class="n">LonePairMapNumber</span><span class="p">)</span>
  803 
  804 <span class="k">def</span> <span class="nf">IsLonePairNitrogenAtomPlanar</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">NitrogenAtom</span><span class="p">):</span>
  805     <span class="sd">&quot;&quot;&quot;Check for the planarity of nitrogen atom and its three neighbors.&quot;&quot;&quot;</span>
  806 
  807     <span class="n">AllowHydrogenNbrs</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;NitrogenLonePairParams&quot;</span><span class="p">][</span><span class="s2">&quot;AllowHydrogenNbrs&quot;</span><span class="p">]</span>
  808     <span class="n">Tolerance</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;NitrogenLonePairParams&quot;</span><span class="p">][</span><span class="s2">&quot;PlanarityTolerance&quot;</span><span class="p">]</span>
  809     
  810     <span class="c1"># Get neighbors...</span>
  811     <span class="k">if</span> <span class="n">AllowHydrogenNbrs</span><span class="p">:</span>
  812         <span class="n">AtomNeighbors</span> <span class="o">=</span> <span class="n">NitrogenAtom</span><span class="o">.</span><span class="n">GetNeighbors</span><span class="p">()</span>
  813     <span class="k">else</span><span class="p">:</span>
  814         <span class="n">AtomNeighbors</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">GetHeavyAtomNeighbors</span><span class="p">(</span><span class="n">NitrogenAtom</span><span class="p">)</span>
  815 
  816     <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">AtomNeighbors</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
  817         <span class="k">return</span> <span class="bp">None</span>
  818 
  819     <span class="c1"># Setup atom positions...</span>
  820     <span class="n">AtomPositions</span> <span class="o">=</span> <span class="p">[]</span>
  821     <span class="n">MolAtomsPositions</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">GetAtomPositions</span><span class="p">(</span><span class="n">Mol</span><span class="p">)</span>
  822 
  823     <span class="c1"># Neighbor positions...</span>
  824     <span class="k">for</span> <span class="n">AtomNbr</span> <span class="ow">in</span> <span class="n">AtomNeighbors</span><span class="p">:</span>
  825         <span class="n">AtomNbrIndex</span> <span class="o">=</span> <span class="n">AtomNbr</span><span class="o">.</span><span class="n">GetIdx</span><span class="p">()</span>
  826         <span class="n">AtomPositions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">MolAtomsPositions</span><span class="p">[</span><span class="n">AtomNbrIndex</span><span class="p">])</span>
  827 
  828     <span class="c1"># Nitrogen position...</span>
  829     <span class="n">NitrogenAtomIndex</span> <span class="o">=</span> <span class="n">NitrogenAtom</span><span class="o">.</span><span class="n">GetIdx</span><span class="p">()</span>
  830     <span class="n">AtomPositions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">MolAtomsPositions</span><span class="p">[</span><span class="n">NitrogenAtomIndex</span><span class="p">])</span>
  831     
  832     <span class="n">Status</span> <span class="o">=</span>  <span class="n">AreFourPointsCoplanar</span><span class="p">(</span><span class="n">AtomPositions</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">AtomPositions</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">AtomPositions</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">AtomPositions</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">Tolerance</span><span class="p">)</span>
  833     
  834     <span class="k">return</span> <span class="n">Status</span>
  835 
  836 <span class="k">def</span> <span class="nf">AreFourPointsCoplanar</span><span class="p">(</span><span class="n">Point1</span><span class="p">,</span> <span class="n">Point2</span><span class="p">,</span> <span class="n">Point3</span><span class="p">,</span> <span class="n">Point4</span><span class="p">,</span> <span class="n">Tolerance</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">):</span>
  837     <span class="sd">&quot;&quot;&quot;Check whether four points are coplanar with in the threshold of 1 degree.&quot;&quot;&quot;</span>
  838 
  839     <span class="c1"># Setup  normalized direction vectors...</span>
  840     <span class="n">VectorP2P1</span> <span class="o">=</span> <span class="n">NormalizeVector</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">Point2</span><span class="p">,</span> <span class="n">Point1</span><span class="p">))</span>
  841     <span class="n">VectorP3P1</span> <span class="o">=</span> <span class="n">NormalizeVector</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">Point3</span><span class="p">,</span> <span class="n">Point1</span><span class="p">))</span>
  842     <span class="n">VectorP1P4</span> <span class="o">=</span> <span class="n">NormalizeVector</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">Point1</span><span class="p">,</span> <span class="n">Point4</span><span class="p">))</span>
  843 
  844     <span class="c1"># Calculate angle between VectorP1P4 and normal to vectors VectorP2P1 and VectorP3P1...</span>
  845     <span class="n">PlaneP1P2P3Normal</span> <span class="o">=</span> <span class="n">NormalizeVector</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">VectorP2P1</span><span class="p">,</span> <span class="n">VectorP3P1</span><span class="p">))</span>
  846     <span class="n">PlanarityAngle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">PlaneP1P2P3Normal</span><span class="p">,</span> <span class="n">VectorP1P4</span><span class="p">),</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">))</span>
  847     
  848     <span class="n">Status</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">PlanarityAngle</span><span class="p">,</span> <span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="mi">90</span><span class="p">),</span> <span class="n">abs_tol</span><span class="o">=</span><span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">Tolerance</span><span class="p">))</span>
  849 
  850     <span class="k">return</span> <span class="n">Status</span>
  851 
  852 <span class="k">def</span> <span class="nf">NormalizeVector</span><span class="p">(</span><span class="n">Vector</span><span class="p">):</span>
  853     <span class="sd">&quot;&quot;&quot;Normalize vector.&quot;&quot;&quot;</span>
  854 
  855     <span class="n">Norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">Vector</span><span class="p">)</span>
  856     
  857     <span class="k">return</span> <span class="n">Vector</span> <span class="k">if</span> <span class="n">math</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">Norm</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">abs_tol</span> <span class="o">=</span> <span class="mf">1e-08</span><span class="p">)</span> <span class="k">else</span> <span class="n">Vector</span><span class="o">/</span><span class="n">Norm</span>
  858 
  859 <span class="k">def</span> <span class="nf">CalculateLonePairCoordinatesForNitrogenAtom</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">NitrogenAtom</span><span class="p">):</span>
  860     <span class="sd">&quot;&quot;&quot;Calculate approximate lone pair coordinates for non-plannar nitrogen atom.&quot;&quot;&quot;</span>
  861 
  862     <span class="n">AllowHydrogenNbrs</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;NitrogenLonePairParams&quot;</span><span class="p">][</span><span class="s2">&quot;AllowHydrogenNbrs&quot;</span><span class="p">]</span>
  863     
  864     <span class="c1"># Get neighbors...</span>
  865     <span class="k">if</span> <span class="n">AllowHydrogenNbrs</span><span class="p">:</span>
  866         <span class="n">AtomNeighbors</span> <span class="o">=</span> <span class="n">NitrogenAtom</span><span class="o">.</span><span class="n">GetNeighbors</span><span class="p">()</span>
  867     <span class="k">else</span><span class="p">:</span>
  868         <span class="n">AtomNeighbors</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">GetHeavyAtomNeighbors</span><span class="p">(</span><span class="n">NitrogenAtom</span><span class="p">)</span>
  869         
  870     <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">AtomNeighbors</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
  871         <span class="k">return</span> <span class="bp">None</span>
  872     
  873     <span class="c1"># Setup positions for nitrogen and its neghbors...</span>
  874     <span class="n">MolAtomsPositions</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">GetAtomPositions</span><span class="p">(</span><span class="n">Mol</span><span class="p">)</span>
  875 
  876     <span class="n">NitrogenPosition</span> <span class="o">=</span> <span class="n">MolAtomsPositions</span><span class="p">[</span><span class="n">NitrogenAtom</span><span class="o">.</span><span class="n">GetIdx</span><span class="p">()]</span>
  877     <span class="n">NbrPositions</span> <span class="o">=</span> <span class="p">[]</span>
  878     <span class="k">for</span> <span class="n">AtomNbr</span> <span class="ow">in</span> <span class="n">AtomNeighbors</span><span class="p">:</span>
  879         <span class="n">NbrPositions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">MolAtomsPositions</span><span class="p">[</span><span class="n">AtomNbr</span><span class="o">.</span><span class="n">GetIdx</span><span class="p">()])</span>
  880     <span class="n">Nbr1Position</span><span class="p">,</span> <span class="n">Nbr2Position</span><span class="p">,</span> <span class="n">Nbr3Position</span> <span class="o">=</span> <span class="n">NbrPositions</span>
  881 
  882     <span class="c1"># Setup  normalized direction vectors...</span>
  883     <span class="n">VectorP2P1</span> <span class="o">=</span> <span class="n">NormalizeVector</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">Nbr2Position</span><span class="p">,</span> <span class="n">Nbr1Position</span><span class="p">))</span>
  884     <span class="n">VectorP3P1</span> <span class="o">=</span> <span class="n">NormalizeVector</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">Nbr3Position</span><span class="p">,</span> <span class="n">Nbr1Position</span><span class="p">))</span>
  885     <span class="n">VectorP1P4</span> <span class="o">=</span> <span class="n">NormalizeVector</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">Nbr1Position</span><span class="p">,</span> <span class="n">NitrogenPosition</span><span class="p">))</span>
  886 
  887     <span class="c1"># Calculate angle between VectorP1P4 and normal to vectors VectorP2P1 and VectorP3P1...</span>
  888     <span class="n">PlaneP1P2P3Normal</span> <span class="o">=</span> <span class="n">NormalizeVector</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">VectorP2P1</span><span class="p">,</span> <span class="n">VectorP3P1</span><span class="p">))</span>
  889     <span class="n">PlanarityAngle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">PlaneP1P2P3Normal</span><span class="p">,</span> <span class="n">VectorP1P4</span><span class="p">),</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">))</span>
  890 
  891     <span class="c1"># Check for reversing the direction of the normal...</span>
  892     <span class="k">if</span> <span class="n">PlanarityAngle</span> <span class="o">&lt;</span> <span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="mi">90</span><span class="p">):</span>
  893         <span class="n">PlaneP1P2P3Normal</span> <span class="o">=</span> <span class="n">PlaneP1P2P3Normal</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span>
  894 
  895     <span class="c1"># Add normal to nitrogen cooridnates for the approximate coordinates of the</span>
  896     <span class="c1"># one pair. The exact VSEPR coordinates of the lone pair are not necessary to</span>
  897     <span class="c1"># calculate the torsion angle...</span>
  898     <span class="n">LonePairPosition</span> <span class="o">=</span> <span class="n">NitrogenPosition</span> <span class="o">+</span> <span class="n">PlaneP1P2P3Normal</span>
  899     
  900     <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">LonePairPosition</span><span class="p">)</span>
  901 
  902 <span class="k">def</span> <span class="nf">ProcessSMARTSForNitrogenLonePairTorsionRule</span><span class="p">(</span><span class="n">SMARTSPattern</span><span class="p">):</span>
  903     <span class="sd">&quot;&quot;&quot;Process SMARTS pattern for a torion rule containing N_lp.&quot;&quot;&quot;</span>
  904 
  905     <span class="n">LonePairMapNumber</span> <span class="o">=</span> <span class="n">GetNitrogenLonePairMapNumber</span><span class="p">(</span><span class="n">SMARTSPattern</span><span class="p">)</span>
  906     
  907     <span class="c1"># Remove double quotes around N_lp..</span>
  908     <span class="n">SMARTSPattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">N_lp</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;N_lp&quot;</span><span class="p">,</span> <span class="n">SMARTSPattern</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span>
  909     
  910     <span class="c1"># Remove N_lp specification from SMARTS pattern for torsion rule...</span>
  911     <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;\[N_lp&quot;</span><span class="p">,</span> <span class="n">SMARTSPattern</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
  912         <span class="c1"># Handle missing NX3...</span>
  913         <span class="n">SMARTSPattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;\[N_lp&quot;</span><span class="p">,</span> <span class="s2">&quot;[NX3&quot;</span><span class="p">,</span> <span class="n">SMARTSPattern</span><span class="p">)</span>
  914     <span class="k">else</span><span class="p">:</span>
  915         <span class="n">SMARTSPattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;;N_lp&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">SMARTSPattern</span><span class="p">)</span>
  916         
  917     <span class="k">return</span> <span class="p">(</span><span class="n">SMARTSPattern</span><span class="p">,</span> <span class="n">LonePairMapNumber</span><span class="p">)</span>
  918 
  919 <span class="k">def</span> <span class="nf">GetNitrogenLonePairMapNumber</span><span class="p">(</span><span class="n">SMARTSPattern</span><span class="p">):</span>
  920     <span class="sd">&quot;&quot;&quot;Get atom map number for nitrogen involved in N_lp.&quot;&quot;&quot;</span>
  921     
  922     <span class="n">LonePairMapNumber</span> <span class="o">=</span> <span class="bp">None</span>
  923     
  924     <span class="n">SMARTSPattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">N_lp</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;N_lp&quot;</span><span class="p">,</span> <span class="n">SMARTSPattern</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span>
  925     <span class="n">MatchedMappedAtoms</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;N_lp:[0-9]&quot;</span><span class="p">,</span> <span class="n">SMARTSPattern</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span>
  926     
  927     <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">MatchedMappedAtoms</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
  928         <span class="n">LonePairMapNumber</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;N_lp:&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">MatchedMappedAtoms</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
  929 
  930     <span class="k">return</span> <span class="n">LonePairMapNumber</span>
  931 
  932 <span class="k">def</span> <span class="nf">IsNitogenLonePairTorsionRule</span><span class="p">(</span><span class="n">ElementNode</span><span class="p">):</span>
  933     <span class="sd">&quot;&quot;&quot;Check for the presence of N_lp in SMARTS pattern for a torsion rule.&quot;&quot;&quot;</span>
  934 
  935     <span class="k">if</span> <span class="s2">&quot;N_lp&quot;</span> <span class="ow">not</span>  <span class="ow">in</span> <span class="n">ElementNode</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;smarts&quot;</span><span class="p">):</span>
  936         <span class="k">return</span> <span class="bp">False</span>
  937     
  938     <span class="n">LonePairMatches</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;N_lp&quot;</span><span class="p">,</span> <span class="n">ElementNode</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;smarts&quot;</span><span class="p">),</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span>
  939     
  940     <span class="k">return</span> <span class="bp">True</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">LonePairMatches</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="bp">False</span>
  941     
  942 <span class="k">def</span> <span class="nf">IsTypeOneNitogenLonePairTorsionRule</span><span class="p">(</span><span class="n">ElementNode</span><span class="p">):</span>
  943     <span class="sd">&quot;&quot;&quot;Check for the presence four mapped atoms in a SMARTS pattern containing</span>
  944 <span class="sd">    N_lp for a torsion rule.&quot;&quot;&quot;</span>
  945 
  946     <span class="c1"># For example:</span>
  947     <span class="c1">#    [CX4:1][CX4H2:2]!@[NX3;&quot;N_lp&quot;:3][CX4:4]</span>
  948     <span class="c1">#    [C:1][CX4H2:2]!@[NX3;&quot;N_lp&quot;:3][C:4]</span>
  949     <span class="c1">#    ... ... ...</span>
  950     
  951     <span class="n">MatchedMappedAtoms</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;:[0-9]&quot;</span><span class="p">,</span> <span class="n">ElementNode</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;smarts&quot;</span><span class="p">),</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span>
  952 
  953     <span class="k">return</span> <span class="bp">True</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">MatchedMappedAtoms</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span> <span class="k">else</span> <span class="bp">False</span>
  954     
  955 <span class="k">def</span> <span class="nf">IsTypeTwoNitogenLonePairTorsionRule</span><span class="p">(</span><span class="n">ElementNode</span><span class="p">):</span>
  956     <span class="sd">&quot;&quot;&quot;Check for the presence three mapped atoms in a SMARTS pattern containing</span>
  957 <span class="sd">    N_lp for a torsion rule.&quot;&quot;&quot;</span>
  958 
  959     <span class="c1"># For example:</span>
  960     <span class="c1"># [!#1:1][CX4:2]!@[NX3;&quot;N_lp&quot;:3]</span>
  961     <span class="c1"># [!#1:1][$(S(=O)=O):2]!@[&quot;N_lp&quot;:3]@[Cr3]</span>
  962     <span class="c1"># [C:1][$(S(=O)=O):2]!@[&quot;N_lp&quot;:3]</span>
  963     <span class="c1"># [c:1][$(S(=O)=O):2]!@[&quot;N_lp&quot;:3]</span>
  964     <span class="c1"># [!#1:1][$(S(=O)=O):2]!@[&quot;N_lp&quot;:3]</span>
  965     <span class="c1">#</span>
  966     
  967     <span class="n">MatchedMappedAtoms</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;:[0-9]&quot;</span><span class="p">,</span> <span class="n">ElementNode</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;smarts&quot;</span><span class="p">),</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span>
  968 
  969     <span class="k">return</span> <span class="bp">True</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">MatchedMappedAtoms</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span> <span class="k">else</span> <span class="bp">False</span>
  970 
  971 <span class="k">def</span> <span class="nf">IsValidTypeTwoNitogenLonePairTorsionRule</span><span class="p">(</span><span class="n">ElementNode</span><span class="p">):</span>
  972     <span class="sd">&quot;&quot;&quot;Validate atom map number for nitrogen involved in N_lp for type two nitrogen</span>
  973 <span class="sd">    lone pair torsion rule.&quot;&quot;&quot;</span>
  974 
  975     <span class="n">LonePairMapNumber</span> <span class="o">=</span> <span class="n">GetNitrogenLonePairMapNumber</span><span class="p">(</span><span class="n">ElementNode</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;smarts&quot;</span><span class="p">))</span>
  976     
  977     <span class="k">return</span> <span class="n">IsValidTypeTwoNitrogenLonePairMapNumber</span><span class="p">(</span><span class="n">LonePairMapNumber</span><span class="p">)</span>
  978 
  979 <span class="k">def</span> <span class="nf">IsValidTypeTwoNitrogenLonePairMapNumber</span><span class="p">(</span><span class="n">LonePairMapNumber</span><span class="p">):</span>
  980     <span class="sd">&quot;&quot;&quot;Check that  the atom map number is 3.&quot;&quot;&quot;</span>
  981 
  982     <span class="k">return</span> <span class="bp">True</span> <span class="k">if</span> <span class="n">LonePairMapNumber</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">LonePairMapNumber</span> <span class="o">==</span> <span class="mi">3</span> <span class="k">else</span> <span class="bp">False</span>
  983 
  984 <span class="k">def</span> <span class="nf">SetupTorsionAlertTypeForRotatableBond</span><span class="p">(</span><span class="n">TorsionAnglesInfo</span><span class="p">,</span> <span class="n">TorsionAngle</span><span class="p">):</span>
  985     <span class="sd">&quot;&quot;&quot;Setup torsion alert type and angle violation for a rotatable bond.&quot;&quot;&quot;</span>
  986 
  987     <span class="n">TorsionCategory</span><span class="p">,</span> <span class="n">TorsionAngleViolation</span> <span class="o">=</span> <span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">]</span>
  988     
  989     <span class="k">for</span> <span class="n">ID</span> <span class="ow">in</span> <span class="n">TorsionAnglesInfo</span><span class="p">[</span><span class="s2">&quot;IDs&quot;</span><span class="p">]:</span>
  990         <span class="k">if</span> <span class="n">IsTorsionAngleInWithinTolerance</span><span class="p">(</span><span class="n">TorsionAngle</span><span class="p">,</span> <span class="n">TorsionAnglesInfo</span><span class="p">[</span><span class="s2">&quot;Value&quot;</span><span class="p">][</span><span class="n">ID</span><span class="p">],</span> <span class="n">TorsionAnglesInfo</span><span class="p">[</span><span class="s2">&quot;Tolerance1&quot;</span><span class="p">][</span><span class="n">ID</span><span class="p">]):</span>
  991             <span class="n">TorsionCategory</span> <span class="o">=</span> <span class="s2">&quot;Green&quot;</span>
  992             <span class="n">TorsionAngleViolation</span> <span class="o">=</span> <span class="mf">0.0</span>
  993             <span class="k">break</span>
  994         
  995         <span class="k">if</span> <span class="n">IsTorsionAngleInWithinTolerance</span><span class="p">(</span><span class="n">TorsionAngle</span><span class="p">,</span> <span class="n">TorsionAnglesInfo</span><span class="p">[</span><span class="s2">&quot;Value&quot;</span><span class="p">][</span><span class="n">ID</span><span class="p">],</span> <span class="n">TorsionAnglesInfo</span><span class="p">[</span><span class="s2">&quot;Tolerance2&quot;</span><span class="p">][</span><span class="n">ID</span><span class="p">]):</span>
  996             <span class="n">TorsionCategory</span> <span class="o">=</span> <span class="s2">&quot;Orange&quot;</span>
  997             <span class="n">TorsionAngleViolation</span> <span class="o">=</span> <span class="n">CalculateTorsionAngleViolation</span><span class="p">(</span><span class="n">TorsionAngle</span><span class="p">,</span> <span class="n">TorsionAnglesInfo</span><span class="p">[</span><span class="s2">&quot;ValuesIn360RangeList&quot;</span><span class="p">],</span> <span class="n">TorsionAnglesInfo</span><span class="p">[</span><span class="s2">&quot;Tolerances1List&quot;</span><span class="p">])</span>
  998             <span class="k">break</span>
  999 
 1000     <span class="k">if</span> <span class="n">TorsionCategory</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
 1001         <span class="n">TorsionCategory</span> <span class="o">=</span> <span class="s2">&quot;Red&quot;</span>
 1002         <span class="n">TorsionAngleViolation</span> <span class="o">=</span> <span class="n">CalculateTorsionAngleViolation</span><span class="p">(</span><span class="n">TorsionAngle</span><span class="p">,</span> <span class="n">TorsionAnglesInfo</span><span class="p">[</span><span class="s2">&quot;ValuesIn360RangeList&quot;</span><span class="p">],</span> <span class="n">TorsionAnglesInfo</span><span class="p">[</span><span class="s2">&quot;Tolerances2List&quot;</span><span class="p">])</span>
 1003         
 1004     <span class="k">return</span> <span class="p">(</span><span class="n">TorsionCategory</span><span class="p">,</span> <span class="n">TorsionAngleViolation</span><span class="p">)</span>
 1005 
 1006 <span class="k">def</span> <span class="nf">IsTorsionAngleInWithinTolerance</span><span class="p">(</span><span class="n">TorsionAngle</span><span class="p">,</span> <span class="n">TorsionPeak</span><span class="p">,</span> <span class="n">TorsionTolerance</span><span class="p">):</span>
 1007     <span class="sd">&quot;&quot;&quot;Check torsion angle against torsion tolerance.&quot;&quot;&quot;</span>
 1008 
 1009     <span class="n">TorsionAngleDiff</span> <span class="o">=</span> <span class="n">TorsionLibraryUtil</span><span class="o">.</span><span class="n">CalculateTorsionAngleDifference</span><span class="p">(</span><span class="n">TorsionPeak</span><span class="p">,</span> <span class="n">TorsionAngle</span><span class="p">)</span>
 1010     
 1011     <span class="k">return</span> <span class="bp">True</span> <span class="k">if</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">TorsionAngleDiff</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">TorsionTolerance</span><span class="p">)</span> <span class="k">else</span> <span class="bp">False</span>
 1012 
 1013 <span class="k">def</span> <span class="nf">CalculateTorsionAngleViolation</span><span class="p">(</span><span class="n">TorsionAngle</span><span class="p">,</span> <span class="n">TorsionPeaks</span><span class="p">,</span> <span class="n">TorsionTolerances</span><span class="p">):</span>
 1014     <span class="sd">&quot;&quot;&quot;Calculate torsion angle violation.&quot;&quot;&quot;</span>
 1015 
 1016     <span class="n">TorsionAngleViolation</span> <span class="o">=</span> <span class="bp">None</span>
 1017 
 1018     <span class="c1"># Map angle to 0 to 360 range. TorsionPeaks values must be in this range...</span>
 1019     <span class="k">if</span> <span class="n">TorsionAngle</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
 1020         <span class="n">TorsionAngle</span> <span class="o">=</span> <span class="n">TorsionAngle</span> <span class="o">+</span> <span class="mi">360</span>
 1021 
 1022     <span class="c1"># Identify the closest torsion peak index...</span>
 1023     <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">TorsionPeaks</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
 1024         <span class="n">NearestPeakIndex</span> <span class="o">=</span> <span class="mi">0</span>
 1025     <span class="k">else</span><span class="p">:</span>
 1026         <span class="n">NearestPeakIndex</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">TorsionPeaks</span><span class="p">)),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">Index</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">TorsionPeaks</span><span class="p">[</span><span class="n">Index</span><span class="p">]</span> <span class="o">-</span> <span class="n">TorsionAngle</span><span class="p">))</span>
 1027 
 1028     <span class="c1"># Calculate torsion angle violation from the nearest peak and its tolerance value...</span>
 1029     <span class="n">TorsionAngleDiff</span> <span class="o">=</span> <span class="n">TorsionLibraryUtil</span><span class="o">.</span><span class="n">CalculateTorsionAngleDifference</span><span class="p">(</span><span class="n">TorsionPeaks</span><span class="p">[</span><span class="n">NearestPeakIndex</span><span class="p">],</span> <span class="n">TorsionAngle</span><span class="p">)</span>
 1030     <span class="n">TorsionAngleViolation</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">TorsionAngleDiff</span><span class="p">)</span> <span class="o">-</span> <span class="n">TorsionTolerances</span><span class="p">[</span><span class="n">NearestPeakIndex</span><span class="p">])</span>
 1031     
 1032     <span class="k">return</span> <span class="n">TorsionAngleViolation</span>
 1033 
 1034 <span class="k">def</span> <span class="nf">InitializeTorsionAlertsSummaryInfo</span><span class="p">():</span>
 1035     <span class="sd">&quot;&quot;&quot;Initialize torsion alerts summary.&quot;&quot;&quot;</span>
 1036 
 1037     <span class="k">if</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;CountMode&quot;</span><span class="p">]:</span>
 1038         <span class="k">return</span> <span class="bp">None</span>
 1039     
 1040     <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;TrackAlertsSummaryInfo&quot;</span><span class="p">]:</span>
 1041         <span class="k">return</span> <span class="bp">None</span>
 1042     
 1043     <span class="n">TorsionAlertsSummaryInfo</span> <span class="o">=</span> <span class="p">{}</span>
 1044     <span class="n">TorsionAlertsSummaryInfo</span><span class="p">[</span><span class="s2">&quot;RuleIDs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
 1045 
 1046     <span class="k">for</span> <span class="n">DataLabel</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;SMARTSToRuleIDs&quot;</span><span class="p">,</span> <span class="s2">&quot;RuleSMARTS&quot;</span><span class="p">,</span> <span class="s2">&quot;HierarchyClassName&quot;</span><span class="p">,</span> <span class="s2">&quot;HierarchySubClassName&quot;</span><span class="p">,</span> <span class="s2">&quot;TorsionRulePeaks&quot;</span><span class="p">,</span> <span class="s2">&quot;TorsionRuleTolerances1&quot;</span><span class="p">,</span> <span class="s2">&quot;TorsionRuleTolerances2&quot;</span><span class="p">,</span> <span class="s2">&quot;AlertTypes&quot;</span><span class="p">,</span> <span class="s2">&quot;AlertTypesMolCount&quot;</span><span class="p">]:</span>
 1047         <span class="n">TorsionAlertsSummaryInfo</span><span class="p">[</span><span class="n">DataLabel</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
 1048         
 1049     <span class="k">return</span> <span class="n">TorsionAlertsSummaryInfo</span>
 1050 
 1051 <span class="k">def</span> <span class="nf">TrackTorsionAlertsSummaryInfo</span><span class="p">(</span><span class="n">TorsionAlertsSummaryInfo</span><span class="p">,</span> <span class="n">RotBondsAlertsInfo</span><span class="p">):</span>
 1052     <span class="sd">&quot;&quot;&quot;Track torsion alerts summary information for matched torsion rules in a</span>
 1053 <span class="sd">    molecule.&quot;&quot;&quot;</span>
 1054     
 1055     <span class="k">if</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;CountMode&quot;</span><span class="p">]:</span>
 1056         <span class="k">return</span>
 1057     
 1058     <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;TrackAlertsSummaryInfo&quot;</span><span class="p">]:</span>
 1059         <span class="k">return</span>
 1060 
 1061     <span class="k">if</span> <span class="n">RotBondsAlertsInfo</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
 1062         <span class="k">return</span>
 1063 
 1064     <span class="n">MolAlertsInfo</span> <span class="o">=</span> <span class="p">{}</span>
 1065     <span class="n">MolAlertsInfo</span><span class="p">[</span><span class="s2">&quot;RuleIDs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
 1066     <span class="n">MolAlertsInfo</span><span class="p">[</span><span class="s2">&quot;AlertTypes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
 1067     
 1068     <span class="k">for</span> <span class="n">ID</span> <span class="ow">in</span> <span class="n">RotBondsAlertsInfo</span><span class="p">[</span><span class="s2">&quot;IDs&quot;</span><span class="p">]:</span>
 1069         <span class="k">if</span> <span class="ow">not</span> <span class="n">RotBondsAlertsInfo</span><span class="p">[</span><span class="s2">&quot;MatchStatus&quot;</span><span class="p">][</span><span class="n">ID</span><span class="p">]:</span>
 1070             <span class="k">continue</span>
 1071 
 1072         <span class="k">if</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;OutfileAlertsOnly&quot;</span><span class="p">]:</span>
 1073             <span class="k">if</span> <span class="n">RotBondsAlertsInfo</span><span class="p">[</span><span class="s2">&quot;AlertTypes&quot;</span><span class="p">][</span><span class="n">ID</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;SpecifiedAlertsModeList&quot;</span><span class="p">]:</span>
 1074                 <span class="k">continue</span>
 1075         
 1076         <span class="n">AlertType</span> <span class="o">=</span> <span class="n">RotBondsAlertsInfo</span><span class="p">[</span><span class="s2">&quot;AlertTypes&quot;</span><span class="p">][</span><span class="n">ID</span><span class="p">]</span>
 1077         <span class="n">TorsionRuleNodeID</span> <span class="o">=</span> <span class="n">RotBondsAlertsInfo</span><span class="p">[</span><span class="s2">&quot;TorsionRuleNodeID&quot;</span><span class="p">][</span><span class="n">ID</span><span class="p">]</span>
 1078         <span class="n">TorsionRuleSMARTS</span> <span class="o">=</span> <span class="n">RotBondsAlertsInfo</span><span class="p">[</span><span class="s2">&quot;TorsionRuleSMARTS&quot;</span><span class="p">][</span><span class="n">ID</span><span class="p">]</span>
 1079 
 1080         <span class="c1"># Track data for torsion alert summary information across molecules...</span>
 1081         <span class="k">if</span> <span class="n">TorsionRuleNodeID</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">TorsionAlertsSummaryInfo</span><span class="p">[</span><span class="s2">&quot;RuleSMARTS&quot;</span><span class="p">]:</span>
 1082             <span class="n">TorsionAlertsSummaryInfo</span><span class="p">[</span><span class="s2">&quot;RuleIDs&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TorsionRuleNodeID</span><span class="p">)</span>
 1083             <span class="n">TorsionAlertsSummaryInfo</span><span class="p">[</span><span class="s2">&quot;SMARTSToRuleIDs&quot;</span><span class="p">][</span><span class="n">TorsionRuleSMARTS</span><span class="p">]</span> <span class="o">=</span> <span class="n">TorsionRuleNodeID</span>
 1084             
 1085             <span class="n">TorsionAlertsSummaryInfo</span><span class="p">[</span><span class="s2">&quot;RuleSMARTS&quot;</span><span class="p">][</span><span class="n">TorsionRuleNodeID</span><span class="p">]</span> <span class="o">=</span> <span class="n">TorsionRuleSMARTS</span>
 1086             <span class="n">TorsionAlertsSummaryInfo</span><span class="p">[</span><span class="s2">&quot;HierarchyClassName&quot;</span><span class="p">][</span><span class="n">TorsionRuleNodeID</span><span class="p">]</span> <span class="o">=</span> <span class="n">RotBondsAlertsInfo</span><span class="p">[</span><span class="s2">&quot;HierarchyClassNames&quot;</span><span class="p">][</span><span class="n">ID</span><span class="p">]</span>
 1087             <span class="n">TorsionAlertsSummaryInfo</span><span class="p">[</span><span class="s2">&quot;HierarchySubClassName&quot;</span><span class="p">][</span><span class="n">TorsionRuleNodeID</span><span class="p">]</span> <span class="o">=</span> <span class="n">RotBondsAlertsInfo</span><span class="p">[</span><span class="s2">&quot;HierarchySubClassNames&quot;</span><span class="p">][</span><span class="n">ID</span><span class="p">]</span>
 1088 
 1089             <span class="n">TorsionAlertsSummaryInfo</span><span class="p">[</span><span class="s2">&quot;TorsionRulePeaks&quot;</span><span class="p">][</span><span class="n">TorsionRuleNodeID</span><span class="p">]</span> <span class="o">=</span> <span class="n">RotBondsAlertsInfo</span><span class="p">[</span><span class="s2">&quot;TorsionRulePeaks&quot;</span><span class="p">][</span><span class="n">ID</span><span class="p">]</span>
 1090             <span class="n">TorsionAlertsSummaryInfo</span><span class="p">[</span><span class="s2">&quot;TorsionRuleTolerances1&quot;</span><span class="p">][</span><span class="n">TorsionRuleNodeID</span><span class="p">]</span> <span class="o">=</span> <span class="n">RotBondsAlertsInfo</span><span class="p">[</span><span class="s2">&quot;TorsionRuleTolerances1&quot;</span><span class="p">][</span><span class="n">ID</span><span class="p">]</span>
 1091             <span class="n">TorsionAlertsSummaryInfo</span><span class="p">[</span><span class="s2">&quot;TorsionRuleTolerances2&quot;</span><span class="p">][</span><span class="n">TorsionRuleNodeID</span><span class="p">]</span> <span class="o">=</span> <span class="n">RotBondsAlertsInfo</span><span class="p">[</span><span class="s2">&quot;TorsionRuleTolerances2&quot;</span><span class="p">][</span><span class="n">ID</span><span class="p">]</span>
 1092             
 1093             <span class="c1"># Initialize number of alert types across all molecules...</span>
 1094             <span class="n">TorsionAlertsSummaryInfo</span><span class="p">[</span><span class="s2">&quot;AlertTypes&quot;</span><span class="p">][</span><span class="n">TorsionRuleNodeID</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
 1095             
 1096             <span class="c1"># Initialize number of molecules flagged by each alert type...</span>
 1097             <span class="n">TorsionAlertsSummaryInfo</span><span class="p">[</span><span class="s2">&quot;AlertTypesMolCount&quot;</span><span class="p">][</span><span class="n">TorsionRuleNodeID</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
 1098         
 1099         <span class="k">if</span> <span class="n">AlertType</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">TorsionAlertsSummaryInfo</span><span class="p">[</span><span class="s2">&quot;AlertTypes&quot;</span><span class="p">][</span><span class="n">TorsionRuleNodeID</span><span class="p">]:</span>
 1100             <span class="n">TorsionAlertsSummaryInfo</span><span class="p">[</span><span class="s2">&quot;AlertTypes&quot;</span><span class="p">][</span><span class="n">TorsionRuleNodeID</span><span class="p">][</span><span class="n">AlertType</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
 1101             <span class="n">TorsionAlertsSummaryInfo</span><span class="p">[</span><span class="s2">&quot;AlertTypesMolCount&quot;</span><span class="p">][</span><span class="n">TorsionRuleNodeID</span><span class="p">][</span><span class="n">AlertType</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
 1102         
 1103         <span class="n">TorsionAlertsSummaryInfo</span><span class="p">[</span><span class="s2">&quot;AlertTypes&quot;</span><span class="p">][</span><span class="n">TorsionRuleNodeID</span><span class="p">][</span><span class="n">AlertType</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
 1104 
 1105         <span class="c1"># Track data for torsion alert information in a molecule...</span>
 1106         <span class="k">if</span> <span class="n">TorsionRuleNodeID</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">MolAlertsInfo</span><span class="p">[</span><span class="s2">&quot;AlertTypes&quot;</span><span class="p">]:</span>
 1107             <span class="n">MolAlertsInfo</span><span class="p">[</span><span class="s2">&quot;RuleIDs&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TorsionRuleNodeID</span><span class="p">)</span>
 1108             <span class="n">MolAlertsInfo</span><span class="p">[</span><span class="s2">&quot;AlertTypes&quot;</span><span class="p">][</span><span class="n">TorsionRuleNodeID</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
 1109         
 1110         <span class="k">if</span> <span class="n">AlertType</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">MolAlertsInfo</span><span class="p">[</span><span class="s2">&quot;AlertTypes&quot;</span><span class="p">][</span><span class="n">TorsionRuleNodeID</span><span class="p">]:</span>
 1111             <span class="n">MolAlertsInfo</span><span class="p">[</span><span class="s2">&quot;AlertTypes&quot;</span><span class="p">][</span><span class="n">TorsionRuleNodeID</span><span class="p">][</span><span class="n">AlertType</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
 1112         <span class="n">MolAlertsInfo</span><span class="p">[</span><span class="s2">&quot;AlertTypes&quot;</span><span class="p">][</span><span class="n">TorsionRuleNodeID</span><span class="p">][</span><span class="n">AlertType</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
 1113 
 1114     <span class="c1"># Track number of molecules flagged by a specific torsion alert...</span>
 1115     <span class="k">for</span> <span class="n">TorsionRuleNodeID</span> <span class="ow">in</span> <span class="n">MolAlertsInfo</span><span class="p">[</span><span class="s2">&quot;RuleIDs&quot;</span><span class="p">]:</span>
 1116         <span class="k">for</span> <span class="n">AlertType</span> <span class="ow">in</span> <span class="n">MolAlertsInfo</span><span class="p">[</span><span class="s2">&quot;AlertTypes&quot;</span><span class="p">][</span><span class="n">TorsionRuleNodeID</span><span class="p">]:</span>
 1117             <span class="k">if</span> <span class="n">MolAlertsInfo</span><span class="p">[</span><span class="s2">&quot;AlertTypes&quot;</span><span class="p">][</span><span class="n">TorsionRuleNodeID</span><span class="p">][</span><span class="n">AlertType</span><span class="p">]:</span>
 1118                 <span class="n">TorsionAlertsSummaryInfo</span><span class="p">[</span><span class="s2">&quot;AlertTypesMolCount&quot;</span><span class="p">][</span><span class="n">TorsionRuleNodeID</span><span class="p">][</span><span class="n">AlertType</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
 1119 
 1120 <span class="k">def</span> <span class="nf">WriteTorsionAlertsSummaryInfo</span><span class="p">(</span><span class="n">Writer</span><span class="p">,</span> <span class="n">TorsionAlertsSummaryInfo</span><span class="p">):</span>
 1121     <span class="sd">&quot;&quot;&quot;Write out torsion alerts summary informatio to a CSV file.&quot;&quot;&quot;</span>
 1122     
 1123     <span class="k">if</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;CountMode&quot;</span><span class="p">]:</span>
 1124         <span class="k">return</span>
 1125     
 1126     <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;OutfileSummaryMode&quot;</span><span class="p">]:</span>
 1127         <span class="k">return</span>
 1128 
 1129     <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">TorsionAlertsSummaryInfo</span><span class="p">[</span><span class="s2">&quot;RuleIDs&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
 1130         <span class="k">return</span>
 1131     
 1132     <span class="c1"># Write headers...</span>
 1133     <span class="n">QuoteValues</span> <span class="o">=</span> <span class="bp">True</span>
 1134     <span class="n">Values</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;TorsionRule&quot;</span><span class="p">,</span> <span class="s2">&quot;TorsionPeaks&quot;</span><span class="p">,</span> <span class="s2">&quot;Tolerances1&quot;</span><span class="p">,</span> <span class="s2">&quot;Tolerances2&quot;</span><span class="p">,</span> <span class="s2">&quot;HierarchyClass&quot;</span><span class="p">,</span> <span class="s2">&quot;HierarchySubClass&quot;</span><span class="p">,</span> <span class="s2">&quot;TorsionAlertTypes&quot;</span><span class="p">,</span> <span class="s2">&quot;TorsionAlertCount&quot;</span><span class="p">,</span> <span class="s2">&quot;TorsionAlertMolCount&quot;</span><span class="p">]</span>
 1135     <span class="n">Writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">MiscUtil</span><span class="o">.</span><span class="n">JoinWords</span><span class="p">(</span><span class="n">Values</span><span class="p">,</span> <span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">QuoteValues</span><span class="p">))</span>
 1136 
 1137     <span class="n">SortedRuleIDs</span> <span class="o">=</span> <span class="n">GetSortedTorsionAlertsSummaryInfoRuleIDs</span><span class="p">(</span><span class="n">TorsionAlertsSummaryInfo</span><span class="p">)</span>
 1138 
 1139     <span class="c1"># Write alerts information...</span>
 1140     <span class="k">for</span> <span class="n">ID</span> <span class="ow">in</span> <span class="n">SortedRuleIDs</span><span class="p">:</span>
 1141         <span class="c1"># Remove any double quotes in SMARTS...</span>
 1142         <span class="n">RuleSMARTS</span> <span class="o">=</span> <span class="n">TorsionAlertsSummaryInfo</span><span class="p">[</span><span class="s2">&quot;RuleSMARTS&quot;</span><span class="p">][</span><span class="n">ID</span><span class="p">]</span>
 1143         <span class="n">RuleSMARTS</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">RuleSMARTS</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span>
 1144         
 1145         <span class="n">HierarchyClassName</span> <span class="o">=</span> <span class="n">TorsionAlertsSummaryInfo</span><span class="p">[</span><span class="s2">&quot;HierarchyClassName&quot;</span><span class="p">][</span><span class="n">ID</span><span class="p">]</span>
 1146         <span class="n">HierarchySubClassName</span> <span class="o">=</span> <span class="n">TorsionAlertsSummaryInfo</span><span class="p">[</span><span class="s2">&quot;HierarchySubClassName&quot;</span><span class="p">][</span><span class="n">ID</span><span class="p">]</span>
 1147 
 1148         <span class="n">TorsionPeaks</span> <span class="o">=</span> <span class="n">MiscUtil</span><span class="o">.</span><span class="n">JoinWords</span><span class="p">([</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">Value</span> <span class="k">for</span> <span class="n">Value</span> <span class="ow">in</span> <span class="n">TorsionAlertsSummaryInfo</span><span class="p">[</span><span class="s2">&quot;TorsionRulePeaks&quot;</span><span class="p">][</span><span class="n">ID</span><span class="p">]],</span> <span class="s2">&quot;,&quot;</span><span class="p">)</span>
 1149         <span class="n">TorsionRuleTolerances1</span> <span class="o">=</span> <span class="n">MiscUtil</span><span class="o">.</span><span class="n">JoinWords</span><span class="p">([</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">Value</span> <span class="k">for</span> <span class="n">Value</span> <span class="ow">in</span> <span class="n">TorsionAlertsSummaryInfo</span><span class="p">[</span><span class="s2">&quot;TorsionRuleTolerances1&quot;</span><span class="p">][</span><span class="n">ID</span><span class="p">]],</span> <span class="s2">&quot;,&quot;</span><span class="p">)</span>
 1150         <span class="n">TorsionRuleTolerances2</span> <span class="o">=</span> <span class="n">MiscUtil</span><span class="o">.</span><span class="n">JoinWords</span><span class="p">([</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">Value</span> <span class="k">for</span> <span class="n">Value</span> <span class="ow">in</span> <span class="n">TorsionAlertsSummaryInfo</span><span class="p">[</span><span class="s2">&quot;TorsionRuleTolerances2&quot;</span><span class="p">][</span><span class="n">ID</span><span class="p">]],</span> <span class="s2">&quot;,&quot;</span><span class="p">)</span>
 1151         
 1152         <span class="n">AlertTypes</span> <span class="o">=</span> <span class="p">[]</span>
 1153         <span class="n">AlertTypeCount</span> <span class="o">=</span> <span class="p">[]</span>
 1154         <span class="n">AlertTypeMolCount</span> <span class="o">=</span> <span class="p">[]</span>
 1155         <span class="k">for</span> <span class="n">AlertType</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">TorsionAlertsSummaryInfo</span><span class="p">[</span><span class="s2">&quot;AlertTypes&quot;</span><span class="p">][</span><span class="n">ID</span><span class="p">]):</span>
 1156             <span class="n">AlertTypes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">AlertType</span><span class="p">)</span>
 1157             <span class="n">AlertTypeCount</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">TorsionAlertsSummaryInfo</span><span class="p">[</span><span class="s2">&quot;AlertTypes&quot;</span><span class="p">][</span><span class="n">ID</span><span class="p">][</span><span class="n">AlertType</span><span class="p">])</span>
 1158             <span class="n">AlertTypeMolCount</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">TorsionAlertsSummaryInfo</span><span class="p">[</span><span class="s2">&quot;AlertTypesMolCount&quot;</span><span class="p">][</span><span class="n">ID</span><span class="p">][</span><span class="n">AlertType</span><span class="p">])</span>
 1159         
 1160         <span class="n">Values</span> <span class="o">=</span> <span class="p">[</span><span class="n">RuleSMARTS</span><span class="p">,</span> <span class="n">TorsionPeaks</span><span class="p">,</span> <span class="n">TorsionRuleTolerances1</span><span class="p">,</span> <span class="n">TorsionRuleTolerances2</span><span class="p">,</span> <span class="n">HierarchyClassName</span><span class="p">,</span> <span class="n">HierarchySubClassName</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">MiscUtil</span><span class="o">.</span><span class="n">JoinWords</span><span class="p">(</span><span class="n">AlertTypes</span><span class="p">,</span> <span class="s2">&quot;,&quot;</span><span class="p">),</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">MiscUtil</span><span class="o">.</span><span class="n">JoinWords</span><span class="p">(</span><span class="n">AlertTypeCount</span><span class="p">,</span> <span class="s2">&quot;,&quot;</span><span class="p">)),</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">MiscUtil</span><span class="o">.</span><span class="n">JoinWords</span><span class="p">(</span><span class="n">AlertTypeMolCount</span><span class="p">,</span> <span class="s2">&quot;,&quot;</span><span class="p">))]</span>
 1161         <span class="n">Writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">MiscUtil</span><span class="o">.</span><span class="n">JoinWords</span><span class="p">(</span><span class="n">Values</span><span class="p">,</span> <span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">QuoteValues</span><span class="p">))</span>
 1162 
 1163 <span class="k">def</span> <span class="nf">GetSortedTorsionAlertsSummaryInfoRuleIDs</span><span class="p">(</span><span class="n">TorsionAlertsSummaryInfo</span><span class="p">):</span>
 1164     <span class="sd">&quot;&quot;&quot;Sort torsion rule IDs by  alert types molecule count in descending order.&quot;&quot;&quot;</span>
 1165 
 1166     <span class="n">SortedRuleIDs</span> <span class="o">=</span> <span class="p">[]</span>
 1167     
 1168     <span class="n">RuleIDs</span> <span class="o">=</span> <span class="n">TorsionAlertsSummaryInfo</span><span class="p">[</span><span class="s2">&quot;RuleIDs&quot;</span><span class="p">]</span>
 1169     <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">RuleIDs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
 1170         <span class="k">return</span> <span class="n">SortedRuleIDs</span>
 1171     
 1172     <span class="c1"># Setup a map from AlertTypesMolCount to IDs for sorting alerts...</span>
 1173     <span class="n">RuleIDs</span> <span class="o">=</span> <span class="n">TorsionAlertsSummaryInfo</span><span class="p">[</span><span class="s2">&quot;RuleIDs&quot;</span><span class="p">]</span>
 1174     <span class="n">MolCountMap</span> <span class="o">=</span> <span class="p">{}</span>
 1175     <span class="k">for</span> <span class="n">ID</span> <span class="ow">in</span> <span class="n">RuleIDs</span><span class="p">:</span>
 1176         <span class="n">MolCount</span> <span class="o">=</span> <span class="mi">0</span>
 1177         <span class="k">for</span> <span class="n">AlertType</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">TorsionAlertsSummaryInfo</span><span class="p">[</span><span class="s2">&quot;AlertTypes&quot;</span><span class="p">][</span><span class="n">ID</span><span class="p">]):</span>
 1178             <span class="n">MolCount</span> <span class="o">+=</span> <span class="n">TorsionAlertsSummaryInfo</span><span class="p">[</span><span class="s2">&quot;AlertTypesMolCount&quot;</span><span class="p">][</span><span class="n">ID</span><span class="p">][</span><span class="n">AlertType</span><span class="p">]</span>
 1179         <span class="n">MolCountMap</span><span class="p">[</span><span class="n">ID</span><span class="p">]</span> <span class="o">=</span> <span class="n">MolCount</span>
 1180 
 1181     <span class="n">SortedRuleIDs</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">RuleIDs</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">ID</span><span class="p">:</span> <span class="n">MolCountMap</span><span class="p">[</span><span class="n">ID</span><span class="p">],</span> <span class="n">reverse</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
 1182     
 1183     <span class="k">return</span> <span class="n">SortedRuleIDs</span>
 1184 
 1185 <span class="k">def</span> <span class="nf">WriteTorsionAlertsFilteredByRulesInfo</span><span class="p">(</span><span class="n">TorsionAlertsSummaryInfo</span><span class="p">):</span>
 1186     <span class="sd">&quot;&quot;&quot;Write out torsion alerts SD files for individual torsion rules.&quot;&quot;&quot;</span>
 1187     
 1188     <span class="k">if</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;CountMode&quot;</span><span class="p">]:</span>
 1189         <span class="k">return</span>
 1190     
 1191     <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;OutfilesFilteredByRulesMode&quot;</span><span class="p">]:</span>
 1192         <span class="k">return</span>
 1193 
 1194     <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">TorsionAlertsSummaryInfo</span><span class="p">[</span><span class="s2">&quot;RuleIDs&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
 1195         <span class="k">return</span>
 1196 
 1197     <span class="c1"># Setup a molecule reader for filtered molecules...</span>
 1198     <span class="n">FilteredMols</span>  <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">ReadMolecules</span><span class="p">(</span><span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;OutfileFiltered&quot;</span><span class="p">],</span> <span class="o">**</span><span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;InfileParams&quot;</span><span class="p">])</span>
 1199 
 1200     <span class="c1"># Get torsion rule IDs for writing out filtered SD files for individual torsion alert rules... </span>
 1201     <span class="n">TorsionRuleIDs</span> <span class="o">=</span> <span class="n">GetTorsionAlertsFilteredByRuleFilesRuleIDs</span><span class="p">(</span><span class="n">TorsionAlertsSummaryInfo</span><span class="p">)</span>
 1202 
 1203     <span class="c1"># Setup writers...</span>
 1204     <span class="n">ByRuleOutfilesWriters</span> <span class="o">=</span> <span class="n">SetupByRuleOutfilesWriters</span><span class="p">(</span><span class="n">TorsionRuleIDs</span><span class="p">)</span>
 1205     
 1206     <span class="k">for</span> <span class="n">Mol</span> <span class="ow">in</span> <span class="n">FilteredMols</span><span class="p">:</span>
 1207         <span class="c1"># Retrieve torsion alerts info...</span>
 1208         <span class="n">TorsionAlertsInfo</span> <span class="o">=</span> <span class="n">RetrieveTorsionAlertsInfo</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">TorsionAlertsSummaryInfo</span><span class="p">)</span>
 1209         <span class="k">if</span> <span class="n">TorsionAlertsInfo</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
 1210             <span class="k">continue</span>
 1211         
 1212         <span class="k">for</span> <span class="n">TorsionRuleID</span> <span class="ow">in</span> <span class="n">TorsionRuleIDs</span><span class="p">:</span>
 1213             <span class="k">if</span> <span class="n">TorsionRuleID</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">TorsionAlertsInfo</span><span class="p">[</span><span class="s2">&quot;RuleSMARTS&quot;</span><span class="p">]:</span>
 1214                 <span class="k">continue</span>
 1215             
 1216             <span class="n">WriteMoleculeFilteredByRuleID</span><span class="p">(</span><span class="n">ByRuleOutfilesWriters</span><span class="p">[</span><span class="n">TorsionRuleID</span><span class="p">],</span> <span class="n">Mol</span><span class="p">,</span> <span class="n">TorsionRuleID</span><span class="p">,</span> <span class="n">TorsionAlertsSummaryInfo</span><span class="p">,</span> <span class="n">TorsionAlertsInfo</span><span class="p">)</span>
 1217         
 1218     <span class="n">CloseByRuleOutfilesWriters</span><span class="p">(</span><span class="n">ByRuleOutfilesWriters</span><span class="p">)</span>
 1219     
 1220 <span class="k">def</span> <span class="nf">GetTorsionAlertsFilteredByRuleFilesRuleIDs</span><span class="p">(</span><span class="n">TorsionAlertsSummaryInfo</span><span class="p">):</span>
 1221     <span class="sd">&quot;&quot;&quot;Get torsion rule IDs for writing out individual SD files filtered by torsion alert rules.&quot;&quot;&quot;</span>
 1222     
 1223     <span class="c1"># Get torsion rule IDs triggering torsion alerts sorted in the order from the most to</span>
 1224     <span class="c1"># the least number of unique molecules...</span>
 1225     <span class="n">RuleIDs</span> <span class="o">=</span> <span class="n">GetSortedTorsionAlertsSummaryInfoRuleIDs</span><span class="p">(</span><span class="n">TorsionAlertsSummaryInfo</span><span class="p">)</span>
 1226 
 1227     <span class="c1"># Select torsion rule IDs for writing out SD files...</span>
 1228     <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;OutfilesFilteredByRulesAllMode&quot;</span><span class="p">]:</span>
 1229         <span class="n">MaxRuleIDs</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;OutfilesFilteredByRulesMaxCount&quot;</span><span class="p">]</span>
 1230         <span class="k">if</span> <span class="n">MaxRuleIDs</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">RuleIDs</span><span class="p">):</span>
 1231             <span class="n">RuleIDs</span> <span class="o">=</span> <span class="n">RuleIDs</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">MaxRuleIDs</span><span class="p">]</span>
 1232     
 1233     <span class="k">return</span> <span class="n">RuleIDs</span>
 1234 
 1235 <span class="k">def</span> <span class="nf">RetrieveTorsionAlertsInfo</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">TorsionAlertsSummaryInfo</span><span class="p">):</span>
 1236     <span class="sd">&quot;&quot;&quot;Parse torsion alerts data field value to retrieve alerts information for rotatable bonds.&quot;&quot;&quot;</span>
 1237     
 1238     <span class="n">TorsionAlertsLabel</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;SDFieldIDsToLabels&quot;</span><span class="p">][</span><span class="s2">&quot;TorsionAlertsLabel&quot;</span><span class="p">]</span>
 1239     <span class="n">TorsionAlerts</span> <span class="o">=</span> <span class="n">Mol</span><span class="o">.</span><span class="n">GetProp</span><span class="p">(</span><span class="n">TorsionAlertsLabel</span><span class="p">)</span> <span class="k">if</span> <span class="n">Mol</span><span class="o">.</span><span class="n">HasProp</span><span class="p">(</span><span class="n">TorsionAlertsLabel</span><span class="p">)</span> <span class="k">else</span> <span class="bp">None</span>
 1240     
 1241     <span class="k">if</span> <span class="n">TorsionAlerts</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">TorsionAlerts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
 1242         <span class="k">return</span> <span class="bp">None</span>
 1243 
 1244     <span class="c1"># Initialize for tracking by rule IDs...</span>
 1245     <span class="n">TorsionAlertsInfo</span> <span class="o">=</span> <span class="p">{}</span>
 1246     <span class="n">TorsionAlertsInfo</span><span class="p">[</span><span class="s2">&quot;RuleIDs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
 1247     
 1248     <span class="k">for</span> <span class="n">DataLabel</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;RuleSMARTS&quot;</span><span class="p">,</span> <span class="s2">&quot;HierarchyClassName&quot;</span><span class="p">,</span> <span class="s2">&quot;HierarchySubClassName&quot;</span><span class="p">,</span> <span class="s2">&quot;TorsionRulePeaks&quot;</span><span class="p">,</span> <span class="s2">&quot;TorsionRuleTolerances1&quot;</span><span class="p">,</span> <span class="s2">&quot;TorsionRuleTolerances2&quot;</span><span class="p">,</span> <span class="s2">&quot;AlertTypes&quot;</span><span class="p">,</span> <span class="s2">&quot;AtomIndices&quot;</span><span class="p">,</span> <span class="s2">&quot;TorsionAtomIndices&quot;</span><span class="p">,</span> <span class="s2">&quot;TorsionAngles&quot;</span><span class="p">,</span> <span class="s2">&quot;TorsionAngleViolations&quot;</span><span class="p">,</span> <span class="s2">&quot;AlertTypesCount&quot;</span><span class="p">]:</span>
 1249         <span class="n">TorsionAlertsInfo</span><span class="p">[</span><span class="n">DataLabel</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
 1250         
 1251     <span class="n">ValuesDelimiter</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;IntraSetValuesDelim&quot;</span><span class="p">]</span>
 1252     <span class="n">TorsionAlertsSetSize</span> <span class="o">=</span> <span class="mi">11</span>
 1253     
 1254     <span class="n">TorsionAlertsWords</span> <span class="o">=</span> <span class="n">TorsionAlerts</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
 1255     <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">TorsionAlertsWords</span><span class="p">)</span> <span class="o">%</span> <span class="n">TorsionAlertsSetSize</span><span class="p">:</span>
 1256         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintError</span><span class="p">(</span><span class="s2">&quot;The number of space delimited values, </span><span class="si">%s</span><span class="s2">, for TorsionAlerts data field in filtered SD file must be a multiple of </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">TorsionAlertsWords</span><span class="p">),</span> <span class="n">TorsionAlertsSetSize</span><span class="p">))</span>
 1257 
 1258     <span class="n">ID</span> <span class="o">=</span> <span class="mi">0</span>
 1259     <span class="k">for</span> <span class="n">Index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">TorsionAlertsWords</span><span class="p">),</span> <span class="n">TorsionAlertsSetSize</span><span class="p">):</span>
 1260         <span class="n">ID</span> <span class="o">+=</span> <span class="mi">1</span>
 1261         
 1262         <span class="n">RotBondIndices</span><span class="p">,</span> <span class="n">TorsionAlertType</span><span class="p">,</span> <span class="n">TorsionIndices</span><span class="p">,</span> <span class="n">TorsionAngle</span><span class="p">,</span> <span class="n">TorsionAngleViolation</span><span class="p">,</span> <span class="n">HierarchyClass</span><span class="p">,</span> <span class="n">HierarchySubClass</span><span class="p">,</span> <span class="n">TorsionPeaks</span><span class="p">,</span> <span class="n">Tolerances1</span><span class="p">,</span> <span class="n">Tolerances2</span><span class="p">,</span> <span class="n">TorsionRule</span> <span class="o">=</span> <span class="n">TorsionAlertsWords</span><span class="p">[</span><span class="n">Index</span><span class="p">:</span> <span class="n">Index</span> <span class="o">+</span> <span class="n">TorsionAlertsSetSize</span><span class="p">]</span>
 1263         <span class="n">RotBondIndices</span> <span class="o">=</span> <span class="n">RotBondIndices</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">ValuesDelimiter</span><span class="p">)</span>
 1264         <span class="n">TorsionIndices</span> <span class="o">=</span> <span class="n">TorsionIndices</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">ValuesDelimiter</span><span class="p">)</span>
 1265         <span class="n">TorsionPeaks</span> <span class="o">=</span> <span class="n">TorsionPeaks</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">ValuesDelimiter</span><span class="p">)</span>
 1266         <span class="n">Tolerances1</span> <span class="o">=</span> <span class="n">Tolerances1</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">ValuesDelimiter</span><span class="p">)</span>
 1267         <span class="n">Tolerances2</span> <span class="o">=</span> <span class="n">Tolerances2</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">ValuesDelimiter</span><span class="p">)</span>
 1268 
 1269         <span class="k">if</span> <span class="n">TorsionRule</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">TorsionAlertsSummaryInfo</span><span class="p">[</span><span class="s2">&quot;SMARTSToRuleIDs&quot;</span><span class="p">]:</span>
 1270             <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintWarning</span><span class="p">(</span><span class="s2">&quot;The SMARTS pattern, </span><span class="si">%s</span><span class="s2">, for TorsionAlerts data field in filtered SD file doesn&#39;t map to any torsion rule...&quot;</span> <span class="o">%</span> <span class="n">TorsionRule</span><span class="p">)</span>
 1271             <span class="k">continue</span>
 1272         <span class="n">TorsionRuleNodeID</span> <span class="o">=</span> <span class="n">TorsionAlertsSummaryInfo</span><span class="p">[</span><span class="s2">&quot;SMARTSToRuleIDs&quot;</span><span class="p">][</span><span class="n">TorsionRule</span><span class="p">]</span>
 1273 
 1274         <span class="c1"># Track data for torsion alerts in a molecule...</span>
 1275         <span class="k">if</span> <span class="n">TorsionRuleNodeID</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">TorsionAlertsInfo</span><span class="p">[</span><span class="s2">&quot;RuleSMARTS&quot;</span><span class="p">]:</span>
 1276             <span class="n">TorsionAlertsInfo</span><span class="p">[</span><span class="s2">&quot;RuleIDs&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TorsionRuleNodeID</span><span class="p">)</span>
 1277 
 1278             <span class="n">TorsionAlertsInfo</span><span class="p">[</span><span class="s2">&quot;RuleSMARTS&quot;</span><span class="p">][</span><span class="n">TorsionRuleNodeID</span><span class="p">]</span> <span class="o">=</span> <span class="n">TorsionRule</span>
 1279             <span class="n">TorsionAlertsInfo</span><span class="p">[</span><span class="s2">&quot;HierarchyClassName&quot;</span><span class="p">][</span><span class="n">TorsionRuleNodeID</span><span class="p">]</span> <span class="o">=</span> <span class="n">HierarchyClass</span>
 1280             <span class="n">TorsionAlertsInfo</span><span class="p">[</span><span class="s2">&quot;HierarchySubClassName&quot;</span><span class="p">][</span><span class="n">TorsionRuleNodeID</span><span class="p">]</span> <span class="o">=</span> <span class="n">HierarchySubClass</span>
 1281             <span class="n">TorsionAlertsInfo</span><span class="p">[</span><span class="s2">&quot;TorsionRulePeaks&quot;</span><span class="p">][</span><span class="n">TorsionRuleNodeID</span><span class="p">]</span> <span class="o">=</span> <span class="n">TorsionPeaks</span>
 1282             <span class="n">TorsionAlertsInfo</span><span class="p">[</span><span class="s2">&quot;TorsionRuleTolerances1&quot;</span><span class="p">][</span><span class="n">TorsionRuleNodeID</span><span class="p">]</span> <span class="o">=</span> <span class="n">Tolerances1</span>
 1283             <span class="n">TorsionAlertsInfo</span><span class="p">[</span><span class="s2">&quot;TorsionRuleTolerances2&quot;</span><span class="p">][</span><span class="n">TorsionRuleNodeID</span><span class="p">]</span> <span class="o">=</span> <span class="n">Tolerances2</span>
 1284             
 1285             <span class="n">TorsionAlertsInfo</span><span class="p">[</span><span class="s2">&quot;AlertTypes&quot;</span><span class="p">][</span><span class="n">TorsionRuleNodeID</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
 1286             <span class="n">TorsionAlertsInfo</span><span class="p">[</span><span class="s2">&quot;AtomIndices&quot;</span><span class="p">][</span><span class="n">TorsionRuleNodeID</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
 1287             <span class="n">TorsionAlertsInfo</span><span class="p">[</span><span class="s2">&quot;TorsionAtomIndices&quot;</span><span class="p">][</span><span class="n">TorsionRuleNodeID</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
 1288             <span class="n">TorsionAlertsInfo</span><span class="p">[</span><span class="s2">&quot;TorsionAngles&quot;</span><span class="p">][</span><span class="n">TorsionRuleNodeID</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
 1289             <span class="n">TorsionAlertsInfo</span><span class="p">[</span><span class="s2">&quot;TorsionAngleViolations&quot;</span><span class="p">][</span><span class="n">TorsionRuleNodeID</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
 1290 
 1291             <span class="n">TorsionAlertsInfo</span><span class="p">[</span><span class="s2">&quot;AlertTypesCount&quot;</span><span class="p">][</span><span class="n">TorsionRuleNodeID</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
 1292             
 1293         <span class="c1"># Track multiple values for a rule ID...</span>
 1294         <span class="n">TorsionAlertsInfo</span><span class="p">[</span><span class="s2">&quot;AlertTypes&quot;</span><span class="p">][</span><span class="n">TorsionRuleNodeID</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TorsionAlertType</span><span class="p">)</span>
 1295         <span class="n">TorsionAlertsInfo</span><span class="p">[</span><span class="s2">&quot;AtomIndices&quot;</span><span class="p">][</span><span class="n">TorsionRuleNodeID</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">RotBondIndices</span><span class="p">)</span>
 1296         <span class="n">TorsionAlertsInfo</span><span class="p">[</span><span class="s2">&quot;TorsionAtomIndices&quot;</span><span class="p">][</span><span class="n">TorsionRuleNodeID</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TorsionIndices</span><span class="p">)</span>
 1297         <span class="n">TorsionAlertsInfo</span><span class="p">[</span><span class="s2">&quot;TorsionAngles&quot;</span><span class="p">][</span><span class="n">TorsionRuleNodeID</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TorsionAngle</span><span class="p">)</span>
 1298         <span class="n">TorsionAlertsInfo</span><span class="p">[</span><span class="s2">&quot;TorsionAngleViolations&quot;</span><span class="p">][</span><span class="n">TorsionRuleNodeID</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TorsionAngleViolation</span><span class="p">)</span>
 1299         
 1300         <span class="c1"># Count alert type for a rule ID...</span>
 1301         <span class="k">if</span> <span class="n">TorsionAlertType</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">TorsionAlertsInfo</span><span class="p">[</span><span class="s2">&quot;AlertTypesCount&quot;</span><span class="p">][</span><span class="n">TorsionRuleNodeID</span><span class="p">]:</span>
 1302             <span class="n">TorsionAlertsInfo</span><span class="p">[</span><span class="s2">&quot;AlertTypesCount&quot;</span><span class="p">][</span><span class="n">TorsionRuleNodeID</span><span class="p">][</span><span class="n">TorsionAlertType</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
 1303         <span class="n">TorsionAlertsInfo</span><span class="p">[</span><span class="s2">&quot;AlertTypesCount&quot;</span><span class="p">][</span><span class="n">TorsionRuleNodeID</span><span class="p">][</span><span class="n">TorsionAlertType</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
 1304         
 1305     <span class="k">return</span> <span class="n">TorsionAlertsInfo</span>
 1306     
 1307 <span class="k">def</span> <span class="nf">WriteMolecule</span><span class="p">(</span><span class="n">Writer</span><span class="p">,</span> <span class="n">Mol</span><span class="p">,</span> <span class="n">RotBondsAlertsInfo</span><span class="p">):</span>
 1308     <span class="sd">&quot;&quot;&quot;Write out molecule.&quot;&quot;&quot;</span>
 1309     
 1310     <span class="k">if</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;CountMode&quot;</span><span class="p">]:</span>
 1311         <span class="k">return</span> <span class="bp">True</span>
 1312 
 1313     <span class="n">SetupMolPropertiesForAlertsInformation</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">RotBondsAlertsInfo</span><span class="p">)</span>
 1314 
 1315     <span class="k">try</span><span class="p">:</span>
 1316         <span class="n">Writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">Mol</span><span class="p">)</span>
 1317     <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ErrMsg</span><span class="p">:</span>
 1318         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintWarning</span><span class="p">(</span><span class="s2">&quot;Failed to write molecule </span><span class="si">%s</span><span class="s2">:</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">RDKitUtil</span><span class="o">.</span><span class="n">GetMolName</span><span class="p">(</span><span class="n">Mol</span><span class="p">),</span> <span class="n">ErrMsg</span><span class="p">))</span>
 1319         <span class="k">return</span> <span class="bp">False</span>
 1320     
 1321     <span class="k">return</span> <span class="bp">True</span>
 1322 
 1323 <span class="k">def</span> <span class="nf">SetupMolPropertiesForAlertsInformation</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">RotBondsAlertsInfo</span><span class="p">):</span>
 1324     <span class="sd">&quot;&quot;&quot;Setup molecule properties containing alerts information for rotatable bonds.&quot;&quot;&quot;</span>
 1325 
 1326     <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;OutfileAlerts&quot;</span><span class="p">]:</span>
 1327         <span class="k">return</span>
 1328     
 1329     <span class="c1"># Setup rotatable bonds count...</span>
 1330     <span class="n">RotBondsCount</span> <span class="o">=</span> <span class="mi">0</span>
 1331     <span class="k">if</span> <span class="n">RotBondsAlertsInfo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
 1332         <span class="n">RotBondsCount</span> <span class="o">=</span>  <span class="nb">len</span><span class="p">(</span><span class="n">RotBondsAlertsInfo</span><span class="p">[</span><span class="s2">&quot;IDs&quot;</span><span class="p">])</span>
 1333     <span class="n">Mol</span><span class="o">.</span><span class="n">SetProp</span><span class="p">(</span><span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;SDFieldIDsToLabels&quot;</span><span class="p">][</span><span class="s2">&quot;RotBondsCountLabel&quot;</span><span class="p">],</span>  <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">RotBondsCount</span><span class="p">)</span>
 1334     
 1335     <span class="c1"># Setup alert counts for rotatable bonds...</span>
 1336     <span class="n">AlertsCount</span> <span class="o">=</span> <span class="p">[]</span>
 1337     <span class="k">if</span> <span class="n">RotBondsAlertsInfo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
 1338         <span class="k">for</span> <span class="n">AlertType</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Green&quot;</span><span class="p">,</span> <span class="s2">&quot;Orange&quot;</span><span class="p">,</span> <span class="s2">&quot;Red&quot;</span><span class="p">]:</span>
 1339             <span class="k">if</span> <span class="n">AlertType</span> <span class="ow">in</span> <span class="n">RotBondsAlertsInfo</span><span class="p">[</span><span class="s2">&quot;Count&quot;</span><span class="p">]:</span>
 1340                 <span class="n">AlertsCount</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">RotBondsAlertsInfo</span><span class="p">[</span><span class="s2">&quot;Count&quot;</span><span class="p">][</span><span class="n">AlertType</span><span class="p">])</span>
 1341             <span class="k">else</span><span class="p">:</span>
 1342                 <span class="n">AlertsCount</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;0&quot;</span><span class="p">)</span>
 1343     
 1344     <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">AlertsCount</span><span class="p">):</span>
 1345         <span class="n">Mol</span><span class="o">.</span><span class="n">SetProp</span><span class="p">(</span><span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;SDFieldIDsToLabels&quot;</span><span class="p">][</span><span class="s2">&quot;TorsionAlertsCountLabel&quot;</span><span class="p">],</span>  <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">MiscUtil</span><span class="o">.</span><span class="n">JoinWords</span><span class="p">(</span><span class="n">AlertsCount</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">))</span>
 1346 
 1347     <span class="c1"># Setup alert information for rotatable bonds...</span>
 1348     <span class="n">AlertsInfoValues</span> <span class="o">=</span> <span class="p">[]</span>
 1349 
 1350     <span class="c1"># Delimiter for multiple values corresponding to specific set of information for</span>
 1351     <span class="c1"># a rotatable bond. For example: TorsionAtomIndices</span>
 1352     <span class="n">ValuesDelim</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;IntraSetValuesDelim&quot;</span><span class="p">]</span>
 1353 
 1354     <span class="c1"># Delimiter for various values for a rotatable bond...</span>
 1355     <span class="n">RotBondValuesDelim</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;InterSetValuesDelim&quot;</span><span class="p">]</span>
 1356     
 1357     <span class="c1"># Delimiter for values corresponding to multiple rotatable bonds...</span>
 1358     <span class="n">AlertsInfoValuesDelim</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;InterSetValuesDelim&quot;</span><span class="p">]</span>
 1359     
 1360     <span class="k">if</span> <span class="n">RotBondsAlertsInfo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
 1361         <span class="k">for</span> <span class="n">ID</span> <span class="ow">in</span> <span class="n">RotBondsAlertsInfo</span><span class="p">[</span><span class="s2">&quot;IDs&quot;</span><span class="p">]:</span>
 1362             <span class="k">if</span> <span class="ow">not</span> <span class="n">RotBondsAlertsInfo</span><span class="p">[</span><span class="s2">&quot;MatchStatus&quot;</span><span class="p">][</span><span class="n">ID</span><span class="p">]:</span>
 1363                 <span class="k">continue</span>
 1364             
 1365             <span class="k">if</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;OutfileAlertsOnly&quot;</span><span class="p">]:</span>
 1366                 <span class="k">if</span> <span class="n">RotBondsAlertsInfo</span><span class="p">[</span><span class="s2">&quot;AlertTypes&quot;</span><span class="p">][</span><span class="n">ID</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;SpecifiedAlertsModeList&quot;</span><span class="p">]:</span>
 1367                     <span class="k">continue</span>
 1368             
 1369             <span class="n">RotBondValues</span> <span class="o">=</span> <span class="p">[]</span>
 1370             
 1371             <span class="c1"># Bond atom indices...</span>
 1372             <span class="n">Values</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">Value</span> <span class="k">for</span> <span class="n">Value</span> <span class="ow">in</span> <span class="n">RotBondsAlertsInfo</span><span class="p">[</span><span class="s2">&quot;AtomIndices&quot;</span><span class="p">][</span><span class="n">ID</span><span class="p">]]</span>
 1373             <span class="n">RotBondValues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ValuesDelim</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Values</span><span class="p">))</span>
 1374 
 1375             <span class="c1"># Alert type...</span>
 1376             <span class="n">RotBondValues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">RotBondsAlertsInfo</span><span class="p">[</span><span class="s2">&quot;AlertTypes&quot;</span><span class="p">][</span><span class="n">ID</span><span class="p">])</span>
 1377 
 1378             <span class="c1"># Torsion atom indices...</span>
 1379             <span class="n">TorsionAtomIndices</span> <span class="o">=</span> <span class="n">SetupTorsionAtomIndicesValues</span><span class="p">(</span><span class="n">RotBondsAlertsInfo</span><span class="p">[</span><span class="s2">&quot;TorsionAtomIndices&quot;</span><span class="p">][</span><span class="n">ID</span><span class="p">],</span> <span class="n">ValuesDelim</span><span class="p">)</span>
 1380             <span class="n">RotBondValues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TorsionAtomIndices</span><span class="p">)</span>
 1381 
 1382             <span class="c1"># Torsion angle...</span>
 1383             <span class="n">RotBondValues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">RotBondsAlertsInfo</span><span class="p">[</span><span class="s2">&quot;TorsionAngles&quot;</span><span class="p">][</span><span class="n">ID</span><span class="p">])</span>
 1384 
 1385             <span class="c1"># Torsion angle violation...</span>
 1386             <span class="n">RotBondValues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">RotBondsAlertsInfo</span><span class="p">[</span><span class="s2">&quot;TorsionAngleViolations&quot;</span><span class="p">][</span><span class="n">ID</span><span class="p">])</span>
 1387 
 1388             <span class="c1"># Hierarchy class and subclass names...</span>
 1389             <span class="n">RotBondValues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">RotBondsAlertsInfo</span><span class="p">[</span><span class="s2">&quot;HierarchyClassNames&quot;</span><span class="p">][</span><span class="n">ID</span><span class="p">])</span>
 1390             <span class="n">RotBondValues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">RotBondsAlertsInfo</span><span class="p">[</span><span class="s2">&quot;HierarchySubClassNames&quot;</span><span class="p">][</span><span class="n">ID</span><span class="p">])</span>
 1391 
 1392             <span class="c1"># Torsion rule peaks...</span>
 1393             <span class="n">Values</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">Value</span> <span class="k">for</span> <span class="n">Value</span> <span class="ow">in</span> <span class="n">RotBondsAlertsInfo</span><span class="p">[</span><span class="s2">&quot;TorsionRulePeaks&quot;</span><span class="p">][</span><span class="n">ID</span><span class="p">]]</span>
 1394             <span class="n">RotBondValues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ValuesDelim</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Values</span><span class="p">))</span>
 1395             
 1396             <span class="c1"># Torsion rule tolerances...</span>
 1397             <span class="n">Values</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">Value</span> <span class="k">for</span> <span class="n">Value</span> <span class="ow">in</span> <span class="n">RotBondsAlertsInfo</span><span class="p">[</span><span class="s2">&quot;TorsionRuleTolerances1&quot;</span><span class="p">][</span><span class="n">ID</span><span class="p">]]</span>
 1398             <span class="n">RotBondValues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ValuesDelim</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Values</span><span class="p">))</span>
 1399             <span class="n">Values</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">Value</span> <span class="k">for</span> <span class="n">Value</span> <span class="ow">in</span> <span class="n">RotBondsAlertsInfo</span><span class="p">[</span><span class="s2">&quot;TorsionRuleTolerances2&quot;</span><span class="p">][</span><span class="n">ID</span><span class="p">]]</span>
 1400             <span class="n">RotBondValues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ValuesDelim</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Values</span><span class="p">))</span>
 1401             
 1402             <span class="c1"># Torsion rule SMARTS...</span>
 1403             <span class="n">RotBondValues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">RotBondsAlertsInfo</span><span class="p">[</span><span class="s2">&quot;TorsionRuleSMARTS&quot;</span><span class="p">][</span><span class="n">ID</span><span class="p">])</span>
 1404 
 1405             <span class="c1"># Track joined values for a rotatable bond...</span>
 1406             <span class="n">AlertsInfoValues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">RotBondValuesDelim</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">RotBondValues</span><span class="p">))</span>
 1407 
 1408     <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">AlertsInfoValues</span><span class="p">):</span>
 1409         <span class="n">Mol</span><span class="o">.</span><span class="n">SetProp</span><span class="p">(</span><span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;SDFieldIDsToLabels&quot;</span><span class="p">][</span><span class="s2">&quot;TorsionAlertsLabel&quot;</span><span class="p">],</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">AlertsInfoValuesDelim</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">AlertsInfoValues</span><span class="p">)))</span>
 1410     
 1411 <span class="k">def</span> <span class="nf">WriteMoleculeFilteredByRuleID</span><span class="p">(</span><span class="n">Writer</span><span class="p">,</span> <span class="n">Mol</span><span class="p">,</span> <span class="n">TorsionRuleID</span><span class="p">,</span> <span class="n">TorsionAlertsSummaryInfo</span><span class="p">,</span> <span class="n">TorsionAlertsInfo</span><span class="p">):</span>
 1412     <span class="sd">&quot;&quot;&quot;Write out molecule.&quot;&quot;&quot;</span>
 1413     
 1414     <span class="k">if</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;CountMode&quot;</span><span class="p">]:</span>
 1415         <span class="k">return</span>
 1416 
 1417     <span class="n">SetupMolPropertiesForFilteredByRuleIDAlertsInformation</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">TorsionRuleID</span><span class="p">,</span> <span class="n">TorsionAlertsSummaryInfo</span><span class="p">,</span> <span class="n">TorsionAlertsInfo</span><span class="p">)</span>
 1418         
 1419     <span class="n">Writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">Mol</span><span class="p">)</span>
 1420 
 1421 <span class="k">def</span> <span class="nf">SetupMolPropertiesForFilteredByRuleIDAlertsInformation</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">TorsionRuleID</span><span class="p">,</span> <span class="n">TorsionAlertsSummaryInfo</span><span class="p">,</span> <span class="n">TorsionAlertsInfo</span><span class="p">):</span>
 1422     <span class="sd">&quot;&quot;&quot;Setup molecule properties containing alerts information for torsion alerts</span>
 1423 <span class="sd">    fileted by Rule IDs.&quot;&quot;&quot;</span>
 1424 
 1425     <span class="c1"># Delete torsion alerts information for rotatable bonds...</span>
 1426     <span class="k">if</span> <span class="n">Mol</span><span class="o">.</span><span class="n">HasProp</span><span class="p">(</span><span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;SDFieldIDsToLabels&quot;</span><span class="p">][</span><span class="s2">&quot;TorsionAlertsLabel&quot;</span><span class="p">]):</span>
 1427         <span class="n">Mol</span><span class="o">.</span><span class="n">ClearProp</span><span class="p">(</span><span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;SDFieldIDsToLabels&quot;</span><span class="p">][</span><span class="s2">&quot;TorsionAlertsLabel&quot;</span><span class="p">])</span>
 1428 
 1429     <span class="c1"># Delimiter for values...</span>
 1430     <span class="n">IntraSetValuesDelim</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;IntraSetValuesDelim&quot;</span><span class="p">]</span>
 1431     <span class="n">InterSetValuesDelim</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;InterSetValuesDelim&quot;</span><span class="p">]</span>
 1432     
 1433     <span class="c1"># Setup alert rule information...</span>
 1434     <span class="n">AlertRuleInfoValues</span> <span class="o">=</span> <span class="p">[]</span>
 1435     
 1436     <span class="n">AlertRuleInfoValues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">TorsionAlertsInfo</span><span class="p">[</span><span class="s2">&quot;HierarchyClassName&quot;</span><span class="p">][</span><span class="n">TorsionRuleID</span><span class="p">])</span>
 1437     <span class="n">AlertRuleInfoValues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">TorsionAlertsInfo</span><span class="p">[</span><span class="s2">&quot;HierarchySubClassName&quot;</span><span class="p">][</span><span class="n">TorsionRuleID</span><span class="p">])</span>
 1438     
 1439     <span class="n">Values</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">Value</span> <span class="k">for</span> <span class="n">Value</span> <span class="ow">in</span> <span class="n">TorsionAlertsInfo</span><span class="p">[</span><span class="s2">&quot;TorsionRulePeaks&quot;</span><span class="p">][</span><span class="n">TorsionRuleID</span><span class="p">]]</span>
 1440     <span class="n">AlertRuleInfoValues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">IntraSetValuesDelim</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Values</span><span class="p">))</span>
 1441     
 1442     <span class="n">Values</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">Value</span> <span class="k">for</span> <span class="n">Value</span> <span class="ow">in</span> <span class="n">TorsionAlertsInfo</span><span class="p">[</span><span class="s2">&quot;TorsionRuleTolerances1&quot;</span><span class="p">][</span><span class="n">TorsionRuleID</span><span class="p">]]</span>
 1443     <span class="n">AlertRuleInfoValues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">IntraSetValuesDelim</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Values</span><span class="p">))</span>
 1444     <span class="n">Values</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">Value</span> <span class="k">for</span> <span class="n">Value</span> <span class="ow">in</span> <span class="n">TorsionAlertsInfo</span><span class="p">[</span><span class="s2">&quot;TorsionRuleTolerances2&quot;</span><span class="p">][</span><span class="n">TorsionRuleID</span><span class="p">]]</span>
 1445     <span class="n">AlertRuleInfoValues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">IntraSetValuesDelim</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Values</span><span class="p">))</span>
 1446     
 1447     <span class="n">AlertRuleInfoValues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">TorsionAlertsInfo</span><span class="p">[</span><span class="s2">&quot;RuleSMARTS&quot;</span><span class="p">][</span><span class="n">TorsionRuleID</span><span class="p">])</span>
 1448     
 1449     <span class="n">Mol</span><span class="o">.</span><span class="n">SetProp</span><span class="p">(</span><span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;SDFieldIDsToLabels&quot;</span><span class="p">][</span><span class="s2">&quot;TorsionRuleLabel&quot;</span><span class="p">],</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">InterSetValuesDelim</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">AlertRuleInfoValues</span><span class="p">)))</span>
 1450 
 1451     <span class="c1"># Setup alerts count for torsion rule...</span>
 1452     <span class="n">AlertsCount</span> <span class="o">=</span> <span class="p">[]</span>
 1453     <span class="k">for</span> <span class="n">AlertType</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Green&quot;</span><span class="p">,</span> <span class="s2">&quot;Orange&quot;</span><span class="p">,</span> <span class="s2">&quot;Red&quot;</span><span class="p">]:</span>
 1454         <span class="k">if</span> <span class="n">AlertType</span> <span class="ow">in</span> <span class="n">TorsionAlertsInfo</span><span class="p">[</span><span class="s2">&quot;AlertTypesCount&quot;</span><span class="p">][</span><span class="n">TorsionRuleID</span><span class="p">]:</span>
 1455             <span class="n">AlertsCount</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">TorsionAlertsInfo</span><span class="p">[</span><span class="s2">&quot;AlertTypesCount&quot;</span><span class="p">][</span><span class="n">TorsionRuleID</span><span class="p">][</span><span class="n">AlertType</span><span class="p">])</span>
 1456         <span class="k">else</span><span class="p">:</span>
 1457             <span class="n">AlertsCount</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;0&quot;</span><span class="p">)</span>
 1458     
 1459     <span class="n">Mol</span><span class="o">.</span><span class="n">SetProp</span><span class="p">(</span><span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;SDFieldIDsToLabels&quot;</span><span class="p">][</span><span class="s2">&quot;TorsionRuleAlertsCountLabel&quot;</span><span class="p">],</span>  <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">InterSetValuesDelim</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">AlertsCount</span><span class="p">)))</span>
 1460     
 1461     <span class="c1"># Setup torsion rule alerts...</span>
 1462     <span class="n">AlertsInfoValues</span> <span class="o">=</span> <span class="p">[]</span>
 1463     <span class="k">for</span> <span class="n">Index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">TorsionAlertsInfo</span><span class="p">[</span><span class="s2">&quot;AlertTypes&quot;</span><span class="p">][</span><span class="n">TorsionRuleID</span><span class="p">])):</span>
 1464         <span class="n">RotBondInfoValues</span> <span class="o">=</span> <span class="p">[]</span>
 1465         
 1466         <span class="c1"># Bond atom indices...</span>
 1467         <span class="n">Values</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">Value</span> <span class="k">for</span> <span class="n">Value</span> <span class="ow">in</span> <span class="n">TorsionAlertsInfo</span><span class="p">[</span><span class="s2">&quot;AtomIndices&quot;</span><span class="p">][</span><span class="n">TorsionRuleID</span><span class="p">][</span><span class="n">Index</span><span class="p">]]</span>
 1468         <span class="n">RotBondInfoValues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">IntraSetValuesDelim</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Values</span><span class="p">))</span>
 1469         
 1470         <span class="c1"># Alert type...</span>
 1471         <span class="n">RotBondInfoValues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TorsionAlertsInfo</span><span class="p">[</span><span class="s2">&quot;AlertTypes&quot;</span><span class="p">][</span><span class="n">TorsionRuleID</span><span class="p">][</span><span class="n">Index</span><span class="p">])</span>
 1472         
 1473         <span class="c1"># Torsion atom indices retrieved from the filtered SD file and stored as strings...</span>
 1474         <span class="n">Values</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">Value</span> <span class="k">for</span> <span class="n">Value</span> <span class="ow">in</span> <span class="n">TorsionAlertsInfo</span><span class="p">[</span><span class="s2">&quot;TorsionAtomIndices&quot;</span><span class="p">][</span><span class="n">TorsionRuleID</span><span class="p">][</span><span class="n">Index</span><span class="p">]]</span>
 1475         <span class="n">RotBondInfoValues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">IntraSetValuesDelim</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Values</span><span class="p">))</span>
 1476         
 1477         <span class="c1"># Torsion angle...</span>
 1478         <span class="n">RotBondInfoValues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TorsionAlertsInfo</span><span class="p">[</span><span class="s2">&quot;TorsionAngles&quot;</span><span class="p">][</span><span class="n">TorsionRuleID</span><span class="p">][</span><span class="n">Index</span><span class="p">])</span>
 1479         
 1480         <span class="c1"># Torsion angle violation...</span>
 1481         <span class="n">RotBondInfoValues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TorsionAlertsInfo</span><span class="p">[</span><span class="s2">&quot;TorsionAngleViolations&quot;</span><span class="p">][</span><span class="n">TorsionRuleID</span><span class="p">][</span><span class="n">Index</span><span class="p">])</span>
 1482 
 1483         <span class="c1"># Track alerts informaiton...</span>
 1484         <span class="n">AlertsInfoValues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">InterSetValuesDelim</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">RotBondInfoValues</span><span class="p">))</span>
 1485     
 1486     <span class="n">Mol</span><span class="o">.</span><span class="n">SetProp</span><span class="p">(</span><span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;SDFieldIDsToLabels&quot;</span><span class="p">][</span><span class="s2">&quot;TorsionRuleAlertsLabel&quot;</span><span class="p">],</span>  <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">InterSetValuesDelim</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">AlertsInfoValues</span><span class="p">)))</span>
 1487     
 1488     <span class="c1"># Setup torsion rule alert max angle violation...</span>
 1489     <span class="n">TorsionAngleViolations</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">Angle</span><span class="p">)</span> <span class="k">for</span> <span class="n">Angle</span> <span class="ow">in</span> <span class="n">TorsionAlertsInfo</span><span class="p">[</span><span class="s2">&quot;TorsionAngleViolations&quot;</span><span class="p">][</span><span class="n">TorsionRuleID</span><span class="p">]]</span>
 1490     <span class="n">Mol</span><span class="o">.</span><span class="n">SetProp</span><span class="p">(</span><span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;SDFieldIDsToLabels&quot;</span><span class="p">][</span><span class="s2">&quot;TorsionRuleMaxAngleViolationLabel&quot;</span><span class="p">],</span>  <span class="s2">&quot;</span><span class="si">%.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">TorsionAngleViolations</span><span class="p">)))</span>
 1491 
 1492 <span class="k">def</span> <span class="nf">SetupTorsionAtomIndicesValues</span><span class="p">(</span><span class="n">TorsionAtomIndicesList</span><span class="p">,</span> <span class="n">ValuesDelim</span><span class="p">):</span>
 1493     <span class="sd">&quot;&quot;&quot;Setup torsion atom indices value for output files.&quot;&quot;&quot;</span>
 1494 
 1495     <span class="c1"># Check for any list values in the list of torsion atom indices used as placeholders</span>
 1496     <span class="c1"># for positions of lone pairs in torsion rules containing  N_lp...</span>
 1497     <span class="n">TorsionAtomsInfo</span> <span class="o">=</span> <span class="p">[]</span>
 1498     <span class="k">for</span> <span class="n">Value</span> <span class="ow">in</span> <span class="n">TorsionAtomIndicesList</span><span class="p">:</span>
 1499         <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">Value</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
 1500             <span class="n">TorsionAtomsInfo</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;N_lp&quot;</span><span class="p">)</span>
 1501         <span class="k">else</span><span class="p">:</span>
 1502             <span class="n">TorsionAtomsInfo</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Value</span><span class="p">)</span>
 1503             
 1504     <span class="n">Values</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">Value</span> <span class="k">for</span> <span class="n">Value</span> <span class="ow">in</span> <span class="n">TorsionAtomsInfo</span><span class="p">]</span>
 1505     
 1506     <span class="k">return</span> <span class="n">ValuesDelim</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Values</span><span class="p">)</span>
 1507     
 1508 <span class="k">def</span> <span class="nf">SetupOutfilesWriters</span><span class="p">():</span>
 1509     <span class="sd">&quot;&quot;&quot;Setup molecule and summary writers.&quot;&quot;&quot;</span>
 1510 
 1511     <span class="n">OutfilesWriters</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;WriterRemaining&quot;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span> <span class="s2">&quot;WriterFiltered&quot;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span> <span class="s2">&quot;WriterAlertSummary&quot;</span><span class="p">:</span> <span class="bp">None</span><span class="p">}</span>
 1512 
 1513     <span class="c1"># Writers for SD files...</span>
 1514     <span class="n">WriterRemaining</span><span class="p">,</span> <span class="n">WriterFiltered</span> <span class="o">=</span> <span class="n">SetupMoleculeWriters</span><span class="p">()</span>
 1515     <span class="n">OutfilesWriters</span><span class="p">[</span><span class="s2">&quot;WriterRemaining&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">WriterRemaining</span>
 1516     <span class="n">OutfilesWriters</span><span class="p">[</span><span class="s2">&quot;WriterFiltered&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">WriterFiltered</span>
 1517     
 1518     <span class="c1"># Writer for alert summary CSV file...</span>
 1519     <span class="n">WriterAlertSummary</span> <span class="o">=</span> <span class="n">SetupAlertSummaryWriter</span><span class="p">()</span>
 1520     <span class="n">OutfilesWriters</span><span class="p">[</span><span class="s2">&quot;WriterAlertSummary&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">WriterAlertSummary</span>
 1521 
 1522     <span class="k">return</span> <span class="n">OutfilesWriters</span>
 1523 
 1524 <span class="k">def</span> <span class="nf">SetupMoleculeWriters</span><span class="p">():</span>
 1525     <span class="sd">&quot;&quot;&quot;Setup molecule writers.&quot;&quot;&quot;</span>
 1526     
 1527     <span class="n">Writer</span> <span class="o">=</span> <span class="bp">None</span>
 1528     <span class="n">WriterFiltered</span> <span class="o">=</span> <span class="bp">None</span>
 1529 
 1530     <span class="k">if</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;CountMode&quot;</span><span class="p">]:</span>
 1531         <span class="k">return</span> <span class="p">(</span><span class="n">Writer</span><span class="p">,</span> <span class="n">WriterFiltered</span><span class="p">)</span>
 1532 
 1533     <span class="n">Writer</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">MoleculesWriter</span><span class="p">(</span><span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Outfile&quot;</span><span class="p">],</span> <span class="o">**</span><span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;OutfileParams&quot;</span><span class="p">])</span>
 1534     <span class="k">if</span> <span class="n">Writer</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
 1535         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintError</span><span class="p">(</span><span class="s2">&quot;Failed to setup a writer for output fie </span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Outfile&quot;</span><span class="p">])</span>
 1536     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Generating file </span><span class="si">%s</span><span class="s2">...&quot;</span> <span class="o">%</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Outfile&quot;</span><span class="p">])</span>
 1537     
 1538     <span class="k">if</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;OutfileFilteredMode&quot;</span><span class="p">]:</span>
 1539         <span class="n">WriterFiltered</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">MoleculesWriter</span><span class="p">(</span><span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;OutfileFiltered&quot;</span><span class="p">],</span> <span class="o">**</span><span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;OutfileParams&quot;</span><span class="p">])</span>
 1540         <span class="k">if</span> <span class="n">WriterFiltered</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
 1541             <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintError</span><span class="p">(</span><span class="s2">&quot;Failed to setup a writer for output fie </span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;OutfileFiltered&quot;</span><span class="p">])</span>
 1542         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;Generating file </span><span class="si">%s</span><span class="s2">...&quot;</span> <span class="o">%</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;OutfileFiltered&quot;</span><span class="p">])</span>
 1543     
 1544     <span class="k">return</span> <span class="p">(</span><span class="n">Writer</span><span class="p">,</span> <span class="n">WriterFiltered</span><span class="p">)</span>
 1545 
 1546 <span class="k">def</span> <span class="nf">SetupAlertSummaryWriter</span><span class="p">():</span>
 1547     <span class="sd">&quot;&quot;&quot;Setup a alert summary writer.&quot;&quot;&quot;</span>
 1548     
 1549     <span class="n">Writer</span> <span class="o">=</span> <span class="bp">None</span>
 1550     
 1551     <span class="k">if</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;CountMode&quot;</span><span class="p">]:</span>
 1552         <span class="k">return</span> <span class="n">Writer</span>
 1553         
 1554     <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;OutfileSummaryMode&quot;</span><span class="p">]:</span>
 1555         <span class="k">return</span> <span class="n">Writer</span>
 1556     
 1557     <span class="n">Outfile</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;OutfileSummary&quot;</span><span class="p">]</span>
 1558     <span class="n">Writer</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">Outfile</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
 1559     <span class="k">if</span> <span class="n">Writer</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
 1560         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintError</span><span class="p">(</span><span class="s2">&quot;Failed to setup a writer for output fie </span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="n">Outfile</span><span class="p">)</span>
 1561     
 1562     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;Generating file </span><span class="si">%s</span><span class="s2">...&quot;</span> <span class="o">%</span> <span class="n">Outfile</span><span class="p">)</span>
 1563     
 1564     <span class="k">return</span> <span class="n">Writer</span>
 1565     
 1566 <span class="k">def</span> <span class="nf">CloseOutfilesWriters</span><span class="p">(</span><span class="n">OutfilesWriters</span><span class="p">):</span>
 1567     <span class="sd">&quot;&quot;&quot;Close outfile writers.&quot;&quot;&quot;</span>
 1568 
 1569     <span class="k">for</span> <span class="n">WriterType</span><span class="p">,</span> <span class="n">Writer</span> <span class="ow">in</span> <span class="n">OutfilesWriters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
 1570         <span class="k">if</span> <span class="n">Writer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
 1571             <span class="n">Writer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
 1572 
 1573 <span class="k">def</span> <span class="nf">SetupByRuleOutfilesWriters</span><span class="p">(</span><span class="n">RuleIDs</span><span class="p">):</span>
 1574     <span class="sd">&quot;&quot;&quot;Setup by rule outfiles writers.&quot;&quot;&quot;</span>
 1575 
 1576     <span class="c1"># Initialize...</span>
 1577     <span class="n">OutfilesWriters</span> <span class="o">=</span> <span class="p">{}</span>
 1578     <span class="k">for</span> <span class="n">RuleID</span> <span class="ow">in</span> <span class="n">RuleIDs</span><span class="p">:</span>
 1579         <span class="n">OutfilesWriters</span><span class="p">[</span><span class="n">RuleID</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
 1580     
 1581     <span class="k">if</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;CountMode&quot;</span><span class="p">]:</span>
 1582         <span class="k">return</span> <span class="n">OutfilesWriters</span>
 1583         
 1584     <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;OutfilesFilteredByRulesMode&quot;</span><span class="p">]:</span>
 1585         <span class="k">return</span> <span class="n">OutfilesWriters</span>
 1586     
 1587     <span class="n">FileDir</span><span class="p">,</span> <span class="n">FileName</span><span class="p">,</span> <span class="n">FileExt</span> <span class="o">=</span> <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ParseFileName</span><span class="p">(</span><span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--outfile&quot;</span><span class="p">])</span>
 1588     <span class="n">OutfilesRoot</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_Filtered_TopRule&quot;</span> <span class="o">%</span> <span class="n">FileName</span>
 1589     <span class="n">OutfilesExt</span> <span class="o">=</span> <span class="s2">&quot;sdf&quot;</span>
 1590 
 1591     <span class="n">MsgTxt</span> <span class="o">=</span> <span class="s2">&quot;all&quot;</span> <span class="k">if</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;OutfilesFilteredByRulesAllMode&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;top </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;OutfilesFilteredByRulesMaxCount&quot;</span><span class="p">]</span>
 1592     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Generating output files </span><span class="si">%s</span><span class="s2">*.</span><span class="si">%s</span><span class="s2"> for </span><span class="si">%s</span><span class="s2"> torsion rules triggering alerts...&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">OutfilesRoot</span><span class="p">,</span> <span class="n">OutfilesExt</span><span class="p">,</span> <span class="n">MsgTxt</span><span class="p">))</span>
 1593     
 1594     <span class="c1"># Delete any existing output files...</span>
 1595     <span class="n">Outfiles</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">*.</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">OutfilesRoot</span><span class="p">,</span> <span class="n">OutfilesExt</span><span class="p">))</span>
 1596     <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">Outfiles</span><span class="p">):</span>
 1597         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;Deleting existing output files </span><span class="si">%s</span><span class="s2">*.</span><span class="si">%s</span><span class="s2">...&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">OutfilesRoot</span><span class="p">,</span> <span class="n">OutfilesExt</span><span class="p">))</span>
 1598         <span class="k">for</span> <span class="n">Outfile</span> <span class="ow">in</span> <span class="n">Outfiles</span><span class="p">:</span>
 1599             <span class="k">try</span><span class="p">:</span>
 1600                 <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">Outfile</span><span class="p">)</span>
 1601             <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ErrMsg</span><span class="p">:</span>
 1602                 <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintWarning</span><span class="p">(</span><span class="s2">&quot;Failed to delete file: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">ErrMsg</span><span class="p">)</span>
 1603     
 1604     <span class="n">RuleIndex</span> <span class="o">=</span> <span class="mi">0</span>
 1605     <span class="k">for</span> <span class="n">RuleID</span> <span class="ow">in</span> <span class="n">RuleIDs</span><span class="p">:</span>
 1606         <span class="n">RuleIndex</span> <span class="o">+=</span> <span class="mi">1</span>
 1607         <span class="n">Outfile</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">OutfilesRoot</span><span class="p">,</span> <span class="n">RuleIndex</span><span class="p">,</span> <span class="n">OutfilesExt</span><span class="p">)</span>
 1608         <span class="n">Writer</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">MoleculesWriter</span><span class="p">(</span><span class="n">Outfile</span><span class="p">,</span> <span class="o">**</span><span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;OutfileParams&quot;</span><span class="p">])</span>
 1609         <span class="k">if</span> <span class="n">Writer</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
 1610             <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintError</span><span class="p">(</span><span class="s2">&quot;Failed to setup a writer for output fie </span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="n">Outfile</span><span class="p">)</span>
 1611             
 1612         <span class="n">OutfilesWriters</span><span class="p">[</span><span class="n">RuleID</span><span class="p">]</span> <span class="o">=</span> <span class="n">Writer</span>
 1613 
 1614     <span class="k">return</span> <span class="n">OutfilesWriters</span>
 1615 
 1616 <span class="k">def</span> <span class="nf">CloseByRuleOutfilesWriters</span><span class="p">(</span><span class="n">OutfilesWriters</span><span class="p">):</span>
 1617     <span class="sd">&quot;&quot;&quot;Close by rule outfile writers.&quot;&quot;&quot;</span>
 1618 
 1619     <span class="k">for</span> <span class="n">RuleID</span><span class="p">,</span> <span class="n">Writer</span> <span class="ow">in</span> <span class="n">OutfilesWriters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
 1620         <span class="k">if</span> <span class="n">Writer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
 1621             <span class="n">Writer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
 1622 
 1623 <span class="k">def</span> <span class="nf">ProcessTorsionLibraryInfo</span><span class="p">():</span>
 1624     <span class="sd">&quot;&quot;&quot;Process torsion library information.&quot;&quot;&quot;</span>
 1625 
 1626     <span class="n">RetrieveTorsionLibraryInfo</span><span class="p">()</span>
 1627     <span class="n">ListTorsionLibraryInfo</span><span class="p">()</span>
 1628 
 1629 <span class="k">def</span> <span class="nf">RetrieveTorsionLibraryInfo</span><span class="p">(</span><span class="n">Quiet</span> <span class="o">=</span> <span class="bp">False</span><span class="p">):</span>
 1630     <span class="sd">&quot;&quot;&quot;Retrieve torsion library information.&quot;&quot;&quot;</span>
 1631 
 1632     <span class="n">TorsionLibraryFilePath</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;TorsionLibraryFile&quot;</span><span class="p">]</span>
 1633     <span class="k">if</span> <span class="n">TorsionLibraryFilePath</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
 1634         <span class="n">TorsionLibraryFile</span> <span class="o">=</span> <span class="s2">&quot;TorsionLibrary.xml&quot;</span>
 1635         <span class="n">MayaChemToolsDataDir</span> <span class="o">=</span> <span class="n">MiscUtil</span><span class="o">.</span><span class="n">GetMayaChemToolsLibDataPath</span><span class="p">()</span>
 1636         <span class="n">TorsionLibraryFilePath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">MayaChemToolsDataDir</span><span class="p">,</span> <span class="n">TorsionLibraryFile</span><span class="p">)</span>
 1637         <span class="k">if</span> <span class="ow">not</span> <span class="n">Quiet</span><span class="p">:</span>
 1638             <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Retrieving data from default torsion library file </span><span class="si">%s</span><span class="s2">...&quot;</span> <span class="o">%</span> <span class="n">TorsionLibraryFile</span><span class="p">)</span>
 1639     <span class="k">else</span><span class="p">:</span>
 1640         <span class="n">TorsionLibraryFilePath</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;TorsionLibraryFile&quot;</span><span class="p">]</span>
 1641         <span class="k">if</span> <span class="ow">not</span> <span class="n">Quiet</span><span class="p">:</span>
 1642             <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Retrieving data from torsion library file </span><span class="si">%s</span><span class="s2">...&quot;</span> <span class="o">%</span> <span class="n">TorsionLibraryFilePath</span><span class="p">)</span>
 1643         
 1644     <span class="n">TorsionLibraryInfo</span><span class="p">[</span><span class="s2">&quot;TorsionLibElementTree&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">TorsionLibraryUtil</span><span class="o">.</span><span class="n">RetrieveTorsionLibraryInfo</span><span class="p">(</span><span class="n">TorsionLibraryFilePath</span><span class="p">)</span>
 1645 
 1646 <span class="k">def</span> <span class="nf">ListTorsionLibraryInfo</span><span class="p">():</span>
 1647     <span class="sd">&quot;&quot;&quot;List torsion library information.&quot;&quot;&quot;</span>
 1648     
 1649     <span class="n">TorsionLibraryUtil</span><span class="o">.</span><span class="n">ListTorsionLibraryInfo</span><span class="p">(</span><span class="n">TorsionLibraryInfo</span><span class="p">[</span><span class="s2">&quot;TorsionLibElementTree&quot;</span><span class="p">])</span>
 1650 
 1651 <span class="k">def</span> <span class="nf">SetupTorsionLibraryInfo</span><span class="p">(</span><span class="n">Quiet</span> <span class="o">=</span> <span class="bp">False</span><span class="p">):</span>
 1652     <span class="sd">&quot;&quot;&quot;Setup torsion library information for matching rotatable bonds.&quot;&quot;&quot;</span>
 1653 
 1654     <span class="k">if</span> <span class="ow">not</span> <span class="n">Quiet</span><span class="p">:</span>
 1655         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Setting up torsion library information for matching rotatable bonds...&quot;</span><span class="p">)</span>
 1656 
 1657     <span class="n">TorsionLibraryUtil</span><span class="o">.</span><span class="n">SetupTorsionLibraryInfoForMatchingRotatableBonds</span><span class="p">(</span><span class="n">TorsionLibraryInfo</span><span class="p">)</span>
 1658 
 1659 <span class="k">def</span> <span class="nf">ProcessRotatableBondsSMARTSMode</span><span class="p">():</span>
 1660     <span class="sd">&quot;&quot;&quot;&quot;Process SMARTS pattern for rotatable bonds.&quot;&quot;&quot;</span>
 1661 
 1662     <span class="n">RotBondsMode</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;RotBondsSMARTSMode&quot;</span><span class="p">]</span>
 1663     <span class="n">RotBondsSMARTSPattern</span> <span class="o">=</span> <span class="bp">None</span>
 1664     <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;NonStrict&quot;</span><span class="p">,</span> <span class="n">RotBondsMode</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
 1665         <span class="n">RotBondsSMARTSPattern</span> <span class="o">=</span> <span class="s2">&quot;[!$(*#*)&amp;!D1]-&amp;!@[!$(*#*)&amp;!D1]&quot;</span>
 1666     <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;SemiStrict&quot;</span><span class="p">,</span> <span class="n">RotBondsMode</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
 1667         <span class="n">RotBondsSMARTSPattern</span> <span class="o">=</span> <span class="s2">&quot;[!$(*#*)&amp;!D1&amp;!$(C(F)(F)F)&amp;!$(C(Cl)(Cl)Cl)&amp;!$(C(Br)(Br)Br)&amp;!$(C([CH3])([CH3])[CH3])]-!@[!$(*#*)&amp;!D1&amp;!$(C(F)(F)F)&amp;!$(C(Cl)(Cl)Cl)&amp;!$(C(Br)(Br)Br)&amp;!$(C([CH3])([CH3])[CH3])]&quot;</span>
 1668     <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;Strict&quot;</span><span class="p">,</span> <span class="n">RotBondsMode</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
 1669         <span class="n">RotBondsSMARTSPattern</span> <span class="o">=</span> <span class="s2">&quot;[!$(*#*)&amp;!D1&amp;!$(C(F)(F)F)&amp;!$(C(Cl)(Cl)Cl)&amp;!$(C(Br)(Br)Br)&amp;!$(C([CH3])([CH3])[CH3])&amp;!$([CD3](=[N,O,S])-!@[#7,O,S!D1])&amp;!$([#7,O,S!D1]-!@[CD3]=[N,O,S])&amp;!$([CD3](=[N+])-!@[#7!D1])&amp;!$([#7!D1]-!@[CD3]=[N+])]-!@[!$(*#*)&amp;!D1&amp;!$(C(F)(F)F)&amp;!$(C(Cl)(Cl)Cl)&amp;!$(C(Br)(Br)Br)&amp;!$(C([CH3])([CH3])[CH3])]&quot;</span>
 1670     <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;Specify&quot;</span><span class="p">,</span> <span class="n">RotBondsMode</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
 1671         <span class="n">RotBondsSMARTSPattern</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;RotBondsSMARTSPatternSpecified&quot;</span><span class="p">]</span>
 1672         <span class="n">RotBondsSMARTSPattern</span> <span class="o">=</span> <span class="n">RotBondsSMARTSPattern</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
 1673         <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">RotBondsSMARTSPattern</span><span class="p">):</span>
 1674             <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintError</span><span class="p">(</span><span class="s2">&quot;Empty value specified for SMILES/SMARTS pattern in  </span><span class="se">\&quot;</span><span class="s2">--rotBondsSMARTSPattern</span><span class="se">\&quot;</span><span class="s2"> option, </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="n">RotBondsMode</span><span class="p">)</span>
 1675     <span class="k">else</span><span class="p">:</span>
 1676         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintError</span><span class="p">(</span><span class="s2">&quot;The value, </span><span class="si">%s</span><span class="s2">, specified for option </span><span class="se">\&quot;</span><span class="s2">-r, --rotBondsSMARTSMode</span><span class="se">\&quot;</span><span class="s2"> is not valid. &quot;</span> <span class="o">%</span> <span class="n">RotBondsMode</span><span class="p">)</span>
 1677         
 1678     <span class="n">RotBondsPatternMol</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">MolFromSmarts</span><span class="p">(</span><span class="n">RotBondsSMARTSPattern</span><span class="p">)</span>
 1679     <span class="k">if</span> <span class="n">RotBondsPatternMol</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
 1680         <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;Specify&quot;</span><span class="p">,</span> <span class="n">RotBondsMode</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
 1681             <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintError</span><span class="p">(</span><span class="s2">&quot;Failed to create rotatable bonds pattern molecule. The rotatable bonds SMARTS pattern, </span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2">, specified using </span><span class="se">\&quot;</span><span class="s2">--rotBondsSMARTSPattern</span><span class="se">\&quot;</span><span class="s2"> option is not valid.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">RotBondsSMARTSPattern</span><span class="p">))</span>
 1682         <span class="k">else</span><span class="p">:</span>
 1683             <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintError</span><span class="p">(</span><span class="s2">&quot;Failed to create rotatable bonds pattern molecule. The default rotatable bonds SMARTS pattern, </span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2">, used for, </span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2">, value of  </span><span class="se">\&quot;</span><span class="s2">-r, --rotBondsSMARTSMode</span><span class="se">\&quot;</span><span class="s2"> option is not valid.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">RotBondsSMARTSPattern</span><span class="p">,</span> <span class="n">RotBondsMode</span><span class="p">))</span>
 1684     
 1685     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;RotBondsSMARTSPattern&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">RotBondsSMARTSPattern</span>
 1686 
 1687 <span class="k">def</span> <span class="nf">ProcessSDFieldLabelsOption</span><span class="p">():</span>
 1688     <span class="sd">&quot;&quot;&quot;Process SD data field label option.&quot;&quot;&quot;</span>
 1689 
 1690     <span class="n">ParamsOptionName</span> <span class="o">=</span> <span class="s2">&quot;--outfileSDFieldLabels&quot;</span>
 1691     <span class="n">ParamsOptionValue</span> <span class="o">=</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--outfileSDFieldLabels&quot;</span><span class="p">]</span>
 1692     
 1693     <span class="n">ParamsIDsToLabels</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;RotBondsCountLabel&quot;</span><span class="p">:</span> <span class="s2">&quot;RotBondsCount&quot;</span><span class="p">,</span> <span class="s2">&quot;TorsionAlertsCountLabel&quot;</span><span class="p">:</span> <span class="s2">&quot;TorsionAlertsCount (Green Orange Red)&quot;</span><span class="p">,</span> <span class="s2">&quot;TorsionAlertsLabel&quot;</span><span class="p">:</span> <span class="s2">&quot;TorsionAlerts (RotBondIndices TorsionAlert TorsionIndices TorsionAngle TorsionAngleViolation HierarchyClass HierarchySubClass TorsionPeaks Tolerances1 Tolerances2 TorsionRule)&quot;</span><span class="p">,</span> <span class="s2">&quot;TorsionRuleLabel&quot;</span><span class="p">:</span> <span class="s2">&quot;TorsionRule (HierarchyClass HierarchySubClass TorsionPeaks Tolerances1 Tolerances2 TorsionRule)&quot;</span><span class="p">,</span> <span class="s2">&quot;TorsionRuleAlertsCountLabel&quot;</span><span class="p">:</span> <span class="s2">&quot;TorsionRuleAlertsCount (Green Orange Red)&quot;</span><span class="p">,</span> <span class="s2">&quot;TorsionRuleAlertsLabel&quot;</span><span class="p">:</span> <span class="s2">&quot;TorsionRuleAlerts (RotBondIndices TorsionAlert TorsionIndices TorsionAngle TorsionAngleViolation)&quot;</span><span class="p">,</span> <span class="s2">&quot;TorsionRuleMaxAngleViolationLabel&quot;</span><span class="p">:</span> <span class="s2">&quot;TorsionRuleMaxAngleViolation&quot;</span><span class="p">}</span>
 1694     
 1695     <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^auto$&quot;</span><span class="p">,</span> <span class="n">ParamsOptionValue</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
 1696         <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;SDFieldIDsToLabels&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ParamsIDsToLabels</span>
 1697         <span class="k">return</span>
 1698     
 1699     <span class="c1"># Setup a canonical paramater names...</span>
 1700     <span class="n">ValidParamNames</span> <span class="o">=</span> <span class="p">[]</span>
 1701     <span class="n">CanonicalParamNamesMap</span> <span class="o">=</span> <span class="p">{}</span>
 1702     <span class="k">for</span> <span class="n">ParamName</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">ParamsIDsToLabels</span><span class="p">):</span>
 1703         <span class="n">ValidParamNames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ParamName</span><span class="p">)</span>
 1704         <span class="n">CanonicalParamNamesMap</span><span class="p">[</span><span class="n">ParamName</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span> <span class="o">=</span> <span class="n">ParamName</span>
 1705     
 1706     <span class="n">ParamsOptionValue</span> <span class="o">=</span> <span class="n">ParamsOptionValue</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
 1707     <span class="k">if</span> <span class="ow">not</span> <span class="n">ParamsOptionValue</span><span class="p">:</span>
 1708         <span class="n">PrintError</span><span class="p">(</span><span class="s2">&quot;No valid parameter name and value pairs specified using </span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2"> option&quot;</span> <span class="o">%</span> <span class="n">ParamsOptionName</span><span class="p">)</span>
 1709     
 1710     <span class="n">ParamsOptionValueWords</span> <span class="o">=</span> <span class="n">ParamsOptionValue</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
 1711     <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ParamsOptionValueWords</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span><span class="p">:</span>
 1712         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintError</span><span class="p">(</span><span class="s2">&quot;The number of comma delimited paramater names and values, </span><span class="si">%d</span><span class="s2">, specified using </span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2"> option must be an even number.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ParamsOptionValueWords</span><span class="p">),</span> <span class="n">ParamsOptionName</span><span class="p">))</span>
 1713     
 1714     <span class="c1"># Validate paramater name and value pairs...</span>
 1715     <span class="k">for</span> <span class="n">Index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ParamsOptionValueWords</span><span class="p">),</span> <span class="mi">2</span><span class="p">):</span>
 1716         <span class="n">Name</span> <span class="o">=</span> <span class="n">ParamsOptionValueWords</span><span class="p">[</span><span class="n">Index</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
 1717         <span class="n">Value</span> <span class="o">=</span> <span class="n">ParamsOptionValueWords</span><span class="p">[</span><span class="n">Index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
 1718 
 1719         <span class="n">CanonicalName</span> <span class="o">=</span> <span class="n">Name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
 1720         <span class="k">if</span>  <span class="ow">not</span> <span class="n">CanonicalName</span> <span class="ow">in</span> <span class="n">CanonicalParamNamesMap</span><span class="p">:</span>
 1721             <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintError</span><span class="p">(</span><span class="s2">&quot;The parameter name, </span><span class="si">%s</span><span class="s2">, specified using </span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2"> is not a valid name. Supported parameter names: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">Name</span><span class="p">,</span> <span class="n">ParamsOptionName</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ValidParamNames</span><span class="p">)))</span>
 1722 
 1723         <span class="n">ParamName</span> <span class="o">=</span> <span class="n">CanonicalParamNamesMap</span><span class="p">[</span><span class="n">CanonicalName</span><span class="p">]</span>
 1724         <span class="n">ParamValue</span> <span class="o">=</span> <span class="n">Value</span>
 1725         
 1726         <span class="c1"># Set value...</span>
 1727         <span class="n">ParamsIDsToLabels</span><span class="p">[</span><span class="n">ParamName</span><span class="p">]</span> <span class="o">=</span> <span class="n">ParamValue</span>
 1728     
 1729     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;SDFieldIDsToLabels&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ParamsIDsToLabels</span>
 1730 
 1731 <span class="k">def</span> <span class="nf">ProcessOptionNitrogenLonePairParameters</span><span class="p">():</span>
 1732     <span class="sd">&quot;&quot;&quot;Process nitrogen lone pair parameters option.&quot;&quot;&quot;</span>
 1733 
 1734     <span class="n">ParamsOptionName</span> <span class="o">=</span> <span class="s2">&quot;--nitrogenLonePairParams&quot;</span>
 1735     <span class="n">ParamsOptionValue</span> <span class="o">=</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--nitrogenLonePairParams&quot;</span><span class="p">]</span>
 1736     
 1737     <span class="n">ParamsInfo</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;AllowHydrogenNbrs&quot;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s2">&quot;PlanarityTolerance&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,}</span>
 1738     
 1739     <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^auto$&quot;</span><span class="p">,</span> <span class="n">ParamsOptionValue</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
 1740         <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;NitrogenLonePairParams&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ParamsInfo</span>
 1741         <span class="k">return</span>
 1742     
 1743     <span class="c1"># Setup a canonical paramater names...</span>
 1744     <span class="n">ValidParamNames</span> <span class="o">=</span> <span class="p">[]</span>
 1745     <span class="n">CanonicalParamNamesMap</span> <span class="o">=</span> <span class="p">{}</span>
 1746     <span class="k">for</span> <span class="n">ParamName</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">ParamsInfo</span><span class="p">):</span>
 1747         <span class="n">ValidParamNames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ParamName</span><span class="p">)</span>
 1748         <span class="n">CanonicalParamNamesMap</span><span class="p">[</span><span class="n">ParamName</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span> <span class="o">=</span> <span class="n">ParamName</span>
 1749     
 1750     <span class="n">ParamsOptionValue</span> <span class="o">=</span> <span class="n">ParamsOptionValue</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
 1751     <span class="k">if</span> <span class="ow">not</span> <span class="n">ParamsOptionValue</span><span class="p">:</span>
 1752         <span class="n">PrintError</span><span class="p">(</span><span class="s2">&quot;No valid parameter name and value pairs specified using </span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2"> option&quot;</span> <span class="o">%</span> <span class="n">ParamsOptionName</span><span class="p">)</span>
 1753     
 1754     <span class="n">ParamsOptionValueWords</span> <span class="o">=</span> <span class="n">ParamsOptionValue</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
 1755     <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ParamsOptionValueWords</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span><span class="p">:</span>
 1756         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintError</span><span class="p">(</span><span class="s2">&quot;The number of comma delimited paramater names and values, </span><span class="si">%d</span><span class="s2">, specified using </span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2"> option must be an even number.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ParamsOptionValueWords</span><span class="p">),</span> <span class="n">ParamsOptionName</span><span class="p">))</span>
 1757     
 1758     <span class="c1"># Validate paramater name and value pairs...</span>
 1759     <span class="k">for</span> <span class="n">Index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ParamsOptionValueWords</span><span class="p">),</span> <span class="mi">2</span><span class="p">):</span>
 1760         <span class="n">Name</span> <span class="o">=</span> <span class="n">ParamsOptionValueWords</span><span class="p">[</span><span class="n">Index</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
 1761         <span class="n">Value</span> <span class="o">=</span> <span class="n">ParamsOptionValueWords</span><span class="p">[</span><span class="n">Index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
 1762 
 1763         <span class="n">CanonicalName</span> <span class="o">=</span> <span class="n">Name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
 1764         <span class="k">if</span>  <span class="ow">not</span> <span class="n">CanonicalName</span> <span class="ow">in</span> <span class="n">CanonicalParamNamesMap</span><span class="p">:</span>
 1765             <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintError</span><span class="p">(</span><span class="s2">&quot;The parameter name, </span><span class="si">%s</span><span class="s2">, specified using </span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2"> is not a valid name. Supported parameter names: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">Name</span><span class="p">,</span> <span class="n">ParamsOptionName</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ValidParamNames</span><span class="p">)))</span>
 1766 
 1767         <span class="n">ParamName</span> <span class="o">=</span> <span class="n">CanonicalParamNamesMap</span><span class="p">[</span><span class="n">CanonicalName</span><span class="p">]</span>
 1768         <span class="n">ParamValue</span> <span class="o">=</span> <span class="n">Value</span>
 1769         
 1770         <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^PlanarityTolerance$&quot;</span><span class="p">,</span> <span class="n">ParamName</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
 1771             <span class="n">Value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">Value</span><span class="p">)</span>
 1772             <span class="k">if</span> <span class="n">Value</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
 1773                 <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintError</span><span class="p">(</span><span class="s2">&quot;The parameter value, </span><span class="si">%s</span><span class="s2">, specified for parameter name, </span><span class="si">%s</span><span class="s2">, using </span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2"> option is not a valid value. Supported values: &gt;= 0&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">Value</span><span class="p">,</span> <span class="n">Name</span><span class="p">,</span> <span class="n">ParamsOptionName</span><span class="p">))</span>
 1774             <span class="n">ParamValue</span> <span class="o">=</span> <span class="n">Value</span>
 1775         <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^AllowHydrogenNbrs$&quot;</span><span class="p">,</span> <span class="n">ParamName</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
 1776             <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^(yes|no)$&quot;</span><span class="p">,</span> <span class="n">Value</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
 1777                 <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintError</span><span class="p">(</span><span class="s2">&quot;The parameter value, </span><span class="si">%s</span><span class="s2">, specified for parameter name, </span><span class="si">%s</span><span class="s2">, using </span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2"> option is not a valid value. Supported values: yes or no&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">Value</span><span class="p">,</span> <span class="n">Name</span><span class="p">,</span> <span class="n">ParamsOptionName</span><span class="p">))</span>
 1778             <span class="n">ParamValue</span> <span class="o">=</span> <span class="bp">True</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^yes$&quot;</span><span class="p">,</span> <span class="n">Value</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span> <span class="k">else</span> <span class="bp">False</span>
 1779             
 1780         <span class="c1"># Set value...</span>
 1781         <span class="n">ParamsInfo</span><span class="p">[</span><span class="n">ParamName</span><span class="p">]</span> <span class="o">=</span> <span class="n">ParamValue</span>
 1782     
 1783     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;NitrogenLonePairParams&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ParamsInfo</span>
 1784     
 1785 <span class="k">def</span> <span class="nf">ProcessOptions</span><span class="p">():</span>
 1786     <span class="sd">&quot;&quot;&quot;Process and validate command line arguments and options.&quot;&quot;&quot;</span>
 1787     
 1788     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;Processing options...&quot;</span><span class="p">)</span>
 1789 
 1790     <span class="c1"># Validate options...</span>
 1791     <span class="n">ValidateOptions</span><span class="p">()</span>
 1792     
 1793     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Infile&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--infile&quot;</span><span class="p">]</span>
 1794     <span class="n">ParamsDefaultInfoOverride</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;RemoveHydrogens&quot;</span><span class="p">:</span> <span class="bp">False</span><span class="p">}</span>
 1795     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;InfileParams&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ProcessOptionInfileParameters</span><span class="p">(</span><span class="s2">&quot;--infileParams&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--infileParams&quot;</span><span class="p">],</span> <span class="n">InfileName</span> <span class="o">=</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--infile&quot;</span><span class="p">],</span> <span class="n">ParamsDefaultInfo</span> <span class="o">=</span> <span class="n">ParamsDefaultInfoOverride</span><span class="p">)</span>
 1796     
 1797     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Outfile&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--outfile&quot;</span><span class="p">]</span>
 1798     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;OutfileParams&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ProcessOptionOutfileParameters</span><span class="p">(</span><span class="s2">&quot;--outfileParams&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--outfileParams&quot;</span><span class="p">],</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--infile&quot;</span><span class="p">],</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--outfile&quot;</span><span class="p">])</span>
 1799     
 1800     <span class="n">FileDir</span><span class="p">,</span> <span class="n">FileName</span><span class="p">,</span> <span class="n">FileExt</span> <span class="o">=</span> <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ParseFileName</span><span class="p">(</span><span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--outfile&quot;</span><span class="p">])</span>
 1801     <span class="n">OutfileFiltered</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_Filtered.</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">FileName</span><span class="p">,</span> <span class="n">FileExt</span><span class="p">)</span>
 1802     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;OutfileFiltered&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">OutfileFiltered</span>
 1803     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;OutfileFilteredMode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^yes$&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--outfileFiltered&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span> <span class="k">else</span> <span class="bp">False</span>
 1804     
 1805     <span class="n">OutfileSummary</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_AlertsSummary.csv&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">FileName</span><span class="p">)</span>
 1806     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;OutfileSummary&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">OutfileSummary</span>
 1807     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;OutfileSummaryMode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^yes$&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--outfileSummary&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span> <span class="k">else</span> <span class="bp">False</span>
 1808 
 1809     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;OutfilesFilteredByRulesMode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^yes$&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--outfilesFilteredByRules&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span> <span class="k">else</span> <span class="bp">False</span>
 1810     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;TrackAlertsSummaryInfo&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span> <span class="k">if</span> <span class="p">(</span><span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;OutfileSummaryMode&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;OutfilesFilteredByRulesMode&quot;</span><span class="p">])</span> <span class="k">else</span> <span class="bp">False</span>
 1811 
 1812     <span class="n">OutfilesFilteredByRulesMaxCount</span> <span class="o">=</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--outfilesFilteredByRulesMaxCount&quot;</span><span class="p">]</span>
 1813     <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^All$&quot;</span><span class="p">,</span> <span class="n">OutfilesFilteredByRulesMaxCount</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
 1814         <span class="n">OutfilesFilteredByRulesMaxCount</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">OutfilesFilteredByRulesMaxCount</span><span class="p">)</span>
 1815     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;OutfilesFilteredByRulesMaxCount&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">OutfilesFilteredByRulesMaxCount</span>
 1816     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;OutfilesFilteredByRulesAllMode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^All$&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--outfilesFilteredByRulesMaxCount&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span> <span class="k">else</span> <span class="bp">False</span>
 1817     
 1818     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;OutfileAlerts&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^yes$&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--outfileAlerts&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span> <span class="k">else</span> <span class="bp">False</span>
 1819 
 1820     <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^yes$&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--outfilesFilteredByRules&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
 1821         <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^yes$&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--outfileAlerts&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
 1822             <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintError</span><span class="p">(</span><span class="s2">&quot;The value </span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2"> specified for </span><span class="se">\&quot;</span><span class="s2">--outfilesFilteredByRules</span><span class="se">\&quot;</span><span class="s2"> option is not valid. The specified value is only allowed during </span><span class="se">\&quot;</span><span class="s2">yes</span><span class="se">\&quot;</span><span class="s2"> value of </span><span class="se">\&quot;</span><span class="s2">--outfileAlerts</span><span class="se">\&quot;</span><span class="s2"> option.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--outfilesFilteredByRules&quot;</span><span class="p">]))</span>
 1823     
 1824     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;OutfileAlertsMode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--outfileAlertsMode&quot;</span><span class="p">]</span>
 1825     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;OutfileAlertsOnly&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^AlertsOnly$&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--outfileAlertsMode&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span> <span class="k">else</span> <span class="bp">False</span>
 1826 
 1827     <span class="n">ProcessSDFieldLabelsOption</span><span class="p">()</span>
 1828     
 1829     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Overwrite&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--overwrite&quot;</span><span class="p">]</span>
 1830     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;CountMode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^count$&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--mode&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span> <span class="k">else</span> <span class="bp">False</span>
 1831 
 1832     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;MPMode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^yes$&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--mp&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span> <span class="k">else</span> <span class="bp">False</span>
 1833     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;MPParams&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ProcessOptionMultiprocessingParameters</span><span class="p">(</span><span class="s2">&quot;--mpParams&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--mpParams&quot;</span><span class="p">])</span>
 1834 
 1835     <span class="n">ProcessOptionNitrogenLonePairParameters</span><span class="p">()</span>
 1836     
 1837     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;AlertsMode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--alertsMode&quot;</span><span class="p">]</span>
 1838     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;SpecifiedAlertsModeList&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
 1839     <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^Red$&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--alertsMode&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
 1840         <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;SpecifiedAlertsModeList&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Red&quot;</span><span class="p">)</span>
 1841     <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^RedAndOrange$&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--alertsMode&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
 1842         <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;SpecifiedAlertsModeList&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Red&quot;</span><span class="p">)</span>
 1843         <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;SpecifiedAlertsModeList&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Orange&quot;</span><span class="p">)</span>
 1844     
 1845     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;MinAlertsCount&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--alertsMinCount&quot;</span><span class="p">])</span>
 1846 
 1847     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;RotBondsSMARTSMode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--rotBondsSMARTSMode&quot;</span><span class="p">]</span>
 1848     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;RotBondsSMARTSPatternSpecified&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--rotBondsSMARTSPattern&quot;</span><span class="p">]</span>
 1849     <span class="n">ProcessRotatableBondsSMARTSMode</span><span class="p">()</span>
 1850 
 1851     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;TorsionLibraryFile&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
 1852     <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^auto$&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--torsionLibraryFile&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
 1853         <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;TorsionLibraryFile&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--torsionLibraryFile&quot;</span><span class="p">]</span>
 1854 
 1855     <span class="c1"># Setup delimiter for writing out torsion alert information to output files...</span>
 1856     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;IntraSetValuesDelim&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span>
 1857     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;InterSetValuesDelim&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span>
 1858 
 1859 <span class="k">def</span> <span class="nf">RetrieveOptions</span><span class="p">():</span>
 1860     <span class="sd">&quot;&quot;&quot;Retrieve command line arguments and options.&quot;&quot;&quot;</span>
 1861     
 1862     <span class="c1"># Get options...</span>
 1863     <span class="k">global</span> <span class="n">Options</span>
 1864     <span class="n">Options</span> <span class="o">=</span> <span class="n">docopt</span><span class="p">(</span><span class="n">_docoptUsage_</span><span class="p">)</span>
 1865 
 1866     <span class="c1"># Set current working directory to the specified directory...</span>
 1867     <span class="n">WorkingDir</span> <span class="o">=</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--workingdir&quot;</span><span class="p">]</span>
 1868     <span class="k">if</span> <span class="n">WorkingDir</span><span class="p">:</span>
 1869         <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">WorkingDir</span><span class="p">)</span>
 1870     
 1871     <span class="c1"># Handle examples option...</span>
 1872     <span class="k">if</span> <span class="s2">&quot;--examples&quot;</span> <span class="ow">in</span> <span class="n">Options</span> <span class="ow">and</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--examples&quot;</span><span class="p">]:</span>
 1873         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="n">MiscUtil</span><span class="o">.</span><span class="n">GetExamplesTextFromDocOptText</span><span class="p">(</span><span class="n">_docoptUsage_</span><span class="p">))</span>
 1874         <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
 1875     
 1876 <span class="k">def</span> <span class="nf">ProcessListTorsionLibraryOption</span><span class="p">():</span>
 1877     <span class="sd">&quot;&quot;&quot;Process list torsion library information.&quot;&quot;&quot;</span>
 1878 
 1879     <span class="c1"># Validate and process dataFile option for listing torsion library information...</span>
 1880     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;TorsionLibraryFile&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
 1881     <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^auto$&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--torsionLibraryFile&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
 1882         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ValidateOptionFilePath</span><span class="p">(</span><span class="s2">&quot;-t, --torsionLibraryFile&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--torsionLibraryFile&quot;</span><span class="p">])</span>
 1883         <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;TorsionLibraryFile&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--torsionLibraryFile&quot;</span><span class="p">]</span>
 1884     
 1885     <span class="n">RetrieveTorsionLibraryInfo</span><span class="p">()</span>
 1886     <span class="n">ListTorsionLibraryInfo</span><span class="p">()</span>
 1887     
 1888 <span class="k">def</span> <span class="nf">ValidateOptions</span><span class="p">():</span>
 1889     <span class="sd">&quot;&quot;&quot;Validate option values.&quot;&quot;&quot;</span>
 1890 
 1891     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ValidateOptionTextValue</span><span class="p">(</span><span class="s2">&quot;-a, --alertsMode&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--alertsMode&quot;</span><span class="p">],</span> <span class="s2">&quot;Red RedAndOrange&quot;</span><span class="p">)</span>
 1892     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ValidateOptionIntegerValue</span><span class="p">(</span><span class="s2">&quot;--alertsMinCount&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--alertsMinCount&quot;</span><span class="p">],</span> <span class="p">{</span><span class="s2">&quot;&gt;=&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
 1893     
 1894     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ValidateOptionFilePath</span><span class="p">(</span><span class="s2">&quot;-i, --infile&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--infile&quot;</span><span class="p">])</span>
 1895     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ValidateOptionFileExt</span><span class="p">(</span><span class="s2">&quot;-i, --infile&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--infile&quot;</span><span class="p">],</span> <span class="s2">&quot;sdf sd mol&quot;</span><span class="p">)</span>
 1896     
 1897     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ValidateOptionFileExt</span><span class="p">(</span><span class="s2">&quot;-o, --outfile&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--outfile&quot;</span><span class="p">],</span> <span class="s2">&quot;sdf sd&quot;</span><span class="p">)</span>
 1898     <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^filter$&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--mode&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
 1899         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ValidateOptionsOutputFileOverwrite</span><span class="p">(</span><span class="s2">&quot;-o, --outfile&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--outfile&quot;</span><span class="p">],</span> <span class="s2">&quot;--overwrite&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--overwrite&quot;</span><span class="p">])</span>
 1900         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ValidateOptionsDistinctFileNames</span><span class="p">(</span><span class="s2">&quot;-i, --infile&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--infile&quot;</span><span class="p">],</span> <span class="s2">&quot;-o, --outfile&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--outfile&quot;</span><span class="p">])</span>
 1901 
 1902     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ValidateOptionTextValue</span><span class="p">(</span><span class="s2">&quot;--outfileFiltered&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--outfileFiltered&quot;</span><span class="p">],</span> <span class="s2">&quot;yes no&quot;</span><span class="p">)</span>
 1903     
 1904     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ValidateOptionTextValue</span><span class="p">(</span><span class="s2">&quot;--outfilesFilteredByRules&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--outfilesFilteredByRules&quot;</span><span class="p">],</span> <span class="s2">&quot;yes no&quot;</span><span class="p">)</span>
 1905     <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^All$&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--outfilesFilteredByRulesMaxCount&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
 1906         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ValidateOptionIntegerValue</span><span class="p">(</span><span class="s2">&quot;--outfilesFilteredByRulesMaxCount&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--outfilesFilteredByRulesMaxCount&quot;</span><span class="p">],</span> <span class="p">{</span><span class="s2">&quot;&gt;&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span>
 1907     
 1908     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ValidateOptionTextValue</span><span class="p">(</span><span class="s2">&quot;--outfileSummary&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--outfileSummary&quot;</span><span class="p">],</span> <span class="s2">&quot;yes no&quot;</span><span class="p">)</span>
 1909     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ValidateOptionTextValue</span><span class="p">(</span><span class="s2">&quot;--outfileAlerts&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--outfileAlerts&quot;</span><span class="p">],</span> <span class="s2">&quot;yes no&quot;</span><span class="p">)</span>
 1910     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ValidateOptionTextValue</span><span class="p">(</span><span class="s2">&quot;--outfileAlertsMode&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--outfileAlertsMode&quot;</span><span class="p">],</span> <span class="s2">&quot;All AlertsOnly&quot;</span><span class="p">)</span>
 1911     
 1912     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ValidateOptionTextValue</span><span class="p">(</span><span class="s2">&quot;-m, --mode&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--mode&quot;</span><span class="p">],</span> <span class="s2">&quot;filter count&quot;</span><span class="p">)</span>
 1913     <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^filter$&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--mode&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
 1914         <span class="k">if</span> <span class="ow">not</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--outfile&quot;</span><span class="p">]:</span>
 1915             <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintError</span><span class="p">(</span><span class="s2">&quot;The outfile must be specified using </span><span class="se">\&quot;</span><span class="s2">-o, --outfile</span><span class="se">\&quot;</span><span class="s2"> during </span><span class="se">\&quot;</span><span class="s2">filter</span><span class="se">\&quot;</span><span class="s2"> value of </span><span class="se">\&quot;</span><span class="s2">-m, --mode</span><span class="se">\&quot;</span><span class="s2"> option&quot;</span><span class="p">)</span>
 1916         
 1917     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ValidateOptionTextValue</span><span class="p">(</span><span class="s2">&quot;--mp&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--mp&quot;</span><span class="p">],</span> <span class="s2">&quot;yes no&quot;</span><span class="p">)</span>
 1918     
 1919     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ValidateOptionTextValue</span><span class="p">(</span><span class="s2">&quot;-r, --rotBondsSMARTSMode&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--rotBondsSMARTSMode&quot;</span><span class="p">],</span> <span class="s2">&quot;NonStrict SemiStrict Strict Specify&quot;</span><span class="p">)</span>
 1920     <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^Specify$&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--rotBondsSMARTSMode&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
 1921         <span class="k">if</span> <span class="ow">not</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--rotBondsSMARTSPattern&quot;</span><span class="p">]:</span>
 1922             <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintError</span><span class="p">(</span><span class="s2">&quot;The SMARTS pattern must be specified using </span><span class="se">\&quot;</span><span class="s2">--rotBondsSMARTSPattern</span><span class="se">\&quot;</span><span class="s2"> during </span><span class="se">\&quot;</span><span class="s2">Specify</span><span class="se">\&quot;</span><span class="s2"> value of </span><span class="se">\&quot;</span><span class="s2">-r, --rotBondsSMARTS</span><span class="se">\&quot;</span><span class="s2"> option&quot;</span><span class="p">)</span>
 1923     
 1924     <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^auto$&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--torsionLibraryFile&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
 1925         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ValidateOptionFilePath</span><span class="p">(</span><span class="s2">&quot;-t, --torsionLibraryFile&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--torsionLibraryFile&quot;</span><span class="p">])</span>
 1926 
 1927 <span class="c1"># Setup a usage string for docopt...</span>
 1928 <span class="n">_docoptUsage_</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
 1929 <span class="s2">RDKitFilterTorsionLibraryAlerts.py - Filter torsion library alerts</span>
 1930 
 1931 <span class="s2">Usage:</span>
 1932 <span class="s2">    RDKitFilterTorsionLibraryAlerts.py  [--alertsMode &lt;Red, RedAndOrange&gt;] [--alertsMinCount &lt;Number&gt;]</span>
 1933 <span class="s2">                                        [--infileParams &lt;Name,Value,...&gt;] [--mode &lt;filter or count&gt;] [--mp &lt;yes or no&gt;] [--mpParams &lt;Name,Value,...&gt;]</span>
 1934 <span class="s2">                                        [--nitrogenLonePairParams &lt;Name,Value,...&gt;] [--outfileAlerts &lt;yes or no&gt;]</span>
 1935 <span class="s2">                                        [--outfileAlertsMode &lt;All or AlertsOnly&gt;] [--outfileFiltered &lt;yes or no&gt;]</span>
 1936 <span class="s2">                                        [--outfilesFilteredByRules &lt;yes or no&gt;] [--outfilesFilteredByRulesMaxCount &lt;All or number&gt;]</span>
 1937 <span class="s2">                                        [--outfileSummary &lt;yes or no&gt;] [--outfileSDFieldLabels &lt;Type,Label,...&gt;]</span>
 1938 <span class="s2">                                        [--outfileParams &lt;Name,Value,...&gt;] [--overwrite] [ --rotBondsSMARTSMode &lt;NonStrict, SemiStrict,...&gt;]</span>
 1939 <span class="s2">                                        [--rotBondsSMARTSPattern &lt;SMARTS&gt;] [--torsionLibraryFile &lt;FileName or auto&gt;] [-w &lt;dir&gt;] -i &lt;infile&gt; -o &lt;outfile&gt;</span>
 1940 <span class="s2">    RDKitFilterTorsionLibraryAlerts.py [--torsionLibraryFile &lt;FileName or auto&gt;] -l | --list</span>
 1941 <span class="s2">    RDKitFilterTorsionLibraryAlerts.py -h | --help | -e | --examples</span>
 1942 
 1943 <span class="s2">Description:</span>
 1944 <span class="s2">    Filter strained molecules from an input file for torsion library [ Ref 146, 152, 159 ]</span>
 1945 <span class="s2">    alerts by matching rotatable bonds against SMARTS patterns specified for torsion</span>
 1946 <span class="s2">    rules in a torsion library file and write out appropriate molecules to output</span>
 1947 <span class="s2">    files. The molecules must have 3D coordinates in input file. The default torsion</span>
 1948 <span class="s2">    library file, TorsionLibrary.xml, is available under MAYACHEMTOOLS/lib/data</span>
 1949 <span class="s2">    directory.</span>
 1950 <span class="s2">    </span>
 1951 <span class="s2">    The data in torsion library file is organized in a hierarchical manner. It consists</span>
 1952 <span class="s2">    of one generic class and six specific classes at the highest level. Each class</span>
 1953 <span class="s2">    contains multiple subclasses corresponding to named functional groups or</span>
 1954 <span class="s2">    substructure patterns. The subclasses consist of torsion rules sorted from</span>
 1955 <span class="s2">    specific to generic torsion patterns. The torsion rule, in turn, contains a list</span>
 1956 <span class="s2">    of peak values for torsion angles and two tolerance values. A pair of tolerance</span>
 1957 <span class="s2">    values define torsion bins around a torsion peak value. For example:</span>
 1958 <span class="s2">         </span>
 1959 <span class="s2">        &lt;library&gt;</span>
 1960 <span class="s2">            &lt;hierarchyClass name=&quot;GG&quot; id1=&quot;G&quot; id2=&quot;G&quot;&gt;</span>
 1961 <span class="s2">            ...</span>
 1962 <span class="s2">            &lt;/hierarchyClass&gt;</span>
 1963 <span class="s2">            &lt;hierarchyClass name=&quot;CO&quot; id1=&quot;C&quot; id2=&quot;O&quot;&gt;</span>
 1964 <span class="s2">                &lt;hierarchySubClass name=&quot;Ester bond I&quot; smarts=&quot;O=[C:2][O:3]&quot;&gt;</span>
 1965 <span class="s2">                    &lt;torsionRule smarts=&quot;[O:1]=[C:2]!@[O:3]~[CH0:4]&quot;&gt;</span>
 1966 <span class="s2">                        &lt;angleList&gt;</span>
 1967 <span class="s2">                            &lt;angle value=&quot;0.0&quot; tolerance1=&quot;20.00&quot;</span>
 1968 <span class="s2">                             tolerance2=&quot;25.00&quot; score=&quot;56.52&quot;/&gt;</span>
 1969 <span class="s2">                        &lt;/angleList&gt;</span>
 1970 <span class="s2">                    &lt;/torsionRule&gt;</span>
 1971 <span class="s2">                    ...</span>
 1972 <span class="s2">                ...</span>
 1973 <span class="s2">             ...</span>
 1974 <span class="s2">            &lt;/hierarchyClass&gt;</span>
 1975 <span class="s2">            &lt;hierarchyClass name=&quot;NC&quot; id1=&quot;N&quot; id2=&quot;C&quot;&gt;</span>
 1976 <span class="s2">             ...</span>
 1977 <span class="s2">            &lt;/hierarchyClass&gt;</span>
 1978 <span class="s2">            &lt;hierarchyClass name=&quot;SN&quot; id1=&quot;S&quot; id2=&quot;N&quot;&gt;</span>
 1979 <span class="s2">            ...</span>
 1980 <span class="s2">            &lt;/hierarchyClass&gt;</span>
 1981 <span class="s2">            &lt;hierarchyClass name=&quot;CS&quot; id1=&quot;C&quot; id2=&quot;S&quot;&gt;</span>
 1982 <span class="s2">            ...</span>
 1983 <span class="s2">            &lt;/hierarchyClass&gt;</span>
 1984 <span class="s2">            &lt;hierarchyClass name=&quot;CC&quot; id1=&quot;C&quot; id2=&quot;C&quot;&gt;</span>
 1985 <span class="s2">            ...</span>
 1986 <span class="s2">            &lt;/hierarchyClass&gt;</span>
 1987 <span class="s2">            &lt;hierarchyClass name=&quot;SS&quot; id1=&quot;S&quot; id2=&quot;S&quot;&gt;</span>
 1988 <span class="s2">             ...</span>
 1989 <span class="s2">            &lt;/hierarchyClass&gt;</span>
 1990 <span class="s2">        &lt;/library&gt;</span>
 1991 <span class="s2">        </span>
 1992 <span class="s2">    The rotatable bonds in a 3D molecule are identified using a default SMARTS pattern.</span>
 1993 <span class="s2">    A custom SMARTS pattern may be optionally specified to detect rotatable bonds.</span>
 1994 <span class="s2">    Each rotatable bond is matched to a torsion rule in the torsion library and</span>
 1995 <span class="s2">    assigned one of the following three alert categories: Green, Orange or Red. The </span>
 1996 <span class="s2">    rotatable bond is marked Green or Orange for the measured angle of the torsion</span>
 1997 <span class="s2">    pattern within the first or second tolerance bins around a torsion peak.</span>
 1998 <span class="s2">    Otherwise, it&#39;s marked Red implying that the measured angle is not observed in</span>
 1999 <span class="s2">    the structure databases employed to generate the torsion library.</span>
 2000 
 2001 <span class="s2">    The following output files are generated after the filtering:</span>
 2002 <span class="s2">        </span>
 2003 <span class="s2">        &lt;OutfileRoot&gt;.sdf</span>
 2004 <span class="s2">        &lt;OutfileRoot&gt;_Filtered.sdf</span>
 2005 <span class="s2">        &lt;OutfileRoot&gt;_AlertsSummary.csv</span>
 2006 <span class="s2">        &lt;OutfileRoot&gt;_Filtered_TopRule*.sdf</span>
 2007 <span class="s2">        </span>
 2008 <span class="s2">    The supported input file formats are: Mol (.mol), SD (.sdf, .sd)</span>
 2009 
 2010 <span class="s2">    The supported output file formats are: SD (.sdf, .sd)</span>
 2011 
 2012 <span class="s2">Options:</span>
 2013 <span class="s2">    -a, --alertsMode &lt;Red, RedAndOrange&gt;  [default: Red]</span>
 2014 <span class="s2">        Torsion library alert types to use for filtering molecules containing</span>
 2015 <span class="s2">        rotatable bonds marked with Green, Orange, or Red alerts. Possible</span>
 2016 <span class="s2">        values: Red or RedAndOrange.</span>
 2017 <span class="s2">    --alertsMinCount &lt;Number&gt;  [default: 1]</span>
 2018 <span class="s2">        Minimum number of rotatable bond alerts in a molecule for filtering the</span>
 2019 <span class="s2">        molecule.</span>
 2020 <span class="s2">    -e, --examples</span>
 2021 <span class="s2">        Print examples.</span>
 2022 <span class="s2">    -h, --help</span>
 2023 <span class="s2">        Print this help message.</span>
 2024 <span class="s2">    -i, --infile &lt;infile&gt;</span>
 2025 <span class="s2">        Input file name.</span>
 2026 <span class="s2">    --infileParams &lt;Name,Value,...&gt;  [default: auto]</span>
 2027 <span class="s2">        A comma delimited list of parameter name and value pairs for reading</span>
 2028 <span class="s2">        molecules from files. The supported parameter names for different file</span>
 2029 <span class="s2">        formats, along with their default values, are shown below:</span>
 2030 <span class="s2">            </span>
 2031 <span class="s2">            SD, MOL: removeHydrogens,no,sanitize,yes,strictParsing,yes</span>
 2032 <span class="s2">            </span>
 2033 <span class="s2">    -l, --list</span>
 2034 <span class="s2">        List torsion library information without performing any filtering.</span>
 2035 <span class="s2">    -m, --mode &lt;filter or count&gt;  [default: filter]</span>
 2036 <span class="s2">        Specify whether to filter molecules for torsion library [ Ref 146, 152, 159 ] alerts</span>
 2037 <span class="s2">        by matching rotatable bonds against SMARTS patterns specified for torsion</span>
 2038 <span class="s2">        rules and write out the rest of the molecules to an outfile or simply count</span>
 2039 <span class="s2">        the number of matched molecules marked for filtering.</span>
 2040 <span class="s2">    --mp &lt;yes or no&gt;  [default: no]</span>
 2041 <span class="s2">        Use multiprocessing.</span>
 2042 <span class="s2">         </span>
 2043 <span class="s2">        By default, input data is retrieved in a lazy manner via mp.Pool.imap()</span>
 2044 <span class="s2">        function employing lazy RDKit data iterable. This allows processing of</span>
 2045 <span class="s2">        arbitrary large data sets without any additional requirements memory.</span>
 2046 <span class="s2">        </span>
 2047 <span class="s2">        All input data may be optionally loaded into memory by mp.Pool.map()</span>
 2048 <span class="s2">        before starting worker processes in a process pool by setting the value</span>
 2049 <span class="s2">        of &#39;inputDataMode&#39; to &#39;InMemory&#39; in &#39;--mpParams&#39; option.</span>
 2050 <span class="s2">        </span>
 2051 <span class="s2">        A word to the wise: The default &#39;chunkSize&#39; value of 1 during &#39;Lazy&#39; input</span>
 2052 <span class="s2">        data mode may adversely impact the performance. The &#39;--mpParams&#39; section</span>
 2053 <span class="s2">        provides additional information to tune the value of &#39;chunkSize&#39;.</span>
 2054 <span class="s2">    --mpParams &lt;Name,Value,...&gt;  [default: auto]</span>
 2055 <span class="s2">        A comma delimited list of parameter name and value pairs to configure</span>
 2056 <span class="s2">        multiprocessing.</span>
 2057 <span class="s2">        </span>
 2058 <span class="s2">        The supported parameter names along with their default and possible</span>
 2059 <span class="s2">        values are shown below:</span>
 2060 <span class="s2">        </span>
 2061 <span class="s2">            chunkSize, auto</span>
 2062 <span class="s2">            inputDataMode, Lazy   [ Possible values: InMemory or Lazy ]</span>
 2063 <span class="s2">            numProcesses, auto   [ Default: mp.cpu_count() ]</span>
 2064 <span class="s2">        </span>
 2065 <span class="s2">        These parameters are used by the following functions to configure and</span>
 2066 <span class="s2">        control the behavior of multiprocessing: mp.Pool(), mp.Pool.map(), and</span>
 2067 <span class="s2">        mp.Pool.imap().</span>
 2068 <span class="s2">        </span>
 2069 <span class="s2">        The chunkSize determines chunks of input data passed to each worker</span>
 2070 <span class="s2">        process in a process pool by mp.Pool.map() and mp.Pool.imap() functions.</span>
 2071 <span class="s2">        The default value of chunkSize is dependent on the value of &#39;inputDataMode&#39;.</span>
 2072 <span class="s2">        </span>
 2073 <span class="s2">        The mp.Pool.map() function, invoked during &#39;InMemory&#39; input data mode,</span>
 2074 <span class="s2">        automatically converts RDKit data iterable into a list, loads all data into</span>
 2075 <span class="s2">        memory, and calculates the default chunkSize using the following method</span>
 2076 <span class="s2">        as shown in its code:</span>
 2077 <span class="s2">        </span>
 2078 <span class="s2">            chunkSize, extra = divmod(len(dataIterable), len(numProcesses) * 4)</span>
 2079 <span class="s2">            if extra: chunkSize += 1</span>
 2080 <span class="s2">        </span>
 2081 <span class="s2">        For example, the default chunkSize will be 7 for a pool of 4 worker processes</span>
 2082 <span class="s2">        and 100 data items.</span>
 2083 <span class="s2">        </span>
 2084 <span class="s2">        The mp.Pool.imap() function, invoked during &#39;Lazy&#39; input data mode, employs</span>
 2085 <span class="s2">        &#39;lazy&#39; RDKit data iterable to retrieve data as needed, without loading all the</span>
 2086 <span class="s2">        data into memory. Consequently, the size of input data is not known a priori.</span>
 2087 <span class="s2">        It&#39;s not possible to estimate an optimal value for the chunkSize. The default </span>
 2088 <span class="s2">        chunkSize is set to 1.</span>
 2089 <span class="s2">        </span>
 2090 <span class="s2">        The default value for the chunkSize during &#39;Lazy&#39; data mode may adversely</span>
 2091 <span class="s2">        impact the performance due to the overhead associated with exchanging</span>
 2092 <span class="s2">        small chunks of data. It is generally a good idea to explicitly set chunkSize to</span>
 2093 <span class="s2">        a larger value during &#39;Lazy&#39; input data mode, based on the size of your input</span>
 2094 <span class="s2">        data and number of processes in the process pool.</span>
 2095 <span class="s2">        </span>
 2096 <span class="s2">        The mp.Pool.map() function waits for all worker processes to process all</span>
 2097 <span class="s2">        the data and return the results. The mp.Pool.imap() function, however,</span>
 2098 <span class="s2">        returns the the results obtained from worker processes as soon as the</span>
 2099 <span class="s2">        results become available for specified chunks of data.</span>
 2100 <span class="s2">        </span>
 2101 <span class="s2">        The order of data in the results returned by both mp.Pool.map() and </span>
 2102 <span class="s2">        mp.Pool.imap() functions always corresponds to the input data.</span>
 2103 <span class="s2">    -n, --nitrogenLonePairParams &lt;Name,Value,...&gt;  [default: auto]</span>
 2104 <span class="s2">        A comma delimited list of parameter name and value pairs to match</span>
 2105 <span class="s2">        torsion SMARTS patterns containing non-standard construct &#39;N_lp&#39;</span>
 2106 <span class="s2">        corresponding to nitrogen lone pair.</span>
 2107 <span class="s2">        </span>
 2108 <span class="s2">        The supported parameter names along with their default and possible</span>
 2109 <span class="s2">        values are shown below:</span>
 2110 <span class="s2">        </span>
 2111 <span class="s2">            allowHydrogenNbrs, yes   [ Possible values: yes or no ]</span>
 2112 <span class="s2">            planarityTolerance, 1  [Possible values: &gt;=0] </span>
 2113 <span class="s2">            </span>
 2114 <span class="s2">        These parameters are used during the matching of torsion rules containing</span>
 2115 <span class="s2">        &#39;N_lp&#39; in their SMARTS patterns. The &#39;allowHydrogensNbrs&#39; allows the use</span>
 2116 <span class="s2">        hydrogen neighbors attached to nitrogen during the determination of its</span>
 2117 <span class="s2">        planarity. The &#39;planarityTolerance&#39; in degrees represents the tolerance</span>
 2118 <span class="s2">        allowed for nitrogen to be considered coplanar with its three neighbors.</span>
 2119 <span class="s2">        </span>
 2120 <span class="s2">        The torsion rules containing &#39;N_lp&#39; in their SMARTS patterns are categorized</span>
 2121 <span class="s2">        into the following two types of rules:</span>
 2122 <span class="s2">         </span>
 2123 <span class="s2">            TypeOne:  </span>
 2124 <span class="s2">            </span>
 2125 <span class="s2">            [CX4:1][CX4H2:2]!@[NX3;&quot;N_lp&quot;:3][CX4:4]</span>
 2126 <span class="s2">            [C:1][CX4H2:2]!@[NX3;&quot;N_lp&quot;:3][C:4]</span>
 2127 <span class="s2">            ... ... ...</span>
 2128 <span class="s2">         </span>
 2129 <span class="s2">            TypeTwo:  </span>
 2130 <span class="s2">            </span>
 2131 <span class="s2">            [!#1:1][CX4:2]!@[NX3;&quot;N_lp&quot;:3]</span>
 2132 <span class="s2">            [C:1][$(S(=O)=O):2]!@[&quot;N_lp&quot;:3]</span>
 2133 <span class="s2">            ... ... ...</span>
 2134 <span class="s2">            </span>
 2135 <span class="s2">        The torsions are matched to torsion rules containing &#39;N_lp&#39; using specified</span>
 2136 <span class="s2">        SMARTS patterns without the &#39;N_lp&#39; along with additional constraints using</span>
 2137 <span class="s2">        the following methodology:</span>
 2138 <span class="s2">            </span>
 2139 <span class="s2">            TypeOne:  </span>
 2140 <span class="s2">            </span>
 2141 <span class="s2">            . SMARTS pattern must contain four mapped atoms and the third</span>
 2142 <span class="s2">                mapped atom must be a nitrogen matched with &#39;NX3:3&#39;</span>
 2143 <span class="s2">            . Nitrogen atom must have 3 neighbors. The &#39;allowHydrogens&#39;</span>
 2144 <span class="s2">                parameter controls inclusion of hydrogens as its neighbors.</span>
 2145 <span class="s2">            . Nitrogen atom and its 3 neighbors must be coplanar.</span>
 2146 <span class="s2">                &#39;planarityTolerance&#39; parameter provides tolerance in degrees</span>
 2147 <span class="s2">                for nitrogen to be considered coplanar with its 3 neighbors.</span>
 2148 <span class="s2">            </span>
 2149 <span class="s2">            TypeTwo:  </span>
 2150 <span class="s2">            </span>
 2151 <span class="s2">            . SMARTS pattern must contain three mapped atoms and the third</span>
 2152 <span class="s2">                mapped atom must be a nitrogen matched with &#39;NX3:3&#39;. The </span>
 2153 <span class="s2">                third mapped atom may contain only &#39;N_lp:3&#39; The missing &#39;NX3&#39;</span>
 2154 <span class="s2">                is automatically detected.</span>
 2155 <span class="s2">            . Nitrogen atom must have 3 neighbors. &#39;allowHydrogens&#39;</span>
 2156 <span class="s2">                parameter controls inclusion of hydrogens as neighbors.</span>
 2157 <span class="s2">            . Nitrogen atom and its 3 neighbors must not be coplanar.</span>
 2158 <span class="s2">                &#39;planarityTolerance&#39; parameter provides tolerance in degrees</span>
 2159 <span class="s2">                for nitrogen to be considered coplanar with its 3 neighbors.</span>
 2160 <span class="s2">            . Nitrogen lone pair position equivalent to VSEPR theory is</span>
 2161 <span class="s2">                determined based on the position of nitrogen and its neighbors.</span>
 2162 <span class="s2">                A vector normal to 3 nitrogen neighbors is calculated and added</span>
 2163 <span class="s2">                to the coordinates of nitrogen atom to determine the approximate</span>
 2164 <span class="s2">                position of the lone pair. It is used as the fourth position to</span>
 2165 <span class="s2">                calculate the torsion angle.</span>
 2166 <span class="s2">            </span>
 2167 <span class="s2">    -o, --outfile &lt;outfile&gt;</span>
 2168 <span class="s2">        Output file name.</span>
 2169 <span class="s2">    --outfileAlerts &lt;yes or no&gt;  [default: yes]</span>
 2170 <span class="s2">        Write out alerts information to SD output files.</span>
 2171 <span class="s2">    --outfileAlertsMode &lt;All or AlertsOnly&gt;  [default: AlertsOnly]</span>
 2172 <span class="s2">        Write alerts information to SD output files for all alerts or only for alerts</span>
 2173 <span class="s2">        specified by &#39;--AlertsMode&#39; option. Possible values: All or AlertsOnly</span>
 2174 <span class="s2">        This option is only valid for &#39;Yes&#39; value of &#39;--outfileAlerts&#39; option.</span>
 2175 <span class="s2">        </span>
 2176 <span class="s2">        The following alerts information is added to SD output files using</span>
 2177 <span class="s2">        &#39;TorsionAlerts&#39; data field:</span>
 2178 <span class="s2">            </span>
 2179 <span class="s2">            RotBondIndices TorsionAlert TorsionIndices TorsionAngle</span>
 2180 <span class="s2">            TorsionAngleViolation HierarchyClass HierarchySubClass</span>
 2181 <span class="s2">            TorsionRule TorsionPeaks Tolerances1 Tolerances2</span>
 2182 <span class="s2">            </span>
 2183 <span class="s2">        The &#39;RotBondsCount&#39; and &#39;TorsionAlertsCount&#39; data fields are always added</span>
 2184 <span class="s2">        to SD output files containing both remaining and filtered molecules.</span>
 2185 <span class="s2">        </span>
 2186 <span class="s2">        Format:</span>
 2187 <span class="s2">            </span>
 2188 <span class="s2">            &gt; &lt;RotBondsCount&gt;</span>
 2189 <span class="s2">            Number</span>
 2190 <span class="s2">            </span>
 2191 <span class="s2">            &gt; &lt;TorsionAlertsCount (Green Orange Red)&gt;</span>
 2192 <span class="s2">            Number Number Number</span>
 2193 <span class="s2">            </span>
 2194 <span class="s2">            &gt; &lt;TorsionAlerts (RotBondIndices TorsionAlert TorsionIndices</span>
 2195 <span class="s2">                TorsionAngle TorsionAngleViolation HierarchyClass</span>
 2196 <span class="s2">                HierarchySubClass TorsionPeaks Tolerances1 Tolerances2</span>
 2197 <span class="s2">                TorsionRule)&gt;</span>
 2198 <span class="s2">            AtomIndex2,AtomIndex3  AlertType AtomIndex1,AtomIndex2,AtomIndex3,</span>
 2199 <span class="s2">            AtomIndex4 Angle AngleViolation ClassName SubClassName</span>
 2200 <span class="s2">            CommaDelimPeakValues CommaDelimTol1Values CommDelimTol2Values</span>
 2201 <span class="s2">            SMARTS ... ... ...</span>
 2202 <span class="s2">             ... ... ...</span>
 2203 <span class="s2">            </span>
 2204 <span class="s2">        A set of 11 values is written out as value of &#39;TorsionAlerts&#39; data field for</span>
 2205 <span class="s2">        each torsion in a molecule. The space character is used as a delimiter</span>
 2206 <span class="s2">        to separate values with in a set and across set. The comma character</span>
 2207 <span class="s2">        is used to delimit multiple values for each value in a set.</span>
 2208 <span class="s2">        </span>
 2209 <span class="s2">        The &#39;RotBondIndices&#39; and &#39;TorsionIndices&#39; contain 2 and 4 comma delimited</span>
 2210 <span class="s2">        values representing atom indices for a rotatable bond and matched torsion.</span>
 2211 <span class="s2">        The &#39;TorsionPeaks&#39;,  &#39;Tolerances1&#39;, and &#39;Tolerances2&#39; contain same number</span>
 2212 <span class="s2">        of comma delimited values corresponding to  torsion angle peaks and</span>
 2213 <span class="s2">        tolerance intervals specified in torsion library. For example:</span>
 2214 <span class="s2">            </span>
 2215 <span class="s2">            ... ... ...</span>
 2216 <span class="s2">            &gt;  &lt;RotBondsCount&gt;  (1) </span>
 2217 <span class="s2">            7</span>
 2218 <span class="s2">            </span>
 2219 <span class="s2">            &gt;  &lt;TorsionAlertsCount (Green Orange Red)&gt;  (1) </span>
 2220 <span class="s2">            3 2 2</span>
 2221 <span class="s2">            </span>
 2222 <span class="s2">            &gt;  &lt;TorsionAlerts (RotBondIndices TorsionAlert TorsionIndices</span>
 2223 <span class="s2">                TorsionAngle TorsionAngleViolation HierarchyClass</span>
 2224 <span class="s2">                HierarchySubClass TorsionPeaks Tolerances1 Tolerances2</span>
 2225 <span class="s2">                TorsionRule)&gt;</span>
 2226 <span class="s2">            1,2 Red 32,2,1,0 0.13 149.87 NC Anilines 180.0 10.0 30.0 [cH0:1][c:2]</span>
 2227 <span class="s2">            ([cH,nX2H0])!@[NX3H1:3][CX4:4] 8,9 Red 10,9,8,28 -0.85 GG</span>
 2228 <span class="s2">            None -90.0,90.0 30.0,30.0 60.0,60.0 [cH1:1][a:2]([cH1])!@[a:3]</span>
 2229 <span class="s2">            ([cH0])[cH0:4]</span>
 2230 <span class="s2">            ... ... ...</span>
 2231 <span class="s2">            </span>
 2232 <span class="s2">    --outfileFiltered &lt;yes or no&gt;  [default: yes]</span>
 2233 <span class="s2">        Write out a file containing filtered molecules. Its name is automatically</span>
 2234 <span class="s2">        generated from the specified output file. Default: &lt;OutfileRoot&gt;_</span>
 2235 <span class="s2">        Filtered.&lt;OutfileExt&gt;.</span>
 2236 <span class="s2">    --outfilesFilteredByRules &lt;yes or no&gt;  [default: yes]</span>
 2237 <span class="s2">        Write out SD files containing filtered molecules for individual torsion</span>
 2238 <span class="s2">        rules triggering alerts in molecules. The name of SD files are automatically</span>
 2239 <span class="s2">        generated from the specified output file. Default file names: &lt;OutfileRoot&gt;_</span>
 2240 <span class="s2">        Filtered_TopRule*.sdf</span>
 2241 <span class="s2">                </span>
 2242 <span class="s2">        The following alerts information is added to SD output files:</span>
 2243 <span class="s2">            </span>
 2244 <span class="s2">            &gt; &lt;RotBondsCount&gt;</span>
 2245 <span class="s2">            Number</span>
 2246 <span class="s2">            </span>
 2247 <span class="s2">            &gt;  &lt;TorsionAlertsCount (Green Orange Red)&gt; </span>
 2248 <span class="s2">            Number Number Number</span>
 2249 <span class="s2">            </span>
 2250 <span class="s2">            &gt;  &lt;TorsionRule (HierarchyClass HierarchySubClass TorsionPeaks</span>
 2251 <span class="s2">                Tolerances1 Tolerances2 TorsionRule)&gt; </span>
 2252 <span class="s2">            ClassName SubClassName CommaDelimPeakValues CommaDelimTol1Values</span>
 2253 <span class="s2">            CommDelimTol2Values SMARTS ... ... ...</span>
 2254 <span class="s2">             ... ... ...</span>
 2255 <span class="s2">            </span>
 2256 <span class="s2">            &gt; &lt;TorsionRuleAlertsCount (Green Orange Red)&gt;</span>
 2257 <span class="s2">            Number Number Number</span>
 2258 <span class="s2">            </span>
 2259 <span class="s2">            &gt;  &lt;TorsionRuleAlerts (RotBondIndices TorsionAlert TorsionIndices</span>
 2260 <span class="s2">                TorsionAngle TorsionAngleViolation)&gt;</span>
 2261 <span class="s2">            AtomIndex2,AtomIndex3  AlertType AtomIndex1,AtomIndex2,AtomIndex3,</span>
 2262 <span class="s2">            AtomIndex4 Angle AngleViolation ... ... ...</span>
 2263 <span class="s2">            </span>
 2264 <span class="s2">            &gt;  &lt;TorsionRuleMaxAngleViolation&gt;</span>
 2265 <span class="s2">            Number</span>
 2266 <span class="s2">             ... ... ...</span>
 2267 <span class="s2">            </span>
 2268 <span class="s2">        For example:</span>
 2269 <span class="s2">            </span>
 2270 <span class="s2">            ... ... ...</span>
 2271 <span class="s2">            &gt;  &lt;RotBondsCount&gt;  (1) </span>
 2272 <span class="s2">            7</span>
 2273 <span class="s2">             </span>
 2274 <span class="s2">            &gt;  &lt;TorsionAlertsCount (Green Orange Red)&gt;  (1) </span>
 2275 <span class="s2">            3 2 2</span>
 2276 <span class="s2">            </span>
 2277 <span class="s2">            &gt;  &lt;TorsionRule (HierarchyClass HierarchySubClass TorsionPeaks</span>
 2278 <span class="s2">                Tolerances1 Tolerances2 TorsionRule)&gt;  (1) </span>
 2279 <span class="s2">            NC Anilines 180.0 10.0 30.0 [cH0:1][c:2]([cH,nX2H0])!@[NX3H1:3][CX4:4]</span>
 2280 <span class="s2">            </span>
 2281 <span class="s2">            &gt;  &lt;TorsionRuleAlertsCount (Green Orange Red)&gt;  (1) </span>
 2282 <span class="s2">            0 0 1</span>
 2283 <span class="s2">            </span>
 2284 <span class="s2">            &gt;  &lt;TorsionRuleAlerts (RotBondIndices TorsionAlert TorsionIndices</span>
 2285 <span class="s2">                TorsionAngle TorsionAngleViolation)&gt;  (1) </span>
 2286 <span class="s2">            1,2 Red 32,2,1,0 0.13 149.87</span>
 2287 <span class="s2">            </span>
 2288 <span class="s2">            &gt;  &lt;TorsionRuleMaxAngleViolation&gt;  (1) </span>
 2289 <span class="s2">            149.87</span>
 2290 <span class="s2">            ... ... ...</span>
 2291 <span class="s2">            </span>
 2292 <span class="s2">    --outfilesFilteredByRulesMaxCount &lt;All or number&gt;  [default: 10]</span>
 2293 <span class="s2">        Write out SD files containing filtered molecules for specified number of</span>
 2294 <span class="s2">        top N torsion rules triggering alerts for the largest number of molecules</span>
 2295 <span class="s2">        or for all torsion rules triggering alerts across all molecules.</span>
 2296 <span class="s2">    --outfileSummary &lt;yes or no&gt;  [default: yes] </span>
 2297 <span class="s2">        Write out a CVS text file containing summary of torsions rules responsible</span>
 2298 <span class="s2">        for triggering torsion alerts. Its name is automatically generated from the</span>
 2299 <span class="s2">        specified output file. Default: &lt;OutfileRoot&gt;_AlertsSummary.csv.</span>
 2300 <span class="s2">        </span>
 2301 <span class="s2">        The following alerts information is written to summary text file:</span>
 2302 <span class="s2">            </span>
 2303 <span class="s2">            TorsionRule, TorsionPeaks, Tolerances1, Tolerances2,</span>
 2304 <span class="s2">            HierarchyClass, HierarchySubClass, TorsionAlertType,</span>
 2305 <span class="s2">            TorsionAlertCount, TorsionAlertMolCount</span>
 2306 <span class="s2">             </span>
 2307 <span class="s2">        The double quotes characters are removed from SMART patterns before</span>
 2308 <span class="s2">        before writing them to a CSV file. In addition, the torsion rules are sorted by</span>
 2309 <span class="s2">        TorsionAlertMolCount. For example:</span>
 2310 <span class="s2">            </span>
 2311 <span class="s2">            &quot;TorsionRule&quot;,&quot;TorsionPeaks&quot;,&quot;Tolerances1&quot;,&quot;Tolerances2&quot;,</span>
 2312 <span class="s2">                &quot;HierarchyClass&quot;,&quot;HierarchySubClass&quot;,&quot;TorsionAlertTypes&quot;,</span>
 2313 <span class="s2">                &quot;TorsionAlertCount&quot;,&quot;TorsionAlertMolCount&quot;</span>
 2314 <span class="s2">            &quot;[!#1:1][CX4H2:2]!@[CX4H2:3][!#1:4]&quot;,&quot;-60.0,60.0,180.0&quot;,</span>
 2315 <span class="s2">                &quot;20.0,20.0,20.0&quot;,&quot;30.0,30.0,30.0&quot;,&quot;CC&quot;,&quot;None/[CX4:2][CX4:3]&quot;,</span>
 2316 <span class="s2">                &quot;Red&quot;,&quot;16&quot;,&quot;11&quot;</span>
 2317 <span class="s2">            ... ... ...</span>
 2318 <span class="s2">            </span>
 2319 <span class="s2">    --outfileSDFieldLabels &lt;Type,Label,...&gt;  [default: auto]</span>
 2320 <span class="s2">        A comma delimited list of SD data field type and label value pairs for writing</span>
 2321 <span class="s2">        torsion alerts information along with molecules to SD files.</span>
 2322 <span class="s2">        </span>
 2323 <span class="s2">        The supported SD data field label type along with their default values are</span>
 2324 <span class="s2">        shown below:</span>
 2325 <span class="s2">            </span>
 2326 <span class="s2">            For all SD files:</span>
 2327 <span class="s2">            </span>
 2328 <span class="s2">            RotBondsCountLabel, RotBondsCount</span>
 2329 <span class="s2">            TorsionAlertsCountLabel, TorsionAlertsCount (Green Orange Red)</span>
 2330 <span class="s2">            TorsionAlertsLabel, TorsionAlerts (RotBondIndices TorsionAlert</span>
 2331 <span class="s2">                TorsionIndices TorsionAngle TorsionAngleViolation</span>
 2332 <span class="s2">                HierarchyClass HierarchySubClass TorsionPeaks Tolerances1</span>
 2333 <span class="s2">                Tolerances2 TorsionRule)</span>
 2334 <span class="s2">            </span>
 2335 <span class="s2">            For individual SD files filtered by torsion rules:</span>
 2336 <span class="s2">            </span>
 2337 <span class="s2">            TorsionRuleLabel, TorsionRule (HierarchyClass HierarchySubClass</span>
 2338 <span class="s2">                TorsionPeaks Tolerances1 Tolerances2 TorsionRule)</span>
 2339 <span class="s2">            TorsionRuleAlertsCountLabel, TorsionRuleAlertsCount (Green Orange</span>
 2340 <span class="s2">                Red)</span>
 2341 <span class="s2">            TorsionRuleAlertsLabel, TorsionRuleAlerts (RotBondIndices</span>
 2342 <span class="s2">                TorsionAlert TorsionIndices TorsionAngle TorsionAngleViolation)</span>
 2343 <span class="s2">            TorsionRuleMaxAngleViolationLabel, TorsionRuleMaxAngleViolation</span>
 2344 <span class="s2">            </span>
 2345 <span class="s2">    --outfileParams &lt;Name,Value,...&gt;  [default: auto]</span>
 2346 <span class="s2">        A comma delimited list of parameter name and value pairs for writing</span>
 2347 <span class="s2">        molecules to files. The supported parameter names for different file</span>
 2348 <span class="s2">        formats, along with their default values, are shown below:</span>
 2349 <span class="s2">            </span>
 2350 <span class="s2">            SD: kekulize,yes</span>
 2351 <span class="s2">            </span>
 2352 <span class="s2">    --overwrite</span>
 2353 <span class="s2">        Overwrite existing files.</span>
 2354 <span class="s2">    -r, --rotBondsSMARTSMode &lt;NonStrict, SemiStrict,...&gt;  [default: SemiStrict]</span>
 2355 <span class="s2">        SMARTS pattern to use for identifying rotatable bonds in a molecule</span>
 2356 <span class="s2">        for matching against torsion rules in the torsion library. Possible values:</span>
 2357 <span class="s2">        NonStrict, SemiStrict, Strict or Specify. The rotatable bond SMARTS matches</span>
 2358 <span class="s2">        are filtered to ensure that each atom in the rotatable bond is attached to</span>
 2359 <span class="s2">        at least two heavy atoms.</span>
 2360 <span class="s2">        </span>
 2361 <span class="s2">        The following SMARTS patterns are used to identify rotatable bonds for</span>
 2362 <span class="s2">        different modes:</span>
 2363 <span class="s2">            </span>
 2364 <span class="s2">            NonStrict: [!$(*#*)&amp;!D1]-&amp;!@[!$(*#*)&amp;!D1]</span>
 2365 <span class="s2">            </span>
 2366 <span class="s2">            SemiStrict:</span>
 2367 <span class="s2">            [!$(*#*)&amp;!D1&amp;!$(C(F)(F)F)&amp;!$(C(Cl)(Cl)Cl)&amp;!$(C(Br)(Br)Br)</span>
 2368 <span class="s2">            &amp;!$(C([CH3])([CH3])[CH3])]-!@[!$(*#*)&amp;!D1&amp;!$(C(F)(F)F)</span>
 2369 <span class="s2">            &amp;!$(C(Cl)(Cl)Cl)&amp;!$(C(Br)(Br)Br)&amp;!$(C([CH3])([CH3])[CH3])]</span>
 2370 <span class="s2">            </span>
 2371 <span class="s2">            Strict:</span>
 2372 <span class="s2">            [!$(*#*)&amp;!D1&amp;!$(C(F)(F)F)&amp;!$(C(Cl)(Cl)Cl)&amp;!$(C(Br)(Br)Br)</span>
 2373 <span class="s2">            &amp;!$(C([CH3])([CH3])[CH3])&amp;!$([CD3](=[N,O,S])-!@[#7,O,S!D1])</span>
 2374 <span class="s2">            &amp;!$([#7,O,S!D1]-!@[CD3]=[N,O,S])&amp;!$([CD3](=[N+])-!@[#7!D1])</span>
 2375 <span class="s2">            &amp;!$([#7!D1]-!@[CD3]=[N+])]-!@[!$(*#*)&amp;!D1&amp;!$(C(F)(F)F)</span>
 2376 <span class="s2">            &amp;!$(C(Cl)(Cl)Cl)&amp;!$(C(Br)(Br)Br)&amp;!$(C([CH3])([CH3])[CH3])]</span>
 2377 <span class="s2">            </span>
 2378 <span class="s2">        The &#39;NonStrict&#39; and &#39;Strict&#39; SMARTS patterns are available in RDKit. The </span>
 2379 <span class="s2">        &#39;NonStrict&#39; SMARTS pattern corresponds to original Daylight SMARTS</span>
 2380 <span class="s2">         specification for rotatable bonds. The &#39;SemiStrict&#39; SMARTS pattern is </span>
 2381 <span class="s2">         derived from &#39;Strict&#39; SMARTS patterns for its usage in this script.</span>
 2382 <span class="s2">        </span>
 2383 <span class="s2">        You may use any arbitrary SMARTS pattern to identify rotatable bonds by</span>
 2384 <span class="s2">        choosing &#39;Specify&#39; value for &#39;-r, --rotBondsSMARTSMode&#39; option and providing its</span>
 2385 <span class="s2">        value via &#39;--rotBondsSMARTSPattern&#39; option.</span>
 2386 <span class="s2">    --rotBondsSMARTSPattern &lt;SMARTS&gt;</span>
 2387 <span class="s2">        SMARTS pattern for identifying rotatable bonds. This option is only valid</span>
 2388 <span class="s2">        for &#39;Specify&#39; value of &#39;-r, --rotBondsSMARTSMode&#39; option.</span>
 2389 <span class="s2">    -t, --torsionLibraryFile &lt;FileName or auto&gt;  [default: auto]</span>
 2390 <span class="s2">        Specify a XML file name containing data for torsion library hierarchy or use</span>
 2391 <span class="s2">        default file, TorsionLibrary.xml, available in MAYACHEMTOOLS/lib/data</span>
 2392 <span class="s2">        directory.</span>
 2393 <span class="s2">        </span>
 2394 <span class="s2">        The format of data in local XML file must match format of the data in Torsion</span>
 2395 <span class="s2">        Library [ Ref 146, 152, 159 ] file available in MAYACHEMTOOLS data directory.</span>
 2396 <span class="s2">    -w, --workingdir &lt;dir&gt;</span>
 2397 <span class="s2">        Location of working directory which defaults to the current directory.</span>
 2398 
 2399 <span class="s2">Examples:</span>
 2400 <span class="s2">    To filter molecules containing any rotatable bonds marked with Red alerts</span>
 2401 <span class="s2">    based on torsion rules in the torsion library and write out SD files containing</span>
 2402 <span class="s2">    remaining and filtered molecules, and individual SD files for torsion rules</span>
 2403 <span class="s2">    triggering alerts along with appropriate torsion information for red alerts,</span>
 2404 <span class="s2">    type:</span>
 2405 
 2406 <span class="s2">        % RDKitFilterTorsionLibraryAlerts.py -i Sample3D.sdf -o Sample3DOut.sdf</span>
 2407 
 2408 <span class="s2">    To run the first example for only counting number of alerts without writing</span>
 2409 <span class="s2">    out any SD files, type:</span>
 2410 
 2411 <span class="s2">        % RDKitFilterTorsionLibraryAlerts.py -m count -i Sample3D.sdf -o</span>
 2412 <span class="s2">          Sample3DOut.sdf</span>
 2413 <span class="s2">    </span>
 2414 <span class="s2">    To run the first example for filtertering molecules marked with Orange or</span>
 2415 <span class="s2">    Red alerts and write out SD files, tye:</span>
 2416 
 2417 <span class="s2">        % RDKitFilterTorsionLibraryAlerts.py -m Filter --alertsMode RedAndOrange</span>
 2418 <span class="s2">          -i Sample3D.sdf -o Sample3DOut.sdf</span>
 2419 <span class="s2">    </span>
 2420 <span class="s2">    To run the first example for filtering molecules and writing out torsion</span>
 2421 <span class="s2">    information for all alert types to SD files, type:</span>
 2422 
 2423 <span class="s2">        % RDKitFilterTorsionLibraryAlerts.py --outfileAlertsMode All</span>
 2424 <span class="s2">          -i Sample3D.sdf -o Sample3DOut.sdf</span>
 2425 
 2426 <span class="s2">    To run the first example for filtering molecules in multiprocessing mode on</span>
 2427 <span class="s2">    all available CPUs without loading all data into memory and write out SD files,</span>
 2428 <span class="s2">    type:</span>
 2429 
 2430 <span class="s2">        % RDKitFilterTorsionLibraryAlerts.py --mp yes -i Sample3D.sdf</span>
 2431 <span class="s2">         -o Sample3DOut.sdf</span>
 2432 
 2433 <span class="s2">    To run the first example for filtering molecules in multiprocessing mode on</span>
 2434 <span class="s2">    all available CPUs by loading all data into memory and write out a SD files,</span>
 2435 <span class="s2">    type:</span>
 2436 
 2437 <span class="s2">        % RDKitFilterTorsionLibraryAlerts.py  --mp yes --mpParams</span>
 2438 <span class="s2">          &quot;inputDataMode, InMemory&quot; -i Sample3D.sdf  -o Sample3DOut.sdf</span>
 2439 
 2440 <span class="s2">    To run the first example for filtering molecules in multiprocessing mode on</span>
 2441 <span class="s2">    specific number of CPUs and chunksize without loading all data into memory</span>
 2442 <span class="s2">    and write out SD files, type:</span>
 2443 
 2444 <span class="s2">        % RDKitFilterTorsionLibraryAlerts.py --mp yes --mpParams</span>
 2445 <span class="s2">          &quot;inputDataMode,lazy,numProcesses,4,chunkSize,8&quot;  -i Sample3D.sdf</span>
 2446 <span class="s2">          -o Sample3DOut.sdf</span>
 2447 
 2448 <span class="s2">    To list information about default torsion library file without performing any</span>
 2449 <span class="s2">    filtering, type:</span>
 2450 
 2451 <span class="s2">        % RDKitFilterTorsionLibraryAlerts.py -l</span>
 2452 
 2453 <span class="s2">    To list information about a local torsion library XML file without performing</span>
 2454 <span class="s2">    any, filtering, type:</span>
 2455 
 2456 <span class="s2">        % RDKitFilterTorsionLibraryAlerts.py --torsionLibraryFile</span>
 2457 <span class="s2">          TorsionLibrary.xml -l</span>
 2458 
 2459 <span class="s2">Author:</span>
 2460 <span class="s2">    Manish Sud (msud@san.rr.com)</span>
 2461 
 2462 <span class="s2">Collaborator:</span>
 2463 <span class="s2">    Pat Walters</span>
 2464 
 2465 <span class="s2">Acknowledgments:</span>
 2466 <span class="s2">    Wolfgang Guba, Patrick Penner, Levi Pierce</span>
 2467 
 2468 <span class="s2">See also:</span>
 2469 <span class="s2">    RDKitFilterChEMBLAlerts.py, RDKitFilterPAINS.py, RDKitFilterTorsionStrainEnergyAlerts.py,</span>
 2470 <span class="s2">    RDKitConvertFileFormat.py, RDKitSearchSMARTS.py</span>
 2471 
 2472 <span class="s2">Copyright:</span>
 2473 <span class="s2">    Copyright (C) 2022 Manish Sud. All rights reserved.</span>
 2474 
 2475 <span class="s2">    This script uses the Torsion Library jointly developed by the University</span>
 2476 <span class="s2">    of Hamburg, Center for Bioinformatics, Hamburg, Germany and</span>
 2477 <span class="s2">    F. Hoffmann-La-Roche Ltd., Basel, Switzerland.</span>
 2478 
 2479 <span class="s2">    The functionality available in this script is implemented using RDKit, an</span>
 2480 <span class="s2">    open source toolkit for cheminformatics developed by Greg Landrum.</span>
 2481 
 2482 <span class="s2">    This file is part of MayaChemTools.</span>
 2483 
 2484 <span class="s2">    MayaChemTools is free software; you can redistribute it and/or modify it under</span>
 2485 <span class="s2">    the terms of the GNU Lesser General Public License as published by the Free</span>
 2486 <span class="s2">    Software Foundation; either version 3 of the License, or (at your option) any</span>
 2487 <span class="s2">    later version.</span>
 2488 
 2489 <span class="s2">&quot;&quot;&quot;</span>
 2490 
 2491 <span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
 2492     <span class="n">main</span><span class="p">()</span>
</pre>
<br />
<center>
<img src="../../../images/h2o2.png">
</center>
</body>
</html>
