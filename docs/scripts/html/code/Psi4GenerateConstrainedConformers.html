<html>
<head>
<title>MayaChemTools:Code:Psi4GenerateConstrainedConformers.py</title>
<meta http-equiv="content-type" content="text/html;charset=utf-8">
<link rel="stylesheet" type="text/css" href="../../../css/MayaChemToolsPythonCode.css">
</head>
<body leftmargin="20" rightmargin="20" topmargin="10" bottommargin="10">
<br/>
<center>
<a href="http://www.mayachemtools.org" title="MayaChemTools Home"><img src="../../../images/MayaChemToolsLogo.gif" border="0" alt="MayaChemTools"></a>
</center>
<br/>
<pre>
    1 <span class="ch">#!/bin/env python</span>
    2 <span class="c1">#</span>
    3 <span class="c1"># File: Psi4GenerateConstrainedConformers.py</span>
    4 <span class="c1"># Author: Manish Sud &lt;msud@san.rr.com&gt;</span>
    5 <span class="c1">#</span>
    6 <span class="c1"># Copyright (C) 2022 Manish Sud. All rights reserved.</span>
    7 <span class="c1">#</span>
    8 <span class="c1"># The functionality available in this script is implemented using Psi4, an</span>
    9 <span class="c1"># open source quantum chemistry software package, and RDKit, an open</span>
   10 <span class="c1"># source toolkit for cheminformatics developed by Greg Landrum.</span>
   11 <span class="c1">#</span>
   12 <span class="c1"># This file is part of MayaChemTools.</span>
   13 <span class="c1">#</span>
   14 <span class="c1"># MayaChemTools is free software; you can redistribute it and/or modify it under</span>
   15 <span class="c1"># the terms of the GNU Lesser General Public License as published by the Free</span>
   16 <span class="c1"># Software Foundation; either version 3 of the License, or (at your option) any</span>
   17 <span class="c1"># later version.</span>
   18 <span class="c1">#</span>
   19 <span class="c1"># MayaChemTools is distributed in the hope that it will be useful, but without</span>
   20 <span class="c1"># any warranty; without even the implied warranty of merchantability of fitness</span>
   21 <span class="c1"># for a particular purpose.  See the GNU Lesser General Public License for more</span>
   22 <span class="c1"># details.</span>
   23 <span class="c1">#</span>
   24 <span class="c1"># You should have received a copy of the GNU Lesser General Public License</span>
   25 <span class="c1"># along with MayaChemTools; if not, see &lt;http://www.gnu.org/licenses/&gt; or</span>
   26 <span class="c1"># write to the Free Software Foundation Inc., 59 Temple Place, Suite 330,</span>
   27 <span class="c1"># Boston, MA, 02111-1307, USA.</span>
   28 <span class="c1">#</span>
   29 
   30 <span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>
   31 
   32 <span class="c1"># Add local python path to the global path and import standard library modules...</span>
   33 <span class="kn">import</span> <span class="nn">os</span>
   34 <span class="kn">import</span> <span class="nn">sys</span><span class="p">;</span>  <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="s2">&quot;..&quot;</span><span class="p">,</span> <span class="s2">&quot;lib&quot;</span><span class="p">,</span> <span class="s2">&quot;Python&quot;</span><span class="p">))</span>
   35 <span class="kn">import</span> <span class="nn">time</span>
   36 <span class="kn">import</span> <span class="nn">re</span>
   37 <span class="kn">import</span> <span class="nn">shutil</span>
   38 <span class="kn">import</span> <span class="nn">multiprocessing</span> <span class="kn">as</span> <span class="nn">mp</span>
   39 
   40 <span class="c1"># Psi4 imports...</span>
   41 <span class="k">if</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">shutil</span><span class="p">,</span> <span class="s1">&#39;which&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">shutil</span><span class="o">.</span><span class="n">which</span><span class="p">(</span><span class="s2">&quot;psi4&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">):</span>
   42     <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Warning: Failed to find &#39;psi4&#39; in your PATH indicating potential issues with your</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
   43     <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Psi4 environment. The &#39;import psi4&#39; directive in the global scope of the script</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
   44     <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;interferes with the multiprocessing functionality. It is imported later in the</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
   45     <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;local scope during the execution of the script and may fail. Check/update your</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
   46     <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Psi4 environment and try again.</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
   47 
   48 <span class="c1"># RDKit imports...</span>
   49 <span class="k">try</span><span class="p">:</span>
   50     <span class="kn">from</span> <span class="nn">rdkit</span> <span class="kn">import</span> <span class="n">rdBase</span>
   51     <span class="kn">from</span> <span class="nn">rdkit</span> <span class="kn">import</span> <span class="n">Chem</span>
   52     <span class="kn">from</span> <span class="nn">rdkit.Chem</span> <span class="kn">import</span> <span class="n">AllChem</span><span class="p">,</span> <span class="n">rdMolAlign</span>
   53     <span class="kn">from</span> <span class="nn">rdkit.Chem</span> <span class="kn">import</span> <span class="n">rdFMCS</span>
   54 <span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">ErrMsg</span><span class="p">:</span>
   55     <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Failed to import RDKit module/package: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">ErrMsg</span><span class="p">)</span>
   56     <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Check/update your RDKit environment and try again.</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
   57     <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
   58 
   59 <span class="c1"># MayaChemTools imports...</span>
   60 <span class="k">try</span><span class="p">:</span>
   61     <span class="kn">from</span> <span class="nn">docopt</span> <span class="kn">import</span> <span class="n">docopt</span>
   62     <span class="kn">import</span> <span class="nn">MiscUtil</span>
   63     <span class="kn">import</span> <span class="nn">Psi4Util</span>
   64     <span class="kn">import</span> <span class="nn">RDKitUtil</span>
   65 <span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">ErrMsg</span><span class="p">:</span>
   66     <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Failed to import MayaChemTools module/package: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">ErrMsg</span><span class="p">)</span>
   67     <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Check/update your MayaChemTools environment and try again.</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
   68     <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
   69 
   70 <span class="n">ScriptName</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
   71 <span class="n">Options</span> <span class="o">=</span> <span class="p">{}</span>
   72 <span class="n">OptionsInfo</span> <span class="o">=</span> <span class="p">{}</span>
   73 
   74 <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
   75     <span class="sd">&quot;&quot;&quot;Start execution of the script.&quot;&quot;&quot;</span>
   76     
   77     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">%s</span><span class="s2"> (Psi4: Imported later; RDKit v</span><span class="si">%s</span><span class="s2">; MayaChemTools v</span><span class="si">%s</span><span class="s2">; </span><span class="si">%s</span><span class="s2">): Starting...</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ScriptName</span><span class="p">,</span> <span class="n">rdBase</span><span class="o">.</span><span class="n">rdkitVersion</span><span class="p">,</span> <span class="n">MiscUtil</span><span class="o">.</span><span class="n">GetMayaChemToolsVersion</span><span class="p">(),</span> <span class="n">time</span><span class="o">.</span><span class="n">asctime</span><span class="p">()))</span>
   78     
   79     <span class="p">(</span><span class="n">WallClockTime</span><span class="p">,</span> <span class="n">ProcessorTime</span><span class="p">)</span> <span class="o">=</span> <span class="n">MiscUtil</span><span class="o">.</span><span class="n">GetWallClockAndProcessorTime</span><span class="p">()</span>
   80     
   81     <span class="c1"># Retrieve command line arguments and options...</span>
   82     <span class="n">RetrieveOptions</span><span class="p">()</span>
   83     
   84     <span class="c1"># Process and validate command line arguments and options...</span>
   85     <span class="n">ProcessOptions</span><span class="p">()</span>
   86     
   87     <span class="c1"># Perform actions required by the script...</span>
   88     <span class="n">GenerateConstrainedConformers</span><span class="p">()</span>
   89     
   90     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">%s</span><span class="s2">: Done...</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">ScriptName</span><span class="p">)</span>
   91     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;Total time: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">MiscUtil</span><span class="o">.</span><span class="n">GetFormattedElapsedTime</span><span class="p">(</span><span class="n">WallClockTime</span><span class="p">,</span> <span class="n">ProcessorTime</span><span class="p">))</span>
   92 
   93 <span class="k">def</span> <span class="nf">GenerateConstrainedConformers</span><span class="p">():</span>
   94     <span class="sd">&quot;&quot;&quot;Generate constrained conformers.&quot;&quot;&quot;</span>
   95     
   96     <span class="c1"># Read and validate reference molecule...</span>
   97     <span class="n">RefMol</span> <span class="o">=</span> <span class="n">RetrieveReferenceMolecule</span><span class="p">()</span>
   98     
   99     <span class="c1"># Setup a molecule reader for input file...</span>
  100     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Processing file </span><span class="si">%s</span><span class="s2">...&quot;</span> <span class="o">%</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Infile&quot;</span><span class="p">])</span>
  101     <span class="n">Mols</span>  <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">ReadMolecules</span><span class="p">(</span><span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Infile&quot;</span><span class="p">],</span> <span class="o">**</span><span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;InfileParams&quot;</span><span class="p">])</span>
  102     
  103     <span class="c1"># Set up a molecule writer...</span>
  104     <span class="n">Writer</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">MoleculesWriter</span><span class="p">(</span><span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Outfile&quot;</span><span class="p">],</span> <span class="o">**</span><span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;OutfileParams&quot;</span><span class="p">])</span>
  105     <span class="k">if</span> <span class="n">Writer</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
  106         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintError</span><span class="p">(</span><span class="s2">&quot;Failed to setup a writer for output fie </span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Outfile&quot;</span><span class="p">])</span>
  107     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;Generating file </span><span class="si">%s</span><span class="s2">...&quot;</span> <span class="o">%</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Outfile&quot;</span><span class="p">])</span>
  108 
  109     <span class="n">MolCount</span><span class="p">,</span> <span class="n">ValidMolCount</span><span class="p">,</span> <span class="n">CoreScaffoldMissingCount</span><span class="p">,</span> <span class="n">ConfGenFailedCount</span> <span class="o">=</span> <span class="n">ProcessMolecules</span><span class="p">(</span><span class="n">RefMol</span><span class="p">,</span> <span class="n">Mols</span><span class="p">,</span> <span class="n">Writer</span><span class="p">)</span>
  110 
  111     <span class="k">if</span> <span class="n">Writer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
  112         <span class="n">Writer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
  113     
  114     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Total number of molecules: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">MolCount</span><span class="p">)</span>
  115     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;Number of valid molecules: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">ValidMolCount</span><span class="p">)</span>
  116     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;Number of molecules with missing core scaffold: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">CoreScaffoldMissingCount</span><span class="p">)</span>
  117     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;Number of molecules failed during conformation generation or minimization: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">ConfGenFailedCount</span><span class="p">)</span>
  118     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;Number of ignored molecules: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">MolCount</span> <span class="o">-</span> <span class="n">ValidMolCount</span> <span class="o">+</span> <span class="n">CoreScaffoldMissingCount</span> <span class="o">+</span> <span class="n">ConfGenFailedCount</span><span class="p">))</span>
  119 
  120 <span class="k">def</span> <span class="nf">ProcessMolecules</span><span class="p">(</span><span class="n">RefMol</span><span class="p">,</span> <span class="n">Mols</span><span class="p">,</span> <span class="n">Writer</span><span class="p">):</span>
  121     <span class="sd">&quot;&quot;&quot;Process molecules to generate constrained conformers.&quot;&quot;&quot;</span>
  122     
  123     <span class="k">if</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;MPMode&quot;</span><span class="p">]:</span>
  124         <span class="k">return</span> <span class="n">ProcessMoleculesUsingMultipleProcesses</span><span class="p">(</span><span class="n">RefMol</span><span class="p">,</span> <span class="n">Mols</span><span class="p">,</span> <span class="n">Writer</span><span class="p">)</span>
  125     <span class="k">else</span><span class="p">:</span>
  126         <span class="k">return</span> <span class="n">ProcessMoleculesUsingSingleProcess</span><span class="p">(</span><span class="n">RefMol</span><span class="p">,</span> <span class="n">Mols</span><span class="p">,</span> <span class="n">Writer</span><span class="p">)</span>
  127 
  128 <span class="k">def</span> <span class="nf">ProcessMoleculesUsingSingleProcess</span><span class="p">(</span><span class="n">RefMol</span><span class="p">,</span> <span class="n">Mols</span><span class="p">,</span> <span class="n">Writer</span><span class="p">):</span>
  129     <span class="sd">&quot;&quot;&quot;Process molecules to generate constrained conformers using a single process.&quot;&quot;&quot;</span>
  130 
  131     <span class="c1"># Intialize Psi4...</span>
  132     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Initializing Psi4...&quot;</span><span class="p">)</span>
  133     <span class="n">Psi4Handle</span> <span class="o">=</span> <span class="n">Psi4Util</span><span class="o">.</span><span class="n">InitializePsi4</span><span class="p">(</span><span class="n">Psi4RunParams</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Psi4RunParams&quot;</span><span class="p">],</span> <span class="n">Psi4OptionsParams</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Psi4OptionsParams&quot;</span><span class="p">],</span> <span class="n">PrintVersion</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">PrintHeader</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
  134     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;psi4&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Psi4Handle</span>
  135 
  136     <span class="c1"># Setup max iterations global variable...</span>
  137     <span class="n">Psi4Util</span><span class="o">.</span><span class="n">UpdatePsi4OptionsParameters</span><span class="p">(</span><span class="n">Psi4Handle</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;GEOM_MAXITER&#39;</span><span class="p">:</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;MaxIters&quot;</span><span class="p">]})</span>
  138     
  139     <span class="c1"># Setup conversion factor for energy units...</span>
  140     <span class="n">SetupEnergyConversionFactor</span><span class="p">(</span><span class="n">Psi4Handle</span><span class="p">)</span>
  141     
  142     <span class="p">(</span><span class="n">MolCount</span><span class="p">,</span> <span class="n">ValidMolCount</span><span class="p">,</span> <span class="n">CoreScaffoldMissingCount</span><span class="p">,</span> <span class="n">ConfGenFailedCount</span><span class="p">)</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">4</span>
  143     
  144     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Generating constrained conformers and performing energy minimization...&quot;</span><span class="p">)</span>
  145     
  146     <span class="k">for</span> <span class="n">Mol</span> <span class="ow">in</span> <span class="n">Mols</span><span class="p">:</span>
  147         <span class="n">MolCount</span> <span class="o">+=</span> <span class="mi">1</span>
  148 
  149         <span class="k">if</span> <span class="ow">not</span> <span class="n">CheckAndValidateMolecule</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolCount</span><span class="p">):</span>
  150             <span class="k">continue</span>
  151 
  152         <span class="c1"># Setup 2D coordinates for SMILES input file...</span>
  153         <span class="k">if</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;SMILESInfileStatus&quot;</span><span class="p">]:</span>
  154             <span class="n">AllChem</span><span class="o">.</span><span class="n">Compute2DCoords</span><span class="p">(</span><span class="n">Mol</span><span class="p">)</span>
  155         
  156         <span class="n">ValidMolCount</span> <span class="o">+=</span> <span class="mi">1</span>
  157         
  158         <span class="c1"># Setup a reference molecule core containing common scaffold atoms...</span>
  159         <span class="n">RefMolCore</span> <span class="o">=</span> <span class="n">SetupCoreScaffold</span><span class="p">(</span><span class="n">RefMol</span><span class="p">,</span> <span class="n">Mol</span><span class="p">,</span> <span class="n">MolCount</span><span class="p">)</span>
  160         <span class="k">if</span> <span class="n">RefMolCore</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
  161             <span class="n">CoreScaffoldMissingCount</span> <span class="o">+=</span> <span class="mi">1</span>
  162             <span class="k">continue</span>
  163 
  164         <span class="n">ConfMols</span><span class="p">,</span> <span class="n">CalcStatus</span><span class="p">,</span> <span class="n">ConfIDs</span><span class="p">,</span> <span class="n">ConfEnergyValues</span><span class="p">,</span> <span class="n">ConfScaffoldEmbedRMSDValues</span> <span class="o">=</span> <span class="n">GenerateMolConformers</span><span class="p">(</span><span class="n">Psi4Handle</span><span class="p">,</span> <span class="n">Mol</span><span class="p">,</span> <span class="n">RefMolCore</span><span class="p">,</span> <span class="n">MolCount</span><span class="p">)</span>
  165         
  166         <span class="k">if</span> <span class="ow">not</span> <span class="n">CalcStatus</span><span class="p">:</span>
  167             <span class="n">ConfGenFailedCount</span> <span class="o">+=</span> <span class="mi">1</span>
  168             <span class="k">continue</span>
  169 
  170         <span class="n">WriteMolConformers</span><span class="p">(</span><span class="n">Writer</span><span class="p">,</span> <span class="n">Mol</span><span class="p">,</span> <span class="n">MolCount</span><span class="p">,</span> <span class="n">ConfMols</span><span class="p">,</span> <span class="n">ConfIDs</span><span class="p">,</span> <span class="n">ConfEnergyValues</span><span class="p">,</span> <span class="n">ConfScaffoldEmbedRMSDValues</span><span class="p">)</span>
  171         
  172     <span class="k">return</span> <span class="p">(</span><span class="n">MolCount</span><span class="p">,</span> <span class="n">ValidMolCount</span><span class="p">,</span> <span class="n">CoreScaffoldMissingCount</span><span class="p">,</span> <span class="n">ConfGenFailedCount</span><span class="p">)</span>
  173 
  174 <span class="k">def</span> <span class="nf">ProcessMoleculesUsingMultipleProcesses</span><span class="p">(</span><span class="n">RefMol</span><span class="p">,</span> <span class="n">Mols</span><span class="p">,</span> <span class="n">Writer</span><span class="p">):</span>
  175     <span class="sd">&quot;&quot;&quot;Process molecules to generate constrained conformers using multiprocessing.&quot;&quot;&quot;</span>
  176     
  177     <span class="k">if</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;MPLevelConformersMode&quot;</span><span class="p">]:</span>
  178         <span class="k">return</span> <span class="n">ProcessMoleculesUsingMultipleProcessesAtConformersLevel</span><span class="p">(</span><span class="n">RefMol</span><span class="p">,</span> <span class="n">Mols</span><span class="p">,</span> <span class="n">Writer</span><span class="p">)</span>
  179     <span class="k">elif</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;MPLevelMoleculesMode&quot;</span><span class="p">]:</span>
  180         <span class="k">return</span> <span class="n">ProcessMoleculesUsingMultipleProcessesAtMoleculesLevel</span><span class="p">(</span><span class="n">RefMol</span><span class="p">,</span> <span class="n">Mols</span><span class="p">,</span> <span class="n">Writer</span><span class="p">)</span>
  181     <span class="k">else</span><span class="p">:</span>
  182         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintError</span><span class="p">(</span><span class="s2">&quot;The value, </span><span class="si">%s</span><span class="s2">,  option </span><span class="se">\&quot;</span><span class="s2">--mpLevel</span><span class="se">\&quot;</span><span class="s2"> is not supported.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;MPLevel&quot;</span><span class="p">]))</span>
  183         
  184 <span class="k">def</span> <span class="nf">ProcessMoleculesUsingMultipleProcessesAtMoleculesLevel</span><span class="p">(</span><span class="n">RefMol</span><span class="p">,</span> <span class="n">Mols</span><span class="p">,</span> <span class="n">Writer</span><span class="p">):</span>
  185     <span class="sd">&quot;&quot;&quot;Process molecules to generate constrained conformers using multiprocessing at molecules level.&quot;&quot;&quot;</span>
  186 
  187     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Generating constrained conformers and performing energy minimization using multiprocessing at molecules level...&quot;</span><span class="p">)</span>
  188     
  189     <span class="n">MPParams</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;MPParams&quot;</span><span class="p">]</span>
  190     
  191     <span class="c1"># Setup data for initializing a worker process...</span>
  192     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;EncodedRefMol&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">MolToBase64EncodedMolString</span><span class="p">(</span><span class="n">RefMol</span><span class="p">)</span>
  193     <span class="n">InitializeWorkerProcessArgs</span> <span class="o">=</span> <span class="p">(</span><span class="n">MiscUtil</span><span class="o">.</span><span class="n">ObjectToBase64EncodedString</span><span class="p">(</span><span class="n">Options</span><span class="p">),</span> <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ObjectToBase64EncodedString</span><span class="p">(</span><span class="n">OptionsInfo</span><span class="p">))</span>
  194     
  195     <span class="c1"># Setup a encoded mols data iterable for a worker process...</span>
  196     <span class="n">WorkerProcessDataIterable</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">GenerateBase64EncodedMolStrings</span><span class="p">(</span><span class="n">Mols</span><span class="p">)</span>
  197     
  198     <span class="c1"># Setup process pool along with data initialization for each process...</span>
  199     <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]:</span>
  200         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Configuring multiprocessing using </span><span class="si">%s</span><span class="s2"> method...&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s2">&quot;mp.Pool.imap()&quot;</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^Lazy$&quot;</span><span class="p">,</span> <span class="n">MPParams</span><span class="p">[</span><span class="s2">&quot;InputDataMode&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;mp.Pool.map()&quot;</span><span class="p">))</span>
  201         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;NumProcesses: </span><span class="si">%s</span><span class="s2">; InputDataMode: </span><span class="si">%s</span><span class="s2">; ChunkSize: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">MPParams</span><span class="p">[</span><span class="s2">&quot;NumProcesses&quot;</span><span class="p">],</span> <span class="n">MPParams</span><span class="p">[</span><span class="s2">&quot;InputDataMode&quot;</span><span class="p">],</span> <span class="p">(</span><span class="s2">&quot;automatic&quot;</span> <span class="k">if</span> <span class="n">MPParams</span><span class="p">[</span><span class="s2">&quot;ChunkSize&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">MPParams</span><span class="p">[</span><span class="s2">&quot;ChunkSize&quot;</span><span class="p">])))</span>
  202     
  203     <span class="n">ProcessPool</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">MPParams</span><span class="p">[</span><span class="s2">&quot;NumProcesses&quot;</span><span class="p">],</span> <span class="n">InitializeWorkerProcess</span><span class="p">,</span> <span class="n">InitializeWorkerProcessArgs</span><span class="p">)</span>
  204     
  205     <span class="c1"># Start processing...</span>
  206     <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^Lazy$&quot;</span><span class="p">,</span> <span class="n">MPParams</span><span class="p">[</span><span class="s2">&quot;InputDataMode&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
  207         <span class="n">Results</span> <span class="o">=</span> <span class="n">ProcessPool</span><span class="o">.</span><span class="n">imap</span><span class="p">(</span><span class="n">WorkerProcess</span><span class="p">,</span> <span class="n">WorkerProcessDataIterable</span><span class="p">,</span> <span class="n">MPParams</span><span class="p">[</span><span class="s2">&quot;ChunkSize&quot;</span><span class="p">])</span>
  208     <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^InMemory$&quot;</span><span class="p">,</span> <span class="n">MPParams</span><span class="p">[</span><span class="s2">&quot;InputDataMode&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
  209         <span class="n">Results</span> <span class="o">=</span> <span class="n">ProcessPool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">WorkerProcess</span><span class="p">,</span> <span class="n">WorkerProcessDataIterable</span><span class="p">,</span> <span class="n">MPParams</span><span class="p">[</span><span class="s2">&quot;ChunkSize&quot;</span><span class="p">])</span>
  210     <span class="k">else</span><span class="p">:</span>
  211         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintError</span><span class="p">(</span><span class="s2">&quot;The value, </span><span class="si">%s</span><span class="s2">, specified for </span><span class="se">\&quot;</span><span class="s2">--inputDataMode</span><span class="se">\&quot;</span><span class="s2"> is not supported.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">MPParams</span><span class="p">[</span><span class="s2">&quot;InputDataMode&quot;</span><span class="p">]))</span>
  212     
  213     <span class="c1"># Print out Psi4 version in the main process...</span>
  214     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Initializing Psi4...</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
  215     <span class="n">Psi4Handle</span>  <span class="o">=</span> <span class="n">Psi4Util</span><span class="o">.</span><span class="n">InitializePsi4</span><span class="p">(</span><span class="n">PrintVersion</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">PrintHeader</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span>
  216     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;psi4&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Psi4Handle</span>
  217 
  218     <span class="p">(</span><span class="n">MolCount</span><span class="p">,</span> <span class="n">ValidMolCount</span><span class="p">,</span> <span class="n">CoreScaffoldMissingCount</span><span class="p">,</span> <span class="n">ConfGenFailedCount</span><span class="p">)</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">4</span>
  219     
  220     <span class="k">for</span> <span class="n">Result</span> <span class="ow">in</span> <span class="n">Results</span><span class="p">:</span>
  221         <span class="n">MolCount</span> <span class="o">+=</span> <span class="mi">1</span>
  222         <span class="n">MolIndex</span><span class="p">,</span> <span class="n">EncodedMol</span><span class="p">,</span> <span class="n">EncodedConfMols</span><span class="p">,</span> <span class="n">CoreScaffoldMissingStatus</span><span class="p">,</span> <span class="n">CalcStatus</span><span class="p">,</span> <span class="n">ConfIDs</span><span class="p">,</span> <span class="n">ConfEnergyValues</span><span class="p">,</span> <span class="n">ConfScaffoldEmbedRMSDValues</span>  <span class="o">=</span> <span class="n">Result</span>
  223     
  224         <span class="k">if</span> <span class="n">EncodedMol</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
  225             <span class="k">continue</span>
  226         <span class="n">ValidMolCount</span> <span class="o">+=</span> <span class="mi">1</span>
  227 
  228         <span class="k">if</span> <span class="n">CoreScaffoldMissingStatus</span><span class="p">:</span>
  229             <span class="n">CoreScaffoldMissingCount</span> <span class="o">+=</span> <span class="mi">1</span>
  230             <span class="k">continue</span>
  231         
  232         <span class="k">if</span> <span class="ow">not</span> <span class="n">CalcStatus</span><span class="p">:</span>
  233             <span class="n">ConfGenFailedCount</span> <span class="o">+=</span> <span class="mi">1</span>
  234             <span class="k">continue</span>
  235 
  236         <span class="n">Mol</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">MolFromBase64EncodedMolString</span><span class="p">(</span><span class="n">EncodedMol</span><span class="p">)</span>
  237         <span class="n">ConfMols</span> <span class="o">=</span> <span class="p">[</span><span class="n">RDKitUtil</span><span class="o">.</span><span class="n">MolFromBase64EncodedMolString</span><span class="p">(</span><span class="n">EncodedConfMol</span><span class="p">)</span> <span class="k">for</span> <span class="n">EncodedConfMol</span> <span class="ow">in</span> <span class="n">EncodedConfMols</span><span class="p">]</span>
  238         
  239         <span class="n">WriteMolConformers</span><span class="p">(</span><span class="n">Writer</span><span class="p">,</span> <span class="n">Mol</span><span class="p">,</span> <span class="n">MolCount</span><span class="p">,</span> <span class="n">ConfMols</span><span class="p">,</span> <span class="n">ConfIDs</span><span class="p">,</span> <span class="n">ConfEnergyValues</span><span class="p">,</span> <span class="n">ConfScaffoldEmbedRMSDValues</span><span class="p">)</span>
  240     
  241     <span class="k">return</span> <span class="p">(</span><span class="n">MolCount</span><span class="p">,</span> <span class="n">ValidMolCount</span><span class="p">,</span> <span class="n">CoreScaffoldMissingCount</span><span class="p">,</span> <span class="n">ConfGenFailedCount</span><span class="p">)</span>
  242 
  243 <span class="k">def</span> <span class="nf">InitializeWorkerProcess</span><span class="p">(</span><span class="o">*</span><span class="n">EncodedArgs</span><span class="p">):</span>
  244     <span class="sd">&quot;&quot;&quot;Initialize data for a worker process.&quot;&quot;&quot;</span>
  245     
  246     <span class="k">global</span> <span class="n">Options</span><span class="p">,</span> <span class="n">OptionsInfo</span>
  247 
  248     <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]:</span>
  249         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;Starting process (PID: </span><span class="si">%s</span><span class="s2">)...&quot;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">())</span>
  250     
  251     <span class="c1"># Decode Options and OptionInfo...</span>
  252     <span class="n">Options</span> <span class="o">=</span> <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ObjectFromBase64EncodedString</span><span class="p">(</span><span class="n">EncodedArgs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
  253     <span class="n">OptionsInfo</span> <span class="o">=</span> <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ObjectFromBase64EncodedString</span><span class="p">(</span><span class="n">EncodedArgs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
  254     
  255     <span class="c1"># Decode RefMol...</span>
  256     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;RefMol&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">MolFromBase64EncodedMolString</span><span class="p">(</span><span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;EncodedRefMol&quot;</span><span class="p">])</span>
  257     
  258     <span class="c1"># Psi4 is initialized in the worker process to avoid creation of redundant Psi4</span>
  259     <span class="c1"># output files for each process...</span>
  260     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Psi4Initialized&quot;</span><span class="p">]</span>  <span class="o">=</span> <span class="bp">False</span>
  261 
  262 <span class="k">def</span> <span class="nf">WorkerProcess</span><span class="p">(</span><span class="n">EncodedMolInfo</span><span class="p">):</span>
  263     <span class="sd">&quot;&quot;&quot;Process data for a worker process.&quot;&quot;&quot;</span>
  264 
  265     <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Psi4Initialized&quot;</span><span class="p">]:</span>
  266         <span class="n">InitializePsi4ForWorkerProcess</span><span class="p">()</span>
  267     
  268     <span class="n">MolIndex</span><span class="p">,</span> <span class="n">EncodedMol</span> <span class="o">=</span> <span class="n">EncodedMolInfo</span>
  269     
  270     <span class="n">MolNum</span> <span class="o">=</span> <span class="n">MolIndex</span> <span class="o">+</span> <span class="mi">1</span>
  271     <span class="n">ConfMols</span> <span class="o">=</span> <span class="bp">None</span>
  272     <span class="n">CoreScaffoldMissingStatus</span> <span class="o">=</span> <span class="bp">False</span>
  273     <span class="n">CalcStatus</span> <span class="o">=</span> <span class="bp">False</span>
  274     <span class="n">ConfIDs</span> <span class="o">=</span> <span class="bp">None</span>
  275     <span class="n">ConfEnergyValues</span> <span class="o">=</span> <span class="bp">None</span>
  276     <span class="n">ConfScaffoldEmbedRMSDValues</span> <span class="o">=</span> <span class="bp">None</span>
  277     
  278     <span class="k">if</span> <span class="n">EncodedMol</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
  279         <span class="k">return</span> <span class="p">[</span><span class="n">MolIndex</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">ConfMols</span><span class="p">,</span> <span class="n">CoreScaffoldMissingStatus</span><span class="p">,</span> <span class="n">CalcStatus</span><span class="p">,</span> <span class="n">ConfIDs</span><span class="p">,</span> <span class="n">ConfEnergyValues</span><span class="p">,</span> <span class="n">ConfScaffoldEmbedRMSDValues</span><span class="p">]</span>
  280     
  281     <span class="n">Mol</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">MolFromBase64EncodedMolString</span><span class="p">(</span><span class="n">EncodedMol</span><span class="p">)</span>
  282     <span class="k">if</span> <span class="ow">not</span> <span class="n">CheckAndValidateMolecule</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">):</span>
  283         <span class="k">return</span> <span class="p">[</span><span class="n">MolIndex</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">ConfMols</span><span class="p">,</span> <span class="n">CoreScaffoldMissingStatus</span><span class="p">,</span> <span class="n">CalcStatus</span><span class="p">,</span> <span class="n">ConfIDs</span><span class="p">,</span> <span class="n">ConfEnergyValues</span><span class="p">,</span> <span class="n">ConfScaffoldEmbedRMSDValues</span><span class="p">]</span>
  284     
  285     <span class="c1"># Setup 2D coordinates for SMILES input file...</span>
  286     <span class="k">if</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;SMILESInfileStatus&quot;</span><span class="p">]:</span>
  287         <span class="n">AllChem</span><span class="o">.</span><span class="n">Compute2DCoords</span><span class="p">(</span><span class="n">Mol</span><span class="p">)</span>
  288         
  289     <span class="c1"># Setup a reference molecule core containing common scaffold atoms...</span>
  290     <span class="n">RefMolCore</span> <span class="o">=</span> <span class="n">SetupCoreScaffold</span><span class="p">(</span><span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;RefMol&quot;</span><span class="p">],</span> <span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">)</span>
  291     <span class="k">if</span> <span class="n">RefMolCore</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
  292         <span class="n">CoreScaffoldMissingStatus</span> <span class="o">=</span> <span class="bp">True</span>
  293         <span class="k">return</span> <span class="p">[</span><span class="n">MolIndex</span><span class="p">,</span> <span class="n">EncodedMol</span><span class="p">,</span> <span class="n">ConfMols</span><span class="p">,</span> <span class="n">CoreScaffoldMissingStatus</span><span class="p">,</span> <span class="n">CalcStatus</span><span class="p">,</span> <span class="n">ConfIDs</span><span class="p">,</span> <span class="n">ConfEnergyValues</span><span class="p">,</span> <span class="n">ConfScaffoldEmbedRMSDValues</span><span class="p">]</span>
  294 
  295     <span class="c1"># Generate conformers...</span>
  296     <span class="n">ConfMols</span><span class="p">,</span> <span class="n">CalcStatus</span><span class="p">,</span> <span class="n">ConfIDs</span><span class="p">,</span> <span class="n">ConfEnergyValues</span><span class="p">,</span> <span class="n">ConfScaffoldEmbedRMSDValues</span> <span class="o">=</span> <span class="n">GenerateMolConformers</span><span class="p">(</span><span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;psi4&quot;</span><span class="p">],</span> <span class="n">Mol</span><span class="p">,</span> <span class="n">RefMolCore</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">)</span>
  297     
  298     <span class="n">EncodedConfMols</span> <span class="o">=</span> <span class="bp">None</span>
  299     <span class="k">if</span> <span class="n">ConfMols</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
  300         <span class="n">EncodedConfMols</span> <span class="o">=</span> <span class="p">[</span><span class="n">RDKitUtil</span><span class="o">.</span><span class="n">MolToBase64EncodedMolString</span><span class="p">(</span><span class="n">ConfMol</span><span class="p">,</span> <span class="n">PropertyPickleFlags</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">PropertyPickleOptions</span><span class="o">.</span><span class="n">MolProps</span> <span class="o">|</span> <span class="n">Chem</span><span class="o">.</span><span class="n">PropertyPickleOptions</span><span class="o">.</span><span class="n">PrivateProps</span><span class="p">)</span> <span class="k">for</span> <span class="n">ConfMol</span> <span class="ow">in</span> <span class="n">ConfMols</span><span class="p">]</span>
  301         
  302     <span class="k">return</span> <span class="p">[</span><span class="n">MolIndex</span><span class="p">,</span> <span class="n">EncodedMol</span><span class="p">,</span> <span class="n">EncodedConfMols</span><span class="p">,</span> <span class="n">CoreScaffoldMissingStatus</span><span class="p">,</span> <span class="n">CalcStatus</span><span class="p">,</span> <span class="n">ConfIDs</span><span class="p">,</span> <span class="n">ConfEnergyValues</span><span class="p">,</span> <span class="n">ConfScaffoldEmbedRMSDValues</span><span class="p">]</span>
  303     
  304 <span class="k">def</span> <span class="nf">ProcessMoleculesUsingMultipleProcessesAtConformersLevel</span><span class="p">(</span><span class="n">RefMol</span><span class="p">,</span> <span class="n">Mols</span><span class="p">,</span> <span class="n">Writer</span><span class="p">):</span>
  305     <span class="sd">&quot;&quot;&quot;Process and minimize molecules using multiprocessing at conformers level.&quot;&quot;&quot;</span>
  306 
  307     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Performing constrained minimization with generation of conformers using multiprocessing at conformers level...&quot;</span><span class="p">)</span>
  308     
  309     <span class="p">(</span><span class="n">MolCount</span><span class="p">,</span> <span class="n">ValidMolCount</span><span class="p">,</span> <span class="n">CoreScaffoldMissingCount</span><span class="p">,</span> <span class="n">ConfGenFailedCount</span><span class="p">)</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">4</span>
  310     
  311     <span class="k">for</span> <span class="n">Mol</span> <span class="ow">in</span> <span class="n">Mols</span><span class="p">:</span>
  312         <span class="n">MolCount</span> <span class="o">+=</span> <span class="mi">1</span>
  313 
  314         <span class="k">if</span> <span class="ow">not</span> <span class="n">CheckAndValidateMolecule</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolCount</span><span class="p">):</span>
  315             <span class="k">continue</span>
  316 
  317         <span class="c1"># Setup 2D coordinates for SMILES input file...</span>
  318         <span class="k">if</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;SMILESInfileStatus&quot;</span><span class="p">]:</span>
  319             <span class="n">AllChem</span><span class="o">.</span><span class="n">Compute2DCoords</span><span class="p">(</span><span class="n">Mol</span><span class="p">)</span>
  320         
  321         <span class="n">ValidMolCount</span> <span class="o">+=</span> <span class="mi">1</span>
  322         
  323         <span class="c1"># Setup a reference molecule core containing common scaffold atoms...</span>
  324         <span class="n">RefMolCore</span> <span class="o">=</span> <span class="n">SetupCoreScaffold</span><span class="p">(</span><span class="n">RefMol</span><span class="p">,</span> <span class="n">Mol</span><span class="p">,</span> <span class="n">MolCount</span><span class="p">)</span>
  325         <span class="k">if</span> <span class="n">RefMolCore</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
  326             <span class="n">CoreScaffoldMissingCount</span> <span class="o">+=</span> <span class="mi">1</span>
  327             <span class="k">continue</span>
  328 
  329         <span class="n">ConfMols</span><span class="p">,</span> <span class="n">CalcStatus</span><span class="p">,</span> <span class="n">ConfIDs</span><span class="p">,</span> <span class="n">ConfEnergyValues</span><span class="p">,</span> <span class="n">ConfScaffoldEmbedRMSDValues</span> <span class="o">=</span> <span class="n">ProcessConformersUsingMultipleProcesses</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">RefMolCore</span><span class="p">,</span> <span class="n">MolCount</span><span class="p">)</span>
  330         
  331         <span class="k">if</span> <span class="ow">not</span> <span class="n">CalcStatus</span><span class="p">:</span>
  332             <span class="n">ConfGenFailedCount</span> <span class="o">+=</span> <span class="mi">1</span>
  333             <span class="k">continue</span>
  334 
  335         <span class="n">WriteMolConformers</span><span class="p">(</span><span class="n">Writer</span><span class="p">,</span> <span class="n">Mol</span><span class="p">,</span> <span class="n">MolCount</span><span class="p">,</span> <span class="n">ConfMols</span><span class="p">,</span> <span class="n">ConfIDs</span><span class="p">,</span> <span class="n">ConfEnergyValues</span><span class="p">,</span> <span class="n">ConfScaffoldEmbedRMSDValues</span><span class="p">)</span>
  336         
  337     <span class="k">return</span> <span class="p">(</span><span class="n">MolCount</span><span class="p">,</span> <span class="n">ValidMolCount</span><span class="p">,</span> <span class="n">CoreScaffoldMissingCount</span><span class="p">,</span> <span class="n">ConfGenFailedCount</span><span class="p">)</span>
  338 
  339 <span class="k">def</span> <span class="nf">ProcessConformersUsingMultipleProcesses</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">RefMolCore</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">):</span>
  340     <span class="sd">&quot;&quot;&quot;Generate constrained conformers and minimize them using multiple processes.&quot;&quot;&quot;</span>
  341     
  342     <span class="c1"># Add hydrogens...</span>
  343     <span class="n">Mol</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">AddHs</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">addCoords</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
  344 
  345     <span class="n">MolName</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">GetMolName</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">)</span>
  346     
  347     <span class="c1"># Setup constrained conformers...</span>
  348     <span class="n">MolConfs</span><span class="p">,</span> <span class="n">MolConfsStatus</span><span class="p">,</span> <span class="n">MolConfIDs</span> <span class="o">=</span> <span class="n">ConstrainEmbedAndMinimizeMoleculeUsingRDKit</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">RefMolCore</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">)</span>
  349     <span class="k">if</span> <span class="ow">not</span> <span class="n">MolConfsStatus</span><span class="p">:</span>
  350         <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]:</span>
  351             <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintWarning</span><span class="p">(</span><span class="s2">&quot;Conformation generation couldn&#39;t be performed for molecule </span><span class="si">%s</span><span class="s2">: Constrained embedding failed...</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">MolName</span><span class="p">)</span>
  352         <span class="k">return</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
  353     
  354     <span class="n">MPParams</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;MPParams&quot;</span><span class="p">]</span>
  355 
  356     <span class="c1"># Setup data for initializing a worker process...</span>
  357     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;EncodedRefMolCore&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">MolToBase64EncodedMolString</span><span class="p">(</span><span class="n">RefMolCore</span><span class="p">)</span>
  358     <span class="n">InitializeWorkerProcessArgs</span> <span class="o">=</span> <span class="p">(</span><span class="n">MiscUtil</span><span class="o">.</span><span class="n">ObjectToBase64EncodedString</span><span class="p">(</span><span class="n">Options</span><span class="p">),</span> <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ObjectToBase64EncodedString</span><span class="p">(</span><span class="n">OptionsInfo</span><span class="p">))</span>
  359 
  360     <span class="c1"># Setup a encoded mols data iterable for a worker process...</span>
  361     <span class="n">WorkerProcessDataIterable</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">GenerateBase64EncodedMolStringsWithIDs</span><span class="p">(</span><span class="n">MolConfs</span><span class="p">,</span> <span class="n">MolConfIDs</span><span class="p">)</span>
  362     
  363     <span class="c1"># Setup process pool along with data initialization for each process...</span>
  364     <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]:</span>
  365         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Configuring multiprocessing using </span><span class="si">%s</span><span class="s2"> method...&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s2">&quot;mp.Pool.imap()&quot;</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^Lazy$&quot;</span><span class="p">,</span> <span class="n">MPParams</span><span class="p">[</span><span class="s2">&quot;InputDataMode&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;mp.Pool.map()&quot;</span><span class="p">))</span>
  366         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;NumProcesses: </span><span class="si">%s</span><span class="s2">; InputDataMode: </span><span class="si">%s</span><span class="s2">; ChunkSize: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">MPParams</span><span class="p">[</span><span class="s2">&quot;NumProcesses&quot;</span><span class="p">],</span> <span class="n">MPParams</span><span class="p">[</span><span class="s2">&quot;InputDataMode&quot;</span><span class="p">],</span> <span class="p">(</span><span class="s2">&quot;automatic&quot;</span> <span class="k">if</span> <span class="n">MPParams</span><span class="p">[</span><span class="s2">&quot;ChunkSize&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">MPParams</span><span class="p">[</span><span class="s2">&quot;ChunkSize&quot;</span><span class="p">])))</span>
  367     
  368     <span class="n">ProcessPool</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">MPParams</span><span class="p">[</span><span class="s2">&quot;NumProcesses&quot;</span><span class="p">],</span> <span class="n">InitializeConformerWorkerProcess</span><span class="p">,</span> <span class="n">InitializeWorkerProcessArgs</span><span class="p">)</span>
  369     
  370     <span class="c1"># Start processing...</span>
  371     <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^Lazy$&quot;</span><span class="p">,</span> <span class="n">MPParams</span><span class="p">[</span><span class="s2">&quot;InputDataMode&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
  372         <span class="n">Results</span> <span class="o">=</span> <span class="n">ProcessPool</span><span class="o">.</span><span class="n">imap</span><span class="p">(</span><span class="n">ConformerWorkerProcess</span><span class="p">,</span> <span class="n">WorkerProcessDataIterable</span><span class="p">,</span> <span class="n">MPParams</span><span class="p">[</span><span class="s2">&quot;ChunkSize&quot;</span><span class="p">])</span>
  373     <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^InMemory$&quot;</span><span class="p">,</span> <span class="n">MPParams</span><span class="p">[</span><span class="s2">&quot;InputDataMode&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
  374         <span class="n">Results</span> <span class="o">=</span> <span class="n">ProcessPool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">ConformerWorkerProcess</span><span class="p">,</span> <span class="n">WorkerProcessDataIterable</span><span class="p">,</span> <span class="n">MPParams</span><span class="p">[</span><span class="s2">&quot;ChunkSize&quot;</span><span class="p">])</span>
  375     <span class="k">else</span><span class="p">:</span>
  376         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintError</span><span class="p">(</span><span class="s2">&quot;The value, </span><span class="si">%s</span><span class="s2">, specified for </span><span class="se">\&quot;</span><span class="s2">--inputDataMode</span><span class="se">\&quot;</span><span class="s2"> is not supported.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">MPParams</span><span class="p">[</span><span class="s2">&quot;InputDataMode&quot;</span><span class="p">]))</span>
  377 
  378     <span class="n">MolConfIDs</span> <span class="o">=</span> <span class="p">[]</span>
  379     <span class="n">MolConfs</span> <span class="o">=</span> <span class="p">[]</span>
  380     <span class="n">CalcEnergyMap</span> <span class="o">=</span> <span class="p">{}</span>
  381     <span class="n">ScaffoldEmbedRMSDMap</span> <span class="o">=</span> <span class="p">{}</span>
  382     <span class="n">CalcFailedCount</span> <span class="o">=</span> <span class="mi">0</span>
  383     
  384     <span class="k">for</span> <span class="n">Result</span> <span class="ow">in</span> <span class="n">Results</span><span class="p">:</span>
  385         <span class="n">ConfID</span><span class="p">,</span> <span class="n">EncodedMolConf</span><span class="p">,</span> <span class="n">CalcStatus</span><span class="p">,</span> <span class="n">Energy</span><span class="p">,</span> <span class="n">ScaffoldEmbedRMSD</span> <span class="o">=</span> <span class="n">Result</span>
  386 
  387         <span class="k">if</span> <span class="n">EncodedMolConf</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
  388             <span class="n">CalcFailedCount</span> <span class="o">+=</span> <span class="mi">1</span>
  389             <span class="k">continue</span>
  390         
  391         <span class="k">if</span> <span class="ow">not</span> <span class="n">CalcStatus</span><span class="p">:</span>
  392             <span class="n">CalcFailedCount</span> <span class="o">+=</span> <span class="mi">1</span>
  393             <span class="k">continue</span>
  394         
  395         <span class="n">MolConf</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">MolFromBase64EncodedMolString</span><span class="p">(</span><span class="n">EncodedMolConf</span><span class="p">)</span>
  396         
  397         <span class="n">MolConfIDs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ConfID</span><span class="p">)</span>
  398         <span class="n">MolConfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">MolConf</span><span class="p">)</span>
  399         <span class="n">CalcEnergyMap</span><span class="p">[</span><span class="n">ConfID</span><span class="p">]</span> <span class="o">=</span> <span class="n">Energy</span>
  400         <span class="n">ScaffoldEmbedRMSDMap</span><span class="p">[</span><span class="n">ConfID</span><span class="p">]</span> <span class="o">=</span> <span class="n">ScaffoldEmbedRMSD</span>
  401     
  402     <span class="k">if</span> <span class="n">CalcFailedCount</span><span class="p">:</span>
  403         <span class="k">return</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
  404 
  405     <span class="c1"># Filter conformers...</span>
  406     <span class="n">SelectedMolConfs</span><span class="p">,</span> <span class="n">SelectedMolConfIDs</span><span class="p">,</span> <span class="n">SelectedConfEnergies</span><span class="p">,</span> <span class="n">SelectedConfScaffoldEmbedRMSDValues</span> <span class="o">=</span> <span class="n">FilterMolConformers</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">,</span> <span class="n">MolConfs</span><span class="p">,</span> <span class="n">MolConfIDs</span><span class="p">,</span> <span class="n">CalcEnergyMap</span><span class="p">,</span> <span class="n">ScaffoldEmbedRMSDMap</span><span class="p">)</span>
  407     
  408     <span class="k">return</span> <span class="p">(</span><span class="n">SelectedMolConfs</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="n">SelectedMolConfIDs</span><span class="p">,</span> <span class="n">SelectedConfEnergies</span><span class="p">,</span> <span class="n">SelectedConfScaffoldEmbedRMSDValues</span><span class="p">)</span>
  409 
  410 <span class="k">def</span> <span class="nf">InitializeConformerWorkerProcess</span><span class="p">(</span><span class="o">*</span><span class="n">EncodedArgs</span><span class="p">):</span>
  411     <span class="sd">&quot;&quot;&quot;Initialize data for a conformer worker process.&quot;&quot;&quot;</span>
  412     
  413     <span class="k">global</span> <span class="n">Options</span><span class="p">,</span> <span class="n">OptionsInfo</span>
  414 
  415     <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]:</span>
  416         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;Starting process (PID: </span><span class="si">%s</span><span class="s2">)...&quot;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">())</span>
  417     
  418     <span class="c1"># Decode Options and OptionInfo...</span>
  419     <span class="n">Options</span> <span class="o">=</span> <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ObjectFromBase64EncodedString</span><span class="p">(</span><span class="n">EncodedArgs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
  420     <span class="n">OptionsInfo</span> <span class="o">=</span> <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ObjectFromBase64EncodedString</span><span class="p">(</span><span class="n">EncodedArgs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
  421     
  422     <span class="c1"># Decode RefMol...</span>
  423     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;RefMolCore&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">MolFromBase64EncodedMolString</span><span class="p">(</span><span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;EncodedRefMolCore&quot;</span><span class="p">])</span>
  424     
  425     <span class="c1"># Psi4 is initialized in the worker process to avoid creation of redundant Psi4</span>
  426     <span class="c1"># output files for each process...</span>
  427     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Psi4Initialized&quot;</span><span class="p">]</span>  <span class="o">=</span> <span class="bp">False</span>
  428 
  429 <span class="k">def</span> <span class="nf">ConformerWorkerProcess</span><span class="p">(</span><span class="n">EncodedMolInfo</span><span class="p">):</span>
  430     <span class="sd">&quot;&quot;&quot;Process data for a conformer worker process.&quot;&quot;&quot;</span>
  431 
  432     <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Psi4Initialized&quot;</span><span class="p">]:</span>
  433         <span class="n">InitializePsi4ForWorkerProcess</span><span class="p">()</span>
  434 
  435     <span class="n">MolConfID</span><span class="p">,</span> <span class="n">EncodedMolConf</span> <span class="o">=</span> <span class="n">EncodedMolInfo</span>
  436     
  437     <span class="n">MolConfNum</span> <span class="o">=</span> <span class="n">MolConfID</span>
  438     <span class="n">CalcStatus</span> <span class="o">=</span> <span class="bp">False</span>
  439     <span class="n">Energy</span> <span class="o">=</span> <span class="bp">None</span>
  440     <span class="n">ScaffoldEmbedRMSD</span> <span class="o">=</span> <span class="bp">None</span>
  441     
  442     <span class="k">if</span> <span class="n">EncodedMolConf</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
  443         <span class="k">return</span> <span class="p">[</span><span class="n">MolConfNum</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">CalcStatus</span><span class="p">,</span> <span class="n">Energy</span><span class="p">,</span> <span class="n">ScaffoldEmbedRMSD</span><span class="p">]</span>
  444     
  445     <span class="n">MolConf</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">MolFromBase64EncodedMolString</span><span class="p">(</span><span class="n">EncodedMolConf</span><span class="p">)</span>
  446     <span class="n">MolConfName</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">GetMolName</span><span class="p">(</span><span class="n">MolConf</span><span class="p">,</span> <span class="n">MolConfNum</span><span class="p">)</span>
  447 
  448     <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]:</span>
  449         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;Processing molecule </span><span class="si">%s</span><span class="s2"> conformer number </span><span class="si">%s</span><span class="s2">...&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">MolConfName</span><span class="p">,</span> <span class="n">MolConfNum</span><span class="p">))</span>
  450     
  451     <span class="c1"># Perform Psi4 constrained minimization...</span>
  452     <span class="n">CalcStatus</span><span class="p">,</span> <span class="n">Energy</span> <span class="o">=</span> <span class="n">ConstrainAndMinimizeMoleculeUsingPsi4</span><span class="p">(</span><span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;psi4&quot;</span><span class="p">],</span> <span class="n">MolConf</span><span class="p">,</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;RefMolCore&quot;</span><span class="p">],</span> <span class="n">MolConfNum</span><span class="p">)</span>
  453     <span class="k">if</span> <span class="ow">not</span> <span class="n">CalcStatus</span><span class="p">:</span>
  454         <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]:</span>
  455             <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintWarning</span><span class="p">(</span><span class="s2">&quot;Minimization couldn&#39;t be performed for molecule </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">MolName</span><span class="p">))</span>
  456         <span class="k">return</span> <span class="p">[</span><span class="n">MolConfNum</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">CalcStatus</span><span class="p">,</span> <span class="n">Energy</span><span class="p">,</span> <span class="n">ScaffoldEmbedRMSD</span><span class="p">]</span>
  457 
  458     <span class="k">if</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;ScaffoldRMSDOut&quot;</span><span class="p">]:</span>
  459         <span class="n">ScaffoldEmbedRMSD</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%.4f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">float</span><span class="p">(</span><span class="n">MolConf</span><span class="o">.</span><span class="n">GetProp</span><span class="p">(</span><span class="s1">&#39;EmbedRMS&#39;</span><span class="p">))</span>
  460     <span class="n">MolConf</span><span class="o">.</span><span class="n">ClearProp</span><span class="p">(</span><span class="s1">&#39;EmbedRMS&#39;</span><span class="p">)</span>
  461     
  462     <span class="k">return</span> <span class="p">[</span><span class="n">MolConfNum</span><span class="p">,</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">MolToBase64EncodedMolString</span><span class="p">(</span><span class="n">MolConf</span><span class="p">,</span> <span class="n">PropertyPickleFlags</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">PropertyPickleOptions</span><span class="o">.</span><span class="n">MolProps</span> <span class="o">|</span> <span class="n">Chem</span><span class="o">.</span><span class="n">PropertyPickleOptions</span><span class="o">.</span><span class="n">PrivateProps</span><span class="p">),</span> <span class="n">CalcStatus</span><span class="p">,</span> <span class="n">Energy</span><span class="p">,</span> <span class="n">ScaffoldEmbedRMSD</span><span class="p">]</span>
  463 
  464 <span class="k">def</span> <span class="nf">InitializePsi4ForWorkerProcess</span><span class="p">():</span>
  465     <span class="sd">&quot;&quot;&quot;Initialize Psi4 for a worker process.&quot;&quot;&quot;</span>
  466     
  467     <span class="k">if</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Psi4Initialized&quot;</span><span class="p">]:</span>
  468         <span class="k">return</span>
  469 
  470     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Psi4Initialized&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
  471 
  472     <span class="k">if</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;MPLevelConformersMode&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Psi4RunParams&quot;</span><span class="p">][</span><span class="s2">&quot;OutputFileSpecified&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
  473         <span class="c1"># Run Psi4 in quiet mode during multiprocessing at Conformers level for &#39;auto&#39; OutputFile...</span>
  474         <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Psi4RunParams&quot;</span><span class="p">][</span><span class="s2">&quot;OutputFile&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;quiet&quot;</span>
  475     <span class="k">else</span><span class="p">:</span>
  476         <span class="c1"># Update output file...</span>
  477         <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Psi4RunParams&quot;</span><span class="p">][</span><span class="s2">&quot;OutputFile&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Psi4Util</span><span class="o">.</span><span class="n">UpdatePsi4OutputFileUsingPID</span><span class="p">(</span><span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Psi4RunParams&quot;</span><span class="p">][</span><span class="s2">&quot;OutputFile&quot;</span><span class="p">],</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">())</span>
  478             
  479     <span class="c1"># Intialize Psi4...</span>
  480     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;psi4&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Psi4Util</span><span class="o">.</span><span class="n">InitializePsi4</span><span class="p">(</span><span class="n">Psi4RunParams</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Psi4RunParams&quot;</span><span class="p">],</span> <span class="n">Psi4OptionsParams</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Psi4OptionsParams&quot;</span><span class="p">],</span> <span class="n">PrintVersion</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> <span class="n">PrintHeader</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
  481     
  482     <span class="c1"># Setup max iterations global variable...</span>
  483     <span class="n">Psi4Util</span><span class="o">.</span><span class="n">UpdatePsi4OptionsParameters</span><span class="p">(</span><span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;psi4&quot;</span><span class="p">],</span> <span class="p">{</span><span class="s1">&#39;GEOM_MAXITER&#39;</span><span class="p">:</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;MaxIters&quot;</span><span class="p">]})</span>
  484     
  485     <span class="c1"># Setup conversion factor for energy units...</span>
  486     <span class="n">SetupEnergyConversionFactor</span><span class="p">(</span><span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;psi4&quot;</span><span class="p">])</span>
  487 
  488 <span class="k">def</span> <span class="nf">RetrieveReferenceMolecule</span><span class="p">():</span>
  489     <span class="sd">&quot;&quot;&quot;Retrieve and validate reference molecule.&quot;&quot;&quot;</span>
  490     
  491     <span class="n">RefFile</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;RefFile&quot;</span><span class="p">]</span>
  492     
  493     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Processing file </span><span class="si">%s</span><span class="s2">...&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">RefFile</span><span class="p">))</span>
  494     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;InfileParams&quot;</span><span class="p">][</span><span class="s2">&quot;AllowEmptyMols&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
  495     <span class="n">ValidRefMols</span><span class="p">,</span> <span class="n">RefMolCount</span><span class="p">,</span> <span class="n">ValidRefMolCount</span>  <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">ReadAndValidateMolecules</span><span class="p">(</span><span class="n">RefFile</span><span class="p">,</span> <span class="o">**</span><span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;InfileParams&quot;</span><span class="p">])</span>
  496     
  497     <span class="k">if</span> <span class="n">ValidRefMolCount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
  498         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintError</span><span class="p">(</span><span class="s2">&quot;The reference file, </span><span class="si">%s</span><span class="s2">, contains no valid molecules.&quot;</span> <span class="o">%</span> <span class="n">RefFile</span><span class="p">)</span>
  499     <span class="k">elif</span> <span class="n">ValidRefMolCount</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
  500         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintWarning</span><span class="p">(</span><span class="s2">&quot;The reference file, </span><span class="si">%s</span><span class="s2">, contains, </span><span class="si">%d</span><span class="s2">, valid molecules. Using first molecule as the reference molecule...&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">RefFile</span><span class="p">,</span> <span class="n">ValidRefMolCount</span><span class="p">))</span>
  501     
  502     <span class="n">RefMol</span> <span class="o">=</span> <span class="n">ValidRefMols</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
  503 
  504     <span class="k">if</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;UseScaffoldSMARTS&quot;</span><span class="p">]:</span>
  505         <span class="n">ScaffoldPatternMol</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">MolFromSmarts</span><span class="p">(</span><span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;ScaffoldSMARTS&quot;</span><span class="p">])</span>
  506         <span class="k">if</span> <span class="n">ScaffoldPatternMol</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
  507             <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintError</span><span class="p">(</span><span class="s2">&quot;Failed to create scaffold pattern molecule. The scaffold SMARTS pattern, </span><span class="si">%s</span><span class="s2">, specified using </span><span class="se">\&quot;</span><span class="s2">-s, --scaffold</span><span class="se">\&quot;</span><span class="s2"> option is not valid.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;ScaffoldSMARTS&quot;</span><span class="p">]))</span>
  508         
  509         <span class="k">if</span> <span class="ow">not</span> <span class="n">RefMol</span><span class="o">.</span><span class="n">HasSubstructMatch</span><span class="p">(</span><span class="n">ScaffoldPatternMol</span><span class="p">):</span>
  510             <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintError</span><span class="p">(</span><span class="s2">&quot;The scaffold SMARTS pattern, </span><span class="si">%s</span><span class="s2">, specified using </span><span class="se">\&quot;</span><span class="s2">-s, --scaffold</span><span class="se">\&quot;</span><span class="s2"> option, is missing in the first valid reference molecule.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;ScaffoldSMARTS&quot;</span><span class="p">]))</span>
  511             
  512     <span class="k">return</span> <span class="n">RefMol</span>
  513 
  514 <span class="k">def</span> <span class="nf">SetupCoreScaffold</span><span class="p">(</span><span class="n">RefMol</span><span class="p">,</span> <span class="n">Mol</span><span class="p">,</span> <span class="n">MolCount</span><span class="p">):</span>
  515     <span class="sd">&quot;&quot;&quot;Setup a reference molecule core containing common scaffold atoms between</span>
  516 <span class="sd">    a pair of molecules.&quot;&quot;&quot;</span>
  517 
  518     <span class="k">if</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;UseScaffoldMCS&quot;</span><span class="p">]:</span>
  519         <span class="k">return</span> <span class="n">SetupCoreScaffoldByMCS</span><span class="p">(</span><span class="n">RefMol</span><span class="p">,</span> <span class="n">Mol</span><span class="p">,</span> <span class="n">MolCount</span><span class="p">)</span>
  520     <span class="k">elif</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;UseScaffoldSMARTS&quot;</span><span class="p">]:</span>
  521         <span class="k">return</span> <span class="n">SetupCoreScaffoldBySMARTS</span><span class="p">(</span><span class="n">RefMol</span><span class="p">,</span> <span class="n">Mol</span><span class="p">,</span> <span class="n">MolCount</span><span class="p">)</span>
  522     <span class="k">else</span><span class="p">:</span>
  523         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintError</span><span class="p">(</span><span class="s2">&quot;The  value, </span><span class="si">%s</span><span class="s2">, specified for  </span><span class="se">\&quot;</span><span class="s2">-s, --scaffold</span><span class="se">\&quot;</span><span class="s2"> option is not supported.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Scaffold&quot;</span><span class="p">]))</span>
  524         
  525 <span class="k">def</span> <span class="nf">SetupCoreScaffoldByMCS</span><span class="p">(</span><span class="n">RefMol</span><span class="p">,</span> <span class="n">Mol</span><span class="p">,</span> <span class="n">MolCount</span><span class="p">):</span>
  526     <span class="sd">&quot;&quot;&quot;Setup a reference molecule core containing common scaffold atoms between</span>
  527 <span class="sd">    a pair of molecules using MCS.&quot;&quot;&quot;</span>
  528     
  529     <span class="n">MCSParams</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;MCSParams&quot;</span><span class="p">]</span>
  530     <span class="n">Mols</span> <span class="o">=</span> <span class="p">[</span><span class="n">RefMol</span><span class="p">,</span> <span class="n">Mol</span><span class="p">]</span>
  531 
  532     <span class="n">MCSResultObject</span> <span class="o">=</span> <span class="n">rdFMCS</span><span class="o">.</span><span class="n">FindMCS</span><span class="p">(</span><span class="n">Mols</span><span class="p">,</span> <span class="n">maximizeBonds</span> <span class="o">=</span> <span class="n">MCSParams</span><span class="p">[</span><span class="s2">&quot;MaximizeBonds&quot;</span><span class="p">],</span> <span class="n">threshold</span> <span class="o">=</span> <span class="n">MCSParams</span><span class="p">[</span><span class="s2">&quot;Threshold&quot;</span><span class="p">],</span> <span class="n">timeout</span> <span class="o">=</span> <span class="n">MCSParams</span><span class="p">[</span><span class="s2">&quot;TimeOut&quot;</span><span class="p">],</span> <span class="n">verbose</span> <span class="o">=</span> <span class="n">MCSParams</span><span class="p">[</span><span class="s2">&quot;Verbose&quot;</span><span class="p">],</span> <span class="n">matchValences</span> <span class="o">=</span> <span class="n">MCSParams</span><span class="p">[</span><span class="s2">&quot;MatchValences&quot;</span><span class="p">],</span> <span class="n">ringMatchesRingOnly</span> <span class="o">=</span> <span class="n">MCSParams</span><span class="p">[</span><span class="s2">&quot;RingMatchesRingOnly&quot;</span><span class="p">],</span> <span class="n">completeRingsOnly</span> <span class="o">=</span> <span class="n">MCSParams</span><span class="p">[</span><span class="s2">&quot;CompleteRingsOnly&quot;</span><span class="p">],</span> <span class="n">matchChiralTag</span> <span class="o">=</span> <span class="n">MCSParams</span><span class="p">[</span><span class="s2">&quot;MatchChiralTag&quot;</span><span class="p">],</span> <span class="n">atomCompare</span> <span class="o">=</span> <span class="n">MCSParams</span><span class="p">[</span><span class="s2">&quot;AtomCompare&quot;</span><span class="p">],</span> <span class="n">bondCompare</span> <span class="o">=</span> <span class="n">MCSParams</span><span class="p">[</span><span class="s2">&quot;BondCompare&quot;</span><span class="p">],</span> <span class="n">seedSmarts</span> <span class="o">=</span> <span class="n">MCSParams</span><span class="p">[</span><span class="s2">&quot;SeedSMARTS&quot;</span><span class="p">])</span> 
  533     
  534     <span class="k">if</span> <span class="n">MCSResultObject</span><span class="o">.</span><span class="n">canceled</span><span class="p">:</span>
  535         <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]:</span>
  536             <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintWarning</span><span class="p">(</span><span class="s2">&quot;MCS failed to identify a common core scaffold between reference moecule and input molecule </span><span class="si">%s</span><span class="s2">. Specify a different set of parameters using </span><span class="se">\&quot;</span><span class="s2">-m, --mcsParams</span><span class="se">\&quot;</span><span class="s2"> option and try again.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">RDKitUtil</span><span class="o">.</span><span class="n">GetMolName</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolCount</span><span class="p">)))</span>
  537         <span class="k">return</span> <span class="bp">None</span>
  538     
  539     <span class="n">CoreNumAtoms</span> <span class="o">=</span> <span class="n">MCSResultObject</span><span class="o">.</span><span class="n">numAtoms</span>
  540     <span class="n">CoreNumBonds</span> <span class="o">=</span> <span class="n">MCSResultObject</span><span class="o">.</span><span class="n">numBonds</span>
  541     
  542     <span class="n">SMARTSCore</span> <span class="o">=</span> <span class="n">MCSResultObject</span><span class="o">.</span><span class="n">smartsString</span>
  543     
  544     <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">SMARTSCore</span><span class="p">):</span>
  545         <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]:</span>
  546             <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintWarning</span><span class="p">(</span><span class="s2">&quot;MCS failed to identify a common core scaffold between reference moecule and input molecule </span><span class="si">%s</span><span class="s2">. Specify a different set of parameters using </span><span class="se">\&quot;</span><span class="s2">-m, --mcsParams</span><span class="se">\&quot;</span><span class="s2"> option and try again.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">RDKitUtil</span><span class="o">.</span><span class="n">GetMolName</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolCount</span><span class="p">)))</span>
  547         <span class="k">return</span> <span class="bp">None</span>
  548         
  549     <span class="k">if</span> <span class="n">CoreNumAtoms</span> <span class="o">&lt;</span> <span class="n">MCSParams</span><span class="p">[</span><span class="s2">&quot;MinNumAtoms&quot;</span><span class="p">]:</span>
  550         <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]:</span>
  551             <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintWarning</span><span class="p">(</span><span class="s2">&quot;Number of atoms, </span><span class="si">%d</span><span class="s2">, in core scaffold identified by MCS is less than, </span><span class="si">%d</span><span class="s2">, as specified by </span><span class="se">\&quot;</span><span class="s2">minNumAtoms</span><span class="se">\&quot;</span><span class="s2"> parameter in  </span><span class="se">\&quot;</span><span class="s2">-m, --mcsParams</span><span class="se">\&quot;</span><span class="s2"> option.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">CoreNumAtoms</span><span class="p">,</span> <span class="n">MCSParams</span><span class="p">[</span><span class="s2">&quot;MinNumAtoms&quot;</span><span class="p">]))</span>
  552         <span class="k">return</span> <span class="bp">None</span>
  553     
  554     <span class="k">if</span> <span class="n">CoreNumBonds</span> <span class="o">&lt;</span> <span class="n">MCSParams</span><span class="p">[</span><span class="s2">&quot;MinNumBonds&quot;</span><span class="p">]:</span>
  555         <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]:</span>
  556             <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintWarning</span><span class="p">(</span><span class="s2">&quot;Number of bonds, </span><span class="si">%d</span><span class="s2">, in core scaffold identified by MCS is less than, </span><span class="si">%d</span><span class="s2">, as specified by </span><span class="se">\&quot;</span><span class="s2">minNumBonds</span><span class="se">\&quot;</span><span class="s2"> parameter in  </span><span class="se">\&quot;</span><span class="s2">-m, --mcsParams</span><span class="se">\&quot;</span><span class="s2"> option.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">CoreNumBonds</span><span class="p">,</span> <span class="n">MCSParams</span><span class="p">[</span><span class="s2">&quot;MinNumBonds&quot;</span><span class="p">]))</span>
  557         <span class="k">return</span> <span class="bp">None</span>
  558 
  559     <span class="k">return</span> <span class="n">GenerateCoreMol</span><span class="p">(</span><span class="n">RefMol</span><span class="p">,</span> <span class="n">SMARTSCore</span><span class="p">)</span>
  560     
  561 <span class="k">def</span> <span class="nf">SetupCoreScaffoldBySMARTS</span><span class="p">(</span><span class="n">RefMol</span><span class="p">,</span> <span class="n">Mol</span><span class="p">,</span> <span class="n">MolCount</span><span class="p">):</span>
  562     <span class="sd">&quot;&quot;&quot;Setup a reference molecule core containing common scaffold atoms between</span>
  563 <span class="sd">    a pair of molecules using specified SMARTS.&quot;&quot;&quot;</span>
  564     
  565     <span class="k">if</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;ScaffoldPatternMol&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
  566         <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;ScaffoldPatternMol&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">MolFromSmarts</span><span class="p">(</span><span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;ScaffoldSMARTS&quot;</span><span class="p">])</span>
  567         
  568     <span class="k">if</span> <span class="ow">not</span> <span class="n">Mol</span><span class="o">.</span><span class="n">HasSubstructMatch</span><span class="p">(</span><span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;ScaffoldPatternMol&quot;</span><span class="p">]):</span>
  569         <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]:</span>
  570             <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintWarning</span><span class="p">(</span><span class="s2">&quot;The scaffold SMARTS pattern, </span><span class="si">%s</span><span class="s2">, specified using </span><span class="se">\&quot;</span><span class="s2">-s, --scaffold</span><span class="se">\&quot;</span><span class="s2"> option is missing in input molecule,  </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;ScaffoldSMARTS&quot;</span><span class="p">],</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">GetMolName</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolCount</span><span class="p">)))</span>
  571         <span class="k">return</span> <span class="bp">None</span>
  572 
  573     <span class="k">return</span> <span class="n">GenerateCoreMol</span><span class="p">(</span><span class="n">RefMol</span><span class="p">,</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;ScaffoldSMARTS&quot;</span><span class="p">])</span>
  574 
  575 <span class="k">def</span> <span class="nf">GenerateCoreMol</span><span class="p">(</span><span class="n">RefMol</span><span class="p">,</span> <span class="n">SMARTSCore</span><span class="p">):</span>
  576     <span class="sd">&quot;&quot;&quot;Generate core molecule for embedding.&quot;&quot;&quot;</span>
  577 
  578     <span class="c1"># Create a molecule corresponding to core atoms...</span>
  579     <span class="n">SMARTSCoreMol</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">MolFromSmarts</span><span class="p">(</span><span class="n">SMARTSCore</span><span class="p">)</span>
  580 
  581     <span class="c1"># Setup a ref molecule containing core atoms with dummy atoms as</span>
  582     <span class="c1"># attachment points for atoms around the core atoms...</span>
  583     <span class="n">Core</span> <span class="o">=</span> <span class="n">AllChem</span><span class="o">.</span><span class="n">ReplaceSidechains</span><span class="p">(</span><span class="n">Chem</span><span class="o">.</span><span class="n">RemoveHs</span><span class="p">(</span><span class="n">RefMol</span><span class="p">),</span> <span class="n">SMARTSCoreMol</span><span class="p">)</span>
  584 
  585     <span class="c1"># Delete any substructures containing dummy atoms..</span>
  586     <span class="n">RefMolCore</span> <span class="o">=</span> <span class="n">AllChem</span><span class="o">.</span><span class="n">DeleteSubstructs</span><span class="p">(</span><span class="n">Core</span><span class="p">,</span> <span class="n">Chem</span><span class="o">.</span><span class="n">MolFromSmiles</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">))</span>
  587     <span class="n">RefMolCore</span><span class="o">.</span><span class="n">UpdatePropertyCache</span><span class="p">()</span>
  588     
  589     <span class="k">return</span> <span class="n">RefMolCore</span>
  590 
  591 <span class="k">def</span> <span class="nf">GenerateMolConformers</span><span class="p">(</span><span class="n">Psi4Handle</span><span class="p">,</span> <span class="n">Mol</span><span class="p">,</span> <span class="n">RefMolCore</span><span class="p">,</span> <span class="n">MolNum</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
  592     <span class="sd">&quot;&quot;&quot;Generate constrained conformers.&quot;&quot;&quot;</span>
  593 
  594     <span class="c1"># Add hydrogens...</span>
  595     <span class="n">Mol</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">AddHs</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">addCoords</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
  596     
  597     <span class="n">MolName</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">GetMolName</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">)</span>
  598     
  599     <span class="c1"># Setup constrained conformers...</span>
  600     <span class="n">MolConfs</span><span class="p">,</span> <span class="n">MolConfsStatus</span><span class="p">,</span> <span class="n">MolConfIDs</span> <span class="o">=</span> <span class="n">ConstrainEmbedAndMinimizeMoleculeUsingRDKit</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">RefMolCore</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">)</span>
  601     <span class="k">if</span> <span class="ow">not</span> <span class="n">MolConfsStatus</span><span class="p">:</span>
  602         <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]:</span>
  603             <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintWarning</span><span class="p">(</span><span class="s2">&quot;Conformation generation couldn&#39;t be performed for molecule </span><span class="si">%s</span><span class="s2">: Constrained embedding failed...</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">MolName</span><span class="p">)</span>
  604         <span class="k">return</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
  605 
  606     <span class="n">CalcEnergyMap</span> <span class="o">=</span> <span class="p">{}</span>
  607     <span class="n">ScaffoldEmbedRMSDMap</span> <span class="o">=</span> <span class="p">{}</span>
  608     
  609     <span class="k">for</span> <span class="n">MolConfIndex</span><span class="p">,</span> <span class="n">MolConf</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">MolConfs</span><span class="p">):</span>
  610         <span class="n">MolConfID</span> <span class="o">=</span> <span class="n">MolConfIDs</span><span class="p">[</span><span class="n">MolConfIndex</span><span class="p">]</span>
  611         
  612         <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]:</span>
  613             <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Processing molecule </span><span class="si">%s</span><span class="s2"> conformer number </span><span class="si">%s</span><span class="s2">...&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">MolName</span><span class="p">,</span> <span class="n">MolConfID</span><span class="p">))</span>
  614         
  615         <span class="c1"># Perform Psi4 minimization...</span>
  616         <span class="n">CalcStatus</span><span class="p">,</span> <span class="n">Energy</span> <span class="o">=</span> <span class="n">ConstrainAndMinimizeMoleculeUsingPsi4</span><span class="p">(</span><span class="n">Psi4Handle</span><span class="p">,</span> <span class="n">MolConf</span><span class="p">,</span> <span class="n">RefMolCore</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">)</span>
  617         <span class="k">if</span> <span class="ow">not</span> <span class="n">CalcStatus</span><span class="p">:</span>
  618             <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]:</span>
  619                 <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintWarning</span><span class="p">(</span><span class="s2">&quot;Minimization couldn&#39;t be performed for molecule </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">MolName</span><span class="p">))</span>
  620             <span class="k">return</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
  621             
  622         <span class="n">CalcEnergyMap</span><span class="p">[</span><span class="n">MolConfID</span><span class="p">]</span> <span class="o">=</span> <span class="n">Energy</span>
  623         
  624         <span class="k">if</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;ScaffoldRMSDOut&quot;</span><span class="p">]:</span>
  625             <span class="n">ScaffoldEmbedRMSDMap</span><span class="p">[</span><span class="n">MolConfID</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%.4f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">float</span><span class="p">(</span><span class="n">MolConf</span><span class="o">.</span><span class="n">GetProp</span><span class="p">(</span><span class="s1">&#39;EmbedRMS&#39;</span><span class="p">))</span>
  626         <span class="n">MolConf</span><span class="o">.</span><span class="n">ClearProp</span><span class="p">(</span><span class="s1">&#39;EmbedRMS&#39;</span><span class="p">)</span>
  627     
  628     <span class="c1"># Filter conformers...</span>
  629     <span class="n">SelectedMolConfs</span><span class="p">,</span> <span class="n">SelectedMolConfIDs</span><span class="p">,</span> <span class="n">SelectedConfEnergies</span><span class="p">,</span> <span class="n">SelectedConfScaffoldEmbedRMSDValues</span> <span class="o">=</span> <span class="n">FilterMolConformers</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">,</span> <span class="n">MolConfs</span><span class="p">,</span> <span class="n">MolConfIDs</span><span class="p">,</span> <span class="n">CalcEnergyMap</span><span class="p">,</span> <span class="n">ScaffoldEmbedRMSDMap</span><span class="p">)</span>
  630 
  631     <span class="k">return</span> <span class="p">(</span><span class="n">SelectedMolConfs</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="n">SelectedMolConfIDs</span><span class="p">,</span> <span class="n">SelectedConfEnergies</span><span class="p">,</span> <span class="n">SelectedConfScaffoldEmbedRMSDValues</span><span class="p">)</span>
  632 
  633 <span class="k">def</span> <span class="nf">FilterMolConformers</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">,</span> <span class="n">MolConfs</span><span class="p">,</span> <span class="n">ConfIDs</span><span class="p">,</span> <span class="n">CalcEnergyMap</span><span class="p">,</span> <span class="n">ScaffoldEmbedRMSDMap</span><span class="p">):</span>
  634     <span class="sd">&quot;&quot;&quot;Filter conformers for a molecule.&quot;&quot;&quot;</span>
  635 
  636     <span class="c1"># Sort conformers by energy...</span>
  637     <span class="n">SortedConfIDs</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">ConfIDs</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">ConfID</span><span class="p">:</span> <span class="n">CalcEnergyMap</span><span class="p">[</span><span class="n">ConfID</span><span class="p">])</span>
  638 
  639     <span class="c1"># Setup a map from ConfID to MolConf...</span>
  640     <span class="n">MolConfsMap</span> <span class="o">=</span> <span class="p">{}</span>
  641     <span class="k">for</span> <span class="n">MolConfIndex</span><span class="p">,</span> <span class="n">ConfID</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ConfIDs</span><span class="p">):</span>
  642         <span class="n">MolConfsMap</span><span class="p">[</span><span class="n">ConfID</span><span class="p">]</span> <span class="o">=</span> <span class="n">MolConfs</span><span class="p">[</span><span class="n">MolConfIndex</span><span class="p">]</span>
  643     
  644     <span class="n">MinEnergyConfID</span> <span class="o">=</span> <span class="n">SortedConfIDs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
  645     <span class="n">MinConfEnergy</span> <span class="o">=</span> <span class="n">CalcEnergyMap</span><span class="p">[</span><span class="n">MinEnergyConfID</span><span class="p">]</span>
  646     <span class="n">MinEnergyMolConf</span> <span class="o">=</span> <span class="n">MolConfsMap</span><span class="p">[</span><span class="n">MinEnergyConfID</span><span class="p">]</span>
  647     
  648     <span class="n">EnergyWindow</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;EnergyWindow&quot;</span><span class="p">]</span>
  649     
  650     <span class="n">EnergyRMSDCutoff</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;EnergyRMSDCutoff&quot;</span><span class="p">]</span>
  651     <span class="n">ApplyEnergyRMSDCutoff</span> <span class="o">=</span> <span class="bp">True</span>  <span class="k">if</span> <span class="n">EnergyRMSDCutoff</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="bp">False</span>
  652     
  653     <span class="n">EnergyRMSDCutoffLowest</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;EnergyRMSDCutoffModeLowest&quot;</span><span class="p">]</span>
  654     <span class="n">EnergyRMSDCalcModeBest</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;EnergyRMSDCalcModeBest&quot;</span><span class="p">]</span>
  655 
  656     <span class="n">SelectedConfIDs</span> <span class="o">=</span> <span class="p">[]</span>
  657     
  658     <span class="n">ConfCount</span> <span class="o">=</span> <span class="mi">0</span>
  659     <span class="n">IgnoredByEnergyConfCount</span> <span class="o">=</span> <span class="mi">0</span>
  660     <span class="n">IgnoredByRMSDConfCount</span> <span class="o">=</span> <span class="mi">0</span>
  661     
  662     <span class="n">FirstConf</span> <span class="o">=</span> <span class="bp">True</span>
  663     
  664     <span class="k">for</span> <span class="n">ConfID</span> <span class="ow">in</span> <span class="n">SortedConfIDs</span><span class="p">:</span>
  665         <span class="k">if</span> <span class="n">FirstConf</span><span class="p">:</span>
  666             <span class="n">FirstConf</span> <span class="o">=</span> <span class="bp">False</span>
  667             <span class="n">ConfCount</span> <span class="o">+=</span> <span class="mi">1</span>
  668             <span class="n">SelectedConfIDs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ConfID</span><span class="p">)</span>
  669             <span class="k">continue</span>
  670             
  671         <span class="n">ConfEnergyDiff</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">CalcEnergyMap</span><span class="p">[</span><span class="n">ConfID</span><span class="p">]</span> <span class="o">-</span> <span class="n">MinConfEnergy</span><span class="p">)</span>
  672         <span class="k">if</span>  <span class="n">ConfEnergyDiff</span> <span class="o">&gt;</span> <span class="n">EnergyWindow</span><span class="p">:</span>
  673             <span class="n">IgnoredByEnergyConfCount</span> <span class="o">+=</span> <span class="mi">1</span>
  674             <span class="k">continue</span>
  675 
  676         <span class="k">if</span> <span class="n">ApplyEnergyRMSDCutoff</span><span class="p">:</span>
  677             <span class="n">IgnoreConf</span> <span class="o">=</span> <span class="bp">False</span>
  678             <span class="n">ProbeMolConf</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">Mol</span><span class="p">(</span><span class="n">MolConfsMap</span><span class="p">[</span><span class="n">ConfID</span><span class="p">])</span>
  679             
  680             <span class="k">if</span> <span class="n">EnergyRMSDCutoffLowest</span><span class="p">:</span>
  681                 <span class="c1"># Compare RMSD with the lowest energy conformation...</span>
  682                 <span class="n">RefMolConf</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">Mol</span><span class="p">(</span><span class="n">MinEnergyMolConf</span><span class="p">)</span>
  683                 <span class="k">if</span> <span class="n">EnergyRMSDCalcModeBest</span><span class="p">:</span>
  684                     <span class="n">CalcRMSD</span> <span class="o">=</span> <span class="n">AllChem</span><span class="o">.</span><span class="n">GetBestRMS</span><span class="p">(</span><span class="n">ProbeMolConf</span><span class="p">,</span> <span class="n">RefMolConf</span><span class="p">)</span>
  685                 <span class="k">else</span><span class="p">:</span>
  686                     <span class="n">CalcRMSD</span> <span class="o">=</span> <span class="n">rdMolAlign</span><span class="o">.</span><span class="n">AlignMol</span><span class="p">(</span><span class="n">ProbeMolConf</span><span class="p">,</span> <span class="n">RefMolConf</span><span class="p">)</span>
  687                 <span class="k">if</span> <span class="n">CalcRMSD</span> <span class="o">&lt;</span> <span class="n">EnergyRMSDCutoff</span><span class="p">:</span>
  688                         <span class="n">IgnoreConf</span> <span class="o">=</span> <span class="bp">True</span>
  689             <span class="k">else</span><span class="p">:</span>
  690                 <span class="k">for</span> <span class="n">SelectedConfID</span> <span class="ow">in</span> <span class="n">SelectedConfIDs</span><span class="p">:</span>
  691                     <span class="n">RefMolConf</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">Mol</span><span class="p">(</span><span class="n">MolConfsMap</span><span class="p">[</span><span class="n">SelectedConfID</span><span class="p">])</span>
  692                     <span class="k">if</span> <span class="n">EnergyRMSDCalcModeBest</span><span class="p">:</span>
  693                         <span class="n">CalcRMSD</span> <span class="o">=</span> <span class="n">AllChem</span><span class="o">.</span><span class="n">GetBestRMS</span><span class="p">(</span><span class="n">ProbeMolConf</span><span class="p">,</span> <span class="n">RefMolConf</span><span class="p">)</span>
  694                     <span class="k">else</span><span class="p">:</span>
  695                         <span class="n">CalcRMSD</span> <span class="o">=</span> <span class="n">rdMolAlign</span><span class="o">.</span><span class="n">AlignMol</span><span class="p">(</span><span class="n">ProbeMolConf</span><span class="p">,</span> <span class="n">RefMolConf</span><span class="p">)</span>
  696                     <span class="k">if</span> <span class="n">CalcRMSD</span> <span class="o">&lt;</span> <span class="n">EnergyRMSDCutoff</span><span class="p">:</span>
  697                         <span class="n">IgnoreConf</span> <span class="o">=</span> <span class="bp">True</span>
  698                         <span class="k">break</span>
  699             <span class="k">if</span> <span class="n">IgnoreConf</span><span class="p">:</span>
  700                 <span class="n">IgnoredByRMSDConfCount</span> <span class="o">+=</span> <span class="mi">1</span>
  701                 <span class="k">continue</span>
  702                 
  703         <span class="n">ConfCount</span> <span class="o">+=</span> <span class="mi">1</span>
  704         <span class="n">SelectedConfIDs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ConfID</span><span class="p">)</span>
  705         
  706     <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]:</span>
  707         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Total Number of conformations generated for </span><span class="si">%s</span><span class="s2">: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">RDKitUtil</span><span class="o">.</span><span class="n">GetMolName</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">),</span> <span class="n">ConfCount</span><span class="p">))</span>
  708         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;Number of conformations ignored due to energy window cutoff: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">IgnoredByEnergyConfCount</span><span class="p">))</span>
  709         <span class="k">if</span> <span class="n">ApplyEnergyRMSDCutoff</span><span class="p">:</span>
  710             <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;Number of conformations ignored due to energy RMSD cutoff:  </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">IgnoredByRMSDConfCount</span><span class="p">))</span>
  711 
  712     <span class="c1"># Setup selected conformer molecules...</span>
  713     <span class="n">SelectedConfMols</span> <span class="o">=</span> <span class="p">[</span><span class="n">MolConfsMap</span><span class="p">[</span><span class="n">ConfID</span><span class="p">]</span> <span class="k">for</span> <span class="n">ConfID</span> <span class="ow">in</span> <span class="n">SelectedConfIDs</span><span class="p">]</span>
  714     
  715     <span class="c1">#  Setup energies...</span>
  716     <span class="n">SelectedConfEnergies</span> <span class="o">=</span> <span class="bp">None</span>
  717     <span class="k">if</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;EnergyOut&quot;</span><span class="p">]:</span>
  718         <span class="n">SelectedConfEnergies</span> <span class="o">=</span> <span class="p">[]</span>
  719         <span class="k">for</span> <span class="n">ConfID</span> <span class="ow">in</span> <span class="n">SelectedConfIDs</span><span class="p">:</span>
  720             <span class="n">Energy</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%.*f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Precision&quot;</span><span class="p">],</span> <span class="n">CalcEnergyMap</span><span class="p">[</span><span class="n">ConfID</span><span class="p">])</span>
  721             <span class="n">SelectedConfEnergies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Energy</span><span class="p">)</span>
  722 
  723     <span class="c1"># Setup scaffold RMSD values...</span>
  724     <span class="n">SelectedConfScaffoldEmbedRMSDValues</span> <span class="o">=</span> <span class="bp">None</span>
  725     <span class="k">if</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;ScaffoldRMSDOut&quot;</span><span class="p">]:</span>
  726         <span class="n">SelectedConfScaffoldEmbedRMSDValues</span> <span class="o">=</span> <span class="p">[]</span>
  727         <span class="k">for</span> <span class="n">ConfID</span> <span class="ow">in</span> <span class="n">SelectedConfIDs</span><span class="p">:</span>
  728             <span class="n">MolConf</span> <span class="o">=</span> <span class="n">MolConfsMap</span><span class="p">[</span><span class="n">ConfID</span><span class="p">]</span>
  729             <span class="n">SelectedConfScaffoldEmbedRMSDValues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ScaffoldEmbedRMSDMap</span><span class="p">[</span><span class="n">ConfID</span><span class="p">])</span>
  730     
  731     <span class="k">return</span> <span class="p">(</span><span class="n">SelectedConfMols</span><span class="p">,</span> <span class="n">SelectedConfIDs</span><span class="p">,</span> <span class="n">SelectedConfEnergies</span><span class="p">,</span> <span class="n">SelectedConfScaffoldEmbedRMSDValues</span><span class="p">)</span>
  732     
  733 <span class="k">def</span> <span class="nf">ConstrainAndMinimizeMoleculeUsingPsi4</span><span class="p">(</span><span class="n">Psi4Handle</span><span class="p">,</span> <span class="n">Mol</span><span class="p">,</span> <span class="n">RefMolCore</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">,</span> <span class="n">ConfID</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
  734     <span class="sd">&quot;&quot;&quot;Constrain and Minimize molecule using Psi4.&quot;&quot;&quot;</span>
  735 
  736     <span class="c1"># Setup a list for constrained atoms...</span>
  737     <span class="n">ConstrainedAtomIndices</span> <span class="o">=</span> <span class="n">SetupConstrainedAtomIndicesForPsi4</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">RefMolCore</span><span class="p">)</span>
  738     <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ConstrainedAtomIndices</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
  739         <span class="k">return</span> <span class="p">(</span><span class="bp">False</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
  740 
  741     <span class="c1"># Setup a Psi4Mol...</span>
  742     <span class="n">Psi4Mol</span> <span class="o">=</span> <span class="n">SetupPsi4Mol</span><span class="p">(</span><span class="n">Psi4Handle</span><span class="p">,</span> <span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">,</span> <span class="n">ConfID</span><span class="p">)</span>
  743     <span class="k">if</span> <span class="n">Psi4Mol</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
  744         <span class="k">return</span> <span class="p">(</span><span class="bp">False</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
  745         
  746     <span class="c1">#  Setup reference wave function...</span>
  747     <span class="n">Reference</span> <span class="o">=</span> <span class="n">SetupReferenceWavefunction</span><span class="p">(</span><span class="n">Mol</span><span class="p">)</span>
  748     <span class="n">Psi4Handle</span><span class="o">.</span><span class="n">set_options</span><span class="p">({</span><span class="s1">&#39;Reference&#39;</span><span class="p">:</span> <span class="n">Reference</span><span class="p">})</span>
  749     
  750     <span class="c1"># Setup method name and basis set...</span>
  751     <span class="n">MethodName</span><span class="p">,</span> <span class="n">BasisSet</span> <span class="o">=</span> <span class="n">SetupMethodNameAndBasisSet</span><span class="p">(</span><span class="n">Mol</span><span class="p">)</span>
  752 
  753     <span class="c1"># Setup freeze list for constrained atoms...</span>
  754     <span class="n">FreezeXYZList</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> xyz&quot;</span> <span class="o">%</span> <span class="n">AtomIdex</span><span class="p">)</span> <span class="k">for</span> <span class="n">AtomIdex</span> <span class="ow">in</span> <span class="n">ConstrainedAtomIndices</span><span class="p">]</span>
  755     <span class="n">FreezeXYZString</span> <span class="o">=</span> <span class="s2">&quot; </span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">FreezeXYZList</span><span class="p">)</span>
  756     <span class="n">Psi4Handle</span><span class="o">.</span><span class="n">set_options</span><span class="p">({</span><span class="s2">&quot;OPTKING__frozen_cartesian&quot;</span><span class="p">:</span> <span class="n">FreezeXYZString</span><span class="p">})</span>
  757     
  758     <span class="c1"># Optimize geometry...</span>
  759     <span class="n">Status</span><span class="p">,</span> <span class="n">Energy</span><span class="p">,</span> <span class="n">WaveFunction</span> <span class="o">=</span> <span class="n">Psi4Util</span><span class="o">.</span><span class="n">PerformGeometryOptimization</span><span class="p">(</span><span class="n">Psi4Handle</span><span class="p">,</span> <span class="n">Psi4Mol</span><span class="p">,</span> <span class="n">MethodName</span><span class="p">,</span> <span class="n">BasisSet</span><span class="p">,</span> <span class="n">ReturnWaveFunction</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">Quiet</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">])</span>
  760     
  761     <span class="k">if</span> <span class="ow">not</span> <span class="n">Status</span><span class="p">:</span>
  762         <span class="n">PerformPsi4Cleanup</span><span class="p">(</span><span class="n">Psi4Handle</span><span class="p">)</span>
  763         <span class="k">return</span> <span class="p">(</span><span class="bp">False</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
  764 
  765     <span class="c1"># Update atom positions...</span>
  766     <span class="n">AtomPositions</span> <span class="o">=</span> <span class="n">Psi4Util</span><span class="o">.</span><span class="n">GetAtomPositions</span><span class="p">(</span><span class="n">Psi4Handle</span><span class="p">,</span> <span class="n">WaveFunction</span><span class="p">,</span> <span class="n">InAngstroms</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
  767     <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">SetAtomPositions</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">AtomPositions</span><span class="p">,</span> <span class="n">ConfID</span> <span class="o">=</span> <span class="n">ConfID</span><span class="p">)</span>
  768 
  769     <span class="c1"># Convert energy units...</span>
  770     <span class="k">if</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;ApplyEnergyConversionFactor&quot;</span><span class="p">]:</span>
  771         <span class="n">Energy</span> <span class="o">=</span> <span class="n">Energy</span> <span class="o">*</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;EnergyConversionFactor&quot;</span><span class="p">]</span>
  772     
  773     <span class="c1"># Clean up</span>
  774     <span class="n">PerformPsi4Cleanup</span><span class="p">(</span><span class="n">Psi4Handle</span><span class="p">)</span>
  775     
  776     <span class="k">return</span> <span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="n">Energy</span><span class="p">)</span>
  777 
  778 <span class="k">def</span> <span class="nf">ConstrainEmbedAndMinimizeMoleculeUsingRDKit</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">RefMolCore</span><span class="p">,</span> <span class="n">MolNum</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
  779     <span class="sd">&quot;&quot;&quot;Constrain, embed, and minimize molecule.&quot;&quot;&quot;</span>
  780 
  781     <span class="c1"># Setup forcefield function to use for constrained minimization...</span>
  782     <span class="n">ForceFieldFunction</span> <span class="o">=</span> <span class="bp">None</span>
  783     <span class="n">ForceFieldName</span> <span class="o">=</span> <span class="bp">None</span>
  784     <span class="k">if</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;ConfGenerationParams&quot;</span><span class="p">][</span><span class="s2">&quot;UseUFF&quot;</span><span class="p">]:</span>
  785         <span class="n">ForceFieldFunction</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">mol</span><span class="p">,</span> <span class="n">confId</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="p">:</span> <span class="n">AllChem</span><span class="o">.</span><span class="n">UFFGetMoleculeForceField</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">confId</span> <span class="o">=</span> <span class="n">confId</span><span class="p">)</span>
  786         <span class="n">ForeceFieldName</span> <span class="o">=</span> <span class="s2">&quot;UFF&quot;</span>
  787     <span class="k">else</span><span class="p">:</span>
  788         <span class="n">ForceFieldFunction</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">mol</span><span class="p">,</span> <span class="n">confId</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="p">:</span> <span class="n">AllChem</span><span class="o">.</span><span class="n">MMFFGetMoleculeForceField</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">AllChem</span><span class="o">.</span><span class="n">MMFFGetMoleculeProperties</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">mmffVariant</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;ConfGenerationParams&quot;</span><span class="p">][</span><span class="s2">&quot;MMFFVariant&quot;</span><span class="p">])</span> <span class="p">,</span> <span class="n">confId</span> <span class="o">=</span> <span class="n">confId</span><span class="p">)</span>
  789         <span class="n">ForeceFieldName</span> <span class="o">=</span> <span class="s2">&quot;MMFF&quot;</span>
  790 
  791     <span class="k">if</span> <span class="n">ForceFieldFunction</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
  792         <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]:</span>
  793             <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintWarning</span><span class="p">(</span><span class="s2">&quot;Failed to setup forcefield </span><span class="si">%s</span><span class="s2"> for molecule: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ForceFieldName</span><span class="p">,</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">GetMolName</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">)))</span>
  794         <span class="k">return</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
  795     
  796     <span class="n">MaxConfs</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;ConfGenerationParams&quot;</span><span class="p">][</span><span class="s2">&quot;MaxConfs&quot;</span><span class="p">]</span>
  797     <span class="n">EnforceChirality</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;ConfGenerationParams&quot;</span><span class="p">][</span><span class="s2">&quot;EnforceChirality&quot;</span><span class="p">]</span>
  798     <span class="n">UseExpTorsionAnglePrefs</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;ConfGenerationParams&quot;</span><span class="p">][</span><span class="s2">&quot;UseExpTorsionAnglePrefs&quot;</span><span class="p">]</span>
  799     <span class="n">UseBasicKnowledge</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;ConfGenerationParams&quot;</span><span class="p">][</span><span class="s2">&quot;UseBasicKnowledge&quot;</span><span class="p">]</span>
  800     <span class="n">UseTethers</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;ConfGenerationParams&quot;</span><span class="p">][</span><span class="s2">&quot;UseTethers&quot;</span><span class="p">]</span>
  801 
  802     <span class="n">MolConfs</span> <span class="o">=</span> <span class="p">[]</span>
  803     <span class="n">ConfIDs</span> <span class="o">=</span> <span class="p">[</span><span class="n">ConfID</span> <span class="k">for</span> <span class="n">ConfID</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">MaxConfs</span><span class="p">)]</span>
  804     
  805     <span class="k">for</span> <span class="n">ConfID</span> <span class="ow">in</span> <span class="n">ConfIDs</span><span class="p">:</span>
  806         <span class="k">try</span><span class="p">:</span>
  807             <span class="n">MolConf</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">Mol</span><span class="p">(</span><span class="n">Mol</span><span class="p">)</span>
  808             <span class="n">AllChem</span><span class="o">.</span><span class="n">ConstrainedEmbed</span><span class="p">(</span><span class="n">MolConf</span><span class="p">,</span> <span class="n">RefMolCore</span><span class="p">,</span> <span class="n">useTethers</span> <span class="o">=</span> <span class="n">UseTethers</span><span class="p">,</span> <span class="n">coreConfId</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">randomseed</span> <span class="o">=</span> <span class="n">ConfID</span><span class="p">,</span> <span class="n">getForceField</span> <span class="o">=</span> <span class="n">ForceFieldFunction</span><span class="p">,</span> <span class="n">enforceChirality</span> <span class="o">=</span> <span class="n">EnforceChirality</span><span class="p">,</span> <span class="n">useExpTorsionAnglePrefs</span> <span class="o">=</span> <span class="n">UseExpTorsionAnglePrefs</span><span class="p">,</span> <span class="n">useBasicKnowledge</span> <span class="o">=</span> <span class="n">UseBasicKnowledge</span><span class="p">)</span>
  809         <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">RuntimeError</span><span class="p">,</span> <span class="n">Chem</span><span class="o">.</span><span class="n">rdchem</span><span class="o">.</span><span class="n">KekulizeException</span><span class="p">)</span>  <span class="k">as</span> <span class="n">ErrMsg</span><span class="p">:</span>
  810             <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]:</span>
  811                 <span class="n">MolName</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">GetMolName</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">)</span>
  812                 <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintWarning</span><span class="p">(</span><span class="s2">&quot;Constrained embedding couldn&#39;t  be performed for molecule </span><span class="si">%s</span><span class="s2">:</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">RDKitUtil</span><span class="o">.</span><span class="n">GetMolName</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">),</span> <span class="n">ErrMsg</span><span class="p">))</span>
  813             <span class="k">return</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
  814         
  815         <span class="n">MolConfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">MolConf</span><span class="p">)</span>
  816 
  817     <span class="k">return</span> <span class="n">FilterConstrainedConformationsByRMSD</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolConfs</span><span class="p">,</span> <span class="n">ConfIDs</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">)</span>
  818 
  819 <span class="k">def</span> <span class="nf">FilterConstrainedConformationsByRMSD</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolConfs</span><span class="p">,</span> <span class="n">MolConfIDs</span><span class="p">,</span> <span class="n">MolNum</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
  820     <span class="sd">&quot;&quot;&quot;Filter contarained conformations by RMSD.&quot;&quot;&quot;</span>
  821     
  822     <span class="n">EmbedRMSDCutoff</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;ConfGenerationParams&quot;</span><span class="p">][</span><span class="s2">&quot;EmbedRMSDCutoff&quot;</span><span class="p">]</span>
  823     <span class="k">if</span> <span class="n">EmbedRMSDCutoff</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">EmbedRMSDCutoff</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
  824         <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]:</span>
  825             <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Generating initial ensemble of  constrained conformations by distance geometry  and forcefield for </span><span class="si">%s</span><span class="s2"> - EmbedRMSDCutoff: None; Size: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">RDKitUtil</span><span class="o">.</span><span class="n">GetMolName</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">MolConfs</span><span class="p">)))</span>
  826         <span class="k">return</span> <span class="p">(</span><span class="n">MolConfs</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="n">MolConfIDs</span><span class="p">)</span>
  827 
  828     <span class="n">FirstMolConf</span> <span class="o">=</span> <span class="bp">True</span>
  829     <span class="n">SelectedMolConfs</span> <span class="o">=</span> <span class="p">[]</span>
  830     <span class="n">SelectedMolConfIDs</span> <span class="o">=</span> <span class="p">[]</span>
  831     <span class="k">for</span> <span class="n">MolConfIndex</span><span class="p">,</span> <span class="n">MolConf</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">MolConfs</span><span class="p">):</span>
  832         <span class="k">if</span> <span class="n">FirstMolConf</span><span class="p">:</span>
  833             <span class="n">FirstMolConf</span> <span class="o">=</span> <span class="bp">False</span>
  834             <span class="n">SelectedMolConfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">MolConf</span><span class="p">)</span>
  835             <span class="n">SelectedMolConfIDs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">MolConfIDs</span><span class="p">[</span><span class="n">MolConfIndex</span><span class="p">])</span>
  836             <span class="k">continue</span>
  837         
  838         <span class="c1"># Compare RMSD against all selected conformers...</span>
  839         <span class="n">IgnoreConf</span> <span class="o">=</span> <span class="bp">False</span>
  840         <span class="n">ProbeMolConf</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">RemoveHs</span><span class="p">(</span><span class="n">Chem</span><span class="o">.</span><span class="n">Mol</span><span class="p">(</span><span class="n">MolConf</span><span class="p">))</span>
  841         <span class="k">for</span> <span class="n">SelectedMolConfIndex</span><span class="p">,</span> <span class="n">SelectedMolConf</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">SelectedMolConfs</span><span class="p">):</span>
  842             <span class="n">RefMolConf</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">RemoveHs</span><span class="p">(</span><span class="n">Chem</span><span class="o">.</span><span class="n">Mol</span><span class="p">(</span><span class="n">SelectedMolConf</span><span class="p">))</span>
  843             <span class="n">CalcRMSD</span> <span class="o">=</span> <span class="n">rdMolAlign</span><span class="o">.</span><span class="n">AlignMol</span><span class="p">(</span><span class="n">ProbeMolConf</span><span class="p">,</span> <span class="n">RefMolConf</span><span class="p">)</span>
  844             
  845             <span class="k">if</span> <span class="n">CalcRMSD</span> <span class="o">&lt;</span> <span class="n">EmbedRMSDCutoff</span><span class="p">:</span>
  846                 <span class="n">IgnoreConf</span> <span class="o">=</span> <span class="bp">True</span>
  847                 <span class="k">break</span>
  848         
  849         <span class="k">if</span> <span class="n">IgnoreConf</span><span class="p">:</span>
  850             <span class="k">continue</span>
  851         
  852         <span class="n">SelectedMolConfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">MolConf</span><span class="p">)</span>
  853         <span class="n">SelectedMolConfIDs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">MolConfIDs</span><span class="p">[</span><span class="n">MolConfIndex</span><span class="p">])</span>
  854         
  855     <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]:</span>
  856         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Generating initial ensemble of constrained conformations by distance geometry and forcefield for </span><span class="si">%s</span><span class="s2"> - EmbedRMSDCutoff: </span><span class="si">%s</span><span class="s2">; Size: </span><span class="si">%s</span><span class="s2">; Size after RMSD filtering: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">RDKitUtil</span><span class="o">.</span><span class="n">GetMolName</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">),</span> <span class="n">EmbedRMSDCutoff</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">MolConfs</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">SelectedMolConfs</span><span class="p">)))</span>
  857 
  858     <span class="k">return</span> <span class="p">(</span><span class="n">SelectedMolConfs</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="n">SelectedMolConfIDs</span><span class="p">)</span>
  859 
  860 <span class="k">def</span> <span class="nf">SetupConstrainedAtomIndicesForPsi4</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">RefMolCore</span><span class="p">,</span> <span class="n">ConstrainHydrogens</span> <span class="o">=</span> <span class="bp">False</span><span class="p">):</span>
  861     <span class="sd">&quot;&quot;&quot;Setup a list of atom indices to be constrained during Psi4 minimizaiton.&quot;&quot;&quot;</span>
  862 
  863     <span class="n">AtomIndices</span> <span class="o">=</span> <span class="p">[]</span>
  864     
  865     <span class="c1"># Collect matched heavy atoms along with attached hydrogens...</span>
  866     <span class="k">for</span> <span class="n">AtomIndex</span> <span class="ow">in</span> <span class="n">Mol</span><span class="o">.</span><span class="n">GetSubstructMatch</span><span class="p">(</span><span class="n">RefMolCore</span><span class="p">):</span>
  867         <span class="n">Atom</span> <span class="o">=</span> <span class="n">Mol</span><span class="o">.</span><span class="n">GetAtomWithIdx</span><span class="p">(</span><span class="n">AtomIndex</span><span class="p">)</span>
  868         <span class="k">if</span> <span class="n">Atom</span><span class="o">.</span><span class="n">GetAtomicNum</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
  869             <span class="k">continue</span>
  870         
  871         <span class="n">AtomIndices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">AtomIndex</span><span class="p">)</span>
  872         <span class="k">for</span> <span class="n">AtomNbr</span> <span class="ow">in</span> <span class="n">Atom</span><span class="o">.</span><span class="n">GetNeighbors</span><span class="p">():</span>
  873             <span class="k">if</span> <span class="n">AtomNbr</span><span class="o">.</span><span class="n">GetAtomicNum</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
  874                 <span class="k">if</span> <span class="n">ConstrainHydrogens</span><span class="p">:</span>
  875                     <span class="n">AtomNbrIndex</span> <span class="o">=</span> <span class="n">AtomNbr</span><span class="o">.</span><span class="n">GetIdx</span><span class="p">()</span>
  876                     <span class="n">AtomIndices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">AtomNbrIndex</span><span class="p">)</span>
  877     
  878     <span class="n">AtomIndices</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">AtomIndices</span><span class="p">)</span>
  879 
  880     <span class="c1"># Atom indices start from 1 for Psi4 instead 0 for RDKit...</span>
  881     <span class="n">AtomIndices</span> <span class="o">=</span> <span class="p">[</span> <span class="n">AtomIndex</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">AtomIndex</span> <span class="ow">in</span> <span class="n">AtomIndices</span><span class="p">]</span>
  882     
  883     <span class="k">return</span> <span class="n">AtomIndices</span>
  884     
  885 <span class="k">def</span> <span class="nf">SetupPsi4Mol</span><span class="p">(</span><span class="n">Psi4Handle</span><span class="p">,</span> <span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">,</span> <span class="n">ConfID</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
  886     <span class="sd">&quot;&quot;&quot;Setup a Psi4 molecule object.&quot;&quot;&quot;</span>
  887 
  888     <span class="c1"># Turn off recentering and reorientation to perform optimization in the</span>
  889     <span class="c1"># constrained coordinate space...</span>
  890     <span class="n">MolGeometry</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">GetPsi4XYZFormatString</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">ConfID</span> <span class="o">=</span> <span class="n">ConfID</span><span class="p">,</span> <span class="n">NoCom</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">NoReorient</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
  891 
  892     <span class="k">try</span><span class="p">:</span>
  893         <span class="n">Psi4Mol</span> <span class="o">=</span> <span class="n">Psi4Handle</span><span class="o">.</span><span class="n">geometry</span><span class="p">(</span><span class="n">MolGeometry</span><span class="p">)</span>
  894     <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ErrMsg</span><span class="p">:</span>
  895         <span class="n">Psi4Mol</span> <span class="o">=</span> <span class="bp">None</span>
  896         <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]:</span>
  897             <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintWarning</span><span class="p">(</span><span class="s2">&quot;Failed to create Psi4 molecule from geometry string: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">ErrMsg</span><span class="p">)</span>
  898             <span class="n">MolName</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">GetMolName</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">)</span>
  899             <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintWarning</span><span class="p">(</span><span class="s2">&quot;Ignoring molecule: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">MolName</span><span class="p">)</span>
  900 
  901     <span class="k">return</span> <span class="n">Psi4Mol</span>
  902 
  903 <span class="k">def</span> <span class="nf">PerformPsi4Cleanup</span><span class="p">(</span><span class="n">Psi4Handle</span><span class="p">):</span>
  904     <span class="sd">&quot;&quot;&quot;Perform clean up.&quot;&quot;&quot;</span>
  905 
  906     <span class="c1"># No need to perform any explicit clean by calling</span>
  907     <span class="c1"># Psi4Handle.core.opt_clean(). It&#39;s already done by Psi4 after</span>
  908     <span class="c1"># optimization...</span>
  909     
  910     <span class="c1"># Clean up any leftover scratch files...</span>
  911     <span class="k">if</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;MPMode&quot;</span><span class="p">]:</span>
  912         <span class="n">Psi4Util</span><span class="o">.</span><span class="n">RemoveScratchFiles</span><span class="p">(</span><span class="n">Psi4Handle</span><span class="p">,</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Psi4RunParams&quot;</span><span class="p">][</span><span class="s2">&quot;OutputFile&quot;</span><span class="p">])</span>
  913 
  914 <span class="k">def</span> <span class="nf">CheckAndValidateMolecule</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolCount</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
  915     <span class="sd">&quot;&quot;&quot;Validate molecule for Psi4 calculations.&quot;&quot;&quot;</span>
  916     
  917     <span class="k">if</span> <span class="n">Mol</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
  918         <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]:</span>
  919             <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Processing molecule number </span><span class="si">%s</span><span class="s2">...&quot;</span> <span class="o">%</span> <span class="n">MolCount</span><span class="p">)</span>
  920         <span class="k">return</span> <span class="bp">False</span>
  921     
  922     <span class="n">MolName</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">GetMolName</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolCount</span><span class="p">)</span>
  923     <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]:</span>
  924         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Processing molecule </span><span class="si">%s</span><span class="s2">...&quot;</span> <span class="o">%</span> <span class="n">MolName</span><span class="p">)</span>
  925     
  926     <span class="k">if</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">IsMolEmpty</span><span class="p">(</span><span class="n">Mol</span><span class="p">):</span>
  927         <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]:</span>
  928             <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintWarning</span><span class="p">(</span><span class="s2">&quot;Ignoring empty molecule: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">MolName</span><span class="p">)</span>
  929         <span class="k">return</span> <span class="bp">False</span>
  930     
  931     <span class="k">if</span> <span class="ow">not</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">ValidateElementSymbols</span><span class="p">(</span><span class="n">RDKitUtil</span><span class="o">.</span><span class="n">GetAtomSymbols</span><span class="p">(</span><span class="n">Mol</span><span class="p">)):</span>
  932         <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]:</span>
  933             <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintWarning</span><span class="p">(</span><span class="s2">&quot;Ignoring molecule containing invalid element symbols: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">MolName</span><span class="p">)</span>
  934         <span class="k">return</span> <span class="bp">False</span>
  935     
  936     <span class="k">return</span> <span class="bp">True</span>
  937 
  938 <span class="k">def</span> <span class="nf">SetupMethodNameAndBasisSet</span><span class="p">(</span><span class="n">Mol</span><span class="p">):</span>
  939     <span class="sd">&quot;&quot;&quot;Setup method name and basis set.&quot;&quot;&quot;</span>
  940     
  941     <span class="n">MethodName</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;MethodName&quot;</span><span class="p">]</span>
  942     <span class="k">if</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;MethodNameAuto&quot;</span><span class="p">]:</span>
  943         <span class="n">MethodName</span> <span class="o">=</span> <span class="s2">&quot;B3LYP&quot;</span>
  944     
  945     <span class="n">BasisSet</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;BasisSet&quot;</span><span class="p">]</span>
  946     <span class="k">if</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;BasisSetAuto&quot;</span><span class="p">]:</span>
  947         <span class="n">BasisSet</span> <span class="o">=</span> <span class="s2">&quot;6-31+G**&quot;</span> <span class="k">if</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">IsAtomSymbolPresentInMol</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="s2">&quot;S&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;6-31G**&quot;</span>
  948     
  949     <span class="k">return</span> <span class="p">(</span><span class="n">MethodName</span><span class="p">,</span> <span class="n">BasisSet</span><span class="p">)</span>
  950 
  951 <span class="k">def</span> <span class="nf">SetupReferenceWavefunction</span><span class="p">(</span><span class="n">Mol</span><span class="p">):</span>
  952     <span class="sd">&quot;&quot;&quot;Setup reference wavefunction.&quot;&quot;&quot;</span>
  953     
  954     <span class="n">Reference</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Reference&quot;</span><span class="p">]</span>
  955     <span class="k">if</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;ReferenceAuto&quot;</span><span class="p">]:</span>
  956         <span class="n">Reference</span> <span class="o">=</span> <span class="s1">&#39;UHF&#39;</span> <span class="k">if</span> <span class="p">(</span><span class="n">RDKitUtil</span><span class="o">.</span><span class="n">GetSpinMultiplicity</span><span class="p">(</span><span class="n">Mol</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;RHF&#39;</span>
  957     
  958     <span class="k">return</span> <span class="n">Reference</span>
  959 
  960 <span class="k">def</span> <span class="nf">SetupEnergyConversionFactor</span><span class="p">(</span><span class="n">Psi4Handle</span><span class="p">):</span>
  961     <span class="sd">&quot;&quot;&quot;Setup converstion factor for energt units. The Psi4 energy units are Hartrees.&quot;&quot;&quot;</span>
  962     
  963     <span class="n">EnergyUnits</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;EnergyUnits&quot;</span><span class="p">]</span>
  964     
  965     <span class="n">ApplyConversionFactor</span> <span class="o">=</span> <span class="bp">True</span>
  966     <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^kcal\/mol$&quot;</span><span class="p">,</span> <span class="n">EnergyUnits</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
  967         <span class="n">ConversionFactor</span> <span class="o">=</span> <span class="n">Psi4Handle</span><span class="o">.</span><span class="n">constants</span><span class="o">.</span><span class="n">hartree2kcalmol</span>
  968     <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^kJ\/mol$&quot;</span><span class="p">,</span> <span class="n">EnergyUnits</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
  969         <span class="n">ConversionFactor</span> <span class="o">=</span> <span class="n">Psi4Handle</span><span class="o">.</span><span class="n">constants</span><span class="o">.</span><span class="n">hartree2kJmol</span>
  970     <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^eV$&quot;</span><span class="p">,</span> <span class="n">EnergyUnits</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
  971         <span class="n">ConversionFactor</span> <span class="o">=</span> <span class="n">Psi4Handle</span><span class="o">.</span><span class="n">constants</span><span class="o">.</span><span class="n">hartree2ev</span>
  972     <span class="k">else</span><span class="p">:</span>
  973         <span class="n">ApplyConversionFactor</span> <span class="o">=</span> <span class="bp">False</span>
  974         <span class="n">ConversionFactor</span> <span class="o">=</span> <span class="mf">1.0</span>
  975     
  976     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;ApplyEnergyConversionFactor&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ApplyConversionFactor</span>
  977     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;EnergyConversionFactor&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ConversionFactor</span>
  978 
  979 <span class="k">def</span> <span class="nf">WriteMolConformers</span><span class="p">(</span><span class="n">Writer</span><span class="p">,</span> <span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">,</span> <span class="n">ConfMols</span><span class="p">,</span> <span class="n">ConfIDs</span><span class="p">,</span> <span class="n">ConfEnergyValues</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">ConfScaffoldEmbedRMSDValues</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
  980     <span class="sd">&quot;&quot;&quot;Write molecule coformers.&quot;&quot;&quot;</span>
  981 
  982     <span class="k">if</span> <span class="n">ConfMols</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
  983         <span class="k">return</span>
  984 
  985     <span class="k">for</span> <span class="n">Index</span><span class="p">,</span> <span class="n">ConfMol</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ConfMols</span><span class="p">):</span>
  986         <span class="n">ConfMolName</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">GetMolName</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">)</span>
  987         <span class="n">SetConfMolName</span><span class="p">(</span><span class="n">ConfMol</span><span class="p">,</span> <span class="n">ConfMolName</span><span class="p">,</span> <span class="n">ConfIDs</span><span class="p">[</span><span class="n">Index</span><span class="p">])</span>
  988         
  989         <span class="k">if</span> <span class="n">ConfScaffoldEmbedRMSDValues</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
  990             <span class="n">ConfMol</span><span class="o">.</span><span class="n">SetProp</span><span class="p">(</span><span class="s2">&quot;CoreScaffoldEmbedRMSD&quot;</span><span class="p">,</span> <span class="n">ConfScaffoldEmbedRMSDValues</span><span class="p">[</span><span class="n">Index</span><span class="p">])</span>
  991             
  992         <span class="k">if</span> <span class="n">ConfEnergyValues</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
  993             <span class="n">ConfMol</span><span class="o">.</span><span class="n">SetProp</span><span class="p">(</span><span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;EnergyDataFieldLabel&quot;</span><span class="p">],</span> <span class="n">ConfEnergyValues</span><span class="p">[</span><span class="n">Index</span><span class="p">])</span>
  994     
  995         <span class="n">Writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">ConfMol</span><span class="p">)</span>
  996     
  997 <span class="k">def</span> <span class="nf">SetConfMolName</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolName</span><span class="p">,</span> <span class="n">ConfCount</span><span class="p">):</span>
  998     <span class="sd">&quot;&quot;&quot;Set conf mol name.&quot;&quot;&quot;</span>
  999 
 1000     <span class="n">ConfName</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_Conf</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">MolName</span><span class="p">,</span> <span class="n">ConfCount</span><span class="p">)</span>
 1001     <span class="n">Mol</span><span class="o">.</span><span class="n">SetProp</span><span class="p">(</span><span class="s2">&quot;_Name&quot;</span><span class="p">,</span> <span class="n">ConfName</span><span class="p">)</span>
 1002 
 1003 <span class="k">def</span> <span class="nf">ProcessMCSParameters</span><span class="p">():</span>
 1004     <span class="sd">&quot;&quot;&quot;Set up and process MCS parameters.&quot;&quot;&quot;</span>
 1005 
 1006     <span class="n">SetupMCSParameters</span><span class="p">()</span>
 1007     <span class="n">ProcessSpecifiedMCSParameters</span><span class="p">()</span>
 1008 
 1009 <span class="k">def</span> <span class="nf">SetupMCSParameters</span><span class="p">():</span>
 1010     <span class="sd">&quot;&quot;&quot;Set up default MCS parameters.&quot;&quot;&quot;</span>
 1011     
 1012     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;MCSParams&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;MaximizeBonds&quot;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s2">&quot;Threshold&quot;</span><span class="p">:</span> <span class="mf">0.9</span><span class="p">,</span> <span class="s2">&quot;TimeOut&quot;</span><span class="p">:</span> <span class="mi">3600</span><span class="p">,</span> <span class="s2">&quot;Verbose&quot;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="s2">&quot;MatchValences&quot;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s2">&quot;MatchChiralTag&quot;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="s2">&quot;RingMatchesRingOnly&quot;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s2">&quot;CompleteRingsOnly&quot;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s2">&quot;AtomCompare&quot;</span><span class="p">:</span> <span class="n">rdFMCS</span><span class="o">.</span><span class="n">AtomCompare</span><span class="o">.</span><span class="n">CompareElements</span><span class="p">,</span> <span class="s2">&quot;BondCompare&quot;</span><span class="p">:</span> <span class="n">rdFMCS</span><span class="o">.</span><span class="n">BondCompare</span><span class="o">.</span><span class="n">CompareOrder</span><span class="p">,</span> <span class="s2">&quot;SeedSMARTS&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;MinNumAtoms&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;MinNumBonds&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
 1013     
 1014 <span class="k">def</span> <span class="nf">ProcessSpecifiedMCSParameters</span><span class="p">():</span>
 1015     <span class="sd">&quot;&quot;&quot;Process specified MCS parameters.&quot;&quot;&quot;</span>
 1016 
 1017     <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^auto$&quot;</span><span class="p">,</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;SpecifiedMCSParams&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
 1018         <span class="c1"># Nothing to process...</span>
 1019         <span class="k">return</span>
 1020     
 1021     <span class="c1"># Parse specified parameters...</span>
 1022     <span class="n">MCSParams</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;SpecifiedMCSParams&quot;</span><span class="p">])</span>
 1023     <span class="k">if</span> <span class="ow">not</span> <span class="n">MCSParams</span><span class="p">:</span>
 1024         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintError</span><span class="p">(</span><span class="s2">&quot;No valid parameter name and value pairs specified using </span><span class="se">\&quot;</span><span class="s2">-m, --mcsParams</span><span class="se">\&quot;</span><span class="s2"> option.&quot;</span><span class="p">)</span>
 1025 
 1026     <span class="n">MCSParamsWords</span> <span class="o">=</span> <span class="n">MCSParams</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
 1027     <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">MCSParamsWords</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span><span class="p">:</span>
 1028         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintError</span><span class="p">(</span><span class="s2">&quot;The number of comma delimited paramater names and values, </span><span class="si">%d</span><span class="s2">, specified using </span><span class="se">\&quot;</span><span class="s2">-m, --mcsParams</span><span class="se">\&quot;</span><span class="s2"> option must be an even number.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">MCSParamsWords</span><span class="p">)))</span>
 1029     
 1030     <span class="c1"># Setup  canonical parameter names...</span>
 1031     <span class="n">ValidParamNames</span> <span class="o">=</span> <span class="p">[]</span>
 1032     <span class="n">CanonicalParamNamesMap</span> <span class="o">=</span> <span class="p">{}</span>
 1033     <span class="k">for</span> <span class="n">ParamName</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;MCSParams&quot;</span><span class="p">]):</span>
 1034         <span class="n">ValidParamNames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ParamName</span><span class="p">)</span>
 1035         <span class="n">CanonicalParamNamesMap</span><span class="p">[</span><span class="n">ParamName</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span> <span class="o">=</span> <span class="n">ParamName</span>
 1036 
 1037     <span class="c1"># Validate and set paramater names and value...</span>
 1038     <span class="k">for</span> <span class="n">Index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">MCSParamsWords</span><span class="p">),</span> <span class="mi">2</span><span class="p">):</span>
 1039         <span class="n">Name</span> <span class="o">=</span> <span class="n">MCSParamsWords</span><span class="p">[</span><span class="n">Index</span><span class="p">]</span>
 1040         <span class="n">Value</span> <span class="o">=</span> <span class="n">MCSParamsWords</span><span class="p">[</span><span class="n">Index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
 1041 
 1042         <span class="n">CanonicalName</span> <span class="o">=</span> <span class="n">Name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
 1043         <span class="k">if</span>  <span class="ow">not</span> <span class="n">CanonicalName</span> <span class="ow">in</span> <span class="n">CanonicalParamNamesMap</span><span class="p">:</span>
 1044             <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintError</span><span class="p">(</span><span class="s2">&quot;The parameter name, </span><span class="si">%s</span><span class="s2">, specified using </span><span class="se">\&quot;</span><span class="s2">-m, --mcsParams</span><span class="se">\&quot;</span><span class="s2"> option is not a valid name. Supported parameter names: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">Name</span><span class="p">,</span>  <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ValidParamNames</span><span class="p">)))</span>
 1045 
 1046         <span class="n">ParamName</span> <span class="o">=</span> <span class="n">CanonicalParamNamesMap</span><span class="p">[</span><span class="n">CanonicalName</span><span class="p">]</span>
 1047         <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^Threshold$&quot;</span><span class="p">,</span> <span class="n">ParamName</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
 1048             <span class="n">Value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">Value</span><span class="p">)</span>
 1049             <span class="k">if</span> <span class="n">Value</span> <span class="o">&lt;=</span> <span class="mf">0.0</span> <span class="ow">or</span> <span class="n">Value</span> <span class="o">&gt;</span> <span class="mf">1.0</span> <span class="p">:</span>
 1050                 <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintError</span><span class="p">(</span><span class="s2">&quot;The parameter value, </span><span class="si">%s</span><span class="s2">, specified using </span><span class="se">\&quot;</span><span class="s2">-m, --mcsParams</span><span class="se">\&quot;</span><span class="s2"> option  for parameter, </span><span class="si">%s</span><span class="s2">, is not a valid value. Supported values: &gt; 0 and &lt;= 1.0&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">Value</span><span class="p">,</span> <span class="n">Name</span><span class="p">))</span>
 1051             <span class="n">ParamValue</span> <span class="o">=</span> <span class="n">Value</span>
 1052         <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^Timeout$&quot;</span><span class="p">,</span> <span class="n">ParamName</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
 1053             <span class="n">Value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">Value</span><span class="p">)</span>
 1054             <span class="k">if</span> <span class="n">Value</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
 1055                 <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintError</span><span class="p">(</span><span class="s2">&quot;The parameter value, </span><span class="si">%s</span><span class="s2">, specified using </span><span class="se">\&quot;</span><span class="s2">-m, --mcsParams</span><span class="se">\&quot;</span><span class="s2"> option  for parameter, </span><span class="si">%s</span><span class="s2">, is not a valid value. Supported values: &gt; 0&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">Value</span><span class="p">,</span> <span class="n">Name</span><span class="p">))</span>
 1056             <span class="n">ParamValue</span> <span class="o">=</span> <span class="n">Value</span>
 1057         <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^MinNumAtoms$&quot;</span><span class="p">,</span> <span class="n">ParamName</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
 1058             <span class="n">Value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">Value</span><span class="p">)</span>
 1059             <span class="k">if</span> <span class="n">Value</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
 1060                 <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintError</span><span class="p">(</span><span class="s2">&quot;The parameter value, </span><span class="si">%s</span><span class="s2">, specified using </span><span class="se">\&quot;</span><span class="s2">-m, --mcsParams</span><span class="se">\&quot;</span><span class="s2"> option  for parameter, </span><span class="si">%s</span><span class="s2">, is not a valid value. Supported values: &gt;= 1&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">Value</span><span class="p">,</span> <span class="n">Name</span><span class="p">))</span>
 1061             <span class="n">ParamValue</span> <span class="o">=</span> <span class="n">Value</span>
 1062         <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^MinNumBonds$&quot;</span><span class="p">,</span> <span class="n">ParamName</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
 1063             <span class="n">Value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">Value</span><span class="p">)</span>
 1064             <span class="k">if</span> <span class="n">Value</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
 1065                 <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintError</span><span class="p">(</span><span class="s2">&quot;The parameter value, </span><span class="si">%s</span><span class="s2">, specified using </span><span class="se">\&quot;</span><span class="s2">-m, --mcsParams</span><span class="se">\&quot;</span><span class="s2"> option  for parameter, </span><span class="si">%s</span><span class="s2">, is not a valid value. Supported values: &gt;=0 &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">Value</span><span class="p">,</span> <span class="n">Name</span><span class="p">))</span>
 1066             <span class="n">ParamValue</span> <span class="o">=</span> <span class="n">Value</span>
 1067         <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^AtomCompare$&quot;</span><span class="p">,</span> <span class="n">ParamName</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
 1068             <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^CompareAny$&quot;</span><span class="p">,</span> <span class="n">Value</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
 1069                 <span class="n">ParamValue</span> <span class="o">=</span> <span class="n">rdFMCS</span><span class="o">.</span><span class="n">AtomCompare</span><span class="o">.</span><span class="n">CompareAny</span>
 1070             <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^CompareElements$&quot;</span><span class="p">,</span> <span class="n">Value</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
 1071                 <span class="n">ParamValue</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">rdFMCS</span><span class="o">.</span><span class="n">AtomCompare</span><span class="o">.</span><span class="n">CompareElements</span>
 1072             <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^CompareIsotopes$&quot;</span><span class="p">,</span> <span class="n">Value</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
 1073                 <span class="n">ParamValue</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">rdFMCS</span><span class="o">.</span><span class="n">AtomCompare</span><span class="o">.</span><span class="n">CompareIsotopes</span>
 1074             <span class="k">else</span><span class="p">:</span>
 1075                 <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintError</span><span class="p">(</span><span class="s2">&quot;The parameter value, </span><span class="si">%s</span><span class="s2">, specified using </span><span class="se">\&quot;</span><span class="s2">-m, --mcsParams</span><span class="se">\&quot;</span><span class="s2"> option  for parameter, </span><span class="si">%s</span><span class="s2">, is not a valid value. Supported values: CompareAny CompareElements CompareIsotopes&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">Value</span><span class="p">,</span> <span class="n">Name</span><span class="p">))</span>
 1076         <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^BondCompare$&quot;</span><span class="p">,</span> <span class="n">ParamName</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
 1077             <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^CompareAny$&quot;</span><span class="p">,</span> <span class="n">Value</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
 1078                 <span class="n">ParamValue</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">rdFMCS</span><span class="o">.</span><span class="n">BondCompare</span><span class="o">.</span><span class="n">CompareAny</span>
 1079             <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^CompareOrder$&quot;</span><span class="p">,</span> <span class="n">Value</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
 1080                 <span class="n">ParamValue</span> <span class="o">=</span> <span class="n">rdFMCS</span><span class="o">.</span><span class="n">BondCompare</span><span class="o">.</span><span class="n">CompareOrder</span>
 1081             <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^CompareOrderExact$&quot;</span><span class="p">,</span> <span class="n">Value</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
 1082                 <span class="n">ParamValue</span> <span class="o">=</span> <span class="n">rdFMCS</span><span class="o">.</span><span class="n">BondCompare</span><span class="o">.</span><span class="n">CompareOrderExact</span>
 1083             <span class="k">else</span><span class="p">:</span>
 1084                 <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintError</span><span class="p">(</span><span class="s2">&quot;The parameter value, </span><span class="si">%s</span><span class="s2">, specified using </span><span class="se">\&quot;</span><span class="s2">-m, --mcsParams</span><span class="se">\&quot;</span><span class="s2"> option  for parameter, </span><span class="si">%s</span><span class="s2">, is not a valid value. Supported values: CompareAny CompareOrder CompareOrderExact&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">Value</span><span class="p">,</span> <span class="n">Name</span><span class="p">))</span>
 1085         <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^SeedSMARTS$&quot;</span><span class="p">,</span> <span class="n">ParamName</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
 1086             <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">Value</span><span class="p">):</span>
 1087                 <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintError</span><span class="p">(</span><span class="s2">&quot;The parameter value specified using </span><span class="se">\&quot;</span><span class="s2">-m, --mcsParams</span><span class="se">\&quot;</span><span class="s2"> option  for parameter, </span><span class="si">%s</span><span class="s2">, is empty. &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">Name</span><span class="p">))</span>
 1088             <span class="n">ParamValue</span> <span class="o">=</span> <span class="n">Value</span>
 1089         <span class="k">else</span><span class="p">:</span>
 1090             <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^(Yes|No|True|False)$&quot;</span><span class="p">,</span> <span class="n">Value</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
 1091                 <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintError</span><span class="p">(</span><span class="s2">&quot;The parameter value, </span><span class="si">%s</span><span class="s2">, specified using </span><span class="se">\&quot;</span><span class="s2">-m, --mcsParams</span><span class="se">\&quot;</span><span class="s2"> option  for parameter, </span><span class="si">%s</span><span class="s2">, is not a valid value. Supported values: Yes No True False&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">Value</span><span class="p">,</span> <span class="n">Name</span><span class="p">))</span>
 1092             <span class="n">ParamValue</span> <span class="o">=</span> <span class="bp">False</span>
 1093             <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^(Yes|True)$&quot;</span><span class="p">,</span> <span class="n">Value</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
 1094                 <span class="n">ParamValue</span> <span class="o">=</span> <span class="bp">True</span>
 1095         
 1096         <span class="c1"># Set value...</span>
 1097         <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;MCSParams&quot;</span><span class="p">][</span><span class="n">ParamName</span><span class="p">]</span> <span class="o">=</span> <span class="n">ParamValue</span>
 1098 
 1099 <span class="k">def</span> <span class="nf">ProcessOptions</span><span class="p">():</span>
 1100     <span class="sd">&quot;&quot;&quot;Process and validate command line arguments and options.&quot;&quot;&quot;</span>
 1101     
 1102     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;Processing options...&quot;</span><span class="p">)</span>
 1103     
 1104     <span class="c1"># Validate options...</span>
 1105     <span class="n">ValidateOptions</span><span class="p">()</span>
 1106 
 1107     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Infile&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--infile&quot;</span><span class="p">]</span>
 1108     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;SMILESInfileStatus&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span> <span class="k">if</span>  <span class="n">MiscUtil</span><span class="o">.</span><span class="n">CheckFileExt</span><span class="p">(</span><span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--infile&quot;</span><span class="p">],</span> <span class="s2">&quot;smi csv tsv txt&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="bp">False</span>
 1109     <span class="n">ParamsDefaultInfoOverride</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;RemoveHydrogens&quot;</span><span class="p">:</span> <span class="bp">False</span><span class="p">}</span>
 1110     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;InfileParams&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ProcessOptionInfileParameters</span><span class="p">(</span><span class="s2">&quot;--infileParams&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--infileParams&quot;</span><span class="p">],</span> <span class="n">InfileName</span> <span class="o">=</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--infile&quot;</span><span class="p">],</span> <span class="n">ParamsDefaultInfo</span> <span class="o">=</span> <span class="n">ParamsDefaultInfoOverride</span><span class="p">)</span>
 1111 
 1112     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;RefFile&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--reffile&quot;</span><span class="p">]</span>
 1113 
 1114     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Outfile&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--outfile&quot;</span><span class="p">]</span>
 1115     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;OutfileParams&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ProcessOptionOutfileParameters</span><span class="p">(</span><span class="s2">&quot;--outfileParams&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--outfileParams&quot;</span><span class="p">])</span>
 1116     
 1117     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Overwrite&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--overwrite&quot;</span><span class="p">]</span>
 1118     
 1119     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Scaffold&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--scaffold&quot;</span><span class="p">]</span>
 1120     <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^auto$&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--scaffold&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
 1121         <span class="n">UseScaffoldMCS</span> <span class="o">=</span> <span class="bp">True</span>
 1122         <span class="n">UseScaffoldSMARTS</span> <span class="o">=</span> <span class="bp">False</span>
 1123         <span class="n">ScaffoldSMARTS</span> <span class="o">=</span> <span class="bp">None</span>
 1124     <span class="k">else</span><span class="p">:</span>
 1125         <span class="n">UseScaffoldMCS</span> <span class="o">=</span> <span class="bp">False</span>
 1126         <span class="n">UseScaffoldSMARTS</span> <span class="o">=</span> <span class="bp">True</span>
 1127         <span class="n">ScaffoldSMARTS</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Scaffold&quot;</span><span class="p">]</span>
 1128     
 1129     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;UseScaffoldMCS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">UseScaffoldMCS</span>
 1130     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;UseScaffoldSMARTS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">UseScaffoldSMARTS</span>
 1131     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;ScaffoldSMARTS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ScaffoldSMARTS</span>
 1132     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;ScaffoldPatternMol&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
 1133 
 1134     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;SpecifiedMCSParams&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--mcsParams&quot;</span><span class="p">]</span>
 1135     <span class="n">ProcessMCSParameters</span><span class="p">()</span>
 1136     
 1137     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;ScaffoldRMSDOut&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^yes$&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--scaffoldRMSDOut&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span> <span class="k">else</span> <span class="bp">False</span>
 1138     
 1139     <span class="c1"># Method, basis set, and reference wavefunction...</span>
 1140     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;BasisSet&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--basisSet&quot;</span><span class="p">]</span>
 1141     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;BasisSetAuto&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^auto$&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--basisSet&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span> <span class="k">else</span> <span class="bp">False</span>
 1142     
 1143     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;MethodName&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--methodName&quot;</span><span class="p">]</span>
 1144     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;MethodNameAuto&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^auto$&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--methodName&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span> <span class="k">else</span> <span class="bp">False</span>
 1145     
 1146     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Reference&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--reference&quot;</span><span class="p">]</span>
 1147     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;ReferenceAuto&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^auto$&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--reference&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span> <span class="k">else</span> <span class="bp">False</span>
 1148     
 1149     <span class="c1"># Run and options parameters...</span>
 1150     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Psi4OptionsParams&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Psi4Util</span><span class="o">.</span><span class="n">ProcessPsi4OptionsParameters</span><span class="p">(</span><span class="s2">&quot;--psi4OptionsParams&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--psi4OptionsParams&quot;</span><span class="p">])</span>
 1151     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Psi4RunParams&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Psi4Util</span><span class="o">.</span><span class="n">ProcessPsi4RunParameters</span><span class="p">(</span><span class="s2">&quot;--psi4RunParams&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--psi4RunParams&quot;</span><span class="p">],</span> <span class="n">InfileName</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Infile&quot;</span><span class="p">])</span>
 1152 
 1153     <span class="c1"># Conformer generation paramaters...</span>
 1154     <span class="n">ParamsDefaultInfoOverride</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;MaxConfs&quot;</span><span class="p">:</span> <span class="mi">50</span><span class="p">}</span>
 1155     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;ConfGenerationParams&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ProcessOptionConformerParameters</span><span class="p">(</span><span class="s2">&quot;--confParams&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--confParams&quot;</span><span class="p">],</span> <span class="n">ParamsDefaultInfoOverride</span><span class="p">)</span>
 1156     
 1157     <span class="c1"># Write energy parameters...</span>
 1158     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;EnergyOut&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^yes$&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--energyOut&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span> <span class="k">else</span> <span class="bp">False</span>
 1159     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;EnergyUnits&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--energyUnits&quot;</span><span class="p">]</span>
 1160     
 1161     <span class="n">EnergyDataFieldLabel</span> <span class="o">=</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--energyDataFieldLabel&quot;</span><span class="p">]</span>
 1162     <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^auto$&quot;</span><span class="p">,</span> <span class="n">EnergyDataFieldLabel</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
 1163         <span class="n">EnergyDataFieldLabel</span> <span class="o">=</span> <span class="s2">&quot;Psi4_Energy (</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--energyUnits&quot;</span><span class="p">]</span>
 1164     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;EnergyDataFieldLabel&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">EnergyDataFieldLabel</span>
 1165     
 1166     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;EnergyRMSDCalcMode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--energyRMSDCalcMode&quot;</span><span class="p">]</span>
 1167     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;EnergyRMSDCalcModeBest&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^BestRMSD$&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--energyRMSDCalcMode&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span> <span class="k">else</span> <span class="bp">False</span>
 1168     
 1169     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;EnergyRMSDCutoff&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--energyRMSDCutoff&quot;</span><span class="p">])</span>
 1170     
 1171     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;EnergyRMSDCutoffMode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--energyRMSDCutoffMode&quot;</span><span class="p">]</span>
 1172     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;EnergyRMSDCutoffModeLowest&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^Lowest$&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--energyRMSDCutoffMode&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span> <span class="k">else</span> <span class="bp">False</span>
 1173     
 1174     <span class="c1"># Process energy window...</span>
 1175     <span class="n">EnergyWindow</span> <span class="o">=</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--energyWindow&quot;</span><span class="p">]</span>
 1176     <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^auto$&quot;</span><span class="p">,</span> <span class="n">EnergyWindow</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
 1177         <span class="c1"># Set default energy window based on units...</span>
 1178         <span class="n">EnergyUnits</span> <span class="o">=</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--energyUnits&quot;</span><span class="p">]</span>
 1179         <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^kcal\/mol$&quot;</span><span class="p">,</span> <span class="n">EnergyUnits</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
 1180             <span class="n">EnergyWindow</span> <span class="o">=</span> <span class="mi">20</span>
 1181         <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^kJ\/mol$&quot;</span><span class="p">,</span> <span class="n">EnergyUnits</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
 1182             <span class="n">EnergyWindow</span> <span class="o">=</span> <span class="mf">83.68</span>
 1183         <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^eV$&quot;</span><span class="p">,</span> <span class="n">EnergyUnits</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
 1184             <span class="n">EnergyWindow</span> <span class="o">=</span> <span class="mf">0.8673</span>
 1185         <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^Hartrees$&quot;</span><span class="p">,</span> <span class="n">EnergyUnits</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
 1186             <span class="n">EnergyWindow</span> <span class="o">=</span> <span class="mf">0.03188</span>
 1187         <span class="k">else</span><span class="p">:</span>
 1188             <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintError</span><span class="p">(</span><span class="s2">&quot;Failed to set default value for </span><span class="se">\&quot;</span><span class="s2">--energyWindow</span><span class="se">\&quot;</span><span class="s2">. The value, </span><span class="si">%s</span><span class="s2">, specified for option </span><span class="se">\&quot;</span><span class="s2">--energyUnits</span><span class="se">\&quot;</span><span class="s2"> is not valid. &quot;</span> <span class="o">%</span> <span class="n">EnergyUnits</span><span class="p">)</span>
 1189     <span class="k">else</span><span class="p">:</span>
 1190         <span class="n">EnergyWindow</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">EnergyWindow</span><span class="p">)</span>
 1191     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;EnergyWindow&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">EnergyWindow</span>
 1192 
 1193     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;MaxIters&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--maxIters&quot;</span><span class="p">])</span>
 1194 
 1195     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;MPMode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^yes$&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--mp&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span> <span class="k">else</span> <span class="bp">False</span>
 1196     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;MPParams&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ProcessOptionMultiprocessingParameters</span><span class="p">(</span><span class="s2">&quot;--mpParams&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--mpParams&quot;</span><span class="p">])</span>
 1197 
 1198     <span class="c1"># Multiprocessing level...</span>
 1199     <span class="n">MPLevelMoleculesMode</span> <span class="o">=</span> <span class="bp">False</span>
 1200     <span class="n">MPLevelConformersMode</span> <span class="o">=</span> <span class="bp">False</span>
 1201     <span class="n">MPLevel</span> <span class="o">=</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--mpLevel&quot;</span><span class="p">]</span>
 1202     <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^Molecules$&quot;</span><span class="p">,</span> <span class="n">MPLevel</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
 1203         <span class="n">MPLevelMoleculesMode</span> <span class="o">=</span> <span class="bp">True</span>
 1204     <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^Conformers$&quot;</span><span class="p">,</span> <span class="n">MPLevel</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
 1205         <span class="n">MPLevelConformersMode</span> <span class="o">=</span> <span class="bp">True</span>
 1206     <span class="k">else</span><span class="p">:</span>
 1207         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintError</span><span class="p">(</span><span class="s2">&quot;The value, </span><span class="si">%s</span><span class="s2">, specified for option </span><span class="se">\&quot;</span><span class="s2">--mpLevel</span><span class="se">\&quot;</span><span class="s2"> is not valid. &quot;</span> <span class="o">%</span> <span class="n">MPLevel</span><span class="p">)</span>
 1208     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;MPLevel&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">MPLevel</span>
 1209     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;MPLevelMoleculesMode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">MPLevelMoleculesMode</span>
 1210     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;MPLevelConformersMode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">MPLevelConformersMode</span>
 1211     
 1212     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Precision&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--precision&quot;</span><span class="p">])</span>
 1213     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^yes$&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--quiet&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span> <span class="k">else</span> <span class="bp">False</span>
 1214 
 1215 <span class="k">def</span> <span class="nf">RetrieveOptions</span><span class="p">():</span>
 1216     <span class="sd">&quot;&quot;&quot;Retrieve command line arguments and options.&quot;&quot;&quot;</span>
 1217     
 1218     <span class="c1"># Get options...</span>
 1219     <span class="k">global</span> <span class="n">Options</span>
 1220     <span class="n">Options</span> <span class="o">=</span> <span class="n">docopt</span><span class="p">(</span><span class="n">_docoptUsage_</span><span class="p">)</span>
 1221 
 1222     <span class="c1"># Set current working directory to the specified directory...</span>
 1223     <span class="n">WorkingDir</span> <span class="o">=</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--workingdir&quot;</span><span class="p">]</span>
 1224     <span class="k">if</span> <span class="n">WorkingDir</span><span class="p">:</span>
 1225         <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">WorkingDir</span><span class="p">)</span>
 1226     
 1227     <span class="c1"># Handle examples option...</span>
 1228     <span class="k">if</span> <span class="s2">&quot;--examples&quot;</span> <span class="ow">in</span> <span class="n">Options</span> <span class="ow">and</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--examples&quot;</span><span class="p">]:</span>
 1229         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="n">MiscUtil</span><span class="o">.</span><span class="n">GetExamplesTextFromDocOptText</span><span class="p">(</span><span class="n">_docoptUsage_</span><span class="p">))</span>
 1230         <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
 1231 
 1232 <span class="k">def</span> <span class="nf">ValidateOptions</span><span class="p">():</span>
 1233     <span class="sd">&quot;&quot;&quot;Validate option values.&quot;&quot;&quot;</span>
 1234 
 1235     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ValidateOptionTextValue</span><span class="p">(</span><span class="s2">&quot;--energyOut&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--energyOut&quot;</span><span class="p">],</span> <span class="s2">&quot;yes no&quot;</span><span class="p">)</span>
 1236     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ValidateOptionTextValue</span><span class="p">(</span><span class="s2">&quot;--energyUnits&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--energyUnits&quot;</span><span class="p">],</span> <span class="s2">&quot;Hartrees kcal/mol kJ/mol eV&quot;</span><span class="p">)</span>
 1237     
 1238     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ValidateOptionTextValue</span><span class="p">(</span><span class="s2">&quot; --energyRMSDCalcMode&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--energyRMSDCalcMode&quot;</span><span class="p">],</span> <span class="s2">&quot;RMSD BestRMSD&quot;</span><span class="p">)</span>
 1239     
 1240     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ValidateOptionFloatValue</span><span class="p">(</span><span class="s2">&quot;--energyRMSDCutoff&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--energyRMSDCutoff&quot;</span><span class="p">],</span> <span class="p">{</span><span class="s2">&quot;&gt;=&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span>
 1241     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ValidateOptionTextValue</span><span class="p">(</span><span class="s2">&quot; --energyRMSDCutoffMode&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--energyRMSDCutoffMode&quot;</span><span class="p">],</span> <span class="s2">&quot;All Lowest&quot;</span><span class="p">)</span>
 1242     
 1243     <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^auto$&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--energyWindow&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
 1244         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ValidateOptionFloatValue</span><span class="p">(</span><span class="s2">&quot;--energyWindow&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--energyWindow&quot;</span><span class="p">],</span> <span class="p">{</span><span class="s2">&quot;&gt;&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span>
 1245     
 1246     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ValidateOptionFilePath</span><span class="p">(</span><span class="s2">&quot;-i, --infile&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--infile&quot;</span><span class="p">])</span>
 1247     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ValidateOptionFileExt</span><span class="p">(</span><span class="s2">&quot;-i, --infile&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--infile&quot;</span><span class="p">],</span> <span class="s2">&quot;sdf sd mol smi txt csv tsv&quot;</span><span class="p">)</span>
 1248     
 1249     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ValidateOptionFilePath</span><span class="p">(</span><span class="s2">&quot;-r, --reffile&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--reffile&quot;</span><span class="p">])</span>
 1250     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ValidateOptionFileExt</span><span class="p">(</span><span class="s2">&quot;-r, --reffile&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--reffile&quot;</span><span class="p">],</span> <span class="s2">&quot;sdf sd mol&quot;</span><span class="p">)</span>
 1251     
 1252     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ValidateOptionIntegerValue</span><span class="p">(</span><span class="s2">&quot;--maxIters&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--maxIters&quot;</span><span class="p">],</span> <span class="p">{</span><span class="s2">&quot;&gt;&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span>
 1253     
 1254     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ValidateOptionFileExt</span><span class="p">(</span><span class="s2">&quot;-o, --outfile&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--outfile&quot;</span><span class="p">],</span> <span class="s2">&quot;sdf sd&quot;</span><span class="p">)</span>
 1255     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ValidateOptionsOutputFileOverwrite</span><span class="p">(</span><span class="s2">&quot;-o, --outfile&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--outfile&quot;</span><span class="p">],</span> <span class="s2">&quot;--overwrite&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--overwrite&quot;</span><span class="p">])</span>
 1256     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ValidateOptionsDistinctFileNames</span><span class="p">(</span><span class="s2">&quot;-i, --infile&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--infile&quot;</span><span class="p">],</span> <span class="s2">&quot;-o, --outfile&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--outfile&quot;</span><span class="p">])</span>
 1257     
 1258     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ValidateOptionTextValue</span><span class="p">(</span><span class="s2">&quot;--mp&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--mp&quot;</span><span class="p">],</span> <span class="s2">&quot;yes no&quot;</span><span class="p">)</span>
 1259     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ValidateOptionTextValue</span><span class="p">(</span><span class="s2">&quot;--mpLevel&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--mpLevel&quot;</span><span class="p">],</span> <span class="s2">&quot;Molecules Conformers&quot;</span><span class="p">)</span>
 1260     
 1261     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ValidateOptionIntegerValue</span><span class="p">(</span><span class="s2">&quot;-p, --precision&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--precision&quot;</span><span class="p">],</span> <span class="p">{</span><span class="s2">&quot;&gt;&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span>
 1262     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ValidateOptionTextValue</span><span class="p">(</span><span class="s2">&quot;-q, --quiet&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--quiet&quot;</span><span class="p">],</span> <span class="s2">&quot;yes no&quot;</span><span class="p">)</span>
 1263     
 1264     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ValidateOptionTextValue</span><span class="p">(</span><span class="s2">&quot;--scaffoldRMSDOut&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--scaffoldRMSDOut&quot;</span><span class="p">],</span> <span class="s2">&quot;yes no&quot;</span><span class="p">)</span>
 1265     
 1266 <span class="c1"># Setup a usage string for docopt...</span>
 1267 <span class="n">_docoptUsage_</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
 1268 <span class="s2">Psi4GenerateConstrainedConformers.py - Generate constrained molecular conformations</span>
 1269 
 1270 <span class="s2">Usage:</span>
 1271 <span class="s2">    Psi4GenerateConstrainedConformers.py [--basisSet &lt;text&gt;] [--confParams &lt;Name,Value,...&gt;] [--energyOut &lt;yes or no&gt;]</span>
 1272 <span class="s2">                                         [--energyDataFieldLabel &lt;text&gt;] [--energyUnits &lt;text&gt;] [--energyRMSDCalcMode &lt;RMSD or BestRMSD&gt;]</span>
 1273 <span class="s2">                                         [--energyRMSDCutoff &lt;number&gt;] [--energyRMSDCutoffMode &lt;All or Lowest&gt;] [--energyWindow &lt;number&gt;]</span>
 1274 <span class="s2">                                         [--infileParams &lt;Name,Value,...&gt;] [--maxIters &lt;number&gt;] [--methodName &lt;text&gt;] [--mcsParams &lt;Name,Value,...&gt;]</span>
 1275 <span class="s2">                                         [--mp &lt;yes or no&gt;] [--mpLevel &lt;Molecules or Conformers&gt;] [--mpParams &lt;Name, Value,...&gt;]</span>
 1276 <span class="s2">                                         [ --outfileParams &lt;Name,Value,...&gt; ] [--overwrite] [--precision &lt;number&gt; ]</span>
 1277 <span class="s2">                                         [--psi4OptionsParams &lt;Name,Value,...&gt;] [--psi4RunParams &lt;Name,Value,...&gt;]</span>
 1278 <span class="s2">                                         [--quiet &lt;yes or no&gt;]  [--reference &lt;text&gt;] [--scaffold &lt;auto or SMARTS&gt;]</span>
 1279 <span class="s2">                                         [--scaffoldRMSDOut &lt;yes or no&gt;] [-w &lt;dir&gt;] -i &lt;infile&gt; -r &lt;reffile&gt; -o &lt;outfile&gt; </span>
 1280 <span class="s2">    Psi4GenerateConstrainedConformers.py -h | --help | -e | --examples</span>
 1281 
 1282 <span class="s2">Description:</span>
 1283 <span class="s2">    Generate molecular conformations  by performing a constrained energy</span>
 1284 <span class="s2">    minimization against a reference molecule. The molecular conformations</span>
 1285 <span class="s2">    are generated using a combination of distance geometry and forcefield</span>
 1286 <span class="s2">    minimization followed by geometry optimization using a quantum chemistry</span>
 1287 <span class="s2">    method.</span>
 1288 
 1289 <span class="s2">    An initial set of 3D conformers are generated for input molecules using</span>
 1290 <span class="s2">    distance geometry. A common core scaffold, corresponding to a Maximum</span>
 1291 <span class="s2">    Common Substructure (MCS) or an explicit SMARTS pattern,  is identified</span>
 1292 <span class="s2">    between a pair of input and reference molecules. The core scaffold atoms in</span>
 1293 <span class="s2">    input molecules are aligned against the same atoms in the reference molecule.</span>
 1294 <span class="s2">    The energy of aligned structures are sequentially minimized using the forcefield</span>
 1295 <span class="s2">    and a quantum chemistry method to generate the final 3D structures.</span>
 1296 
 1297 <span class="s2">    A Psi4 XYZ format geometry string is automatically generated for each molecule</span>
 1298 <span class="s2">    in input file. It contains atom symbols and 3D coordinates for each atom in a</span>
 1299 <span class="s2">    molecule. In addition, the formal charge and spin multiplicity are present in the</span>
 1300 <span class="s2">    the geometry string. These values are either retrieved from molecule properties</span>
 1301 <span class="s2">    named &#39;FormalCharge&#39; and &#39;SpinMultiplicty&#39; or dynamically calculated for a</span>
 1302 <span class="s2">    molecule.</span>
 1303 
 1304 <span class="s2">    The supported input file formats are: Mol (.mol), SD (.sdf, .sd), SMILES (.smi,</span>
 1305 <span class="s2">    .csv, .tsv, .txt)</span>
 1306 
 1307 <span class="s2">    The supported output file formats are: SD (.sdf, .sd)</span>
 1308 
 1309 <span class="s2">Options:</span>
 1310 <span class="s2">    -b, --basisSet &lt;text&gt;  [default: auto]</span>
 1311 <span class="s2">        Basis set to use for constrained energy minimization. Default: 6-31+G**</span>
 1312 <span class="s2">        for sulfur containing molecules; Otherwise, 6-31G** [ Ref 150 ]. The specified </span>
 1313 <span class="s2">        value must be a valid Psi4 basis set. No validation is performed.</span>
 1314 <span class="s2">        </span>
 1315 <span class="s2">        The following list shows a representative sample of basis sets available</span>
 1316 <span class="s2">        in Psi4:</span>
 1317 <span class="s2">            </span>
 1318 <span class="s2">            STO-3G, 6-31G, 6-31+G, 6-31++G, 6-31G*, 6-31+G*,  6-31++G*, </span>
 1319 <span class="s2">            6-31G**, 6-31+G**, 6-31++G**, 6-311G, 6-311+G, 6-311++G,</span>
 1320 <span class="s2">            6-311G*, 6-311+G*, 6-311++G*, 6-311G**, 6-311+G**, 6-311++G**,</span>
 1321 <span class="s2">            cc-pVDZ, cc-pCVDZ, aug-cc-pVDZ, cc-pVDZ-DK, cc-pCVDZ-DK, def2-SVP,</span>
 1322 <span class="s2">            def2-SVPD, def2-TZVP, def2-TZVPD, def2-TZVPP, def2-TZVPPD</span>
 1323 <span class="s2">            </span>
 1324 <span class="s2">    --confParams &lt;Name,Value,...&gt;  [default: auto]</span>
 1325 <span class="s2">        A comma delimited list of parameter name and value pairs for generating</span>
 1326 <span class="s2">        initial 3D coordinates for molecules in input file. A common core scaffold is</span>
 1327 <span class="s2">        identified between a pair of input and reference molecules. The atoms in</span>
 1328 <span class="s2">        common core scaffold of input molecules are aligned against the reference</span>
 1329 <span class="s2">        molecule followed by constrained energy minimization using forcefield</span>
 1330 <span class="s2">        available in RDKit. The 3D structures are subsequently constrained and </span>
 1331 <span class="s2">        minimized by a quantum chemistry method available in Psi4.</span>
 1332 <span class="s2">        </span>
 1333 <span class="s2">        The supported parameter names along with their default values are shown</span>
 1334 <span class="s2">        below:</span>
 1335 <span class="s2">            </span>
 1336 <span class="s2">            confMethod,ETKDG,</span>
 1337 <span class="s2">            forceField,MMFF, forceFieldMMFFVariant,MMFF94,</span>
 1338 <span class="s2">            enforceChirality,yes,embedRMSDCutoff,0.5,maxConfs,50,</span>
 1339 <span class="s2">            useTethers,yes</span>
 1340 <span class="s2">            </span>
 1341 <span class="s2">            confMethod,ETKDG   [ Possible values: SDG, ETDG, KDG, ETKDG ]</span>
 1342 <span class="s2">            forceField, MMFF   [ Possible values: UFF or MMFF ]</span>
 1343 <span class="s2">            forceFieldMMFFVariant,MMFF94   [ Possible values: MMFF94 or MMFF94s ]</span>
 1344 <span class="s2">            enforceChirality,yes   [ Possible values: yes or no ]</span>
 1345 <span class="s2">            useTethers,yes   [ Possible values: yes or no ]</span>
 1346 <span class="s2">            </span>
 1347 <span class="s2">        confMethod: Conformation generation methodology for generating initial 3D</span>
 1348 <span class="s2">        coordinates. Possible values: Standard Distance Geometry (SDG), Experimental</span>
 1349 <span class="s2">        Torsion-angle preference with Distance Geometry (ETDG), basic Knowledge-terms</span>
 1350 <span class="s2">        with Distance Geometry (KDG) and Experimental Torsion-angle preference</span>
 1351 <span class="s2">        along with basic Knowledge-terms with Distance Geometry (ETKDG) [Ref 129] .</span>
 1352 <span class="s2">        </span>
 1353 <span class="s2">        forceField: Forcefield method to use for constrained energy minimization.</span>
 1354 <span class="s2">        Possible values: Universal Force Field (UFF) [ Ref 81 ] or Merck Molecular</span>
 1355 <span class="s2">        Mechanics Force Field [ Ref 83-87 ] .</span>
 1356 <span class="s2">        </span>
 1357 <span class="s2">        enforceChirality: Enforce chirality for defined chiral centers during</span>
 1358 <span class="s2">        forcefield minimization.</span>
 1359 <span class="s2">        </span>
 1360 <span class="s2">        maxConfs: Maximum number of conformations to generate for each molecule</span>
 1361 <span class="s2">        during the generation of an initial 3D conformation ensemble using conformation</span>
 1362 <span class="s2">        generation methodology. The conformations are constrained and minimized using</span>
 1363 <span class="s2">        the specified forcefield and a quantum chemistry method. The lowest energy</span>
 1364 <span class="s2">        conformation is written to the output file.</span>
 1365 <span class="s2">        </span>
 1366 <span class="s2">        embedRMSDCutoff: RMSD cutoff for retaining initial set of conformers embedded</span>
 1367 <span class="s2">        using distance geometry and forcefield minimization. All embedded conformers</span>
 1368 <span class="s2">        are kept for &#39;None&#39; value. Otherwise, only those conformers which are different</span>
 1369 <span class="s2">        from each other by the specified RMSD cutoff, 0.5 by default, are kept. The first</span>
 1370 <span class="s2">        embedded conformer is always retained.</span>
 1371 <span class="s2">        </span>
 1372 <span class="s2">        useTethers: Use tethers to optimize the final embedded conformation by</span>
 1373 <span class="s2">        applying a series of extra forces to align matching atoms to the positions of</span>
 1374 <span class="s2">        the core atoms. Otherwise, use simple distance constraints during the</span>
 1375 <span class="s2">        optimization.</span>
 1376 <span class="s2">    --energyOut &lt;yes or no&gt;  [default: yes]</span>
 1377 <span class="s2">        Write out energy values.</span>
 1378 <span class="s2">    --energyDataFieldLabel &lt;text&gt;  [default: auto]</span>
 1379 <span class="s2">        Energy data field label for writing energy values. Default: Psi4_Energy (&lt;Units&gt;). </span>
 1380 <span class="s2">    --energyUnits &lt;text&gt;  [default: kcal/mol]</span>
 1381 <span class="s2">        Energy units. Possible values: Hartrees, kcal/mol, kJ/mol, or eV.</span>
 1382 <span class="s2">    --energyRMSDCalcMode &lt;RMSD or BestRMSD&gt;  [default: RMSD]</span>
 1383 <span class="s2">        Methodology for calculating RMSD values during the application of RMSD</span>
 1384 <span class="s2">        cutoff for retaining conformations after the final energy minimization. Possible</span>
 1385 <span class="s2">        values: RMSD or BestRMSD. This option is ignore during &#39;None&#39; value of</span>
 1386 <span class="s2">        &#39;--energyRMSDCutoff&#39; option.</span>
 1387 <span class="s2">        </span>
 1388 <span class="s2">        During BestRMSMode mode, the RDKit &#39;function AllChem.GetBestRMS&#39; is used to</span>
 1389 <span class="s2">        align and calculate RMSD. This function calculates optimal RMSD for aligning two</span>
 1390 <span class="s2">        molecules, taking symmetry into account. Otherwise, the RMSD value is calculated</span>
 1391 <span class="s2">        using &#39;AllChem.GetConformerRMS&#39; without changing the atom order. A word to the</span>
 1392 <span class="s2">        wise from RDKit documentation: The AllChem.GetBestRMS function will attempt to</span>
 1393 <span class="s2">        align all permutations of matching atom orders in both molecules, for some molecules</span>
 1394 <span class="s2">        it will lead to &#39;combinatorial explosion&#39;.</span>
 1395 <span class="s2">    --energyRMSDCutoff &lt;number&gt;  [default: 0.5]</span>
 1396 <span class="s2">        RMSD cutoff for retaining conformations after the final energy minimization.</span>
 1397 <span class="s2">        By default, only those conformations which are different from other low</span>
 1398 <span class="s2">        energy conformation by the specified RMSD cutoff and are with in the </span>
 1399 <span class="s2">        specified energy window are kept. The lowest energy conformation is always</span>
 1400 <span class="s2">        retained. A value of zero keeps all minimized conformations with in the</span>
 1401 <span class="s2">        specified energy window from the lowest energy.</span>
 1402 <span class="s2">    --energyRMSDCutoffMode &lt;All or Lowest&gt;  [default: All]</span>
 1403 <span class="s2">        RMSD cutoff mode for  retaining conformations after the final energy</span>
 1404 <span class="s2">        minimization. Possible values: All or Lowest. The RMSD values are compared</span>
 1405 <span class="s2">        against all the selected conformations or the lowest energy conformation during</span>
 1406 <span class="s2">        &#39;All&#39; and &#39;Lowest&#39; value of &#39;--energyRMSDCutoffMode&#39;. This option is ignored</span>
 1407 <span class="s2">        during zero value of &#39;--energyRMSDCutoff&#39;.</span>
 1408 <span class="s2">        </span>
 1409 <span class="s2">        By default, only those conformations which all different from all selected</span>
 1410 <span class="s2">        low energy conformations by the specified RMSD cutoff and are with in the</span>
 1411 <span class="s2">        specified energy window are kept.</span>
 1412 <span class="s2">    --energyWindow &lt;number&gt;  [default: auto]</span>
 1413 <span class="s2">        Psi4 Energy window  for selecting conformers after the final energy minimization.</span>
 1414 <span class="s2">        The default value is dependent on &#39;--energyUnits&#39;: 20 kcal/mol, 83.68 kJ/mol,</span>
 1415 <span class="s2">        0.8673 ev, or 0.03188 Hartrees. The specified value must be in &#39;--energyUnits&#39;.</span>
 1416 <span class="s2">    -e, --examples</span>
 1417 <span class="s2">        Print examples.</span>
 1418 <span class="s2">    -h, --help</span>
 1419 <span class="s2">        Print this help message.</span>
 1420 <span class="s2">    -i, --infile &lt;infile&gt;</span>
 1421 <span class="s2">        Input file name.</span>
 1422 <span class="s2">    --infileParams &lt;Name,Value,...&gt;  [default: auto]</span>
 1423 <span class="s2">        A comma delimited list of parameter name and value pairs for reading</span>
 1424 <span class="s2">        molecules from files. The supported parameter names for different file</span>
 1425 <span class="s2">        formats, along with their default values, are shown below:</span>
 1426 <span class="s2">            </span>
 1427 <span class="s2">            SD, MOL: removeHydrogens,no,sanitize,yes,strictParsing,yes</span>
 1428 <span class="s2">            </span>
 1429 <span class="s2">            SMILES: smilesColumn,1,smilesNameColumn,2,smilesDelimiter,space,</span>
 1430 <span class="s2">                smilesTitleLine,auto,sanitize,yes</span>
 1431 <span class="s2">            </span>
 1432 <span class="s2">        Possible values for smilesDelimiter: space, comma or tab.</span>
 1433 <span class="s2">    --maxIters &lt;number&gt;  [default: 50]</span>
 1434 <span class="s2">        Maximum number of iterations to perform for each molecule or conformer</span>
 1435 <span class="s2">        during energy minimization by a quantum chemistry method.</span>
 1436 <span class="s2">    -m, --methodName &lt;text&gt;  [default: auto]</span>
 1437 <span class="s2">        Method to use for constrained energy minimization. Default: B3LYP [ Ref 150 ].</span>
 1438 <span class="s2">        The specified value must be a valid Psi4 method name. No validation is</span>
 1439 <span class="s2">        performed.</span>
 1440 <span class="s2">        </span>
 1441 <span class="s2">        The following list shows a representative sample of methods available</span>
 1442 <span class="s2">        in Psi4:</span>
 1443 <span class="s2">            </span>
 1444 <span class="s2">            B1LYP, B2PLYP, B2PLYP-D3BJ, B2PLYP-D3MBJ, B3LYP, B3LYP-D3BJ,</span>
 1445 <span class="s2">            B3LYP-D3MBJ, CAM-B3LYP, CAM-B3LYP-D3BJ, HF, HF-D3BJ,  HF3c, M05,</span>
 1446 <span class="s2">            M06, M06-2x, M06-HF, M06-L, MN12-L, MN15, MN15-D3BJ,PBE, PBE0,</span>
 1447 <span class="s2">            PBEH3c, PW6B95, PW6B95-D3BJ, WB97, WB97X, WB97X-D, WB97X-D3BJ</span>
 1448 <span class="s2">            </span>
 1449 <span class="s2">    --mcsParams &lt;Name,Value,...&gt;  [default: auto]</span>
 1450 <span class="s2">        Parameter values to use for identifying a maximum common substructure</span>
 1451 <span class="s2">        (MCS) in between a pair of reference and input molecules.In general, it is a</span>
 1452 <span class="s2">        comma delimited list of parameter name and value pairs. The supported</span>
 1453 <span class="s2">        parameter names along with their default values are shown below:</span>
 1454 <span class="s2">            </span>
 1455 <span class="s2">            atomCompare,CompareElements,bondCompare,CompareOrder,</span>
 1456 <span class="s2">            maximizeBonds,yes,matchValences,yes,matchChiralTag,no,</span>
 1457 <span class="s2">            minNumAtoms,1,minNumBonds,0,ringMatchesRingOnly,yes,</span>
 1458 <span class="s2">            completeRingsOnly,yes,threshold,1.0,timeOut,3600,seedSMARTS,none</span>
 1459 <span class="s2">            </span>
 1460 <span class="s2">        Possible values for atomCompare: CompareAny, CompareElements,</span>
 1461 <span class="s2">        CompareIsotopes. Possible values for bondCompare: CompareAny,</span>
 1462 <span class="s2">        CompareOrder, CompareOrderExact.</span>
 1463 <span class="s2">        </span>
 1464 <span class="s2">        A brief description of MCS parameters taken from RDKit documentation is</span>
 1465 <span class="s2">        as follows:</span>
 1466 <span class="s2">            </span>
 1467 <span class="s2">            atomCompare - Controls match between two atoms</span>
 1468 <span class="s2">            bondCompare - Controls match between two bonds</span>
 1469 <span class="s2">            maximizeBonds - Maximize number of bonds instead of atoms</span>
 1470 <span class="s2">            matchValences - Include atom valences in the MCS match</span>
 1471 <span class="s2">            matchChiralTag - Include atom chirality in the MCS match</span>
 1472 <span class="s2">            minNumAtoms - Minimum number of atoms in the MCS match</span>
 1473 <span class="s2">            minNumBonds - Minimum number of bonds in the MCS match</span>
 1474 <span class="s2">            ringMatchesRingOnly - Ring bonds only match other ring bonds</span>
 1475 <span class="s2">            completeRingsOnly - Partial rings not allowed during the match</span>
 1476 <span class="s2">            threshold - Fraction of the dataset that must contain the MCS</span>
 1477 <span class="s2">            seedSMARTS - SMARTS string as the seed of the MCS</span>
 1478 <span class="s2">            timeout - Timeout for the MCS calculation in seconds</span>
 1479 <span class="s2">            </span>
 1480 <span class="s2">    --mp &lt;yes or no&gt;  [default: no]</span>
 1481 <span class="s2">        Use multiprocessing.</span>
 1482 <span class="s2">         </span>
 1483 <span class="s2">        By default, input data is retrieved in a lazy manner via mp.Pool.imap()</span>
 1484 <span class="s2">        function employing lazy RDKit data iterable. This allows processing of</span>
 1485 <span class="s2">        arbitrary large data sets without any additional requirements memory.</span>
 1486 <span class="s2">        </span>
 1487 <span class="s2">        All input data may be optionally loaded into memory by mp.Pool.map()</span>
 1488 <span class="s2">        before starting worker processes in a process pool by setting the value</span>
 1489 <span class="s2">        of &#39;inputDataMode&#39; to &#39;InMemory&#39; in &#39;--mpParams&#39; option.</span>
 1490 <span class="s2">        </span>
 1491 <span class="s2">        A word to the wise: The default &#39;chunkSize&#39; value of 1 during &#39;Lazy&#39; input</span>
 1492 <span class="s2">        data mode may adversely impact the performance. The &#39;--mpParams&#39; section</span>
 1493 <span class="s2">        provides additional information to tune the value of &#39;chunkSize&#39;.</span>
 1494 <span class="s2">    --mpLevel &lt;Molecules or Conformers&gt;  [default: Molecules]</span>
 1495 <span class="s2">        Perform multiprocessing at molecules or conformers level. Possible values:</span>
 1496 <span class="s2">        Molecules or Conformers. The &#39;Molecules&#39; value starts a process pool at the</span>
 1497 <span class="s2">        molecules level. All conformers of a molecule are processed in a single</span>
 1498 <span class="s2">        process. The &#39;Conformers&#39; value, however, starts a process pool at the </span>
 1499 <span class="s2">        conformers level. Each conformer of a molecule is processed in an individual</span>
 1500 <span class="s2">        process in the process pool. The default Psi4 &#39;OutputFile&#39; is set to &#39;quiet&#39;</span>
 1501 <span class="s2">        using &#39;--psi4RunParams&#39; for &#39;Conformers&#39; level. Otherwise, it may generate</span>
 1502 <span class="s2">        a large number of Psi4 output files.</span>
 1503 <span class="s2">    --mpParams &lt;Name,Value,...&gt;  [default: auto]</span>
 1504 <span class="s2">        A comma delimited list of parameter name and value pairs to configure</span>
 1505 <span class="s2">        multiprocessing.</span>
 1506 <span class="s2">        </span>
 1507 <span class="s2">        The supported parameter names along with their default and possible</span>
 1508 <span class="s2">        values are shown below:</span>
 1509 <span class="s2">        </span>
 1510 <span class="s2">            chunkSize, auto</span>
 1511 <span class="s2">            inputDataMode, Lazy   [ Possible values: InMemory or Lazy ]</span>
 1512 <span class="s2">            numProcesses, auto   [ Default: mp.cpu_count() ]</span>
 1513 <span class="s2">        </span>
 1514 <span class="s2">        These parameters are used by the following functions to configure and</span>
 1515 <span class="s2">        control the behavior of multiprocessing: mp.Pool(), mp.Pool.map(), and</span>
 1516 <span class="s2">        mp.Pool.imap().</span>
 1517 <span class="s2">        </span>
 1518 <span class="s2">        The chunkSize determines chunks of input data passed to each worker</span>
 1519 <span class="s2">        process in a process pool by mp.Pool.map() and mp.Pool.imap() functions.</span>
 1520 <span class="s2">        The default value of chunkSize is dependent on the value of &#39;inputDataMode&#39;.</span>
 1521 <span class="s2">        </span>
 1522 <span class="s2">        The mp.Pool.map() function, invoked during &#39;InMemory&#39; input data mode,</span>
 1523 <span class="s2">        automatically converts RDKit data iterable into a list, loads all data into</span>
 1524 <span class="s2">        memory, and calculates the default chunkSize using the following method</span>
 1525 <span class="s2">        as shown in its code:</span>
 1526 <span class="s2">        </span>
 1527 <span class="s2">            chunkSize, extra = divmod(len(dataIterable), len(numProcesses) * 4)</span>
 1528 <span class="s2">            if extra: chunkSize += 1</span>
 1529 <span class="s2">        </span>
 1530 <span class="s2">        For example, the default chunkSize will be 7 for a pool of 4 worker processes</span>
 1531 <span class="s2">        and 100 data items.</span>
 1532 <span class="s2">        </span>
 1533 <span class="s2">        The mp.Pool.imap() function, invoked during &#39;Lazy&#39; input data mode, employs</span>
 1534 <span class="s2">        &#39;lazy&#39; RDKit data iterable to retrieve data as needed, without loading all the</span>
 1535 <span class="s2">        data into memory. Consequently, the size of input data is not known a priori.</span>
 1536 <span class="s2">        It&#39;s not possible to estimate an optimal value for the chunkSize. The default </span>
 1537 <span class="s2">        chunkSize is set to 1.</span>
 1538 <span class="s2">        </span>
 1539 <span class="s2">        The default value for the chunkSize during &#39;Lazy&#39; data mode may adversely</span>
 1540 <span class="s2">        impact the performance due to the overhead associated with exchanging</span>
 1541 <span class="s2">        small chunks of data. It is generally a good idea to explicitly set chunkSize to</span>
 1542 <span class="s2">        a larger value during &#39;Lazy&#39; input data mode, based on the size of your input</span>
 1543 <span class="s2">        data and number of processes in the process pool.</span>
 1544 <span class="s2">        </span>
 1545 <span class="s2">        The mp.Pool.map() function waits for all worker processes to process all</span>
 1546 <span class="s2">        the data and return the results. The mp.Pool.imap() function, however,</span>
 1547 <span class="s2">        returns the the results obtained from worker processes as soon as the</span>
 1548 <span class="s2">        results become available for specified chunks of data.</span>
 1549 <span class="s2">        </span>
 1550 <span class="s2">        The order of data in the results returned by both mp.Pool.map() and </span>
 1551 <span class="s2">        mp.Pool.imap() functions always corresponds to the input data.</span>
 1552 <span class="s2">    -o, --outfile &lt;outfile&gt;</span>
 1553 <span class="s2">        Output file name.</span>
 1554 <span class="s2">    --outfileParams &lt;Name,Value,...&gt;  [default: auto]</span>
 1555 <span class="s2">        A comma delimited list of parameter name and value pairs for writing</span>
 1556 <span class="s2">        molecules to files. The supported parameter names for different file</span>
 1557 <span class="s2">        formats, along with their default values, are shown below:</span>
 1558 <span class="s2">            </span>
 1559 <span class="s2">            SD: kekulize,yes</span>
 1560 <span class="s2">            </span>
 1561 <span class="s2">    --overwrite</span>
 1562 <span class="s2">        Overwrite existing files.</span>
 1563 <span class="s2">    --precision &lt;number&gt;  [default: 6]</span>
 1564 <span class="s2">        Floating point precision for writing energy values.</span>
 1565 <span class="s2">    --psi4OptionsParams &lt;Name,Value,...&gt;  [default: none]</span>
 1566 <span class="s2">        A comma delimited list of Psi4 option name and value pairs for setting</span>
 1567 <span class="s2">        global and module options. The names are &#39;option_name&#39; for global options</span>
 1568 <span class="s2">        and &#39;module_name__option_name&#39; for options local to a module. The</span>
 1569 <span class="s2">        specified option names must be valid Psi4 names. No validation is</span>
 1570 <span class="s2">        performed.</span>
 1571 <span class="s2">        </span>
 1572 <span class="s2">        The specified option name and  value pairs are processed and passed to</span>
 1573 <span class="s2">        psi4.set_options() as a dictionary. The supported value types are float,</span>
 1574 <span class="s2">        integer, boolean, or string. The float value string is converted into a float.</span>
 1575 <span class="s2">        The valid values for a boolean string are yes, no, true, false, on, or off. </span>
 1576 <span class="s2">    --psi4RunParams &lt;Name,Value,...&gt;  [default: auto]</span>
 1577 <span class="s2">        A comma delimited list of parameter name and value pairs for configuring</span>
 1578 <span class="s2">        Psi4 jobs.</span>
 1579 <span class="s2">        </span>
 1580 <span class="s2">        The supported parameter names along with their default and possible</span>
 1581 <span class="s2">        values are shown below:</span>
 1582 <span class="s2">             </span>
 1583 <span class="s2">            MemoryInGB, 1</span>
 1584 <span class="s2">            NumThreads, 1</span>
 1585 <span class="s2">            OutputFile, auto   [ Possible  values: stdout, quiet, or FileName ]</span>
 1586 <span class="s2">            ScratchDir, auto   [ Possivle values: DirName]</span>
 1587 <span class="s2">            RemoveOutputFile, yes   [ Possible values: yes, no, true, or false]</span>
 1588 <span class="s2">            </span>
 1589 <span class="s2">        These parameters control the runtime behavior of Psi4.</span>
 1590 <span class="s2">        </span>
 1591 <span class="s2">        The default file name for &#39;OutputFile&#39; is &lt;InFileRoot&gt;_Psi4.out. The PID</span>
 1592 <span class="s2">        is appended to output file name during multiprocessing as shown:</span>
 1593 <span class="s2">        &lt;InFileRoot&gt;_Psi4_&lt;PIDNum&gt;.out. The &#39;stdout&#39; value for &#39;OutputType&#39;</span>
 1594 <span class="s2">        sends Psi4 output to stdout. The &#39;quiet&#39; or &#39;devnull&#39; value suppresses</span>
 1595 <span class="s2">        all Psi4 output. The &#39;OutputFile&#39; is set to &#39;quiet&#39; for &#39;auto&#39; value during </span>
 1596 <span class="s2">        &#39;Conformers&#39; of &#39;--mpLevel&#39; option.</span>
 1597 <span class="s2">        </span>
 1598 <span class="s2">        The default &#39;Yes&#39; value of &#39;RemoveOutputFile&#39; option forces the removal</span>
 1599 <span class="s2">        of any existing Psi4 before creating new files to append output from</span>
 1600 <span class="s2">        multiple Psi4 runs.</span>
 1601 <span class="s2">        </span>
 1602 <span class="s2">        The option &#39;ScratchDir&#39; is a directory path to the location of scratch</span>
 1603 <span class="s2">        files. The default value corresponds to Psi4 default. It may be used to</span>
 1604 <span class="s2">        override the deafult path.</span>
 1605 <span class="s2">    -q, --quiet &lt;yes or no&gt;  [default: no]</span>
 1606 <span class="s2">        Use quiet mode. The warning and information messages will not be printed.</span>
 1607 <span class="s2">    -r, --reffile &lt;reffile&gt;</span>
 1608 <span class="s2">        Reference input file name containing a 3D reference molecule. A common</span>
 1609 <span class="s2">        core scaffold must be present in a pair of an input and reference molecules.</span>
 1610 <span class="s2">        Otherwise, no constrained minimization is performed on the input molecule.</span>
 1611 <span class="s2">    --reference &lt;text&gt;  [default: auto]</span>
 1612 <span class="s2">        Reference wave function to use for energy calculation. Default: RHF or UHF.</span>
 1613 <span class="s2">        The default values are Restricted Hartree-Fock (RHF) for closed-shell molecules</span>
 1614 <span class="s2">        with all electrons paired and Unrestricted Hartree-Fock (UHF) for open-shell</span>
 1615 <span class="s2">        molecules with unpaired electrons.</span>
 1616 <span class="s2">        </span>
 1617 <span class="s2">        The specified value must be a valid Psi4 reference wave function. No validation</span>
 1618 <span class="s2">        is performed. For example: ROHF, CUHF, RKS, etc.</span>
 1619 <span class="s2">        </span>
 1620 <span class="s2">        The spin multiplicity determines the default value of reference wave function</span>
 1621 <span class="s2">        for input molecules. It is calculated from number of free radical electrons using</span>
 1622 <span class="s2">        Hund&#39;s rule of maximum multiplicity defined as 2S + 1 where S is the total</span>
 1623 <span class="s2">        electron spin. The total spin is 1/2 the number of free radical electrons in a </span>
 1624 <span class="s2">        molecule. The value of &#39;SpinMultiplicity&#39; molecule property takes precedence</span>
 1625 <span class="s2">        over the calculated value of spin multiplicity.</span>
 1626 <span class="s2">    -s, --scaffold &lt;auto or SMARTS&gt;  [default: auto]</span>
 1627 <span class="s2">        Common core scaffold between a pair of input and reference molecules used for</span>
 1628 <span class="s2">        constrained minimization of molecules in input file. Possible values: Auto or a</span>
 1629 <span class="s2">        valid SMARTS pattern. The common core scaffold is automatically detected</span>
 1630 <span class="s2">        corresponding to the Maximum Common Substructure (MCS) between a pair of</span>
 1631 <span class="s2">        reference and input molecules. A valid SMARTS pattern may be optionally specified</span>
 1632 <span class="s2">        for the common core scaffold.</span>
 1633 <span class="s2">    --scaffoldRMSDOut &lt;yes or no&gt;  [default: No]</span>
 1634 <span class="s2">        Write out RMSD value for common core alignment between a pair of input and</span>
 1635 <span class="s2">        reference molecules.</span>
 1636 <span class="s2">    -w, --workingdir &lt;dir&gt;</span>
 1637 <span class="s2">        Location of working directory which defaults to the current directory.</span>
 1638 
 1639 <span class="s2">Examples:</span>
 1640 <span class="s2">    To generate conformers by performing constrained energy minimization for molecules</span>
 1641 <span class="s2">    in a SMILES file against a reference 3D molecule in a SD file using a common core</span>
 1642 <span class="s2">    scaffold between pairs of input and reference molecules identified using MCS,</span>
 1643 <span class="s2">    generating up to 50 conformations using ETKDG methodology followed by initial</span>
 1644 <span class="s2">    MMFF forcefield minimization and  final energy minimization using B3LYP/6-31G**</span>
 1645 <span class="s2">    and B3LYP/6-31+G** for non-sulfur and sulfur containing molecules, applying</span>
 1646 <span class="s2">    energy RMSD cutoff of 0.5 and energy window value value of 20 kcal/mol, and</span>
 1647 <span class="s2">    write out a SD file:</span>
 1648 
 1649 <span class="s2">       %  Psi4GenerateConstrainedConformers.py  -i Psi4SampleAlkanes.smi</span>
 1650 <span class="s2">          -r Psi4SampleEthane3D.sdf  -o Psi4SampleAlkanesOut.sdf</span>
 1651 
 1652 <span class="s2">    To run the first example in a quiet mode and write out a SD file, type:</span>
 1653 
 1654 <span class="s2">       %  Psi4GenerateConstrainedConformers.py  -q yes -i Psi4SampleAlkanes.smi</span>
 1655 <span class="s2">          -r Psi4SampleEthane3D.sdf  -o Psi4SampleAlkanesOut.sdf</span>
 1656 
 1657 <span class="s2">    To rerun the first example in multiprocessing mode on all available CPUs</span>
 1658 <span class="s2">    without loading all data into memory and write out a SD file, type:</span>
 1659 
 1660 <span class="s2">       %  Psi4GenerateConstrainedConformers.py  --mp yes</span>
 1661 <span class="s2">          -i Psi4SampleAlkanes.smi -r Psi4SampleEthane3D.sdf</span>
 1662 <span class="s2">          -o Psi4SampleAlkanesOut.sdf</span>
 1663 
 1664 <span class="s2">    To run the first example in multiprocessing mode on all available CPUs</span>
 1665 <span class="s2">    by loading all data into memory and write out a SD file, type:</span>
 1666 
 1667 <span class="s2">       %  Psi4GenerateConstrainedConformers.py  --mp yes --mpParams</span>
 1668 <span class="s2">          &quot;inputDataMode,InMemory&quot;-i Psi4SampleAlkanes.smi</span>
 1669 <span class="s2">          -r Psi4SampleEthane3D.sdf -o Psi4SampleAlkanesOut.sdf</span>
 1670 
 1671 <span class="s2">    To rerun the first example in multiprocessing mode on specific number of</span>
 1672 <span class="s2">    CPUs and chunk size without loading all data into memory and write out a SD file,</span>
 1673 <span class="s2">    type:</span>
 1674 
 1675 <span class="s2">       %  Psi4GenerateConstrainedConformers.py  --mp yes --mpParams</span>
 1676 <span class="s2">          &quot;inputDataMode,Lazy,numProcesses,4,chunkSize,8&quot;</span>
 1677 <span class="s2">          -i Psi4SampleAlkanes.smi -r Psi4SampleEthane3D.sdf</span>
 1678 <span class="s2">          -o Psi4SampleAlkanesOut.sdf</span>
 1679 
 1680 <span class="s2">    To rerun the first example using an explicit SMARTS string for a common core</span>
 1681 <span class="s2">    scaffold and write out a SD file, type:</span>
 1682 
 1683 <span class="s2">       %  Psi4GenerateConstrainedConformers.py  --scaffold &quot;CC&quot;</span>
 1684 <span class="s2">          -i Psi4SampleAlkanes.smi -r Psi4SampleEthane3D.sdf</span>
 1685 <span class="s2">          -o Psi4SampleAlkanesOut.sdf</span>
 1686 
 1687 <span class="s2">    To run the first example using a specific set of parameters for generating</span>
 1688 <span class="s2">    an initial set of conformers followed by energy minimization using forcefield</span>
 1689 <span class="s2">    and a quantum chemistry method and write out a SD file type:</span>
 1690 
 1691 <span class="s2">       %  Psi4GenerateConstrainedConformers.py  --confParams &quot;confMethod,ETKDG,</span>
 1692 <span class="s2">          forceField,MMFF, forceFieldMMFFVariant,MMFF94s, maxConfs,20,</span>
 1693 <span class="s2">          embedRMSDCutoff,0.5&quot; --energyUnits &quot;kJ/mol&quot; -m B3LYP</span>
 1694 <span class="s2">          -b &quot;6-31+G**&quot; --maxIters 20 --energyRMSDCutoff 0.5</span>
 1695 <span class="s2">          --energyRMSDCutoffMode All -i Psi4SampleAlkanes.sdf</span>
 1696 <span class="s2">          -r Psi4SampleEthane3D.sdf -o Psi4SampleAlkanesOut.sdf</span>
 1697 
 1698 <span class="s2">    To rerun the first example using molecules in a CSV SMILES file, SMILES</span>
 1699 <span class="s2">    strings in column 1, name in column2, and write out a SD file, type:</span>
 1700 
 1701 <span class="s2">       %  Psi4GenerateConstrainedConformers.py  --infileParams</span>
 1702 <span class="s2">          &quot;smilesDelimiter,comma,smilesTitleLine,yes,smilesColumn,1,</span>
 1703 <span class="s2">          smilesNameColumn,2&quot; -i Psi4SampleAlkanes.csv</span>
 1704 <span class="s2">          -r Psi4SampleEthane3D.sdf -o Psi4SampleAlkanesOut.sdf</span>
 1705 
 1706 <span class="s2">Author:</span>
 1707 
 1708 <span class="s2">    Manish Sud(msud@san.rr.com)</span>
 1709 
 1710 <span class="s2">See also:</span>
 1711 <span class="s2">    Psi4CalculateEnergy.py, Psi4CalculatePartialCharges.py, Psi4GenerateConformers.py,</span>
 1712 <span class="s2">    Psi4PerformConstrainedMinimization.py, Psi4PerformMinimization.py</span>
 1713 
 1714 <span class="s2">Copyright:</span>
 1715 <span class="s2">    Copyright (C) 2022 Manish Sud. All rights reserved.</span>
 1716 
 1717 <span class="s2">    The functionality available in this script is implemented using Psi4, an</span>
 1718 <span class="s2">    open source quantum chemistry software package, and RDKit, an open</span>
 1719 <span class="s2">    source toolkit for cheminformatics developed by Greg Landrum.</span>
 1720 
 1721 <span class="s2">    This file is part of MayaChemTools.</span>
 1722 
 1723 <span class="s2">    MayaChemTools is free software; you can redistribute it and/or modify it under</span>
 1724 <span class="s2">    the terms of the GNU Lesser General Public License as published by the Free</span>
 1725 <span class="s2">    Software Foundation; either version 3 of the License, or (at your option) any</span>
 1726 <span class="s2">    later version.</span>
 1727 
 1728 <span class="s2">&quot;&quot;&quot;</span>
 1729 
 1730 <span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
 1731     <span class="n">main</span><span class="p">()</span>
</pre>
<br />
<center>
<img src="../../../images/h2o2.png">
</center>
</body>
</html>
