<html>
<head>
<title>MayaChemTools:Code:RDKitPerformTorsionScan.py</title>
<meta http-equiv="content-type" content="text/html;charset=utf-8">
<link rel="stylesheet" type="text/css" href="../../../css/MayaChemToolsPythonCode.css">
</head>
<body leftmargin="20" rightmargin="20" topmargin="10" bottommargin="10">
<br/>
<center>
<a href="http://www.mayachemtools.org" title="MayaChemTools Home"><img src="../../../images/MayaChemToolsLogo.gif" border="0" alt="MayaChemTools"></a>
</center>
<br/>
<pre>
    1 <span class="ch">#!/bin/env python</span>
    2 <span class="c1">#</span>
    3 <span class="c1"># File: RDKitPerformTorsionScan.py</span>
    4 <span class="c1"># Author: Manish Sud &lt;msud@san.rr.com&gt;</span>
    5 <span class="c1">#</span>
    6 <span class="c1"># Copyright (C) 2022 Manish Sud. All rights reserved.</span>
    7 <span class="c1">#</span>
    8 <span class="c1"># The functionality available in this script is implemented using RDKit, an</span>
    9 <span class="c1"># open source toolkit for cheminformatics developed by Greg Landrum.</span>
   10 <span class="c1">#</span>
   11 <span class="c1"># This file is part of MayaChemTools.</span>
   12 <span class="c1">#</span>
   13 <span class="c1"># MayaChemTools is free software; you can redistribute it and/or modify it under</span>
   14 <span class="c1"># the terms of the GNU Lesser General Public License as published by the Free</span>
   15 <span class="c1"># Software Foundation; either version 3 of the License, or (at your option) any</span>
   16 <span class="c1"># later version.</span>
   17 <span class="c1">#</span>
   18 <span class="c1"># MayaChemTools is distributed in the hope that it will be useful, but without</span>
   19 <span class="c1"># any warranty; without even the implied warranty of merchantability of fitness</span>
   20 <span class="c1"># for a particular purpose.  See the GNU Lesser General Public License for more</span>
   21 <span class="c1"># details.</span>
   22 <span class="c1">#</span>
   23 <span class="c1"># You should have received a copy of the GNU Lesser General Public License</span>
   24 <span class="c1"># along with MayaChemTools; if not, see &lt;http://www.gnu.org/licenses/&gt; or</span>
   25 <span class="c1"># write to the Free Software Foundation Inc., 59 Temple Place, Suite 330,</span>
   26 <span class="c1"># Boston, MA, 02111-1307, USA.</span>
   27 <span class="c1">#</span>
   28 
   29 <span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>
   30 
   31 <span class="c1"># Add local python path to the global path and import standard library modules...</span>
   32 <span class="kn">import</span> <span class="nn">os</span>
   33 <span class="kn">import</span> <span class="nn">sys</span><span class="p">;</span>  <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="s2">&quot;..&quot;</span><span class="p">,</span> <span class="s2">&quot;lib&quot;</span><span class="p">,</span> <span class="s2">&quot;Python&quot;</span><span class="p">))</span>
   34 <span class="kn">import</span> <span class="nn">time</span>
   35 <span class="kn">import</span> <span class="nn">re</span>
   36 <span class="kn">import</span> <span class="nn">glob</span>
   37 <span class="kn">import</span> <span class="nn">multiprocessing</span> <span class="kn">as</span> <span class="nn">mp</span>
   38 
   39 <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
   40 <span class="kn">import</span> <span class="nn">seaborn</span> <span class="kn">as</span> <span class="nn">sns</span>
   41 
   42 <span class="c1"># RDKit imports...</span>
   43 <span class="k">try</span><span class="p">:</span>
   44     <span class="kn">from</span> <span class="nn">rdkit</span> <span class="kn">import</span> <span class="n">rdBase</span>
   45     <span class="kn">from</span> <span class="nn">rdkit</span> <span class="kn">import</span> <span class="n">Chem</span>
   46     <span class="kn">from</span> <span class="nn">rdkit.Chem</span> <span class="kn">import</span> <span class="n">AllChem</span>
   47     <span class="kn">from</span> <span class="nn">rdkit.Chem</span> <span class="kn">import</span> <span class="n">rdMolTransforms</span>
   48 <span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">ErrMsg</span><span class="p">:</span>
   49     <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Failed to import RDKit module/package: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">ErrMsg</span><span class="p">)</span>
   50     <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Check/update your RDKit environment and try again.</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
   51     <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
   52 
   53 <span class="c1"># MayaChemTools imports...</span>
   54 <span class="k">try</span><span class="p">:</span>
   55     <span class="kn">from</span> <span class="nn">docopt</span> <span class="kn">import</span> <span class="n">docopt</span>
   56     <span class="kn">import</span> <span class="nn">MiscUtil</span>
   57     <span class="kn">import</span> <span class="nn">RDKitUtil</span>
   58 <span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">ErrMsg</span><span class="p">:</span>
   59     <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Failed to import MayaChemTools module/package: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">ErrMsg</span><span class="p">)</span>
   60     <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Check/update your MayaChemTools environment and try again.</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
   61     <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
   62 
   63 <span class="n">ScriptName</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
   64 <span class="n">Options</span> <span class="o">=</span> <span class="p">{}</span>
   65 <span class="n">OptionsInfo</span> <span class="o">=</span> <span class="p">{}</span>
   66 
   67 <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
   68     <span class="sd">&quot;&quot;&quot;Start execution of the script.&quot;&quot;&quot;</span>
   69     
   70     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">%s</span><span class="s2"> (RDKit v</span><span class="si">%s</span><span class="s2">; MayaChemTools v</span><span class="si">%s</span><span class="s2">; </span><span class="si">%s</span><span class="s2">): Starting...</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ScriptName</span><span class="p">,</span> <span class="n">rdBase</span><span class="o">.</span><span class="n">rdkitVersion</span><span class="p">,</span> <span class="n">MiscUtil</span><span class="o">.</span><span class="n">GetMayaChemToolsVersion</span><span class="p">(),</span> <span class="n">time</span><span class="o">.</span><span class="n">asctime</span><span class="p">()))</span>
   71     
   72     <span class="p">(</span><span class="n">WallClockTime</span><span class="p">,</span> <span class="n">ProcessorTime</span><span class="p">)</span> <span class="o">=</span> <span class="n">MiscUtil</span><span class="o">.</span><span class="n">GetWallClockAndProcessorTime</span><span class="p">()</span>
   73     
   74     <span class="c1"># Retrieve command line arguments and options...</span>
   75     <span class="n">RetrieveOptions</span><span class="p">()</span>
   76     
   77     <span class="c1"># Process and validate command line arguments and options...</span>
   78     <span class="n">ProcessOptions</span><span class="p">()</span>
   79     
   80     <span class="c1"># Perform actions required by the script...</span>
   81     <span class="n">PerformTorsionScan</span><span class="p">()</span>
   82 
   83     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">%s</span><span class="s2">: Done...</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">ScriptName</span><span class="p">)</span>
   84     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;Total time: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">MiscUtil</span><span class="o">.</span><span class="n">GetFormattedElapsedTime</span><span class="p">(</span><span class="n">WallClockTime</span><span class="p">,</span> <span class="n">ProcessorTime</span><span class="p">))</span>
   85 
   86 <span class="k">def</span> <span class="nf">PerformTorsionScan</span><span class="p">():</span>
   87     <span class="sd">&quot;&quot;&quot;Perform torsion scan.&quot;&quot;&quot;</span>
   88     
   89     <span class="c1"># Setup a molecule reader for input file...</span>
   90     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Processing file </span><span class="si">%s</span><span class="s2">...&quot;</span> <span class="o">%</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Infile&quot;</span><span class="p">])</span>
   91     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;InfileParams&quot;</span><span class="p">][</span><span class="s2">&quot;AllowEmptyMols&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
   92     <span class="n">Mols</span>  <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">ReadMolecules</span><span class="p">(</span><span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Infile&quot;</span><span class="p">],</span> <span class="o">**</span><span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;InfileParams&quot;</span><span class="p">])</span>
   93     
   94     <span class="n">PlotExt</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;OutPlotParams&quot;</span><span class="p">][</span><span class="s2">&quot;OutExt&quot;</span><span class="p">]</span>
   95     <span class="n">FileDir</span><span class="p">,</span> <span class="n">FileName</span><span class="p">,</span> <span class="n">FileExt</span> <span class="o">=</span> <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ParseFileName</span><span class="p">(</span><span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--outfile&quot;</span><span class="p">])</span>
   96     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;Generating output files </span><span class="si">%s</span><span class="s2">_*.sdf, </span><span class="si">%s</span><span class="s2">_*Torsion*Match*.sdf, </span><span class="si">%s</span><span class="s2">_*Torsion*Match*Energies.csv, </span><span class="si">%s</span><span class="s2">_*Torsion*Match*Plot.</span><span class="si">%s</span><span class="s2">...&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">FileName</span><span class="p">,</span> <span class="n">FileName</span><span class="p">,</span> <span class="n">FileName</span><span class="p">,</span> <span class="n">FileName</span><span class="p">,</span> <span class="n">PlotExt</span><span class="p">))</span>
   97 
   98     <span class="n">MolCount</span><span class="p">,</span> <span class="n">ValidMolCount</span><span class="p">,</span> <span class="n">MinimizationFailedCount</span><span class="p">,</span> <span class="n">TorsionsMissingCount</span><span class="p">,</span> <span class="n">TorsionsScanFailedCount</span> <span class="o">=</span> <span class="n">ProcessMolecules</span><span class="p">(</span><span class="n">Mols</span><span class="p">)</span>
   99     
  100     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Total number of molecules: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">MolCount</span><span class="p">)</span>
  101     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;Number of valid molecules: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">ValidMolCount</span><span class="p">)</span>
  102     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;Number of molecules failed during initial minimization: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">MinimizationFailedCount</span><span class="p">)</span>
  103     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;Number of molecules without any matched torsions: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">TorsionsMissingCount</span><span class="p">)</span>
  104     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;Number of molecules failed during torsion scan: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">TorsionsScanFailedCount</span><span class="p">)</span>
  105     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;Number of ignored molecules: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">MolCount</span> <span class="o">-</span> <span class="n">ValidMolCount</span> <span class="o">+</span> <span class="n">TorsionsMissingCount</span> <span class="o">+</span> <span class="n">MinimizationFailedCount</span> <span class="o">+</span> <span class="n">TorsionsScanFailedCount</span><span class="p">))</span>
  106 
  107 <span class="k">def</span> <span class="nf">ProcessMolecules</span><span class="p">(</span><span class="n">Mols</span><span class="p">):</span>
  108     <span class="sd">&quot;&quot;&quot;Process molecules to perform torsion scan.&quot;&quot;&quot;</span>
  109 
  110     <span class="k">if</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;MPMode&quot;</span><span class="p">]:</span>
  111         <span class="k">return</span> <span class="n">ProcessMoleculesUsingMultipleProcesses</span><span class="p">(</span><span class="n">Mols</span><span class="p">)</span>
  112     <span class="k">else</span><span class="p">:</span>
  113         <span class="k">return</span> <span class="n">ProcessMoleculesUsingSingleProcess</span><span class="p">(</span> <span class="n">Mols</span><span class="p">)</span>
  114 
  115 <span class="k">def</span> <span class="nf">ProcessMoleculesUsingSingleProcess</span><span class="p">(</span><span class="n">Mols</span><span class="p">):</span>
  116     <span class="sd">&quot;&quot;&quot;Process molecules to perform torsion scan using a single process.&quot;&quot;&quot;</span>
  117 
  118     <span class="n">MolInfoText</span> <span class="o">=</span> <span class="s2">&quot;first molecule&quot;</span>
  119     <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;FirstMolMode&quot;</span><span class="p">]:</span>
  120         <span class="n">MolInfoText</span> <span class="o">=</span> <span class="s2">&quot;all molecules&quot;</span>
  121 
  122     <span class="k">if</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;TorsionMinimize&quot;</span><span class="p">]:</span>
  123         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Performing torsion scan on </span><span class="si">%s</span><span class="s2"> by generating conformation ensembles for specific torsion angles and constrained energy minimization of the ensembles...&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">MolInfoText</span><span class="p">))</span>
  124     <span class="k">else</span><span class="p">:</span>
  125         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Performing torsion scan on </span><span class="si">%s</span><span class="s2"> by skipping generation of conformation ensembles for specific torsion angles and constrained energy minimization of the ensembles...&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">MolInfoText</span><span class="p">))</span>
  126     
  127     <span class="n">SetupTorsionsPatternsInfo</span><span class="p">()</span>
  128     
  129     <span class="p">(</span><span class="n">MolCount</span><span class="p">,</span> <span class="n">ValidMolCount</span><span class="p">,</span> <span class="n">TorsionsMissingCount</span><span class="p">,</span> <span class="n">MinimizationFailedCount</span><span class="p">,</span> <span class="n">TorsionsScanFailedCount</span><span class="p">)</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">5</span>
  130 
  131     <span class="k">for</span> <span class="n">Mol</span> <span class="ow">in</span> <span class="n">Mols</span><span class="p">:</span>
  132         <span class="n">MolCount</span> <span class="o">+=</span> <span class="mi">1</span>
  133 
  134         <span class="k">if</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;FirstMolMode&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">MolCount</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
  135             <span class="n">MolCount</span> <span class="o">-=</span> <span class="mi">1</span>
  136             <span class="k">break</span>
  137         
  138         <span class="k">if</span> <span class="n">Mol</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
  139             <span class="k">continue</span>
  140         
  141         <span class="k">if</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">IsMolEmpty</span><span class="p">(</span><span class="n">Mol</span><span class="p">):</span>
  142             <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]:</span>
  143                 <span class="n">MolName</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">GetMolName</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolCount</span><span class="p">)</span>
  144                 <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintWarning</span><span class="p">(</span><span class="s2">&quot;Ignoring empty molecule: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">MolName</span><span class="p">)</span>
  145             <span class="k">continue</span>
  146         <span class="n">ValidMolCount</span> <span class="o">+=</span> <span class="mi">1</span>
  147 
  148         <span class="n">Mol</span><span class="p">,</span> <span class="n">MinimizationCalcStatus</span><span class="p">,</span> <span class="n">TorsionsMatchStatus</span><span class="p">,</span> <span class="n">TorsionsScanCalcStatus</span> <span class="o">=</span> <span class="n">PerformMinimizationAndTorsionScan</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolCount</span><span class="p">)</span>
  149         
  150         <span class="k">if</span> <span class="ow">not</span> <span class="n">MinimizationCalcStatus</span><span class="p">:</span>
  151             <span class="n">MinimizationFailedCount</span> <span class="o">+=</span> <span class="mi">1</span>
  152             <span class="k">continue</span>
  153         
  154         <span class="k">if</span> <span class="ow">not</span> <span class="n">TorsionsMatchStatus</span><span class="p">:</span>
  155             <span class="n">TorsionsMissingCount</span> <span class="o">+=</span> <span class="mi">1</span>
  156             <span class="k">continue</span>
  157 
  158         <span class="k">if</span> <span class="ow">not</span> <span class="n">TorsionsScanCalcStatus</span><span class="p">:</span>
  159             <span class="n">TorsionsScanFailedCount</span> <span class="o">+=</span> <span class="mi">1</span>
  160             <span class="k">continue</span>
  161 
  162     <span class="k">return</span> <span class="p">(</span><span class="n">MolCount</span><span class="p">,</span> <span class="n">ValidMolCount</span><span class="p">,</span> <span class="n">MinimizationFailedCount</span><span class="p">,</span> <span class="n">TorsionsMissingCount</span><span class="p">,</span> <span class="n">TorsionsScanFailedCount</span><span class="p">)</span>
  163 
  164 <span class="k">def</span> <span class="nf">ProcessMoleculesUsingMultipleProcesses</span><span class="p">(</span><span class="n">Mols</span><span class="p">):</span>
  165     <span class="sd">&quot;&quot;&quot;Process and minimize molecules using multiprocessing.&quot;&quot;&quot;</span>
  166     
  167     <span class="k">if</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;MPLevelTorsionAnglesMode&quot;</span><span class="p">]:</span>
  168         <span class="k">return</span> <span class="n">ProcessMoleculesUsingMultipleProcessesAtTorsionAnglesLevel</span><span class="p">(</span><span class="n">Mols</span><span class="p">)</span>
  169     <span class="k">elif</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;MPLevelMoleculesMode&quot;</span><span class="p">]:</span>
  170         <span class="k">return</span> <span class="n">ProcessMoleculesUsingMultipleProcessesAtMoleculesLevel</span><span class="p">(</span><span class="n">Mols</span><span class="p">)</span>
  171     <span class="k">else</span><span class="p">:</span>
  172         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintError</span><span class="p">(</span><span class="s2">&quot;The value, </span><span class="si">%s</span><span class="s2">,  option </span><span class="se">\&quot;</span><span class="s2">--mpLevel</span><span class="se">\&quot;</span><span class="s2"> is not supported.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;MPLevel&quot;</span><span class="p">]))</span>
  173         
  174 <span class="k">def</span> <span class="nf">ProcessMoleculesUsingMultipleProcessesAtMoleculesLevel</span><span class="p">(</span><span class="n">Mols</span><span class="p">):</span>
  175     <span class="sd">&quot;&quot;&quot;Process molecules to perform torsion scan using multiprocessing at molecules level.&quot;&quot;&quot;</span>
  176 
  177     <span class="n">MolInfoText</span> <span class="o">=</span> <span class="s2">&quot;first molecule&quot;</span>
  178     <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;FirstMolMode&quot;</span><span class="p">]:</span>
  179         <span class="n">MolInfoText</span> <span class="o">=</span> <span class="s2">&quot;all molecules&quot;</span>
  180 
  181     <span class="k">if</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;TorsionMinimize&quot;</span><span class="p">]:</span>
  182         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Performing torsion scan on </span><span class="si">%s</span><span class="s2"> using multiprocessing at molecules level by generating conformation ensembles for specific torsion angles and constrained energy minimization of the ensembles...&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">MolInfoText</span><span class="p">))</span>
  183     <span class="k">else</span><span class="p">:</span>
  184         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Performing torsion scan </span><span class="si">%s</span><span class="s2"> using multiprocessing at molecules level by skipping generation of conformation ensembles for specific torsion angles and constrained energy minimization of the ensembles...&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">MolInfoText</span><span class="p">))</span>
  185         
  186     <span class="n">MPParams</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;MPParams&quot;</span><span class="p">]</span>
  187     
  188     <span class="c1"># Setup data for initializing a worker process...</span>
  189     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Encoding options info...&quot;</span><span class="p">)</span>
  190     
  191     <span class="n">InitializeWorkerProcessArgs</span> <span class="o">=</span> <span class="p">(</span><span class="n">MiscUtil</span><span class="o">.</span><span class="n">ObjectToBase64EncodedString</span><span class="p">(</span><span class="n">Options</span><span class="p">),</span> <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ObjectToBase64EncodedString</span><span class="p">(</span><span class="n">OptionsInfo</span><span class="p">))</span>
  192 
  193     <span class="k">if</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;FirstMolMode&quot;</span><span class="p">]:</span>
  194         <span class="n">Mol</span> <span class="o">=</span> <span class="n">Mols</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
  195         <span class="n">Mols</span> <span class="o">=</span> <span class="p">[</span><span class="n">Mol</span><span class="p">]</span>
  196 
  197     <span class="c1"># Setup a encoded mols data iterable for a worker process...</span>
  198     <span class="n">WorkerProcessDataIterable</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">GenerateBase64EncodedMolStrings</span><span class="p">(</span><span class="n">Mols</span><span class="p">)</span>
  199 
  200     <span class="c1"># Setup process pool along with data initialization for each process...</span>
  201     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Configuring multiprocessing using </span><span class="si">%s</span><span class="s2"> method...&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s2">&quot;mp.Pool.imap()&quot;</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^Lazy$&quot;</span><span class="p">,</span> <span class="n">MPParams</span><span class="p">[</span><span class="s2">&quot;InputDataMode&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;mp.Pool.map()&quot;</span><span class="p">))</span>
  202     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;NumProcesses: </span><span class="si">%s</span><span class="s2">; InputDataMode: </span><span class="si">%s</span><span class="s2">; ChunkSize: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">MPParams</span><span class="p">[</span><span class="s2">&quot;NumProcesses&quot;</span><span class="p">],</span> <span class="n">MPParams</span><span class="p">[</span><span class="s2">&quot;InputDataMode&quot;</span><span class="p">],</span> <span class="p">(</span><span class="s2">&quot;automatic&quot;</span> <span class="k">if</span> <span class="n">MPParams</span><span class="p">[</span><span class="s2">&quot;ChunkSize&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">MPParams</span><span class="p">[</span><span class="s2">&quot;ChunkSize&quot;</span><span class="p">])))</span>
  203     
  204     <span class="n">ProcessPool</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">MPParams</span><span class="p">[</span><span class="s2">&quot;NumProcesses&quot;</span><span class="p">],</span> <span class="n">InitializeWorkerProcess</span><span class="p">,</span> <span class="n">InitializeWorkerProcessArgs</span><span class="p">)</span>
  205     
  206     <span class="c1"># Start processing...</span>
  207     <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^Lazy$&quot;</span><span class="p">,</span> <span class="n">MPParams</span><span class="p">[</span><span class="s2">&quot;InputDataMode&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
  208         <span class="n">Results</span> <span class="o">=</span> <span class="n">ProcessPool</span><span class="o">.</span><span class="n">imap</span><span class="p">(</span><span class="n">WorkerProcess</span><span class="p">,</span> <span class="n">WorkerProcessDataIterable</span><span class="p">,</span> <span class="n">MPParams</span><span class="p">[</span><span class="s2">&quot;ChunkSize&quot;</span><span class="p">])</span>
  209     <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^InMemory$&quot;</span><span class="p">,</span> <span class="n">MPParams</span><span class="p">[</span><span class="s2">&quot;InputDataMode&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
  210         <span class="n">Results</span> <span class="o">=</span> <span class="n">ProcessPool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">WorkerProcess</span><span class="p">,</span> <span class="n">WorkerProcessDataIterable</span><span class="p">,</span> <span class="n">MPParams</span><span class="p">[</span><span class="s2">&quot;ChunkSize&quot;</span><span class="p">])</span>
  211     <span class="k">else</span><span class="p">:</span>
  212         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintError</span><span class="p">(</span><span class="s2">&quot;The value, </span><span class="si">%s</span><span class="s2">, specified for </span><span class="se">\&quot;</span><span class="s2">--inputDataMode</span><span class="se">\&quot;</span><span class="s2"> is not supported.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">MPParams</span><span class="p">[</span><span class="s2">&quot;InputDataMode&quot;</span><span class="p">]))</span>
  213 
  214     <span class="p">(</span><span class="n">MolCount</span><span class="p">,</span> <span class="n">ValidMolCount</span><span class="p">,</span> <span class="n">TorsionsMissingCount</span><span class="p">,</span> <span class="n">MinimizationFailedCount</span><span class="p">,</span> <span class="n">TorsionsScanFailedCount</span><span class="p">)</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">5</span>
  215     
  216     <span class="k">for</span> <span class="n">Result</span> <span class="ow">in</span> <span class="n">Results</span><span class="p">:</span>
  217         <span class="n">MolCount</span> <span class="o">+=</span> <span class="mi">1</span>
  218         
  219         <span class="n">MolIndex</span><span class="p">,</span> <span class="n">EncodedMol</span><span class="p">,</span> <span class="n">MinimizationCalcStatus</span><span class="p">,</span> <span class="n">TorsionsMatchStatus</span><span class="p">,</span> <span class="n">TorsionsScanCalcStatus</span> <span class="o">=</span> <span class="n">Result</span>
  220         
  221         <span class="k">if</span> <span class="n">EncodedMol</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
  222             <span class="k">continue</span>
  223         <span class="n">ValidMolCount</span> <span class="o">+=</span> <span class="mi">1</span>
  224     
  225         <span class="k">if</span> <span class="ow">not</span> <span class="n">MinimizationCalcStatus</span><span class="p">:</span>
  226             <span class="n">MinimizationFailedCount</span> <span class="o">+=</span> <span class="mi">1</span>
  227             <span class="k">continue</span>
  228         
  229         <span class="k">if</span> <span class="ow">not</span> <span class="n">TorsionsMatchStatus</span><span class="p">:</span>
  230             <span class="n">TorsionsMissingCount</span> <span class="o">+=</span> <span class="mi">1</span>
  231             <span class="k">continue</span>
  232 
  233         <span class="k">if</span> <span class="ow">not</span> <span class="n">TorsionsScanCalcStatus</span><span class="p">:</span>
  234             <span class="n">TorsionsScanFailedCount</span> <span class="o">+=</span> <span class="mi">1</span>
  235             <span class="k">continue</span>
  236         
  237         <span class="n">Mol</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">MolFromBase64EncodedMolString</span><span class="p">(</span><span class="n">EncodedMol</span><span class="p">)</span>
  238         
  239     <span class="k">return</span> <span class="p">(</span><span class="n">MolCount</span><span class="p">,</span> <span class="n">ValidMolCount</span><span class="p">,</span> <span class="n">MinimizationFailedCount</span><span class="p">,</span> <span class="n">TorsionsMissingCount</span><span class="p">,</span> <span class="n">TorsionsScanFailedCount</span><span class="p">)</span>
  240     
  241 <span class="k">def</span> <span class="nf">InitializeWorkerProcess</span><span class="p">(</span><span class="o">*</span><span class="n">EncodedArgs</span><span class="p">):</span>
  242     <span class="sd">&quot;&quot;&quot;Initialize data for a worker process.&quot;&quot;&quot;</span>
  243     
  244     <span class="k">global</span> <span class="n">Options</span><span class="p">,</span> <span class="n">OptionsInfo</span>
  245 
  246     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;Starting process (PID: </span><span class="si">%s</span><span class="s2">)...&quot;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">())</span>
  247 
  248     <span class="c1"># Decode Options and OptionInfo...</span>
  249     <span class="n">Options</span> <span class="o">=</span> <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ObjectFromBase64EncodedString</span><span class="p">(</span><span class="n">EncodedArgs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
  250     <span class="n">OptionsInfo</span> <span class="o">=</span> <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ObjectFromBase64EncodedString</span><span class="p">(</span><span class="n">EncodedArgs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
  251 
  252     <span class="c1"># Initialize torsion patterns info...</span>
  253     <span class="n">SetupTorsionsPatternsInfo</span><span class="p">()</span>
  254 
  255 <span class="k">def</span> <span class="nf">WorkerProcess</span><span class="p">(</span><span class="n">EncodedMolInfo</span><span class="p">):</span>
  256     <span class="sd">&quot;&quot;&quot;Process data for a worker process.&quot;&quot;&quot;</span>
  257 
  258     <span class="n">MolIndex</span><span class="p">,</span> <span class="n">EncodedMol</span> <span class="o">=</span> <span class="n">EncodedMolInfo</span>
  259 
  260     <span class="p">(</span><span class="n">MinimizationCalcStatus</span><span class="p">,</span> <span class="n">TorsionsMatchStatus</span><span class="p">,</span> <span class="n">TorsionsScanCalcStatus</span><span class="p">)</span> <span class="o">=</span> <span class="p">[</span><span class="bp">False</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span>
  261     
  262     <span class="k">if</span> <span class="n">EncodedMol</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
  263         <span class="k">return</span> <span class="p">[</span><span class="n">MolIndex</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">MinimizationCalcStatus</span><span class="p">,</span> <span class="n">TorsionsMatchStatus</span><span class="p">,</span> <span class="n">TorsionsScanCalcStatus</span><span class="p">]</span>
  264     
  265     <span class="n">Mol</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">MolFromBase64EncodedMolString</span><span class="p">(</span><span class="n">EncodedMol</span><span class="p">)</span>
  266     <span class="k">if</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">IsMolEmpty</span><span class="p">(</span><span class="n">Mol</span><span class="p">):</span>
  267         <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]:</span>
  268             <span class="n">MolName</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">GetMolName</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="p">(</span><span class="n">MolIndex</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
  269             <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintWarning</span><span class="p">(</span><span class="s2">&quot;Ignoring empty molecule: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">MolName</span><span class="p">)</span>
  270         <span class="k">return</span> <span class="p">[</span><span class="n">MolIndex</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">MinimizationCalcStatus</span><span class="p">,</span> <span class="n">TorsionsMatchStatus</span><span class="p">,</span> <span class="n">TorsionsScanCalcStatus</span><span class="p">]</span>
  271     
  272     <span class="n">Mol</span><span class="p">,</span> <span class="n">MinimizationCalcStatus</span><span class="p">,</span> <span class="n">TorsionsMatchStatus</span><span class="p">,</span> <span class="n">TorsionsScanCalcStatus</span> <span class="o">=</span> <span class="n">PerformMinimizationAndTorsionScan</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="p">(</span><span class="n">MolIndex</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
  273     
  274     <span class="k">return</span> <span class="p">[</span><span class="n">MolIndex</span><span class="p">,</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">MolToBase64EncodedMolString</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">PropertyPickleFlags</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">PropertyPickleOptions</span><span class="o">.</span><span class="n">MolProps</span> <span class="o">|</span> <span class="n">Chem</span><span class="o">.</span><span class="n">PropertyPickleOptions</span><span class="o">.</span><span class="n">PrivateProps</span><span class="p">),</span> <span class="n">MinimizationCalcStatus</span><span class="p">,</span> <span class="n">TorsionsMatchStatus</span><span class="p">,</span> <span class="n">TorsionsScanCalcStatus</span><span class="p">]</span>
  275 
  276 <span class="k">def</span> <span class="nf">ProcessMoleculesUsingMultipleProcessesAtTorsionAnglesLevel</span><span class="p">(</span><span class="n">Mols</span><span class="p">):</span>
  277     <span class="sd">&quot;&quot;&quot;Process molecules to perform torsion scan using multiprocessing at torsion angles level.&quot;&quot;&quot;</span>
  278 
  279     <span class="n">MolInfoText</span> <span class="o">=</span> <span class="s2">&quot;first molecule&quot;</span>
  280     <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;FirstMolMode&quot;</span><span class="p">]:</span>
  281         <span class="n">MolInfoText</span> <span class="o">=</span> <span class="s2">&quot;all molecules&quot;</span>
  282 
  283     <span class="k">if</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;TorsionMinimize&quot;</span><span class="p">]:</span>
  284         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Performing torsion scan on </span><span class="si">%s</span><span class="s2"> using multiprocessing at torsion angles level by generating conformation ensembles for specific torsion angles and constrained energy minimization of the ensembles...&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">MolInfoText</span><span class="p">))</span>
  285     <span class="k">else</span><span class="p">:</span>
  286         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Performing torsion scan </span><span class="si">%s</span><span class="s2"> using multiprocessing at torsion angles level by skipping generation of conformation ensembles for specific torsion angles and constrained energy minimization of the ensembles...&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">MolInfoText</span><span class="p">))</span>
  287         
  288     <span class="n">SetupTorsionsPatternsInfo</span><span class="p">()</span>
  289     
  290     <span class="p">(</span><span class="n">MolCount</span><span class="p">,</span> <span class="n">ValidMolCount</span><span class="p">,</span> <span class="n">TorsionsMissingCount</span><span class="p">,</span> <span class="n">MinimizationFailedCount</span><span class="p">,</span> <span class="n">TorsionsScanFailedCount</span><span class="p">)</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">5</span>
  291 
  292     <span class="k">for</span> <span class="n">Mol</span> <span class="ow">in</span> <span class="n">Mols</span><span class="p">:</span>
  293         <span class="n">MolCount</span> <span class="o">+=</span> <span class="mi">1</span>
  294 
  295         <span class="k">if</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;FirstMolMode&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">MolCount</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
  296             <span class="n">MolCount</span> <span class="o">-=</span> <span class="mi">1</span>
  297             <span class="k">break</span>
  298         
  299         <span class="k">if</span> <span class="n">Mol</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
  300             <span class="k">continue</span>
  301         
  302         <span class="k">if</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">IsMolEmpty</span><span class="p">(</span><span class="n">Mol</span><span class="p">):</span>
  303             <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]:</span>
  304                 <span class="n">MolName</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">GetMolName</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolCount</span><span class="p">)</span>
  305                 <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintWarning</span><span class="p">(</span><span class="s2">&quot;Ignoring empty molecule: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">MolName</span><span class="p">)</span>
  306             <span class="k">continue</span>
  307         <span class="n">ValidMolCount</span> <span class="o">+=</span> <span class="mi">1</span>
  308 
  309         <span class="n">Mol</span><span class="p">,</span> <span class="n">MinimizationCalcStatus</span><span class="p">,</span> <span class="n">TorsionsMatchStatus</span><span class="p">,</span> <span class="n">TorsionsScanCalcStatus</span> <span class="o">=</span> <span class="n">PerformMinimizationAndTorsionScan</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolCount</span><span class="p">,</span> <span class="n">UseMultiProcessingAtTorsionAnglesLevel</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
  310         
  311         <span class="k">if</span> <span class="ow">not</span> <span class="n">MinimizationCalcStatus</span><span class="p">:</span>
  312             <span class="n">MinimizationFailedCount</span> <span class="o">+=</span> <span class="mi">1</span>
  313             <span class="k">continue</span>
  314         
  315         <span class="k">if</span> <span class="ow">not</span> <span class="n">TorsionsMatchStatus</span><span class="p">:</span>
  316             <span class="n">TorsionsMissingCount</span> <span class="o">+=</span> <span class="mi">1</span>
  317             <span class="k">continue</span>
  318 
  319         <span class="k">if</span> <span class="ow">not</span> <span class="n">TorsionsScanCalcStatus</span><span class="p">:</span>
  320             <span class="n">TorsionsScanFailedCount</span> <span class="o">+=</span> <span class="mi">1</span>
  321             <span class="k">continue</span>
  322 
  323     <span class="k">return</span> <span class="p">(</span><span class="n">MolCount</span><span class="p">,</span> <span class="n">ValidMolCount</span><span class="p">,</span> <span class="n">MinimizationFailedCount</span><span class="p">,</span> <span class="n">TorsionsMissingCount</span><span class="p">,</span> <span class="n">TorsionsScanFailedCount</span><span class="p">)</span>
  324 
  325 <span class="k">def</span> <span class="nf">ScanSingleTorsionInMolUsingMultipleProcessesAtTorsionAnglesLevel</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">TorsionID</span><span class="p">,</span> <span class="n">TorsionPattern</span><span class="p">,</span> <span class="n">TorsionPatternMol</span><span class="p">,</span> <span class="n">TorsionMatches</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">):</span>
  326     <span class="sd">&quot;&quot;&quot;Perform torsion scan for a molecule using multiple processses at torsion angles</span>
  327 <span class="sd">    level along with constrained energy minimization.</span>
  328 <span class="sd">    &quot;&quot;&quot;</span>
  329 
  330     <span class="k">if</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;MPLevelMoleculesMode&quot;</span><span class="p">]:</span>
  331         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintError</span><span class="p">(</span><span class="s2">&quot;Single torison scanning for a molecule is not allowed in multiprocessing mode at molecules level.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
  332 
  333     <span class="n">Mols</span><span class="p">,</span> <span class="n">Angles</span> <span class="o">=</span> <span class="n">SetupMolsForSingleTorsionScanInMol</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">TorsionMatches</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">)</span>
  334 
  335     <span class="n">MPParams</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;MPParams&quot;</span><span class="p">]</span>
  336     
  337     <span class="c1"># Setup data for initializing a worker process...</span>
  338     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Encoding options info...&quot;</span><span class="p">)</span>
  339 
  340     <span class="c1"># Track and avoid encoding TorsionsPatternsInfo as it contains RDKit molecule object...</span>
  341     <span class="n">TorsionsPatternsInfo</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;TorsionsPatternsInfo&quot;</span><span class="p">]</span>
  342     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;TorsionsPatternsInfo&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
  343     
  344     <span class="n">InitializeWorkerProcessArgs</span> <span class="o">=</span> <span class="p">(</span><span class="n">MiscUtil</span><span class="o">.</span><span class="n">ObjectToBase64EncodedString</span><span class="p">(</span><span class="n">Options</span><span class="p">),</span> <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ObjectToBase64EncodedString</span><span class="p">(</span><span class="n">OptionsInfo</span><span class="p">))</span>
  345     
  346     <span class="c1"># Restore TorsionsPatternsInfo...</span>
  347     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;TorsionsPatternsInfo&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">TorsionsPatternsInfo</span>
  348 
  349     <span class="c1"># Setup a encoded mols data iterable for a worker process...</span>
  350     <span class="n">WorkerProcessDataIterable</span> <span class="o">=</span> <span class="n">GenerateBase64EncodedMolStringsWithTorsionScanInfo</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="p">(</span><span class="n">MolNum</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">Mols</span><span class="p">,</span> <span class="n">Angles</span><span class="p">,</span> <span class="n">TorsionID</span><span class="p">,</span> <span class="n">TorsionPattern</span><span class="p">,</span> <span class="n">TorsionPatternMol</span><span class="p">,</span> <span class="n">TorsionMatches</span><span class="p">)</span>
  351     
  352     <span class="c1"># Setup process pool along with data initialization for each process...</span>
  353     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Configuring multiprocessing using </span><span class="si">%s</span><span class="s2"> method...&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s2">&quot;mp.Pool.imap()&quot;</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^Lazy$&quot;</span><span class="p">,</span> <span class="n">MPParams</span><span class="p">[</span><span class="s2">&quot;InputDataMode&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;mp.Pool.map()&quot;</span><span class="p">))</span>
  354     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;NumProcesses: </span><span class="si">%s</span><span class="s2">; InputDataMode: </span><span class="si">%s</span><span class="s2">; ChunkSize: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">MPParams</span><span class="p">[</span><span class="s2">&quot;NumProcesses&quot;</span><span class="p">],</span> <span class="n">MPParams</span><span class="p">[</span><span class="s2">&quot;InputDataMode&quot;</span><span class="p">],</span> <span class="p">(</span><span class="s2">&quot;automatic&quot;</span> <span class="k">if</span> <span class="n">MPParams</span><span class="p">[</span><span class="s2">&quot;ChunkSize&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">MPParams</span><span class="p">[</span><span class="s2">&quot;ChunkSize&quot;</span><span class="p">])))</span>
  355     
  356     <span class="n">ProcessPool</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">MPParams</span><span class="p">[</span><span class="s2">&quot;NumProcesses&quot;</span><span class="p">],</span> <span class="n">InitializeTorsionAngleWorkerProcess</span><span class="p">,</span> <span class="n">InitializeWorkerProcessArgs</span><span class="p">)</span>
  357     
  358     <span class="c1"># Start processing...</span>
  359     <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^Lazy$&quot;</span><span class="p">,</span> <span class="n">MPParams</span><span class="p">[</span><span class="s2">&quot;InputDataMode&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
  360         <span class="n">Results</span> <span class="o">=</span> <span class="n">ProcessPool</span><span class="o">.</span><span class="n">imap</span><span class="p">(</span><span class="n">TorsionAngleWorkerProcess</span><span class="p">,</span> <span class="n">WorkerProcessDataIterable</span><span class="p">,</span> <span class="n">MPParams</span><span class="p">[</span><span class="s2">&quot;ChunkSize&quot;</span><span class="p">])</span>
  361     <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^InMemory$&quot;</span><span class="p">,</span> <span class="n">MPParams</span><span class="p">[</span><span class="s2">&quot;InputDataMode&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
  362         <span class="n">Results</span> <span class="o">=</span> <span class="n">ProcessPool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">TorsionAngleWorkerProcess</span><span class="p">,</span> <span class="n">WorkerProcessDataIterable</span><span class="p">,</span> <span class="n">MPParams</span><span class="p">[</span><span class="s2">&quot;ChunkSize&quot;</span><span class="p">])</span>
  363     <span class="k">else</span><span class="p">:</span>
  364         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintError</span><span class="p">(</span><span class="s2">&quot;The value, </span><span class="si">%s</span><span class="s2">, specified for </span><span class="se">\&quot;</span><span class="s2">--inputDataMode</span><span class="se">\&quot;</span><span class="s2"> is not supported.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">MPParams</span><span class="p">[</span><span class="s2">&quot;InputDataMode&quot;</span><span class="p">]))</span>
  365 
  366     <span class="n">TorsionMols</span> <span class="o">=</span> <span class="p">[]</span>
  367     <span class="n">TorsionEnergies</span> <span class="o">=</span> <span class="p">[]</span>
  368     <span class="n">TorsionAngles</span> <span class="o">=</span> <span class="p">[]</span>
  369     
  370     <span class="k">for</span> <span class="n">Result</span> <span class="ow">in</span> <span class="n">Results</span><span class="p">:</span>
  371         <span class="n">EncodedTorsionMol</span><span class="p">,</span> <span class="n">CalcStatus</span><span class="p">,</span> <span class="n">Angle</span><span class="p">,</span> <span class="n">Energy</span> <span class="o">=</span> <span class="n">Result</span>
  372         
  373         <span class="k">if</span> <span class="ow">not</span> <span class="n">CalcStatus</span><span class="p">:</span>
  374             <span class="k">return</span> <span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
  375 
  376         <span class="k">if</span> <span class="n">EncodedTorsionMol</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
  377             <span class="k">return</span> <span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
  378         <span class="n">TorsionMol</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">MolFromBase64EncodedMolString</span><span class="p">(</span><span class="n">EncodedTorsionMol</span><span class="p">)</span>
  379         
  380         <span class="k">if</span>  <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;RemoveHydrogens&quot;</span><span class="p">]:</span>
  381             <span class="n">TorsionMol</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">RemoveHs</span><span class="p">(</span><span class="n">TorsionMol</span><span class="p">)</span>
  382         
  383         <span class="n">TorsionMols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TorsionMol</span><span class="p">)</span>
  384         <span class="n">TorsionEnergies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Energy</span><span class="p">)</span>
  385         <span class="n">TorsionAngles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Angle</span><span class="p">)</span>
  386     
  387     <span class="k">return</span> <span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="n">TorsionMols</span><span class="p">,</span> <span class="n">TorsionEnergies</span><span class="p">,</span> <span class="n">TorsionAngles</span><span class="p">)</span>
  388 
  389 <span class="k">def</span> <span class="nf">InitializeTorsionAngleWorkerProcess</span><span class="p">(</span><span class="o">*</span><span class="n">EncodedArgs</span><span class="p">):</span>
  390     <span class="sd">&quot;&quot;&quot;Initialize data for a worker process.&quot;&quot;&quot;</span>
  391     
  392     <span class="k">global</span> <span class="n">Options</span><span class="p">,</span> <span class="n">OptionsInfo</span>
  393 
  394     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;Starting process (PID: </span><span class="si">%s</span><span class="s2">)...&quot;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">())</span>
  395 
  396     <span class="c1"># Decode Options and OptionInfo...</span>
  397     <span class="n">Options</span> <span class="o">=</span> <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ObjectFromBase64EncodedString</span><span class="p">(</span><span class="n">EncodedArgs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
  398     <span class="n">OptionsInfo</span> <span class="o">=</span> <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ObjectFromBase64EncodedString</span><span class="p">(</span><span class="n">EncodedArgs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
  399 
  400     <span class="c1"># Initialize torsion patterns info...</span>
  401     <span class="n">SetupTorsionsPatternsInfo</span><span class="p">()</span>
  402 
  403 <span class="k">def</span> <span class="nf">TorsionAngleWorkerProcess</span><span class="p">(</span><span class="n">EncodedMolInfo</span><span class="p">):</span>
  404     <span class="sd">&quot;&quot;&quot;Process data for a worker process.&quot;&quot;&quot;</span>
  405 
  406     <span class="n">MolIndex</span><span class="p">,</span> <span class="n">EncodedMol</span><span class="p">,</span> <span class="n">EncodedTorsionMol</span><span class="p">,</span> <span class="n">TorsionAngle</span><span class="p">,</span> <span class="n">TorsionID</span><span class="p">,</span> <span class="n">TorsionPattern</span><span class="p">,</span> <span class="n">EncodedTorsionPatternMol</span><span class="p">,</span> <span class="n">TorsionMatches</span> <span class="o">=</span> <span class="n">EncodedMolInfo</span>
  407 
  408     <span class="k">if</span> <span class="n">EncodedMol</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">EncodedTorsionMol</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">EncodedTorsionPatternMol</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
  409         <span class="k">return</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
  410     
  411     <span class="n">Mol</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">MolFromBase64EncodedMolString</span><span class="p">(</span><span class="n">EncodedMol</span><span class="p">)</span>
  412     <span class="n">TorsionMol</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">MolFromBase64EncodedMolString</span><span class="p">(</span><span class="n">EncodedTorsionMol</span><span class="p">)</span>
  413     <span class="n">TorsionPatternMol</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">MolFromBase64EncodedMolString</span><span class="p">(</span><span class="n">EncodedTorsionPatternMol</span><span class="p">)</span>
  414     
  415     <span class="n">TorsionMol</span><span class="p">,</span> <span class="n">CalcStatus</span><span class="p">,</span> <span class="n">Energy</span> <span class="o">=</span> <span class="n">MinimizeCalculateEnergyForTorsionMol</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">TorsionMol</span><span class="p">,</span> <span class="n">TorsionAngle</span><span class="p">,</span> <span class="n">TorsionID</span><span class="p">,</span> <span class="n">TorsionPattern</span><span class="p">,</span> <span class="n">TorsionPatternMol</span><span class="p">,</span> <span class="n">TorsionMatches</span><span class="p">,</span> <span class="p">(</span><span class="n">MolIndex</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
  416 
  417     <span class="k">return</span> <span class="p">(</span><span class="n">RDKitUtil</span><span class="o">.</span><span class="n">MolToBase64EncodedMolString</span><span class="p">(</span><span class="n">TorsionMol</span><span class="p">,</span> <span class="n">PropertyPickleFlags</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">PropertyPickleOptions</span><span class="o">.</span><span class="n">MolProps</span> <span class="o">|</span> <span class="n">Chem</span><span class="o">.</span><span class="n">PropertyPickleOptions</span><span class="o">.</span><span class="n">PrivateProps</span><span class="p">),</span> <span class="n">CalcStatus</span><span class="p">,</span> <span class="n">TorsionAngle</span><span class="p">,</span> <span class="n">Energy</span><span class="p">)</span>
  418 
  419 <span class="k">def</span> <span class="nf">GenerateBase64EncodedMolStringsWithTorsionScanInfo</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolIndex</span><span class="p">,</span> <span class="n">TorsionMols</span><span class="p">,</span> <span class="n">TorsionAngles</span><span class="p">,</span> <span class="n">TorsionID</span><span class="p">,</span> <span class="n">TorsionPattern</span><span class="p">,</span> <span class="n">TorsionPatternMol</span><span class="p">,</span> <span class="n">TorsionMatches</span><span class="p">,</span> <span class="n">PropertyPickleFlags</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">PropertyPickleOptions</span><span class="o">.</span><span class="n">AllProps</span><span class="p">):</span>
  420     <span class="sd">&quot;&quot;&quot;Set up an iterator for generating base64 encoded molecule string for</span>
  421 <span class="sd">    a torsion in a molecule along with appropriate trosion scan information.</span>
  422 <span class="sd">    &quot;&quot;&quot;</span>
  423     
  424     <span class="k">for</span> <span class="n">Index</span><span class="p">,</span> <span class="n">TorsionMol</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">TorsionMols</span><span class="p">):</span>
  425         <span class="k">yield</span> <span class="p">[</span><span class="n">MolIndex</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">TorsionAngles</span><span class="p">[</span><span class="n">Index</span><span class="p">],</span> <span class="n">TorsionID</span><span class="p">,</span> <span class="n">TorsionPattern</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">TorsionMatches</span><span class="p">]</span> <span class="k">if</span> <span class="p">(</span><span class="n">Mol</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">TorsionMol</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">MolIndex</span><span class="p">,</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">MolToBase64EncodedMolString</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">PropertyPickleFlags</span><span class="p">),</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">MolToBase64EncodedMolString</span><span class="p">(</span><span class="n">TorsionMol</span><span class="p">,</span> <span class="n">PropertyPickleFlags</span><span class="p">),</span> <span class="n">TorsionAngles</span><span class="p">[</span><span class="n">Index</span><span class="p">],</span> <span class="n">TorsionID</span><span class="p">,</span> <span class="n">TorsionPattern</span><span class="p">,</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">MolToBase64EncodedMolString</span><span class="p">(</span><span class="n">TorsionPatternMol</span><span class="p">,</span> <span class="n">PropertyPickleFlags</span><span class="p">),</span> <span class="n">TorsionMatches</span><span class="p">]</span>
  426 
  427 <span class="k">def</span> <span class="nf">PerformMinimizationAndTorsionScan</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">,</span> <span class="n">UseMultiProcessingAtTorsionAnglesLevel</span> <span class="o">=</span> <span class="bp">False</span><span class="p">):</span>
  428     <span class="sd">&quot;&quot;&quot;Perform minimization and torsions scan.&quot;&quot;&quot;</span>
  429     
  430     <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]:</span>
  431         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Processing molecule </span><span class="si">%s</span><span class="s2">...&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">RDKitUtil</span><span class="o">.</span><span class="n">GetMolName</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">)))</span>
  432         
  433     <span class="n">Mol</span> <span class="o">=</span> <span class="n">AddHydrogens</span><span class="p">(</span><span class="n">Mol</span><span class="p">)</span>
  434     
  435     <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Infile3D&quot;</span><span class="p">]:</span>
  436         <span class="n">Mol</span><span class="p">,</span> <span class="n">MinimizationCalcStatus</span> <span class="o">=</span> <span class="n">MinimizeMolecule</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">)</span>
  437         <span class="k">if</span> <span class="ow">not</span> <span class="n">MinimizationCalcStatus</span><span class="p">:</span>
  438             <span class="k">return</span> <span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
  439         
  440     <span class="n">TorsionsMolInfo</span> <span class="o">=</span> <span class="n">SetupTorsionsMolInfo</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">)</span>
  441     <span class="k">if</span> <span class="n">TorsionsMolInfo</span><span class="p">[</span><span class="s2">&quot;NumOfMatches&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
  442         <span class="k">return</span> <span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
  443     
  444     <span class="n">Mol</span><span class="p">,</span> <span class="n">ScanCalcStatus</span> <span class="o">=</span> <span class="n">ScanAllTorsionsInMol</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">TorsionsMolInfo</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">,</span> <span class="n">UseMultiProcessingAtTorsionAnglesLevel</span><span class="p">)</span>
  445     <span class="k">if</span> <span class="ow">not</span> <span class="n">ScanCalcStatus</span><span class="p">:</span>
  446         <span class="k">return</span> <span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
  447     
  448     <span class="k">return</span> <span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
  449 
  450 <span class="k">def</span> <span class="nf">ScanAllTorsionsInMol</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">TorsionsMolInfo</span><span class="p">,</span>  <span class="n">MolNum</span><span class="p">,</span> <span class="n">UseMultiProcessingAtTorsionAnglesLevel</span> <span class="o">=</span> <span class="bp">False</span><span class="p">):</span>
  451     <span class="sd">&quot;&quot;&quot;Perform scans on all torsions in a molecule.&quot;&quot;&quot;</span>
  452     
  453     <span class="k">if</span> <span class="n">TorsionsMolInfo</span><span class="p">[</span><span class="s2">&quot;NumOfMatches&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
  454         <span class="k">return</span> <span class="n">Mol</span><span class="p">,</span> <span class="bp">True</span>
  455 
  456     <span class="n">MolName</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">GetMolName</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">)</span>
  457     
  458     <span class="n">FirstTorsionMode</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;FirstTorsionMode&quot;</span><span class="p">]</span>
  459     <span class="n">TorsionsPatternsInfo</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;TorsionsPatternsInfo&quot;</span><span class="p">]</span>
  460 
  461     <span class="n">TorsionPatternCount</span><span class="p">,</span> <span class="n">TorsionScanCount</span><span class="p">,</span> <span class="n">TorsionMatchCount</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span>
  462     <span class="n">TorsionMaxMatches</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;TorsionMaxMatches&quot;</span><span class="p">]</span>
  463     
  464     <span class="k">for</span> <span class="n">TorsionID</span> <span class="ow">in</span> <span class="n">TorsionsPatternsInfo</span><span class="p">[</span><span class="s2">&quot;IDs&quot;</span><span class="p">]:</span>
  465         <span class="n">TorsionPatternCount</span> <span class="o">+=</span>  <span class="mi">1</span>
  466         <span class="n">TorsionPattern</span> <span class="o">=</span> <span class="n">TorsionsPatternsInfo</span><span class="p">[</span><span class="s2">&quot;Pattern&quot;</span><span class="p">][</span><span class="n">TorsionID</span><span class="p">]</span>
  467         <span class="n">TorsionPatternMol</span> <span class="o">=</span> <span class="n">TorsionsPatternsInfo</span><span class="p">[</span><span class="s2">&quot;Mol&quot;</span><span class="p">][</span><span class="n">TorsionID</span><span class="p">]</span>
  468         
  469         <span class="n">TorsionsMatches</span> <span class="o">=</span> <span class="n">TorsionsMolInfo</span><span class="p">[</span><span class="s2">&quot;Matches&quot;</span><span class="p">][</span><span class="n">TorsionID</span><span class="p">]</span>
  470 
  471         <span class="k">if</span> <span class="n">TorsionsMatches</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
  472             <span class="k">continue</span>
  473         
  474         <span class="k">if</span> <span class="n">FirstTorsionMode</span> <span class="ow">and</span> <span class="n">TorsionPatternCount</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
  475             <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]:</span>
  476                 <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintWarning</span><span class="p">(</span><span class="s2">&quot;Already scaned first torsion pattern, </span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2"> for molecule </span><span class="si">%s</span><span class="s2"> during </span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2"> value of </span><span class="se">\&quot;</span><span class="s2">--modeTorsions</span><span class="se">\&quot;</span><span class="s2"> option . Abandoning torsion scan...</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">TorsionPattern</span><span class="p">,</span> <span class="n">MolName</span><span class="p">,</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;ModeTorsions&quot;</span><span class="p">]))</span>
  477             <span class="k">break</span>
  478 
  479         <span class="k">for</span> <span class="n">Index</span><span class="p">,</span> <span class="n">TorsionMatches</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">TorsionsMatches</span><span class="p">):</span>
  480             <span class="n">TorsionMatchNum</span> <span class="o">=</span> <span class="n">Index</span> <span class="o">+</span> <span class="mi">1</span>
  481             <span class="n">TorsionMatchCount</span> <span class="o">+=</span>  <span class="mi">1</span>
  482 
  483             <span class="k">if</span> <span class="n">TorsionMatchCount</span> <span class="o">&gt;</span> <span class="n">TorsionMaxMatches</span><span class="p">:</span>
  484                 <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]:</span>
  485                     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintWarning</span><span class="p">(</span><span class="s2">&quot;Already scaned a maximum of </span><span class="si">%s</span><span class="s2"> torsion matches for molecule </span><span class="si">%s</span><span class="s2"> specified by </span><span class="se">\&quot;</span><span class="s2">--torsionMaxMatches</span><span class="se">\&quot;</span><span class="s2"> option. Abandoning torsion scan...</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">TorsionMaxMatches</span><span class="p">,</span> <span class="n">MolName</span><span class="p">))</span>
  486                 <span class="k">break</span>
  487 
  488             <span class="n">TmpMol</span><span class="p">,</span> <span class="n">TorsionScanStatus</span><span class="p">,</span>  <span class="n">TorsionMols</span><span class="p">,</span> <span class="n">TorsionEnergies</span><span class="p">,</span> <span class="n">TorsionAngles</span> <span class="o">=</span> <span class="n">ScanSingleTorsionInMol</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">TorsionID</span><span class="p">,</span> <span class="n">TorsionPattern</span><span class="p">,</span> <span class="n">TorsionPatternMol</span><span class="p">,</span> <span class="n">TorsionMatches</span><span class="p">,</span>  <span class="n">TorsionMatchNum</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">,</span> <span class="n">UseMultiProcessingAtTorsionAnglesLevel</span><span class="p">)</span>
  489             <span class="k">if</span> <span class="ow">not</span> <span class="n">TorsionScanStatus</span><span class="p">:</span>
  490                 <span class="k">continue</span>
  491             
  492             <span class="n">TorsionScanCount</span> <span class="o">+=</span>  <span class="mi">1</span>
  493             <span class="n">GenerateOutputFiles</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">,</span> <span class="n">TorsionID</span><span class="p">,</span> <span class="n">TorsionMatchNum</span><span class="p">,</span> <span class="n">TorsionMols</span><span class="p">,</span> <span class="n">TorsionEnergies</span><span class="p">,</span> <span class="n">TorsionAngles</span><span class="p">)</span>
  494         
  495         <span class="k">if</span> <span class="n">TorsionMatchCount</span> <span class="o">&gt;</span> <span class="n">TorsionMaxMatches</span><span class="p">:</span>
  496             <span class="k">break</span>
  497     
  498     <span class="k">if</span>  <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;RemoveHydrogens&quot;</span><span class="p">]:</span>
  499         <span class="n">Mol</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">RemoveHs</span><span class="p">(</span><span class="n">Mol</span><span class="p">)</span>
  500 
  501     <span class="k">if</span> <span class="n">TorsionScanCount</span><span class="p">:</span>
  502         <span class="n">GenerateStartingTorsionScanStructureOutfile</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">)</span>
  503 
  504     <span class="n">Status</span> <span class="o">=</span> <span class="bp">True</span> <span class="k">if</span> <span class="n">TorsionScanCount</span> <span class="k">else</span> <span class="bp">False</span>
  505     
  506     <span class="k">return</span> <span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">Status</span><span class="p">)</span>
  507 
  508 <span class="k">def</span> <span class="nf">ScanSingleTorsionInMol</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">TorsionID</span><span class="p">,</span> <span class="n">TorsionPattern</span><span class="p">,</span> <span class="n">TorsionPatternMol</span><span class="p">,</span> <span class="n">TorsionMatches</span><span class="p">,</span> <span class="n">TorsionMatchNum</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">,</span> <span class="n">UseMultiProcessingAtTorsionAnglesLevel</span><span class="p">):</span>
  509     <span class="sd">&quot;&quot;&quot;Perform torsion scan for a molecule along with constrained energy minimization.&quot;&quot;&quot;</span>
  510     
  511     <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]:</span>
  512         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;Processing torsion pattern, </span><span class="si">%s</span><span class="s2">, match number, </span><span class="si">%s</span><span class="s2">, in molecule </span><span class="si">%s</span><span class="s2">...&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">TorsionPattern</span><span class="p">,</span> <span class="n">TorsionMatchNum</span><span class="p">,</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">GetMolName</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">)))</span>
  513     
  514     <span class="k">if</span> <span class="n">UseMultiProcessingAtTorsionAnglesLevel</span><span class="p">:</span>
  515         <span class="k">return</span> <span class="n">ScanSingleTorsionInMolUsingMultipleProcessesAtTorsionAnglesLevel</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">TorsionID</span><span class="p">,</span> <span class="n">TorsionPattern</span><span class="p">,</span> <span class="n">TorsionPatternMol</span><span class="p">,</span> <span class="n">TorsionMatches</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">)</span>
  516     <span class="k">else</span><span class="p">:</span>
  517         <span class="k">return</span> <span class="n">ScanSingleTorsionInMolUsingSingleProcess</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">TorsionID</span><span class="p">,</span> <span class="n">TorsionPattern</span><span class="p">,</span> <span class="n">TorsionPatternMol</span><span class="p">,</span> <span class="n">TorsionMatches</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">)</span>
  518 
  519 <span class="k">def</span> <span class="nf">ScanSingleTorsionInMolUsingSingleProcess</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">TorsionID</span><span class="p">,</span> <span class="n">TorsionPattern</span><span class="p">,</span> <span class="n">TorsionPatternMol</span><span class="p">,</span> <span class="n">TorsionMatches</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">):</span>
  520     <span class="sd">&quot;&quot;&quot;Perform torsion scan for a molecule using single processs along with constrained</span>
  521 <span class="sd">    energy minimization.&quot;&quot;&quot;</span>
  522 
  523     <span class="n">TorsionMols</span> <span class="o">=</span> <span class="p">[]</span>
  524     <span class="n">TorsionEnergies</span> <span class="o">=</span> <span class="p">[]</span>
  525     <span class="n">TorsionAngles</span> <span class="o">=</span> <span class="p">[]</span>
  526 
  527     <span class="n">Mols</span><span class="p">,</span> <span class="n">Angles</span> <span class="o">=</span> <span class="n">SetupMolsForSingleTorsionScanInMol</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">TorsionMatches</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">)</span>
  528     
  529     <span class="k">for</span> <span class="n">Index</span><span class="p">,</span> <span class="n">Angle</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">Angles</span><span class="p">):</span>
  530         <span class="n">TorsionMol</span> <span class="o">=</span> <span class="n">Mols</span><span class="p">[</span><span class="n">Index</span><span class="p">]</span>
  531         <span class="n">TorsionMol</span><span class="p">,</span> <span class="n">CalcStatus</span><span class="p">,</span> <span class="n">Energy</span> <span class="o">=</span> <span class="n">MinimizeCalculateEnergyForTorsionMol</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">TorsionMol</span><span class="p">,</span> <span class="n">Angle</span><span class="p">,</span> <span class="n">TorsionID</span><span class="p">,</span> <span class="n">TorsionPattern</span><span class="p">,</span> <span class="n">TorsionPatternMol</span><span class="p">,</span> <span class="n">TorsionMatches</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">)</span>
  532         
  533         <span class="k">if</span> <span class="ow">not</span> <span class="n">CalcStatus</span><span class="p">:</span>
  534             <span class="k">return</span> <span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
  535         
  536         <span class="k">if</span>  <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;RemoveHydrogens&quot;</span><span class="p">]:</span>
  537             <span class="n">TorsionMol</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">RemoveHs</span><span class="p">(</span><span class="n">TorsionMol</span><span class="p">)</span>
  538         
  539         <span class="n">TorsionMols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TorsionMol</span><span class="p">)</span>
  540         <span class="n">TorsionEnergies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Energy</span><span class="p">)</span>
  541         <span class="n">TorsionAngles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Angle</span><span class="p">)</span>
  542     
  543     <span class="k">return</span> <span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="n">TorsionMols</span><span class="p">,</span> <span class="n">TorsionEnergies</span><span class="p">,</span> <span class="n">TorsionAngles</span><span class="p">)</span>
  544 
  545 <span class="k">def</span> <span class="nf">SetupMolsForSingleTorsionScanInMol</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">TorsionMatches</span><span class="p">,</span> <span class="n">MolNum</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
  546     <span class="sd">&quot;&quot;&quot;Setup molecules corresponding to all torsion angles in a molecule.&quot;&quot;&quot;</span>
  547 
  548     <span class="n">StartAngle</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;TorsionStart&quot;</span><span class="p">]</span>
  549     <span class="n">StopAngle</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;TorsionStop&quot;</span><span class="p">]</span>
  550     <span class="n">StepSize</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;TorsionStep&quot;</span><span class="p">]</span>
  551     
  552     <span class="n">AtomIndex1</span><span class="p">,</span> <span class="n">AtomIndex2</span><span class="p">,</span> <span class="n">AtomIndex3</span><span class="p">,</span> <span class="n">AtomIndex4</span> <span class="o">=</span> <span class="n">TorsionMatches</span>
  553 
  554     <span class="n">TorsionMols</span> <span class="o">=</span> <span class="p">[]</span>
  555     
  556     <span class="n">TorsionAngles</span> <span class="o">=</span> <span class="p">[</span><span class="n">Angle</span> <span class="k">for</span> <span class="n">Angle</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">StartAngle</span><span class="p">,</span> <span class="n">StopAngle</span><span class="p">,</span> <span class="n">StepSize</span><span class="p">)]</span>
  557     <span class="n">TorsionAngles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">StopAngle</span><span class="p">)</span>
  558 
  559     <span class="k">for</span> <span class="n">Angle</span> <span class="ow">in</span> <span class="n">TorsionAngles</span><span class="p">:</span>
  560         <span class="n">TorsionMol</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">Mol</span><span class="p">(</span><span class="n">Mol</span><span class="p">)</span>
  561         <span class="n">TorsionMolConf</span> <span class="o">=</span> <span class="n">TorsionMol</span><span class="o">.</span><span class="n">GetConformer</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
  562         
  563         <span class="n">rdMolTransforms</span><span class="o">.</span><span class="n">SetDihedralDeg</span><span class="p">(</span><span class="n">TorsionMolConf</span><span class="p">,</span> <span class="n">AtomIndex1</span><span class="p">,</span> <span class="n">AtomIndex2</span><span class="p">,</span> <span class="n">AtomIndex3</span><span class="p">,</span> <span class="n">AtomIndex4</span><span class="p">,</span> <span class="n">Angle</span><span class="p">)</span>
  564         <span class="n">TorsionMols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TorsionMol</span><span class="p">)</span>
  565     
  566     <span class="k">return</span> <span class="p">(</span><span class="n">TorsionMols</span><span class="p">,</span> <span class="n">TorsionAngles</span><span class="p">)</span>
  567 
  568 <span class="k">def</span> <span class="nf">MinimizeCalculateEnergyForTorsionMol</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">TorsionMol</span><span class="p">,</span> <span class="n">TorsionAngle</span><span class="p">,</span> <span class="n">TorsionID</span><span class="p">,</span> <span class="n">TorsionPattern</span><span class="p">,</span> <span class="n">TorsionPatternMol</span><span class="p">,</span> <span class="n">TorsionMatches</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">):</span>
  569     <span class="sd">&quot;&quot;&quot;&quot;Calculate energy of a torsion molecule by performing an optional constrained</span>
  570 <span class="sd">    energy minimzation.</span>
  571 <span class="sd">    &quot;&quot;&quot;</span>
  572 
  573     <span class="k">if</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;TorsionMinimize&quot;</span><span class="p">]:</span>
  574         <span class="c1"># Perform constrained minimization...</span>
  575         <span class="n">TorsionMatchesMol</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">MolFromSubstructureMatch</span><span class="p">(</span><span class="n">TorsionMol</span><span class="p">,</span> <span class="n">TorsionPatternMol</span><span class="p">,</span> <span class="n">TorsionMatches</span><span class="p">)</span>
  576         <span class="n">TorsionMol</span><span class="p">,</span> <span class="n">CalcStatus</span><span class="p">,</span> <span class="n">Energy</span> <span class="o">=</span> <span class="n">ConstrainAndMinimizeMolecule</span><span class="p">(</span><span class="n">TorsionMol</span><span class="p">,</span> <span class="n">TorsionMatchesMol</span><span class="p">,</span> <span class="n">TorsionMatches</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">)</span>
  577         
  578         <span class="k">if</span> <span class="ow">not</span> <span class="n">CalcStatus</span><span class="p">:</span>
  579             <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]:</span>
  580                 <span class="n">MolName</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">GetMolName</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">)</span>
  581                 <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintWarning</span><span class="p">(</span><span class="s2">&quot;Failed to perform constrained minimization for molecule </span><span class="si">%s</span><span class="s2"> with torsion angle set to </span><span class="si">%s</span><span class="s2"> during torsion scan for torsion pattern </span><span class="si">%s</span><span class="s2">. Abandoning torsion scan...&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">MolName</span><span class="p">,</span> <span class="n">TorsionAngle</span><span class="p">,</span> <span class="n">TorsionPattern</span><span class="p">))</span>
  582             <span class="k">return</span> <span class="p">(</span><span class="n">TorsionMol</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
  583     <span class="k">else</span><span class="p">:</span>
  584         <span class="c1"># Calculate energy...</span>
  585         <span class="n">CalcStatus</span><span class="p">,</span> <span class="n">Energy</span> <span class="o">=</span> <span class="n">GetEnergy</span><span class="p">(</span><span class="n">TorsionMol</span><span class="p">)</span>
  586         <span class="k">if</span> <span class="ow">not</span> <span class="n">CalcStatus</span><span class="p">:</span>
  587             <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]:</span>
  588                 <span class="n">MolName</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">GetMolName</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">)</span>
  589                 <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintWarning</span><span class="p">(</span><span class="s2">&quot;Failed to retrieve calculated energy for molecule </span><span class="si">%s</span><span class="s2"> with torsion angle set to </span><span class="si">%s</span><span class="s2"> during torsion scan for torsion pattern </span><span class="si">%s</span><span class="s2">. Abandoning torsion scan...&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">MolName</span><span class="p">,</span> <span class="n">TorsionAngle</span><span class="p">,</span> <span class="n">TorsionPattern</span><span class="p">))</span>
  590             <span class="k">return</span> <span class="p">(</span><span class="n">TorsionMol</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
  591         
  592     <span class="k">return</span> <span class="p">(</span><span class="n">TorsionMol</span><span class="p">,</span> <span class="n">CalcStatus</span><span class="p">,</span> <span class="n">Energy</span><span class="p">)</span>
  593 
  594 <span class="k">def</span> <span class="nf">SetupTorsionsMolInfo</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
  595     <span class="sd">&quot;&quot;&quot;Setup torsions info for a molecule.&quot;&quot;&quot;</span>
  596 
  597     <span class="n">TorsionsPatternsInfo</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;TorsionsPatternsInfo&quot;</span><span class="p">]</span>
  598     
  599     <span class="c1"># Initialize...</span>
  600     <span class="n">TorsionsMolInfo</span> <span class="o">=</span> <span class="p">{}</span>
  601     <span class="n">TorsionsMolInfo</span><span class="p">[</span><span class="s2">&quot;IDs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
  602     <span class="n">TorsionsMolInfo</span><span class="p">[</span><span class="s2">&quot;NumOfMatches&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
  603     <span class="n">TorsionsMolInfo</span><span class="p">[</span><span class="s2">&quot;Matches&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
  604     <span class="k">for</span> <span class="n">TorsionID</span> <span class="ow">in</span> <span class="n">TorsionsPatternsInfo</span><span class="p">[</span><span class="s2">&quot;IDs&quot;</span><span class="p">]:</span>
  605         <span class="n">TorsionsMolInfo</span><span class="p">[</span><span class="s2">&quot;IDs&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TorsionID</span><span class="p">)</span>
  606         <span class="n">TorsionsMolInfo</span><span class="p">[</span><span class="s2">&quot;Matches&quot;</span><span class="p">][</span><span class="n">TorsionID</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
  607     
  608     <span class="n">MolName</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">GetMolName</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">)</span>
  609     <span class="n">UseChirality</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;UseChirality&quot;</span><span class="p">]</span>
  610     
  611     <span class="k">for</span> <span class="n">TorsionID</span> <span class="ow">in</span> <span class="n">TorsionsPatternsInfo</span><span class="p">[</span><span class="s2">&quot;IDs&quot;</span><span class="p">]:</span>
  612         <span class="c1"># Match torsions..</span>
  613         <span class="n">TorsionPattern</span> <span class="o">=</span> <span class="n">TorsionsPatternsInfo</span><span class="p">[</span><span class="s2">&quot;Pattern&quot;</span><span class="p">][</span><span class="n">TorsionID</span><span class="p">]</span>
  614         <span class="n">TorsionPatternMol</span> <span class="o">=</span> <span class="n">TorsionsPatternsInfo</span><span class="p">[</span><span class="s2">&quot;Mol&quot;</span><span class="p">][</span><span class="n">TorsionID</span><span class="p">]</span>
  615         <span class="n">TorsionsMatches</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">FilterSubstructureMatchesByAtomMapNumbers</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">TorsionPatternMol</span><span class="p">,</span> <span class="n">Mol</span><span class="o">.</span><span class="n">GetSubstructMatches</span><span class="p">(</span><span class="n">TorsionPatternMol</span><span class="p">,</span> <span class="n">useChirality</span> <span class="o">=</span> <span class="n">UseChirality</span><span class="p">))</span>
  616         
  617         <span class="c1"># Validate tosion matches...</span>
  618         <span class="n">ValidTorsionsMatches</span> <span class="o">=</span> <span class="p">[]</span>
  619         <span class="k">for</span> <span class="n">Index</span><span class="p">,</span> <span class="n">TorsionMatch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">TorsionsMatches</span><span class="p">):</span>
  620             <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">TorsionMatch</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">:</span>
  621                 <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]:</span>
  622                     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintWarning</span><span class="p">(</span><span class="s2">&quot;Ignoring invalid torsion match to atom indices, </span><span class="si">%s</span><span class="s2">, for torsion pattern, </span><span class="si">%s</span><span class="s2">, in molecule </span><span class="si">%s</span><span class="s2">: It must match exactly 4 atoms.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">TorsionMatch</span><span class="p">,</span> <span class="n">TorsionPattern</span><span class="p">,</span> <span class="n">MolName</span><span class="p">))</span>
  623                 <span class="k">continue</span>
  624             
  625             <span class="k">if</span> <span class="ow">not</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">AreAtomIndicesSequentiallyConnected</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">TorsionMatch</span><span class="p">):</span>
  626                 <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]:</span>
  627                     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
  628                     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintWarning</span><span class="p">(</span><span class="s2">&quot;Invalid torsion match to atom indices, </span><span class="si">%s</span><span class="s2">, for torsion pattern, </span><span class="si">%s</span><span class="s2">, in molecule </span><span class="si">%s</span><span class="s2">: Matched atom indices must be sequentially connected.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">TorsionMatch</span><span class="p">,</span> <span class="n">TorsionPattern</span><span class="p">,</span> <span class="n">MolName</span><span class="p">))</span>
  629                     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintWarning</span><span class="p">(</span><span class="s2">&quot;Reordering matched atom indices in a sequentially connected manner...&quot;</span><span class="p">)</span>
  630                 
  631                 <span class="n">Status</span><span class="p">,</span> <span class="n">ReorderdTorsionMatch</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">ReorderAtomIndicesInSequentiallyConnectedManner</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">TorsionMatch</span><span class="p">)</span>
  632                 <span class="k">if</span> <span class="n">Status</span><span class="p">:</span>
  633                     <span class="n">TorsionMatch</span> <span class="o">=</span> <span class="n">ReorderdTorsionMatch</span>
  634                     <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]:</span>
  635                         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintWarning</span><span class="p">(</span><span class="s2">&quot;Successfully reordered torsion match to atom indices, </span><span class="si">%s</span><span class="s2">, for torsion pattern, </span><span class="si">%s</span><span class="s2">, in molecule </span><span class="si">%s</span><span class="s2">: Matched atom indices are now sequentially connected.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">TorsionMatch</span><span class="p">,</span> <span class="n">TorsionPattern</span><span class="p">,</span> <span class="n">MolName</span><span class="p">))</span>
  636                 <span class="k">else</span><span class="p">:</span>
  637                     <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]:</span>
  638                         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintWarning</span><span class="p">(</span><span class="s2">&quot;Ignoring torsion match. Failed to reorder torsion match to atom indices, </span><span class="si">%s</span><span class="s2">, for torsion pattern, </span><span class="si">%s</span><span class="s2">, in molecule </span><span class="si">%s</span><span class="s2">: Matched atom indices are not sequentially connected.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">TorsionMatch</span><span class="p">,</span> <span class="n">TorsionPattern</span><span class="p">,</span> <span class="n">MolName</span><span class="p">))</span>
  639                     <span class="k">continue</span>
  640             
  641             <span class="n">Bond</span> <span class="o">=</span> <span class="n">Mol</span><span class="o">.</span><span class="n">GetBondBetweenAtoms</span><span class="p">(</span><span class="n">TorsionMatch</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">TorsionMatch</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
  642             <span class="k">if</span> <span class="n">Bond</span><span class="o">.</span><span class="n">IsInRing</span><span class="p">():</span>
  643                 <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]:</span>
  644                     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintWarning</span><span class="p">(</span><span class="s2">&quot;Ignoring invalid torsion match to atom indices, </span><span class="si">%s</span><span class="s2">, for torsion pattern, </span><span class="si">%s</span><span class="s2">, in molecule </span><span class="si">%s</span><span class="s2">: Matched atom indices, </span><span class="si">%s</span><span class="s2"> and </span><span class="si">%s</span><span class="s2">, are not allowed to be in a ring.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">TorsionMatch</span><span class="p">,</span> <span class="n">TorsionPattern</span><span class="p">,</span> <span class="n">MolName</span><span class="p">,</span> <span class="n">TorsionMatch</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">TorsionMatch</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
  645                 <span class="k">continue</span>
  646             
  647             <span class="c1"># Filter matched torsions...</span>
  648             <span class="k">if</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;FilterTorsionsByAtomIndicesMode&quot;</span><span class="p">]:</span>
  649                 <span class="n">InvalidAtomIndices</span> <span class="o">=</span> <span class="p">[]</span>
  650                 <span class="k">for</span> <span class="n">AtomIndex</span> <span class="ow">in</span> <span class="n">TorsionMatch</span><span class="p">:</span>
  651                     <span class="k">if</span> <span class="n">AtomIndex</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;TorsionsFilterByAtomIndicesList&quot;</span><span class="p">]:</span>
  652                         <span class="n">InvalidAtomIndices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">AtomIndex</span><span class="p">)</span>
  653                 <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">InvalidAtomIndices</span><span class="p">):</span>
  654                     <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]:</span>
  655                         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintWarning</span><span class="p">(</span><span class="s2">&quot;Ignoring invalid torsion match to atom indices, </span><span class="si">%s</span><span class="s2">, for torsion pattern, </span><span class="si">%s</span><span class="s2">, in molecule </span><span class="si">%s</span><span class="s2">: Matched atom indices, </span><span class="si">%s</span><span class="s2">,  must be present in the list, </span><span class="si">%s</span><span class="s2">, specified using option </span><span class="se">\&quot;</span><span class="s2">--torsionsFilterbyAtomIndices</span><span class="se">\&quot;</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">TorsionMatch</span><span class="p">,</span> <span class="n">TorsionPattern</span><span class="p">,</span> <span class="n">MolName</span><span class="p">,</span> <span class="n">InvalidAtomIndices</span><span class="p">,</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;TorsionsFilterByAtomIndicesList&quot;</span><span class="p">]))</span>
  656                     <span class="k">continue</span>
  657             
  658             <span class="n">ValidTorsionsMatches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TorsionMatch</span><span class="p">)</span>
  659         
  660         <span class="c1"># Track valid matches...</span>
  661         <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ValidTorsionsMatches</span><span class="p">):</span>
  662             <span class="n">TorsionsMolInfo</span><span class="p">[</span><span class="s2">&quot;NumOfMatches&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ValidTorsionsMatches</span><span class="p">)</span>
  663             <span class="n">TorsionsMolInfo</span><span class="p">[</span><span class="s2">&quot;Matches&quot;</span><span class="p">][</span><span class="n">TorsionID</span><span class="p">]</span> <span class="o">=</span> <span class="n">ValidTorsionsMatches</span>
  664         
  665     <span class="k">if</span> <span class="n">TorsionsMolInfo</span><span class="p">[</span><span class="s2">&quot;NumOfMatches&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
  666         <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]:</span>
  667             <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintWarning</span><span class="p">(</span><span class="s2">&quot;Failed to match any torsions  in molecule </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">MolName</span><span class="p">))</span>
  668 
  669     <span class="k">return</span> <span class="n">TorsionsMolInfo</span>
  670 
  671 <span class="k">def</span> <span class="nf">SetupTorsionsPatternsInfo</span><span class="p">():</span>
  672     <span class="sd">&quot;&quot;&quot;Setup torsions patterns info.&quot;&quot;&quot;</span>
  673 
  674     <span class="n">TorsionsPatternsInfo</span> <span class="o">=</span> <span class="p">{}</span>
  675     <span class="n">TorsionsPatternsInfo</span><span class="p">[</span><span class="s2">&quot;IDs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
  676     <span class="n">TorsionsPatternsInfo</span><span class="p">[</span><span class="s2">&quot;Pattern&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
  677     <span class="n">TorsionsPatternsInfo</span><span class="p">[</span><span class="s2">&quot;Mol&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
  678 
  679     <span class="n">TorsionID</span> <span class="o">=</span> <span class="mi">0</span>
  680     <span class="k">for</span> <span class="n">TorsionPattern</span> <span class="ow">in</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;TorsionPatternsList&quot;</span><span class="p">]:</span>
  681         <span class="n">TorsionID</span> <span class="o">+=</span> <span class="mi">1</span>
  682         
  683         <span class="n">TorsionMol</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">MolFromSmarts</span><span class="p">(</span><span class="n">TorsionPattern</span><span class="p">)</span>
  684         <span class="k">if</span> <span class="n">TorsionMol</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
  685             <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintError</span><span class="p">(</span><span class="s2">&quot;Failed to create torsion pattern molecule. The torsion SMILES/SMARTS pattern, </span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2">, specified using </span><span class="se">\&quot;</span><span class="s2">-t, --torsions</span><span class="se">\&quot;</span><span class="s2"> option is not valid.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">TorsionPattern</span><span class="p">))</span>
  686         
  687         <span class="n">TorsionsPatternsInfo</span><span class="p">[</span><span class="s2">&quot;IDs&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TorsionID</span><span class="p">)</span>
  688         <span class="n">TorsionsPatternsInfo</span><span class="p">[</span><span class="s2">&quot;Pattern&quot;</span><span class="p">][</span><span class="n">TorsionID</span><span class="p">]</span> <span class="o">=</span> <span class="n">TorsionPattern</span>
  689         <span class="n">TorsionsPatternsInfo</span><span class="p">[</span><span class="s2">&quot;Mol&quot;</span><span class="p">][</span><span class="n">TorsionID</span><span class="p">]</span> <span class="o">=</span> <span class="n">TorsionMol</span>
  690 
  691     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;TorsionsPatternsInfo&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">TorsionsPatternsInfo</span>
  692     
  693 <span class="k">def</span> <span class="nf">MinimizeMolecule</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
  694     <span class="sd">&quot;&quot;&quot;Generate and minimize conformers for a molecule to get the lowest energy conformer.&quot;&quot;&quot;</span>
  695 
  696     <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]:</span>
  697         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;Minimizing molecule </span><span class="si">%s</span><span class="s2">...&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">RDKitUtil</span><span class="o">.</span><span class="n">GetMolName</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">)))</span>
  698         
  699     <span class="n">ConfIDs</span> <span class="o">=</span> <span class="n">EmbedMolecule</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">)</span>
  700     <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">ConfIDs</span><span class="p">):</span>
  701         <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]:</span>
  702             <span class="n">MolName</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">GetMolName</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">)</span>
  703             <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintWarning</span><span class="p">(</span><span class="s2">&quot;Minimization couldn&#39;t be performed for molecule </span><span class="si">%s</span><span class="s2">: Embedding failed...</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">MolName</span><span class="p">)</span>
  704         <span class="k">return</span> <span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
  705 
  706     <span class="n">CalcEnergyMap</span> <span class="o">=</span> <span class="p">{}</span>
  707     <span class="k">for</span> <span class="n">ConfID</span> <span class="ow">in</span> <span class="n">ConfIDs</span><span class="p">:</span>
  708         <span class="k">try</span><span class="p">:</span>
  709             <span class="k">if</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;UseUFF&quot;</span><span class="p">]:</span>
  710                 <span class="n">Status</span> <span class="o">=</span> <span class="n">AllChem</span><span class="o">.</span><span class="n">UFFOptimizeMolecule</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">confId</span> <span class="o">=</span> <span class="n">ConfID</span><span class="p">,</span> <span class="n">maxIters</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;MaxIters&quot;</span><span class="p">])</span>
  711             <span class="k">elif</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;UseMMFF&quot;</span><span class="p">]:</span>
  712                 <span class="n">Status</span> <span class="o">=</span> <span class="n">AllChem</span><span class="o">.</span><span class="n">MMFFOptimizeMolecule</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">confId</span> <span class="o">=</span> <span class="n">ConfID</span><span class="p">,</span> <span class="n">maxIters</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;MaxIters&quot;</span><span class="p">],</span> <span class="n">mmffVariant</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;MMFFVariant&quot;</span><span class="p">])</span>
  713             <span class="k">else</span><span class="p">:</span>
  714                 <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintError</span><span class="p">(</span><span class="s2">&quot;Minimization couldn&#39;t be performed: Specified forcefield, </span><span class="si">%s</span><span class="s2">, is not supported&quot;</span> <span class="o">%</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;ForceField&quot;</span><span class="p">])</span>
  715         <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">RuntimeError</span><span class="p">,</span> <span class="n">Chem</span><span class="o">.</span><span class="n">rdchem</span><span class="o">.</span><span class="n">KekulizeException</span><span class="p">)</span> <span class="k">as</span> <span class="n">ErrMsg</span><span class="p">:</span>
  716             <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]:</span>
  717                 <span class="n">MolName</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">GetMolName</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">)</span>
  718                 <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintWarning</span><span class="p">(</span><span class="s2">&quot;Minimization couldn&#39;t be performed for molecule </span><span class="si">%s</span><span class="s2">:</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">MolName</span><span class="p">,</span> <span class="n">ErrMsg</span><span class="p">))</span>
  719             <span class="k">return</span> <span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
  720         
  721         <span class="n">EnergyStatus</span><span class="p">,</span> <span class="n">Energy</span> <span class="o">=</span> <span class="n">GetEnergy</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">ConfID</span><span class="p">)</span>
  722         <span class="k">if</span> <span class="ow">not</span> <span class="n">EnergyStatus</span><span class="p">:</span>
  723             <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]:</span>
  724                 <span class="n">MolName</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">GetMolName</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">)</span>
  725                 <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintWarning</span><span class="p">(</span><span class="s2">&quot;Failed to retrieve calculated energy for conformation number </span><span class="si">%d</span><span class="s2"> of molecule </span><span class="si">%s</span><span class="s2">. Try again after removing any salts or cleaing up the molecule...</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ConfID</span><span class="p">,</span> <span class="n">MolName</span><span class="p">))</span>
  726             <span class="k">return</span> <span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
  727         
  728         <span class="k">if</span> <span class="n">Status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
  729             <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]:</span>
  730                 <span class="n">MolName</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">GetMolName</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">)</span>
  731                 <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintWarning</span><span class="p">(</span><span class="s2">&quot;Minimization failed to converge for conformation number </span><span class="si">%d</span><span class="s2"> of molecule </span><span class="si">%s</span><span class="s2"> in </span><span class="si">%d</span><span class="s2"> steps. Try using higher value for </span><span class="se">\&quot;</span><span class="s2">--maxIters</span><span class="se">\&quot;</span><span class="s2"> option...</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ConfID</span><span class="p">,</span> <span class="n">MolName</span><span class="p">,</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;MaxIters&quot;</span><span class="p">]))</span>
  732             
  733         <span class="n">CalcEnergyMap</span><span class="p">[</span><span class="n">ConfID</span><span class="p">]</span> <span class="o">=</span> <span class="n">Energy</span>
  734     
  735     <span class="n">SortedConfIDs</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">ConfIDs</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">ConfID</span><span class="p">:</span> <span class="n">CalcEnergyMap</span><span class="p">[</span><span class="n">ConfID</span><span class="p">])</span>
  736     <span class="n">MinEnergyConfID</span> <span class="o">=</span> <span class="n">SortedConfIDs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
  737         
  738     <span class="k">for</span> <span class="n">ConfID</span> <span class="ow">in</span> <span class="p">[</span><span class="n">Conf</span><span class="o">.</span><span class="n">GetId</span><span class="p">()</span> <span class="k">for</span> <span class="n">Conf</span> <span class="ow">in</span> <span class="n">Mol</span><span class="o">.</span><span class="n">GetConformers</span><span class="p">()]:</span>
  739         <span class="k">if</span> <span class="n">ConfID</span> <span class="o">==</span> <span class="n">MinEnergyConfID</span><span class="p">:</span>
  740             <span class="k">continue</span>
  741         <span class="n">Mol</span><span class="o">.</span><span class="n">RemoveConformer</span><span class="p">(</span><span class="n">ConfID</span><span class="p">)</span>
  742     
  743     <span class="c1"># Set ConfID to 0 for MinEnergyConf...</span>
  744     <span class="n">Mol</span><span class="o">.</span><span class="n">GetConformer</span><span class="p">(</span><span class="n">MinEnergyConfID</span><span class="p">)</span><span class="o">.</span><span class="n">SetId</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
  745 
  746     <span class="k">return</span> <span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
  747 
  748 <span class="k">def</span> <span class="nf">ConstrainAndMinimizeMolecule</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">RefMolCore</span><span class="p">,</span> <span class="n">RefMolMatches</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">MolNum</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
  749     <span class="sd">&quot;&quot;&quot;Constrain and Minimize molecule.&quot;&quot;&quot;</span>
  750 
  751     <span class="c1"># Setup forcefield function to use for constrained minimization...</span>
  752     <span class="n">ForceFieldFunction</span> <span class="o">=</span> <span class="bp">None</span>
  753     <span class="n">ForceFieldName</span> <span class="o">=</span> <span class="bp">None</span>
  754     <span class="k">if</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;UseUFF&quot;</span><span class="p">]:</span>
  755         <span class="n">ForceFieldFunction</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">mol</span><span class="p">,</span> <span class="n">confId</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="p">:</span> <span class="n">AllChem</span><span class="o">.</span><span class="n">UFFGetMoleculeForceField</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">confId</span> <span class="o">=</span> <span class="n">confId</span><span class="p">)</span>
  756         <span class="n">ForeceFieldName</span> <span class="o">=</span> <span class="s2">&quot;UFF&quot;</span>
  757     <span class="k">else</span><span class="p">:</span>
  758         <span class="n">ForceFieldFunction</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">mol</span><span class="p">,</span> <span class="n">confId</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="p">:</span> <span class="n">AllChem</span><span class="o">.</span><span class="n">MMFFGetMoleculeForceField</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">AllChem</span><span class="o">.</span><span class="n">MMFFGetMoleculeProperties</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">mmffVariant</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;MMFFVariant&quot;</span><span class="p">])</span> <span class="p">,</span> <span class="n">confId</span> <span class="o">=</span> <span class="n">confId</span><span class="p">)</span>
  759         <span class="n">ForeceFieldName</span> <span class="o">=</span> <span class="s2">&quot;MMFF&quot;</span>
  760 
  761     <span class="k">if</span> <span class="n">ForceFieldFunction</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
  762         <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]:</span>
  763             <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintWarning</span><span class="p">(</span><span class="s2">&quot;Failed to setup forcefield </span><span class="si">%s</span><span class="s2"> for molecule: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ForceFieldName</span><span class="p">,</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">GetMolName</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">)))</span>
  764         <span class="k">return</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
  765         
  766     <span class="n">MaxConfs</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;MaxConfsTorsion&quot;</span><span class="p">]</span>
  767     <span class="n">EnforceChirality</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;EnforceChirality&quot;</span><span class="p">]</span>
  768     <span class="n">UseExpTorsionAnglePrefs</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;UseExpTorsionAnglePrefs&quot;</span><span class="p">]</span>
  769     <span class="n">UseBasicKnowledge</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;UseBasicKnowledge&quot;</span><span class="p">]</span>
  770     <span class="n">UseTethers</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;UseTethers&quot;</span><span class="p">]</span>
  771     
  772     <span class="n">CalcEnergyMap</span> <span class="o">=</span> <span class="p">{}</span>
  773     <span class="n">MolConfsMap</span> <span class="o">=</span> <span class="p">{}</span>
  774     <span class="n">ConfIDs</span> <span class="o">=</span> <span class="p">[</span><span class="n">ConfID</span> <span class="k">for</span> <span class="n">ConfID</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">MaxConfs</span><span class="p">)]</span>
  775 
  776     <span class="k">for</span> <span class="n">ConfID</span> <span class="ow">in</span> <span class="n">ConfIDs</span><span class="p">:</span>
  777         <span class="k">try</span><span class="p">:</span>
  778             <span class="n">MolConf</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">Mol</span><span class="p">(</span><span class="n">Mol</span><span class="p">)</span>
  779             <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">ConstrainAndEmbed</span><span class="p">(</span><span class="n">MolConf</span><span class="p">,</span> <span class="n">RefMolCore</span><span class="p">,</span> <span class="n">coreMatchesMol</span> <span class="o">=</span> <span class="n">RefMolMatches</span><span class="p">,</span> <span class="n">useTethers</span> <span class="o">=</span> <span class="n">UseTethers</span><span class="p">,</span> <span class="n">coreConfId</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">randomseed</span> <span class="o">=</span> <span class="n">ConfID</span><span class="p">,</span> <span class="n">getForceField</span> <span class="o">=</span> <span class="n">ForceFieldFunction</span><span class="p">,</span> <span class="n">enforceChirality</span> <span class="o">=</span> <span class="n">EnforceChirality</span><span class="p">,</span> <span class="n">useExpTorsionAnglePrefs</span> <span class="o">=</span> <span class="n">UseExpTorsionAnglePrefs</span><span class="p">,</span> <span class="n">useBasicKnowledge</span> <span class="o">=</span> <span class="n">UseBasicKnowledge</span><span class="p">)</span>
  780         <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">RuntimeError</span><span class="p">,</span> <span class="n">Chem</span><span class="o">.</span><span class="n">rdchem</span><span class="o">.</span><span class="n">KekulizeException</span><span class="p">)</span>  <span class="k">as</span> <span class="n">ErrMsg</span><span class="p">:</span>
  781             <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]:</span>
  782                 <span class="n">MolName</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">GetMolName</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">)</span>
  783                 <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintWarning</span><span class="p">(</span><span class="s2">&quot;Constrained embedding couldn&#39;t  be performed for molecule </span><span class="si">%s</span><span class="s2">:</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">RDKitUtil</span><span class="o">.</span><span class="n">GetMolName</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">),</span> <span class="n">ErrMsg</span><span class="p">))</span>
  784             <span class="k">return</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
  785         
  786         <span class="n">EnergyStatus</span><span class="p">,</span> <span class="n">Energy</span> <span class="o">=</span> <span class="n">GetEnergy</span><span class="p">(</span><span class="n">MolConf</span><span class="p">)</span>
  787         
  788         <span class="k">if</span> <span class="ow">not</span> <span class="n">EnergyStatus</span><span class="p">:</span>
  789             <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]:</span>
  790                 <span class="n">MolName</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">GetMolName</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">)</span>
  791                 <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintWarning</span><span class="p">(</span><span class="s2">&quot;Failed to retrieve calculated energy for conformation number </span><span class="si">%d</span><span class="s2"> of molecule </span><span class="si">%s</span><span class="s2">. Try again after removing any salts or cleaing up the molecule...</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ConfID</span><span class="p">,</span> <span class="n">MolName</span><span class="p">))</span>
  792             <span class="k">return</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
  793         
  794         <span class="n">CalcEnergyMap</span><span class="p">[</span><span class="n">ConfID</span><span class="p">]</span> <span class="o">=</span> <span class="n">Energy</span>
  795         <span class="n">MolConfsMap</span><span class="p">[</span><span class="n">ConfID</span><span class="p">]</span> <span class="o">=</span> <span class="n">MolConf</span>
  796 
  797     <span class="n">SortedConfIDs</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">ConfIDs</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">ConfID</span><span class="p">:</span> <span class="n">CalcEnergyMap</span><span class="p">[</span><span class="n">ConfID</span><span class="p">])</span>
  798     <span class="n">MinEnergyConfID</span> <span class="o">=</span> <span class="n">SortedConfIDs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
  799     
  800     <span class="n">MinEnergy</span> <span class="o">=</span> <span class="n">CalcEnergyMap</span><span class="p">[</span><span class="n">MinEnergyConfID</span><span class="p">]</span>
  801     <span class="n">MinEnergyMolConf</span> <span class="o">=</span> <span class="n">MolConfsMap</span><span class="p">[</span><span class="n">MinEnergyConfID</span><span class="p">]</span>
  802     
  803     <span class="n">MinEnergyMolConf</span><span class="o">.</span><span class="n">ClearProp</span><span class="p">(</span><span class="s1">&#39;EmbedRMS&#39;</span><span class="p">)</span>
  804     
  805     <span class="k">return</span> <span class="p">(</span><span class="n">MinEnergyMolConf</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="n">MinEnergy</span><span class="p">)</span>
  806 
  807 <span class="k">def</span> <span class="nf">GetEnergy</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">ConfID</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
  808     <span class="sd">&quot;&quot;&quot;Calculate energy.&quot;&quot;&quot;</span>
  809 
  810     <span class="n">Status</span> <span class="o">=</span> <span class="bp">True</span>
  811     <span class="n">Energy</span> <span class="o">=</span> <span class="bp">None</span>
  812 
  813     <span class="k">if</span> <span class="n">ConfID</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
  814         <span class="n">ConfID</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
  815     
  816     <span class="k">if</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;UseUFF&quot;</span><span class="p">]:</span>
  817         <span class="n">UFFMoleculeForcefield</span> <span class="o">=</span> <span class="n">AllChem</span><span class="o">.</span><span class="n">UFFGetMoleculeForceField</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">confId</span> <span class="o">=</span> <span class="n">ConfID</span><span class="p">)</span>
  818         <span class="k">if</span> <span class="n">UFFMoleculeForcefield</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
  819             <span class="n">Status</span> <span class="o">=</span> <span class="bp">False</span>
  820         <span class="k">else</span><span class="p">:</span>
  821             <span class="n">Energy</span> <span class="o">=</span> <span class="n">UFFMoleculeForcefield</span><span class="o">.</span><span class="n">CalcEnergy</span><span class="p">()</span>
  822     <span class="k">elif</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;UseMMFF&quot;</span><span class="p">]:</span>
  823         <span class="n">MMFFMoleculeProperties</span> <span class="o">=</span> <span class="n">AllChem</span><span class="o">.</span><span class="n">MMFFGetMoleculeProperties</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">mmffVariant</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;MMFFVariant&quot;</span><span class="p">])</span>
  824         <span class="n">MMFFMoleculeForcefield</span> <span class="o">=</span> <span class="n">AllChem</span><span class="o">.</span><span class="n">MMFFGetMoleculeForceField</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MMFFMoleculeProperties</span><span class="p">,</span> <span class="n">confId</span> <span class="o">=</span> <span class="n">ConfID</span><span class="p">)</span>
  825         <span class="k">if</span> <span class="n">MMFFMoleculeForcefield</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
  826             <span class="n">Status</span> <span class="o">=</span> <span class="bp">False</span>
  827         <span class="k">else</span><span class="p">:</span>
  828             <span class="n">Energy</span> <span class="o">=</span> <span class="n">MMFFMoleculeForcefield</span><span class="o">.</span><span class="n">CalcEnergy</span><span class="p">()</span>
  829     <span class="k">else</span><span class="p">:</span>
  830         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintError</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t retrieve conformer energy: Specified forcefield, </span><span class="si">%s</span><span class="s2">, is not supported&quot;</span> <span class="o">%</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;ForceField&quot;</span><span class="p">])</span>
  831     
  832     <span class="k">return</span> <span class="p">(</span><span class="n">Status</span><span class="p">,</span> <span class="n">Energy</span><span class="p">)</span>
  833 
  834 <span class="k">def</span> <span class="nf">EmbedMolecule</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
  835     <span class="sd">&quot;&quot;&quot;Embed conformations.&quot;&quot;&quot;</span>
  836 
  837     <span class="n">ConfIDs</span> <span class="o">=</span> <span class="p">[]</span>
  838     
  839     <span class="n">MaxConfs</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;MaxConfs&quot;</span><span class="p">]</span>
  840     <span class="n">RandomSeed</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;RandomSeed&quot;</span><span class="p">]</span>
  841     <span class="n">EnforceChirality</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;EnforceChirality&quot;</span><span class="p">]</span>
  842     <span class="n">UseExpTorsionAnglePrefs</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;UseExpTorsionAnglePrefs&quot;</span><span class="p">]</span>
  843     <span class="n">UseBasicKnowledge</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;UseBasicKnowledge&quot;</span><span class="p">]</span>
  844     
  845     <span class="k">try</span><span class="p">:</span>
  846         <span class="n">ConfIDs</span> <span class="o">=</span> <span class="n">AllChem</span><span class="o">.</span><span class="n">EmbedMultipleConfs</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">numConfs</span> <span class="o">=</span> <span class="n">MaxConfs</span><span class="p">,</span> <span class="n">randomSeed</span> <span class="o">=</span> <span class="n">RandomSeed</span><span class="p">,</span> <span class="n">enforceChirality</span> <span class="o">=</span> <span class="n">EnforceChirality</span><span class="p">,</span> <span class="n">useExpTorsionAnglePrefs</span> <span class="o">=</span> <span class="n">UseExpTorsionAnglePrefs</span><span class="p">,</span> <span class="n">useBasicKnowledge</span> <span class="o">=</span> <span class="n">UseBasicKnowledge</span><span class="p">)</span>
  847     <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">ErrMsg</span><span class="p">:</span>
  848         <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]:</span>
  849             <span class="n">MolName</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">GetMolName</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">)</span>
  850             <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintWarning</span><span class="p">(</span><span class="s2">&quot;Embedding failed  for molecule </span><span class="si">%s</span><span class="s2">:</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">MolName</span><span class="p">,</span> <span class="n">ErrMsg</span><span class="p">))</span>
  851         <span class="n">ConfIDs</span> <span class="o">=</span> <span class="p">[]</span>
  852     
  853     <span class="k">return</span> <span class="n">ConfIDs</span>
  854 
  855 <span class="k">def</span> <span class="nf">GenerateStartingTorsionScanStructureOutfile</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">):</span>
  856     <span class="sd">&quot;&quot;&quot;Write out the structure of molecule used for starting tosion scan.&quot;&quot;&quot;</span>
  857     
  858     <span class="n">FileDir</span><span class="p">,</span> <span class="n">FileName</span><span class="p">,</span> <span class="n">FileExt</span> <span class="o">=</span> <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ParseFileName</span><span class="p">(</span><span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--outfile&quot;</span><span class="p">])</span>
  859     <span class="n">MolName</span> <span class="o">=</span> <span class="n">GetOutputFileMolName</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">)</span>
  860     
  861     <span class="n">Outfile</span>  <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_</span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">FileName</span><span class="p">,</span> <span class="n">MolName</span><span class="p">,</span> <span class="n">FileExt</span><span class="p">)</span>
  862     
  863     <span class="c1"># Set up a molecule writer...</span>
  864     <span class="n">Writer</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">MoleculesWriter</span><span class="p">(</span><span class="n">Outfile</span><span class="p">,</span> <span class="o">**</span><span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;OutfileParams&quot;</span><span class="p">])</span>
  865     <span class="k">if</span> <span class="n">Writer</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
  866         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintWarning</span><span class="p">(</span><span class="s2">&quot;Failed to setup a writer for output fie </span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="n">Outfile</span><span class="p">)</span>
  867         <span class="k">return</span>
  868     
  869     <span class="n">Writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">Mol</span><span class="p">)</span>
  870     
  871     <span class="k">if</span> <span class="n">Writer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
  872         <span class="n">Writer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
  873 
  874 <span class="k">def</span> <span class="nf">GenerateOutputFiles</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">,</span> <span class="n">TorsionID</span><span class="p">,</span> <span class="n">TorsionMatchNum</span><span class="p">,</span> <span class="n">TorsionMols</span><span class="p">,</span> <span class="n">TorsionEnergies</span><span class="p">,</span> <span class="n">TorsionAngles</span><span class="p">):</span>
  875     <span class="sd">&quot;&quot;&quot;Generate output files.&quot;&quot;&quot;</span>
  876     
  877     <span class="n">StructureOutfile</span><span class="p">,</span> <span class="n">EnergyTextOutfile</span><span class="p">,</span> <span class="n">PlotOutfile</span> <span class="o">=</span> <span class="n">SetupOutputFileNames</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">,</span> <span class="n">TorsionID</span><span class="p">,</span> <span class="n">TorsionMatchNum</span><span class="p">)</span>
  878     
  879     <span class="n">GenerateScannedTorsionsStructureOutfile</span><span class="p">(</span><span class="n">StructureOutfile</span><span class="p">,</span> <span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">,</span> <span class="n">TorsionID</span><span class="p">,</span> <span class="n">TorsionMatchNum</span><span class="p">,</span> <span class="n">TorsionMols</span><span class="p">,</span> <span class="n">TorsionEnergies</span><span class="p">,</span> <span class="n">TorsionAngles</span><span class="p">)</span>
  880     <span class="n">GenerateEnergyTextOutfile</span><span class="p">(</span><span class="n">EnergyTextOutfile</span><span class="p">,</span> <span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">,</span> <span class="n">TorsionID</span><span class="p">,</span> <span class="n">TorsionMatchNum</span><span class="p">,</span> <span class="n">TorsionMols</span><span class="p">,</span> <span class="n">TorsionEnergies</span><span class="p">,</span> <span class="n">TorsionAngles</span><span class="p">)</span>
  881     <span class="n">GeneratePlotOutfile</span><span class="p">(</span><span class="n">PlotOutfile</span><span class="p">,</span> <span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">,</span> <span class="n">TorsionID</span><span class="p">,</span> <span class="n">TorsionMatchNum</span><span class="p">,</span> <span class="n">TorsionMols</span><span class="p">,</span> <span class="n">TorsionEnergies</span><span class="p">,</span> <span class="n">TorsionAngles</span><span class="p">)</span>
  882 
  883 <span class="k">def</span> <span class="nf">GenerateScannedTorsionsStructureOutfile</span><span class="p">(</span><span class="n">Outfile</span><span class="p">,</span> <span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">,</span> <span class="n">TorsionID</span><span class="p">,</span> <span class="n">TorsionMatchNum</span><span class="p">,</span> <span class="n">TorsionMols</span><span class="p">,</span> <span class="n">TorsionEnergies</span><span class="p">,</span> <span class="n">TorsionAngles</span><span class="p">):</span>
  884     <span class="sd">&quot;&quot;&quot;Write out structures generated after torsion scan along with associated data.&quot;&quot;&quot;</span>
  885 
  886     <span class="c1"># Set up a molecule writer...</span>
  887     <span class="n">Writer</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">MoleculesWriter</span><span class="p">(</span><span class="n">Outfile</span><span class="p">,</span> <span class="o">**</span><span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;OutfileParams&quot;</span><span class="p">])</span>
  888     <span class="k">if</span> <span class="n">Writer</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
  889         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintWarning</span><span class="p">(</span><span class="s2">&quot;Failed to setup a writer for output fie </span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="n">Outfile</span><span class="p">)</span>
  890         <span class="k">return</span>
  891     
  892     <span class="n">MolName</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">GetMolName</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">)</span>
  893     
  894     <span class="n">RelativeTorsionEnergies</span> <span class="o">=</span> <span class="n">SetupRelativeEnergies</span><span class="p">(</span><span class="n">TorsionEnergies</span><span class="p">)</span>
  895     <span class="k">for</span> <span class="n">Index</span><span class="p">,</span> <span class="n">TorsionMol</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">TorsionMols</span><span class="p">):</span>
  896         <span class="n">TorsionAngle</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">TorsionAngles</span><span class="p">[</span><span class="n">Index</span><span class="p">]</span>
  897         <span class="n">TorsionMol</span><span class="o">.</span><span class="n">SetProp</span><span class="p">(</span><span class="s2">&quot;Torsion_Angle&quot;</span><span class="p">,</span> <span class="n">TorsionAngle</span><span class="p">)</span>
  898         
  899         <span class="n">TorsionEnergy</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">TorsionEnergies</span><span class="p">[</span><span class="n">Index</span><span class="p">]</span>
  900         <span class="n">TorsionMol</span><span class="o">.</span><span class="n">SetProp</span><span class="p">(</span><span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;EnergyLabel&quot;</span><span class="p">],</span> <span class="n">TorsionEnergy</span><span class="p">)</span>
  901 
  902         <span class="n">RelativeTorsionEnergy</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">RelativeTorsionEnergies</span><span class="p">[</span><span class="n">Index</span><span class="p">]</span>
  903         <span class="n">TorsionMol</span><span class="o">.</span><span class="n">SetProp</span><span class="p">(</span><span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;RelativeEnergyLabel&quot;</span><span class="p">],</span> <span class="n">RelativeTorsionEnergy</span><span class="p">)</span>
  904 
  905         <span class="n">TorsionMolName</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_Deg</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">MolName</span><span class="p">,</span> <span class="n">TorsionAngle</span><span class="p">)</span>
  906         <span class="n">TorsionMol</span><span class="o">.</span><span class="n">SetProp</span><span class="p">(</span><span class="s2">&quot;_Name&quot;</span><span class="p">,</span> <span class="n">TorsionMolName</span><span class="p">)</span>
  907         
  908         <span class="n">Writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">TorsionMol</span><span class="p">)</span>
  909         
  910     <span class="k">if</span> <span class="n">Writer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
  911         <span class="n">Writer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
  912     
  913 <span class="k">def</span> <span class="nf">GenerateEnergyTextOutfile</span><span class="p">(</span><span class="n">Outfile</span><span class="p">,</span> <span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">,</span> <span class="n">TorsionID</span><span class="p">,</span> <span class="n">TorsionMatchNum</span><span class="p">,</span> <span class="n">TorsionMols</span><span class="p">,</span> <span class="n">TorsionEnergies</span><span class="p">,</span> <span class="n">TorsionAngles</span><span class="p">):</span>
  914     <span class="sd">&quot;&quot;&quot;Write out torsion angles and energies.&quot;&quot;&quot;</span>
  915 
  916     <span class="c1"># Setup a writer...</span>
  917     <span class="n">Writer</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">Outfile</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
  918     <span class="k">if</span> <span class="n">Writer</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
  919         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintError</span><span class="p">(</span><span class="s2">&quot;Failed to setup a writer for output fie </span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="n">Outfile</span><span class="p">)</span>
  920     
  921     <span class="c1"># Write headers...</span>
  922     <span class="n">Writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;TorsionAngle,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;EnergyLabel&quot;</span><span class="p">],</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;RelativeEnergyLabel&quot;</span><span class="p">]))</span>
  923 
  924     <span class="n">RelativeTorsionEnergies</span> <span class="o">=</span> <span class="n">SetupRelativeEnergies</span><span class="p">(</span><span class="n">TorsionEnergies</span><span class="p">)</span>
  925     <span class="k">for</span> <span class="n">Index</span><span class="p">,</span> <span class="n">TorsionAngle</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">TorsionAngles</span><span class="p">):</span>
  926         <span class="n">Writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">,</span><span class="si">%.2f</span><span class="s2">,</span><span class="si">%.2f</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">TorsionAngle</span><span class="p">,</span> <span class="n">TorsionEnergies</span><span class="p">[</span><span class="n">Index</span><span class="p">],</span> <span class="n">RelativeTorsionEnergies</span><span class="p">[</span><span class="n">Index</span><span class="p">]))</span>
  927 
  928     <span class="k">if</span> <span class="n">Writer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
  929         <span class="n">Writer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
  930     
  931 <span class="k">def</span> <span class="nf">GeneratePlotOutfile</span><span class="p">(</span><span class="n">Outfile</span><span class="p">,</span> <span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">,</span> <span class="n">TorsionID</span><span class="p">,</span> <span class="n">TorsionMatchNum</span><span class="p">,</span> <span class="n">TorsionMols</span><span class="p">,</span> <span class="n">TorsionEnergies</span><span class="p">,</span> <span class="n">TorsionAngles</span><span class="p">):</span>
  932     <span class="sd">&quot;&quot;&quot;Generate a plot corresponding to torsion angles and energies.&quot;&quot;&quot;</span>
  933 
  934     <span class="n">OutPlotParams</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;OutPlotParams&quot;</span><span class="p">]</span>
  935 
  936     <span class="c1"># Initialize seaborn and matplotlib paramaters...</span>
  937     <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;OutPlotInitialized&quot;</span><span class="p">]:</span>
  938         <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;OutPlotInitialized&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
  939         <span class="n">RCParams</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;figure.figsize&quot;</span><span class="p">:(</span><span class="n">OutPlotParams</span><span class="p">[</span><span class="s2">&quot;Width&quot;</span><span class="p">],</span> <span class="n">OutPlotParams</span><span class="p">[</span><span class="s2">&quot;Height&quot;</span><span class="p">]),</span>
  940                     <span class="s2">&quot;axes.titleweight&quot;</span><span class="p">:</span> <span class="n">OutPlotParams</span><span class="p">[</span><span class="s2">&quot;TitleWeight&quot;</span><span class="p">],</span>
  941                     <span class="s2">&quot;axes.labelweight&quot;</span><span class="p">:</span> <span class="n">OutPlotParams</span><span class="p">[</span><span class="s2">&quot;LabelWeight&quot;</span><span class="p">]}</span>
  942         <span class="n">sns</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">context</span> <span class="o">=</span> <span class="n">OutPlotParams</span><span class="p">[</span><span class="s2">&quot;Context&quot;</span><span class="p">],</span> <span class="n">style</span> <span class="o">=</span> <span class="n">OutPlotParams</span><span class="p">[</span><span class="s2">&quot;Style&quot;</span><span class="p">],</span> <span class="n">palette</span> <span class="o">=</span> <span class="n">OutPlotParams</span><span class="p">[</span><span class="s2">&quot;Palette&quot;</span><span class="p">],</span> <span class="n">font</span> <span class="o">=</span> <span class="n">OutPlotParams</span><span class="p">[</span><span class="s2">&quot;Font&quot;</span><span class="p">],</span> <span class="n">font_scale</span> <span class="o">=</span> <span class="n">OutPlotParams</span><span class="p">[</span><span class="s2">&quot;FontScale&quot;</span><span class="p">],</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">RCParams</span><span class="p">)</span>
  943 
  944     <span class="c1"># Create a new figure...</span>
  945     <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
  946 
  947     <span class="k">if</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;OutPlotRelativeEnergy&quot;</span><span class="p">]:</span> 
  948         <span class="n">TorsionEnergies</span> <span class="o">=</span> <span class="n">SetupRelativeEnergies</span><span class="p">(</span><span class="n">TorsionEnergies</span><span class="p">)</span>
  949     
  950     <span class="c1"># Draw plot...</span>
  951     <span class="n">PlotType</span> <span class="o">=</span> <span class="n">OutPlotParams</span><span class="p">[</span><span class="s2">&quot;Type&quot;</span><span class="p">]</span>
  952     <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;linepoint&quot;</span><span class="p">,</span> <span class="n">PlotType</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
  953         <span class="n">Axis</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">TorsionAngles</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">TorsionEnergies</span><span class="p">,</span> <span class="n">marker</span> <span class="o">=</span> <span class="s2">&quot;o&quot;</span><span class="p">,</span>  <span class="n">legend</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span>
  954     <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;scatter&quot;</span><span class="p">,</span> <span class="n">PlotType</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
  955         <span class="n">Axis</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">TorsionAngles</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">TorsionEnergies</span><span class="p">,</span> <span class="n">legend</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span>
  956     <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;line&quot;</span><span class="p">,</span> <span class="n">PlotType</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
  957         <span class="n">Axis</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">TorsionAngles</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">TorsionEnergies</span><span class="p">,</span> <span class="n">legend</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span>
  958     <span class="k">else</span><span class="p">:</span>
  959         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintError</span><span class="p">(</span><span class="s2">&quot;The value, </span><span class="si">%s</span><span class="s2">, specified for </span><span class="se">\&quot;</span><span class="s2">type</span><span class="se">\&quot;</span><span class="s2"> using option </span><span class="se">\&quot;</span><span class="s2">--outPlotParams</span><span class="se">\&quot;</span><span class="s2"> is not supported. Valid plot types: linepoint, scatter or line&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">PlotType</span><span class="p">))</span>
  960 
  961     <span class="c1"># Setup title and labels...</span>
  962     <span class="n">Title</span> <span class="o">=</span> <span class="n">OutPlotParams</span><span class="p">[</span><span class="s2">&quot;Title&quot;</span><span class="p">]</span>
  963     <span class="k">if</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;OutPlotTitleTorsionSpec&quot;</span><span class="p">]:</span>
  964         <span class="n">TorsionPattern</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;TorsionsPatternsInfo&quot;</span><span class="p">][</span><span class="s2">&quot;Pattern&quot;</span><span class="p">][</span><span class="n">TorsionID</span><span class="p">]</span>
  965         <span class="n">Title</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">OutPlotParams</span><span class="p">[</span><span class="s2">&quot;Title&quot;</span><span class="p">],</span> <span class="n">TorsionPattern</span><span class="p">)</span>
  966 
  967     <span class="c1"># Set labels and title...</span>
  968     <span class="n">Axis</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span> <span class="o">=</span> <span class="n">OutPlotParams</span><span class="p">[</span><span class="s2">&quot;XLabel&quot;</span><span class="p">],</span> <span class="n">ylabel</span> <span class="o">=</span> <span class="n">OutPlotParams</span><span class="p">[</span><span class="s2">&quot;YLabel&quot;</span><span class="p">],</span> <span class="n">title</span> <span class="o">=</span> <span class="n">Title</span><span class="p">)</span>
  969     
  970     <span class="c1"># Save figure...</span>
  971     <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">Outfile</span><span class="p">)</span>
  972 
  973     <span class="c1"># Close the plot...</span>
  974     <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
  975 
  976 <span class="k">def</span> <span class="nf">SetupRelativeEnergies</span><span class="p">(</span><span class="n">Energies</span><span class="p">):</span>
  977     <span class="sd">&quot;&quot;&quot;Set up a list of relative energies.&quot;&quot;&quot;</span>
  978     
  979     <span class="n">SortedEnergies</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">Energies</span><span class="p">)</span>
  980     <span class="n">MinEnergy</span> <span class="o">=</span> <span class="n">SortedEnergies</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
  981     <span class="n">RelativeEnergies</span> <span class="o">=</span> <span class="p">[(</span><span class="n">Energy</span> <span class="o">-</span> <span class="n">MinEnergy</span><span class="p">)</span> <span class="k">for</span> <span class="n">Energy</span> <span class="ow">in</span> <span class="n">Energies</span><span class="p">]</span>
  982 
  983     <span class="k">return</span> <span class="n">RelativeEnergies</span>
  984     
  985 <span class="k">def</span> <span class="nf">SetupOutputFileNames</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">,</span> <span class="n">TorsionID</span><span class="p">,</span> <span class="n">TorsionMatchNum</span><span class="p">):</span>
  986     <span class="sd">&quot;&quot;&quot;Setup names of output files.&quot;&quot;&quot;</span>
  987     
  988     <span class="n">FileDir</span><span class="p">,</span> <span class="n">FileName</span><span class="p">,</span> <span class="n">FileExt</span> <span class="o">=</span> <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ParseFileName</span><span class="p">(</span><span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--outfile&quot;</span><span class="p">])</span>
  989     <span class="n">MolName</span> <span class="o">=</span> <span class="n">GetOutputFileMolName</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">)</span>
  990     
  991     <span class="n">OutfileRoot</span>  <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_</span><span class="si">%s</span><span class="s2">_Torsion</span><span class="si">%s</span><span class="s2">_Match</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">FileName</span><span class="p">,</span> <span class="n">MolName</span><span class="p">,</span> <span class="n">TorsionID</span><span class="p">,</span> <span class="n">TorsionMatchNum</span><span class="p">)</span>
  992     
  993     <span class="n">StructureOutfile</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">OutfileRoot</span><span class="p">,</span> <span class="n">FileExt</span><span class="p">)</span>
  994     <span class="n">EnergyTextOutfile</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_Energies.csv&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">OutfileRoot</span><span class="p">)</span>
  995     <span class="n">PlotExt</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;OutPlotParams&quot;</span><span class="p">][</span><span class="s2">&quot;OutExt&quot;</span><span class="p">]</span>
  996     <span class="n">PlotOutfile</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_Plot.</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">OutfileRoot</span><span class="p">,</span> <span class="n">PlotExt</span><span class="p">)</span>
  997 
  998     <span class="k">return</span> <span class="p">(</span><span class="n">StructureOutfile</span><span class="p">,</span> <span class="n">EnergyTextOutfile</span><span class="p">,</span> <span class="n">PlotOutfile</span><span class="p">)</span>
  999 
 1000 <span class="k">def</span> <span class="nf">GetOutputFileMolName</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">):</span>
 1001     <span class="sd">&quot;&quot;&quot;Get output file prefix.&quot;&quot;&quot;</span>
 1002     
 1003     <span class="n">MolName</span> <span class="o">=</span> <span class="s2">&quot;Mol</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">MolNum</span>
 1004     <span class="k">if</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;OutfileMolName&quot;</span><span class="p">]:</span>
 1005         <span class="n">MolName</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;[^a-zA-Z0-9]&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">GetMolName</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">),</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span>
 1006 
 1007     <span class="k">return</span> <span class="n">MolName</span>
 1008 
 1009 <span class="k">def</span> <span class="nf">AddHydrogens</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">AddCoords</span> <span class="o">=</span> <span class="bp">True</span><span class="p">):</span>
 1010     <span class="sd">&quot;&quot;&quot;Check and add hydrogens.&quot;&quot;&quot;</span>
 1011     
 1012     <span class="k">if</span>  <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;AddHydrogens&quot;</span><span class="p">]:</span>
 1013         <span class="k">return</span> <span class="n">Mol</span>
 1014 
 1015     <span class="k">return</span> <span class="n">Chem</span><span class="o">.</span><span class="n">AddHs</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">addCoords</span> <span class="o">=</span> <span class="n">AddCoords</span><span class="p">)</span>
 1016 
 1017 <span class="k">def</span> <span class="nf">ProcessOptions</span><span class="p">():</span>
 1018     <span class="sd">&quot;&quot;&quot;Process and validate command line arguments and options.&quot;&quot;&quot;</span>
 1019     
 1020     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;Processing options...&quot;</span><span class="p">)</span>
 1021 
 1022     <span class="c1"># Validate options...</span>
 1023     <span class="n">ValidateOptions</span><span class="p">()</span>
 1024     
 1025     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;ModeMols&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--modeMols&quot;</span><span class="p">]</span>
 1026     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;FirstMolMode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^First$&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--modeMols&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span> <span class="k">else</span> <span class="bp">False</span>
 1027     
 1028     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;ModeTorsions&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--modeTorsions&quot;</span><span class="p">]</span>
 1029     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;FirstTorsionMode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^First$&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--modeTorsions&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span> <span class="k">else</span> <span class="bp">False</span>
 1030     
 1031     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Infile&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--infile&quot;</span><span class="p">]</span>
 1032     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;InfileParams&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ProcessOptionInfileParameters</span><span class="p">(</span><span class="s2">&quot;--infileParams&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--infileParams&quot;</span><span class="p">],</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--infile&quot;</span><span class="p">])</span>
 1033     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Infile3D&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^yes$&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--infile3D&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span> <span class="k">else</span> <span class="bp">False</span>
 1034     
 1035     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Outfile&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--outfile&quot;</span><span class="p">]</span>
 1036     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;OutfileParams&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ProcessOptionOutfileParameters</span><span class="p">(</span><span class="s2">&quot;--outfileParams&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--outfileParams&quot;</span><span class="p">])</span>
 1037 
 1038     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;OutfileMolName&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^yes$&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--outfileMolName&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span> <span class="k">else</span> <span class="bp">False</span>
 1039     
 1040     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;OutPlotRelativeEnergy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^yes$&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--outPlotRelativeEnergy&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span> <span class="k">else</span> <span class="bp">False</span>
 1041     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;OutPlotTitleTorsionSpec&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^yes$&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--outPlotTitleTorsionSpec&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span> <span class="k">else</span> <span class="bp">False</span>
 1042     
 1043     <span class="c1"># The default width and height, 10.0 and 7.5, map to aspect raito of 16/9 (1.778)...</span>
 1044     <span class="n">DefaultValues</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Type&#39;</span><span class="p">:</span> <span class="s1">&#39;linepoint&#39;</span><span class="p">,</span> <span class="s1">&#39;Width&#39;</span><span class="p">:</span> <span class="mf">10.0</span><span class="p">,</span> <span class="s1">&#39;Height&#39;</span><span class="p">:</span> <span class="mf">5.6</span><span class="p">,</span> <span class="s1">&#39;Title&#39;</span><span class="p">:</span> <span class="s1">&#39;RDKit Torsion Scan&#39;</span><span class="p">,</span> <span class="s1">&#39;XLabel&#39;</span><span class="p">:</span> <span class="s1">&#39;Torsion Angle (degrees)&#39;</span><span class="p">,</span> <span class="s1">&#39;YLabel&#39;</span><span class="p">:</span> <span class="s1">&#39;Energy (kcal/mol)&#39;</span><span class="p">}</span>
 1045     <span class="k">if</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;OutPlotRelativeEnergy&quot;</span><span class="p">]:</span>
 1046         <span class="n">DefaultValues</span><span class="p">[</span><span class="s2">&quot;YLabel&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Relative Energy (kcal/mol)&quot;</span>
 1047     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;OutPlotParams&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ProcessOptionSeabornPlotParameters</span><span class="p">(</span><span class="s2">&quot;--outPlotParams&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--outPlotParams&quot;</span><span class="p">],</span> <span class="n">DefaultValues</span><span class="p">)</span>
 1048     <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^(linepoint|scatter|Line)$&quot;</span><span class="p">,</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;OutPlotParams&quot;</span><span class="p">][</span><span class="s2">&quot;Type&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
 1049         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintError</span><span class="p">(</span><span class="s2">&quot;The value, </span><span class="si">%s</span><span class="s2">, specified for </span><span class="se">\&quot;</span><span class="s2">type</span><span class="se">\&quot;</span><span class="s2"> using option </span><span class="se">\&quot;</span><span class="s2">--outPlotParams</span><span class="se">\&quot;</span><span class="s2"> is not supported. Valid plot types: linepoint, scatter or line&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;OutPlotParams&quot;</span><span class="p">][</span><span class="s2">&quot;Type&quot;</span><span class="p">]))</span>
 1050     
 1051     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;OutPlotInitialized&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
 1052     
 1053     <span class="c1"># Procsss and validate specified SMILES/SMARTS torsion patterns...</span>
 1054     <span class="n">TorsionPatterns</span> <span class="o">=</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--torsions&quot;</span><span class="p">]</span>
 1055     <span class="n">TorsionPatternsList</span> <span class="o">=</span> <span class="p">[]</span>
 1056     <span class="k">for</span> <span class="n">TorsionPattern</span> <span class="ow">in</span> <span class="n">TorsionPatterns</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">):</span>
 1057         <span class="n">TorsionPattern</span> <span class="o">=</span> <span class="n">TorsionPattern</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
 1058         <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">TorsionPattern</span><span class="p">):</span>
 1059             <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintError</span><span class="p">(</span><span class="s2">&quot;Empty value specified for SMILES/SMARTS pattern in  </span><span class="se">\&quot;</span><span class="s2">-t, --torsions</span><span class="se">\&quot;</span><span class="s2"> option: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">TorsionPatterns</span><span class="p">)</span>
 1060         
 1061         <span class="n">TorsionMol</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">MolFromSmarts</span><span class="p">(</span><span class="n">TorsionPattern</span><span class="p">)</span>
 1062         <span class="k">if</span> <span class="n">TorsionMol</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
 1063             <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintError</span><span class="p">(</span><span class="s2">&quot;Failed to create torsion pattern molecule. The torsion SMILES/SMARTS pattern, </span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2">, specified using </span><span class="se">\&quot;</span><span class="s2">-t, --torsions</span><span class="se">\&quot;</span><span class="s2"> option, </span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2">,  is not valid.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">TorsionPattern</span><span class="p">,</span> <span class="n">TorsionPatterns</span><span class="p">))</span>
 1064         <span class="n">TorsionPatternsList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TorsionPattern</span><span class="p">)</span>
 1065     
 1066     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;TorsionPatterns&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">TorsionPatterns</span>
 1067     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;TorsionPatternsList&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">TorsionPatternsList</span>
 1068 
 1069     <span class="c1"># Process and validate any specified torsion atom indices for filtering torsion matches...</span>
 1070     <span class="n">TorsionsFilterByAtomIndices</span> <span class="o">=</span>  <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--torsionsFilterbyAtomIndices&quot;</span><span class="p">]</span>
 1071     <span class="n">TorsionsFilterByAtomIndicesList</span> <span class="o">=</span> <span class="p">[]</span>
 1072     <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^None$&quot;</span><span class="p">,</span> <span class="n">TorsionsFilterByAtomIndices</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
 1073         <span class="k">for</span> <span class="n">AtomIndex</span> <span class="ow">in</span> <span class="n">TorsionsFilterByAtomIndices</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">):</span>
 1074             <span class="n">AtomIndex</span> <span class="o">=</span> <span class="n">AtomIndex</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
 1075             <span class="k">if</span> <span class="ow">not</span> <span class="n">MiscUtil</span><span class="o">.</span><span class="n">IsInteger</span><span class="p">(</span><span class="n">AtomIndex</span><span class="p">):</span>
 1076                 <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintError</span><span class="p">(</span><span class="s2">&quot;The value specified, </span><span class="si">%s</span><span class="s2">, for option </span><span class="se">\&quot;</span><span class="s2">--torsionsFilterbyAtomIndices</span><span class="se">\&quot;</span><span class="s2"> must be an integer.&quot;</span> <span class="o">%</span> <span class="n">AtomIndex</span><span class="p">)</span>
 1077             <span class="n">AtomIndex</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">AtomIndex</span><span class="p">)</span>
 1078             <span class="k">if</span> <span class="n">AtomIndex</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
 1079                 <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintError</span><span class="p">(</span><span class="s2">&quot;The value specified, </span><span class="si">%s</span><span class="s2">, for option </span><span class="se">\&quot;</span><span class="s2">--torsionsFilterbyAtomIndices</span><span class="se">\&quot;</span><span class="s2"> must be &gt;= 0.&quot;</span> <span class="o">%</span> <span class="n">AtomIdex</span><span class="p">)</span>
 1080             <span class="n">TorsionsFilterByAtomIndicesList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">AtomIndex</span><span class="p">)</span>
 1081 
 1082         <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">TorsionsFilterByAtomIndicesList</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
 1083             <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintError</span><span class="p">(</span><span class="s2">&quot;The number of values, </span><span class="si">%s</span><span class="s2">,  specified, </span><span class="si">%s</span><span class="s2">, for option </span><span class="se">\&quot;</span><span class="s2">--torsionsFilterbyAtomIndices</span><span class="se">\&quot;</span><span class="s2"> must be &gt;=4.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">TorsionsFilterByAtomIndicesList</span><span class="p">),</span> <span class="n">TorsionsFilterByAtomIndices</span><span class="p">))</span>
 1084             
 1085     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;TorsionsFilterByAtomIndices&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">TorsionsFilterByAtomIndices</span>
 1086     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;TorsionsFilterByAtomIndicesList&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">TorsionsFilterByAtomIndicesList</span>
 1087     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;FilterTorsionsByAtomIndicesMode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">TorsionsFilterByAtomIndicesList</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="bp">False</span>
 1088     
 1089     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Overwrite&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--overwrite&quot;</span><span class="p">]</span>
 1090     
 1091     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;AddHydrogens&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^yes$&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--addHydrogens&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span> <span class="k">else</span> <span class="bp">False</span>
 1092     
 1093     <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^ETDG$&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--conformerGenerator&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
 1094         <span class="n">ConformerGenerator</span> <span class="o">=</span> <span class="s2">&quot;ETDG&quot;</span>
 1095         <span class="n">UseExpTorsionAnglePrefs</span> <span class="o">=</span> <span class="bp">True</span>
 1096         <span class="n">UseBasicKnowledge</span> <span class="o">=</span> <span class="bp">False</span>
 1097     <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^KDG$&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--conformerGenerator&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
 1098         <span class="n">ConformerGenerator</span> <span class="o">=</span> <span class="s2">&quot;KDG&quot;</span>
 1099         <span class="n">UseExpTorsionAnglePrefs</span> <span class="o">=</span> <span class="bp">False</span>
 1100         <span class="n">UseBasicKnowledge</span> <span class="o">=</span> <span class="bp">True</span>
 1101     <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^ETKDG$&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--conformerGenerator&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
 1102         <span class="n">ConformerGenerator</span> <span class="o">=</span> <span class="s2">&quot;ETKDG&quot;</span>
 1103         <span class="n">UseExpTorsionAnglePrefs</span> <span class="o">=</span> <span class="bp">True</span>
 1104         <span class="n">UseBasicKnowledge</span> <span class="o">=</span> <span class="bp">True</span>
 1105     <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^SDG$&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--conformerGenerator&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
 1106         <span class="n">ConformerGenerator</span> <span class="o">=</span> <span class="s2">&quot;SDG&quot;</span>
 1107         <span class="n">UseExpTorsionAnglePrefs</span> <span class="o">=</span> <span class="bp">False</span>
 1108         <span class="n">UseBasicKnowledge</span> <span class="o">=</span> <span class="bp">False</span>
 1109     <span class="k">else</span><span class="p">:</span>
 1110         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintError</span><span class="p">(</span><span class="s2">&quot;The value, </span><span class="si">%s</span><span class="s2">, specified for option </span><span class="se">\&quot;</span><span class="s2">-c, --conformerGenerator</span><span class="se">\&quot;</span><span class="s2"> is not supported.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--conformerGenerator&quot;</span><span class="p">]))</span>
 1111     
 1112     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;ConformerGenerator&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ConformerGenerator</span>
 1113     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;UseExpTorsionAnglePrefs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">UseExpTorsionAnglePrefs</span>
 1114     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;UseBasicKnowledge&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">UseBasicKnowledge</span>
 1115 
 1116     <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^UFF$&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--forceField&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
 1117         <span class="n">ForceField</span> <span class="o">=</span> <span class="s2">&quot;UFF&quot;</span>
 1118         <span class="n">UseUFF</span> <span class="o">=</span> <span class="bp">True</span>
 1119         <span class="n">UseMMFF</span> <span class="o">=</span> <span class="bp">False</span>
 1120     <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^MMFF$&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--forceField&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
 1121         <span class="n">ForceField</span> <span class="o">=</span> <span class="s2">&quot;MMFF&quot;</span>
 1122         <span class="n">UseUFF</span> <span class="o">=</span> <span class="bp">False</span>
 1123         <span class="n">UseMMFF</span> <span class="o">=</span> <span class="bp">True</span>
 1124     <span class="k">else</span><span class="p">:</span>
 1125         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintError</span><span class="p">(</span><span class="s2">&quot;The value, </span><span class="si">%s</span><span class="s2">, specified for </span><span class="se">\&quot;</span><span class="s2">--forceField</span><span class="se">\&quot;</span><span class="s2"> is not supported.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--forceField&quot;</span><span class="p">],))</span>
 1126     
 1127     <span class="n">MMFFVariant</span> <span class="o">=</span> <span class="s2">&quot;MMFF94&quot;</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^MMFF94$&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--forceFieldMMFFVariant&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;MMFF94s&quot;</span>
 1128     
 1129     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;ForceField&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ForceField</span>
 1130     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;MMFFVariant&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">MMFFVariant</span>
 1131     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;UseMMFF&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">UseMMFF</span>
 1132     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;UseUFF&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">UseUFF</span>
 1133 
 1134     <span class="n">EnergyUnits</span> <span class="o">=</span> <span class="s2">&quot;kcal/mol&quot;</span>
 1135     <span class="k">if</span> <span class="n">UseMMFF</span><span class="p">:</span>
 1136         <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;EnergyLabel&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_Energy&quot;</span> <span class="o">%</span> <span class="n">MMFFVariant</span>
 1137         <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;RelativeEnergyLabel&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_Relative_Energy&quot;</span> <span class="o">%</span> <span class="n">MMFFVariant</span>
 1138     <span class="k">else</span><span class="p">:</span>
 1139         <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;EnergyLabel&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_Energy&quot;</span> <span class="o">%</span> <span class="n">ForceField</span>
 1140         <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;RelativeEnergyLabel&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_Relative_Energy&quot;</span> <span class="o">%</span> <span class="n">ForceField</span>
 1141     
 1142     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;EnforceChirality&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^yes$&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--enforceChirality&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span> <span class="k">else</span> <span class="bp">False</span>
 1143     
 1144     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;MaxConfs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--maxConfs&quot;</span><span class="p">])</span>
 1145     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;MaxConfsTorsion&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--maxConfsTorsion&quot;</span><span class="p">])</span>
 1146     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;MaxIters&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--maxIters&quot;</span><span class="p">])</span>
 1147     
 1148     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;MPMode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^yes$&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--mp&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span> <span class="k">else</span> <span class="bp">False</span>
 1149     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;MPParams&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ProcessOptionMultiprocessingParameters</span><span class="p">(</span><span class="s2">&quot;--mpParams&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--mpParams&quot;</span><span class="p">])</span>
 1150     
 1151     <span class="c1"># Multiprocessing level...</span>
 1152     <span class="n">MPLevelMoleculesMode</span> <span class="o">=</span> <span class="bp">False</span>
 1153     <span class="n">MPLevelTorsionAnglesMode</span> <span class="o">=</span> <span class="bp">False</span>
 1154     <span class="n">MPLevel</span> <span class="o">=</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--mpLevel&quot;</span><span class="p">]</span>
 1155     <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^Molecules$&quot;</span><span class="p">,</span> <span class="n">MPLevel</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
 1156         <span class="n">MPLevelMoleculesMode</span> <span class="o">=</span> <span class="bp">True</span>
 1157     <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^TorsionAngles$&quot;</span><span class="p">,</span> <span class="n">MPLevel</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
 1158         <span class="n">MPLevelTorsionAnglesMode</span> <span class="o">=</span> <span class="bp">True</span>
 1159     <span class="k">else</span><span class="p">:</span>
 1160         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintError</span><span class="p">(</span><span class="s2">&quot;The value, </span><span class="si">%s</span><span class="s2">, specified for option </span><span class="se">\&quot;</span><span class="s2">--mpLevel</span><span class="se">\&quot;</span><span class="s2"> is not valid. &quot;</span> <span class="o">%</span> <span class="n">MPLevel</span><span class="p">)</span>
 1161     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;MPLevel&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">MPLevel</span>
 1162     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;MPLevelMoleculesMode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">MPLevelMoleculesMode</span>
 1163     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;MPLevelTorsionAnglesMode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">MPLevelTorsionAnglesMode</span>
 1164     
 1165     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^yes$&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--quiet&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span> <span class="k">else</span> <span class="bp">False</span>
 1166     
 1167     <span class="n">RandomSeed</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
 1168     <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^auto$&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--randomSeed&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
 1169         <span class="n">RandomSeed</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--randomSeed&quot;</span><span class="p">])</span>
 1170     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;RandomSeed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">RandomSeed</span>
 1171     
 1172     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;RemoveHydrogens&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^yes$&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--removeHydrogens&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span> <span class="k">else</span> <span class="bp">False</span>
 1173     
 1174     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;TorsionMaxMatches&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--torsionMaxMatches&quot;</span><span class="p">])</span>
 1175     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;TorsionMinimize&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^yes$&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--torsionMinimize&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span> <span class="k">else</span> <span class="bp">False</span>
 1176 
 1177     <span class="n">TorsionRange</span> <span class="o">=</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--torsionRange&quot;</span><span class="p">]</span>
 1178     <span class="n">TorsionRangeWords</span> <span class="o">=</span> <span class="n">TorsionRange</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
 1179     
 1180     <span class="n">TorsionStart</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">TorsionRangeWords</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
 1181     <span class="n">TorsionStop</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">TorsionRangeWords</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
 1182     <span class="n">TorsionStep</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">TorsionRangeWords</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
 1183     
 1184     <span class="k">if</span> <span class="n">TorsionStart</span> <span class="o">&gt;=</span> <span class="n">TorsionStop</span><span class="p">:</span>
 1185         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintError</span><span class="p">(</span><span class="s2">&quot;The start value, </span><span class="si">%d</span><span class="s2">, specified for option </span><span class="se">\&quot;</span><span class="s2">--torsionRange</span><span class="se">\&quot;</span><span class="s2"> in string </span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2"> must be less than stop value, </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">TorsionStart</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--torsionRange&quot;</span><span class="p">],</span> <span class="n">TorsionStop</span><span class="p">))</span>
 1186     <span class="k">if</span> <span class="n">TorsionStep</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
 1187         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintError</span><span class="p">(</span><span class="s2">&quot;The step value, </span><span class="si">%d</span><span class="s2">, specified for option </span><span class="se">\&quot;</span><span class="s2">--torsonRange</span><span class="se">\&quot;</span><span class="s2"> in string </span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2"> must be &gt; 0.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">TorsionStep</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--torsionRange&quot;</span><span class="p">]))</span>
 1188     <span class="k">if</span> <span class="n">TorsionStep</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">TorsionStop</span> <span class="o">-</span> <span class="n">TorsionStart</span><span class="p">):</span>
 1189         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintError</span><span class="p">(</span><span class="s2">&quot;The step value, </span><span class="si">%d</span><span class="s2">, specified for option </span><span class="se">\&quot;</span><span class="s2">--torsonRange</span><span class="se">\&quot;</span><span class="s2"> in string </span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2"> must be less than, </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">TorsionStep</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--torsionRange&quot;</span><span class="p">],</span> <span class="p">(</span><span class="n">TorsionStop</span> <span class="o">-</span> <span class="n">TorsionStart</span><span class="p">)))</span>
 1190     
 1191     <span class="k">if</span> <span class="n">TorsionStart</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
 1192         <span class="k">if</span> <span class="n">TorsionStart</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">180</span><span class="p">:</span>
 1193             <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintError</span><span class="p">(</span><span class="s2">&quot;The start value, </span><span class="si">%d</span><span class="s2">, specified for option </span><span class="se">\&quot;</span><span class="s2">--torsionRange</span><span class="se">\&quot;</span><span class="s2"> in string </span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2"> must be  &gt;= -180 to use scan range from -180 to 180.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">TorsionStart</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--torsionRange&quot;</span><span class="p">]))</span>
 1194         <span class="k">if</span> <span class="n">TorsionStop</span> <span class="o">&gt;</span> <span class="mi">180</span><span class="p">:</span>
 1195             <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintError</span><span class="p">(</span><span class="s2">&quot;The stop value, </span><span class="si">%d</span><span class="s2">, specified for option </span><span class="se">\&quot;</span><span class="s2">--torsionRange</span><span class="se">\&quot;</span><span class="s2"> in string </span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2"> must be &lt;= 180 to use scan range from -180 to 180.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">TorsionStop</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--torsionRange&quot;</span><span class="p">]))</span>
 1196     <span class="k">else</span><span class="p">:</span>
 1197         <span class="k">if</span> <span class="n">TorsionStop</span> <span class="o">&gt;</span> <span class="mi">360</span><span class="p">:</span>
 1198             <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintError</span><span class="p">(</span><span class="s2">&quot;The stop value, </span><span class="si">%d</span><span class="s2">, specified for option </span><span class="se">\&quot;</span><span class="s2">--torsionRange</span><span class="se">\&quot;</span><span class="s2"> in string </span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2"> must be  &lt;= 360 to use scan range from 0 to 360.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">TorsionStop</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--torsionRange&quot;</span><span class="p">]))</span>
 1199     
 1200     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;TorsionRange&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">TorsionRange</span>
 1201     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;TorsionStart&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">TorsionStart</span>
 1202     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;TorsionStop&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">TorsionStop</span>
 1203     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;TorsionStep&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">TorsionStep</span>
 1204     
 1205     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;UseTethers&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^yes$&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--useTethers&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span> <span class="k">else</span> <span class="bp">False</span>
 1206     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;UseChirality&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^yes$&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--useChirality&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span> <span class="k">else</span> <span class="bp">False</span>
 1207 
 1208 <span class="k">def</span> <span class="nf">RetrieveOptions</span><span class="p">():</span>
 1209     <span class="sd">&quot;&quot;&quot;Retrieve command line arguments and options.&quot;&quot;&quot;</span>
 1210     
 1211     <span class="c1"># Get options...</span>
 1212     <span class="k">global</span> <span class="n">Options</span>
 1213     <span class="n">Options</span> <span class="o">=</span> <span class="n">docopt</span><span class="p">(</span><span class="n">_docoptUsage_</span><span class="p">)</span>
 1214     
 1215     <span class="c1"># Set current working directory to the specified directory...</span>
 1216     <span class="n">WorkingDir</span> <span class="o">=</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--workingdir&quot;</span><span class="p">]</span>
 1217     <span class="k">if</span> <span class="n">WorkingDir</span><span class="p">:</span>
 1218         <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">WorkingDir</span><span class="p">)</span>
 1219     
 1220     <span class="c1"># Handle examples option...</span>
 1221     <span class="k">if</span> <span class="s2">&quot;--examples&quot;</span> <span class="ow">in</span> <span class="n">Options</span> <span class="ow">and</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--examples&quot;</span><span class="p">]:</span>
 1222         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="n">MiscUtil</span><span class="o">.</span><span class="n">GetExamplesTextFromDocOptText</span><span class="p">(</span><span class="n">_docoptUsage_</span><span class="p">))</span>
 1223         <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
 1224 
 1225 <span class="k">def</span> <span class="nf">ValidateOptions</span><span class="p">():</span>
 1226     <span class="sd">&quot;&quot;&quot;Validate option values.&quot;&quot;&quot;</span>
 1227 
 1228     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ValidateOptionTextValue</span><span class="p">(</span><span class="s2">&quot;-a, --addHydrogens&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--addHydrogens&quot;</span><span class="p">],</span> <span class="s2">&quot;yes no&quot;</span><span class="p">)</span>
 1229     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ValidateOptionTextValue</span><span class="p">(</span><span class="s2">&quot;-c, --conformerGenerator&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--conformerGenerator&quot;</span><span class="p">],</span> <span class="s2">&quot;SDG ETDG KDG ETKDG&quot;</span><span class="p">)</span>
 1230     
 1231     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ValidateOptionTextValue</span><span class="p">(</span><span class="s2">&quot;-f, --forceField&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--forceField&quot;</span><span class="p">],</span> <span class="s2">&quot;UFF MMFF&quot;</span><span class="p">)</span>
 1232     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ValidateOptionTextValue</span><span class="p">(</span><span class="s2">&quot; --forceFieldMMFFVariant&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--forceFieldMMFFVariant&quot;</span><span class="p">],</span> <span class="s2">&quot;MMFF94 MMFF94s&quot;</span><span class="p">)</span>
 1233     
 1234     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ValidateOptionTextValue</span><span class="p">(</span><span class="s2">&quot;--enforceChirality &quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--enforceChirality&quot;</span><span class="p">],</span> <span class="s2">&quot;yes no&quot;</span><span class="p">)</span>
 1235     
 1236     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ValidateOptionFilePath</span><span class="p">(</span><span class="s2">&quot;-i, --infile&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--infile&quot;</span><span class="p">])</span>
 1237     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ValidateOptionFileExt</span><span class="p">(</span><span class="s2">&quot;-i, --infile&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--infile&quot;</span><span class="p">],</span> <span class="s2">&quot;sdf sd mol smi txt csv tsv&quot;</span><span class="p">)</span>
 1238     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ValidateOptionTextValue</span><span class="p">(</span><span class="s2">&quot;--infile3D&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--infile3D&quot;</span><span class="p">],</span> <span class="s2">&quot;yes no&quot;</span><span class="p">)</span>
 1239 
 1240     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ValidateOptionFileExt</span><span class="p">(</span><span class="s2">&quot;-o, --outfile&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--outfile&quot;</span><span class="p">],</span> <span class="s2">&quot;sdf sd&quot;</span><span class="p">)</span>
 1241     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ValidateOptionsOutputFileOverwrite</span><span class="p">(</span><span class="s2">&quot;-o, --outfile&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--outfile&quot;</span><span class="p">],</span> <span class="s2">&quot;--overwrite&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--overwrite&quot;</span><span class="p">])</span>
 1242     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ValidateOptionsDistinctFileNames</span><span class="p">(</span><span class="s2">&quot;-i, --infile&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--infile&quot;</span><span class="p">],</span> <span class="s2">&quot;-o, --outfile&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--outfile&quot;</span><span class="p">])</span>
 1243     
 1244     <span class="k">if</span> <span class="ow">not</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--overwrite&quot;</span><span class="p">]:</span>
 1245         <span class="n">FileDir</span><span class="p">,</span> <span class="n">FileName</span><span class="p">,</span> <span class="n">FileExt</span> <span class="o">=</span> <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ParseFileName</span><span class="p">(</span><span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--outfile&quot;</span><span class="p">])</span>
 1246         <span class="n">FileNames</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_*&quot;</span> <span class="o">%</span> <span class="n">FileName</span><span class="p">)</span>
 1247         <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">FileNames</span><span class="p">):</span>
 1248             <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintError</span><span class="p">(</span><span class="s2">&quot;The outfile names, </span><span class="si">%s</span><span class="s2">_*, generated from file specified, </span><span class="si">%s</span><span class="s2">, for option </span><span class="se">\&quot;</span><span class="s2">-o, --outfile</span><span class="se">\&quot;</span><span class="s2"> already exist. Use option </span><span class="se">\&quot;</span><span class="s2">--overwrite</span><span class="se">\&quot;</span><span class="s2"> or </span><span class="se">\&quot;</span><span class="s2">--ov</span><span class="se">\&quot;</span><span class="s2">  and try again.</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">FileName</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--outfile&quot;</span><span class="p">]))</span>
 1249     
 1250     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ValidateOptionTextValue</span><span class="p">(</span><span class="s2">&quot;--outPlotRelativeEnergy&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--outPlotRelativeEnergy&quot;</span><span class="p">],</span> <span class="s2">&quot;yes no&quot;</span><span class="p">)</span>
 1251     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ValidateOptionTextValue</span><span class="p">(</span><span class="s2">&quot;--outPlotTitleTorsionSpec&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--outPlotTitleTorsionSpec&quot;</span><span class="p">],</span> <span class="s2">&quot;yes no&quot;</span><span class="p">)</span>
 1252     
 1253     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ValidateOptionTextValue</span><span class="p">(</span><span class="s2">&quot;--outfileMolName &quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--outfileMolName&quot;</span><span class="p">],</span> <span class="s2">&quot;yes no&quot;</span><span class="p">)</span>
 1254     
 1255     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ValidateOptionTextValue</span><span class="p">(</span><span class="s2">&quot;--modeMols&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--modeMols&quot;</span><span class="p">],</span> <span class="s2">&quot;First All&quot;</span><span class="p">)</span>
 1256     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ValidateOptionTextValue</span><span class="p">(</span><span class="s2">&quot;--modeTorsions&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--modeTorsions&quot;</span><span class="p">],</span> <span class="s2">&quot;First All&quot;</span><span class="p">)</span>
 1257 
 1258     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ValidateOptionIntegerValue</span><span class="p">(</span><span class="s2">&quot;--maxConfs&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--maxConfs&quot;</span><span class="p">],</span> <span class="p">{</span><span class="s2">&quot;&gt;&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span>
 1259     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ValidateOptionIntegerValue</span><span class="p">(</span><span class="s2">&quot;--maxConfsTorsion&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--maxConfsTorsion&quot;</span><span class="p">],</span> <span class="p">{</span><span class="s2">&quot;&gt;&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span>
 1260     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ValidateOptionIntegerValue</span><span class="p">(</span><span class="s2">&quot;--maxIters&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--maxIters&quot;</span><span class="p">],</span> <span class="p">{</span><span class="s2">&quot;&gt;&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span>
 1261     
 1262     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ValidateOptionTextValue</span><span class="p">(</span><span class="s2">&quot;--mp&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--mp&quot;</span><span class="p">],</span> <span class="s2">&quot;yes no&quot;</span><span class="p">)</span>
 1263     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ValidateOptionTextValue</span><span class="p">(</span><span class="s2">&quot;--mpLevel&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--mpLevel&quot;</span><span class="p">],</span> <span class="s2">&quot;Molecules TorsionAngles&quot;</span><span class="p">)</span>
 1264     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ValidateOptionTextValue</span><span class="p">(</span><span class="s2">&quot;-q, --quiet&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--quiet&quot;</span><span class="p">],</span> <span class="s2">&quot;yes no&quot;</span><span class="p">)</span>
 1265     
 1266     <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^auto$&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--randomSeed&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
 1267         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ValidateOptionIntegerValue</span><span class="p">(</span><span class="s2">&quot;--randomSeed&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--randomSeed&quot;</span><span class="p">],</span> <span class="p">{})</span>
 1268     
 1269     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ValidateOptionTextValue</span><span class="p">(</span><span class="s2">&quot;-r, --removeHydrogens&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--removeHydrogens&quot;</span><span class="p">],</span> <span class="s2">&quot;yes no&quot;</span><span class="p">)</span>
 1270     
 1271     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ValidateOptionIntegerValue</span><span class="p">(</span><span class="s2">&quot;--torsionMaxMatches&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--torsionMaxMatches&quot;</span><span class="p">],</span> <span class="p">{</span><span class="s2">&quot;&gt;&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span>
 1272     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ValidateOptionTextValue</span><span class="p">(</span><span class="s2">&quot;--torsionMinimize&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--torsionMinimize&quot;</span><span class="p">],</span> <span class="s2">&quot;yes no&quot;</span><span class="p">)</span>
 1273     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ValidateOptionNumberValues</span><span class="p">(</span><span class="s2">&quot;--torsionRange&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--torsionRange&quot;</span><span class="p">],</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="s2">&quot;integer&quot;</span><span class="p">,</span> <span class="p">{})</span>
 1274     
 1275     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ValidateOptionTextValue</span><span class="p">(</span><span class="s2">&quot;--useChirality&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--useChirality&quot;</span><span class="p">],</span> <span class="s2">&quot;yes no&quot;</span><span class="p">)</span>
 1276     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ValidateOptionTextValue</span><span class="p">(</span><span class="s2">&quot;--useTethers&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--useTethers&quot;</span><span class="p">],</span> <span class="s2">&quot;yes no&quot;</span><span class="p">)</span>
 1277 
 1278 <span class="c1"># Setup a usage string for docopt...</span>
 1279 <span class="n">_docoptUsage_</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
 1280 <span class="s2">RDKitPerformTorsionScan.py - Perform torsion scan</span>
 1281 
 1282 <span class="s2">Usage:</span>
 1283 <span class="s2">    RDKitPerformTorsionScan.py [--addHydrogens &lt;yes or no&gt;] [--conformerGenerator &lt;SDG, ETDG, KDG, ETKDG&gt;]</span>
 1284 <span class="s2">                               [--forceField &lt;UFF, or MMFF&gt;] [--forceFieldMMFFVariant &lt;MMFF94 or MMFF94s&gt;]</span>
 1285 <span class="s2">                               [--enforceChirality &lt;yes or no&gt;] [--infile3D &lt;yes or no&gt;] [--infileParams &lt;Name,Value,...&gt;]</span>
 1286 <span class="s2">                               [--modeMols  &lt;First or All&gt;] [--modeTorsions  &lt;First or All&gt; ] [--maxConfs &lt;number&gt;]</span>
 1287 <span class="s2">                               [--maxConfsTorsion &lt;number&gt;] [--maxIters &lt;number&gt;] [--mp &lt;yes or no&gt;]</span>
 1288 <span class="s2">                               [--mpLevel &lt;Molecules or TorsionAngles&gt;] [--mpParams &lt;Name,Value,...&gt;]</span>
 1289 <span class="s2">                               [--outfileMolName  &lt;yes or no&gt;] [--outfileParams &lt;Name,Value,...&gt;] [--outPlotParams &lt;Name,Value,...&gt;]</span>
 1290 <span class="s2">                               [--outPlotRelativeEnergy &lt;yes or no&gt;] [--outPlotTitleTorsionSpec &lt;yes or no&gt;] [--overwrite]  [--quiet &lt;yes or no&gt;]</span>
 1291 <span class="s2">                               [--removeHydrogens &lt;yes or no&gt;] [--randomSeed &lt;number&gt;] [--torsionsFilterbyAtomIndices &lt;Index1, Index2, ...&gt;]</span>
 1292 <span class="s2">                               [--torsionMaxMatches &lt;number&gt;] [--torsionMinimize &lt;yes or no&gt;] [--torsionRange &lt;Start,Stop,Step&gt;]</span>
 1293 <span class="s2">                               [--useChirality &lt;yes or no&gt;] [--useTethers  &lt;yes or no&gt;] [-w &lt;dir&gt;] -t &lt;torsions&gt; -i &lt;infile&gt;  -o &lt;outfile&gt; </span>
 1294 <span class="s2">    RDKitPerformTorsionScan.py -h | --help | -e | --examples</span>
 1295 
 1296 <span class="s2">Description:</span>
 1297 <span class="s2">    Perform torsion scan for molecules around torsion angles specified using</span>
 1298 <span class="s2">    SMILES/SMARTS patterns. A molecule is optionally minimized before performing</span>
 1299 <span class="s2">    a torsion scan. A set of initial 3D structures are generated for a molecule</span>
 1300 <span class="s2">    by scanning the torsion angle across the specified range and updating the 3D</span>
 1301 <span class="s2">    coordinates of the molecule. A conformation ensemble is optionally generated</span>
 1302 <span class="s2">    for each 3D structure representing a specific torsion angle. The conformation</span>
 1303 <span class="s2">    with the lowest energy is selected to represent the torsion angle. An option</span>
 1304 <span class="s2">    is available to skip the generation of the conformation ensemble and simply</span>
 1305 <span class="s2">    calculate the energy for the initial 3D structure for a specific torsion angle.</span>
 1306 
 1307 <span class="s2">    The torsions are specified using SMILES or SMARTS patterns. A substructure match</span>
 1308 <span class="s2">    is performed to select torsion atoms in a molecule. The SMILES pattern match must</span>
 1309 <span class="s2">    correspond to four torsion atoms. The SMARTS patterns containing atom map numbers</span>
 1310 <span class="s2">    may match  more than four atoms. The atom map numbers, however, must match</span>
 1311 <span class="s2">    exactly four torsion atoms. For example: [s:1][c:2]([aX2,cH1])!@[CX3:3](O)=[O:4] for</span>
 1312 <span class="s2">    thiophene esters and carboxylates as specified in Torsion Library (TorLib) [Ref 146].</span>
 1313 
 1314 <span class="s2">    A set of four output files is generated for each torsion match in each</span>
 1315 <span class="s2">    molecule. The names of the output files are generated using the root of</span>
 1316 <span class="s2">    the specified output file. They may either contain sequential molecule</span>
 1317 <span class="s2">    numbers or molecule names as shown below:</span>
 1318 <span class="s2">        </span>
 1319 <span class="s2">        &lt;OutfileRoot&gt;_Mol&lt;Num&gt;.sdf</span>
 1320 <span class="s2">        &lt;OutfileRoot&gt;_Mol&lt;Num&gt;_Torsion&lt;Num&gt;_Match&lt;Num&gt;.sdf</span>
 1321 <span class="s2">        &lt;OutfileRoot&gt;_Mol&lt;Num&gt;_Torsion&lt;Num&gt;_Match&lt;Num&gt;_Energies.csv</span>
 1322 <span class="s2">        &lt;OutfileRoot&gt;_Mol&lt;Num&gt;_Torsion&lt;Num&gt;_Match&lt;Num&gt;_Plot.&lt;ImgExt&gt;</span>
 1323 <span class="s2">        </span>
 1324 <span class="s2">        or</span>
 1325 <span class="s2">        </span>
 1326 <span class="s2">        &lt;OutfileRoot&gt;_&lt;MolName&gt;.sdf</span>
 1327 <span class="s2">        &lt;OutfileRoot&gt;_&lt;MolName&gt;_Torsion&lt;Num&gt;_Match&lt;Num&gt;.sdf</span>
 1328 <span class="s2">        &lt;OutfileRoot&gt;_&lt;MolName&gt;_Torsion&lt;Num&gt;_Match&lt;Num&gt;_Energies.csv</span>
 1329 <span class="s2">        &lt;OutfileRoot&gt;_&lt;MolName&gt;_Torsion&lt;Num&gt;_Match&lt;Num&gt;_Plot.&lt;ImgExt&gt;</span>
 1330 <span class="s2">        </span>
 1331 <span class="s2">    The supported input file formats are: Mol (.mol), SD (.sdf, .sd), SMILES (.smi,</span>
 1332 <span class="s2">    .csv, .tsv, .txt)</span>
 1333 
 1334 <span class="s2">    The supported output file formats are: SD (.sdf, .sd)</span>
 1335 
 1336 <span class="s2">Options:</span>
 1337 <span class="s2">    -a, --addHydrogens &lt;yes or no&gt;  [default: yes]</span>
 1338 <span class="s2">        Add hydrogens before minimization.</span>
 1339 <span class="s2">    -c, --conformerGenerator &lt;SDG, ETDG, KDG, ETKDG&gt;  [default: ETKDG]</span>
 1340 <span class="s2">        Conformation generation methodology for generating initial 3D structure</span>
 1341 <span class="s2">        of a molecule and conformation ensemble representing a specific torsion</span>
 1342 <span class="s2">        angle. No conformation ensemble is generated for &#39;No&#39; value of</span>
 1343 <span class="s2">        &#39;--torsionMinimize&#39; option.</span>
 1344 <span class="s2">        </span>
 1345 <span class="s2">        Possible values: Standard Distance Geometry, (SDG), Experimental Torsion-angle</span>
 1346 <span class="s2">        preference with Distance Geometry (ETDG), basic Knowledge-terms with Distance</span>
 1347 <span class="s2">        Geometry (KDG),  and Experimental Torsion-angle preference along with basic</span>
 1348 <span class="s2">        Knowledge-terms with Distance Geometry (ETKDG) [Ref 129] .</span>
 1349 <span class="s2">    -f, --forceField &lt;UFF, MMFF&gt;  [default: MMFF]</span>
 1350 <span class="s2">        Forcefield method to use for  energy minimization of initial 3D structure</span>
 1351 <span class="s2">        of a molecule and conformation ensemble representing a specific torsion.</span>
 1352 <span class="s2">        No conformation ensemble is generated during for &#39;No&#39; value of &#39;--torsionMinimze&#39;</span>
 1353 <span class="s2">        option and constrained energy minimization is not performed. Possible values:</span>
 1354 <span class="s2">        Universal Force Field (UFF) [ Ref 81 ] or Merck Molecular Mechanics Force</span>
 1355 <span class="s2">        Field [ Ref 83-87 ] .</span>
 1356 <span class="s2">    --forceFieldMMFFVariant &lt;MMFF94 or MMFF94s&gt;  [default: MMFF94]</span>
 1357 <span class="s2">        Variant of MMFF forcefield to use for energy minimization.</span>
 1358 <span class="s2">    --enforceChirality &lt;yes or no&gt;  [default: Yes]</span>
 1359 <span class="s2">        Enforce chirality for defined chiral centers during generation of conformers.</span>
 1360 <span class="s2">    -e, --examples</span>
 1361 <span class="s2">        Print examples.</span>
 1362 <span class="s2">    -h, --help</span>
 1363 <span class="s2">        Print this help message.</span>
 1364 <span class="s2">    -i, --infile &lt;infile&gt;</span>
 1365 <span class="s2">        Input file name.</span>
 1366 <span class="s2">    --infile3D &lt;yes or no&gt;  [default: no]</span>
 1367 <span class="s2">        Skip generation and minimization of initial 3D structures for molecules in</span>
 1368 <span class="s2">        input file containing 3D coordinates.</span>
 1369 <span class="s2">    --infileParams &lt;Name,Value,...&gt;  [default: auto]</span>
 1370 <span class="s2">        A comma delimited list of parameter name and value pairs for reading</span>
 1371 <span class="s2">        molecules from files. The supported parameter names for different file</span>
 1372 <span class="s2">        formats, along with their default values, are shown below:</span>
 1373 <span class="s2">            </span>
 1374 <span class="s2">            SD, MOL: removeHydrogens,yes,sanitize,yes,strictParsing,yes</span>
 1375 <span class="s2">            </span>
 1376 <span class="s2">            SMILES: smilesColumn,1,smilesNameColumn,2,smilesDelimiter,space,</span>
 1377 <span class="s2">                smilesTitleLine,auto,sanitize,yes</span>
 1378 <span class="s2">            </span>
 1379 <span class="s2">        Possible values for smilesDelimiter: space, comma or tab.</span>
 1380 <span class="s2">    --modeMols &lt;First or All&gt;  [default: First]</span>
 1381 <span class="s2">        Perform torsion scan for the first molecule or all molecules in input</span>
 1382 <span class="s2">        file.</span>
 1383 <span class="s2">    --modeTorsions &lt;First or All&gt;  [default: First]</span>
 1384 <span class="s2">        Perform torsion scan for the first or all specified torsion pattern in</span>
 1385 <span class="s2">        molecules up to a maximum number of matches for each torsion</span>
 1386 <span class="s2">        specification as indicated by &#39;--torsionMaxMatches&#39; option. </span>
 1387 <span class="s2">    --maxConfs &lt;number&gt;  [default: 250]</span>
 1388 <span class="s2">        Maximum number of conformations to generate for initial 3D structure of a</span>
 1389 <span class="s2">        molecule. The lowest energy conformation is written to the output file.</span>
 1390 <span class="s2">    --maxConfsTorsion &lt;number&gt;  [default: 50]</span>
 1391 <span class="s2">        Maximum number of conformations to generate for conformation ensemble</span>
 1392 <span class="s2">        representing a specific torsion. A constrained minimization is performed</span>
 1393 <span class="s2">        using the coordinates of the specified torsion and the lowest energy</span>
 1394 <span class="s2">        conformation is written to the output file.</span>
 1395 <span class="s2">    --maxIters &lt;number&gt;  [default: 500]</span>
 1396 <span class="s2">        Maximum number of iterations to perform for a molecule during minimization</span>
 1397 <span class="s2">        to generation initial 3D structures. This option is ignored during &#39;yes&#39; value</span>
 1398 <span class="s2">        of  &#39;--infile3D&#39; option.</span>
 1399 <span class="s2">    --mp &lt;yes or no&gt;  [default: no]</span>
 1400 <span class="s2">        Use multiprocessing.</span>
 1401 <span class="s2">         </span>
 1402 <span class="s2">        By default, input data is retrieved in a lazy manner via mp.Pool.imap()</span>
 1403 <span class="s2">        function employing lazy RDKit data iterable. This allows processing of</span>
 1404 <span class="s2">        arbitrary large data sets without any additional requirements memory.</span>
 1405 <span class="s2">        </span>
 1406 <span class="s2">        All input data may be optionally loaded into memory by mp.Pool.map()</span>
 1407 <span class="s2">        before starting worker processes in a process pool by setting the value</span>
 1408 <span class="s2">        of &#39;inputDataMode&#39; to &#39;InMemory&#39; in &#39;--mpParams&#39; option.</span>
 1409 <span class="s2">        </span>
 1410 <span class="s2">        A word to the wise: The default &#39;chunkSize&#39; value of 1 during &#39;Lazy&#39; input</span>
 1411 <span class="s2">        data mode may adversely impact the performance. The &#39;--mpParams&#39; section</span>
 1412 <span class="s2">        provides additional information to tune the value of &#39;chunkSize&#39;.</span>
 1413 <span class="s2">    --mpLevel &lt;Molecules or TorsionAngles&gt;  [default: Molecules]</span>
 1414 <span class="s2">        Perform multiprocessing at molecules or torsion angles level. Possible values:</span>
 1415 <span class="s2">        Molecules or TorsionAngles. The &#39;Molecules&#39; value starts a process pool at the</span>
 1416 <span class="s2">        molecules level. All torsion angles of a molecule are processed in a single</span>
 1417 <span class="s2">        process. The &#39;TorsionAngles&#39; value, however, starts a process pool at the </span>
 1418 <span class="s2">        torsion angles level. Each torsion angle in a torsion match for a molecule is</span>
 1419 <span class="s2">        processed in an individual process in the process pool.</span>
 1420 <span class="s2">    --mpParams &lt;Name,Value,...&gt;  [default: auto]</span>
 1421 <span class="s2">        A comma delimited list of parameter name and value pairs to configure</span>
 1422 <span class="s2">        multiprocessing.</span>
 1423 <span class="s2">        </span>
 1424 <span class="s2">        The supported parameter names along with their default and possible</span>
 1425 <span class="s2">        values are shown below:</span>
 1426 <span class="s2">        </span>
 1427 <span class="s2">            chunkSize, auto</span>
 1428 <span class="s2">            inputDataMode, Lazy   [ Possible values: InMemory or Lazy ]</span>
 1429 <span class="s2">            numProcesses, auto   [ Default: mp.cpu_count() ]</span>
 1430 <span class="s2">        </span>
 1431 <span class="s2">        These parameters are used by the following functions to configure and</span>
 1432 <span class="s2">        control the behavior of multiprocessing: mp.Pool(), mp.Pool.map(), and</span>
 1433 <span class="s2">        mp.Pool.imap().</span>
 1434 <span class="s2">        </span>
 1435 <span class="s2">        The chunkSize determines chunks of input data passed to each worker</span>
 1436 <span class="s2">        process in a process pool by mp.Pool.map() and mp.Pool.imap() functions.</span>
 1437 <span class="s2">        The default value of chunkSize is dependent on the value of &#39;inputDataMode&#39;.</span>
 1438 <span class="s2">        </span>
 1439 <span class="s2">        The mp.Pool.map() function, invoked during &#39;InMemory&#39; input data mode,</span>
 1440 <span class="s2">        automatically converts RDKit data iterable into a list, loads all data into</span>
 1441 <span class="s2">        memory, and calculates the default chunkSize using the following method</span>
 1442 <span class="s2">        as shown in its code:</span>
 1443 <span class="s2">        </span>
 1444 <span class="s2">            chunkSize, extra = divmod(len(dataIterable), len(numProcesses) * 4)</span>
 1445 <span class="s2">            if extra: chunkSize += 1</span>
 1446 <span class="s2">        </span>
 1447 <span class="s2">        For example, the default chunkSize will be 7 for a pool of 4 worker processes</span>
 1448 <span class="s2">        and 100 data items.</span>
 1449 <span class="s2">        </span>
 1450 <span class="s2">        The mp.Pool.imap() function, invoked during &#39;Lazy&#39; input data mode, employs</span>
 1451 <span class="s2">        &#39;lazy&#39; RDKit data iterable to retrieve data as needed, without loading all the</span>
 1452 <span class="s2">        data into memory. Consequently, the size of input data is not known a priori.</span>
 1453 <span class="s2">        It&#39;s not possible to estimate an optimal value for the chunkSize. The default </span>
 1454 <span class="s2">        chunkSize is set to 1.</span>
 1455 <span class="s2">        </span>
 1456 <span class="s2">        The default value for the chunkSize during &#39;Lazy&#39; data mode may adversely</span>
 1457 <span class="s2">        impact the performance due to the overhead associated with exchanging</span>
 1458 <span class="s2">        small chunks of data. It is generally a good idea to explicitly set chunkSize to</span>
 1459 <span class="s2">        a larger value during &#39;Lazy&#39; input data mode, based on the size of your input</span>
 1460 <span class="s2">        data and number of processes in the process pool.</span>
 1461 <span class="s2">        </span>
 1462 <span class="s2">        The mp.Pool.map() function waits for all worker processes to process all</span>
 1463 <span class="s2">        the data and return the results. The mp.Pool.imap() function, however,</span>
 1464 <span class="s2">        returns the the results obtained from worker processes as soon as the</span>
 1465 <span class="s2">        results become available for specified chunks of data.</span>
 1466 <span class="s2">        </span>
 1467 <span class="s2">        The order of data in the results returned by both mp.Pool.map() and </span>
 1468 <span class="s2">        mp.Pool.imap() functions always corresponds to the input data.</span>
 1469 <span class="s2">    -o, --outfile &lt;outfile&gt;</span>
 1470 <span class="s2">        Output file name. The output file root is used for generating the names</span>
 1471 <span class="s2">        of the output files corresponding to structures, energies, and plots during</span>
 1472 <span class="s2">        the torsion scan.</span>
 1473 <span class="s2">    --outfileMolName &lt;yes or no&gt;  [default: no]</span>
 1474 <span class="s2">        Append molecule name to output file root during the generation of the names</span>
 1475 <span class="s2">        for output files. The default is to use &lt;MolNum&gt;. The non alphabetical</span>
 1476 <span class="s2">        characters in molecule names are replaced by underscores.</span>
 1477 <span class="s2">    --outfileParams &lt;Name,Value,...&gt;  [default: auto]</span>
 1478 <span class="s2">        A comma delimited list of parameter name and value pairs for writing</span>
 1479 <span class="s2">        molecules to files. The supported parameter names for different file</span>
 1480 <span class="s2">        formats, along with their default values, are shown below:</span>
 1481 <span class="s2">            </span>
 1482 <span class="s2">            SD: kekulize,yes</span>
 1483 <span class="s2">            </span>
 1484 <span class="s2">    --outPlotParams &lt;Name,Value,...&gt;  [default: auto]</span>
 1485 <span class="s2">        A comma delimited list of parameter name and value pairs for generating</span>
 1486 <span class="s2">        plots using Seaborn module. The supported parameter names along with their</span>
 1487 <span class="s2">        default values are shown below:</span>
 1488 <span class="s2">            </span>
 1489 <span class="s2">            type,linepoint,outExt,svg,width,10,height,5.6,</span>
 1490 <span class="s2">            title,auto,xlabel,auto,ylabel,auto,titleWeight,bold,labelWeight,bold</span>
 1491 <span class="s2">            style,darkgrid,palette,deep,font,sans-serif,fontScale,1,</span>
 1492 <span class="s2">            context,notebook</span>
 1493 <span class="s2">            </span>
 1494 <span class="s2">        Possible values:</span>
 1495 <span class="s2">            </span>
 1496 <span class="s2">            type: linepoint, scatter, or line. Both points and lines are drawn</span>
 1497 <span class="s2">                for linepoint plot type.</span>
 1498 <span class="s2">            outExt: Any valid format supported by Python module Matplotlib.</span>
 1499 <span class="s2">                For example: PDF (.pdf), PNG (.png), PS (.ps), SVG (.svg)</span>
 1500 <span class="s2">            titleWeight, labelWeight: Font weight for title and axes labels.</span>
 1501 <span class="s2">                Any valid value.</span>
 1502 <span class="s2">            style: darkgrid, whitegrid, dark, white, ticks</span>
 1503 <span class="s2">            palette: deep, muted, pastel, dark, bright, colorblind</span>
 1504 <span class="s2">            font: Any valid font name</span>
 1505 <span class="s2">            </span>
 1506 <span class="s2">    --outPlotRelativeEnergy &lt;yes or no&gt;  [default: yes]</span>
 1507 <span class="s2">        Plot relative energies in the torsion plot. The minimum energy value is</span>
 1508 <span class="s2">        subtracted from energy values to calculate relative energies.</span>
 1509 <span class="s2">    --outPlotTitleTorsionSpec &lt;yes or no&gt;  [default: yes]</span>
 1510 <span class="s2">        Append torsion specification to the title of the torsion plot.</span>
 1511 <span class="s2">    --overwrite</span>
 1512 <span class="s2">        Overwrite existing files.</span>
 1513 <span class="s2">    -q, --quiet &lt;yes or no&gt;  [default: no]</span>
 1514 <span class="s2">        Use quiet mode. The warning and information messages will not be printed.</span>
 1515 <span class="s2">    --randomSeed &lt;number&gt;  [default: auto]</span>
 1516 <span class="s2">        Seed for the random number generator for generating initial 3D coordinates.</span>
 1517 <span class="s2">        Default is to use a random seed.</span>
 1518 <span class="s2">    --removeHydrogens &lt;yes or no&gt;  [default: Yes]</span>
 1519 <span class="s2">        Remove hydrogens after minimization.</span>
 1520 <span class="s2">    -t, --torsions &lt;SMILES/SMARTS,...,...&gt;</span>
 1521 <span class="s2">        SMILES/SMARTS patterns corresponding to torsion specifications. It&#39;s a </span>
 1522 <span class="s2">        comma delimited list of valid SMILES/SMART patterns.</span>
 1523 <span class="s2">        </span>
 1524 <span class="s2">        A substructure match is performed to select torsion atoms in a molecule.</span>
 1525 <span class="s2">        The SMILES pattern match must correspond to four torsion atoms. The</span>
 1526 <span class="s2">        SMARTS patterns containing atom map numbers  may match  more than four</span>
 1527 <span class="s2">        atoms. The atom map numbers, however, must match exactly four torsion</span>
 1528 <span class="s2">        atoms. For example: [s:1][c:2]([aX2,cH1])!@[CX3:3](O)=[O:4] for thiophene</span>
 1529 <span class="s2">        esters and carboxylates as specified in Torsion Library (TorLib) [Ref 146].</span>
 1530 <span class="s2">    --torsionsFilterbyAtomIndices &lt;Index1, Index2, ...&gt;  [default: none]</span>
 1531 <span class="s2">        Comma delimited list of atom indices for filtering torsion matches</span>
 1532 <span class="s2">        corresponding to torsion specifications  &quot;-t, --torsions&quot;. The atom indices</span>
 1533 <span class="s2">        must be valid. No explicit validation is performed. The list must contain at</span>
 1534 <span class="s2">        least 4 atom indices.</span>
 1535 <span class="s2">        </span>
 1536 <span class="s2">        The torsion atom indices, matched by &quot;-t, --torsions&quot; specifications, must be</span>
 1537 <span class="s2">        present in the list. Otherwise, the torsion matches are ignored.</span>
 1538 <span class="s2">    --torsionMaxMatches &lt;number&gt;  [default: 5]</span>
 1539 <span class="s2">        Maximum number of torsions to match for each torsion specification in a</span>
 1540 <span class="s2">        molecule.</span>
 1541 <span class="s2">    --torsionMinimize &lt;yes or no&gt;  [default: no]</span>
 1542 <span class="s2">        Perform constrained energy minimization on a conformation ensemble</span>
 1543 <span class="s2">        for  a specific torsion angle and select the lowest energy conformation</span>
 1544 <span class="s2">        representing the torsion angle.</span>
 1545 <span class="s2">    --torsionRange &lt;Start,Stop,Step&gt;  [default: 0,360,5]</span>
 1546 <span class="s2">        Start, stop, and step size angles in degrees for a torsion scan. In addition,</span>
 1547 <span class="s2">        you may specify values using start and stop angles from -180 to 180.</span>
 1548 <span class="s2">    --useChirality &lt;yes or no&gt;  [default: no]</span>
 1549 <span class="s2">        Use chirrality during substructure matches for identification of torsions.</span>
 1550 <span class="s2">     --useTethers &lt;yes or no&gt;  [default: yes]</span>
 1551 <span class="s2">        Use tethers to optimize the final conformation by applying a series of extra forces</span>
 1552 <span class="s2">        to align matching atoms to the positions of the core atoms. Otherwise, use simple</span>
 1553 <span class="s2">        distance constraints during the optimization.</span>
 1554 <span class="s2">    -w, --workingdir &lt;dir&gt;</span>
 1555 <span class="s2">        Location of working directory which defaults to the current directory.</span>
 1556 
 1557 <span class="s2">Examples:</span>
 1558 <span class="s2">    To perform a torsion scan on the first molecule in a SMILES file using a minimum</span>
 1559 <span class="s2">    energy structure of the molecule selected from an ensemble of conformations,</span>
 1560 <span class="s2">    skipping generation of conformation ensembles for specific torsion angles and</span>
 1561 <span class="s2">    constrained energy minimization of the ensemble, generate output files</span>
 1562 <span class="s2">    corresponding to structure, energy and torsion plot, type:</span>
 1563 <span class="s2">    </span>
 1564 <span class="s2">        % RDKitPerformTorsionScan.py  -t &quot;O=CNC&quot; -i SampleSeriesD3R.smi </span>
 1565 <span class="s2">          -o SampleOut.sdf</span>
 1566 
 1567 <span class="s2">    To run the previous example on all molecules in a SD file, type:</span>
 1568 <span class="s2">    </span>
 1569 <span class="s2">        % RDKitPerformTorsionScan.py  -t &quot;O=CNC&quot; --modeMols All</span>
 1570 <span class="s2">          -i SampleSeriesD3R.sdf -o SampleOut.sdf</span>
 1571 
 1572 <span class="s2">    To perform a torsion scan on the first molecule in a SMILES file using a minimum</span>
 1573 <span class="s2">    energy structure of the molecule selected from an ensemble of conformations,</span>
 1574 <span class="s2">    generation of conformation ensembles for specific torsion angles and constrained</span>
 1575 <span class="s2">    energy minimization of the ensemble, generate output files corresponding to</span>
 1576 <span class="s2">    structure, energy and torsion plot, type:</span>
 1577 <span class="s2">    </span>
 1578 <span class="s2">        % RDKitPerformTorsionScan.py  -t &quot;O=CNC&quot; --torsionMinimize Yes</span>
 1579 <span class="s2">           -i SampleSeriesD3R.smi -o SampleOut.sdf</span>
 1580 
 1581 <span class="s2">    To run the previous example on all molecules in a SD file, type:</span>
 1582 <span class="s2">    </span>
 1583 <span class="s2">        % RDKitPerformTorsionScan.py  -t &quot;O=CNC&quot; --modeMols All</span>
 1584 <span class="s2">           --torsionMinimize Yes -i SampleSeriesD3R.sdf -o SampleOut.sdf</span>
 1585 
 1586 <span class="s2">    To run the previous example in multiprocessing mode at molecules level</span>
 1587 <span class="s2">    on all available CPUs without loading all data into memory and write out</span>
 1588 <span class="s2">    a SD file, type:</span>
 1589 
 1590 <span class="s2">        % RDKitPerformTorsionScan.py  -t &quot;O=CNC&quot; -i SampleSeriesD3R.smi </span>
 1591 <span class="s2">          -o SampleOut.sdf --modeMols All --torsionMinimize Yes --mp yes</span>
 1592 <span class="s2">    </span>
 1593 <span class="s2">    To run the previous example in multiprocessing mode at torsion angles level</span>
 1594 <span class="s2">    on all available CPUs without loading all data into memory and write out</span>
 1595 <span class="s2">    a SD file, type:</span>
 1596 
 1597 <span class="s2">        % RDKitPerformTorsionScan.py  -t &quot;O=CNC&quot; -i SampleSeriesD3R.smi </span>
 1598 <span class="s2">          -o SampleOut.sdf --modeMols All --torsionMinimize Yes --mp yes</span>
 1599 <span class="s2">          --mpLevel TorsionAngles</span>
 1600 <span class="s2">    </span>
 1601 <span class="s2">    To run the previous example in multiprocessing mode on all available CPUs</span>
 1602 <span class="s2">    by loading all data into memory and write out a SD file, type:</span>
 1603 
 1604 <span class="s2">        % RDKitPerformTorsionScan.py  -t &quot;O=CNC&quot; -i SampleSeriesD3R.smi </span>
 1605 <span class="s2">          -o SampleOut.sdf --modeMols All --torsionMinimize Yes --mp yes</span>
 1606 <span class="s2">          --mpParams &quot;inputDataMode,InMemory&quot;</span>
 1607 <span class="s2">    </span>
 1608 <span class="s2">    To run the previous example in multiprocessing mode on specific number of</span>
 1609 <span class="s2">    CPUs and chunk size without loading all data into memory and write out a SD file,</span>
 1610 <span class="s2">    type:</span>
 1611 
 1612 <span class="s2">        % RDKitPerformTorsionScan.py  -t &quot;O=CNC&quot; -i SampleSeriesD3R.smi </span>
 1613 <span class="s2">          -o SampleOut.sdf --modeMols All --torsionMinimize Yes --mp yes</span>
 1614 <span class="s2">          --mpParams &quot;inputDataMode,Lazy,numProcesses,4,chunkSize,8&quot;</span>
 1615 
 1616 <span class="s2">    To perform a torsion scan on first molecule in a SD file containing 3D coordinates,</span>
 1617 <span class="s2">    skipping generation of conformation ensembles for specific torsion angles and</span>
 1618 <span class="s2">    constrained energy minimization of the ensemble, generate output files</span>
 1619 <span class="s2">    corresponding to structure, energy and torsion plot, type:</span>
 1620 <span class="s2">    </span>
 1621 <span class="s2">        % RDKitPerformTorsionScan.py  -t &quot;O=CNC&quot;  --infile3D yes</span>
 1622 <span class="s2">          -i SampleSeriesD3R3D.sdf -o SampleOut.sdf</span>
 1623 
 1624 <span class="s2">    To perform a torsion scan using multiple torsion specifications on all molecules in</span>
 1625 <span class="s2">    a SD file containing 3D coordinates, generation of conformation ensembles for specific</span>
 1626 <span class="s2">    torsion angles and constrained energy minimization of the ensemble, generate output files</span>
 1627 <span class="s2">    corresponding to structure, energy and torsion plot, type:</span>
 1628 <span class="s2">    </span>
 1629 <span class="s2">        % RDKitPerformTorsionScan.py  -t &quot;O=CNC,[O:1]=[C:2](c)[N:3][C:4]&quot;</span>
 1630 <span class="s2">          --infile3D yes --modeMols All  --modeTorsions All</span>
 1631 <span class="s2">          --torsionMinimize Yes -i SampleSeriesD3R3D.sdf -o SampleOut.sdf</span>
 1632 
 1633 <span class="s2">    To run the previous example using a specific torsion scan range, type:</span>
 1634 
 1635 <span class="s2">        % RDKitPerformTorsionScan.py  -t &quot;O=CNC,[O:1]=[C:2](c)[N:3][C:4]&quot;</span>
 1636 <span class="s2">          --infile3D yes --modeMols All --modeTorsions All --torsionMinimize</span>
 1637 <span class="s2">          Yes --torsionRange 0,360,10 -i SampleSeriesD3R.smi -o SampleOut.sdf</span>
 1638 
 1639 <span class="s2">Author:</span>
 1640 <span class="s2">    Manish Sud(msud@san.rr.com)</span>
 1641 
 1642 <span class="s2">See also:</span>
 1643 <span class="s2">    RDKitCalculateRMSD.py, RDKitCalculateMolecularDescriptors.py, RDKitCompareMoleculeShapes.py,</span>
 1644 <span class="s2">    RDKitConvertFileFormat.py, RDKitPerformConstrainedMinimization.py</span>
 1645 
 1646 <span class="s2">Copyright:</span>
 1647 <span class="s2">    Copyright (C) 2022 Manish Sud. All rights reserved.</span>
 1648 
 1649 <span class="s2">    The functionality available in this script is implemented using RDKit, an</span>
 1650 <span class="s2">    open source toolkit for cheminformatics developed by Greg Landrum.</span>
 1651 
 1652 <span class="s2">    This file is part of MayaChemTools.</span>
 1653 
 1654 <span class="s2">    MayaChemTools is free software; you can redistribute it and/or modify it under</span>
 1655 <span class="s2">    the terms of the GNU Lesser General Public License as published by the Free</span>
 1656 <span class="s2">    Software Foundation; either version 3 of the License, or (at your option) any</span>
 1657 <span class="s2">    later version.</span>
 1658 
 1659 <span class="s2">&quot;&quot;&quot;</span>
 1660 
 1661 <span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
 1662     <span class="n">main</span><span class="p">()</span>
</pre>
<br />
<center>
<img src="../../../images/h2o2.png">
</center>
</body>
</html>
