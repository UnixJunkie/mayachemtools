<html>
<head>
<title>MayaChemTools:Code:Psi4PerformTorsionScan.py</title>
<meta http-equiv="content-type" content="text/html;charset=utf-8">
<link rel="stylesheet" type="text/css" href="../../../css/MayaChemToolsPythonCode.css">
</head>
<body leftmargin="20" rightmargin="20" topmargin="10" bottommargin="10">
<br/>
<center>
<a href="http://www.mayachemtools.org" title="MayaChemTools Home"><img src="../../../images/MayaChemToolsLogo.gif" border="0" alt="MayaChemTools"></a>
</center>
<br/>
<pre>
    1 <span class="ch">#!/bin/env python</span>
    2 <span class="c1">#</span>
    3 <span class="c1"># File: Psi4PerformTorsionScan.py</span>
    4 <span class="c1"># Author: Manish Sud &lt;msud@san.rr.com&gt;</span>
    5 <span class="c1">#</span>
    6 <span class="c1"># Copyright (C) 2022 Manish Sud. All rights reserved.</span>
    7 <span class="c1">#</span>
    8 <span class="c1"># The functionality available in this script is implemented using Psi4, an</span>
    9 <span class="c1"># open source quantum chemistry software package, and RDKit, an open</span>
   10 <span class="c1"># source toolkit for cheminformatics developed by Greg Landrum.</span>
   11 <span class="c1">#</span>
   12 <span class="c1"># This file is part of MayaChemTools.</span>
   13 <span class="c1">#</span>
   14 <span class="c1"># MayaChemTools is free software; you can redistribute it and/or modify it under</span>
   15 <span class="c1"># the terms of the GNU Lesser General Public License as published by the Free</span>
   16 <span class="c1"># Software Foundation; either version 3 of the License, or (at your option) any</span>
   17 <span class="c1"># later version.</span>
   18 <span class="c1">#</span>
   19 <span class="c1"># MayaChemTools is distributed in the hope that it will be useful, but without</span>
   20 <span class="c1"># any warranty; without even the implied warranty of merchantability of fitness</span>
   21 <span class="c1"># for a particular purpose.  See the GNU Lesser General Public License for more</span>
   22 <span class="c1"># details.</span>
   23 <span class="c1">#</span>
   24 <span class="c1"># You should have received a copy of the GNU Lesser General Public License</span>
   25 <span class="c1"># along with MayaChemTools; if not, see &lt;http://www.gnu.org/licenses/&gt; or</span>
   26 <span class="c1"># write to the Free Software Foundation Inc., 59 Temple Place, Suite 330,</span>
   27 <span class="c1"># Boston, MA, 02111-1307, USA.</span>
   28 <span class="c1">#</span>
   29 <span class="c1">#</span>
   30 
   31 <span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>
   32 
   33 <span class="c1"># Add local python path to the global path and import standard library modules...</span>
   34 <span class="kn">import</span> <span class="nn">os</span>
   35 <span class="kn">import</span> <span class="nn">sys</span><span class="p">;</span>  <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="s2">&quot;..&quot;</span><span class="p">,</span> <span class="s2">&quot;lib&quot;</span><span class="p">,</span> <span class="s2">&quot;Python&quot;</span><span class="p">))</span>
   36 <span class="kn">import</span> <span class="nn">time</span>
   37 <span class="kn">import</span> <span class="nn">re</span>
   38 <span class="kn">import</span> <span class="nn">glob</span>
   39 <span class="kn">import</span> <span class="nn">shutil</span>
   40 <span class="kn">import</span> <span class="nn">multiprocessing</span> <span class="kn">as</span> <span class="nn">mp</span>
   41 
   42 <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
   43 <span class="kn">import</span> <span class="nn">seaborn</span> <span class="kn">as</span> <span class="nn">sns</span>
   44 
   45 <span class="c1"># Psi4 imports...</span>
   46 <span class="k">if</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">shutil</span><span class="p">,</span> <span class="s1">&#39;which&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">shutil</span><span class="o">.</span><span class="n">which</span><span class="p">(</span><span class="s2">&quot;psi4&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">):</span>
   47     <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Warning: Failed to find &#39;psi4&#39; in your PATH indicating potential issues with your</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
   48     <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Psi4 environment. The &#39;import psi4&#39; directive in the global scope of the script</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
   49     <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;interferes with the multiprocessing functionality. It is imported later in the</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
   50     <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;local scope during the execution of the script and may fail. Check/update your</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
   51     <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Psi4 environment and try again.</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
   52 
   53 <span class="c1"># RDKit imports...</span>
   54 <span class="k">try</span><span class="p">:</span>
   55     <span class="kn">from</span> <span class="nn">rdkit</span> <span class="kn">import</span> <span class="n">rdBase</span>
   56     <span class="kn">from</span> <span class="nn">rdkit</span> <span class="kn">import</span> <span class="n">Chem</span>
   57     <span class="kn">from</span> <span class="nn">rdkit.Chem</span> <span class="kn">import</span> <span class="n">AllChem</span>
   58     <span class="kn">from</span> <span class="nn">rdkit.Chem</span> <span class="kn">import</span> <span class="n">rdMolAlign</span>
   59     <span class="kn">from</span> <span class="nn">rdkit.Chem</span> <span class="kn">import</span> <span class="n">rdMolTransforms</span>
   60 <span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">ErrMsg</span><span class="p">:</span>
   61     <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Failed to import RDKit module/package: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">ErrMsg</span><span class="p">)</span>
   62     <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Check/update your RDKit environment and try again.</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
   63     <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
   64 
   65 <span class="c1"># MayaChemTools imports...</span>
   66 <span class="k">try</span><span class="p">:</span>
   67     <span class="kn">from</span> <span class="nn">docopt</span> <span class="kn">import</span> <span class="n">docopt</span>
   68     <span class="kn">import</span> <span class="nn">MiscUtil</span>
   69     <span class="kn">import</span> <span class="nn">Psi4Util</span>
   70     <span class="kn">import</span> <span class="nn">RDKitUtil</span>
   71 <span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">ErrMsg</span><span class="p">:</span>
   72     <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Failed to import MayaChemTools module/package: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">ErrMsg</span><span class="p">)</span>
   73     <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Check/update your MayaChemTools environment and try again.</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
   74     <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
   75 
   76 <span class="n">ScriptName</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
   77 <span class="n">Options</span> <span class="o">=</span> <span class="p">{}</span>
   78 <span class="n">OptionsInfo</span> <span class="o">=</span> <span class="p">{}</span>
   79 
   80 <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
   81     <span class="sd">&quot;&quot;&quot;Start execution of the script.&quot;&quot;&quot;</span>
   82     
   83     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">%s</span><span class="s2"> (Psi4: Imported later; RDKit v</span><span class="si">%s</span><span class="s2">; MayaChemTools v</span><span class="si">%s</span><span class="s2">; </span><span class="si">%s</span><span class="s2">): Starting...</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ScriptName</span><span class="p">,</span> <span class="n">rdBase</span><span class="o">.</span><span class="n">rdkitVersion</span><span class="p">,</span> <span class="n">MiscUtil</span><span class="o">.</span><span class="n">GetMayaChemToolsVersion</span><span class="p">(),</span> <span class="n">time</span><span class="o">.</span><span class="n">asctime</span><span class="p">()))</span>
   84     
   85     <span class="p">(</span><span class="n">WallClockTime</span><span class="p">,</span> <span class="n">ProcessorTime</span><span class="p">)</span> <span class="o">=</span> <span class="n">MiscUtil</span><span class="o">.</span><span class="n">GetWallClockAndProcessorTime</span><span class="p">()</span>
   86     
   87     <span class="c1"># Retrieve command line arguments and options...</span>
   88     <span class="n">RetrieveOptions</span><span class="p">()</span>
   89     
   90     <span class="c1"># Process and validate command line arguments and options...</span>
   91     <span class="n">ProcessOptions</span><span class="p">()</span>
   92     
   93     <span class="c1"># Perform actions required by the script...</span>
   94     <span class="n">PerformTorsionScan</span><span class="p">()</span>
   95 
   96     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">%s</span><span class="s2">: Done...</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">ScriptName</span><span class="p">)</span>
   97     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;Total time: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">MiscUtil</span><span class="o">.</span><span class="n">GetFormattedElapsedTime</span><span class="p">(</span><span class="n">WallClockTime</span><span class="p">,</span> <span class="n">ProcessorTime</span><span class="p">))</span>
   98 
   99 <span class="k">def</span> <span class="nf">PerformTorsionScan</span><span class="p">():</span>
  100     <span class="sd">&quot;&quot;&quot;Perform torsion scan.&quot;&quot;&quot;</span>
  101     
  102     <span class="c1"># Setup a molecule reader for input file...</span>
  103     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Processing file </span><span class="si">%s</span><span class="s2">...&quot;</span> <span class="o">%</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Infile&quot;</span><span class="p">])</span>
  104     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;InfileParams&quot;</span><span class="p">][</span><span class="s2">&quot;AllowEmptyMols&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
  105     <span class="n">Mols</span>  <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">ReadMolecules</span><span class="p">(</span><span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Infile&quot;</span><span class="p">],</span> <span class="o">**</span><span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;InfileParams&quot;</span><span class="p">])</span>
  106     
  107     <span class="n">PlotExt</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;OutPlotParams&quot;</span><span class="p">][</span><span class="s2">&quot;OutExt&quot;</span><span class="p">]</span>
  108     <span class="n">FileDir</span><span class="p">,</span> <span class="n">FileName</span><span class="p">,</span> <span class="n">FileExt</span> <span class="o">=</span> <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ParseFileName</span><span class="p">(</span><span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--outfile&quot;</span><span class="p">])</span>
  109     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;Generating output files </span><span class="si">%s</span><span class="s2">_*.sdf, </span><span class="si">%s</span><span class="s2">_*Torsion*Match*.sdf, </span><span class="si">%s</span><span class="s2">_*Torsion*Match*Energies.csv, </span><span class="si">%s</span><span class="s2">_*Torsion*Match*Plot.</span><span class="si">%s</span><span class="s2">...&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">FileName</span><span class="p">,</span> <span class="n">FileName</span><span class="p">,</span> <span class="n">FileName</span><span class="p">,</span> <span class="n">FileName</span><span class="p">,</span> <span class="n">PlotExt</span><span class="p">))</span>
  110 
  111     <span class="n">MolCount</span><span class="p">,</span> <span class="n">ValidMolCount</span><span class="p">,</span> <span class="n">MinimizationFailedCount</span><span class="p">,</span> <span class="n">TorsionsMissingCount</span><span class="p">,</span> <span class="n">TorsionsScanFailedCount</span> <span class="o">=</span> <span class="n">ProcessMolecules</span><span class="p">(</span><span class="n">Mols</span><span class="p">)</span>
  112     
  113     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Total number of molecules: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">MolCount</span><span class="p">)</span>
  114     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;Number of valid molecules: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">ValidMolCount</span><span class="p">)</span>
  115     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;Number of molecules failed during initial minimization: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">MinimizationFailedCount</span><span class="p">)</span>
  116     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;Number of molecules without any matched torsions: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">TorsionsMissingCount</span><span class="p">)</span>
  117     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;Number of molecules failed during torsion scan: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">TorsionsScanFailedCount</span><span class="p">)</span>
  118     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;Number of ignored molecules: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">MolCount</span> <span class="o">-</span> <span class="n">ValidMolCount</span> <span class="o">+</span> <span class="n">TorsionsMissingCount</span> <span class="o">+</span> <span class="n">MinimizationFailedCount</span> <span class="o">+</span> <span class="n">TorsionsScanFailedCount</span><span class="p">))</span>
  119 
  120 <span class="k">def</span> <span class="nf">ProcessMolecules</span><span class="p">(</span><span class="n">Mols</span><span class="p">):</span>
  121     <span class="sd">&quot;&quot;&quot;Process molecules to perform torsion scan.&quot;&quot;&quot;</span>
  122 
  123     <span class="k">if</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;MPMode&quot;</span><span class="p">]:</span>
  124         <span class="k">return</span> <span class="n">ProcessMoleculesUsingMultipleProcesses</span><span class="p">(</span><span class="n">Mols</span><span class="p">)</span>
  125     <span class="k">else</span><span class="p">:</span>
  126         <span class="k">return</span> <span class="n">ProcessMoleculesUsingSingleProcess</span><span class="p">(</span><span class="n">Mols</span><span class="p">)</span>
  127 
  128 <span class="k">def</span> <span class="nf">ProcessMoleculesUsingSingleProcess</span><span class="p">(</span><span class="n">Mols</span><span class="p">):</span>
  129     <span class="sd">&quot;&quot;&quot;Process molecules to perform torsion scan using a single process.&quot;&quot;&quot;</span>
  130 
  131     <span class="c1"># Intialize Psi4...</span>
  132     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Initializing Psi4...&quot;</span><span class="p">)</span>
  133     <span class="n">Psi4Handle</span> <span class="o">=</span> <span class="n">Psi4Util</span><span class="o">.</span><span class="n">InitializePsi4</span><span class="p">(</span><span class="n">Psi4RunParams</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Psi4RunParams&quot;</span><span class="p">],</span> <span class="n">Psi4OptionsParams</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Psi4OptionsParams&quot;</span><span class="p">],</span> <span class="n">PrintVersion</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">PrintHeader</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
  134     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;psi4&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Psi4Handle</span>
  135 
  136     <span class="c1"># Setup max iterations global variable...</span>
  137     <span class="n">Psi4Util</span><span class="o">.</span><span class="n">UpdatePsi4OptionsParameters</span><span class="p">(</span><span class="n">Psi4Handle</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;GEOM_MAXITER&#39;</span><span class="p">:</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;MaxIters&quot;</span><span class="p">]})</span>
  138     
  139     <span class="c1"># Setup conversion factor for energy units...</span>
  140     <span class="n">SetupEnergyConversionFactor</span><span class="p">(</span><span class="n">Psi4Handle</span><span class="p">)</span>
  141     
  142     <span class="n">MolInfoText</span> <span class="o">=</span> <span class="s2">&quot;first molecule&quot;</span>
  143     <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;FirstMolMode&quot;</span><span class="p">]:</span>
  144         <span class="n">MolInfoText</span> <span class="o">=</span> <span class="s2">&quot;all molecules&quot;</span>
  145 
  146     <span class="k">if</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;TorsionMinimize&quot;</span><span class="p">]:</span>
  147         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Performing torsion scan on </span><span class="si">%s</span><span class="s2"> by generating conformation ensembles for specific torsion angles and constrained energy minimization of the ensembles...&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">MolInfoText</span><span class="p">))</span>
  148     <span class="k">else</span><span class="p">:</span>
  149         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Performing torsion scan on </span><span class="si">%s</span><span class="s2"> by skipping generation of conformation ensembles for specific torsion angles and constrained energy minimization of the ensembles...&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">MolInfoText</span><span class="p">))</span>
  150     
  151     <span class="n">SetupTorsionsPatternsInfo</span><span class="p">()</span>
  152     
  153     <span class="p">(</span><span class="n">MolCount</span><span class="p">,</span> <span class="n">ValidMolCount</span><span class="p">,</span> <span class="n">TorsionsMissingCount</span><span class="p">,</span> <span class="n">MinimizationFailedCount</span><span class="p">,</span> <span class="n">TorsionsScanFailedCount</span><span class="p">)</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">5</span>
  154 
  155     <span class="k">for</span> <span class="n">Mol</span> <span class="ow">in</span> <span class="n">Mols</span><span class="p">:</span>
  156         <span class="n">MolCount</span> <span class="o">+=</span> <span class="mi">1</span>
  157 
  158         <span class="k">if</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;FirstMolMode&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">MolCount</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
  159             <span class="n">MolCount</span> <span class="o">-=</span> <span class="mi">1</span>
  160             <span class="k">break</span>
  161         
  162         <span class="k">if</span> <span class="ow">not</span> <span class="n">CheckAndValidateMolecule</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolCount</span><span class="p">):</span>
  163             <span class="k">continue</span>
  164 
  165         <span class="c1"># Setup 2D coordinates for SMILES input file...</span>
  166         <span class="k">if</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;SMILESInfileStatus&quot;</span><span class="p">]:</span>
  167             <span class="n">AllChem</span><span class="o">.</span><span class="n">Compute2DCoords</span><span class="p">(</span><span class="n">Mol</span><span class="p">)</span>
  168         
  169         <span class="n">ValidMolCount</span> <span class="o">+=</span> <span class="mi">1</span>
  170 
  171         <span class="n">Mol</span><span class="p">,</span> <span class="n">MinimizationCalcStatus</span><span class="p">,</span> <span class="n">TorsionsMatchStatus</span><span class="p">,</span> <span class="n">TorsionsScanCalcStatus</span> <span class="o">=</span> <span class="n">PerformMinimizationAndTorsionScan</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolCount</span><span class="p">)</span>
  172         
  173         <span class="k">if</span> <span class="ow">not</span> <span class="n">MinimizationCalcStatus</span><span class="p">:</span>
  174             <span class="n">MinimizationFailedCount</span> <span class="o">+=</span> <span class="mi">1</span>
  175             <span class="k">continue</span>
  176         
  177         <span class="k">if</span> <span class="ow">not</span> <span class="n">TorsionsMatchStatus</span><span class="p">:</span>
  178             <span class="n">TorsionsMissingCount</span> <span class="o">+=</span> <span class="mi">1</span>
  179             <span class="k">continue</span>
  180 
  181         <span class="k">if</span> <span class="ow">not</span> <span class="n">TorsionsScanCalcStatus</span><span class="p">:</span>
  182             <span class="n">TorsionsScanFailedCount</span> <span class="o">+=</span> <span class="mi">1</span>
  183             <span class="k">continue</span>
  184 
  185     <span class="k">return</span> <span class="p">(</span><span class="n">MolCount</span><span class="p">,</span> <span class="n">ValidMolCount</span><span class="p">,</span> <span class="n">MinimizationFailedCount</span><span class="p">,</span> <span class="n">TorsionsMissingCount</span><span class="p">,</span> <span class="n">TorsionsScanFailedCount</span><span class="p">)</span>
  186 
  187 <span class="k">def</span> <span class="nf">ProcessMoleculesUsingMultipleProcesses</span><span class="p">(</span><span class="n">Mols</span><span class="p">):</span>
  188     <span class="sd">&quot;&quot;&quot;Process and minimize molecules using multiprocessing.&quot;&quot;&quot;</span>
  189     
  190     <span class="k">if</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;MPLevelTorsionAnglesMode&quot;</span><span class="p">]:</span>
  191         <span class="k">return</span> <span class="n">ProcessMoleculesUsingMultipleProcessesAtTorsionAnglesLevel</span><span class="p">(</span><span class="n">Mols</span><span class="p">)</span>
  192     <span class="k">elif</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;MPLevelMoleculesMode&quot;</span><span class="p">]:</span>
  193         <span class="k">return</span> <span class="n">ProcessMoleculesUsingMultipleProcessesAtMoleculesLevel</span><span class="p">(</span><span class="n">Mols</span><span class="p">)</span>
  194     <span class="k">else</span><span class="p">:</span>
  195         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintError</span><span class="p">(</span><span class="s2">&quot;The value, </span><span class="si">%s</span><span class="s2">,  option </span><span class="se">\&quot;</span><span class="s2">--mpLevel</span><span class="se">\&quot;</span><span class="s2"> is not supported.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;MPLevel&quot;</span><span class="p">]))</span>
  196         
  197 <span class="k">def</span> <span class="nf">ProcessMoleculesUsingMultipleProcessesAtMoleculesLevel</span><span class="p">(</span><span class="n">Mols</span><span class="p">):</span>
  198     <span class="sd">&quot;&quot;&quot;Process molecules to perform torsion scan using multiprocessing at molecules level.&quot;&quot;&quot;</span>
  199 
  200     <span class="n">MolInfoText</span> <span class="o">=</span> <span class="s2">&quot;first molecule&quot;</span>
  201     <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;FirstMolMode&quot;</span><span class="p">]:</span>
  202         <span class="n">MolInfoText</span> <span class="o">=</span> <span class="s2">&quot;all molecules&quot;</span>
  203 
  204     <span class="k">if</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;TorsionMinimize&quot;</span><span class="p">]:</span>
  205         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Performing torsion scan on </span><span class="si">%s</span><span class="s2"> using multiprocessing at molecules level by generating conformation ensembles for specific torsion angles and constrained energy minimization of the ensembles...&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">MolInfoText</span><span class="p">))</span>
  206     <span class="k">else</span><span class="p">:</span>
  207         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Performing torsion scan </span><span class="si">%s</span><span class="s2"> using multiprocessing at molecules level by skipping generation of conformation ensembles for specific torsion angles and constrained energy minimization of the ensembles...&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">MolInfoText</span><span class="p">))</span>
  208         
  209     <span class="n">MPParams</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;MPParams&quot;</span><span class="p">]</span>
  210     
  211     <span class="c1"># Setup data for initializing a worker process...</span>
  212     <span class="n">InitializeWorkerProcessArgs</span> <span class="o">=</span> <span class="p">(</span><span class="n">MiscUtil</span><span class="o">.</span><span class="n">ObjectToBase64EncodedString</span><span class="p">(</span><span class="n">Options</span><span class="p">),</span> <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ObjectToBase64EncodedString</span><span class="p">(</span><span class="n">OptionsInfo</span><span class="p">))</span>
  213 
  214     <span class="k">if</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;FirstMolMode&quot;</span><span class="p">]:</span>
  215         <span class="n">Mol</span> <span class="o">=</span> <span class="n">Mols</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
  216         <span class="n">Mols</span> <span class="o">=</span> <span class="p">[</span><span class="n">Mol</span><span class="p">]</span>
  217 
  218     <span class="c1"># Setup a encoded mols data iterable for a worker process...</span>
  219     <span class="n">WorkerProcessDataIterable</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">GenerateBase64EncodedMolStrings</span><span class="p">(</span><span class="n">Mols</span><span class="p">)</span>
  220 
  221     <span class="c1"># Setup process pool along with data initialization for each process...</span>
  222     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Configuring multiprocessing using </span><span class="si">%s</span><span class="s2"> method...&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s2">&quot;mp.Pool.imap()&quot;</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^Lazy$&quot;</span><span class="p">,</span> <span class="n">MPParams</span><span class="p">[</span><span class="s2">&quot;InputDataMode&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;mp.Pool.map()&quot;</span><span class="p">))</span>
  223     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;NumProcesses: </span><span class="si">%s</span><span class="s2">; InputDataMode: </span><span class="si">%s</span><span class="s2">; ChunkSize: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">MPParams</span><span class="p">[</span><span class="s2">&quot;NumProcesses&quot;</span><span class="p">],</span> <span class="n">MPParams</span><span class="p">[</span><span class="s2">&quot;InputDataMode&quot;</span><span class="p">],</span> <span class="p">(</span><span class="s2">&quot;automatic&quot;</span> <span class="k">if</span> <span class="n">MPParams</span><span class="p">[</span><span class="s2">&quot;ChunkSize&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">MPParams</span><span class="p">[</span><span class="s2">&quot;ChunkSize&quot;</span><span class="p">])))</span>
  224     
  225     <span class="n">ProcessPool</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">MPParams</span><span class="p">[</span><span class="s2">&quot;NumProcesses&quot;</span><span class="p">],</span> <span class="n">InitializeWorkerProcess</span><span class="p">,</span> <span class="n">InitializeWorkerProcessArgs</span><span class="p">)</span>
  226     
  227     <span class="c1"># Start processing...</span>
  228     <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^Lazy$&quot;</span><span class="p">,</span> <span class="n">MPParams</span><span class="p">[</span><span class="s2">&quot;InputDataMode&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
  229         <span class="n">Results</span> <span class="o">=</span> <span class="n">ProcessPool</span><span class="o">.</span><span class="n">imap</span><span class="p">(</span><span class="n">WorkerProcess</span><span class="p">,</span> <span class="n">WorkerProcessDataIterable</span><span class="p">,</span> <span class="n">MPParams</span><span class="p">[</span><span class="s2">&quot;ChunkSize&quot;</span><span class="p">])</span>
  230     <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^InMemory$&quot;</span><span class="p">,</span> <span class="n">MPParams</span><span class="p">[</span><span class="s2">&quot;InputDataMode&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
  231         <span class="n">Results</span> <span class="o">=</span> <span class="n">ProcessPool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">WorkerProcess</span><span class="p">,</span> <span class="n">WorkerProcessDataIterable</span><span class="p">,</span> <span class="n">MPParams</span><span class="p">[</span><span class="s2">&quot;ChunkSize&quot;</span><span class="p">])</span>
  232     <span class="k">else</span><span class="p">:</span>
  233         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintError</span><span class="p">(</span><span class="s2">&quot;The value, </span><span class="si">%s</span><span class="s2">, specified for </span><span class="se">\&quot;</span><span class="s2">--inputDataMode</span><span class="se">\&quot;</span><span class="s2"> is not supported.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">MPParams</span><span class="p">[</span><span class="s2">&quot;InputDataMode&quot;</span><span class="p">]))</span>
  234 
  235     <span class="p">(</span><span class="n">MolCount</span><span class="p">,</span> <span class="n">ValidMolCount</span><span class="p">,</span> <span class="n">TorsionsMissingCount</span><span class="p">,</span> <span class="n">MinimizationFailedCount</span><span class="p">,</span> <span class="n">TorsionsScanFailedCount</span><span class="p">)</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">5</span>
  236     
  237     <span class="k">for</span> <span class="n">Result</span> <span class="ow">in</span> <span class="n">Results</span><span class="p">:</span>
  238         <span class="n">MolCount</span> <span class="o">+=</span> <span class="mi">1</span>
  239         
  240         <span class="n">MolIndex</span><span class="p">,</span> <span class="n">EncodedMol</span><span class="p">,</span> <span class="n">MinimizationCalcStatus</span><span class="p">,</span> <span class="n">TorsionsMatchStatus</span><span class="p">,</span> <span class="n">TorsionsScanCalcStatus</span> <span class="o">=</span> <span class="n">Result</span>
  241         
  242         <span class="k">if</span> <span class="n">EncodedMol</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
  243             <span class="k">continue</span>
  244         <span class="n">ValidMolCount</span> <span class="o">+=</span> <span class="mi">1</span>
  245     
  246         <span class="k">if</span> <span class="ow">not</span> <span class="n">MinimizationCalcStatus</span><span class="p">:</span>
  247             <span class="n">MinimizationFailedCount</span> <span class="o">+=</span> <span class="mi">1</span>
  248             <span class="k">continue</span>
  249         
  250         <span class="k">if</span> <span class="ow">not</span> <span class="n">TorsionsMatchStatus</span><span class="p">:</span>
  251             <span class="n">TorsionsMissingCount</span> <span class="o">+=</span> <span class="mi">1</span>
  252             <span class="k">continue</span>
  253 
  254         <span class="k">if</span> <span class="ow">not</span> <span class="n">TorsionsScanCalcStatus</span><span class="p">:</span>
  255             <span class="n">TorsionsScanFailedCount</span> <span class="o">+=</span> <span class="mi">1</span>
  256             <span class="k">continue</span>
  257         
  258         <span class="n">Mol</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">MolFromBase64EncodedMolString</span><span class="p">(</span><span class="n">EncodedMol</span><span class="p">)</span>
  259         
  260     <span class="k">return</span> <span class="p">(</span><span class="n">MolCount</span><span class="p">,</span> <span class="n">ValidMolCount</span><span class="p">,</span> <span class="n">MinimizationFailedCount</span><span class="p">,</span> <span class="n">TorsionsMissingCount</span><span class="p">,</span> <span class="n">TorsionsScanFailedCount</span><span class="p">)</span>
  261     
  262 <span class="k">def</span> <span class="nf">InitializeWorkerProcess</span><span class="p">(</span><span class="o">*</span><span class="n">EncodedArgs</span><span class="p">):</span>
  263     <span class="sd">&quot;&quot;&quot;Initialize data for a worker process.&quot;&quot;&quot;</span>
  264     
  265     <span class="k">global</span> <span class="n">Options</span><span class="p">,</span> <span class="n">OptionsInfo</span>
  266 
  267     <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]:</span>
  268         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;Starting process (PID: </span><span class="si">%s</span><span class="s2">)...&quot;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">())</span>
  269 
  270     <span class="c1"># Decode Options and OptionInfo...</span>
  271     <span class="n">Options</span> <span class="o">=</span> <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ObjectFromBase64EncodedString</span><span class="p">(</span><span class="n">EncodedArgs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
  272     <span class="n">OptionsInfo</span> <span class="o">=</span> <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ObjectFromBase64EncodedString</span><span class="p">(</span><span class="n">EncodedArgs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
  273 
  274     <span class="c1"># Initialize torsion patterns info...</span>
  275     <span class="n">SetupTorsionsPatternsInfo</span><span class="p">()</span>
  276     
  277     <span class="c1"># Psi4 is initialized in the worker process to avoid creation of redundant Psi4</span>
  278     <span class="c1"># output files for each process...</span>
  279     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Psi4Initialized&quot;</span><span class="p">]</span>  <span class="o">=</span> <span class="bp">False</span>
  280 
  281 <span class="k">def</span> <span class="nf">WorkerProcess</span><span class="p">(</span><span class="n">EncodedMolInfo</span><span class="p">):</span>
  282     <span class="sd">&quot;&quot;&quot;Process data for a worker process.&quot;&quot;&quot;</span>
  283 
  284     <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Psi4Initialized&quot;</span><span class="p">]:</span>
  285         <span class="n">InitializePsi4ForWorkerProcess</span><span class="p">()</span>
  286     
  287     <span class="n">MolIndex</span><span class="p">,</span> <span class="n">EncodedMol</span> <span class="o">=</span> <span class="n">EncodedMolInfo</span>
  288 
  289     <span class="n">MolNum</span> <span class="o">=</span> <span class="n">MolIndex</span> <span class="o">+</span> <span class="mi">1</span>
  290     <span class="p">(</span><span class="n">MinimizationCalcStatus</span><span class="p">,</span> <span class="n">TorsionsMatchStatus</span><span class="p">,</span> <span class="n">TorsionsScanCalcStatus</span><span class="p">)</span> <span class="o">=</span> <span class="p">[</span><span class="bp">False</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span>
  291     
  292     <span class="k">if</span> <span class="n">EncodedMol</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
  293         <span class="k">return</span> <span class="p">[</span><span class="n">MolIndex</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">MinimizationCalcStatus</span><span class="p">,</span> <span class="n">TorsionsMatchStatus</span><span class="p">,</span> <span class="n">TorsionsScanCalcStatus</span><span class="p">]</span>
  294     
  295     <span class="n">Mol</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">MolFromBase64EncodedMolString</span><span class="p">(</span><span class="n">EncodedMol</span><span class="p">)</span>
  296     <span class="k">if</span> <span class="ow">not</span> <span class="n">CheckAndValidateMolecule</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">):</span>
  297         <span class="k">return</span> <span class="p">[</span><span class="n">MolIndex</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">MinimizationCalcStatus</span><span class="p">,</span> <span class="n">TorsionsMatchStatus</span><span class="p">,</span> <span class="n">TorsionsScanCalcStatus</span><span class="p">]</span>
  298     
  299     <span class="c1"># Setup 2D coordinates for SMILES input file...</span>
  300     <span class="k">if</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;SMILESInfileStatus&quot;</span><span class="p">]:</span>
  301         <span class="n">AllChem</span><span class="o">.</span><span class="n">Compute2DCoords</span><span class="p">(</span><span class="n">Mol</span><span class="p">)</span>
  302     
  303     <span class="n">Mol</span><span class="p">,</span> <span class="n">MinimizationCalcStatus</span><span class="p">,</span> <span class="n">TorsionsMatchStatus</span><span class="p">,</span> <span class="n">TorsionsScanCalcStatus</span> <span class="o">=</span> <span class="n">PerformMinimizationAndTorsionScan</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">)</span>
  304     
  305     <span class="k">return</span> <span class="p">[</span><span class="n">MolIndex</span><span class="p">,</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">MolToBase64EncodedMolString</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">PropertyPickleFlags</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">PropertyPickleOptions</span><span class="o">.</span><span class="n">MolProps</span> <span class="o">|</span> <span class="n">Chem</span><span class="o">.</span><span class="n">PropertyPickleOptions</span><span class="o">.</span><span class="n">PrivateProps</span><span class="p">),</span> <span class="n">MinimizationCalcStatus</span><span class="p">,</span> <span class="n">TorsionsMatchStatus</span><span class="p">,</span> <span class="n">TorsionsScanCalcStatus</span><span class="p">]</span>
  306 
  307 <span class="k">def</span> <span class="nf">ProcessMoleculesUsingMultipleProcessesAtTorsionAnglesLevel</span><span class="p">(</span><span class="n">Mols</span><span class="p">):</span>
  308     <span class="sd">&quot;&quot;&quot;Process molecules to perform torsion scan using multiprocessing at torsion angles level.&quot;&quot;&quot;</span>
  309 
  310     <span class="n">MolInfoText</span> <span class="o">=</span> <span class="s2">&quot;first molecule&quot;</span>
  311     <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;FirstMolMode&quot;</span><span class="p">]:</span>
  312         <span class="n">MolInfoText</span> <span class="o">=</span> <span class="s2">&quot;all molecules&quot;</span>
  313 
  314     <span class="k">if</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;TorsionMinimize&quot;</span><span class="p">]:</span>
  315         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Performing torsion scan on </span><span class="si">%s</span><span class="s2"> using multiprocessing at torsion angles level by generating conformation ensembles for specific torsion angles and constrained energy minimization of the ensembles...&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">MolInfoText</span><span class="p">))</span>
  316     <span class="k">else</span><span class="p">:</span>
  317         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Performing torsion scan </span><span class="si">%s</span><span class="s2"> using multiprocessing at torsion angles level by skipping generation of conformation ensembles for specific torsion angles and constrained energy minimization of the ensembles...&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">MolInfoText</span><span class="p">))</span>
  318     
  319     <span class="n">SetupTorsionsPatternsInfo</span><span class="p">()</span>
  320     
  321     <span class="p">(</span><span class="n">MolCount</span><span class="p">,</span> <span class="n">ValidMolCount</span><span class="p">,</span> <span class="n">TorsionsMissingCount</span><span class="p">,</span> <span class="n">MinimizationFailedCount</span><span class="p">,</span> <span class="n">TorsionsScanFailedCount</span><span class="p">)</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">5</span>
  322 
  323     <span class="k">for</span> <span class="n">Mol</span> <span class="ow">in</span> <span class="n">Mols</span><span class="p">:</span>
  324         <span class="n">MolCount</span> <span class="o">+=</span> <span class="mi">1</span>
  325 
  326         <span class="k">if</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;FirstMolMode&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">MolCount</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
  327             <span class="n">MolCount</span> <span class="o">-=</span> <span class="mi">1</span>
  328             <span class="k">break</span>
  329         
  330         <span class="k">if</span> <span class="ow">not</span> <span class="n">CheckAndValidateMolecule</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolCount</span><span class="p">):</span>
  331             <span class="k">continue</span>
  332 
  333         <span class="c1"># Setup 2D coordinates for SMILES input file...</span>
  334         <span class="k">if</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;SMILESInfileStatus&quot;</span><span class="p">]:</span>
  335             <span class="n">AllChem</span><span class="o">.</span><span class="n">Compute2DCoords</span><span class="p">(</span><span class="n">Mol</span><span class="p">)</span>
  336         
  337         <span class="n">ValidMolCount</span> <span class="o">+=</span> <span class="mi">1</span>
  338 
  339         <span class="n">Mol</span><span class="p">,</span> <span class="n">MinimizationCalcStatus</span><span class="p">,</span> <span class="n">TorsionsMatchStatus</span><span class="p">,</span> <span class="n">TorsionsScanCalcStatus</span> <span class="o">=</span> <span class="n">PerformMinimizationAndTorsionScan</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolCount</span><span class="p">,</span> <span class="n">UseMultiProcessingAtTorsionAnglesLevel</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
  340         
  341         <span class="k">if</span> <span class="ow">not</span> <span class="n">MinimizationCalcStatus</span><span class="p">:</span>
  342             <span class="n">MinimizationFailedCount</span> <span class="o">+=</span> <span class="mi">1</span>
  343             <span class="k">continue</span>
  344         
  345         <span class="k">if</span> <span class="ow">not</span> <span class="n">TorsionsMatchStatus</span><span class="p">:</span>
  346             <span class="n">TorsionsMissingCount</span> <span class="o">+=</span> <span class="mi">1</span>
  347             <span class="k">continue</span>
  348 
  349         <span class="k">if</span> <span class="ow">not</span> <span class="n">TorsionsScanCalcStatus</span><span class="p">:</span>
  350             <span class="n">TorsionsScanFailedCount</span> <span class="o">+=</span> <span class="mi">1</span>
  351             <span class="k">continue</span>
  352 
  353     <span class="k">return</span> <span class="p">(</span><span class="n">MolCount</span><span class="p">,</span> <span class="n">ValidMolCount</span><span class="p">,</span> <span class="n">MinimizationFailedCount</span><span class="p">,</span> <span class="n">TorsionsMissingCount</span><span class="p">,</span> <span class="n">TorsionsScanFailedCount</span><span class="p">)</span>
  354 
  355 <span class="k">def</span> <span class="nf">ScanSingleTorsionInMolUsingMultipleProcessesAtTorsionAnglesLevel</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">TorsionID</span><span class="p">,</span> <span class="n">TorsionPattern</span><span class="p">,</span> <span class="n">TorsionPatternMol</span><span class="p">,</span> <span class="n">TorsionMatches</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">):</span>
  356     <span class="sd">&quot;&quot;&quot;Perform torsion scan for a molecule using multiple processses at torsion angles</span>
  357 <span class="sd">    level along with constrained energy minimization.</span>
  358 <span class="sd">    &quot;&quot;&quot;</span>
  359     
  360     <span class="k">if</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;MPLevelMoleculesMode&quot;</span><span class="p">]:</span>
  361         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintError</span><span class="p">(</span><span class="s2">&quot;Single torison scanning for a molecule is not allowed in multiprocessing mode at molecules level.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
  362 
  363     <span class="n">Mols</span><span class="p">,</span> <span class="n">Angles</span> <span class="o">=</span> <span class="n">SetupMolsForSingleTorsionScanInMol</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">TorsionMatches</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">)</span>
  364 
  365     <span class="n">MPParams</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;MPParams&quot;</span><span class="p">]</span>
  366     
  367     <span class="c1"># Setup data for initializing a worker process...</span>
  368     
  369     <span class="c1"># Track and avoid encoding TorsionsPatternsInfo as it contains RDKit molecule object...</span>
  370     <span class="n">TorsionsPatternsInfo</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;TorsionsPatternsInfo&quot;</span><span class="p">]</span>
  371     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;TorsionsPatternsInfo&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
  372     
  373     <span class="n">InitializeWorkerProcessArgs</span> <span class="o">=</span> <span class="p">(</span><span class="n">MiscUtil</span><span class="o">.</span><span class="n">ObjectToBase64EncodedString</span><span class="p">(</span><span class="n">Options</span><span class="p">),</span> <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ObjectToBase64EncodedString</span><span class="p">(</span><span class="n">OptionsInfo</span><span class="p">))</span>
  374     
  375     <span class="c1"># Restore TorsionsPatternsInfo...</span>
  376     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;TorsionsPatternsInfo&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">TorsionsPatternsInfo</span>
  377 
  378     <span class="c1"># Setup a encoded mols data iterable for a worker process...</span>
  379     <span class="n">WorkerProcessDataIterable</span> <span class="o">=</span> <span class="n">GenerateBase64EncodedMolStringsWithTorsionScanInfo</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="p">(</span><span class="n">MolNum</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">Mols</span><span class="p">,</span> <span class="n">Angles</span><span class="p">,</span> <span class="n">TorsionID</span><span class="p">,</span> <span class="n">TorsionPattern</span><span class="p">,</span> <span class="n">TorsionPatternMol</span><span class="p">,</span> <span class="n">TorsionMatches</span><span class="p">)</span>
  380     
  381     <span class="c1"># Setup process pool along with data initialization for each process...</span>
  382     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Configuring multiprocessing using </span><span class="si">%s</span><span class="s2"> method...&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s2">&quot;mp.Pool.imap()&quot;</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^Lazy$&quot;</span><span class="p">,</span> <span class="n">MPParams</span><span class="p">[</span><span class="s2">&quot;InputDataMode&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;mp.Pool.map()&quot;</span><span class="p">))</span>
  383     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;NumProcesses: </span><span class="si">%s</span><span class="s2">; InputDataMode: </span><span class="si">%s</span><span class="s2">; ChunkSize: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">MPParams</span><span class="p">[</span><span class="s2">&quot;NumProcesses&quot;</span><span class="p">],</span> <span class="n">MPParams</span><span class="p">[</span><span class="s2">&quot;InputDataMode&quot;</span><span class="p">],</span> <span class="p">(</span><span class="s2">&quot;automatic&quot;</span> <span class="k">if</span> <span class="n">MPParams</span><span class="p">[</span><span class="s2">&quot;ChunkSize&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">MPParams</span><span class="p">[</span><span class="s2">&quot;ChunkSize&quot;</span><span class="p">])))</span>
  384     
  385     <span class="n">ProcessPool</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">MPParams</span><span class="p">[</span><span class="s2">&quot;NumProcesses&quot;</span><span class="p">],</span> <span class="n">InitializeTorsionAngleWorkerProcess</span><span class="p">,</span> <span class="n">InitializeWorkerProcessArgs</span><span class="p">)</span>
  386     
  387     <span class="c1"># Start processing...</span>
  388     <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^Lazy$&quot;</span><span class="p">,</span> <span class="n">MPParams</span><span class="p">[</span><span class="s2">&quot;InputDataMode&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
  389         <span class="n">Results</span> <span class="o">=</span> <span class="n">ProcessPool</span><span class="o">.</span><span class="n">imap</span><span class="p">(</span><span class="n">TorsionAngleWorkerProcess</span><span class="p">,</span> <span class="n">WorkerProcessDataIterable</span><span class="p">,</span> <span class="n">MPParams</span><span class="p">[</span><span class="s2">&quot;ChunkSize&quot;</span><span class="p">])</span>
  390     <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^InMemory$&quot;</span><span class="p">,</span> <span class="n">MPParams</span><span class="p">[</span><span class="s2">&quot;InputDataMode&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
  391         <span class="n">Results</span> <span class="o">=</span> <span class="n">ProcessPool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">TorsionAngleWorkerProcess</span><span class="p">,</span> <span class="n">WorkerProcessDataIterable</span><span class="p">,</span> <span class="n">MPParams</span><span class="p">[</span><span class="s2">&quot;ChunkSize&quot;</span><span class="p">])</span>
  392     <span class="k">else</span><span class="p">:</span>
  393         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintError</span><span class="p">(</span><span class="s2">&quot;The value, </span><span class="si">%s</span><span class="s2">, specified for </span><span class="se">\&quot;</span><span class="s2">--inputDataMode</span><span class="se">\&quot;</span><span class="s2"> is not supported.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">MPParams</span><span class="p">[</span><span class="s2">&quot;InputDataMode&quot;</span><span class="p">]))</span>
  394 
  395     <span class="n">TorsionMols</span> <span class="o">=</span> <span class="p">[]</span>
  396     <span class="n">TorsionEnergies</span> <span class="o">=</span> <span class="p">[]</span>
  397     <span class="n">TorsionAngles</span> <span class="o">=</span> <span class="p">[]</span>
  398     
  399     <span class="k">for</span> <span class="n">Result</span> <span class="ow">in</span> <span class="n">Results</span><span class="p">:</span>
  400         <span class="n">EncodedTorsionMol</span><span class="p">,</span> <span class="n">CalcStatus</span><span class="p">,</span> <span class="n">Angle</span><span class="p">,</span> <span class="n">Energy</span> <span class="o">=</span> <span class="n">Result</span>
  401         
  402         <span class="k">if</span> <span class="ow">not</span> <span class="n">CalcStatus</span><span class="p">:</span>
  403             <span class="k">return</span> <span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
  404 
  405         <span class="k">if</span> <span class="n">EncodedTorsionMol</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
  406             <span class="k">return</span> <span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
  407         <span class="n">TorsionMol</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">MolFromBase64EncodedMolString</span><span class="p">(</span><span class="n">EncodedTorsionMol</span><span class="p">)</span>
  408         
  409         <span class="n">TorsionMols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TorsionMol</span><span class="p">)</span>
  410         <span class="n">TorsionEnergies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Energy</span><span class="p">)</span>
  411         <span class="n">TorsionAngles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Angle</span><span class="p">)</span>
  412     
  413     <span class="k">return</span> <span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="n">TorsionMols</span><span class="p">,</span> <span class="n">TorsionEnergies</span><span class="p">,</span> <span class="n">TorsionAngles</span><span class="p">)</span>
  414 
  415 <span class="k">def</span> <span class="nf">InitializeTorsionAngleWorkerProcess</span><span class="p">(</span><span class="o">*</span><span class="n">EncodedArgs</span><span class="p">):</span>
  416     <span class="sd">&quot;&quot;&quot;Initialize data for a worker process.&quot;&quot;&quot;</span>
  417     
  418     <span class="k">global</span> <span class="n">Options</span><span class="p">,</span> <span class="n">OptionsInfo</span>
  419 
  420     <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]:</span>
  421         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;Starting process (PID: </span><span class="si">%s</span><span class="s2">)...&quot;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">())</span>
  422 
  423     <span class="c1"># Decode Options and OptionInfo...</span>
  424     <span class="n">Options</span> <span class="o">=</span> <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ObjectFromBase64EncodedString</span><span class="p">(</span><span class="n">EncodedArgs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
  425     <span class="n">OptionsInfo</span> <span class="o">=</span> <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ObjectFromBase64EncodedString</span><span class="p">(</span><span class="n">EncodedArgs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
  426 
  427     <span class="c1"># Initialize torsion patterns info...</span>
  428     <span class="n">SetupTorsionsPatternsInfo</span><span class="p">()</span>
  429     
  430     <span class="c1"># Psi4 is initialized in the worker process to avoid creation of redundant Psi4</span>
  431     <span class="c1"># output files for each process...</span>
  432     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Psi4Initialized&quot;</span><span class="p">]</span>  <span class="o">=</span> <span class="bp">False</span>
  433 
  434 <span class="k">def</span> <span class="nf">TorsionAngleWorkerProcess</span><span class="p">(</span><span class="n">EncodedMolInfo</span><span class="p">):</span>
  435     <span class="sd">&quot;&quot;&quot;Process data for a worker process.&quot;&quot;&quot;</span>
  436 
  437     <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Psi4Initialized&quot;</span><span class="p">]:</span>
  438         <span class="n">InitializePsi4ForWorkerProcess</span><span class="p">()</span>
  439     
  440     <span class="n">MolIndex</span><span class="p">,</span> <span class="n">EncodedMol</span><span class="p">,</span> <span class="n">EncodedTorsionMol</span><span class="p">,</span> <span class="n">TorsionAngle</span><span class="p">,</span> <span class="n">TorsionID</span><span class="p">,</span> <span class="n">TorsionPattern</span><span class="p">,</span> <span class="n">EncodedTorsionPatternMol</span><span class="p">,</span> <span class="n">TorsionMatches</span> <span class="o">=</span> <span class="n">EncodedMolInfo</span>
  441 
  442     <span class="k">if</span> <span class="n">EncodedMol</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">EncodedTorsionMol</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">EncodedTorsionPatternMol</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
  443         <span class="k">return</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
  444     
  445     <span class="n">Mol</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">MolFromBase64EncodedMolString</span><span class="p">(</span><span class="n">EncodedMol</span><span class="p">)</span>
  446     <span class="n">TorsionMol</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">MolFromBase64EncodedMolString</span><span class="p">(</span><span class="n">EncodedTorsionMol</span><span class="p">)</span>
  447     <span class="n">TorsionPatternMol</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">MolFromBase64EncodedMolString</span><span class="p">(</span><span class="n">EncodedTorsionPatternMol</span><span class="p">)</span>
  448     
  449     <span class="n">TorsionMol</span><span class="p">,</span> <span class="n">CalcStatus</span><span class="p">,</span> <span class="n">Energy</span> <span class="o">=</span> <span class="n">MinimizeCalculateEnergyForTorsionMol</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">TorsionMol</span><span class="p">,</span> <span class="n">TorsionAngle</span><span class="p">,</span> <span class="n">TorsionID</span><span class="p">,</span> <span class="n">TorsionPattern</span><span class="p">,</span> <span class="n">TorsionPatternMol</span><span class="p">,</span> <span class="n">TorsionMatches</span><span class="p">,</span> <span class="p">(</span><span class="n">MolIndex</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
  450 
  451     <span class="k">return</span> <span class="p">(</span><span class="n">RDKitUtil</span><span class="o">.</span><span class="n">MolToBase64EncodedMolString</span><span class="p">(</span><span class="n">TorsionMol</span><span class="p">,</span> <span class="n">PropertyPickleFlags</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">PropertyPickleOptions</span><span class="o">.</span><span class="n">MolProps</span> <span class="o">|</span> <span class="n">Chem</span><span class="o">.</span><span class="n">PropertyPickleOptions</span><span class="o">.</span><span class="n">PrivateProps</span><span class="p">),</span> <span class="n">CalcStatus</span><span class="p">,</span> <span class="n">TorsionAngle</span><span class="p">,</span> <span class="n">Energy</span><span class="p">)</span>
  452 
  453 <span class="k">def</span> <span class="nf">GenerateBase64EncodedMolStringsWithTorsionScanInfo</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolIndex</span><span class="p">,</span> <span class="n">TorsionMols</span><span class="p">,</span> <span class="n">TorsionAngles</span><span class="p">,</span> <span class="n">TorsionID</span><span class="p">,</span> <span class="n">TorsionPattern</span><span class="p">,</span> <span class="n">TorsionPatternMol</span><span class="p">,</span> <span class="n">TorsionMatches</span><span class="p">,</span> <span class="n">PropertyPickleFlags</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">PropertyPickleOptions</span><span class="o">.</span><span class="n">AllProps</span><span class="p">):</span>
  454     <span class="sd">&quot;&quot;&quot;Set up an iterator for generating base64 encoded molecule string for</span>
  455 <span class="sd">    a torsion in a molecule along with appropriate trosion scan information.</span>
  456 <span class="sd">    &quot;&quot;&quot;</span>
  457     
  458     <span class="k">for</span> <span class="n">Index</span><span class="p">,</span> <span class="n">TorsionMol</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">TorsionMols</span><span class="p">):</span>
  459         <span class="k">yield</span> <span class="p">[</span><span class="n">MolIndex</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">TorsionAngles</span><span class="p">[</span><span class="n">Index</span><span class="p">],</span> <span class="n">TorsionID</span><span class="p">,</span> <span class="n">TorsionPattern</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">TorsionMatches</span><span class="p">]</span> <span class="k">if</span> <span class="p">(</span><span class="n">Mol</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">TorsionMol</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">MolIndex</span><span class="p">,</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">MolToBase64EncodedMolString</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">PropertyPickleFlags</span><span class="p">),</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">MolToBase64EncodedMolString</span><span class="p">(</span><span class="n">TorsionMol</span><span class="p">,</span> <span class="n">PropertyPickleFlags</span><span class="p">),</span> <span class="n">TorsionAngles</span><span class="p">[</span><span class="n">Index</span><span class="p">],</span> <span class="n">TorsionID</span><span class="p">,</span> <span class="n">TorsionPattern</span><span class="p">,</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">MolToBase64EncodedMolString</span><span class="p">(</span><span class="n">TorsionPatternMol</span><span class="p">,</span> <span class="n">PropertyPickleFlags</span><span class="p">),</span> <span class="n">TorsionMatches</span><span class="p">]</span>
  460 
  461 <span class="k">def</span> <span class="nf">InitializePsi4ForWorkerProcess</span><span class="p">():</span>
  462     <span class="sd">&quot;&quot;&quot;Initialize Psi4 for a worker process.&quot;&quot;&quot;</span>
  463     
  464     <span class="k">if</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Psi4Initialized&quot;</span><span class="p">]:</span>
  465         <span class="k">return</span>
  466 
  467     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Psi4Initialized&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
  468 
  469     <span class="k">if</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;MPLevelTorsionAnglesMode&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Psi4RunParams&quot;</span><span class="p">][</span><span class="s2">&quot;OutputFileSpecified&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
  470         <span class="c1"># Run Psi4 in quiet mode during multiprocessing at Torsions level for &#39;auto&#39; OutputFile...</span>
  471         <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Psi4RunParams&quot;</span><span class="p">][</span><span class="s2">&quot;OutputFile&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;quiet&quot;</span>
  472     <span class="k">else</span><span class="p">:</span>
  473         <span class="c1"># Update output file...</span>
  474         <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Psi4RunParams&quot;</span><span class="p">][</span><span class="s2">&quot;OutputFile&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Psi4Util</span><span class="o">.</span><span class="n">UpdatePsi4OutputFileUsingPID</span><span class="p">(</span><span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Psi4RunParams&quot;</span><span class="p">][</span><span class="s2">&quot;OutputFile&quot;</span><span class="p">],</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">())</span>
  475             
  476     <span class="c1"># Intialize Psi4...</span>
  477     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;psi4&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Psi4Util</span><span class="o">.</span><span class="n">InitializePsi4</span><span class="p">(</span><span class="n">Psi4RunParams</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Psi4RunParams&quot;</span><span class="p">],</span> <span class="n">Psi4OptionsParams</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Psi4OptionsParams&quot;</span><span class="p">],</span> <span class="n">PrintVersion</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> <span class="n">PrintHeader</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
  478     
  479     <span class="c1"># Setup max iterations global variable...</span>
  480     <span class="n">Psi4Util</span><span class="o">.</span><span class="n">UpdatePsi4OptionsParameters</span><span class="p">(</span><span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;psi4&quot;</span><span class="p">],</span> <span class="p">{</span><span class="s1">&#39;GEOM_MAXITER&#39;</span><span class="p">:</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;MaxIters&quot;</span><span class="p">]})</span>
  481     
  482     <span class="c1"># Setup conversion factor for energy units...</span>
  483     <span class="n">SetupEnergyConversionFactor</span><span class="p">(</span><span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;psi4&quot;</span><span class="p">])</span>
  484 
  485 <span class="k">def</span> <span class="nf">PerformMinimizationAndTorsionScan</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">,</span> <span class="n">UseMultiProcessingAtTorsionAnglesLevel</span> <span class="o">=</span> <span class="bp">False</span><span class="p">):</span>
  486     <span class="sd">&quot;&quot;&quot;Perform minimization and torsions scan.&quot;&quot;&quot;</span>
  487 
  488     <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Infile3D&quot;</span><span class="p">]:</span>
  489         <span class="c1"># Add hydrogens...</span>
  490         <span class="n">Mol</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">AddHs</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">addCoords</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
  491 
  492         <span class="n">Mol</span><span class="p">,</span> <span class="n">MinimizationCalcStatus</span> <span class="o">=</span> <span class="n">MinimizeMolecule</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">)</span>
  493         <span class="k">if</span> <span class="ow">not</span> <span class="n">MinimizationCalcStatus</span><span class="p">:</span>
  494             <span class="k">return</span> <span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
  495         
  496     <span class="n">TorsionsMolInfo</span> <span class="o">=</span> <span class="n">SetupTorsionsMolInfo</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">)</span>
  497     <span class="k">if</span> <span class="n">TorsionsMolInfo</span><span class="p">[</span><span class="s2">&quot;NumOfMatches&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
  498         <span class="k">return</span> <span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
  499     
  500     <span class="n">Mol</span><span class="p">,</span> <span class="n">ScanCalcStatus</span> <span class="o">=</span> <span class="n">ScanAllTorsionsInMol</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">TorsionsMolInfo</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">,</span> <span class="n">UseMultiProcessingAtTorsionAnglesLevel</span><span class="p">)</span>
  501     <span class="k">if</span> <span class="ow">not</span> <span class="n">ScanCalcStatus</span><span class="p">:</span>
  502         <span class="k">return</span> <span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
  503     
  504     <span class="k">return</span> <span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
  505 
  506 <span class="k">def</span> <span class="nf">ScanAllTorsionsInMol</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">TorsionsMolInfo</span><span class="p">,</span>  <span class="n">MolNum</span><span class="p">,</span> <span class="n">UseMultiProcessingAtTorsionAnglesLevel</span> <span class="o">=</span> <span class="bp">False</span><span class="p">):</span>
  507     <span class="sd">&quot;&quot;&quot;Perform scans on all torsions in a molecule.&quot;&quot;&quot;</span>
  508 
  509     <span class="k">if</span> <span class="n">TorsionsMolInfo</span><span class="p">[</span><span class="s2">&quot;NumOfMatches&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
  510         <span class="k">return</span> <span class="n">Mol</span><span class="p">,</span> <span class="bp">True</span>
  511 
  512     <span class="n">MolName</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">GetMolName</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">)</span>
  513     
  514     <span class="n">FirstTorsionMode</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;FirstTorsionMode&quot;</span><span class="p">]</span>
  515     <span class="n">TorsionsPatternsInfo</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;TorsionsPatternsInfo&quot;</span><span class="p">]</span>
  516 
  517     <span class="n">TorsionPatternCount</span><span class="p">,</span> <span class="n">TorsionScanCount</span><span class="p">,</span> <span class="n">TorsionMatchCount</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span>
  518     <span class="n">TorsionMaxMatches</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;TorsionMaxMatches&quot;</span><span class="p">]</span>
  519     
  520     <span class="k">for</span> <span class="n">TorsionID</span> <span class="ow">in</span> <span class="n">TorsionsPatternsInfo</span><span class="p">[</span><span class="s2">&quot;IDs&quot;</span><span class="p">]:</span>
  521         <span class="n">TorsionPatternCount</span> <span class="o">+=</span>  <span class="mi">1</span>
  522         <span class="n">TorsionPattern</span> <span class="o">=</span> <span class="n">TorsionsPatternsInfo</span><span class="p">[</span><span class="s2">&quot;Pattern&quot;</span><span class="p">][</span><span class="n">TorsionID</span><span class="p">]</span>
  523         <span class="n">TorsionPatternMol</span> <span class="o">=</span> <span class="n">TorsionsPatternsInfo</span><span class="p">[</span><span class="s2">&quot;Mol&quot;</span><span class="p">][</span><span class="n">TorsionID</span><span class="p">]</span>
  524         
  525         <span class="n">TorsionsMatches</span> <span class="o">=</span> <span class="n">TorsionsMolInfo</span><span class="p">[</span><span class="s2">&quot;Matches&quot;</span><span class="p">][</span><span class="n">TorsionID</span><span class="p">]</span>
  526 
  527         <span class="k">if</span> <span class="n">TorsionsMatches</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
  528             <span class="k">continue</span>
  529         
  530         <span class="k">if</span> <span class="n">FirstTorsionMode</span> <span class="ow">and</span> <span class="n">TorsionPatternCount</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
  531             <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]:</span>
  532                 <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintWarning</span><span class="p">(</span><span class="s2">&quot;Already scaned first torsion pattern, </span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2"> for molecule </span><span class="si">%s</span><span class="s2"> during </span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2"> value of </span><span class="se">\&quot;</span><span class="s2">--modeTorsions</span><span class="se">\&quot;</span><span class="s2"> option . Abandoning torsion scan...</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">TorsionPattern</span><span class="p">,</span> <span class="n">MolName</span><span class="p">,</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;ModeTorsions&quot;</span><span class="p">]))</span>
  533             <span class="k">break</span>
  534 
  535         <span class="k">for</span> <span class="n">Index</span><span class="p">,</span> <span class="n">TorsionMatches</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">TorsionsMatches</span><span class="p">):</span>
  536             <span class="n">TorsionMatchNum</span> <span class="o">=</span> <span class="n">Index</span> <span class="o">+</span> <span class="mi">1</span>
  537             <span class="n">TorsionMatchCount</span> <span class="o">+=</span>  <span class="mi">1</span>
  538 
  539             <span class="k">if</span> <span class="n">TorsionMatchCount</span> <span class="o">&gt;</span> <span class="n">TorsionMaxMatches</span><span class="p">:</span>
  540                 <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]:</span>
  541                     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintWarning</span><span class="p">(</span><span class="s2">&quot;Already scaned a maximum of </span><span class="si">%s</span><span class="s2"> torsion matches for molecule </span><span class="si">%s</span><span class="s2"> specified by </span><span class="se">\&quot;</span><span class="s2">--torsionMaxMatches</span><span class="se">\&quot;</span><span class="s2"> option. Abandoning torsion scan...</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">TorsionMaxMatches</span><span class="p">,</span> <span class="n">MolName</span><span class="p">))</span>
  542                 <span class="k">break</span>
  543 
  544             <span class="n">TmpMol</span><span class="p">,</span> <span class="n">TorsionScanStatus</span><span class="p">,</span>  <span class="n">TorsionMols</span><span class="p">,</span> <span class="n">TorsionEnergies</span><span class="p">,</span> <span class="n">TorsionAngles</span> <span class="o">=</span> <span class="n">ScanSingleTorsionInMol</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">TorsionID</span><span class="p">,</span> <span class="n">TorsionPattern</span><span class="p">,</span> <span class="n">TorsionPatternMol</span><span class="p">,</span> <span class="n">TorsionMatches</span><span class="p">,</span>  <span class="n">TorsionMatchNum</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">,</span> <span class="n">UseMultiProcessingAtTorsionAnglesLevel</span><span class="p">)</span>
  545             <span class="k">if</span> <span class="ow">not</span> <span class="n">TorsionScanStatus</span><span class="p">:</span>
  546                 <span class="k">continue</span>
  547             
  548             <span class="n">TorsionScanCount</span> <span class="o">+=</span>  <span class="mi">1</span>
  549             <span class="n">GenerateOutputFiles</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">,</span> <span class="n">TorsionID</span><span class="p">,</span> <span class="n">TorsionMatchNum</span><span class="p">,</span> <span class="n">TorsionMols</span><span class="p">,</span> <span class="n">TorsionEnergies</span><span class="p">,</span> <span class="n">TorsionAngles</span><span class="p">)</span>
  550         
  551         <span class="k">if</span> <span class="n">TorsionMatchCount</span> <span class="o">&gt;</span> <span class="n">TorsionMaxMatches</span><span class="p">:</span>
  552             <span class="k">break</span>
  553     
  554     <span class="k">if</span> <span class="n">TorsionScanCount</span><span class="p">:</span>
  555         <span class="n">GenerateStartingTorsionScanStructureOutfile</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">)</span>
  556 
  557     <span class="n">Status</span> <span class="o">=</span> <span class="bp">True</span> <span class="k">if</span> <span class="n">TorsionScanCount</span> <span class="k">else</span> <span class="bp">False</span>
  558     
  559     <span class="k">return</span> <span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">Status</span><span class="p">)</span>
  560 
  561 <span class="k">def</span> <span class="nf">ScanSingleTorsionInMol</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">TorsionID</span><span class="p">,</span> <span class="n">TorsionPattern</span><span class="p">,</span> <span class="n">TorsionPatternMol</span><span class="p">,</span> <span class="n">TorsionMatches</span><span class="p">,</span> <span class="n">TorsionMatchNum</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">,</span> <span class="n">UseMultiProcessingAtTorsionAnglesLevel</span><span class="p">):</span>
  562     <span class="sd">&quot;&quot;&quot;Perform torsion scan for a molecule along with constrained energy minimization.&quot;&quot;&quot;</span>
  563     
  564     <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]:</span>
  565         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Processing torsion pattern, </span><span class="si">%s</span><span class="s2">, match number, </span><span class="si">%s</span><span class="s2">, in molecule </span><span class="si">%s</span><span class="s2">...&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">TorsionPattern</span><span class="p">,</span> <span class="n">TorsionMatchNum</span><span class="p">,</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">GetMolName</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">)))</span>
  566         
  567         <span class="k">if</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;TorsionMinimize&quot;</span><span class="p">]:</span>
  568             <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;Generating initial ensemble of constrained conformations by distance geometry and forcefield followed by Psi4 constraned minimization to select the lowest energy structure at specific torsion angles for molecule </span><span class="si">%s</span><span class="s2">...&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">RDKitUtil</span><span class="o">.</span><span class="n">GetMolName</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">)))</span>
  569         <span class="k">else</span><span class="p">:</span>
  570             <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;Calculating single point energy using Psi4 for molecule, </span><span class="si">%s</span><span class="s2">, at specific torsion angles...&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">RDKitUtil</span><span class="o">.</span><span class="n">GetMolName</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">)))</span>
  571     
  572     <span class="k">if</span> <span class="n">UseMultiProcessingAtTorsionAnglesLevel</span><span class="p">:</span>
  573         <span class="k">return</span> <span class="n">ScanSingleTorsionInMolUsingMultipleProcessesAtTorsionAnglesLevel</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">TorsionID</span><span class="p">,</span> <span class="n">TorsionPattern</span><span class="p">,</span> <span class="n">TorsionPatternMol</span><span class="p">,</span> <span class="n">TorsionMatches</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">)</span>
  574     <span class="k">else</span><span class="p">:</span>
  575         <span class="k">return</span> <span class="n">ScanSingleTorsionInMolUsingSingleProcess</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">TorsionID</span><span class="p">,</span> <span class="n">TorsionPattern</span><span class="p">,</span> <span class="n">TorsionPatternMol</span><span class="p">,</span> <span class="n">TorsionMatches</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">)</span>
  576 
  577 <span class="k">def</span> <span class="nf">ScanSingleTorsionInMolUsingSingleProcess</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">TorsionID</span><span class="p">,</span> <span class="n">TorsionPattern</span><span class="p">,</span> <span class="n">TorsionPatternMol</span><span class="p">,</span> <span class="n">TorsionMatches</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">):</span>
  578     <span class="sd">&quot;&quot;&quot;Perform torsion scan for a molecule using single processs along with constrained</span>
  579 <span class="sd">    energy minimization.&quot;&quot;&quot;</span>
  580 
  581     <span class="n">TorsionMols</span> <span class="o">=</span> <span class="p">[]</span>
  582     <span class="n">TorsionEnergies</span> <span class="o">=</span> <span class="p">[]</span>
  583     <span class="n">TorsionAngles</span> <span class="o">=</span> <span class="p">[]</span>
  584 
  585     <span class="n">Mols</span><span class="p">,</span> <span class="n">Angles</span> <span class="o">=</span> <span class="n">SetupMolsForSingleTorsionScanInMol</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">TorsionMatches</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">)</span>
  586     
  587     <span class="k">for</span> <span class="n">Index</span><span class="p">,</span> <span class="n">Angle</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">Angles</span><span class="p">):</span>
  588         <span class="n">TorsionMol</span> <span class="o">=</span> <span class="n">Mols</span><span class="p">[</span><span class="n">Index</span><span class="p">]</span>
  589         <span class="n">TorsionMol</span><span class="p">,</span> <span class="n">CalcStatus</span><span class="p">,</span> <span class="n">Energy</span> <span class="o">=</span> <span class="n">MinimizeCalculateEnergyForTorsionMol</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">TorsionMol</span><span class="p">,</span> <span class="n">Angle</span><span class="p">,</span> <span class="n">TorsionID</span><span class="p">,</span> <span class="n">TorsionPattern</span><span class="p">,</span> <span class="n">TorsionPatternMol</span><span class="p">,</span> <span class="n">TorsionMatches</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">)</span>
  590         
  591         <span class="k">if</span> <span class="ow">not</span> <span class="n">CalcStatus</span><span class="p">:</span>
  592             <span class="k">return</span> <span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
  593         
  594         <span class="n">TorsionMols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TorsionMol</span><span class="p">)</span>
  595         <span class="n">TorsionEnergies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Energy</span><span class="p">)</span>
  596         <span class="n">TorsionAngles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Angle</span><span class="p">)</span>
  597     
  598     <span class="k">return</span> <span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="n">TorsionMols</span><span class="p">,</span> <span class="n">TorsionEnergies</span><span class="p">,</span> <span class="n">TorsionAngles</span><span class="p">)</span>
  599 
  600 <span class="k">def</span> <span class="nf">SetupMolsForSingleTorsionScanInMol</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">TorsionMatches</span><span class="p">,</span> <span class="n">MolNum</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
  601     <span class="sd">&quot;&quot;&quot;Setup molecules corresponding to all torsion angles in a molecule.&quot;&quot;&quot;</span>
  602 
  603     <span class="n">StartAngle</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;TorsionStart&quot;</span><span class="p">]</span>
  604     <span class="n">StopAngle</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;TorsionStop&quot;</span><span class="p">]</span>
  605     <span class="n">StepSize</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;TorsionStep&quot;</span><span class="p">]</span>
  606     
  607     <span class="n">AtomIndex1</span><span class="p">,</span> <span class="n">AtomIndex2</span><span class="p">,</span> <span class="n">AtomIndex3</span><span class="p">,</span> <span class="n">AtomIndex4</span> <span class="o">=</span> <span class="n">TorsionMatches</span>
  608 
  609     <span class="n">TorsionMols</span> <span class="o">=</span> <span class="p">[]</span>
  610     
  611     <span class="n">TorsionAngles</span> <span class="o">=</span> <span class="p">[</span><span class="n">Angle</span> <span class="k">for</span> <span class="n">Angle</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">StartAngle</span><span class="p">,</span> <span class="n">StopAngle</span><span class="p">,</span> <span class="n">StepSize</span><span class="p">)]</span>
  612     <span class="n">TorsionAngles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">StopAngle</span><span class="p">)</span>
  613 
  614     <span class="k">for</span> <span class="n">Angle</span> <span class="ow">in</span> <span class="n">TorsionAngles</span><span class="p">:</span>
  615         <span class="n">TorsionMol</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">Mol</span><span class="p">(</span><span class="n">Mol</span><span class="p">)</span>
  616         <span class="n">TorsionMolConf</span> <span class="o">=</span> <span class="n">TorsionMol</span><span class="o">.</span><span class="n">GetConformer</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
  617         
  618         <span class="n">rdMolTransforms</span><span class="o">.</span><span class="n">SetDihedralDeg</span><span class="p">(</span><span class="n">TorsionMolConf</span><span class="p">,</span> <span class="n">AtomIndex1</span><span class="p">,</span> <span class="n">AtomIndex2</span><span class="p">,</span> <span class="n">AtomIndex3</span><span class="p">,</span> <span class="n">AtomIndex4</span><span class="p">,</span> <span class="n">Angle</span><span class="p">)</span>
  619         <span class="n">TorsionMols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TorsionMol</span><span class="p">)</span>
  620 
  621     <span class="k">return</span> <span class="p">(</span><span class="n">TorsionMols</span><span class="p">,</span> <span class="n">TorsionAngles</span><span class="p">)</span>
  622 
  623 <span class="k">def</span> <span class="nf">MinimizeCalculateEnergyForTorsionMol</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">TorsionMol</span><span class="p">,</span> <span class="n">TorsionAngle</span><span class="p">,</span> <span class="n">TorsionID</span><span class="p">,</span> <span class="n">TorsionPattern</span><span class="p">,</span> <span class="n">TorsionPatternMol</span><span class="p">,</span> <span class="n">TorsionMatches</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">):</span>
  624     <span class="sd">&quot;&quot;&quot;&quot;Calculate energy of a torsion molecule by performing an optional constrained</span>
  625 <span class="sd">    energy minimzation.</span>
  626 <span class="sd">    &quot;&quot;&quot;</span>
  627 
  628     <span class="k">if</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;TorsionMinimize&quot;</span><span class="p">]:</span>
  629         <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]:</span>
  630             <span class="n">MolName</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">GetMolName</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">)</span>
  631             <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Processing torsion angle </span><span class="si">%s</span><span class="s2"> for molecule </span><span class="si">%s</span><span class="s2">...&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">TorsionAngle</span><span class="p">,</span> <span class="n">MolName</span><span class="p">))</span>
  632         
  633         <span class="c1"># Perform constrained minimization...</span>
  634         <span class="n">TorsionMatchesMol</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">MolFromSubstructureMatch</span><span class="p">(</span><span class="n">TorsionMol</span><span class="p">,</span> <span class="n">TorsionPatternMol</span><span class="p">,</span> <span class="n">TorsionMatches</span><span class="p">)</span>
  635         <span class="n">TorsionMol</span><span class="p">,</span> <span class="n">CalcStatus</span><span class="p">,</span> <span class="n">Energy</span> <span class="o">=</span> <span class="n">ConstrainAndMinimizeMolecule</span><span class="p">(</span><span class="n">TorsionMol</span><span class="p">,</span> <span class="n">TorsionAngle</span><span class="p">,</span> <span class="n">TorsionMatchesMol</span><span class="p">,</span> <span class="n">TorsionMatches</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">)</span>
  636         
  637         <span class="k">if</span> <span class="ow">not</span> <span class="n">CalcStatus</span><span class="p">:</span>
  638             <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]:</span>
  639                 <span class="n">MolName</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">GetMolName</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">)</span>
  640                 <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintWarning</span><span class="p">(</span><span class="s2">&quot;Failed to perform constrained minimization for molecule </span><span class="si">%s</span><span class="s2"> with torsion angle set to </span><span class="si">%s</span><span class="s2"> during torsion scan for torsion pattern </span><span class="si">%s</span><span class="s2">. Abandoning torsion scan...&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">MolName</span><span class="p">,</span> <span class="n">TorsionAngle</span><span class="p">,</span> <span class="n">TorsionPattern</span><span class="p">))</span>
  641             <span class="k">return</span> <span class="p">(</span><span class="n">TorsionMol</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
  642     <span class="k">else</span><span class="p">:</span>
  643         <span class="c1"># Setup a Psi4 molecule...</span>
  644         <span class="n">Psi4Mol</span> <span class="o">=</span> <span class="n">SetupPsi4Mol</span><span class="p">(</span><span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;psi4&quot;</span><span class="p">],</span> <span class="n">TorsionMol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">)</span>
  645         <span class="k">if</span> <span class="n">Psi4Mol</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
  646             <span class="k">return</span> <span class="p">(</span><span class="n">TorsionMol</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
  647             
  648         <span class="c1"># Calculate single point Psi4 energy...</span>
  649         <span class="n">CalcStatus</span><span class="p">,</span> <span class="n">Energy</span> <span class="o">=</span> <span class="n">CalculateEnergyUsingPsi4</span><span class="p">(</span><span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;psi4&quot;</span><span class="p">],</span> <span class="n">Psi4Mol</span><span class="p">,</span> <span class="n">TorsionMol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">)</span>
  650         <span class="k">if</span> <span class="ow">not</span> <span class="n">CalcStatus</span><span class="p">:</span>
  651             <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]:</span>
  652                 <span class="n">MolName</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">GetMolName</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">)</span>
  653                 <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintWarning</span><span class="p">(</span><span class="s2">&quot;Failed to calculate Psi4 energy for molecule </span><span class="si">%s</span><span class="s2"> with torsion angle set to </span><span class="si">%s</span><span class="s2"> during torsion scan for torsion pattern </span><span class="si">%s</span><span class="s2">. Abandoning torsion scan...&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">MolName</span><span class="p">,</span> <span class="n">TorsionAngle</span><span class="p">,</span> <span class="n">TorsionPattern</span><span class="p">))</span>
  654             <span class="k">return</span> <span class="p">(</span><span class="n">TorsionMol</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
  655         
  656     <span class="k">return</span> <span class="p">(</span><span class="n">TorsionMol</span><span class="p">,</span> <span class="n">CalcStatus</span><span class="p">,</span> <span class="n">Energy</span><span class="p">)</span>
  657     
  658 <span class="k">def</span> <span class="nf">SetupTorsionsMolInfo</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
  659     <span class="sd">&quot;&quot;&quot;Setup torsions info for a molecule.&quot;&quot;&quot;</span>
  660 
  661     <span class="n">TorsionsPatternsInfo</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;TorsionsPatternsInfo&quot;</span><span class="p">]</span>
  662     
  663     <span class="c1"># Initialize...</span>
  664     <span class="n">TorsionsMolInfo</span> <span class="o">=</span> <span class="p">{}</span>
  665     <span class="n">TorsionsMolInfo</span><span class="p">[</span><span class="s2">&quot;IDs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
  666     <span class="n">TorsionsMolInfo</span><span class="p">[</span><span class="s2">&quot;NumOfMatches&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
  667     <span class="n">TorsionsMolInfo</span><span class="p">[</span><span class="s2">&quot;Matches&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
  668     <span class="k">for</span> <span class="n">TorsionID</span> <span class="ow">in</span> <span class="n">TorsionsPatternsInfo</span><span class="p">[</span><span class="s2">&quot;IDs&quot;</span><span class="p">]:</span>
  669         <span class="n">TorsionsMolInfo</span><span class="p">[</span><span class="s2">&quot;IDs&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TorsionID</span><span class="p">)</span>
  670         <span class="n">TorsionsMolInfo</span><span class="p">[</span><span class="s2">&quot;Matches&quot;</span><span class="p">][</span><span class="n">TorsionID</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
  671     
  672     <span class="n">MolName</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">GetMolName</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">)</span>
  673     <span class="n">UseChirality</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;UseChirality&quot;</span><span class="p">]</span>
  674     
  675     <span class="k">for</span> <span class="n">TorsionID</span> <span class="ow">in</span> <span class="n">TorsionsPatternsInfo</span><span class="p">[</span><span class="s2">&quot;IDs&quot;</span><span class="p">]:</span>
  676         <span class="c1"># Match torsions..</span>
  677         <span class="n">TorsionPattern</span> <span class="o">=</span> <span class="n">TorsionsPatternsInfo</span><span class="p">[</span><span class="s2">&quot;Pattern&quot;</span><span class="p">][</span><span class="n">TorsionID</span><span class="p">]</span>
  678         <span class="n">TorsionPatternMol</span> <span class="o">=</span> <span class="n">TorsionsPatternsInfo</span><span class="p">[</span><span class="s2">&quot;Mol&quot;</span><span class="p">][</span><span class="n">TorsionID</span><span class="p">]</span>
  679         <span class="n">TorsionsMatches</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">FilterSubstructureMatchesByAtomMapNumbers</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">TorsionPatternMol</span><span class="p">,</span> <span class="n">Mol</span><span class="o">.</span><span class="n">GetSubstructMatches</span><span class="p">(</span><span class="n">TorsionPatternMol</span><span class="p">,</span> <span class="n">useChirality</span> <span class="o">=</span> <span class="n">UseChirality</span><span class="p">))</span>
  680 
  681         <span class="c1"># Validate tosion matches...</span>
  682         <span class="n">ValidTorsionsMatches</span> <span class="o">=</span> <span class="p">[]</span>
  683         <span class="k">for</span> <span class="n">Index</span><span class="p">,</span> <span class="n">TorsionMatch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">TorsionsMatches</span><span class="p">):</span>
  684             <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">TorsionMatch</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">:</span>
  685                 <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]:</span>
  686                     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintWarning</span><span class="p">(</span><span class="s2">&quot;Ignoring invalid torsion match to atom indices, </span><span class="si">%s</span><span class="s2">, for torsion pattern, </span><span class="si">%s</span><span class="s2">, in molecule </span><span class="si">%s</span><span class="s2">: It must match exactly 4 atoms.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">TorsionMatch</span><span class="p">,</span> <span class="n">TorsionPattern</span><span class="p">,</span> <span class="n">MolName</span><span class="p">))</span>
  687                 <span class="k">continue</span>
  688             
  689             <span class="k">if</span> <span class="ow">not</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">AreAtomIndicesSequentiallyConnected</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">TorsionMatch</span><span class="p">):</span>
  690                 <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]:</span>
  691                     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
  692                     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintWarning</span><span class="p">(</span><span class="s2">&quot;Invalid torsion match to atom indices, </span><span class="si">%s</span><span class="s2">, for torsion pattern, </span><span class="si">%s</span><span class="s2">, in molecule </span><span class="si">%s</span><span class="s2">: Matched atom indices must be sequentially connected.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">TorsionMatch</span><span class="p">,</span> <span class="n">TorsionPattern</span><span class="p">,</span> <span class="n">MolName</span><span class="p">))</span>
  693                     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintWarning</span><span class="p">(</span><span class="s2">&quot;Reordering matched atom indices in a sequentially connected manner...&quot;</span><span class="p">)</span>
  694                 
  695                 <span class="n">Status</span><span class="p">,</span> <span class="n">ReorderdTorsionMatch</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">ReorderAtomIndicesInSequentiallyConnectedManner</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">TorsionMatch</span><span class="p">)</span>
  696                 <span class="k">if</span> <span class="n">Status</span><span class="p">:</span>
  697                     <span class="n">TorsionMatch</span> <span class="o">=</span> <span class="n">ReorderdTorsionMatch</span>
  698                     <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]:</span>
  699                         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintWarning</span><span class="p">(</span><span class="s2">&quot;Successfully reordered torsion match to atom indices, </span><span class="si">%s</span><span class="s2">, for torsion pattern, </span><span class="si">%s</span><span class="s2">, in molecule </span><span class="si">%s</span><span class="s2">: Matched atom indices are now sequentially connected.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">TorsionMatch</span><span class="p">,</span> <span class="n">TorsionPattern</span><span class="p">,</span> <span class="n">MolName</span><span class="p">))</span>
  700                 <span class="k">else</span><span class="p">:</span>
  701                     <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]:</span>
  702                         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintWarning</span><span class="p">(</span><span class="s2">&quot;Ignoring torsion match. Failed to reorder torsion match to atom indices, </span><span class="si">%s</span><span class="s2">, for torsion pattern, </span><span class="si">%s</span><span class="s2">, in molecule </span><span class="si">%s</span><span class="s2">: Matched atom indices are not sequentially connected.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">TorsionMatch</span><span class="p">,</span> <span class="n">TorsionPattern</span><span class="p">,</span> <span class="n">MolName</span><span class="p">))</span>
  703                     <span class="k">continue</span>
  704             
  705             <span class="n">Bond</span> <span class="o">=</span> <span class="n">Mol</span><span class="o">.</span><span class="n">GetBondBetweenAtoms</span><span class="p">(</span><span class="n">TorsionMatch</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">TorsionMatch</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
  706             <span class="k">if</span> <span class="n">Bond</span><span class="o">.</span><span class="n">IsInRing</span><span class="p">():</span>
  707                 <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]:</span>
  708                     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintWarning</span><span class="p">(</span><span class="s2">&quot;Ignoring invalid torsion match to atom indices, </span><span class="si">%s</span><span class="s2">, for torsion pattern, </span><span class="si">%s</span><span class="s2">, in molecule </span><span class="si">%s</span><span class="s2">: Matched atom indices, </span><span class="si">%s</span><span class="s2"> and </span><span class="si">%s</span><span class="s2">, are not allowed to be in a ring.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">TorsionMatch</span><span class="p">,</span> <span class="n">TorsionPattern</span><span class="p">,</span> <span class="n">MolName</span><span class="p">,</span> <span class="n">TorsionMatch</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">TorsionMatch</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
  709                 <span class="k">continue</span>
  710             
  711             <span class="c1"># Filter matched torsions...</span>
  712             <span class="k">if</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;FilterTorsionsByAtomIndicesMode&quot;</span><span class="p">]:</span>
  713                 <span class="n">InvalidAtomIndices</span> <span class="o">=</span> <span class="p">[]</span>
  714                 <span class="k">for</span> <span class="n">AtomIndex</span> <span class="ow">in</span> <span class="n">TorsionMatch</span><span class="p">:</span>
  715                     <span class="k">if</span> <span class="n">AtomIndex</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;TorsionsFilterByAtomIndicesList&quot;</span><span class="p">]:</span>
  716                         <span class="n">InvalidAtomIndices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">AtomIndex</span><span class="p">)</span>
  717                 <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">InvalidAtomIndices</span><span class="p">):</span>
  718                     <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]:</span>
  719                         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintWarning</span><span class="p">(</span><span class="s2">&quot;Ignoring invalid torsion match to atom indices, </span><span class="si">%s</span><span class="s2">, for torsion pattern, </span><span class="si">%s</span><span class="s2">, in molecule </span><span class="si">%s</span><span class="s2">: Matched atom indices, </span><span class="si">%s</span><span class="s2">,  must be present in the list, </span><span class="si">%s</span><span class="s2">, specified using option </span><span class="se">\&quot;</span><span class="s2">--torsionsFilterbyAtomIndices</span><span class="se">\&quot;</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">TorsionMatch</span><span class="p">,</span> <span class="n">TorsionPattern</span><span class="p">,</span> <span class="n">MolName</span><span class="p">,</span> <span class="n">InvalidAtomIndices</span><span class="p">,</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;TorsionsFilterByAtomIndicesList&quot;</span><span class="p">]))</span>
  720                     <span class="k">continue</span>
  721             
  722             <span class="n">ValidTorsionsMatches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TorsionMatch</span><span class="p">)</span>
  723         
  724         <span class="c1"># Track valid matches...</span>
  725         <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ValidTorsionsMatches</span><span class="p">):</span>
  726             <span class="n">TorsionsMolInfo</span><span class="p">[</span><span class="s2">&quot;NumOfMatches&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ValidTorsionsMatches</span><span class="p">)</span>
  727             <span class="n">TorsionsMolInfo</span><span class="p">[</span><span class="s2">&quot;Matches&quot;</span><span class="p">][</span><span class="n">TorsionID</span><span class="p">]</span> <span class="o">=</span> <span class="n">ValidTorsionsMatches</span>
  728         
  729     <span class="k">if</span> <span class="n">TorsionsMolInfo</span><span class="p">[</span><span class="s2">&quot;NumOfMatches&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
  730         <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]:</span>
  731             <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintWarning</span><span class="p">(</span><span class="s2">&quot;Failed to match any torsions  in molecule </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">MolName</span><span class="p">))</span>
  732 
  733     <span class="k">return</span> <span class="n">TorsionsMolInfo</span>
  734 
  735 <span class="k">def</span> <span class="nf">SetupTorsionsPatternsInfo</span><span class="p">():</span>
  736     <span class="sd">&quot;&quot;&quot;Setup torsions patterns info.&quot;&quot;&quot;</span>
  737 
  738     <span class="n">TorsionsPatternsInfo</span> <span class="o">=</span> <span class="p">{}</span>
  739     <span class="n">TorsionsPatternsInfo</span><span class="p">[</span><span class="s2">&quot;IDs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
  740     <span class="n">TorsionsPatternsInfo</span><span class="p">[</span><span class="s2">&quot;Pattern&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
  741     <span class="n">TorsionsPatternsInfo</span><span class="p">[</span><span class="s2">&quot;Mol&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
  742 
  743     <span class="n">TorsionID</span> <span class="o">=</span> <span class="mi">0</span>
  744     <span class="k">for</span> <span class="n">TorsionPattern</span> <span class="ow">in</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;TorsionPatternsList&quot;</span><span class="p">]:</span>
  745         <span class="n">TorsionID</span> <span class="o">+=</span> <span class="mi">1</span>
  746         
  747         <span class="n">TorsionMol</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">MolFromSmarts</span><span class="p">(</span><span class="n">TorsionPattern</span><span class="p">)</span>
  748         <span class="k">if</span> <span class="n">TorsionMol</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
  749             <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintError</span><span class="p">(</span><span class="s2">&quot;Failed to create torsion pattern molecule. The torsion SMILES/SMARTS pattern, </span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2">, specified using </span><span class="se">\&quot;</span><span class="s2">-t, --torsions</span><span class="se">\&quot;</span><span class="s2"> option is not valid.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">TorsionPattern</span><span class="p">))</span>
  750         
  751         <span class="n">TorsionsPatternsInfo</span><span class="p">[</span><span class="s2">&quot;IDs&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TorsionID</span><span class="p">)</span>
  752         <span class="n">TorsionsPatternsInfo</span><span class="p">[</span><span class="s2">&quot;Pattern&quot;</span><span class="p">][</span><span class="n">TorsionID</span><span class="p">]</span> <span class="o">=</span> <span class="n">TorsionPattern</span>
  753         <span class="n">TorsionsPatternsInfo</span><span class="p">[</span><span class="s2">&quot;Mol&quot;</span><span class="p">][</span><span class="n">TorsionID</span><span class="p">]</span> <span class="o">=</span> <span class="n">TorsionMol</span>
  754 
  755     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;TorsionsPatternsInfo&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">TorsionsPatternsInfo</span>
  756     
  757 <span class="k">def</span> <span class="nf">MinimizeMolecule</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
  758     <span class="sd">&quot;&quot;&quot;Minimize molecule.&quot;&quot;&quot;</span>
  759 
  760     <span class="k">return</span> <span class="n">GenerateAndMinimizeConformersUsingForceField</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">)</span>
  761 
  762 <span class="k">def</span> <span class="nf">GenerateAndMinimizeConformersUsingForceField</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
  763     <span class="sd">&quot;&quot;&quot;Generate and minimize conformers for a molecule to get the lowest energy conformer</span>
  764 <span class="sd">    as the minimized structure.&quot;&quot;&quot;</span>
  765 
  766     <span class="n">MolName</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">GetMolName</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">)</span>
  767     
  768     <span class="c1"># Setup conformers...</span>
  769     <span class="n">ConfIDs</span> <span class="o">=</span> <span class="n">EmbedMolecule</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">)</span>
  770     <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">ConfIDs</span><span class="p">):</span>
  771         <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]:</span>
  772             <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintWarning</span><span class="p">(</span><span class="s2">&quot;Minimization couldn&#39;t be performed for molecule </span><span class="si">%s</span><span class="s2">: Embedding failed...</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">MolName</span><span class="p">)</span>
  773         <span class="k">return</span> <span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
  774     
  775     <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]:</span>
  776         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;Performing initial minimization of molecule, </span><span class="si">%s</span><span class="s2">, using forcefield by generating a conformation ensemble and selecting the lowest energy conformer - EmbedRMSDCutoff: </span><span class="si">%s</span><span class="s2">; Size: </span><span class="si">%s</span><span class="s2">; Size after RMSD filtering: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">MolName</span><span class="p">,</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;ConfGenerationParams&quot;</span><span class="p">][</span><span class="s2">&quot;EmbedRMSDCutoff&quot;</span><span class="p">],</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;ConfGenerationParams&quot;</span><span class="p">][</span><span class="s2">&quot;MaxConfs&quot;</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">ConfIDs</span><span class="p">)))</span>
  777     
  778     <span class="c1"># Minimize conformers...</span>
  779     <span class="n">CalcEnergyMap</span> <span class="o">=</span> <span class="p">{}</span>
  780     <span class="k">for</span> <span class="n">ConfID</span> <span class="ow">in</span> <span class="n">ConfIDs</span><span class="p">:</span>
  781         <span class="c1"># Perform forcefield minimization...</span>
  782         <span class="n">Status</span><span class="p">,</span> <span class="n">ConvergeStatus</span> <span class="o">=</span> <span class="n">MinimizeMoleculeUsingForceField</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">,</span> <span class="n">ConfID</span><span class="p">)</span>
  783         <span class="k">if</span> <span class="ow">not</span> <span class="n">Status</span><span class="p">:</span>
  784             <span class="k">return</span> <span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
  785         
  786         <span class="n">EnergyStatus</span><span class="p">,</span> <span class="n">Energy</span> <span class="o">=</span> <span class="n">CalculateEnergyUsingForceField</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">ConfID</span><span class="p">)</span>
  787         <span class="k">if</span> <span class="ow">not</span> <span class="n">EnergyStatus</span><span class="p">:</span>
  788             <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]:</span>
  789                 <span class="n">MolName</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">GetMolName</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">)</span>
  790                 <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintWarning</span><span class="p">(</span><span class="s2">&quot;Failed to retrieve calculated energy for conformation number </span><span class="si">%d</span><span class="s2"> of molecule </span><span class="si">%s</span><span class="s2">. Try again after removing any salts or cleaing up the molecule...</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ConfID</span><span class="p">,</span> <span class="n">MolName</span><span class="p">))</span>
  791             <span class="k">return</span> <span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
  792         
  793         <span class="k">if</span> <span class="n">ConvergeStatus</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
  794             <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]:</span>
  795                 <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintWarning</span><span class="p">(</span><span class="s2">&quot;Minimization using forcefield failed to converge for molecule </span><span class="si">%s</span><span class="s2"> in </span><span class="si">%d</span><span class="s2"> steps. Try using higher value for </span><span class="se">\&quot;</span><span class="s2">maxIters</span><span class="se">\&quot;</span><span class="s2"> in </span><span class="se">\&quot;</span><span class="s2">--confParams</span><span class="se">\&quot;</span><span class="s2"> option...</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">MolName</span><span class="p">,</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;ConfGenerationParams&quot;</span><span class="p">][</span><span class="s2">&quot;MaxIters&quot;</span><span class="p">]))</span>
  796         
  797         <span class="n">CalcEnergyMap</span><span class="p">[</span><span class="n">ConfID</span><span class="p">]</span> <span class="o">=</span> <span class="n">Energy</span>
  798     
  799     <span class="n">SortedConfIDs</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">ConfIDs</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">ConfID</span><span class="p">:</span> <span class="n">CalcEnergyMap</span><span class="p">[</span><span class="n">ConfID</span><span class="p">])</span>
  800     <span class="n">MinEnergyConfID</span> <span class="o">=</span> <span class="n">SortedConfIDs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
  801         
  802     <span class="k">for</span> <span class="n">ConfID</span> <span class="ow">in</span> <span class="p">[</span><span class="n">Conf</span><span class="o">.</span><span class="n">GetId</span><span class="p">()</span> <span class="k">for</span> <span class="n">Conf</span> <span class="ow">in</span> <span class="n">Mol</span><span class="o">.</span><span class="n">GetConformers</span><span class="p">()]:</span>
  803         <span class="k">if</span> <span class="n">ConfID</span> <span class="o">==</span> <span class="n">MinEnergyConfID</span><span class="p">:</span>
  804             <span class="k">continue</span>
  805         <span class="n">Mol</span><span class="o">.</span><span class="n">RemoveConformer</span><span class="p">(</span><span class="n">ConfID</span><span class="p">)</span>
  806     
  807     <span class="c1"># Set ConfID to 0 for MinEnergyConf...</span>
  808     <span class="n">Mol</span><span class="o">.</span><span class="n">GetConformer</span><span class="p">(</span><span class="n">MinEnergyConfID</span><span class="p">)</span><span class="o">.</span><span class="n">SetId</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
  809 
  810     <span class="k">return</span> <span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
  811 
  812 <span class="k">def</span> <span class="nf">ConstrainAndMinimizeMolecule</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">TorsionAngle</span><span class="p">,</span> <span class="n">RefMolCore</span><span class="p">,</span> <span class="n">RefMolMatches</span><span class="p">,</span> <span class="n">MolNum</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
  813     <span class="sd">&quot;&quot;&quot;Constrain and minimize molecule.&quot;&quot;&quot;</span>
  814 
  815     <span class="c1"># TorsionMol, CalcStatus, Energy</span>
  816     <span class="n">MolName</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">GetMolName</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">)</span>
  817 
  818     <span class="c1"># Setup constrained conformers...</span>
  819     <span class="n">MolConfs</span><span class="p">,</span> <span class="n">MolConfsStatus</span> <span class="o">=</span> <span class="n">ConstrainEmbedAndMinimizeMoleculeUsingRDKit</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">RefMolCore</span><span class="p">,</span> <span class="n">RefMolMatches</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">)</span>
  820     <span class="k">if</span> <span class="ow">not</span> <span class="n">MolConfsStatus</span><span class="p">:</span>
  821         <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]:</span>
  822             <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintWarning</span><span class="p">(</span><span class="s2">&quot;Conformation generation couldn&#39;t be performed for molecule </span><span class="si">%s</span><span class="s2">: Constrained embedding failed...</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">MolName</span><span class="p">)</span>
  823         <span class="k">return</span> <span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
  824 
  825     <span class="c1"># Minimize conformers...</span>
  826     <span class="n">ConfNums</span> <span class="o">=</span> <span class="p">[]</span>
  827     <span class="n">CalcEnergyMap</span> <span class="o">=</span> <span class="p">{}</span>
  828     <span class="n">MolConfsMap</span> <span class="o">=</span> <span class="p">{}</span>
  829     
  830     <span class="k">for</span> <span class="n">ConfNum</span><span class="p">,</span> <span class="n">MolConf</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">MolConfs</span><span class="p">):</span>
  831         <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]:</span>
  832             <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Performing constrained minimization using Psi4 for molecule, </span><span class="si">%s</span><span class="s2">, conformer number, </span><span class="si">%s</span><span class="s2">, at torsion angle </span><span class="si">%s</span><span class="s2">...&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">MolName</span><span class="p">,</span> <span class="n">ConfNum</span><span class="p">,</span> <span class="n">TorsionAngle</span><span class="p">))</span>
  833 
  834         <span class="n">CalcStatus</span><span class="p">,</span> <span class="n">Energy</span> <span class="o">=</span> <span class="n">ConstrainAndMinimizeMoleculeUsingPsi4</span><span class="p">(</span><span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;psi4&quot;</span><span class="p">],</span> <span class="n">MolConf</span><span class="p">,</span> <span class="n">RefMolCore</span><span class="p">,</span> <span class="n">RefMolMatches</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">)</span>
  835         <span class="k">if</span> <span class="ow">not</span> <span class="n">CalcStatus</span><span class="p">:</span>
  836             <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]:</span>
  837                 <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintWarning</span><span class="p">(</span><span class="s2">&quot;Minimization couldn&#39;t be performed for molecule </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">MolName</span><span class="p">))</span>
  838             <span class="k">return</span> <span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
  839         
  840         <span class="n">ConfNums</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ConfNum</span><span class="p">)</span>
  841         <span class="n">CalcEnergyMap</span><span class="p">[</span><span class="n">ConfNum</span><span class="p">]</span> <span class="o">=</span> <span class="n">Energy</span>
  842         <span class="n">MolConfsMap</span><span class="p">[</span><span class="n">ConfNum</span><span class="p">]</span> <span class="o">=</span> <span class="n">MolConf</span>
  843     
  844     <span class="n">SortedConfNums</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">ConfNums</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">ConfNum</span><span class="p">:</span> <span class="n">CalcEnergyMap</span><span class="p">[</span><span class="n">ConfNum</span><span class="p">])</span>
  845     <span class="n">MinEnergyConfNum</span> <span class="o">=</span> <span class="n">SortedConfNums</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
  846     
  847     <span class="n">MinEnergy</span> <span class="o">=</span> <span class="n">CalcEnergyMap</span><span class="p">[</span><span class="n">MinEnergyConfNum</span><span class="p">]</span>
  848     <span class="n">MinEnergyMolConf</span> <span class="o">=</span> <span class="n">MolConfsMap</span><span class="p">[</span><span class="n">MinEnergyConfNum</span><span class="p">]</span>
  849     
  850     <span class="n">MinEnergyMolConf</span><span class="o">.</span><span class="n">ClearProp</span><span class="p">(</span><span class="s1">&#39;EmbedRMS&#39;</span><span class="p">)</span>
  851     
  852     <span class="k">return</span> <span class="p">(</span><span class="n">MinEnergyMolConf</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="n">MinEnergy</span><span class="p">)</span>
  853 
  854 <span class="k">def</span> <span class="nf">ConstrainAndMinimizeMoleculeUsingPsi4</span><span class="p">(</span><span class="n">Psi4Handle</span><span class="p">,</span> <span class="n">Mol</span><span class="p">,</span> <span class="n">RefMolCore</span><span class="p">,</span> <span class="n">RefMolMatches</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">,</span> <span class="n">ConfID</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
  855     <span class="sd">&quot;&quot;&quot;Minimize molecule using Psi4.&quot;&quot;&quot;</span>
  856 
  857     <span class="c1"># Setup a list for constrained atoms...</span>
  858     <span class="n">ConstrainedAtomIndices</span> <span class="o">=</span> <span class="n">SetupConstrainedAtomIndicesForPsi4</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">RefMolCore</span><span class="p">,</span> <span class="n">RefMolMatches</span><span class="p">)</span>
  859     <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ConstrainedAtomIndices</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
  860         <span class="k">return</span> <span class="p">(</span><span class="bp">False</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
  861     
  862     <span class="c1"># Setup a Psi4Mol...</span>
  863     <span class="n">Psi4Mol</span> <span class="o">=</span> <span class="n">SetupPsi4Mol</span><span class="p">(</span><span class="n">Psi4Handle</span><span class="p">,</span> <span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">,</span> <span class="n">ConfID</span><span class="p">)</span>
  864     <span class="k">if</span> <span class="n">Psi4Mol</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
  865         <span class="k">return</span> <span class="p">(</span><span class="bp">False</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
  866         
  867     <span class="c1">#  Setup reference wave function...</span>
  868     <span class="n">Reference</span> <span class="o">=</span> <span class="n">SetupReferenceWavefunction</span><span class="p">(</span><span class="n">Mol</span><span class="p">)</span>
  869     <span class="n">Psi4Handle</span><span class="o">.</span><span class="n">set_options</span><span class="p">({</span><span class="s1">&#39;Reference&#39;</span><span class="p">:</span> <span class="n">Reference</span><span class="p">})</span>
  870     
  871     <span class="c1"># Setup method name and basis set...</span>
  872     <span class="n">MethodName</span><span class="p">,</span> <span class="n">BasisSet</span> <span class="o">=</span> <span class="n">SetupMethodNameAndBasisSet</span><span class="p">(</span><span class="n">Mol</span><span class="p">)</span>
  873 
  874     <span class="c1"># Setup freeze list for constrained atoms...</span>
  875     <span class="n">FreezeXYZList</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> xyz&quot;</span> <span class="o">%</span> <span class="n">AtomIdex</span><span class="p">)</span> <span class="k">for</span> <span class="n">AtomIdex</span> <span class="ow">in</span> <span class="n">ConstrainedAtomIndices</span><span class="p">]</span>
  876     <span class="n">FreezeXYZString</span> <span class="o">=</span> <span class="s2">&quot; </span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">FreezeXYZList</span><span class="p">)</span>
  877     <span class="n">Psi4Handle</span><span class="o">.</span><span class="n">set_options</span><span class="p">({</span><span class="s2">&quot;OPTKING__frozen_cartesian&quot;</span><span class="p">:</span> <span class="n">FreezeXYZString</span><span class="p">})</span>
  878     
  879     <span class="c1"># Optimize geometry...</span>
  880     <span class="n">Status</span><span class="p">,</span> <span class="n">Energy</span><span class="p">,</span> <span class="n">WaveFunction</span> <span class="o">=</span> <span class="n">Psi4Util</span><span class="o">.</span><span class="n">PerformGeometryOptimization</span><span class="p">(</span><span class="n">Psi4Handle</span><span class="p">,</span> <span class="n">Psi4Mol</span><span class="p">,</span> <span class="n">MethodName</span><span class="p">,</span> <span class="n">BasisSet</span><span class="p">,</span> <span class="n">ReturnWaveFunction</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">Quiet</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">])</span>
  881     
  882     <span class="k">if</span> <span class="ow">not</span> <span class="n">Status</span><span class="p">:</span>
  883         <span class="n">PerformPsi4Cleanup</span><span class="p">(</span><span class="n">Psi4Handle</span><span class="p">)</span>
  884         <span class="k">return</span> <span class="p">(</span><span class="bp">False</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
  885 
  886     <span class="c1"># Update atom positions...</span>
  887     <span class="n">AtomPositions</span> <span class="o">=</span> <span class="n">Psi4Util</span><span class="o">.</span><span class="n">GetAtomPositions</span><span class="p">(</span><span class="n">Psi4Handle</span><span class="p">,</span> <span class="n">WaveFunction</span><span class="p">,</span> <span class="n">InAngstroms</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
  888     <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">SetAtomPositions</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">AtomPositions</span><span class="p">,</span> <span class="n">ConfID</span> <span class="o">=</span> <span class="n">ConfID</span><span class="p">)</span>
  889 
  890     <span class="c1"># Convert energy units...</span>
  891     <span class="k">if</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;ApplyEnergyConversionFactor&quot;</span><span class="p">]:</span>
  892         <span class="n">Energy</span> <span class="o">=</span> <span class="n">Energy</span> <span class="o">*</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;EnergyConversionFactor&quot;</span><span class="p">]</span>
  893     
  894     <span class="c1"># Clean up</span>
  895     <span class="n">PerformPsi4Cleanup</span><span class="p">(</span><span class="n">Psi4Handle</span><span class="p">)</span>
  896     
  897     <span class="k">return</span> <span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="n">Energy</span><span class="p">)</span>
  898     
  899 <span class="k">def</span> <span class="nf">ConstrainEmbedAndMinimizeMoleculeUsingRDKit</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">RefMolCore</span><span class="p">,</span> <span class="n">RefMolMatches</span><span class="p">,</span> <span class="n">MolNum</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
  900     <span class="sd">&quot;&quot;&quot;Constrain, embed, and minimize molecule.&quot;&quot;&quot;</span>
  901 
  902     <span class="c1"># Setup forcefield function to use for constrained minimization...</span>
  903     <span class="n">ForceFieldFunction</span> <span class="o">=</span> <span class="bp">None</span>
  904     <span class="n">ForceFieldName</span> <span class="o">=</span> <span class="bp">None</span>
  905     <span class="k">if</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;ConfGenerationParams&quot;</span><span class="p">][</span><span class="s2">&quot;UseUFF&quot;</span><span class="p">]:</span>
  906         <span class="n">ForceFieldFunction</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">mol</span><span class="p">,</span> <span class="n">confId</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="p">:</span> <span class="n">AllChem</span><span class="o">.</span><span class="n">UFFGetMoleculeForceField</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">confId</span> <span class="o">=</span> <span class="n">confId</span><span class="p">)</span>
  907         <span class="n">ForeceFieldName</span> <span class="o">=</span> <span class="s2">&quot;UFF&quot;</span>
  908     <span class="k">else</span><span class="p">:</span>
  909         <span class="n">ForceFieldFunction</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">mol</span><span class="p">,</span> <span class="n">confId</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="p">:</span> <span class="n">AllChem</span><span class="o">.</span><span class="n">MMFFGetMoleculeForceField</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">AllChem</span><span class="o">.</span><span class="n">MMFFGetMoleculeProperties</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">mmffVariant</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;ConfGenerationParams&quot;</span><span class="p">][</span><span class="s2">&quot;MMFFVariant&quot;</span><span class="p">])</span> <span class="p">,</span> <span class="n">confId</span> <span class="o">=</span> <span class="n">confId</span><span class="p">)</span>
  910         <span class="n">ForeceFieldName</span> <span class="o">=</span> <span class="s2">&quot;MMFF&quot;</span>
  911 
  912     <span class="k">if</span> <span class="n">ForceFieldFunction</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
  913         <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]:</span>
  914             <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintWarning</span><span class="p">(</span><span class="s2">&quot;Failed to setup forcefield </span><span class="si">%s</span><span class="s2"> for molecule: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ForceFieldName</span><span class="p">,</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">GetMolName</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">)))</span>
  915         <span class="k">return</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
  916     
  917     <span class="n">MaxConfs</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;ConfGenerationParams&quot;</span><span class="p">][</span><span class="s2">&quot;MaxConfsTorsions&quot;</span><span class="p">]</span>
  918     <span class="n">EnforceChirality</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;ConfGenerationParams&quot;</span><span class="p">][</span><span class="s2">&quot;EnforceChirality&quot;</span><span class="p">]</span>
  919     <span class="n">UseExpTorsionAnglePrefs</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;ConfGenerationParams&quot;</span><span class="p">][</span><span class="s2">&quot;UseExpTorsionAnglePrefs&quot;</span><span class="p">]</span>
  920     <span class="n">UseBasicKnowledge</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;ConfGenerationParams&quot;</span><span class="p">][</span><span class="s2">&quot;UseBasicKnowledge&quot;</span><span class="p">]</span>
  921     <span class="n">UseTethers</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;ConfGenerationParams&quot;</span><span class="p">][</span><span class="s2">&quot;UseTethers&quot;</span><span class="p">]</span>
  922 
  923     <span class="n">MolConfs</span> <span class="o">=</span> <span class="p">[]</span>
  924     <span class="n">ConfIDs</span> <span class="o">=</span> <span class="p">[</span><span class="n">ConfID</span> <span class="k">for</span> <span class="n">ConfID</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">MaxConfs</span><span class="p">)]</span>
  925     
  926     <span class="k">for</span> <span class="n">ConfID</span> <span class="ow">in</span> <span class="n">ConfIDs</span><span class="p">:</span>
  927         <span class="k">try</span><span class="p">:</span>
  928             <span class="n">MolConf</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">Mol</span><span class="p">(</span><span class="n">Mol</span><span class="p">)</span>
  929             <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">ConstrainAndEmbed</span><span class="p">(</span><span class="n">MolConf</span><span class="p">,</span> <span class="n">RefMolCore</span><span class="p">,</span> <span class="n">coreMatchesMol</span> <span class="o">=</span> <span class="n">RefMolMatches</span><span class="p">,</span> <span class="n">useTethers</span> <span class="o">=</span> <span class="n">UseTethers</span><span class="p">,</span> <span class="n">coreConfId</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">randomseed</span> <span class="o">=</span> <span class="n">ConfID</span><span class="p">,</span> <span class="n">getForceField</span> <span class="o">=</span> <span class="n">ForceFieldFunction</span><span class="p">,</span> <span class="n">enforceChirality</span> <span class="o">=</span> <span class="n">EnforceChirality</span><span class="p">,</span> <span class="n">useExpTorsionAnglePrefs</span> <span class="o">=</span> <span class="n">UseExpTorsionAnglePrefs</span><span class="p">,</span> <span class="n">useBasicKnowledge</span> <span class="o">=</span> <span class="n">UseBasicKnowledge</span><span class="p">)</span>
  930         <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">RuntimeError</span><span class="p">,</span> <span class="n">Chem</span><span class="o">.</span><span class="n">rdchem</span><span class="o">.</span><span class="n">KekulizeException</span><span class="p">)</span>  <span class="k">as</span> <span class="n">ErrMsg</span><span class="p">:</span>
  931             <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]:</span>
  932                 <span class="n">MolName</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">GetMolName</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">)</span>
  933                 <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintWarning</span><span class="p">(</span><span class="s2">&quot;Constrained embedding couldn&#39;t  be performed for molecule </span><span class="si">%s</span><span class="s2">:</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">RDKitUtil</span><span class="o">.</span><span class="n">GetMolName</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">),</span> <span class="n">ErrMsg</span><span class="p">))</span>
  934             <span class="k">return</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
  935         
  936         <span class="n">MolConfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">MolConf</span><span class="p">)</span>
  937 
  938     <span class="k">return</span> <span class="n">FilterConstrainedConformationsByRMSD</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolConfs</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">)</span>
  939 
  940 <span class="k">def</span> <span class="nf">FilterConstrainedConformationsByRMSD</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolConfs</span><span class="p">,</span> <span class="n">MolNum</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
  941     <span class="sd">&quot;&quot;&quot;Filter contarained conformations by RMSD.&quot;&quot;&quot;</span>
  942     
  943     <span class="n">EmbedRMSDCutoff</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;ConfGenerationParams&quot;</span><span class="p">][</span><span class="s2">&quot;EmbedRMSDCutoff&quot;</span><span class="p">]</span>
  944     <span class="k">if</span> <span class="n">EmbedRMSDCutoff</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">EmbedRMSDCutoff</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
  945         <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]:</span>
  946             <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Generating initial ensemble of  constrained conformations by distance geometry  and forcefield for </span><span class="si">%s</span><span class="s2"> - EmbedRMSDCutoff: None; Size: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">RDKitUtil</span><span class="o">.</span><span class="n">GetMolName</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">MolConfs</span><span class="p">)))</span>
  947         <span class="k">return</span> <span class="p">(</span><span class="n">MolConfs</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
  948 
  949     <span class="n">FirstMolConf</span> <span class="o">=</span> <span class="bp">True</span>
  950     <span class="n">SelectedMolConfs</span> <span class="o">=</span> <span class="p">[]</span>
  951     <span class="k">for</span> <span class="n">MolConfIndex</span><span class="p">,</span> <span class="n">MolConf</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">MolConfs</span><span class="p">):</span>
  952         <span class="k">if</span> <span class="n">FirstMolConf</span><span class="p">:</span>
  953             <span class="n">FirstMolConf</span> <span class="o">=</span> <span class="bp">False</span>
  954             <span class="n">SelectedMolConfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">MolConf</span><span class="p">)</span>
  955             <span class="k">continue</span>
  956         
  957         <span class="c1"># Compare RMSD against all selected conformers...</span>
  958         <span class="n">ProbeMolConf</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">RemoveHs</span><span class="p">(</span><span class="n">Chem</span><span class="o">.</span><span class="n">Mol</span><span class="p">(</span><span class="n">MolConf</span><span class="p">))</span>
  959         <span class="n">IgnoreConf</span> <span class="o">=</span> <span class="bp">False</span>
  960         <span class="k">for</span> <span class="n">SelectedMolConfIndex</span><span class="p">,</span> <span class="n">SelectedMolConf</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">SelectedMolConfs</span><span class="p">):</span>
  961             <span class="n">RefMolConf</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">RemoveHs</span><span class="p">(</span><span class="n">Chem</span><span class="o">.</span><span class="n">Mol</span><span class="p">(</span><span class="n">SelectedMolConf</span><span class="p">))</span>
  962             <span class="n">CalcRMSD</span> <span class="o">=</span> <span class="n">rdMolAlign</span><span class="o">.</span><span class="n">AlignMol</span><span class="p">(</span><span class="n">ProbeMolConf</span><span class="p">,</span> <span class="n">RefMolConf</span><span class="p">)</span>
  963             
  964             <span class="k">if</span> <span class="n">CalcRMSD</span> <span class="o">&lt;</span> <span class="n">EmbedRMSDCutoff</span><span class="p">:</span>
  965                 <span class="n">IgnoreConf</span> <span class="o">=</span> <span class="bp">True</span>
  966                 <span class="k">break</span>
  967         
  968         <span class="k">if</span> <span class="n">IgnoreConf</span><span class="p">:</span>
  969             <span class="k">continue</span>
  970         
  971         <span class="n">SelectedMolConfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">MolConf</span><span class="p">)</span>
  972         
  973     <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]:</span>
  974         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Generating initial ensemble of constrained conformations by distance geometry and forcefield for </span><span class="si">%s</span><span class="s2"> - EmbedRMSDCutoff: </span><span class="si">%s</span><span class="s2">; Size: </span><span class="si">%s</span><span class="s2">; Size after RMSD filtering: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">RDKitUtil</span><span class="o">.</span><span class="n">GetMolName</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">),</span> <span class="n">EmbedRMSDCutoff</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">MolConfs</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">SelectedMolConfs</span><span class="p">)))</span>
  975     
  976     <span class="k">return</span> <span class="p">(</span><span class="n">SelectedMolConfs</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
  977 
  978 <span class="k">def</span> <span class="nf">EmbedMolecule</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
  979     <span class="sd">&quot;&quot;&quot;Embed conformations.&quot;&quot;&quot;</span>
  980 
  981     <span class="n">ConfIDs</span> <span class="o">=</span> <span class="p">[]</span>
  982     
  983     <span class="n">MaxConfs</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;ConfGenerationParams&quot;</span><span class="p">][</span><span class="s2">&quot;MaxConfs&quot;</span><span class="p">]</span>
  984     <span class="n">RandomSeed</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;ConfGenerationParams&quot;</span><span class="p">][</span><span class="s2">&quot;RandomSeed&quot;</span><span class="p">]</span>
  985     <span class="n">EnforceChirality</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;ConfGenerationParams&quot;</span><span class="p">][</span><span class="s2">&quot;EnforceChirality&quot;</span><span class="p">]</span>
  986     <span class="n">UseExpTorsionAnglePrefs</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;ConfGenerationParams&quot;</span><span class="p">][</span><span class="s2">&quot;UseExpTorsionAnglePrefs&quot;</span><span class="p">]</span>
  987     <span class="n">UseBasicKnowledge</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;ConfGenerationParams&quot;</span><span class="p">][</span><span class="s2">&quot;UseBasicKnowledge&quot;</span><span class="p">]</span>
  988     <span class="n">EmbedRMSDCutoff</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;ConfGenerationParams&quot;</span><span class="p">][</span><span class="s2">&quot;EmbedRMSDCutoff&quot;</span><span class="p">]</span>
  989 
  990     <span class="k">try</span><span class="p">:</span>
  991         <span class="n">ConfIDs</span> <span class="o">=</span> <span class="n">AllChem</span><span class="o">.</span><span class="n">EmbedMultipleConfs</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">numConfs</span> <span class="o">=</span> <span class="n">MaxConfs</span><span class="p">,</span> <span class="n">randomSeed</span> <span class="o">=</span> <span class="n">RandomSeed</span><span class="p">,</span> <span class="n">pruneRmsThresh</span> <span class="o">=</span> <span class="n">EmbedRMSDCutoff</span><span class="p">,</span> <span class="n">enforceChirality</span> <span class="o">=</span> <span class="n">EnforceChirality</span><span class="p">,</span> <span class="n">useExpTorsionAnglePrefs</span> <span class="o">=</span> <span class="n">UseExpTorsionAnglePrefs</span><span class="p">,</span> <span class="n">useBasicKnowledge</span> <span class="o">=</span> <span class="n">UseBasicKnowledge</span><span class="p">)</span>
  992     <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">ErrMsg</span><span class="p">:</span>
  993         <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]:</span>
  994             <span class="n">MolName</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">GetMolName</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">)</span>
  995             <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintWarning</span><span class="p">(</span><span class="s2">&quot;Embedding failed  for molecule </span><span class="si">%s</span><span class="s2">:</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">MolName</span><span class="p">,</span> <span class="n">ErrMsg</span><span class="p">))</span>
  996         <span class="n">ConfIDs</span> <span class="o">=</span> <span class="p">[]</span>
  997 
  998     <span class="k">return</span> <span class="n">ConfIDs</span>
  999 
 1000 <span class="k">def</span> <span class="nf">MinimizeMoleculeUsingForceField</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">,</span> <span class="n">ConfID</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
 1001     <span class="sd">&quot;&quot;&quot;Minimize molecule using forcefield available in RDKit.&quot;&quot;&quot;</span>
 1002     
 1003     <span class="k">try</span><span class="p">:</span>
 1004         <span class="k">if</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;ConfGenerationParams&quot;</span><span class="p">][</span><span class="s2">&quot;UseUFF&quot;</span><span class="p">]:</span>
 1005             <span class="n">ConvergeStatus</span> <span class="o">=</span> <span class="n">AllChem</span><span class="o">.</span><span class="n">UFFOptimizeMolecule</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">confId</span> <span class="o">=</span> <span class="n">ConfID</span><span class="p">,</span> <span class="n">maxIters</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;ConfGenerationParams&quot;</span><span class="p">][</span><span class="s2">&quot;MaxIters&quot;</span><span class="p">])</span>
 1006         <span class="k">elif</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;ConfGenerationParams&quot;</span><span class="p">][</span><span class="s2">&quot;UseMMFF&quot;</span><span class="p">]:</span>
 1007             <span class="n">ConvergeStatus</span> <span class="o">=</span> <span class="n">AllChem</span><span class="o">.</span><span class="n">MMFFOptimizeMolecule</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">confId</span> <span class="o">=</span> <span class="n">ConfID</span><span class="p">,</span> <span class="n">maxIters</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;ConfGenerationParams&quot;</span><span class="p">][</span><span class="s2">&quot;MaxIters&quot;</span><span class="p">],</span> <span class="n">mmffVariant</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;ConfGenerationParams&quot;</span><span class="p">][</span><span class="s2">&quot;MMFFVariant&quot;</span><span class="p">])</span>
 1008         <span class="k">else</span><span class="p">:</span>
 1009             <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintError</span><span class="p">(</span><span class="s2">&quot;Minimization couldn&#39;t be performed: Specified forcefield, </span><span class="si">%s</span><span class="s2">, is not supported&quot;</span> <span class="o">%</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;ConfGenerationParams&quot;</span><span class="p">][</span><span class="s2">&quot;ForceField&quot;</span><span class="p">])</span>
 1010     <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">RuntimeError</span><span class="p">,</span> <span class="n">Chem</span><span class="o">.</span><span class="n">rdchem</span><span class="o">.</span><span class="n">KekulizeException</span><span class="p">)</span> <span class="k">as</span> <span class="n">ErrMsg</span><span class="p">:</span>
 1011         <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]:</span>
 1012             <span class="n">MolName</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">GetMolName</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">)</span>
 1013             <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintWarning</span><span class="p">(</span><span class="s2">&quot;Minimization using forcefield couldn&#39;t be performed for molecule </span><span class="si">%s</span><span class="s2">:</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">MolName</span><span class="p">,</span> <span class="n">ErrMsg</span><span class="p">))</span>
 1014         <span class="k">return</span> <span class="p">(</span><span class="bp">False</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
 1015     
 1016     <span class="k">return</span> <span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="n">ConvergeStatus</span><span class="p">)</span>
 1017 
 1018 <span class="k">def</span> <span class="nf">CalculateEnergyUsingForceField</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">ConfID</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
 1019     <span class="sd">&quot;&quot;&quot;Calculate energy.&quot;&quot;&quot;</span>
 1020 
 1021     <span class="n">Status</span> <span class="o">=</span> <span class="bp">True</span>
 1022     <span class="n">Energy</span> <span class="o">=</span> <span class="bp">None</span>
 1023 
 1024     <span class="k">if</span> <span class="n">ConfID</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
 1025         <span class="n">ConfID</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
 1026     
 1027     <span class="k">if</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;ConfGenerationParams&quot;</span><span class="p">][</span><span class="s2">&quot;UseUFF&quot;</span><span class="p">]:</span>
 1028         <span class="n">UFFMoleculeForcefield</span> <span class="o">=</span> <span class="n">AllChem</span><span class="o">.</span><span class="n">UFFGetMoleculeForceField</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">confId</span> <span class="o">=</span> <span class="n">ConfID</span><span class="p">)</span>
 1029         <span class="k">if</span> <span class="n">UFFMoleculeForcefield</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
 1030             <span class="n">Status</span> <span class="o">=</span> <span class="bp">False</span>
 1031         <span class="k">else</span><span class="p">:</span>
 1032             <span class="n">Energy</span> <span class="o">=</span> <span class="n">UFFMoleculeForcefield</span><span class="o">.</span><span class="n">CalcEnergy</span><span class="p">()</span>
 1033     <span class="k">elif</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;ConfGenerationParams&quot;</span><span class="p">][</span><span class="s2">&quot;UseMMFF&quot;</span><span class="p">]:</span>
 1034         <span class="n">MMFFMoleculeProperties</span> <span class="o">=</span> <span class="n">AllChem</span><span class="o">.</span><span class="n">MMFFGetMoleculeProperties</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">mmffVariant</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;ConfGenerationParams&quot;</span><span class="p">][</span><span class="s2">&quot;MMFFVariant&quot;</span><span class="p">])</span>
 1035         <span class="n">MMFFMoleculeForcefield</span> <span class="o">=</span> <span class="n">AllChem</span><span class="o">.</span><span class="n">MMFFGetMoleculeForceField</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MMFFMoleculeProperties</span><span class="p">,</span> <span class="n">confId</span> <span class="o">=</span> <span class="n">ConfID</span><span class="p">)</span>
 1036         <span class="k">if</span> <span class="n">MMFFMoleculeForcefield</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
 1037             <span class="n">Status</span> <span class="o">=</span> <span class="bp">False</span>
 1038         <span class="k">else</span><span class="p">:</span>
 1039             <span class="n">Energy</span> <span class="o">=</span> <span class="n">MMFFMoleculeForcefield</span><span class="o">.</span><span class="n">CalcEnergy</span><span class="p">()</span>
 1040     <span class="k">else</span><span class="p">:</span>
 1041         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintError</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t retrieve conformer energy: Specified forcefield, </span><span class="si">%s</span><span class="s2">, is not supported&quot;</span> <span class="o">%</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;ConfGenerationParams&quot;</span><span class="p">][</span><span class="s2">&quot;ForceField&quot;</span><span class="p">])</span>
 1042     
 1043     <span class="k">return</span> <span class="p">(</span><span class="n">Status</span><span class="p">,</span> <span class="n">Energy</span><span class="p">)</span>
 1044 
 1045 <span class="k">def</span> <span class="nf">CalculateEnergyUsingPsi4</span><span class="p">(</span><span class="n">Psi4Handle</span><span class="p">,</span> <span class="n">Psi4Mol</span><span class="p">,</span> <span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
 1046     <span class="sd">&quot;&quot;&quot;Calculate single point energy using Psi4.&quot;&quot;&quot;</span>
 1047     
 1048     <span class="n">Status</span> <span class="o">=</span> <span class="bp">False</span>
 1049     <span class="n">Energy</span> <span class="o">=</span> <span class="bp">None</span>
 1050     
 1051     <span class="c1">#  Setup reference wave function...</span>
 1052     <span class="n">Reference</span> <span class="o">=</span> <span class="n">SetupReferenceWavefunction</span><span class="p">(</span><span class="n">Mol</span><span class="p">)</span>
 1053     <span class="n">Psi4Handle</span><span class="o">.</span><span class="n">set_options</span><span class="p">({</span><span class="s1">&#39;Reference&#39;</span><span class="p">:</span> <span class="n">Reference</span><span class="p">})</span>
 1054     
 1055     <span class="c1"># Setup method name and basis set...</span>
 1056     <span class="n">MethodName</span><span class="p">,</span> <span class="n">BasisSet</span> <span class="o">=</span> <span class="n">SetupMethodNameAndBasisSet</span><span class="p">(</span><span class="n">Mol</span><span class="p">)</span>
 1057     
 1058     <span class="n">Status</span><span class="p">,</span> <span class="n">Energy</span> <span class="o">=</span> <span class="n">Psi4Util</span><span class="o">.</span><span class="n">CalculateSinglePointEnergy</span><span class="p">(</span><span class="n">Psi4Handle</span><span class="p">,</span> <span class="n">Psi4Mol</span><span class="p">,</span> <span class="n">MethodName</span><span class="p">,</span> <span class="n">BasisSet</span><span class="p">,</span> <span class="n">Quiet</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">])</span>
 1059     
 1060     <span class="c1"># Convert energy units...</span>
 1061     <span class="k">if</span> <span class="n">Status</span><span class="p">:</span>
 1062         <span class="k">if</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;ApplyEnergyConversionFactor&quot;</span><span class="p">]:</span>
 1063             <span class="n">Energy</span> <span class="o">=</span> <span class="n">Energy</span> <span class="o">*</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;EnergyConversionFactor&quot;</span><span class="p">]</span>
 1064 
 1065     <span class="c1"># Clean up</span>
 1066     <span class="n">PerformPsi4Cleanup</span><span class="p">(</span><span class="n">Psi4Handle</span><span class="p">)</span>
 1067     
 1068     <span class="k">return</span> <span class="p">(</span><span class="n">Status</span><span class="p">,</span> <span class="n">Energy</span><span class="p">)</span>
 1069 
 1070 <span class="k">def</span> <span class="nf">SetupConstrainedAtomIndicesForPsi4</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">RefMolCore</span><span class="p">,</span> <span class="n">RefMolMatches</span><span class="p">,</span> <span class="n">ConstrainHydrogens</span> <span class="o">=</span> <span class="bp">False</span><span class="p">):</span>
 1071     <span class="sd">&quot;&quot;&quot;Setup a list of atom indices to be constrained during Psi4 minimizaiton.&quot;&quot;&quot;</span>
 1072 
 1073     <span class="n">AtomIndices</span> <span class="o">=</span> <span class="p">[]</span>
 1074 
 1075     <span class="k">if</span> <span class="n">RefMolMatches</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
 1076         <span class="n">ConstrainAtomIndices</span> <span class="o">=</span> <span class="n">Mol</span><span class="o">.</span><span class="n">GetSubstructMatch</span><span class="p">(</span><span class="n">RefMolCore</span><span class="p">)</span>
 1077     <span class="k">else</span><span class="p">:</span>
 1078         <span class="n">ConstrainAtomIndices</span> <span class="o">=</span> <span class="n">RefMolMatches</span>
 1079         
 1080     <span class="c1"># Collect matched heavy atoms along with attached hydrogens...</span>
 1081     <span class="k">for</span> <span class="n">AtomIndex</span> <span class="ow">in</span> <span class="n">ConstrainAtomIndices</span><span class="p">:</span>
 1082         <span class="n">Atom</span> <span class="o">=</span> <span class="n">Mol</span><span class="o">.</span><span class="n">GetAtomWithIdx</span><span class="p">(</span><span class="n">AtomIndex</span><span class="p">)</span>
 1083         <span class="k">if</span> <span class="n">Atom</span><span class="o">.</span><span class="n">GetAtomicNum</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
 1084             <span class="k">continue</span>
 1085         
 1086         <span class="n">AtomIndices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">AtomIndex</span><span class="p">)</span>
 1087         <span class="k">for</span> <span class="n">AtomNbr</span> <span class="ow">in</span> <span class="n">Atom</span><span class="o">.</span><span class="n">GetNeighbors</span><span class="p">():</span>
 1088             <span class="k">if</span> <span class="n">AtomNbr</span><span class="o">.</span><span class="n">GetAtomicNum</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
 1089                 <span class="k">if</span> <span class="n">ConstrainHydrogens</span><span class="p">:</span>
 1090                     <span class="n">AtomNbrIndex</span> <span class="o">=</span> <span class="n">AtomNbr</span><span class="o">.</span><span class="n">GetIdx</span><span class="p">()</span>
 1091                     <span class="n">AtomIndices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">AtomNbrIndex</span><span class="p">)</span>
 1092     
 1093     <span class="n">AtomIndices</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">AtomIndices</span><span class="p">)</span>
 1094 
 1095     <span class="c1"># Atom indices start from 1 for Psi4 instead 0 for RDKit...</span>
 1096     <span class="n">AtomIndices</span> <span class="o">=</span> <span class="p">[</span> <span class="n">AtomIndex</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">AtomIndex</span> <span class="ow">in</span> <span class="n">AtomIndices</span><span class="p">]</span>
 1097     
 1098     <span class="k">return</span> <span class="n">AtomIndices</span>
 1099     
 1100 <span class="k">def</span> <span class="nf">SetupPsi4Mol</span><span class="p">(</span><span class="n">Psi4Handle</span><span class="p">,</span> <span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">,</span> <span class="n">ConfID</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
 1101     <span class="sd">&quot;&quot;&quot;Setup a Psi4 molecule object.&quot;&quot;&quot;</span>
 1102 
 1103     <span class="c1"># Turn off recentering and reorientation to perform optimization in the</span>
 1104     <span class="c1"># constrained coordinate space...</span>
 1105     <span class="n">MolGeometry</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">GetPsi4XYZFormatString</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">ConfID</span> <span class="o">=</span> <span class="n">ConfID</span><span class="p">,</span> <span class="n">NoCom</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">NoReorient</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
 1106 
 1107     <span class="k">try</span><span class="p">:</span>
 1108         <span class="n">Psi4Mol</span> <span class="o">=</span> <span class="n">Psi4Handle</span><span class="o">.</span><span class="n">geometry</span><span class="p">(</span><span class="n">MolGeometry</span><span class="p">)</span>
 1109     <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ErrMsg</span><span class="p">:</span>
 1110         <span class="n">Psi4Mol</span> <span class="o">=</span> <span class="bp">None</span>
 1111         <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]:</span>
 1112             <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintWarning</span><span class="p">(</span><span class="s2">&quot;Failed to create Psi4 molecule from geometry string: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">ErrMsg</span><span class="p">)</span>
 1113             <span class="n">MolName</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">GetMolName</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">)</span>
 1114             <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintWarning</span><span class="p">(</span><span class="s2">&quot;Ignoring molecule: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">MolName</span><span class="p">)</span>
 1115 
 1116     <span class="k">return</span> <span class="n">Psi4Mol</span>
 1117 
 1118 <span class="k">def</span> <span class="nf">PerformPsi4Cleanup</span><span class="p">(</span><span class="n">Psi4Handle</span><span class="p">):</span>
 1119     <span class="sd">&quot;&quot;&quot;Perform clean up.&quot;&quot;&quot;</span>
 1120 
 1121     <span class="c1"># No need to perform any explicit clean by calling</span>
 1122     <span class="c1"># Psi4Handle.core.opt_clean(). It&#39;s already done by Psi4 after</span>
 1123     <span class="c1"># optimization...</span>
 1124     
 1125     <span class="c1"># Clean up any leftover scratch files...</span>
 1126     <span class="k">if</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;MPMode&quot;</span><span class="p">]:</span>
 1127         <span class="n">Psi4Util</span><span class="o">.</span><span class="n">RemoveScratchFiles</span><span class="p">(</span><span class="n">Psi4Handle</span><span class="p">,</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Psi4RunParams&quot;</span><span class="p">][</span><span class="s2">&quot;OutputFile&quot;</span><span class="p">])</span>
 1128 
 1129 <span class="k">def</span> <span class="nf">CheckAndValidateMolecule</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolCount</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
 1130     <span class="sd">&quot;&quot;&quot;Validate molecule for Psi4 calculations.&quot;&quot;&quot;</span>
 1131     
 1132     <span class="k">if</span> <span class="n">Mol</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
 1133         <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]:</span>
 1134             <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Processing molecule number </span><span class="si">%s</span><span class="s2">...&quot;</span> <span class="o">%</span> <span class="n">MolCount</span><span class="p">)</span>
 1135         <span class="k">return</span> <span class="bp">False</span>
 1136     
 1137     <span class="n">MolName</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">GetMolName</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolCount</span><span class="p">)</span>
 1138     <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]:</span>
 1139         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Processing molecule </span><span class="si">%s</span><span class="s2">...&quot;</span> <span class="o">%</span> <span class="n">MolName</span><span class="p">)</span>
 1140     
 1141     <span class="k">if</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">IsMolEmpty</span><span class="p">(</span><span class="n">Mol</span><span class="p">):</span>
 1142         <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]:</span>
 1143             <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintWarning</span><span class="p">(</span><span class="s2">&quot;Ignoring empty molecule: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">MolName</span><span class="p">)</span>
 1144         <span class="k">return</span> <span class="bp">False</span>
 1145     
 1146     <span class="k">if</span> <span class="ow">not</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">ValidateElementSymbols</span><span class="p">(</span><span class="n">RDKitUtil</span><span class="o">.</span><span class="n">GetAtomSymbols</span><span class="p">(</span><span class="n">Mol</span><span class="p">)):</span>
 1147         <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]:</span>
 1148             <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintWarning</span><span class="p">(</span><span class="s2">&quot;Ignoring molecule containing invalid element symbols: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">MolName</span><span class="p">)</span>
 1149         <span class="k">return</span> <span class="bp">False</span>
 1150 
 1151     <span class="k">if</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Infile3D&quot;</span><span class="p">]:</span>
 1152         <span class="k">if</span> <span class="ow">not</span> <span class="n">Mol</span><span class="o">.</span><span class="n">GetConformer</span><span class="p">()</span><span class="o">.</span><span class="n">Is3D</span><span class="p">():</span>
 1153             <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]:</span>
 1154                 <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintWarning</span><span class="p">(</span><span class="s2">&quot;3D tag is not set for molecule: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">MolName</span><span class="p">)</span>
 1155     
 1156     <span class="k">if</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Infile3D&quot;</span><span class="p">]:</span>
 1157         <span class="c1"># Otherwise, Hydrogens are always added...</span>
 1158         <span class="k">if</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">AreHydrogensMissingInMolecule</span><span class="p">(</span><span class="n">Mol</span><span class="p">):</span>
 1159             <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]:</span>
 1160                 <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintWarning</span><span class="p">(</span><span class="s2">&quot;Missing hydrogens in molecule: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">MolName</span><span class="p">)</span>
 1161         
 1162     <span class="k">return</span> <span class="bp">True</span>
 1163 
 1164 <span class="k">def</span> <span class="nf">SetupMethodNameAndBasisSet</span><span class="p">(</span><span class="n">Mol</span><span class="p">):</span>
 1165     <span class="sd">&quot;&quot;&quot;Setup method name and basis set.&quot;&quot;&quot;</span>
 1166     
 1167     <span class="n">MethodName</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;MethodName&quot;</span><span class="p">]</span>
 1168     <span class="k">if</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;MethodNameAuto&quot;</span><span class="p">]:</span>
 1169         <span class="n">MethodName</span> <span class="o">=</span> <span class="s2">&quot;B3LYP&quot;</span>
 1170     
 1171     <span class="n">BasisSet</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;BasisSet&quot;</span><span class="p">]</span>
 1172     <span class="k">if</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;BasisSetAuto&quot;</span><span class="p">]:</span>
 1173         <span class="n">BasisSet</span> <span class="o">=</span> <span class="s2">&quot;6-31+G**&quot;</span> <span class="k">if</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">IsAtomSymbolPresentInMol</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="s2">&quot;S&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;6-31G**&quot;</span>
 1174     
 1175     <span class="k">return</span> <span class="p">(</span><span class="n">MethodName</span><span class="p">,</span> <span class="n">BasisSet</span><span class="p">)</span>
 1176 
 1177 <span class="k">def</span> <span class="nf">SetupReferenceWavefunction</span><span class="p">(</span><span class="n">Mol</span><span class="p">):</span>
 1178     <span class="sd">&quot;&quot;&quot;Setup reference wavefunction.&quot;&quot;&quot;</span>
 1179     
 1180     <span class="n">Reference</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Reference&quot;</span><span class="p">]</span>
 1181     <span class="k">if</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;ReferenceAuto&quot;</span><span class="p">]:</span>
 1182         <span class="n">Reference</span> <span class="o">=</span> <span class="s1">&#39;UHF&#39;</span> <span class="k">if</span> <span class="p">(</span><span class="n">RDKitUtil</span><span class="o">.</span><span class="n">GetSpinMultiplicity</span><span class="p">(</span><span class="n">Mol</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;RHF&#39;</span>
 1183     
 1184     <span class="k">return</span> <span class="n">Reference</span>
 1185 
 1186 <span class="k">def</span> <span class="nf">SetupEnergyConversionFactor</span><span class="p">(</span><span class="n">Psi4Handle</span><span class="p">):</span>
 1187     <span class="sd">&quot;&quot;&quot;Setup converstion factor for energt units. The Psi4 energy units are Hartrees.&quot;&quot;&quot;</span>
 1188     
 1189     <span class="n">EnergyUnits</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;EnergyUnits&quot;</span><span class="p">]</span>
 1190     
 1191     <span class="n">ApplyConversionFactor</span> <span class="o">=</span> <span class="bp">True</span>
 1192     <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^kcal\/mol$&quot;</span><span class="p">,</span> <span class="n">EnergyUnits</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
 1193         <span class="n">ConversionFactor</span> <span class="o">=</span> <span class="n">Psi4Handle</span><span class="o">.</span><span class="n">constants</span><span class="o">.</span><span class="n">hartree2kcalmol</span>
 1194     <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^kJ\/mol$&quot;</span><span class="p">,</span> <span class="n">EnergyUnits</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
 1195         <span class="n">ConversionFactor</span> <span class="o">=</span> <span class="n">Psi4Handle</span><span class="o">.</span><span class="n">constants</span><span class="o">.</span><span class="n">hartree2kJmol</span>
 1196     <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^eV$&quot;</span><span class="p">,</span> <span class="n">EnergyUnits</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
 1197         <span class="n">ConversionFactor</span> <span class="o">=</span> <span class="n">Psi4Handle</span><span class="o">.</span><span class="n">constants</span><span class="o">.</span><span class="n">hartree2ev</span>
 1198     <span class="k">else</span><span class="p">:</span>
 1199         <span class="n">ApplyConversionFactor</span> <span class="o">=</span> <span class="bp">False</span>
 1200         <span class="n">ConversionFactor</span> <span class="o">=</span> <span class="mf">1.0</span>
 1201     
 1202     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;ApplyEnergyConversionFactor&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ApplyConversionFactor</span>
 1203     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;EnergyConversionFactor&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ConversionFactor</span>
 1204 
 1205 <span class="k">def</span> <span class="nf">GenerateStartingTorsionScanStructureOutfile</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">):</span>
 1206     <span class="sd">&quot;&quot;&quot;Write out the structure of molecule used for starting tosion scan.&quot;&quot;&quot;</span>
 1207     
 1208     <span class="n">FileDir</span><span class="p">,</span> <span class="n">FileName</span><span class="p">,</span> <span class="n">FileExt</span> <span class="o">=</span> <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ParseFileName</span><span class="p">(</span><span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--outfile&quot;</span><span class="p">])</span>
 1209     <span class="n">MolName</span> <span class="o">=</span> <span class="n">GetOutputFileMolName</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">)</span>
 1210     
 1211     <span class="n">Outfile</span>  <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_</span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">FileName</span><span class="p">,</span> <span class="n">MolName</span><span class="p">,</span> <span class="n">FileExt</span><span class="p">)</span>
 1212     
 1213     <span class="c1"># Set up a molecule writer...</span>
 1214     <span class="n">Writer</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">MoleculesWriter</span><span class="p">(</span><span class="n">Outfile</span><span class="p">,</span> <span class="o">**</span><span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;OutfileParams&quot;</span><span class="p">])</span>
 1215     <span class="k">if</span> <span class="n">Writer</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
 1216         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintWarning</span><span class="p">(</span><span class="s2">&quot;Failed to setup a writer for output fie </span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="n">Outfile</span><span class="p">)</span>
 1217         <span class="k">return</span>
 1218     
 1219     <span class="n">Writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">Mol</span><span class="p">)</span>
 1220     
 1221     <span class="k">if</span> <span class="n">Writer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
 1222         <span class="n">Writer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
 1223 
 1224 <span class="k">def</span> <span class="nf">GenerateOutputFiles</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">,</span> <span class="n">TorsionID</span><span class="p">,</span> <span class="n">TorsionMatchNum</span><span class="p">,</span> <span class="n">TorsionMols</span><span class="p">,</span> <span class="n">TorsionEnergies</span><span class="p">,</span> <span class="n">TorsionAngles</span><span class="p">):</span>
 1225     <span class="sd">&quot;&quot;&quot;Generate output files.&quot;&quot;&quot;</span>
 1226     
 1227     <span class="n">StructureOutfile</span><span class="p">,</span> <span class="n">EnergyTextOutfile</span><span class="p">,</span> <span class="n">PlotOutfile</span> <span class="o">=</span> <span class="n">SetupOutputFileNames</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">,</span> <span class="n">TorsionID</span><span class="p">,</span> <span class="n">TorsionMatchNum</span><span class="p">)</span>
 1228     
 1229     <span class="n">GenerateScannedTorsionsStructureOutfile</span><span class="p">(</span><span class="n">StructureOutfile</span><span class="p">,</span> <span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">,</span> <span class="n">TorsionID</span><span class="p">,</span> <span class="n">TorsionMatchNum</span><span class="p">,</span> <span class="n">TorsionMols</span><span class="p">,</span> <span class="n">TorsionEnergies</span><span class="p">,</span> <span class="n">TorsionAngles</span><span class="p">)</span>
 1230     <span class="n">GenerateEnergyTextOutfile</span><span class="p">(</span><span class="n">EnergyTextOutfile</span><span class="p">,</span> <span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">,</span> <span class="n">TorsionID</span><span class="p">,</span> <span class="n">TorsionMatchNum</span><span class="p">,</span> <span class="n">TorsionMols</span><span class="p">,</span> <span class="n">TorsionEnergies</span><span class="p">,</span> <span class="n">TorsionAngles</span><span class="p">)</span>
 1231     <span class="n">GeneratePlotOutfile</span><span class="p">(</span><span class="n">PlotOutfile</span><span class="p">,</span> <span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">,</span> <span class="n">TorsionID</span><span class="p">,</span> <span class="n">TorsionMatchNum</span><span class="p">,</span> <span class="n">TorsionMols</span><span class="p">,</span> <span class="n">TorsionEnergies</span><span class="p">,</span> <span class="n">TorsionAngles</span><span class="p">)</span>
 1232 
 1233 <span class="k">def</span> <span class="nf">GenerateScannedTorsionsStructureOutfile</span><span class="p">(</span><span class="n">Outfile</span><span class="p">,</span> <span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">,</span> <span class="n">TorsionID</span><span class="p">,</span> <span class="n">TorsionMatchNum</span><span class="p">,</span> <span class="n">TorsionMols</span><span class="p">,</span> <span class="n">TorsionEnergies</span><span class="p">,</span> <span class="n">TorsionAngles</span><span class="p">):</span>
 1234     <span class="sd">&quot;&quot;&quot;Write out structures generated after torsion scan along with associated data.&quot;&quot;&quot;</span>
 1235 
 1236     <span class="c1"># Set up a molecule writer...</span>
 1237     <span class="n">Writer</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">MoleculesWriter</span><span class="p">(</span><span class="n">Outfile</span><span class="p">,</span> <span class="o">**</span><span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;OutfileParams&quot;</span><span class="p">])</span>
 1238     <span class="k">if</span> <span class="n">Writer</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
 1239         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintWarning</span><span class="p">(</span><span class="s2">&quot;Failed to setup a writer for output fie </span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="n">Outfile</span><span class="p">)</span>
 1240         <span class="k">return</span>
 1241     
 1242     <span class="n">MolName</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">GetMolName</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">)</span>
 1243     
 1244     <span class="n">RelativeTorsionEnergies</span> <span class="o">=</span> <span class="n">SetupRelativeEnergies</span><span class="p">(</span><span class="n">TorsionEnergies</span><span class="p">)</span>
 1245     <span class="k">for</span> <span class="n">Index</span><span class="p">,</span> <span class="n">TorsionMol</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">TorsionMols</span><span class="p">):</span>
 1246         <span class="n">TorsionAngle</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">TorsionAngles</span><span class="p">[</span><span class="n">Index</span><span class="p">]</span>
 1247         <span class="n">TorsionMol</span><span class="o">.</span><span class="n">SetProp</span><span class="p">(</span><span class="s2">&quot;Torsion_Angle&quot;</span><span class="p">,</span> <span class="n">TorsionAngle</span><span class="p">)</span>
 1248         
 1249         <span class="n">TorsionEnergy</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%.*f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Precision&quot;</span><span class="p">],</span> <span class="n">TorsionEnergies</span><span class="p">[</span><span class="n">Index</span><span class="p">])</span>
 1250         <span class="n">TorsionMol</span><span class="o">.</span><span class="n">SetProp</span><span class="p">(</span><span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;EnergyDataFieldLabel&quot;</span><span class="p">],</span> <span class="n">TorsionEnergy</span><span class="p">)</span>
 1251 
 1252         <span class="n">RelativeTorsionEnergy</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%.*f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Precision&quot;</span><span class="p">],</span> <span class="n">RelativeTorsionEnergies</span><span class="p">[</span><span class="n">Index</span><span class="p">])</span>
 1253         <span class="n">TorsionMol</span><span class="o">.</span><span class="n">SetProp</span><span class="p">(</span><span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;EnergyRelativeDataFieldLabel&quot;</span><span class="p">],</span> <span class="n">RelativeTorsionEnergy</span><span class="p">)</span>
 1254 
 1255         <span class="n">TorsionMolName</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_Deg</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">MolName</span><span class="p">,</span> <span class="n">TorsionAngle</span><span class="p">)</span>
 1256         <span class="n">TorsionMol</span><span class="o">.</span><span class="n">SetProp</span><span class="p">(</span><span class="s2">&quot;_Name&quot;</span><span class="p">,</span> <span class="n">TorsionMolName</span><span class="p">)</span>
 1257         
 1258         <span class="n">Writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">TorsionMol</span><span class="p">)</span>
 1259         
 1260     <span class="k">if</span> <span class="n">Writer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
 1261         <span class="n">Writer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
 1262     
 1263 <span class="k">def</span> <span class="nf">GenerateEnergyTextOutfile</span><span class="p">(</span><span class="n">Outfile</span><span class="p">,</span> <span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">,</span> <span class="n">TorsionID</span><span class="p">,</span> <span class="n">TorsionMatchNum</span><span class="p">,</span> <span class="n">TorsionMols</span><span class="p">,</span> <span class="n">TorsionEnergies</span><span class="p">,</span> <span class="n">TorsionAngles</span><span class="p">):</span>
 1264     <span class="sd">&quot;&quot;&quot;Write out torsion angles and energies.&quot;&quot;&quot;</span>
 1265 
 1266     <span class="c1"># Setup a writer...</span>
 1267     <span class="n">Writer</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">Outfile</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
 1268     <span class="k">if</span> <span class="n">Writer</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
 1269         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintError</span><span class="p">(</span><span class="s2">&quot;Failed to setup a writer for output fie </span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="n">Outfile</span><span class="p">)</span>
 1270 
 1271     <span class="c1"># Write headers...</span>
 1272     <span class="n">Writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;TorsionAngle,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;EnergyDataFieldLabel&quot;</span><span class="p">],</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;EnergyRelativeDataFieldLabel&quot;</span><span class="p">]))</span>
 1273 
 1274     <span class="n">RelativeTorsionEnergies</span> <span class="o">=</span> <span class="n">SetupRelativeEnergies</span><span class="p">(</span><span class="n">TorsionEnergies</span><span class="p">)</span>
 1275     <span class="k">for</span> <span class="n">Index</span><span class="p">,</span> <span class="n">TorsionAngle</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">TorsionAngles</span><span class="p">):</span>
 1276         <span class="n">TorsionEnergy</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%.*f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Precision&quot;</span><span class="p">],</span> <span class="n">TorsionEnergies</span><span class="p">[</span><span class="n">Index</span><span class="p">])</span>
 1277         <span class="n">RelativeTorsionEnergy</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%.*f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Precision&quot;</span><span class="p">],</span> <span class="n">RelativeTorsionEnergies</span><span class="p">[</span><span class="n">Index</span><span class="p">])</span>
 1278         <span class="n">Writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">TorsionAngle</span><span class="p">,</span> <span class="n">TorsionEnergy</span><span class="p">,</span> <span class="n">RelativeTorsionEnergy</span><span class="p">))</span>
 1279 
 1280     <span class="k">if</span> <span class="n">Writer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
 1281         <span class="n">Writer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
 1282     
 1283 <span class="k">def</span> <span class="nf">GeneratePlotOutfile</span><span class="p">(</span><span class="n">Outfile</span><span class="p">,</span> <span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">,</span> <span class="n">TorsionID</span><span class="p">,</span> <span class="n">TorsionMatchNum</span><span class="p">,</span> <span class="n">TorsionMols</span><span class="p">,</span> <span class="n">TorsionEnergies</span><span class="p">,</span> <span class="n">TorsionAngles</span><span class="p">):</span>
 1284     <span class="sd">&quot;&quot;&quot;Generate a plot corresponding to torsion angles and energies.&quot;&quot;&quot;</span>
 1285 
 1286     <span class="n">OutPlotParams</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;OutPlotParams&quot;</span><span class="p">]</span>
 1287 
 1288     <span class="c1"># Initialize seaborn and matplotlib paramaters...</span>
 1289     <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;OutPlotInitialized&quot;</span><span class="p">]:</span>
 1290         <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;OutPlotInitialized&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
 1291         <span class="n">RCParams</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;figure.figsize&quot;</span><span class="p">:(</span><span class="n">OutPlotParams</span><span class="p">[</span><span class="s2">&quot;Width&quot;</span><span class="p">],</span> <span class="n">OutPlotParams</span><span class="p">[</span><span class="s2">&quot;Height&quot;</span><span class="p">]),</span>
 1292                     <span class="s2">&quot;axes.titleweight&quot;</span><span class="p">:</span> <span class="n">OutPlotParams</span><span class="p">[</span><span class="s2">&quot;TitleWeight&quot;</span><span class="p">],</span>
 1293                     <span class="s2">&quot;axes.labelweight&quot;</span><span class="p">:</span> <span class="n">OutPlotParams</span><span class="p">[</span><span class="s2">&quot;LabelWeight&quot;</span><span class="p">]}</span>
 1294         <span class="n">sns</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">context</span> <span class="o">=</span> <span class="n">OutPlotParams</span><span class="p">[</span><span class="s2">&quot;Context&quot;</span><span class="p">],</span> <span class="n">style</span> <span class="o">=</span> <span class="n">OutPlotParams</span><span class="p">[</span><span class="s2">&quot;Style&quot;</span><span class="p">],</span> <span class="n">palette</span> <span class="o">=</span> <span class="n">OutPlotParams</span><span class="p">[</span><span class="s2">&quot;Palette&quot;</span><span class="p">],</span> <span class="n">font</span> <span class="o">=</span> <span class="n">OutPlotParams</span><span class="p">[</span><span class="s2">&quot;Font&quot;</span><span class="p">],</span> <span class="n">font_scale</span> <span class="o">=</span> <span class="n">OutPlotParams</span><span class="p">[</span><span class="s2">&quot;FontScale&quot;</span><span class="p">],</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">RCParams</span><span class="p">)</span>
 1295 
 1296     <span class="c1"># Create a new figure...</span>
 1297     <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
 1298 
 1299     <span class="k">if</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;OutPlotRelativeEnergy&quot;</span><span class="p">]:</span> 
 1300         <span class="n">TorsionEnergies</span> <span class="o">=</span> <span class="n">SetupRelativeEnergies</span><span class="p">(</span><span class="n">TorsionEnergies</span><span class="p">)</span>
 1301     
 1302     <span class="c1"># Draw plot...</span>
 1303     <span class="n">PlotType</span> <span class="o">=</span> <span class="n">OutPlotParams</span><span class="p">[</span><span class="s2">&quot;Type&quot;</span><span class="p">]</span>
 1304     <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;linepoint&quot;</span><span class="p">,</span> <span class="n">PlotType</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
 1305         <span class="n">Axis</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">TorsionAngles</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">TorsionEnergies</span><span class="p">,</span> <span class="n">marker</span> <span class="o">=</span> <span class="s2">&quot;o&quot;</span><span class="p">,</span>  <span class="n">legend</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span>
 1306     <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;scatter&quot;</span><span class="p">,</span> <span class="n">PlotType</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
 1307         <span class="n">Axis</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">TorsionAngles</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">TorsionEnergies</span><span class="p">,</span> <span class="n">legend</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span>
 1308     <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;line&quot;</span><span class="p">,</span> <span class="n">PlotType</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
 1309         <span class="n">Axis</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">TorsionAngles</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">TorsionEnergies</span><span class="p">,</span> <span class="n">legend</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span>
 1310     <span class="k">else</span><span class="p">:</span>
 1311         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintError</span><span class="p">(</span><span class="s2">&quot;The value, </span><span class="si">%s</span><span class="s2">, specified for </span><span class="se">\&quot;</span><span class="s2">type</span><span class="se">\&quot;</span><span class="s2"> using option </span><span class="se">\&quot;</span><span class="s2">--outPlotParams</span><span class="se">\&quot;</span><span class="s2"> is not supported. Valid plot types: linepoint, scatter or line&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">PlotType</span><span class="p">))</span>
 1312 
 1313     <span class="c1"># Setup title and labels...</span>
 1314     <span class="n">Title</span> <span class="o">=</span> <span class="n">OutPlotParams</span><span class="p">[</span><span class="s2">&quot;Title&quot;</span><span class="p">]</span>
 1315     <span class="k">if</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;OutPlotTitleTorsionSpec&quot;</span><span class="p">]:</span>
 1316         <span class="n">TorsionPattern</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;TorsionsPatternsInfo&quot;</span><span class="p">][</span><span class="s2">&quot;Pattern&quot;</span><span class="p">][</span><span class="n">TorsionID</span><span class="p">]</span>
 1317         <span class="n">Title</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">OutPlotParams</span><span class="p">[</span><span class="s2">&quot;Title&quot;</span><span class="p">],</span> <span class="n">TorsionPattern</span><span class="p">)</span>
 1318 
 1319     <span class="c1"># Set labels and title...</span>
 1320     <span class="n">Axis</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span> <span class="o">=</span> <span class="n">OutPlotParams</span><span class="p">[</span><span class="s2">&quot;XLabel&quot;</span><span class="p">],</span> <span class="n">ylabel</span> <span class="o">=</span> <span class="n">OutPlotParams</span><span class="p">[</span><span class="s2">&quot;YLabel&quot;</span><span class="p">],</span> <span class="n">title</span> <span class="o">=</span> <span class="n">Title</span><span class="p">)</span>
 1321     
 1322     <span class="c1"># Save figure...</span>
 1323     <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">Outfile</span><span class="p">)</span>
 1324 
 1325     <span class="c1"># Close the plot...</span>
 1326     <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
 1327 
 1328 <span class="k">def</span> <span class="nf">SetupRelativeEnergies</span><span class="p">(</span><span class="n">Energies</span><span class="p">):</span>
 1329     <span class="sd">&quot;&quot;&quot;Set up a list of relative energies.&quot;&quot;&quot;</span>
 1330     
 1331     <span class="n">SortedEnergies</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">Energies</span><span class="p">)</span>
 1332     <span class="n">MinEnergy</span> <span class="o">=</span> <span class="n">SortedEnergies</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
 1333     <span class="n">RelativeEnergies</span> <span class="o">=</span> <span class="p">[(</span><span class="n">Energy</span> <span class="o">-</span> <span class="n">MinEnergy</span><span class="p">)</span> <span class="k">for</span> <span class="n">Energy</span> <span class="ow">in</span> <span class="n">Energies</span><span class="p">]</span>
 1334 
 1335     <span class="k">return</span> <span class="n">RelativeEnergies</span>
 1336     
 1337 <span class="k">def</span> <span class="nf">SetupOutputFileNames</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">,</span> <span class="n">TorsionID</span><span class="p">,</span> <span class="n">TorsionMatchNum</span><span class="p">):</span>
 1338     <span class="sd">&quot;&quot;&quot;Setup names of output files.&quot;&quot;&quot;</span>
 1339     
 1340     <span class="n">FileDir</span><span class="p">,</span> <span class="n">FileName</span><span class="p">,</span> <span class="n">FileExt</span> <span class="o">=</span> <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ParseFileName</span><span class="p">(</span><span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--outfile&quot;</span><span class="p">])</span>
 1341     <span class="n">MolName</span> <span class="o">=</span> <span class="n">GetOutputFileMolName</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">)</span>
 1342     
 1343     <span class="n">OutfileRoot</span>  <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_</span><span class="si">%s</span><span class="s2">_Torsion</span><span class="si">%s</span><span class="s2">_Match</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">FileName</span><span class="p">,</span> <span class="n">MolName</span><span class="p">,</span> <span class="n">TorsionID</span><span class="p">,</span> <span class="n">TorsionMatchNum</span><span class="p">)</span>
 1344     
 1345     <span class="n">StructureOutfile</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">OutfileRoot</span><span class="p">,</span> <span class="n">FileExt</span><span class="p">)</span>
 1346     <span class="n">EnergyTextOutfile</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_Energies.csv&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">OutfileRoot</span><span class="p">)</span>
 1347     <span class="n">PlotExt</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;OutPlotParams&quot;</span><span class="p">][</span><span class="s2">&quot;OutExt&quot;</span><span class="p">]</span>
 1348     <span class="n">PlotOutfile</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_Plot.</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">OutfileRoot</span><span class="p">,</span> <span class="n">PlotExt</span><span class="p">)</span>
 1349 
 1350     <span class="k">return</span> <span class="p">(</span><span class="n">StructureOutfile</span><span class="p">,</span> <span class="n">EnergyTextOutfile</span><span class="p">,</span> <span class="n">PlotOutfile</span><span class="p">)</span>
 1351 
 1352 <span class="k">def</span> <span class="nf">GetOutputFileMolName</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">):</span>
 1353     <span class="sd">&quot;&quot;&quot;Get output file prefix.&quot;&quot;&quot;</span>
 1354     
 1355     <span class="n">MolName</span> <span class="o">=</span> <span class="s2">&quot;Mol</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">MolNum</span>
 1356     <span class="k">if</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;OutfileMolName&quot;</span><span class="p">]:</span>
 1357         <span class="n">MolName</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;[^a-zA-Z0-9]&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">GetMolName</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">),</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span>
 1358 
 1359     <span class="k">return</span> <span class="n">MolName</span>
 1360 
 1361 <span class="k">def</span> <span class="nf">ProcessOptions</span><span class="p">():</span>
 1362     <span class="sd">&quot;&quot;&quot;Process and validate command line arguments and options.&quot;&quot;&quot;</span>
 1363     
 1364     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;Processing options...&quot;</span><span class="p">)</span>
 1365 
 1366     <span class="c1"># Validate options...</span>
 1367     <span class="n">ValidateOptions</span><span class="p">()</span>
 1368 
 1369     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;ModeMols&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--modeMols&quot;</span><span class="p">]</span>
 1370     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;FirstMolMode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^First$&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--modeMols&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span> <span class="k">else</span> <span class="bp">False</span>
 1371     
 1372     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;ModeTorsions&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--modeTorsions&quot;</span><span class="p">]</span>
 1373     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;FirstTorsionMode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^First$&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--modeTorsions&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span> <span class="k">else</span> <span class="bp">False</span>
 1374     
 1375     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Infile&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--infile&quot;</span><span class="p">]</span>
 1376     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;SMILESInfileStatus&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span> <span class="k">if</span>  <span class="n">MiscUtil</span><span class="o">.</span><span class="n">CheckFileExt</span><span class="p">(</span><span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--infile&quot;</span><span class="p">],</span> <span class="s2">&quot;smi csv tsv txt&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="bp">False</span>
 1377     <span class="n">ParamsDefaultInfoOverride</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;RemoveHydrogens&quot;</span><span class="p">:</span> <span class="bp">False</span><span class="p">}</span>
 1378     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;InfileParams&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ProcessOptionInfileParameters</span><span class="p">(</span><span class="s2">&quot;--infileParams&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--infileParams&quot;</span><span class="p">],</span> <span class="n">InfileName</span> <span class="o">=</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--infile&quot;</span><span class="p">],</span> <span class="n">ParamsDefaultInfo</span> <span class="o">=</span> <span class="n">ParamsDefaultInfoOverride</span><span class="p">)</span>
 1379     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Infile3D&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^yes$&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--infile3D&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span> <span class="k">else</span> <span class="bp">False</span>
 1380     
 1381     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Outfile&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--outfile&quot;</span><span class="p">]</span>
 1382     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;OutfileParams&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ProcessOptionOutfileParameters</span><span class="p">(</span><span class="s2">&quot;--outfileParams&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--outfileParams&quot;</span><span class="p">])</span>
 1383     
 1384     <span class="c1"># Method, basis set, and reference wavefunction...</span>
 1385     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;BasisSet&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--basisSet&quot;</span><span class="p">]</span>
 1386     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;BasisSetAuto&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^auto$&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--basisSet&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span> <span class="k">else</span> <span class="bp">False</span>
 1387     
 1388     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;MethodName&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--methodName&quot;</span><span class="p">]</span>
 1389     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;MethodNameAuto&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^auto$&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--methodName&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span> <span class="k">else</span> <span class="bp">False</span>
 1390     
 1391     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Reference&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--reference&quot;</span><span class="p">]</span>
 1392     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;ReferenceAuto&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^auto$&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--reference&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span> <span class="k">else</span> <span class="bp">False</span>
 1393     
 1394     <span class="c1"># Run and options parameters...</span>
 1395     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Psi4OptionsParams&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Psi4Util</span><span class="o">.</span><span class="n">ProcessPsi4OptionsParameters</span><span class="p">(</span><span class="s2">&quot;--psi4OptionsParams&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--psi4OptionsParams&quot;</span><span class="p">])</span>
 1396     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Psi4RunParams&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Psi4Util</span><span class="o">.</span><span class="n">ProcessPsi4RunParameters</span><span class="p">(</span><span class="s2">&quot;--psi4RunParams&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--psi4RunParams&quot;</span><span class="p">],</span> <span class="n">InfileName</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Infile&quot;</span><span class="p">])</span>
 1397 
 1398     <span class="c1"># Conformer generation paramaters...</span>
 1399     <span class="n">ParamsDefaultInfoOverride</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;MaxConfs&quot;</span><span class="p">:</span> <span class="mi">250</span><span class="p">,</span> <span class="s2">&quot;MaxConfsTorsions&quot;</span><span class="p">:</span> <span class="mi">50</span><span class="p">}</span>
 1400     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;ConfGenerationParams&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ProcessOptionConformerParameters</span><span class="p">(</span><span class="s2">&quot;--confParams&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--confParams&quot;</span><span class="p">],</span> <span class="n">ParamsDefaultInfoOverride</span><span class="p">)</span>
 1401     
 1402     <span class="c1"># Energy units and label...</span>
 1403     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;EnergyUnits&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--energyUnits&quot;</span><span class="p">]</span>
 1404     
 1405     <span class="n">EnergyDataFieldLabel</span> <span class="o">=</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--energyDataFieldLabel&quot;</span><span class="p">]</span>
 1406     <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^auto$&quot;</span><span class="p">,</span> <span class="n">EnergyDataFieldLabel</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
 1407         <span class="n">EnergyDataFieldLabel</span> <span class="o">=</span> <span class="s2">&quot;Psi4_Energy (</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--energyUnits&quot;</span><span class="p">]</span>
 1408     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;EnergyDataFieldLabel&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">EnergyDataFieldLabel</span>
 1409     
 1410     <span class="n">EnergyRelativeDataFieldLabel</span> <span class="o">=</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--energyRelativeDataFieldLabel&quot;</span><span class="p">]</span>
 1411     <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^auto$&quot;</span><span class="p">,</span> <span class="n">EnergyRelativeDataFieldLabel</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
 1412         <span class="n">EnergyRelativeDataFieldLabel</span> <span class="o">=</span> <span class="s2">&quot;Psi4_Relative_Energy (</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--energyUnits&quot;</span><span class="p">]</span>
 1413     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;EnergyRelativeDataFieldLabel&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">EnergyRelativeDataFieldLabel</span>
 1414 
 1415     <span class="c1"># Plot parameters...</span>
 1416     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;OutfileMolName&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^yes$&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--outfileMolName&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span> <span class="k">else</span> <span class="bp">False</span>
 1417     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;OutPlotRelativeEnergy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^yes$&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--outPlotRelativeEnergy&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span> <span class="k">else</span> <span class="bp">False</span>
 1418     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;OutPlotTitleTorsionSpec&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^yes$&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--outPlotTitleTorsionSpec&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span> <span class="k">else</span> <span class="bp">False</span>
 1419     
 1420     <span class="c1"># The default width and height, 10.0 and 7.5, map to aspect raito of 16/9 (1.778)...</span>
 1421     <span class="k">if</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;OutPlotRelativeEnergy&quot;</span><span class="p">]:</span>
 1422         <span class="n">EnergyLabel</span> <span class="o">=</span> <span class="s2">&quot;Relative Energy (</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;EnergyUnits&quot;</span><span class="p">]</span>
 1423     <span class="k">else</span><span class="p">:</span>
 1424         <span class="n">EnergyLabel</span> <span class="o">=</span> <span class="s2">&quot;Energy (</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;EnergyUnits&quot;</span><span class="p">]</span>
 1425         
 1426     <span class="n">DefaultValues</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Type&#39;</span><span class="p">:</span> <span class="s1">&#39;linepoint&#39;</span><span class="p">,</span> <span class="s1">&#39;Width&#39;</span><span class="p">:</span> <span class="mf">10.0</span><span class="p">,</span> <span class="s1">&#39;Height&#39;</span><span class="p">:</span> <span class="mf">5.6</span><span class="p">,</span> <span class="s1">&#39;Title&#39;</span><span class="p">:</span> <span class="s1">&#39;Psi4 Torsion Scan&#39;</span><span class="p">,</span> <span class="s1">&#39;XLabel&#39;</span><span class="p">:</span> <span class="s1">&#39;Torsion Angle (degrees)&#39;</span><span class="p">,</span> <span class="s1">&#39;YLabel&#39;</span><span class="p">:</span> <span class="n">EnergyLabel</span><span class="p">}</span>
 1427     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;OutPlotParams&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ProcessOptionSeabornPlotParameters</span><span class="p">(</span><span class="s2">&quot;--outPlotParams&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--outPlotParams&quot;</span><span class="p">],</span> <span class="n">DefaultValues</span><span class="p">)</span>
 1428     <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^(linepoint|scatter|Line)$&quot;</span><span class="p">,</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;OutPlotParams&quot;</span><span class="p">][</span><span class="s2">&quot;Type&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
 1429         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintError</span><span class="p">(</span><span class="s2">&quot;The value, </span><span class="si">%s</span><span class="s2">, specified for </span><span class="se">\&quot;</span><span class="s2">type</span><span class="se">\&quot;</span><span class="s2"> using option </span><span class="se">\&quot;</span><span class="s2">--outPlotParams</span><span class="se">\&quot;</span><span class="s2"> is not supported. Valid plot types: linepoint, scatter or line&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;OutPlotParams&quot;</span><span class="p">][</span><span class="s2">&quot;Type&quot;</span><span class="p">]))</span>
 1430     
 1431     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;OutPlotInitialized&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
 1432     
 1433     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Overwrite&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--overwrite&quot;</span><span class="p">]</span>
 1434 
 1435     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;MaxIters&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--maxIters&quot;</span><span class="p">])</span>
 1436     
 1437     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;MPMode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^yes$&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--mp&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span> <span class="k">else</span> <span class="bp">False</span>
 1438     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;MPParams&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ProcessOptionMultiprocessingParameters</span><span class="p">(</span><span class="s2">&quot;--mpParams&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--mpParams&quot;</span><span class="p">])</span>
 1439     
 1440     <span class="c1"># Multiprocessing level...</span>
 1441     <span class="n">MPLevelMoleculesMode</span> <span class="o">=</span> <span class="bp">False</span>
 1442     <span class="n">MPLevelTorsionAnglesMode</span> <span class="o">=</span> <span class="bp">False</span>
 1443     <span class="n">MPLevel</span> <span class="o">=</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--mpLevel&quot;</span><span class="p">]</span>
 1444     <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^Molecules$&quot;</span><span class="p">,</span> <span class="n">MPLevel</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
 1445         <span class="n">MPLevelMoleculesMode</span> <span class="o">=</span> <span class="bp">True</span>
 1446     <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^TorsionAngles$&quot;</span><span class="p">,</span> <span class="n">MPLevel</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
 1447         <span class="n">MPLevelTorsionAnglesMode</span> <span class="o">=</span> <span class="bp">True</span>
 1448     <span class="k">else</span><span class="p">:</span>
 1449         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintError</span><span class="p">(</span><span class="s2">&quot;The value, </span><span class="si">%s</span><span class="s2">, specified for option </span><span class="se">\&quot;</span><span class="s2">--mpLevel</span><span class="se">\&quot;</span><span class="s2"> is not valid. &quot;</span> <span class="o">%</span> <span class="n">MPLevel</span><span class="p">)</span>
 1450     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;MPLevel&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">MPLevel</span>
 1451     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;MPLevelMoleculesMode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">MPLevelMoleculesMode</span>
 1452     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;MPLevelTorsionAnglesMode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">MPLevelTorsionAnglesMode</span>
 1453     
 1454     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Precision&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--precision&quot;</span><span class="p">])</span>
 1455     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^yes$&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--quiet&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span> <span class="k">else</span> <span class="bp">False</span>
 1456     
 1457     <span class="c1"># Procsss and validate specified SMILES/SMARTS torsion patterns...</span>
 1458     <span class="n">TorsionPatterns</span> <span class="o">=</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--torsions&quot;</span><span class="p">]</span>
 1459     <span class="n">TorsionPatternsList</span> <span class="o">=</span> <span class="p">[]</span>
 1460     <span class="k">for</span> <span class="n">TorsionPattern</span> <span class="ow">in</span> <span class="n">TorsionPatterns</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">):</span>
 1461         <span class="n">TorsionPattern</span> <span class="o">=</span> <span class="n">TorsionPattern</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
 1462         <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">TorsionPattern</span><span class="p">):</span>
 1463             <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintError</span><span class="p">(</span><span class="s2">&quot;Empty value specified for SMILES/SMARTS pattern in  </span><span class="se">\&quot;</span><span class="s2">-t, --torsions</span><span class="se">\&quot;</span><span class="s2"> option: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">TorsionPatterns</span><span class="p">)</span>
 1464         
 1465         <span class="n">TorsionMol</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">MolFromSmarts</span><span class="p">(</span><span class="n">TorsionPattern</span><span class="p">)</span>
 1466         <span class="k">if</span> <span class="n">TorsionMol</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
 1467             <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintError</span><span class="p">(</span><span class="s2">&quot;Failed to create torsion pattern molecule. The torsion SMILES/SMARTS pattern, </span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2">, specified using </span><span class="se">\&quot;</span><span class="s2">-t, --torsions</span><span class="se">\&quot;</span><span class="s2"> option, </span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2">,  is not valid.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">TorsionPattern</span><span class="p">,</span> <span class="n">TorsionPatterns</span><span class="p">))</span>
 1468         <span class="n">TorsionPatternsList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TorsionPattern</span><span class="p">)</span>
 1469     
 1470     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;TorsionPatterns&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">TorsionPatterns</span>
 1471     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;TorsionPatternsList&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">TorsionPatternsList</span>
 1472     
 1473     <span class="c1"># Process and validate any specified torsion atom indices for filtering torsion matches...</span>
 1474     <span class="n">TorsionsFilterByAtomIndices</span> <span class="o">=</span>  <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--torsionsFilterbyAtomIndices&quot;</span><span class="p">]</span>
 1475     <span class="n">TorsionsFilterByAtomIndicesList</span> <span class="o">=</span> <span class="p">[]</span>
 1476     <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^None$&quot;</span><span class="p">,</span> <span class="n">TorsionsFilterByAtomIndices</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
 1477         <span class="k">for</span> <span class="n">AtomIndex</span> <span class="ow">in</span> <span class="n">TorsionsFilterByAtomIndices</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">):</span>
 1478             <span class="n">AtomIndex</span> <span class="o">=</span> <span class="n">AtomIndex</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
 1479             <span class="k">if</span> <span class="ow">not</span> <span class="n">MiscUtil</span><span class="o">.</span><span class="n">IsInteger</span><span class="p">(</span><span class="n">AtomIndex</span><span class="p">):</span>
 1480                 <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintError</span><span class="p">(</span><span class="s2">&quot;The value specified, </span><span class="si">%s</span><span class="s2">, for option </span><span class="se">\&quot;</span><span class="s2">--torsionsFilterbyAtomIndices</span><span class="se">\&quot;</span><span class="s2"> must be an integer.&quot;</span> <span class="o">%</span> <span class="n">AtomIndex</span><span class="p">)</span>
 1481             <span class="n">AtomIndex</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">AtomIndex</span><span class="p">)</span>
 1482             <span class="k">if</span> <span class="n">AtomIndex</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
 1483                 <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintError</span><span class="p">(</span><span class="s2">&quot;The value specified, </span><span class="si">%s</span><span class="s2">, for option </span><span class="se">\&quot;</span><span class="s2">--torsionsFilterbyAtomIndices</span><span class="se">\&quot;</span><span class="s2"> must be &gt;= 0.&quot;</span> <span class="o">%</span> <span class="n">AtomIdex</span><span class="p">)</span>
 1484             <span class="n">TorsionsFilterByAtomIndicesList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">AtomIndex</span><span class="p">)</span>
 1485 
 1486         <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">TorsionsFilterByAtomIndicesList</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
 1487             <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintError</span><span class="p">(</span><span class="s2">&quot;The number of values, </span><span class="si">%s</span><span class="s2">,  specified, </span><span class="si">%s</span><span class="s2">, for option </span><span class="se">\&quot;</span><span class="s2">--torsionsFilterbyAtomIndices</span><span class="se">\&quot;</span><span class="s2"> must be &gt;=4.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">TorsionsFilterByAtomIndicesList</span><span class="p">),</span> <span class="n">TorsionsFilterByAtomIndices</span><span class="p">))</span>
 1488             
 1489     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;TorsionsFilterByAtomIndices&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">TorsionsFilterByAtomIndices</span>
 1490     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;TorsionsFilterByAtomIndicesList&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">TorsionsFilterByAtomIndicesList</span>
 1491     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;FilterTorsionsByAtomIndicesMode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">TorsionsFilterByAtomIndicesList</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="bp">False</span>
 1492     
 1493     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;TorsionMaxMatches&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--torsionMaxMatches&quot;</span><span class="p">])</span>
 1494     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;TorsionMinimize&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^yes$&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--torsionMinimize&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span> <span class="k">else</span> <span class="bp">False</span>
 1495 
 1496     <span class="n">TorsionRange</span> <span class="o">=</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--torsionRange&quot;</span><span class="p">]</span>
 1497     <span class="n">TorsionRangeWords</span> <span class="o">=</span> <span class="n">TorsionRange</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
 1498     
 1499     <span class="n">TorsionStart</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">TorsionRangeWords</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
 1500     <span class="n">TorsionStop</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">TorsionRangeWords</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
 1501     <span class="n">TorsionStep</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">TorsionRangeWords</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
 1502     
 1503     <span class="k">if</span> <span class="n">TorsionStart</span> <span class="o">&gt;=</span> <span class="n">TorsionStop</span><span class="p">:</span>
 1504         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintError</span><span class="p">(</span><span class="s2">&quot;The start value, </span><span class="si">%d</span><span class="s2">, specified for option </span><span class="se">\&quot;</span><span class="s2">--torsionRange</span><span class="se">\&quot;</span><span class="s2"> in string </span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2"> must be less than stop value, </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">TorsionStart</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--torsionRange&quot;</span><span class="p">],</span> <span class="n">TorsionStop</span><span class="p">))</span>
 1505     <span class="k">if</span> <span class="n">TorsionStep</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
 1506         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintError</span><span class="p">(</span><span class="s2">&quot;The step value, </span><span class="si">%d</span><span class="s2">, specified for option </span><span class="se">\&quot;</span><span class="s2">--torsonRange</span><span class="se">\&quot;</span><span class="s2"> in string </span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2"> must be &gt; 0.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">TorsionStep</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--torsionRange&quot;</span><span class="p">]))</span>
 1507     <span class="k">if</span> <span class="n">TorsionStep</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">TorsionStop</span> <span class="o">-</span> <span class="n">TorsionStart</span><span class="p">):</span>
 1508         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintError</span><span class="p">(</span><span class="s2">&quot;The step value, </span><span class="si">%d</span><span class="s2">, specified for option </span><span class="se">\&quot;</span><span class="s2">--torsonRange</span><span class="se">\&quot;</span><span class="s2"> in string </span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2"> must be less than, </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">TorsionStep</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--torsionRange&quot;</span><span class="p">],</span> <span class="p">(</span><span class="n">TorsionStop</span> <span class="o">-</span> <span class="n">TorsionStart</span><span class="p">)))</span>
 1509     
 1510     <span class="k">if</span> <span class="n">TorsionStart</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
 1511         <span class="k">if</span> <span class="n">TorsionStart</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">180</span><span class="p">:</span>
 1512             <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintError</span><span class="p">(</span><span class="s2">&quot;The start value, </span><span class="si">%d</span><span class="s2">, specified for option </span><span class="se">\&quot;</span><span class="s2">--torsionRange</span><span class="se">\&quot;</span><span class="s2"> in string </span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2"> must be  &gt;= -180 to use scan range from -180 to 180.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">TorsionStart</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--torsionRange&quot;</span><span class="p">]))</span>
 1513         <span class="k">if</span> <span class="n">TorsionStop</span> <span class="o">&gt;</span> <span class="mi">180</span><span class="p">:</span>
 1514             <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintError</span><span class="p">(</span><span class="s2">&quot;The stop value, </span><span class="si">%d</span><span class="s2">, specified for option </span><span class="se">\&quot;</span><span class="s2">--torsionRange</span><span class="se">\&quot;</span><span class="s2"> in string </span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2"> must be &lt;= 180 to use scan range from -180 to 180.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">TorsionStop</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--torsionRange&quot;</span><span class="p">]))</span>
 1515     <span class="k">else</span><span class="p">:</span>
 1516         <span class="k">if</span> <span class="n">TorsionStop</span> <span class="o">&gt;</span> <span class="mi">360</span><span class="p">:</span>
 1517             <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintError</span><span class="p">(</span><span class="s2">&quot;The stop value, </span><span class="si">%d</span><span class="s2">, specified for option </span><span class="se">\&quot;</span><span class="s2">--torsionRange</span><span class="se">\&quot;</span><span class="s2"> in string </span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2"> must be  &lt;= 360 to use scan range from 0 to 360.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">TorsionStop</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--torsionRange&quot;</span><span class="p">]))</span>
 1518     
 1519     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;TorsionRange&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">TorsionRange</span>
 1520     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;TorsionStart&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">TorsionStart</span>
 1521     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;TorsionStop&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">TorsionStop</span>
 1522     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;TorsionStep&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">TorsionStep</span>
 1523     
 1524     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;UseChirality&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^yes$&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--useChirality&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span> <span class="k">else</span> <span class="bp">False</span>
 1525     
 1526 <span class="k">def</span> <span class="nf">RetrieveOptions</span><span class="p">():</span>
 1527     <span class="sd">&quot;&quot;&quot;Retrieve command line arguments and options.&quot;&quot;&quot;</span>
 1528     
 1529     <span class="c1"># Get options...</span>
 1530     <span class="k">global</span> <span class="n">Options</span>
 1531     <span class="n">Options</span> <span class="o">=</span> <span class="n">docopt</span><span class="p">(</span><span class="n">_docoptUsage_</span><span class="p">)</span>
 1532     
 1533     <span class="c1"># Set current working directory to the specified directory...</span>
 1534     <span class="n">WorkingDir</span> <span class="o">=</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--workingdir&quot;</span><span class="p">]</span>
 1535     <span class="k">if</span> <span class="n">WorkingDir</span><span class="p">:</span>
 1536         <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">WorkingDir</span><span class="p">)</span>
 1537     
 1538     <span class="c1"># Handle examples option...</span>
 1539     <span class="k">if</span> <span class="s2">&quot;--examples&quot;</span> <span class="ow">in</span> <span class="n">Options</span> <span class="ow">and</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--examples&quot;</span><span class="p">]:</span>
 1540         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="n">MiscUtil</span><span class="o">.</span><span class="n">GetExamplesTextFromDocOptText</span><span class="p">(</span><span class="n">_docoptUsage_</span><span class="p">))</span>
 1541         <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
 1542 
 1543 <span class="k">def</span> <span class="nf">ValidateOptions</span><span class="p">():</span>
 1544     <span class="sd">&quot;&quot;&quot;Validate option values.&quot;&quot;&quot;</span>
 1545 
 1546     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ValidateOptionTextValue</span><span class="p">(</span><span class="s2">&quot;--energyUnits&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--energyUnits&quot;</span><span class="p">],</span> <span class="s2">&quot;Hartrees kcal/mol kJ/mol eV&quot;</span><span class="p">)</span>
 1547     
 1548     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ValidateOptionFilePath</span><span class="p">(</span><span class="s2">&quot;-i, --infile&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--infile&quot;</span><span class="p">])</span>
 1549     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ValidateOptionFileExt</span><span class="p">(</span><span class="s2">&quot;-i, --infile&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--infile&quot;</span><span class="p">],</span> <span class="s2">&quot;sdf sd mol smi txt csv tsv&quot;</span><span class="p">)</span>
 1550     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ValidateOptionTextValue</span><span class="p">(</span><span class="s2">&quot;--infile3D&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--infile3D&quot;</span><span class="p">],</span> <span class="s2">&quot;yes no&quot;</span><span class="p">)</span>
 1551 
 1552     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ValidateOptionFileExt</span><span class="p">(</span><span class="s2">&quot;-o, --outfile&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--outfile&quot;</span><span class="p">],</span> <span class="s2">&quot;sdf sd&quot;</span><span class="p">)</span>
 1553     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ValidateOptionsOutputFileOverwrite</span><span class="p">(</span><span class="s2">&quot;-o, --outfile&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--outfile&quot;</span><span class="p">],</span> <span class="s2">&quot;--overwrite&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--overwrite&quot;</span><span class="p">])</span>
 1554     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ValidateOptionsDistinctFileNames</span><span class="p">(</span><span class="s2">&quot;-i, --infile&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--infile&quot;</span><span class="p">],</span> <span class="s2">&quot;-o, --outfile&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--outfile&quot;</span><span class="p">])</span>
 1555     
 1556     <span class="k">if</span> <span class="ow">not</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--overwrite&quot;</span><span class="p">]:</span>
 1557         <span class="n">FileDir</span><span class="p">,</span> <span class="n">FileName</span><span class="p">,</span> <span class="n">FileExt</span> <span class="o">=</span> <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ParseFileName</span><span class="p">(</span><span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--outfile&quot;</span><span class="p">])</span>
 1558         <span class="n">FileNames</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_*&quot;</span> <span class="o">%</span> <span class="n">FileName</span><span class="p">)</span>
 1559         <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">FileNames</span><span class="p">):</span>
 1560             <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintError</span><span class="p">(</span><span class="s2">&quot;The outfile names, </span><span class="si">%s</span><span class="s2">_*, generated from file specified, </span><span class="si">%s</span><span class="s2">, for option </span><span class="se">\&quot;</span><span class="s2">-o, --outfile</span><span class="se">\&quot;</span><span class="s2"> already exist. Use option </span><span class="se">\&quot;</span><span class="s2">--overwrite</span><span class="se">\&quot;</span><span class="s2"> or </span><span class="se">\&quot;</span><span class="s2">--ov</span><span class="se">\&quot;</span><span class="s2">  and try again.</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">FileName</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--outfile&quot;</span><span class="p">]))</span>
 1561     
 1562     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ValidateOptionTextValue</span><span class="p">(</span><span class="s2">&quot;--outPlotRelativeEnergy&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--outPlotRelativeEnergy&quot;</span><span class="p">],</span> <span class="s2">&quot;yes no&quot;</span><span class="p">)</span>
 1563     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ValidateOptionTextValue</span><span class="p">(</span><span class="s2">&quot;--outPlotTitleTorsionSpec&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--outPlotTitleTorsionSpec&quot;</span><span class="p">],</span> <span class="s2">&quot;yes no&quot;</span><span class="p">)</span>
 1564     
 1565     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ValidateOptionTextValue</span><span class="p">(</span><span class="s2">&quot;--outfileMolName &quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--outfileMolName&quot;</span><span class="p">],</span> <span class="s2">&quot;yes no&quot;</span><span class="p">)</span>
 1566     
 1567     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ValidateOptionTextValue</span><span class="p">(</span><span class="s2">&quot;--modeMols&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--modeMols&quot;</span><span class="p">],</span> <span class="s2">&quot;First All&quot;</span><span class="p">)</span>
 1568     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ValidateOptionTextValue</span><span class="p">(</span><span class="s2">&quot;--modeTorsions&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--modeTorsions&quot;</span><span class="p">],</span> <span class="s2">&quot;First All&quot;</span><span class="p">)</span>
 1569     
 1570     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ValidateOptionIntegerValue</span><span class="p">(</span><span class="s2">&quot;--maxIters&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--maxIters&quot;</span><span class="p">],</span> <span class="p">{</span><span class="s2">&quot;&gt;&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span>
 1571     
 1572     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ValidateOptionTextValue</span><span class="p">(</span><span class="s2">&quot;--mp&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--mp&quot;</span><span class="p">],</span> <span class="s2">&quot;yes no&quot;</span><span class="p">)</span>
 1573     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ValidateOptionTextValue</span><span class="p">(</span><span class="s2">&quot;--mpLevel&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--mpLevel&quot;</span><span class="p">],</span> <span class="s2">&quot;Molecules TorsionAngles&quot;</span><span class="p">)</span>
 1574     
 1575     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ValidateOptionIntegerValue</span><span class="p">(</span><span class="s2">&quot;-p, --precision&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--precision&quot;</span><span class="p">],</span> <span class="p">{</span><span class="s2">&quot;&gt;&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span>
 1576     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ValidateOptionTextValue</span><span class="p">(</span><span class="s2">&quot;-q, --quiet&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--quiet&quot;</span><span class="p">],</span> <span class="s2">&quot;yes no&quot;</span><span class="p">)</span>
 1577     
 1578     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ValidateOptionIntegerValue</span><span class="p">(</span><span class="s2">&quot;--torsionMaxMatches&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--torsionMaxMatches&quot;</span><span class="p">],</span> <span class="p">{</span><span class="s2">&quot;&gt;&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span>
 1579     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ValidateOptionTextValue</span><span class="p">(</span><span class="s2">&quot;--torsionMinimize&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--torsionMinimize&quot;</span><span class="p">],</span> <span class="s2">&quot;yes no&quot;</span><span class="p">)</span>
 1580     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ValidateOptionNumberValues</span><span class="p">(</span><span class="s2">&quot;--torsionRange&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--torsionRange&quot;</span><span class="p">],</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="s2">&quot;integer&quot;</span><span class="p">,</span> <span class="p">{})</span>
 1581     
 1582     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ValidateOptionTextValue</span><span class="p">(</span><span class="s2">&quot;--useChirality&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--useChirality&quot;</span><span class="p">],</span> <span class="s2">&quot;yes no&quot;</span><span class="p">)</span>
 1583     
 1584 <span class="c1"># Setup a usage string for docopt...</span>
 1585 <span class="n">_docoptUsage_</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
 1586 <span class="s2">Psi4PerformTorsionScan.py - Perform torsion scan</span>
 1587 
 1588 <span class="s2">Usage:</span>
 1589 <span class="s2">    Psi4PerformTorsionScan.py [--basisSet &lt;text&gt;] [--confParams &lt;Name,Value,...&gt;] [--energyDataFieldLabel &lt;text&gt;]</span>
 1590 <span class="s2">                              [--energyRelativeDataFieldLabel &lt;text&gt;] [--energyUnits &lt;text&gt;] [--infile3D &lt;yes or no&gt;]</span>
 1591 <span class="s2">                              [--infileParams &lt;Name,Value,...&gt;] [--maxIters &lt;number&gt;] [--methodName &lt;text&gt;]</span>
 1592 <span class="s2">                              [--modeMols &lt;First or All&gt;] [--modeTorsions &lt;First or All&gt;] [--mp &lt;yes or no&gt;]</span>
 1593 <span class="s2">                              [--mpLevel &lt;Molecules or TorsionAngles&gt;] [--mpParams &lt;Name,Value,...&gt;]</span>
 1594 <span class="s2">                              [--outfileMolName &lt;yes or no&gt;] [--outfileParams &lt;Name,Value,...&gt;] [--outPlotParams &lt;Name,Value,...&gt;]</span>
 1595 <span class="s2">                              [--outPlotRelativeEnergy &lt;yes or no&gt;] [--outPlotTitleTorsionSpec &lt;yes or no&gt;] [--overwrite]</span>
 1596 <span class="s2">                              [--precision &lt;number&gt;] [--psi4OptionsParams &lt;Name,Value,...&gt;] [--psi4RunParams &lt;Name,Value,...&gt;]</span>
 1597 <span class="s2">                              [--quiet &lt;yes or no&gt;] [--reference &lt;text&gt;]  [--torsionsFilterbyAtomIndices &lt;Index1, Index2, ...&gt;]</span>
 1598 <span class="s2">                              [--torsionMaxMatches &lt;number&gt;] [--torsionMinimize &lt;yes or no&gt;] [--torsionRange &lt;Start,Stop,Step&gt;]</span>
 1599 <span class="s2">                              [--useChirality &lt;yes or no&gt;] [-w &lt;dir&gt;] -t &lt;torsions&gt; -i &lt;infile&gt;  -o &lt;outfile&gt; </span>
 1600 <span class="s2">    Psi4PerformTorsionScan.py -h | --help | -e | --examples</span>
 1601 
 1602 <span class="s2">Description:</span>
 1603 <span class="s2">    Perform torsion scan for molecules around torsion angles specified using</span>
 1604 <span class="s2">    SMILES/SMARTS patterns. A molecule is optionally minimized before performing</span>
 1605 <span class="s2">    a torsion scan using a forcefield. A set of initial 3D structures are generated for</span>
 1606 <span class="s2">    a molecule by scanning the torsion angle across the specified range and updating</span>
 1607 <span class="s2">    the 3D coordinates of the molecule. A conformation ensemble is optionally generated</span>
 1608 <span class="s2">    for each 3D structure representing a specific torsion angle using a combination of</span>
 1609 <span class="s2">    distance geometry and forcefield followed by constrained geometry optimization</span>
 1610 <span class="s2">    using a quantum chemistry method. The conformation with the lowest energy is</span>
 1611 <span class="s2">    selected to represent the torsion angle. An option is available to skip the generation</span>
 1612 <span class="s2">    of the conformation ensemble and simply calculate the energy for the initial 3D</span>
 1613 <span class="s2">    structure for a specific torsion torsion angle using a quantum chemistry method.</span>
 1614 <span class="s2">    </span>
 1615 <span class="s2">    The torsions are specified using SMILES or SMARTS patterns. A substructure match</span>
 1616 <span class="s2">    is performed to select torsion atoms in a molecule. The SMILES pattern match must</span>
 1617 <span class="s2">    correspond to four torsion atoms. The SMARTS patterns containing atom map numbers</span>
 1618 <span class="s2">    may match  more than four atoms. The atom map numbers, however, must match</span>
 1619 <span class="s2">    exactly four torsion atoms. For example: [s:1][c:2]([aX2,cH1])!@[CX3:3](O)=[O:4] for</span>
 1620 <span class="s2">    thiophene esters and carboxylates as specified in Torsion Library (TorLib) [Ref 146].</span>
 1621 
 1622 <span class="s2">    A Psi4 XYZ format geometry string is automatically generated for each molecule</span>
 1623 <span class="s2">    in input file. It contains atom symbols and 3D coordinates for each atom in a</span>
 1624 <span class="s2">    molecule. In addition, the formal charge and spin multiplicity are present in the</span>
 1625 <span class="s2">    the geometry string. These values are either retrieved from molecule properties</span>
 1626 <span class="s2">    named &#39;FormalCharge&#39; and &#39;SpinMultiplicty&#39; or dynamically calculated for a</span>
 1627 <span class="s2">    molecule.</span>
 1628 <span class="s2">    </span>
 1629 <span class="s2">    A set of four output files is generated for each torsion match in each</span>
 1630 <span class="s2">    molecule. The names of the output files are generated using the root of</span>
 1631 <span class="s2">    the specified output file. They may either contain sequential molecule</span>
 1632 <span class="s2">    numbers or molecule names as shown below:</span>
 1633 <span class="s2">        </span>
 1634 <span class="s2">        &lt;OutfileRoot&gt;_Mol&lt;Num&gt;.sdf</span>
 1635 <span class="s2">        &lt;OutfileRoot&gt;_Mol&lt;Num&gt;_Torsion&lt;Num&gt;_Match&lt;Num&gt;.sdf</span>
 1636 <span class="s2">        &lt;OutfileRoot&gt;_Mol&lt;Num&gt;_Torsion&lt;Num&gt;_Match&lt;Num&gt;_Energies.csv</span>
 1637 <span class="s2">        &lt;OutfileRoot&gt;_Mol&lt;Num&gt;_Torsion&lt;Num&gt;_Match&lt;Num&gt;_Plot.&lt;ImgExt&gt;</span>
 1638 <span class="s2">        </span>
 1639 <span class="s2">        or</span>
 1640 <span class="s2">        </span>
 1641 <span class="s2">        &lt;OutfileRoot&gt;_&lt;MolName&gt;.sdf</span>
 1642 <span class="s2">        &lt;OutfileRoot&gt;_&lt;MolName&gt;_Torsion&lt;Num&gt;_Match&lt;Num&gt;.sdf</span>
 1643 <span class="s2">        &lt;OutfileRoot&gt;_&lt;MolName&gt;_Torsion&lt;Num&gt;_Match&lt;Num&gt;_Energies.csv</span>
 1644 <span class="s2">        &lt;OutfileRoot&gt;_&lt;MolName&gt;_Torsion&lt;Num&gt;_Match&lt;Num&gt;_Plot.&lt;ImgExt&gt;</span>
 1645 <span class="s2">        </span>
 1646 <span class="s2">    The supported input file formats are: Mol (.mol), SD (.sdf, .sd), SMILES (.smi,</span>
 1647 <span class="s2">    .csv, .tsv, .txt)</span>
 1648 
 1649 <span class="s2">    The supported output file formats are: SD (.sdf, .sd)</span>
 1650 
 1651 <span class="s2">Options:</span>
 1652 <span class="s2">    -b, --basisSet &lt;text&gt;  [default: auto]</span>
 1653 <span class="s2">        Basis set to use for energy calculation or constrained energy minimization.</span>
 1654 <span class="s2">        Default: 6-31+G** for sulfur containing molecules; Otherwise, 6-31G** [ Ref 150 ].</span>
 1655 <span class="s2">        The specified value must be a valid Psi4 basis set. No validation is performed.</span>
 1656 <span class="s2">        </span>
 1657 <span class="s2">        The following list shows a representative sample of basis sets available</span>
 1658 <span class="s2">        in Psi4:</span>
 1659 <span class="s2">            </span>
 1660 <span class="s2">            STO-3G, 6-31G, 6-31+G, 6-31++G, 6-31G*, 6-31+G*,  6-31++G*, </span>
 1661 <span class="s2">            6-31G**, 6-31+G**, 6-31++G**, 6-311G, 6-311+G, 6-311++G,</span>
 1662 <span class="s2">            6-311G*, 6-311+G*, 6-311++G*, 6-311G**, 6-311+G**, 6-311++G**,</span>
 1663 <span class="s2">            cc-pVDZ, cc-pCVDZ, aug-cc-pVDZ, cc-pVDZ-DK, cc-pCVDZ-DK, def2-SVP,</span>
 1664 <span class="s2">            def2-SVPD, def2-TZVP, def2-TZVPD, def2-TZVPP, def2-TZVPPD</span>
 1665 <span class="s2">            </span>
 1666 <span class="s2">    --confParams &lt;Name,Value,...&gt;  [default: auto]</span>
 1667 <span class="s2">        A comma delimited list of parameter name and value pairs for generating</span>
 1668 <span class="s2">        initial 3D coordinates for molecules in input file at specific torsion angles. A</span>
 1669 <span class="s2">        conformation ensemble is optionally generated for each 3D structure</span>
 1670 <span class="s2">        representing a specific torsion angle using a combination of distance geometry</span>
 1671 <span class="s2">        and forcefield followed by constrained geometry optimization using a quantum</span>
 1672 <span class="s2">        chemistry method. The conformation with the lowest energy is selected to</span>
 1673 <span class="s2">        represent the torsion angle.</span>
 1674 <span class="s2">        </span>
 1675 <span class="s2">        The supported parameter names along with their default values are shown</span>
 1676 <span class="s2">        below:</span>
 1677 <span class="s2">            </span>
 1678 <span class="s2">            confMethod,ETKDG,</span>
 1679 <span class="s2">            forceField,MMFF, forceFieldMMFFVariant,MMFF94,</span>
 1680 <span class="s2">            enforceChirality,yes,embedRMSDCutoff,0.5,maxConfs,250,</span>
 1681 <span class="s2">            maxConfsTorsions,50,useTethers,yes</span>
 1682 <span class="s2">            </span>
 1683 <span class="s2">            confMethod,ETKDG   [ Possible values: SDG, ETDG, KDG, ETKDG ]</span>
 1684 <span class="s2">            forceField, MMFF   [ Possible values: UFF or MMFF ]</span>
 1685 <span class="s2">            forceFieldMMFFVariant,MMFF94   [ Possible values: MMFF94 or MMFF94s ]</span>
 1686 <span class="s2">            enforceChirality,yes   [ Possible values: yes or no ]</span>
 1687 <span class="s2">            useTethers,yes   [ Possible values: yes or no ]</span>
 1688 <span class="s2">            </span>
 1689 <span class="s2">        confMethod: Conformation generation methodology for generating initial 3D</span>
 1690 <span class="s2">        coordinates. Possible values: Standard Distance Geometry (SDG), Experimental</span>
 1691 <span class="s2">        Torsion-angle preference with Distance Geometry (ETDG), basic Knowledge-terms</span>
 1692 <span class="s2">        with Distance Geometry (KDG) and Experimental Torsion-angle preference</span>
 1693 <span class="s2">        along with basic Knowledge-terms with Distance Geometry (ETKDG) [Ref 129] .</span>
 1694 <span class="s2">        </span>
 1695 <span class="s2">        forceField: Forcefield method to use for energy minimization. Possible values:</span>
 1696 <span class="s2">        Universal Force Field (UFF) [ Ref 81 ] or Merck Molecular Mechanics Force</span>
 1697 <span class="s2">        Field [ Ref 83-87 ] .</span>
 1698 <span class="s2">        </span>
 1699 <span class="s2">        enforceChirality: Enforce chirality for defined chiral centers during</span>
 1700 <span class="s2">        forcefield minimization.</span>
 1701 <span class="s2">        </span>
 1702 <span class="s2">        maxConfs: Maximum number of conformations to generate for each molecule</span>
 1703 <span class="s2">        during the generation of an initial 3D conformation ensemble using a conformation</span>
 1704 <span class="s2">        generation methodology. The conformations are minimized using the specified</span>
 1705 <span class="s2">        forcefield. The lowest energy structure is selected for performing the torsion scan.</span>
 1706 <span class="s2">        </span>
 1707 <span class="s2">        maxConfsTorsion: Maximum number of 3D conformations to generate for</span>
 1708 <span class="s2">        conformation ensemble representing a specific torsion. The conformations are</span>
 1709 <span class="s2">        constrained at specific torsions angles and minimized using the specified forcefield</span>
 1710 <span class="s2">        and a quantum chemistry method. The lowest energy conformation is selected to</span>
 1711 <span class="s2">        calculate final torsion energy and written to the output file.</span>
 1712 <span class="s2">        </span>
 1713 <span class="s2">        embedRMSDCutoff: RMSD cutoff for retaining initial set of conformers embedded</span>
 1714 <span class="s2">        using distance geometry and forcefield minimization. All embedded conformers</span>
 1715 <span class="s2">        are kept for &#39;None&#39; value. Otherwise, only those conformers which are different</span>
 1716 <span class="s2">        from each other by the specified RMSD cutoff, 0.5 by default, are kept. The first</span>
 1717 <span class="s2">        embedded conformer is always retained.</span>
 1718 <span class="s2">        </span>
 1719 <span class="s2">        useTethers: Use tethers to optimize the final embedded conformation by</span>
 1720 <span class="s2">        applying a series of extra forces to align matching atoms to the positions of</span>
 1721 <span class="s2">        the core atoms. Otherwise, use simple distance constraints during the</span>
 1722 <span class="s2">        optimization.</span>
 1723 <span class="s2">    --energyDataFieldLabel &lt;text&gt;  [default: auto]</span>
 1724 <span class="s2">        Energy data field label for writing energy values. Default: Psi4_Energy (&lt;Units&gt;). </span>
 1725 <span class="s2">    --energyRelativeDataFieldLabel &lt;text&gt;  [default: auto]</span>
 1726 <span class="s2">        Relative energy data field label for writing energy values. Default:</span>
 1727 <span class="s2">        Psi4_Relative_Energy (&lt;Units&gt;). </span>
 1728 <span class="s2">    --energyUnits &lt;text&gt;  [default: kcal/mol]</span>
 1729 <span class="s2">        Energy units. Possible values: Hartrees, kcal/mol, kJ/mol, or eV.</span>
 1730 <span class="s2">    -e, --examples</span>
 1731 <span class="s2">        Print examples.</span>
 1732 <span class="s2">    -h, --help</span>
 1733 <span class="s2">        Print this help message.</span>
 1734 <span class="s2">    -i, --infile &lt;infile&gt;</span>
 1735 <span class="s2">        Input file name.</span>
 1736 <span class="s2">    --infile3D &lt;yes or no&gt;  [default: no]</span>
 1737 <span class="s2">        Skip generation and minimization of initial 3D structures for molecules in</span>
 1738 <span class="s2">        input file containing 3D coordinates.</span>
 1739 <span class="s2">    --infileParams &lt;Name,Value,...&gt;  [default: auto]</span>
 1740 <span class="s2">        A comma delimited list of parameter name and value pairs for reading</span>
 1741 <span class="s2">        molecules from files. The supported parameter names for different file</span>
 1742 <span class="s2">        formats, along with their default values, are shown below:</span>
 1743 <span class="s2">            </span>
 1744 <span class="s2">            SD, MOL: removeHydrogens,no,sanitize,yes,strictParsing,yes</span>
 1745 <span class="s2">            </span>
 1746 <span class="s2">            SMILES: smilesColumn,1,smilesNameColumn,2,smilesDelimiter,space,</span>
 1747 <span class="s2">                smilesTitleLine,auto,sanitize,yes</span>
 1748 <span class="s2">            </span>
 1749 <span class="s2">        Possible values for smilesDelimiter: space, comma or tab.</span>
 1750 <span class="s2">    --maxIters &lt;number&gt;  [default: 50]</span>
 1751 <span class="s2">        Maximum number of iterations to perform for each molecule or conformer</span>
 1752 <span class="s2">        during constrained energy minimization by a quantum chemistry method.</span>
 1753 <span class="s2">    -m, --methodName &lt;text&gt;  [default: auto]</span>
 1754 <span class="s2">        Method to use for energy calculation or constrained energy minimization.</span>
 1755 <span class="s2">        Default: B3LYP [ Ref 150 ]. The specified value must be a valid Psi4 method</span>
 1756 <span class="s2">        name. No validation is performed.</span>
 1757 <span class="s2">        </span>
 1758 <span class="s2">        The following list shows a representative sample of methods available</span>
 1759 <span class="s2">        in Psi4:</span>
 1760 <span class="s2">            </span>
 1761 <span class="s2">            B1LYP, B2PLYP, B2PLYP-D3BJ, B2PLYP-D3MBJ, B3LYP, B3LYP-D3BJ,</span>
 1762 <span class="s2">            B3LYP-D3MBJ, CAM-B3LYP, CAM-B3LYP-D3BJ, HF, HF-D3BJ,  HF3c, M05,</span>
 1763 <span class="s2">            M06, M06-2x, M06-HF, M06-L, MN12-L, MN15, MN15-D3BJ,PBE, PBE0,</span>
 1764 <span class="s2">            PBEH3c, PW6B95, PW6B95-D3BJ, WB97, WB97X, WB97X-D, WB97X-D3BJ</span>
 1765 <span class="s2">            </span>
 1766 <span class="s2">    --modeMols &lt;First or All&gt;  [default: First]</span>
 1767 <span class="s2">        Perform torsion scan for the first molecule or all molecules in input</span>
 1768 <span class="s2">        file.</span>
 1769 <span class="s2">    --modeTorsions &lt;First or All&gt;  [default: First]</span>
 1770 <span class="s2">        Perform torsion scan for the first or all specified torsion pattern in</span>
 1771 <span class="s2">        molecules up to a maximum number of matches for each torsion</span>
 1772 <span class="s2">        specification as indicated by &#39;--torsionMaxMatches&#39; option. </span>
 1773 <span class="s2">    --mp &lt;yes or no&gt;  [default: no]</span>
 1774 <span class="s2">        Use multiprocessing.</span>
 1775 <span class="s2">         </span>
 1776 <span class="s2">        By default, input data is retrieved in a lazy manner via mp.Pool.imap()</span>
 1777 <span class="s2">        function employing lazy RDKit data iterable. This allows processing of</span>
 1778 <span class="s2">        arbitrary large data sets without any additional requirements memory.</span>
 1779 <span class="s2">        </span>
 1780 <span class="s2">        All input data may be optionally loaded into memory by mp.Pool.map()</span>
 1781 <span class="s2">        before starting worker processes in a process pool by setting the value</span>
 1782 <span class="s2">        of &#39;inputDataMode&#39; to &#39;InMemory&#39; in &#39;--mpParams&#39; option.</span>
 1783 <span class="s2">        </span>
 1784 <span class="s2">        A word to the wise: The default &#39;chunkSize&#39; value of 1 during &#39;Lazy&#39; input</span>
 1785 <span class="s2">        data mode may adversely impact the performance. The &#39;--mpParams&#39; section</span>
 1786 <span class="s2">        provides additional information to tune the value of &#39;chunkSize&#39;.</span>
 1787 <span class="s2">    --mpLevel &lt;Molecules or TorsionAngles&gt;  [default: Molecules]</span>
 1788 <span class="s2">        Perform multiprocessing at molecules or torsion angles level. Possible values:</span>
 1789 <span class="s2">        Molecules or TorsionAngles. The &#39;Molecules&#39; value starts a process pool at the</span>
 1790 <span class="s2">        molecules level. All torsion angles of a molecule are processed in a single</span>
 1791 <span class="s2">        process. The &#39;TorsionAngles&#39; value, however, starts a process pool at the </span>
 1792 <span class="s2">        torsion angles level. Each torsion angle in a torsion match for a molecule is</span>
 1793 <span class="s2">        processed in an individual process in the process pool.</span>
 1794 <span class="s2">    --mpParams &lt;Name,Value,...&gt;  [default: auto]</span>
 1795 <span class="s2">        A comma delimited list of parameter name and value pairs to configure</span>
 1796 <span class="s2">        multiprocessing.</span>
 1797 <span class="s2">        </span>
 1798 <span class="s2">        The supported parameter names along with their default and possible</span>
 1799 <span class="s2">        values are shown below:</span>
 1800 <span class="s2">        </span>
 1801 <span class="s2">            chunkSize, auto</span>
 1802 <span class="s2">            inputDataMode, Lazy   [ Possible values: InMemory or Lazy ]</span>
 1803 <span class="s2">            numProcesses, auto   [ Default: mp.cpu_count() ]</span>
 1804 <span class="s2">        </span>
 1805 <span class="s2">        These parameters are used by the following functions to configure and</span>
 1806 <span class="s2">        control the behavior of multiprocessing: mp.Pool(), mp.Pool.map(), and</span>
 1807 <span class="s2">        mp.Pool.imap().</span>
 1808 <span class="s2">        </span>
 1809 <span class="s2">        The chunkSize determines chunks of input data passed to each worker</span>
 1810 <span class="s2">        process in a process pool by mp.Pool.map() and mp.Pool.imap() functions.</span>
 1811 <span class="s2">        The default value of chunkSize is dependent on the value of &#39;inputDataMode&#39;.</span>
 1812 <span class="s2">        </span>
 1813 <span class="s2">        The mp.Pool.map() function, invoked during &#39;InMemory&#39; input data mode,</span>
 1814 <span class="s2">        automatically converts RDKit data iterable into a list, loads all data into</span>
 1815 <span class="s2">        memory, and calculates the default chunkSize using the following method</span>
 1816 <span class="s2">        as shown in its code:</span>
 1817 <span class="s2">        </span>
 1818 <span class="s2">            chunkSize, extra = divmod(len(dataIterable), len(numProcesses) * 4)</span>
 1819 <span class="s2">            if extra: chunkSize += 1</span>
 1820 <span class="s2">        </span>
 1821 <span class="s2">        For example, the default chunkSize will be 7 for a pool of 4 worker processes</span>
 1822 <span class="s2">        and 100 data items.</span>
 1823 <span class="s2">        </span>
 1824 <span class="s2">        The mp.Pool.imap() function, invoked during &#39;Lazy&#39; input data mode, employs</span>
 1825 <span class="s2">        &#39;lazy&#39; RDKit data iterable to retrieve data as needed, without loading all the</span>
 1826 <span class="s2">        data into memory. Consequently, the size of input data is not known a priori.</span>
 1827 <span class="s2">        It&#39;s not possible to estimate an optimal value for the chunkSize. The default </span>
 1828 <span class="s2">        chunkSize is set to 1.</span>
 1829 <span class="s2">        </span>
 1830 <span class="s2">        The default value for the chunkSize during &#39;Lazy&#39; data mode may adversely</span>
 1831 <span class="s2">        impact the performance due to the overhead associated with exchanging</span>
 1832 <span class="s2">        small chunks of data. It is generally a good idea to explicitly set chunkSize to</span>
 1833 <span class="s2">        a larger value during &#39;Lazy&#39; input data mode, based on the size of your input</span>
 1834 <span class="s2">        data and number of processes in the process pool.</span>
 1835 <span class="s2">        </span>
 1836 <span class="s2">        The mp.Pool.map() function waits for all worker processes to process all</span>
 1837 <span class="s2">        the data and return the results. The mp.Pool.imap() function, however,</span>
 1838 <span class="s2">        returns the the results obtained from worker processes as soon as the</span>
 1839 <span class="s2">        results become available for specified chunks of data.</span>
 1840 <span class="s2">        </span>
 1841 <span class="s2">        The order of data in the results returned by both mp.Pool.map() and </span>
 1842 <span class="s2">        mp.Pool.imap() functions always corresponds to the input data.</span>
 1843 <span class="s2">    -o, --outfile &lt;outfile&gt;</span>
 1844 <span class="s2">        Output file name. The output file root is used for generating the names</span>
 1845 <span class="s2">        of the output files corresponding to structures, energies, and plots during</span>
 1846 <span class="s2">        the torsion scan.</span>
 1847 <span class="s2">    --outfileMolName &lt;yes or no&gt;  [default: no]</span>
 1848 <span class="s2">        Append molecule name to output file root during the generation of the names</span>
 1849 <span class="s2">        for output files. The default is to use &lt;MolNum&gt;. The non alphabetical</span>
 1850 <span class="s2">        characters in molecule names are replaced by underscores.</span>
 1851 <span class="s2">    --outfileParams &lt;Name,Value,...&gt;  [default: auto]</span>
 1852 <span class="s2">        A comma delimited list of parameter name and value pairs for writing</span>
 1853 <span class="s2">        molecules to files. The supported parameter names for different file</span>
 1854 <span class="s2">        formats, along with their default values, are shown below:</span>
 1855 <span class="s2">            </span>
 1856 <span class="s2">            SD: kekulize,yes</span>
 1857 <span class="s2">            </span>
 1858 <span class="s2">    --outPlotParams &lt;Name,Value,...&gt;  [default: auto]</span>
 1859 <span class="s2">        A comma delimited list of parameter name and value pairs for generating</span>
 1860 <span class="s2">        plots using Seaborn module. The supported parameter names along with their</span>
 1861 <span class="s2">        default values are shown below:</span>
 1862 <span class="s2">            </span>
 1863 <span class="s2">            type,linepoint,outExt,svg,width,10,height,5.6,</span>
 1864 <span class="s2">            title,auto,xlabel,auto,ylabel,auto,titleWeight,bold,labelWeight,bold</span>
 1865 <span class="s2">            style,darkgrid,palette,deep,font,sans-serif,fontScale,1,</span>
 1866 <span class="s2">            context,notebook</span>
 1867 <span class="s2">            </span>
 1868 <span class="s2">        Possible values:</span>
 1869 <span class="s2">            </span>
 1870 <span class="s2">            type: linepoint, scatter, or line. Both points and lines are drawn</span>
 1871 <span class="s2">                for linepoint plot type.</span>
 1872 <span class="s2">            outExt: Any valid format supported by Python module Matplotlib.</span>
 1873 <span class="s2">                For example: PDF (.pdf), PNG (.png), PS (.ps), SVG (.svg)</span>
 1874 <span class="s2">            titleWeight, labelWeight: Font weight for title and axes labels.</span>
 1875 <span class="s2">                Any valid value.</span>
 1876 <span class="s2">            style: darkgrid, whitegrid, dark, white, ticks</span>
 1877 <span class="s2">            palette: deep, muted, pastel, dark, bright, colorblind</span>
 1878 <span class="s2">            font: Any valid font name</span>
 1879 <span class="s2">            </span>
 1880 <span class="s2">    --outPlotRelativeEnergy &lt;yes or no&gt;  [default: yes]</span>
 1881 <span class="s2">        Plot relative energies in the torsion plot. The minimum energy value is</span>
 1882 <span class="s2">        subtracted from energy values to calculate relative energies.</span>
 1883 <span class="s2">    --outPlotTitleTorsionSpec &lt;yes or no&gt;  [default: yes]</span>
 1884 <span class="s2">        Append torsion specification to the title of the torsion plot.</span>
 1885 <span class="s2">    --overwrite</span>
 1886 <span class="s2">        Overwrite existing files.</span>
 1887 <span class="s2">    --precision &lt;number&gt;  [default: 6]</span>
 1888 <span class="s2">        Floating point precision for writing energy values.</span>
 1889 <span class="s2">    --psi4OptionsParams &lt;Name,Value,...&gt;  [default: none]</span>
 1890 <span class="s2">        A comma delimited list of Psi4 option name and value pairs for setting</span>
 1891 <span class="s2">        global and module options. The names are &#39;option_name&#39; for global options</span>
 1892 <span class="s2">        and &#39;module_name__option_name&#39; for options local to a module. The</span>
 1893 <span class="s2">        specified option names must be valid Psi4 names. No validation is</span>
 1894 <span class="s2">        performed.</span>
 1895 <span class="s2">        </span>
 1896 <span class="s2">        The specified option name and  value pairs are processed and passed to</span>
 1897 <span class="s2">        psi4.set_options() as a dictionary. The supported value types are float,</span>
 1898 <span class="s2">        integer, boolean, or string. The float value string is converted into a float.</span>
 1899 <span class="s2">        The valid values for a boolean string are yes, no, true, false, on, or off. </span>
 1900 <span class="s2">    --psi4RunParams &lt;Name,Value,...&gt;  [default: auto]</span>
 1901 <span class="s2">        A comma delimited list of parameter name and value pairs for configuring</span>
 1902 <span class="s2">        Psi4 jobs.</span>
 1903 <span class="s2">        </span>
 1904 <span class="s2">        The supported parameter names along with their default and possible</span>
 1905 <span class="s2">        values are shown below:</span>
 1906 <span class="s2">             </span>
 1907 <span class="s2">            MemoryInGB, 1</span>
 1908 <span class="s2">            NumThreads, 1</span>
 1909 <span class="s2">            OutputFile, auto   [ Possible  values: stdout, quiet, or FileName ]</span>
 1910 <span class="s2">            ScratchDir, auto   [ Possivle values: DirName]</span>
 1911 <span class="s2">            RemoveOutputFile, yes   [ Possible values: yes, no, true, or false]</span>
 1912 <span class="s2">            </span>
 1913 <span class="s2">        These parameters control the runtime behavior of Psi4.</span>
 1914 <span class="s2">        </span>
 1915 <span class="s2">        The default file name for &#39;OutputFile&#39; is &lt;InFileRoot&gt;_Psi4.out. The PID</span>
 1916 <span class="s2">        is appended to output file name during multiprocessing as shown:</span>
 1917 <span class="s2">        &lt;InFileRoot&gt;_Psi4_&lt;PIDNum&gt;.out. The &#39;stdout&#39; value for &#39;OutputType&#39;</span>
 1918 <span class="s2">        sends Psi4 output to stdout. The &#39;quiet&#39; or &#39;devnull&#39; value suppresses</span>
 1919 <span class="s2">        all Psi4 output. The &#39;OutputFile&#39; is set to &#39;quiet&#39; for &#39;auto&#39; value during </span>
 1920 <span class="s2">        &#39;Conformers&#39; of &#39;--mpLevel&#39; option.</span>
 1921 <span class="s2">        </span>
 1922 <span class="s2">        The default &#39;Yes&#39; value of &#39;RemoveOutputFile&#39; option forces the removal</span>
 1923 <span class="s2">        of any existing Psi4 before creating new files to append output from</span>
 1924 <span class="s2">        multiple Psi4 runs.</span>
 1925 <span class="s2">        </span>
 1926 <span class="s2">        The option &#39;ScratchDir&#39; is a directory path to the location of scratch</span>
 1927 <span class="s2">        files. The default value corresponds to Psi4 default. It may be used to</span>
 1928 <span class="s2">        override the deafult path.</span>
 1929 <span class="s2">    -q, --quiet &lt;yes or no&gt;  [default: no]</span>
 1930 <span class="s2">        Use quiet mode. The warning and information messages will not be printed.</span>
 1931 <span class="s2">    --reference &lt;text&gt;  [default: auto]</span>
 1932 <span class="s2">        Reference wave function to use for energy calculation or constrained energy</span>
 1933 <span class="s2">        minimization. Default: RHF or UHF. The default values are Restricted Hartree-Fock</span>
 1934 <span class="s2">        (RHF) for closed-shell molecules with all electrons paired and Unrestricted</span>
 1935 <span class="s2">        Hartree-Fock (UHF) for open-shell molecules with unpaired electrons.</span>
 1936 <span class="s2">        </span>
 1937 <span class="s2">        The specified value must be a valid Psi4 reference wave function. No validation</span>
 1938 <span class="s2">        is performed. For example: ROHF, CUHF, RKS, etc.</span>
 1939 <span class="s2">        </span>
 1940 <span class="s2">        The spin multiplicity determines the default value of reference wave function</span>
 1941 <span class="s2">        for input molecules. It is calculated from number of free radical electrons using</span>
 1942 <span class="s2">        Hund&#39;s rule of maximum multiplicity defined as 2S + 1 where S is the total</span>
 1943 <span class="s2">        electron spin. The total spin is 1/2 the number of free radical electrons in a </span>
 1944 <span class="s2">        molecule. The value of &#39;SpinMultiplicity&#39; molecule property takes precedence</span>
 1945 <span class="s2">        over the calculated value of spin multiplicity.</span>
 1946 <span class="s2">    -t, --torsions &lt;SMILES/SMARTS,...,...&gt;</span>
 1947 <span class="s2">        SMILES/SMARTS patterns corresponding to torsion specifications. It&#39;s a </span>
 1948 <span class="s2">        comma delimited list of valid SMILES/SMART patterns.</span>
 1949 <span class="s2">        </span>
 1950 <span class="s2">        A substructure match is performed to select torsion atoms in a molecule.</span>
 1951 <span class="s2">        The SMILES pattern match must correspond to four torsion atoms. The</span>
 1952 <span class="s2">        SMARTS patterns containing atom map numbers  may match  more than four</span>
 1953 <span class="s2">        atoms. The atom map numbers, however, must match exactly four torsion</span>
 1954 <span class="s2">        atoms. For example: [s:1][c:2]([aX2,cH1])!@[CX3:3](O)=[O:4] for thiophene</span>
 1955 <span class="s2">        esters and carboxylates as specified in Torsion Library (TorLib) [Ref 146].</span>
 1956 <span class="s2">    --torsionsFilterbyAtomIndices &lt;Index1, Index2, ...&gt;  [default: none]</span>
 1957 <span class="s2">        Comma delimited list of atom indices for filtering torsion matches</span>
 1958 <span class="s2">        corresponding to torsion specifications  &quot;-t, --torsions&quot;. The atom indices</span>
 1959 <span class="s2">        must be valid. No explicit validation is performed. The list must contain at</span>
 1960 <span class="s2">        least 4 atom indices.</span>
 1961 <span class="s2">        </span>
 1962 <span class="s2">        The torsion atom indices, matched by &quot;-t, --torsions&quot; specifications, must be</span>
 1963 <span class="s2">        present in the list. Otherwise, the torsion matches are ignored.</span>
 1964 <span class="s2">    --torsionMaxMatches &lt;number&gt;  [default: 5]</span>
 1965 <span class="s2">        Maximum number of torsions to match for each torsion specification in a</span>
 1966 <span class="s2">        molecule.</span>
 1967 <span class="s2">    --torsionMinimize &lt;yes or no&gt;  [default: no]</span>
 1968 <span class="s2">        Perform constrained energy minimization on a conformation ensemble</span>
 1969 <span class="s2">        for  a specific torsion angle and select the lowest energy conformation</span>
 1970 <span class="s2">        representing the torsion angle. A conformation ensemble is generated for</span>
 1971 <span class="s2">        each 3D structure representing a specific torsion angle using a combination</span>
 1972 <span class="s2">        of distance geometry and forcefield followed by constrained geometry</span>
 1973 <span class="s2">        optimization using a quantum chemistry method.</span>
 1974 <span class="s2">    --torsionRange &lt;Start,Stop,Step&gt;  [default: 0,360,5]</span>
 1975 <span class="s2">        Start, stop, and step size angles in degrees for a torsion scan. In addition,</span>
 1976 <span class="s2">        you may specify values using start and stop angles from -180 to 180.</span>
 1977 <span class="s2">    --useChirality &lt;yes or no&gt;  [default: no]</span>
 1978 <span class="s2">        Use chirrality during substructure matches for identification of torsions.</span>
 1979 <span class="s2">    -w, --workingdir &lt;dir&gt;</span>
 1980 <span class="s2">        Location of working directory which defaults to the current directory.</span>
 1981 
 1982 <span class="s2">Examples:</span>
 1983 <span class="s2">    To perform a torsion scan on the first molecule in a SMILES file using a minimum</span>
 1984 <span class="s2">    energy structure of the molecule selected from an initial ensemble of conformations</span>
 1985 <span class="s2">    generated using distance geometry and forcefield, skip generation of conformation</span>
 1986 <span class="s2">    ensembles for specific torsion angles and constrained energy minimization of the</span>
 1987 <span class="s2">    ensemble, calculating single point at a specific torsion angle energy using B3LYP/6-31G**</span>
 1988 <span class="s2">    and B3LYP/6-31+G** for non-sulfur and sulfur containing molecules, generate output files</span>
 1989 <span class="s2">    corresponding to structure, energy and torsion plot, type:</span>
 1990 <span class="s2">    </span>
 1991 <span class="s2">        % Psi4PerformTorsionScan.py  -t &quot;CCCC&quot; -i Psi4SampleTorsionScan.smi </span>
 1992 <span class="s2">          -o SampleOut.sdf</span>
 1993 
 1994 <span class="s2">    To run the previous example on the first molecule in a SD file containing 3D</span>
 1995 <span class="s2">    coordinates and skip the generations of initial 3D structure, type: </span>
 1996 <span class="s2">    </span>
 1997 <span class="s2">        % Psi4PerformTorsionScan.py  -t &quot;CCCC&quot;  --infile3D yes</span>
 1998 <span class="s2">          -i Psi4SampleTorsionScan3D.sdf  -o SampleOut.sdf</span>
 1999 
 2000 <span class="s2">    To run the first example on all molecules in a SD file, type:</span>
 2001 <span class="s2">    </span>
 2002 <span class="s2">        % Psi4PerformTorsionScan.py  -t &quot;CCCC&quot; --modeMols All</span>
 2003 <span class="s2">          -i Psi4SampleTorsionScan.sdf -o SampleOut.sdf</span>
 2004 
 2005 <span class="s2">    To run the first example on all molecules in a SD file containing 3D</span>
 2006 <span class="s2">    coordinates and skip the generation of initial 3D structures, type: </span>
 2007 <span class="s2">    </span>
 2008 <span class="s2">        % Psi4PerformTorsionScan.py  -t &quot;CCCC&quot;  --infile3D yes</span>
 2009 <span class="s2">          --modeMols All -i Psi4SampleTorsionScan3D.sdf  -o SampleOut.sdf</span>
 2010 
 2011 <span class="s2">    To perform a torsion scan on the first molecule in a SMILES file using a minimum</span>
 2012 <span class="s2">    energy structure of the molecule selected from an initial ensemble of conformations</span>
 2013 <span class="s2">    generated using distance geometry and forcefield,  generate up to 50 conformations</span>
 2014 <span class="s2">    for specific torsion angles using ETKDG methodology followed by initial MMFF</span>
 2015 <span class="s2">    forcefield minimization and final energy minimization using B3LYP/6-31G** and</span>
 2016 <span class="s2">    B3LYP/6-31+G** for non-sulfur and sulfur containing molecules, generate output files</span>
 2017 <span class="s2">    corresponding to minimum energy structure, energy and torsion plot, type:</span>
 2018 
 2019 <span class="s2">        % Psi4PerformTorsionScan.py  -t &quot;CCCC&quot; --torsionMinimize Yes</span>
 2020 <span class="s2">           -i Psi4SampleTorsionScan.smi -o SampleOut.sdf</span>
 2021 
 2022 <span class="s2">    To run the previous example on all molecules in a SD file, type:</span>
 2023 <span class="s2">    </span>
 2024 <span class="s2">        % Psi4PerformTorsionScan.py  -t &quot;CCCC&quot; --modeMols All</span>
 2025 <span class="s2">           --torsionMinimize Yes -i Psi4SampleTorsionScan.sdf -o SampleOut.sdf</span>
 2026 
 2027 <span class="s2">    To run the previous example on all molecules in a SD file containing 3D</span>
 2028 <span class="s2">    coordinates and skip the generation of initial 3D structures, type:</span>
 2029 <span class="s2">    </span>
 2030 <span class="s2">        % Psi4PerformTorsionScan.py  -t &quot;CCCC&quot; --modeMols All</span>
 2031 <span class="s2">           --infile3D yes --modeMols All  --torsionMinimize Yes</span>
 2032 <span class="s2">           -i Psi4SampleTorsionScan.sdf -o SampleOut.sdf</span>
 2033 
 2034 <span class="s2">    To run the previous example in multiprocessing mode at molecules level</span>
 2035 <span class="s2">    on all available CPUs without loading all data into memory and write out</span>
 2036 <span class="s2">    a SD file, type:</span>
 2037 
 2038 <span class="s2">        % Psi4PerformTorsionScan.py  -t &quot;CCCC&quot; -i Psi4SampleTorsionScan.smi </span>
 2039 <span class="s2">          -o SampleOut.sdf --modeMols All --torsionMinimize Yes --mp yes</span>
 2040 <span class="s2">    </span>
 2041 <span class="s2">    To run the previous example in multiprocessing mode at torsion angles level</span>
 2042 <span class="s2">    on all available CPUs without loading all data into memory and write out</span>
 2043 <span class="s2">    a SD file, type:</span>
 2044 
 2045 <span class="s2">        % Psi4PerformTorsionScan.py  -t &quot;CCCC&quot; -i Psi4SampleTorsionScan.smi </span>
 2046 <span class="s2">          -o SampleOut.sdf --modeMols All --torsionMinimize Yes --mp yes</span>
 2047 <span class="s2">          --mpLevel TorsionAngles</span>
 2048 <span class="s2">    </span>
 2049 <span class="s2">    To run the previous example in multiprocessing mode on all available CPUs</span>
 2050 <span class="s2">    by loading all data into memory and write out a SD file, type:</span>
 2051 
 2052 <span class="s2">        % Psi4PerformTorsionScan.py  -t &quot;CCCC&quot; -i Psi4SampleTorsionScan.smi </span>
 2053 <span class="s2">          -o SampleOut.sdf --modeMols All --torsionMinimize Yes --mp yes</span>
 2054 <span class="s2">          --mpParams &quot;inputDataMode,InMemory&quot;</span>
 2055 <span class="s2">    </span>
 2056 <span class="s2">    To run the previous example in multiprocessing mode on specific number of</span>
 2057 <span class="s2">    CPUs and chunk size without loading all data into memory and write out a SD file,</span>
 2058 <span class="s2">    type:</span>
 2059 
 2060 <span class="s2">        % Psi4PerformTorsionScan.py  -t &quot;CCCC&quot; -i Psi4SampleTorsionScan.smi </span>
 2061 <span class="s2">          -o SampleOut.sdf --modeMols All --torsionMinimize Yes --mp yes</span>
 2062 <span class="s2">          --mpParams &quot;inputDataMode,Lazy,numProcesses,4,chunkSize,8&quot;</span>
 2063 
 2064 <span class="s2">Author:</span>
 2065 <span class="s2">    Manish Sud(msud@san.rr.com)</span>
 2066 
 2067 <span class="s2">See also:</span>
 2068 <span class="s2">    Psi4CalculateEnergy.py, Psi4GenerateConformers.py,</span>
 2069 <span class="s2">    Psi4GenerateConstrainedConformers.py, Psi4PerformConstrainedMinimization.py</span>
 2070 
 2071 <span class="s2">Copyright:</span>
 2072 <span class="s2">    Copyright (C) 2022 Manish Sud. All rights reserved.</span>
 2073 
 2074 <span class="s2">    The functionality available in this script is implemented using RDKit, an</span>
 2075 <span class="s2">    open source toolkit for cheminformatics developed by Greg Landrum.</span>
 2076 
 2077 <span class="s2">    This file is part of MayaChemTools.</span>
 2078 
 2079 <span class="s2">    MayaChemTools is free software; you can redistribute it and/or modify it under</span>
 2080 <span class="s2">    the terms of the GNU Lesser General Public License as published by the Free</span>
 2081 <span class="s2">    Software Foundation; either version 3 of the License, or (at your option) any</span>
 2082 <span class="s2">    later version.</span>
 2083 
 2084 <span class="s2">&quot;&quot;&quot;</span>
 2085 
 2086 <span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
 2087     <span class="n">main</span><span class="p">()</span>
</pre>
<br />
<center>
<img src="../../../images/h2o2.png">
</center>
</body>
</html>
