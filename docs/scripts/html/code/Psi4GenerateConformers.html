<html>
<head>
<title>MayaChemTools:Code:Psi4GenerateConformers.py</title>
<meta http-equiv="content-type" content="text/html;charset=utf-8">
<link rel="stylesheet" type="text/css" href="../../../css/MayaChemToolsPythonCode.css">
</head>
<body leftmargin="20" rightmargin="20" topmargin="10" bottommargin="10">
<br/>
<center>
<a href="http://www.mayachemtools.org" title="MayaChemTools Home"><img src="../../../images/MayaChemToolsLogo.gif" border="0" alt="MayaChemTools"></a>
</center>
<br/>
<pre>
    1 <span class="ch">#!/bin/env python</span>
    2 <span class="c1">#</span>
    3 <span class="c1"># File: Psi4GenerateConformers.py</span>
    4 <span class="c1"># Author: Manish Sud &lt;msud@san.rr.com&gt;</span>
    5 <span class="c1">#</span>
    6 <span class="c1"># Copyright (C) 2022 Manish Sud. All rights reserved.</span>
    7 <span class="c1">#</span>
    8 <span class="c1"># The functionality available in this script is implemented using Psi4, an</span>
    9 <span class="c1"># open source quantum chemistry software package, and RDKit, an open</span>
   10 <span class="c1"># source toolkit for cheminformatics developed by Greg Landrum.</span>
   11 <span class="c1">#</span>
   12 <span class="c1"># This file is part of MayaChemTools.</span>
   13 <span class="c1">#</span>
   14 <span class="c1"># MayaChemTools is free software; you can redistribute it and/or modify it under</span>
   15 <span class="c1"># the terms of the GNU Lesser General Public License as published by the Free</span>
   16 <span class="c1"># Software Foundation; either version 3 of the License, or (at your option) any</span>
   17 <span class="c1"># later version.</span>
   18 <span class="c1">#</span>
   19 <span class="c1"># MayaChemTools is distributed in the hope that it will be useful, but without</span>
   20 <span class="c1"># any warranty; without even the implied warranty of merchantability of fitness</span>
   21 <span class="c1"># for a particular purpose.  See the GNU Lesser General Public License for more</span>
   22 <span class="c1"># details.</span>
   23 <span class="c1">#</span>
   24 <span class="c1"># You should have received a copy of the GNU Lesser General Public License</span>
   25 <span class="c1"># along with MayaChemTools; if not, see &lt;http://www.gnu.org/licenses/&gt; or</span>
   26 <span class="c1"># write to the Free Software Foundation Inc., 59 Temple Place, Suite 330,</span>
   27 <span class="c1"># Boston, MA, 02111-1307, USA.</span>
   28 <span class="c1">#</span>
   29 
   30 <span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>
   31 
   32 <span class="c1"># Add local python path to the global path and import standard library modules...</span>
   33 <span class="kn">import</span> <span class="nn">os</span>
   34 <span class="kn">import</span> <span class="nn">sys</span><span class="p">;</span>  <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="s2">&quot;..&quot;</span><span class="p">,</span> <span class="s2">&quot;lib&quot;</span><span class="p">,</span> <span class="s2">&quot;Python&quot;</span><span class="p">))</span>
   35 <span class="kn">import</span> <span class="nn">time</span>
   36 <span class="kn">import</span> <span class="nn">re</span>
   37 <span class="kn">import</span> <span class="nn">shutil</span>
   38 <span class="kn">import</span> <span class="nn">multiprocessing</span> <span class="kn">as</span> <span class="nn">mp</span>
   39 
   40 <span class="c1"># Psi4 imports...</span>
   41 <span class="k">if</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">shutil</span><span class="p">,</span> <span class="s1">&#39;which&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">shutil</span><span class="o">.</span><span class="n">which</span><span class="p">(</span><span class="s2">&quot;psi4&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">):</span>
   42     <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Warning: Failed to find &#39;psi4&#39; in your PATH indicating potential issues with your</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
   43     <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Psi4 environment. The &#39;import psi4&#39; directive in the global scope of the script</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
   44     <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;interferes with the multiprocessing functionality. It is imported later in the</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
   45     <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;local scope during the execution of the script and may fail. Check/update your</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
   46     <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Psi4 environment and try again.</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
   47 
   48 <span class="c1"># RDKit imports...</span>
   49 <span class="k">try</span><span class="p">:</span>
   50     <span class="kn">from</span> <span class="nn">rdkit</span> <span class="kn">import</span> <span class="n">rdBase</span>
   51     <span class="kn">from</span> <span class="nn">rdkit</span> <span class="kn">import</span> <span class="n">Chem</span>
   52     <span class="kn">from</span> <span class="nn">rdkit.Chem</span> <span class="kn">import</span> <span class="n">AllChem</span>
   53 <span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">ErrMsg</span><span class="p">:</span>
   54     <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Failed to import RDKit module/package: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">ErrMsg</span><span class="p">)</span>
   55     <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Check/update your RDKit environment and try again.</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
   56     <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
   57 
   58 <span class="c1"># MayaChemTools imports...</span>
   59 <span class="k">try</span><span class="p">:</span>
   60     <span class="kn">from</span> <span class="nn">docopt</span> <span class="kn">import</span> <span class="n">docopt</span>
   61     <span class="kn">import</span> <span class="nn">MiscUtil</span>
   62     <span class="kn">import</span> <span class="nn">Psi4Util</span>
   63     <span class="kn">import</span> <span class="nn">RDKitUtil</span>
   64 <span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">ErrMsg</span><span class="p">:</span>
   65     <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Failed to import MayaChemTools module/package: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">ErrMsg</span><span class="p">)</span>
   66     <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Check/update your MayaChemTools environment and try again.</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
   67     <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
   68 
   69 <span class="n">ScriptName</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
   70 <span class="n">Options</span> <span class="o">=</span> <span class="p">{}</span>
   71 <span class="n">OptionsInfo</span> <span class="o">=</span> <span class="p">{}</span>
   72 
   73 <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
   74     <span class="sd">&quot;&quot;&quot;Start execution of the script.&quot;&quot;&quot;</span>
   75     
   76     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">%s</span><span class="s2"> (Psi4: Imported later; RDKit v</span><span class="si">%s</span><span class="s2">; MayaChemTools v</span><span class="si">%s</span><span class="s2">; </span><span class="si">%s</span><span class="s2">): Starting...</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ScriptName</span><span class="p">,</span> <span class="n">rdBase</span><span class="o">.</span><span class="n">rdkitVersion</span><span class="p">,</span> <span class="n">MiscUtil</span><span class="o">.</span><span class="n">GetMayaChemToolsVersion</span><span class="p">(),</span> <span class="n">time</span><span class="o">.</span><span class="n">asctime</span><span class="p">()))</span>
   77     
   78     <span class="p">(</span><span class="n">WallClockTime</span><span class="p">,</span> <span class="n">ProcessorTime</span><span class="p">)</span> <span class="o">=</span> <span class="n">MiscUtil</span><span class="o">.</span><span class="n">GetWallClockAndProcessorTime</span><span class="p">()</span>
   79     
   80     <span class="c1"># Retrieve command line arguments and options...</span>
   81     <span class="n">RetrieveOptions</span><span class="p">()</span>
   82     
   83     <span class="c1"># Process and validate command line arguments and options...</span>
   84     <span class="n">ProcessOptions</span><span class="p">()</span>
   85     
   86     <span class="c1"># Perform actions required by the script...</span>
   87     <span class="n">GenerateConformers</span><span class="p">()</span>
   88     
   89     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">%s</span><span class="s2">: Done...</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">ScriptName</span><span class="p">)</span>
   90     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;Total time: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">MiscUtil</span><span class="o">.</span><span class="n">GetFormattedElapsedTime</span><span class="p">(</span><span class="n">WallClockTime</span><span class="p">,</span> <span class="n">ProcessorTime</span><span class="p">))</span>
   91 
   92 <span class="k">def</span> <span class="nf">GenerateConformers</span><span class="p">():</span>
   93     <span class="sd">&quot;&quot;&quot;Generate conformers.&quot;&quot;&quot;</span>
   94     
   95     <span class="c1"># Setup a molecule reader...</span>
   96     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Processing file </span><span class="si">%s</span><span class="s2">...&quot;</span> <span class="o">%</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Infile&quot;</span><span class="p">])</span>
   97     <span class="n">Mols</span>  <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">ReadMolecules</span><span class="p">(</span><span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Infile&quot;</span><span class="p">],</span> <span class="o">**</span><span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;InfileParams&quot;</span><span class="p">])</span>
   98     
   99     <span class="c1"># Set up a molecule writer...</span>
  100     <span class="n">Writer</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">MoleculesWriter</span><span class="p">(</span><span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Outfile&quot;</span><span class="p">],</span> <span class="o">**</span><span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;OutfileParams&quot;</span><span class="p">])</span>
  101     <span class="k">if</span> <span class="n">Writer</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
  102         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintError</span><span class="p">(</span><span class="s2">&quot;Failed to setup a writer for output fie </span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Outfile&quot;</span><span class="p">])</span>
  103     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;Generating file </span><span class="si">%s</span><span class="s2">...&quot;</span> <span class="o">%</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Outfile&quot;</span><span class="p">])</span>
  104 
  105     <span class="n">MolCount</span><span class="p">,</span> <span class="n">ValidMolCount</span><span class="p">,</span> <span class="n">ConfGenFailedCount</span> <span class="o">=</span> <span class="n">ProcessMolecules</span><span class="p">(</span><span class="n">Mols</span><span class="p">,</span> <span class="n">Writer</span><span class="p">)</span>
  106 
  107     <span class="k">if</span> <span class="n">Writer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
  108         <span class="n">Writer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
  109     
  110     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Total number of molecules: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">MolCount</span><span class="p">)</span>
  111     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;Number of valid molecules: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">ValidMolCount</span><span class="p">)</span>
  112     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;Number of molecules failed during conformation generation or minimization: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">ConfGenFailedCount</span><span class="p">)</span>
  113     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;Number of ignored molecules: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">MolCount</span> <span class="o">-</span> <span class="n">ValidMolCount</span> <span class="o">+</span> <span class="n">ConfGenFailedCount</span><span class="p">))</span>
  114 
  115 <span class="k">def</span> <span class="nf">ProcessMolecules</span><span class="p">(</span><span class="n">Mols</span><span class="p">,</span> <span class="n">Writer</span><span class="p">):</span>
  116     <span class="sd">&quot;&quot;&quot;Process molecules to generate conformers.&quot;&quot;&quot;</span>
  117     
  118     <span class="k">if</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;MPMode&quot;</span><span class="p">]:</span>
  119         <span class="k">return</span> <span class="n">ProcessMoleculesUsingMultipleProcesses</span><span class="p">(</span><span class="n">Mols</span><span class="p">,</span> <span class="n">Writer</span><span class="p">)</span>
  120     <span class="k">else</span><span class="p">:</span>
  121         <span class="k">return</span> <span class="n">ProcessMoleculesUsingSingleProcess</span><span class="p">(</span><span class="n">Mols</span><span class="p">,</span> <span class="n">Writer</span><span class="p">)</span>
  122 
  123 <span class="k">def</span> <span class="nf">ProcessMoleculesUsingSingleProcess</span><span class="p">(</span><span class="n">Mols</span><span class="p">,</span> <span class="n">Writer</span><span class="p">):</span>
  124     <span class="sd">&quot;&quot;&quot;Process molecules to generate conformers using a single process.&quot;&quot;&quot;</span>
  125     
  126     <span class="c1"># Intialize Psi4...</span>
  127     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Initializing Psi4...&quot;</span><span class="p">)</span>
  128     <span class="n">Psi4Handle</span> <span class="o">=</span> <span class="n">Psi4Util</span><span class="o">.</span><span class="n">InitializePsi4</span><span class="p">(</span><span class="n">Psi4RunParams</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Psi4RunParams&quot;</span><span class="p">],</span> <span class="n">Psi4OptionsParams</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Psi4OptionsParams&quot;</span><span class="p">],</span> <span class="n">PrintVersion</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">PrintHeader</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
  129     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;psi4&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Psi4Handle</span>
  130 
  131     <span class="c1"># Setup max iterations global variable...</span>
  132     <span class="n">Psi4Util</span><span class="o">.</span><span class="n">UpdatePsi4OptionsParameters</span><span class="p">(</span><span class="n">Psi4Handle</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;GEOM_MAXITER&#39;</span><span class="p">:</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;MaxIters&quot;</span><span class="p">]})</span>
  133     
  134     <span class="c1"># Setup conversion factor for energy units...</span>
  135     <span class="n">SetupEnergyConversionFactor</span><span class="p">(</span><span class="n">Psi4Handle</span><span class="p">)</span>
  136 
  137     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Generating conformers and performing energy minimization...&quot;</span><span class="p">)</span>
  138 
  139     <span class="p">(</span><span class="n">MolCount</span><span class="p">,</span> <span class="n">ValidMolCount</span><span class="p">,</span> <span class="n">ConfGenFailedCount</span><span class="p">)</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span>
  140     <span class="k">for</span> <span class="n">Mol</span> <span class="ow">in</span> <span class="n">Mols</span><span class="p">:</span>
  141         <span class="n">MolCount</span> <span class="o">+=</span> <span class="mi">1</span>
  142 
  143         <span class="k">if</span> <span class="ow">not</span> <span class="n">CheckAndValidateMolecule</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolCount</span><span class="p">):</span>
  144             <span class="k">continue</span>
  145 
  146         <span class="c1"># Setup 2D coordinates for SMILES input file...</span>
  147         <span class="k">if</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;SMILESInfileStatus&quot;</span><span class="p">]:</span>
  148             <span class="n">AllChem</span><span class="o">.</span><span class="n">Compute2DCoords</span><span class="p">(</span><span class="n">Mol</span><span class="p">)</span>
  149         
  150         <span class="n">ValidMolCount</span> <span class="o">+=</span> <span class="mi">1</span>
  151 
  152         <span class="n">ConformerMol</span><span class="p">,</span> <span class="n">CalcStatus</span><span class="p">,</span> <span class="n">ConfIDs</span><span class="p">,</span> <span class="n">ConfEnergies</span> <span class="o">=</span> <span class="n">GenerateMolConformers</span><span class="p">(</span><span class="n">Psi4Handle</span><span class="p">,</span> <span class="n">Mol</span><span class="p">,</span> <span class="n">MolCount</span><span class="p">)</span>
  153 
  154         <span class="k">if</span> <span class="ow">not</span> <span class="n">CalcStatus</span><span class="p">:</span>
  155             <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]:</span>
  156                 <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintWarning</span><span class="p">(</span><span class="s2">&quot;Failed to calculate energy for molecule </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">GetMolName</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolCount</span><span class="p">))</span>
  157             
  158             <span class="n">ConfGenFailedCount</span> <span class="o">+=</span> <span class="mi">1</span>
  159             <span class="k">continue</span>
  160 
  161         <span class="n">WriteMolConformers</span><span class="p">(</span><span class="n">Writer</span><span class="p">,</span> <span class="n">ConformerMol</span><span class="p">,</span> <span class="n">MolCount</span><span class="p">,</span> <span class="n">ConfIDs</span><span class="p">,</span> <span class="n">ConfEnergies</span><span class="p">)</span>
  162         
  163     <span class="k">return</span> <span class="p">(</span><span class="n">MolCount</span><span class="p">,</span> <span class="n">ValidMolCount</span><span class="p">,</span> <span class="n">ConfGenFailedCount</span><span class="p">)</span>
  164 
  165 <span class="k">def</span> <span class="nf">ProcessMoleculesUsingMultipleProcesses</span><span class="p">(</span><span class="n">Mols</span><span class="p">,</span> <span class="n">Writer</span><span class="p">):</span>
  166     <span class="sd">&quot;&quot;&quot;Process and minimize molecules using multiprocessing.&quot;&quot;&quot;</span>
  167     
  168     <span class="k">if</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;MPLevelConformersMode&quot;</span><span class="p">]:</span>
  169         <span class="k">return</span> <span class="n">ProcessMoleculesUsingMultipleProcessesAtConformersLevel</span><span class="p">(</span><span class="n">Mols</span><span class="p">,</span> <span class="n">Writer</span><span class="p">)</span>
  170     <span class="k">elif</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;MPLevelMoleculesMode&quot;</span><span class="p">]:</span>
  171         <span class="k">return</span> <span class="n">ProcessMoleculesUsingMultipleProcessesAtMoleculesLevel</span><span class="p">(</span><span class="n">Mols</span><span class="p">,</span> <span class="n">Writer</span><span class="p">)</span>
  172     <span class="k">else</span><span class="p">:</span>
  173         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintError</span><span class="p">(</span><span class="s2">&quot;The value, </span><span class="si">%s</span><span class="s2">,  option </span><span class="se">\&quot;</span><span class="s2">--mpLevel</span><span class="se">\&quot;</span><span class="s2"> is not supported.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;MPLevel&quot;</span><span class="p">]))</span>
  174         
  175 <span class="k">def</span> <span class="nf">ProcessMoleculesUsingMultipleProcessesAtMoleculesLevel</span><span class="p">(</span><span class="n">Mols</span><span class="p">,</span> <span class="n">Writer</span><span class="p">):</span>
  176     <span class="sd">&quot;&quot;&quot;Process molecules to generate conformers using multiprocessing at molecules level.&quot;&quot;&quot;</span>
  177 
  178     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Generating conformers and performing energy minimization using multiprocessing at molecules level...&quot;</span><span class="p">)</span>
  179 
  180     <span class="n">MPParams</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;MPParams&quot;</span><span class="p">]</span>
  181     
  182     <span class="c1"># Setup data for initializing a worker process...</span>
  183     <span class="n">InitializeWorkerProcessArgs</span> <span class="o">=</span> <span class="p">(</span><span class="n">MiscUtil</span><span class="o">.</span><span class="n">ObjectToBase64EncodedString</span><span class="p">(</span><span class="n">Options</span><span class="p">),</span> <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ObjectToBase64EncodedString</span><span class="p">(</span><span class="n">OptionsInfo</span><span class="p">))</span>
  184     
  185     <span class="c1"># Setup a encoded mols data iterable for a worker process...</span>
  186     <span class="n">WorkerProcessDataIterable</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">GenerateBase64EncodedMolStrings</span><span class="p">(</span><span class="n">Mols</span><span class="p">)</span>
  187     
  188     <span class="c1"># Setup process pool along with data initialization for each process...</span>
  189     <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]:</span>
  190         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Configuring multiprocessing using </span><span class="si">%s</span><span class="s2"> method...&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s2">&quot;mp.Pool.imap()&quot;</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^Lazy$&quot;</span><span class="p">,</span> <span class="n">MPParams</span><span class="p">[</span><span class="s2">&quot;InputDataMode&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;mp.Pool.map()&quot;</span><span class="p">))</span>
  191         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;NumProcesses: </span><span class="si">%s</span><span class="s2">; InputDataMode: </span><span class="si">%s</span><span class="s2">; ChunkSize: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">MPParams</span><span class="p">[</span><span class="s2">&quot;NumProcesses&quot;</span><span class="p">],</span> <span class="n">MPParams</span><span class="p">[</span><span class="s2">&quot;InputDataMode&quot;</span><span class="p">],</span> <span class="p">(</span><span class="s2">&quot;automatic&quot;</span> <span class="k">if</span> <span class="n">MPParams</span><span class="p">[</span><span class="s2">&quot;ChunkSize&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">MPParams</span><span class="p">[</span><span class="s2">&quot;ChunkSize&quot;</span><span class="p">])))</span>
  192     
  193     <span class="n">ProcessPool</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">MPParams</span><span class="p">[</span><span class="s2">&quot;NumProcesses&quot;</span><span class="p">],</span> <span class="n">InitializeWorkerProcess</span><span class="p">,</span> <span class="n">InitializeWorkerProcessArgs</span><span class="p">)</span>
  194     
  195     <span class="c1"># Start processing...</span>
  196     <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^Lazy$&quot;</span><span class="p">,</span> <span class="n">MPParams</span><span class="p">[</span><span class="s2">&quot;InputDataMode&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
  197         <span class="n">Results</span> <span class="o">=</span> <span class="n">ProcessPool</span><span class="o">.</span><span class="n">imap</span><span class="p">(</span><span class="n">WorkerProcess</span><span class="p">,</span> <span class="n">WorkerProcessDataIterable</span><span class="p">,</span> <span class="n">MPParams</span><span class="p">[</span><span class="s2">&quot;ChunkSize&quot;</span><span class="p">])</span>
  198     <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^InMemory$&quot;</span><span class="p">,</span> <span class="n">MPParams</span><span class="p">[</span><span class="s2">&quot;InputDataMode&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
  199         <span class="n">Results</span> <span class="o">=</span> <span class="n">ProcessPool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">WorkerProcess</span><span class="p">,</span> <span class="n">WorkerProcessDataIterable</span><span class="p">,</span> <span class="n">MPParams</span><span class="p">[</span><span class="s2">&quot;ChunkSize&quot;</span><span class="p">])</span>
  200     <span class="k">else</span><span class="p">:</span>
  201         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintError</span><span class="p">(</span><span class="s2">&quot;The value, </span><span class="si">%s</span><span class="s2">, specified for </span><span class="se">\&quot;</span><span class="s2">--inputDataMode</span><span class="se">\&quot;</span><span class="s2"> is not supported.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">MPParams</span><span class="p">[</span><span class="s2">&quot;InputDataMode&quot;</span><span class="p">]))</span>
  202     
  203     <span class="c1"># Print out Psi4 version in the main process...</span>
  204     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Initializing Psi4...</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
  205     <span class="n">Psi4Handle</span>  <span class="o">=</span> <span class="n">Psi4Util</span><span class="o">.</span><span class="n">InitializePsi4</span><span class="p">(</span><span class="n">PrintVersion</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">PrintHeader</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span>
  206     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;psi4&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Psi4Handle</span>
  207     
  208     <span class="p">(</span><span class="n">MolCount</span><span class="p">,</span> <span class="n">ValidMolCount</span><span class="p">,</span> <span class="n">ConfGenFailedCount</span><span class="p">)</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span>
  209     <span class="k">for</span> <span class="n">Result</span> <span class="ow">in</span> <span class="n">Results</span><span class="p">:</span>
  210         <span class="n">MolCount</span> <span class="o">+=</span> <span class="mi">1</span>
  211         <span class="n">MolIndex</span><span class="p">,</span> <span class="n">EncodedMol</span><span class="p">,</span> <span class="n">CalcStatus</span><span class="p">,</span> <span class="n">ConfIDs</span><span class="p">,</span> <span class="n">ConfEnergies</span> <span class="o">=</span> <span class="n">Result</span>
  212         
  213         <span class="k">if</span> <span class="n">EncodedMol</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
  214             <span class="k">continue</span>
  215         <span class="n">ValidMolCount</span> <span class="o">+=</span> <span class="mi">1</span>
  216 
  217         <span class="k">if</span> <span class="ow">not</span> <span class="n">CalcStatus</span><span class="p">:</span>
  218             <span class="n">ConfGenFailedCount</span> <span class="o">+=</span> <span class="mi">1</span>
  219             <span class="k">continue</span>
  220             
  221         <span class="n">Mol</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">MolFromBase64EncodedMolString</span><span class="p">(</span><span class="n">EncodedMol</span><span class="p">)</span>
  222         <span class="n">WriteMolConformers</span><span class="p">(</span><span class="n">Writer</span><span class="p">,</span> <span class="n">Mol</span><span class="p">,</span> <span class="n">MolCount</span><span class="p">,</span> <span class="n">ConfIDs</span><span class="p">,</span> <span class="n">ConfEnergies</span><span class="p">)</span>
  223         
  224     <span class="k">return</span> <span class="p">(</span><span class="n">MolCount</span><span class="p">,</span> <span class="n">ValidMolCount</span><span class="p">,</span> <span class="n">ConfGenFailedCount</span><span class="p">)</span>
  225 
  226 <span class="k">def</span> <span class="nf">InitializeWorkerProcess</span><span class="p">(</span><span class="o">*</span><span class="n">EncodedArgs</span><span class="p">):</span>
  227     <span class="sd">&quot;&quot;&quot;Initialize data for a worker process.&quot;&quot;&quot;</span>
  228     
  229     <span class="k">global</span> <span class="n">Options</span><span class="p">,</span> <span class="n">OptionsInfo</span>
  230 
  231     <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]:</span>
  232         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;Starting process (PID: </span><span class="si">%s</span><span class="s2">)...&quot;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">())</span>
  233     
  234     <span class="c1"># Decode Options and OptionInfo...</span>
  235     <span class="n">Options</span> <span class="o">=</span> <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ObjectFromBase64EncodedString</span><span class="p">(</span><span class="n">EncodedArgs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
  236     <span class="n">OptionsInfo</span> <span class="o">=</span> <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ObjectFromBase64EncodedString</span><span class="p">(</span><span class="n">EncodedArgs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
  237     
  238     <span class="c1"># Psi4 is initialized in the worker process to avoid creation of redundant Psi4</span>
  239     <span class="c1"># output files for each process...</span>
  240     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Psi4Initialized&quot;</span><span class="p">]</span>  <span class="o">=</span> <span class="bp">False</span>
  241 
  242 <span class="k">def</span> <span class="nf">WorkerProcess</span><span class="p">(</span><span class="n">EncodedMolInfo</span><span class="p">):</span>
  243     <span class="sd">&quot;&quot;&quot;Process data for a worker process.&quot;&quot;&quot;</span>
  244 
  245     <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Psi4Initialized&quot;</span><span class="p">]:</span>
  246         <span class="n">InitializePsi4ForWorkerProcess</span><span class="p">()</span>
  247     
  248     <span class="n">MolIndex</span><span class="p">,</span> <span class="n">EncodedMol</span> <span class="o">=</span> <span class="n">EncodedMolInfo</span>
  249     <span class="n">MolNum</span> <span class="o">=</span> <span class="n">MolIndex</span> <span class="o">+</span> <span class="mi">1</span>
  250     
  251     <span class="n">CalcStatus</span> <span class="o">=</span> <span class="bp">False</span>
  252     <span class="n">ConfIDs</span> <span class="o">=</span> <span class="bp">None</span>
  253     <span class="n">ConfEnergies</span> <span class="o">=</span> <span class="bp">None</span>
  254     
  255     <span class="k">if</span> <span class="n">EncodedMol</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
  256         <span class="k">return</span> <span class="p">[</span><span class="n">MolIndex</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">CalcStatus</span><span class="p">,</span> <span class="n">ConfIDs</span><span class="p">,</span> <span class="n">ConfEnergies</span><span class="p">]</span>
  257 
  258     <span class="n">Mol</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">MolFromBase64EncodedMolString</span><span class="p">(</span><span class="n">EncodedMol</span><span class="p">)</span>
  259     
  260     <span class="k">if</span> <span class="ow">not</span> <span class="n">CheckAndValidateMolecule</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">):</span>
  261         <span class="k">return</span> <span class="p">[</span><span class="n">MolIndex</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">CalcStatus</span><span class="p">,</span> <span class="n">ConfIDs</span><span class="p">,</span> <span class="n">ConfEnergies</span><span class="p">]</span>
  262     
  263     <span class="c1"># Setup 2D coordinates for SMILES input file...</span>
  264     <span class="k">if</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;SMILESInfileStatus&quot;</span><span class="p">]:</span>
  265         <span class="n">AllChem</span><span class="o">.</span><span class="n">Compute2DCoords</span><span class="p">(</span><span class="n">Mol</span><span class="p">)</span>
  266     
  267     <span class="n">Mol</span><span class="p">,</span> <span class="n">CalcStatus</span><span class="p">,</span> <span class="n">ConfIDs</span><span class="p">,</span> <span class="n">ConfEnergies</span> <span class="o">=</span> <span class="n">GenerateMolConformers</span><span class="p">(</span><span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;psi4&quot;</span><span class="p">],</span> <span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">)</span>
  268 
  269     <span class="k">return</span> <span class="p">[</span><span class="n">MolIndex</span><span class="p">,</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">MolToBase64EncodedMolString</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">PropertyPickleFlags</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">PropertyPickleOptions</span><span class="o">.</span><span class="n">MolProps</span> <span class="o">|</span> <span class="n">Chem</span><span class="o">.</span><span class="n">PropertyPickleOptions</span><span class="o">.</span><span class="n">PrivateProps</span><span class="p">),</span> <span class="n">CalcStatus</span><span class="p">,</span> <span class="n">ConfIDs</span><span class="p">,</span> <span class="n">ConfEnergies</span><span class="p">]</span>
  270 
  271 <span class="k">def</span> <span class="nf">ProcessMoleculesUsingMultipleProcessesAtConformersLevel</span><span class="p">(</span><span class="n">Mols</span><span class="p">,</span> <span class="n">Writer</span><span class="p">):</span>
  272     <span class="sd">&quot;&quot;&quot;Process molecules to generate conformers using multiprocessing at conformers level.&quot;&quot;&quot;</span>
  273 
  274     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Performing minimization with generation of conformers using multiprocessing at conformers level...&quot;</span><span class="p">)</span>
  275 
  276     <span class="p">(</span><span class="n">MolCount</span><span class="p">,</span> <span class="n">ValidMolCount</span><span class="p">,</span> <span class="n">ConfGenFailedCount</span><span class="p">)</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span>
  277     <span class="k">for</span> <span class="n">Mol</span> <span class="ow">in</span> <span class="n">Mols</span><span class="p">:</span>
  278         <span class="n">MolCount</span> <span class="o">+=</span> <span class="mi">1</span>
  279         
  280         <span class="k">if</span> <span class="ow">not</span> <span class="n">CheckAndValidateMolecule</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolCount</span><span class="p">):</span>
  281             <span class="k">continue</span>
  282 
  283         <span class="c1"># Setup 2D coordinates for SMILES input file...</span>
  284         <span class="k">if</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;SMILESInfileStatus&quot;</span><span class="p">]:</span>
  285             <span class="n">AllChem</span><span class="o">.</span><span class="n">Compute2DCoords</span><span class="p">(</span><span class="n">Mol</span><span class="p">)</span>
  286 
  287         <span class="n">ValidMolCount</span> <span class="o">+=</span> <span class="mi">1</span>
  288         
  289         <span class="n">Mol</span><span class="p">,</span> <span class="n">CalcStatus</span><span class="p">,</span> <span class="n">ConfIDs</span><span class="p">,</span> <span class="n">ConfEnergies</span> <span class="o">=</span> <span class="n">ProcessConformersUsingMultipleProcesses</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolCount</span><span class="p">)</span>
  290 
  291         <span class="k">if</span> <span class="ow">not</span> <span class="n">CalcStatus</span><span class="p">:</span>
  292             <span class="n">ConfGenFailedCount</span> <span class="o">+=</span> <span class="mi">1</span>
  293             <span class="k">continue</span>
  294         
  295         <span class="n">WriteMolConformers</span><span class="p">(</span><span class="n">Writer</span><span class="p">,</span> <span class="n">Mol</span><span class="p">,</span> <span class="n">MolCount</span><span class="p">,</span> <span class="n">ConfIDs</span><span class="p">,</span> <span class="n">ConfEnergies</span><span class="p">)</span>
  296         
  297     <span class="k">return</span> <span class="p">(</span><span class="n">MolCount</span><span class="p">,</span> <span class="n">ValidMolCount</span><span class="p">,</span> <span class="n">ConfGenFailedCount</span><span class="p">)</span>
  298 
  299 <span class="k">def</span> <span class="nf">ProcessConformersUsingMultipleProcesses</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">):</span>
  300     <span class="sd">&quot;&quot;&quot;Generate coformers and minimize them using multiple processes.&quot;&quot;&quot;</span>
  301 
  302     <span class="c1"># Add hydrogens...</span>
  303     <span class="n">Mol</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">AddHs</span><span class="p">(</span><span class="n">Mol</span><span class="p">)</span>
  304 
  305     <span class="c1"># Setup conformers...</span>
  306     <span class="n">ConfIDs</span> <span class="o">=</span> <span class="n">EmbedMolecule</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">)</span>
  307     <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">ConfIDs</span><span class="p">):</span>
  308         <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]:</span>
  309             <span class="n">MolName</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">GetMolName</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">)</span>
  310             <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintWarning</span><span class="p">(</span><span class="s2">&quot;Minimization couldn&#39;t be performed for molecule </span><span class="si">%s</span><span class="s2">: Embedding failed...</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">MolName</span><span class="p">)</span>
  311         <span class="k">return</span> <span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
  312 
  313     <span class="n">MPParams</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;MPParams&quot;</span><span class="p">]</span>
  314     
  315     <span class="c1"># Setup data for initializing a worker process...</span>
  316     <span class="n">InitializeWorkerProcessArgs</span> <span class="o">=</span> <span class="p">(</span><span class="n">MiscUtil</span><span class="o">.</span><span class="n">ObjectToBase64EncodedString</span><span class="p">(</span><span class="n">Options</span><span class="p">),</span> <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ObjectToBase64EncodedString</span><span class="p">(</span><span class="n">OptionsInfo</span><span class="p">))</span>
  317 
  318     <span class="c1"># Setup a encoded mols data iterable for a worker process...</span>
  319     <span class="n">MolIndex</span> <span class="o">=</span> <span class="n">MolNum</span> <span class="o">-</span> <span class="mi">1</span>
  320     <span class="n">WorkerProcessDataIterable</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">GenerateBase64EncodedMolStringWithConfIDs</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolIndex</span><span class="p">,</span> <span class="n">ConfIDs</span><span class="p">)</span>
  321 
  322     <span class="c1"># Setup process pool along with data initialization for each process...</span>
  323     <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]:</span>
  324         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Configuring multiprocessing using </span><span class="si">%s</span><span class="s2"> method...&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s2">&quot;mp.Pool.imap()&quot;</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^Lazy$&quot;</span><span class="p">,</span> <span class="n">MPParams</span><span class="p">[</span><span class="s2">&quot;InputDataMode&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;mp.Pool.map()&quot;</span><span class="p">))</span>
  325         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;NumProcesses: </span><span class="si">%s</span><span class="s2">; InputDataMode: </span><span class="si">%s</span><span class="s2">; ChunkSize: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">MPParams</span><span class="p">[</span><span class="s2">&quot;NumProcesses&quot;</span><span class="p">],</span> <span class="n">MPParams</span><span class="p">[</span><span class="s2">&quot;InputDataMode&quot;</span><span class="p">],</span> <span class="p">(</span><span class="s2">&quot;automatic&quot;</span> <span class="k">if</span> <span class="n">MPParams</span><span class="p">[</span><span class="s2">&quot;ChunkSize&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">MPParams</span><span class="p">[</span><span class="s2">&quot;ChunkSize&quot;</span><span class="p">])))</span>
  326     
  327     <span class="n">ProcessPool</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">MPParams</span><span class="p">[</span><span class="s2">&quot;NumProcesses&quot;</span><span class="p">],</span> <span class="n">InitializeConformerWorkerProcess</span><span class="p">,</span> <span class="n">InitializeWorkerProcessArgs</span><span class="p">)</span>
  328     
  329     <span class="c1"># Start processing...</span>
  330     <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^Lazy$&quot;</span><span class="p">,</span> <span class="n">MPParams</span><span class="p">[</span><span class="s2">&quot;InputDataMode&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
  331         <span class="n">Results</span> <span class="o">=</span> <span class="n">ProcessPool</span><span class="o">.</span><span class="n">imap</span><span class="p">(</span><span class="n">ConformerWorkerProcess</span><span class="p">,</span> <span class="n">WorkerProcessDataIterable</span><span class="p">,</span> <span class="n">MPParams</span><span class="p">[</span><span class="s2">&quot;ChunkSize&quot;</span><span class="p">])</span>
  332     <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^InMemory$&quot;</span><span class="p">,</span> <span class="n">MPParams</span><span class="p">[</span><span class="s2">&quot;InputDataMode&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
  333         <span class="n">Results</span> <span class="o">=</span> <span class="n">ProcessPool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">ConformerWorkerProcess</span><span class="p">,</span> <span class="n">WorkerProcessDataIterable</span><span class="p">,</span> <span class="n">MPParams</span><span class="p">[</span><span class="s2">&quot;ChunkSize&quot;</span><span class="p">])</span>
  334     <span class="k">else</span><span class="p">:</span>
  335         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintError</span><span class="p">(</span><span class="s2">&quot;The value, </span><span class="si">%s</span><span class="s2">, specified for </span><span class="se">\&quot;</span><span class="s2">--inputDataMode</span><span class="se">\&quot;</span><span class="s2"> is not supported.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">MPParams</span><span class="p">[</span><span class="s2">&quot;InputDataMode&quot;</span><span class="p">]))</span>
  336     
  337     <span class="n">CalcEnergyMap</span> <span class="o">=</span> <span class="p">{}</span>
  338     <span class="n">CalcFailedCount</span> <span class="o">=</span> <span class="mi">0</span>
  339     <span class="k">for</span> <span class="n">Result</span> <span class="ow">in</span> <span class="n">Results</span><span class="p">:</span>
  340         <span class="n">MolIndex</span><span class="p">,</span> <span class="n">EncodedMol</span><span class="p">,</span> <span class="n">CalcStatus</span><span class="p">,</span> <span class="n">ConfID</span><span class="p">,</span> <span class="n">Energy</span> <span class="o">=</span> <span class="n">Result</span>
  341 
  342         <span class="k">if</span> <span class="n">EncodedMol</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
  343             <span class="n">CalcFailedCount</span> <span class="o">+=</span> <span class="mi">1</span>
  344             <span class="k">continue</span>
  345         
  346         <span class="k">if</span> <span class="ow">not</span> <span class="n">CalcStatus</span><span class="p">:</span>
  347             <span class="n">CalcFailedCount</span> <span class="o">+=</span> <span class="mi">1</span>
  348             <span class="k">continue</span>
  349         
  350         <span class="c1"># Retrieve minimized atom positions...</span>
  351         <span class="n">MinimizedMol</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">MolFromBase64EncodedMolString</span><span class="p">(</span><span class="n">EncodedMol</span><span class="p">)</span>
  352         <span class="n">AtomPositions</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">GetAtomPositions</span><span class="p">(</span><span class="n">MinimizedMol</span><span class="p">,</span> <span class="n">ConfID</span> <span class="o">=</span> <span class="n">ConfID</span><span class="p">)</span>
  353 
  354         <span class="c1"># Update atom positions...</span>
  355         <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">SetAtomPositions</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">AtomPositions</span><span class="p">,</span> <span class="n">ConfID</span> <span class="o">=</span> <span class="n">ConfID</span><span class="p">)</span>
  356         
  357         <span class="n">CalcEnergyMap</span><span class="p">[</span><span class="n">ConfID</span><span class="p">]</span> <span class="o">=</span> <span class="n">Energy</span>
  358     
  359     <span class="k">if</span> <span class="n">CalcFailedCount</span><span class="p">:</span>
  360         <span class="k">return</span> <span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
  361     
  362     <span class="c1"># Align molecules after minimization...</span>
  363     <span class="k">if</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;ConfGenerationParams&quot;</span><span class="p">][</span><span class="s2">&quot;AlignConformers&quot;</span><span class="p">]:</span>
  364         <span class="n">AllChem</span><span class="o">.</span><span class="n">AlignMolConformers</span><span class="p">(</span><span class="n">Mol</span><span class="p">)</span>
  365 
  366     <span class="c1"># Filter conformers...</span>
  367     <span class="n">SelectedConfIDs</span><span class="p">,</span> <span class="n">SelectedConfEnergies</span> <span class="o">=</span> <span class="n">FilterMolConformers</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">,</span> <span class="n">ConfIDs</span><span class="p">,</span> <span class="n">CalcEnergyMap</span><span class="p">)</span>
  368     
  369     <span class="k">return</span> <span class="p">[</span><span class="n">Mol</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="n">SelectedConfIDs</span><span class="p">,</span> <span class="n">SelectedConfEnergies</span><span class="p">]</span>
  370     
  371 <span class="k">def</span> <span class="nf">InitializeConformerWorkerProcess</span><span class="p">(</span><span class="o">*</span><span class="n">EncodedArgs</span><span class="p">):</span>
  372     <span class="sd">&quot;&quot;&quot;Initialize data for a conformer worker process.&quot;&quot;&quot;</span>
  373     
  374     <span class="k">global</span> <span class="n">Options</span><span class="p">,</span> <span class="n">OptionsInfo</span>
  375     
  376     <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]:</span>
  377         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;Starting process (PID: </span><span class="si">%s</span><span class="s2">)...&quot;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">())</span>
  378     
  379     <span class="c1"># Decode Options and OptionInfo...</span>
  380     <span class="n">Options</span> <span class="o">=</span> <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ObjectFromBase64EncodedString</span><span class="p">(</span><span class="n">EncodedArgs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
  381     <span class="n">OptionsInfo</span> <span class="o">=</span> <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ObjectFromBase64EncodedString</span><span class="p">(</span><span class="n">EncodedArgs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
  382     
  383     <span class="c1"># Psi4 is initialized in the worker process to avoid creation of redundant Psi4</span>
  384     <span class="c1"># output files for each process...</span>
  385     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Psi4Initialized&quot;</span><span class="p">]</span>  <span class="o">=</span> <span class="bp">False</span>
  386 
  387 <span class="k">def</span> <span class="nf">ConformerWorkerProcess</span><span class="p">(</span><span class="n">EncodedMolInfo</span><span class="p">):</span>
  388     <span class="sd">&quot;&quot;&quot;Process data for a conformer worker process.&quot;&quot;&quot;</span>
  389 
  390     <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Psi4Initialized&quot;</span><span class="p">]:</span>
  391         <span class="n">InitializePsi4ForWorkerProcess</span><span class="p">()</span>
  392     
  393     <span class="n">MolIndex</span><span class="p">,</span> <span class="n">EncodedMol</span><span class="p">,</span> <span class="n">ConfID</span> <span class="o">=</span> <span class="n">EncodedMolInfo</span>
  394 
  395     <span class="n">MolNum</span> <span class="o">=</span> <span class="n">MolIndex</span> <span class="o">+</span> <span class="mi">1</span>
  396     
  397     <span class="n">CalcStatus</span> <span class="o">=</span> <span class="bp">False</span>
  398     <span class="n">Energy</span> <span class="o">=</span> <span class="bp">None</span>
  399     
  400     <span class="k">if</span> <span class="n">EncodedMol</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
  401         <span class="k">return</span> <span class="p">[</span><span class="n">MolIndex</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">CalcStatus</span><span class="p">,</span> <span class="n">ConfID</span><span class="p">,</span> <span class="n">Energy</span><span class="p">]</span>
  402     
  403     <span class="n">Mol</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">MolFromBase64EncodedMolString</span><span class="p">(</span><span class="n">EncodedMol</span><span class="p">)</span>
  404     <span class="n">MolName</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">GetMolName</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">)</span>
  405     
  406     <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]:</span>
  407         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;Processing conformer ID </span><span class="si">%s</span><span class="s2"> for molecule </span><span class="si">%s</span><span class="s2">...&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ConfID</span><span class="p">,</span> <span class="n">MolName</span><span class="p">))</span>
  408     
  409     <span class="n">Status</span><span class="p">,</span> <span class="n">ConvergeStatus</span> <span class="o">=</span> <span class="n">MinimizeMoleculeUsingForceField</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">,</span> <span class="n">ConfID</span><span class="p">)</span>
  410     <span class="k">if</span> <span class="ow">not</span> <span class="n">Status</span><span class="p">:</span>
  411         <span class="k">return</span> <span class="p">[</span><span class="n">MolIndex</span><span class="p">,</span> <span class="n">EncodedMol</span><span class="p">,</span> <span class="n">CalcStatus</span><span class="p">,</span> <span class="n">ConfID</span><span class="p">,</span> <span class="n">Energy</span><span class="p">]</span>
  412     
  413     <span class="k">if</span> <span class="n">ConvergeStatus</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
  414         <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]:</span>
  415             <span class="n">MolName</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">GetMolName</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="p">(</span><span class="n">MolIndex</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
  416             <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintWarning</span><span class="p">(</span><span class="s2">&quot;Minimization using forcefield failed to converge for molecule </span><span class="si">%s</span><span class="s2"> in </span><span class="si">%d</span><span class="s2"> steps. Try using higher value for </span><span class="se">\&quot;</span><span class="s2">maxIters</span><span class="se">\&quot;</span><span class="s2"> in </span><span class="se">\&quot;</span><span class="s2">--confParams</span><span class="se">\&quot;</span><span class="s2"> option...</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">MolName</span><span class="p">,</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;ConfGenerationParams&quot;</span><span class="p">][</span><span class="s2">&quot;MaxIters&quot;</span><span class="p">]))</span>
  417     
  418     <span class="c1"># Perform Psi4 minimization...</span>
  419     <span class="n">CalcStatus</span><span class="p">,</span> <span class="n">Energy</span> <span class="o">=</span> <span class="n">MinimizeMoleculeUsingPsi4</span><span class="p">(</span><span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;psi4&quot;</span><span class="p">],</span> <span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">,</span> <span class="n">ConfID</span><span class="p">)</span>
  420     <span class="k">if</span> <span class="ow">not</span> <span class="n">CalcStatus</span><span class="p">:</span>
  421         <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]:</span>
  422             <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintWarning</span><span class="p">(</span><span class="s2">&quot;Minimization couldn&#39;t be performed for molecule </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">MolName</span><span class="p">))</span>
  423             <span class="k">return</span> <span class="p">[</span><span class="n">MolIndex</span><span class="p">,</span> <span class="n">EncodedMol</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="n">ConfID</span><span class="p">,</span> <span class="n">Energy</span><span class="p">]</span>
  424 
  425     <span class="k">return</span> <span class="p">[</span><span class="n">MolIndex</span><span class="p">,</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">MolToBase64EncodedMolString</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">PropertyPickleFlags</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">PropertyPickleOptions</span><span class="o">.</span><span class="n">MolProps</span> <span class="o">|</span> <span class="n">Chem</span><span class="o">.</span><span class="n">PropertyPickleOptions</span><span class="o">.</span><span class="n">PrivateProps</span><span class="p">),</span> <span class="n">CalcStatus</span><span class="p">,</span> <span class="n">ConfID</span><span class="p">,</span> <span class="n">Energy</span><span class="p">]</span>
  426 
  427 <span class="k">def</span> <span class="nf">InitializePsi4ForWorkerProcess</span><span class="p">():</span>
  428     <span class="sd">&quot;&quot;&quot;Initialize Psi4 for a worker process.&quot;&quot;&quot;</span>
  429     
  430     <span class="k">if</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Psi4Initialized&quot;</span><span class="p">]:</span>
  431         <span class="k">return</span>
  432 
  433     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Psi4Initialized&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
  434 
  435     <span class="k">if</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;MPLevelConformersMode&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Psi4RunParams&quot;</span><span class="p">][</span><span class="s2">&quot;OutputFileSpecified&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
  436         <span class="c1"># Run Psi4 in quiet mode during multiprocessing at Conformers level for &#39;auto&#39; OutputFile...</span>
  437         <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Psi4RunParams&quot;</span><span class="p">][</span><span class="s2">&quot;OutputFile&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;quiet&quot;</span>
  438     <span class="k">else</span><span class="p">:</span>
  439         <span class="c1"># Update output file...</span>
  440         <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Psi4RunParams&quot;</span><span class="p">][</span><span class="s2">&quot;OutputFile&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Psi4Util</span><span class="o">.</span><span class="n">UpdatePsi4OutputFileUsingPID</span><span class="p">(</span><span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Psi4RunParams&quot;</span><span class="p">][</span><span class="s2">&quot;OutputFile&quot;</span><span class="p">],</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">())</span>
  441             
  442     <span class="c1"># Intialize Psi4...</span>
  443     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;psi4&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Psi4Util</span><span class="o">.</span><span class="n">InitializePsi4</span><span class="p">(</span><span class="n">Psi4RunParams</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Psi4RunParams&quot;</span><span class="p">],</span> <span class="n">Psi4OptionsParams</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Psi4OptionsParams&quot;</span><span class="p">],</span> <span class="n">PrintVersion</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> <span class="n">PrintHeader</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
  444     
  445     <span class="c1"># Setup max iterations global variable...</span>
  446     <span class="n">Psi4Util</span><span class="o">.</span><span class="n">UpdatePsi4OptionsParameters</span><span class="p">(</span><span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;psi4&quot;</span><span class="p">],</span> <span class="p">{</span><span class="s1">&#39;GEOM_MAXITER&#39;</span><span class="p">:</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;MaxIters&quot;</span><span class="p">]})</span>
  447     
  448     <span class="c1"># Setup conversion factor for energy units...</span>
  449     <span class="n">SetupEnergyConversionFactor</span><span class="p">(</span><span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;psi4&quot;</span><span class="p">])</span>
  450 
  451 <span class="k">def</span> <span class="nf">GenerateMolConformers</span><span class="p">(</span><span class="n">Psi4Handle</span><span class="p">,</span> <span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">):</span>
  452     <span class="sd">&quot;&quot;&quot;Generate and mininize conformers for a molecule.&quot;&quot;&quot;</span>
  453 
  454     <span class="c1"># Add hydrogens..</span>
  455     <span class="n">Mol</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">AddHs</span><span class="p">(</span><span class="n">Mol</span><span class="p">)</span>
  456     
  457     <span class="n">MolName</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">GetMolName</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">)</span>
  458 
  459     <span class="c1"># Setup conformers...</span>
  460     <span class="n">ConfIDs</span> <span class="o">=</span> <span class="n">EmbedMolecule</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">)</span>
  461     <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">ConfIDs</span><span class="p">):</span>
  462         <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]:</span>
  463             <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintWarning</span><span class="p">(</span><span class="s2">&quot;Conformation generation couldn&#39;t be performed for molecule </span><span class="si">%s</span><span class="s2">: Embedding failed...</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">MolName</span><span class="p">)</span>
  464         <span class="k">return</span> <span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
  465     
  466     <span class="c1"># Minimize conformers...</span>
  467     <span class="n">CalcEnergyMap</span> <span class="o">=</span> <span class="p">{}</span>
  468     <span class="k">for</span> <span class="n">ConfID</span> <span class="ow">in</span> <span class="n">ConfIDs</span><span class="p">:</span>
  469         <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]:</span>
  470             <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;Processing conformer ID </span><span class="si">%s</span><span class="s2"> for molecule </span><span class="si">%s</span><span class="s2">...&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ConfID</span><span class="p">,</span> <span class="n">MolName</span><span class="p">))</span>
  471             
  472         <span class="c1"># Perform forcefield minimization...</span>
  473         <span class="n">Status</span><span class="p">,</span> <span class="n">ConvergeStatus</span> <span class="o">=</span> <span class="n">MinimizeMoleculeUsingForceField</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">,</span> <span class="n">ConfID</span><span class="p">)</span>
  474         <span class="k">if</span> <span class="ow">not</span> <span class="n">Status</span><span class="p">:</span>
  475             <span class="k">return</span> <span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
  476         
  477         <span class="k">if</span> <span class="n">ConvergeStatus</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
  478             <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]:</span>
  479                 <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintWarning</span><span class="p">(</span><span class="s2">&quot;Minimization using forcefield failed to converge for molecule </span><span class="si">%s</span><span class="s2"> in </span><span class="si">%d</span><span class="s2"> steps. Try using higher value for </span><span class="se">\&quot;</span><span class="s2">maxIters</span><span class="se">\&quot;</span><span class="s2"> in </span><span class="se">\&quot;</span><span class="s2">--confParams</span><span class="se">\&quot;</span><span class="s2"> option...</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">MolName</span><span class="p">,</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;ConfGenerationParams&quot;</span><span class="p">][</span><span class="s2">&quot;MaxIters&quot;</span><span class="p">]))</span>
  480 
  481         <span class="c1"># Perform Psi4 minimization...</span>
  482         <span class="n">CalcStatus</span><span class="p">,</span> <span class="n">Energy</span> <span class="o">=</span> <span class="n">MinimizeMoleculeUsingPsi4</span><span class="p">(</span><span class="n">Psi4Handle</span><span class="p">,</span> <span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">,</span> <span class="n">ConfID</span><span class="p">)</span>
  483         <span class="k">if</span> <span class="ow">not</span> <span class="n">CalcStatus</span><span class="p">:</span>
  484             <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]:</span>
  485                 <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintWarning</span><span class="p">(</span><span class="s2">&quot;Minimization couldn&#39;t be performed for molecule </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">MolName</span><span class="p">))</span>
  486             <span class="k">return</span> <span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
  487 
  488         <span class="n">CalcEnergyMap</span><span class="p">[</span><span class="n">ConfID</span><span class="p">]</span> <span class="o">=</span> <span class="n">Energy</span>
  489     
  490     <span class="c1"># Align molecules after minimization...</span>
  491     <span class="k">if</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;ConfGenerationParams&quot;</span><span class="p">][</span><span class="s2">&quot;AlignConformers&quot;</span><span class="p">]:</span>
  492         <span class="n">AllChem</span><span class="o">.</span><span class="n">AlignMolConformers</span><span class="p">(</span><span class="n">Mol</span><span class="p">)</span>
  493 
  494     <span class="c1"># Filter conformers...</span>
  495     <span class="n">SelectedConfIDs</span><span class="p">,</span> <span class="n">SelectedConfEnergies</span> <span class="o">=</span> <span class="n">FilterMolConformers</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">,</span> <span class="n">ConfIDs</span><span class="p">,</span> <span class="n">CalcEnergyMap</span><span class="p">)</span>
  496     
  497     <span class="k">return</span> <span class="p">[</span><span class="n">Mol</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="n">SelectedConfIDs</span><span class="p">,</span> <span class="n">SelectedConfEnergies</span><span class="p">]</span>
  498 
  499 <span class="k">def</span> <span class="nf">FilterMolConformers</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">,</span> <span class="n">ConfIDs</span><span class="p">,</span> <span class="n">CalcEnergyMap</span><span class="p">):</span>
  500     <span class="sd">&quot;&quot;&quot;Filter conformers for a molecule.&quot;&quot;&quot;</span>
  501 
  502     <span class="n">SortedConfIDs</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">ConfIDs</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">ConfID</span><span class="p">:</span> <span class="n">CalcEnergyMap</span><span class="p">[</span><span class="n">ConfID</span><span class="p">])</span>
  503 
  504     <span class="n">MinEnergyConfID</span> <span class="o">=</span> <span class="n">SortedConfIDs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
  505     <span class="n">MinConfEnergy</span> <span class="o">=</span> <span class="n">CalcEnergyMap</span><span class="p">[</span><span class="n">MinEnergyConfID</span><span class="p">]</span>
  506     <span class="n">EnergyWindow</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;EnergyWindow&quot;</span><span class="p">]</span>
  507     
  508     <span class="n">EnergyRMSDCutoff</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;EnergyRMSDCutoff&quot;</span><span class="p">]</span>
  509     <span class="n">ApplyEnergyRMSDCutoff</span> <span class="o">=</span> <span class="bp">False</span>
  510     <span class="k">if</span> <span class="n">EnergyRMSDCutoff</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
  511         <span class="n">ApplyEnergyRMSDCutoff</span> <span class="o">=</span> <span class="bp">True</span>
  512 
  513     <span class="n">EnergyRMSDCutoffLowest</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;EnergyRMSDCutoffModeLowest&quot;</span><span class="p">]</span>
  514     <span class="n">EnergyRMSDCalcModeBest</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;EnergyRMSDCalcModeBest&quot;</span><span class="p">]</span>
  515     
  516     <span class="n">PreAligned</span> <span class="o">=</span> <span class="bp">False</span>
  517     <span class="k">if</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;ConfGenerationParams&quot;</span><span class="p">][</span><span class="s2">&quot;AlignConformers&quot;</span><span class="p">]:</span>
  518         <span class="n">PreAligned</span> <span class="o">=</span> <span class="bp">True</span>
  519     
  520     <span class="n">RefMol</span><span class="p">,</span> <span class="n">ProbeMol</span> <span class="o">=</span> <span class="p">[</span><span class="bp">None</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span>
  521     <span class="k">if</span> <span class="n">EnergyRMSDCalcModeBest</span><span class="p">:</span>
  522         <span class="c1"># Copy molecules for best RMSD calculations to avoid change in the coordinates</span>
  523         <span class="c1"># of the conformations...</span>
  524         <span class="n">RefMol</span> <span class="o">=</span> <span class="n">AllChem</span><span class="o">.</span><span class="n">Mol</span><span class="p">(</span><span class="n">Mol</span><span class="p">)</span>
  525         <span class="n">ProbeMol</span> <span class="o">=</span> <span class="n">AllChem</span><span class="o">.</span><span class="n">Mol</span><span class="p">(</span><span class="n">Mol</span><span class="p">)</span>
  526     
  527     <span class="c1"># Track conformers with in the specified energy window  from the lowest</span>
  528     <span class="c1"># energy conformation along with applying RMSD cutoff as needed...</span>
  529     <span class="c1">#</span>
  530     <span class="n">SelectedConfIDs</span> <span class="o">=</span> <span class="p">[]</span>
  531     
  532     <span class="n">ConfCount</span> <span class="o">=</span> <span class="mi">0</span>
  533     <span class="n">IgnoredByEnergyConfCount</span> <span class="o">=</span> <span class="mi">0</span>
  534     <span class="n">IgnoredByRMSDConfCount</span> <span class="o">=</span> <span class="mi">0</span>
  535     
  536     <span class="n">FirstConf</span> <span class="o">=</span> <span class="bp">True</span>
  537     
  538     <span class="k">for</span> <span class="n">ConfID</span> <span class="ow">in</span> <span class="n">SortedConfIDs</span><span class="p">:</span>
  539         <span class="k">if</span> <span class="n">FirstConf</span><span class="p">:</span>
  540             <span class="n">FirstConf</span> <span class="o">=</span> <span class="bp">False</span>
  541             <span class="n">ConfCount</span> <span class="o">+=</span> <span class="mi">1</span>
  542             <span class="n">SelectedConfIDs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ConfID</span><span class="p">)</span>
  543             <span class="k">continue</span>
  544             
  545         <span class="n">ConfEnergyDiff</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">CalcEnergyMap</span><span class="p">[</span><span class="n">ConfID</span><span class="p">]</span> <span class="o">-</span> <span class="n">MinConfEnergy</span> <span class="p">)</span>
  546         <span class="k">if</span>  <span class="n">ConfEnergyDiff</span> <span class="o">&gt;</span> <span class="n">EnergyWindow</span><span class="p">:</span>
  547             <span class="n">IgnoredByEnergyConfCount</span> <span class="o">+=</span> <span class="mi">1</span>
  548             <span class="k">continue</span>
  549         
  550         <span class="k">if</span> <span class="n">ApplyEnergyRMSDCutoff</span><span class="p">:</span>
  551             <span class="n">IgnoreConf</span> <span class="o">=</span> <span class="bp">False</span>
  552             <span class="k">if</span> <span class="n">EnergyRMSDCutoffLowest</span><span class="p">:</span>
  553                 <span class="c1"># Compare RMSD with the lowest energy conformation...</span>
  554                 <span class="k">if</span> <span class="n">EnergyRMSDCalcModeBest</span><span class="p">:</span>
  555                     <span class="n">CalcRMSD</span> <span class="o">=</span> <span class="n">AllChem</span><span class="o">.</span><span class="n">GetBestRMS</span><span class="p">(</span><span class="n">ProbeMol</span><span class="p">,</span> <span class="n">RefMol</span><span class="p">,</span> <span class="n">prbId</span> <span class="o">=</span> <span class="n">ConfID</span><span class="p">,</span> <span class="n">refId</span> <span class="o">=</span> <span class="n">MinEnergyConfID</span><span class="p">)</span>
  556                 <span class="k">else</span><span class="p">:</span>
  557                     <span class="n">CalcRMSD</span> <span class="o">=</span> <span class="n">AllChem</span><span class="o">.</span><span class="n">GetConformerRMS</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MinEnergyConfID</span><span class="p">,</span> <span class="n">ConfID</span><span class="p">,</span> <span class="n">prealigned</span><span class="o">=</span><span class="n">PreAligned</span><span class="p">)</span>
  558                 <span class="k">if</span> <span class="n">CalcRMSD</span> <span class="o">&lt;</span> <span class="n">EnergyRMSDCutoff</span><span class="p">:</span>
  559                         <span class="n">IgnoreConf</span> <span class="o">=</span> <span class="bp">True</span>
  560             <span class="k">else</span><span class="p">:</span>
  561                 <span class="k">for</span> <span class="n">SelectedConfID</span> <span class="ow">in</span> <span class="n">SelectedConfIDs</span><span class="p">:</span>
  562                     <span class="k">if</span> <span class="n">EnergyRMSDCalcModeBest</span><span class="p">:</span>
  563                         <span class="n">CalcRMSD</span> <span class="o">=</span> <span class="n">AllChem</span><span class="o">.</span><span class="n">GetBestRMS</span><span class="p">(</span><span class="n">ProbeMol</span><span class="p">,</span> <span class="n">RefMol</span><span class="p">,</span> <span class="n">prbId</span> <span class="o">=</span> <span class="n">ConfID</span><span class="p">,</span> <span class="n">refId</span> <span class="o">=</span> <span class="n">SelectedConfID</span><span class="p">)</span>
  564                     <span class="k">else</span><span class="p">:</span>
  565                         <span class="n">CalcRMSD</span> <span class="o">=</span> <span class="n">AllChem</span><span class="o">.</span><span class="n">GetConformerRMS</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">SelectedConfID</span><span class="p">,</span> <span class="n">ConfID</span><span class="p">,</span> <span class="n">prealigned</span><span class="o">=</span><span class="n">PreAligned</span><span class="p">)</span>
  566                     <span class="k">if</span> <span class="n">CalcRMSD</span> <span class="o">&lt;</span> <span class="n">EnergyRMSDCutoff</span><span class="p">:</span>
  567                         <span class="n">IgnoreConf</span> <span class="o">=</span> <span class="bp">True</span>
  568                         <span class="k">break</span>
  569             <span class="k">if</span> <span class="n">IgnoreConf</span><span class="p">:</span>
  570                 <span class="n">IgnoredByRMSDConfCount</span> <span class="o">+=</span> <span class="mi">1</span>
  571                 <span class="k">continue</span>
  572                 
  573         <span class="n">ConfCount</span> <span class="o">+=</span> <span class="mi">1</span>
  574         <span class="n">SelectedConfIDs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ConfID</span><span class="p">)</span>
  575     
  576     <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]:</span>
  577         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Total Number of conformations generated for </span><span class="si">%s</span><span class="s2">: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">RDKitUtil</span><span class="o">.</span><span class="n">GetMolName</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">),</span> <span class="n">ConfCount</span><span class="p">))</span>
  578         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;Number of conformations ignored due to energy window cutoff: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">IgnoredByEnergyConfCount</span><span class="p">))</span>
  579         <span class="k">if</span> <span class="n">ApplyEnergyRMSDCutoff</span><span class="p">:</span>
  580             <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;Number of conformations ignored due to energy RMSD cutoff:  </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">IgnoredByRMSDConfCount</span><span class="p">))</span>
  581 
  582     <span class="n">SelectedConfEnergies</span> <span class="o">=</span> <span class="bp">None</span>
  583     <span class="k">if</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;EnergyOut&quot;</span><span class="p">]:</span>
  584         <span class="n">SelectedConfEnergies</span> <span class="o">=</span> <span class="p">[]</span>
  585         <span class="k">for</span> <span class="n">ConfID</span> <span class="ow">in</span> <span class="n">SelectedConfIDs</span><span class="p">:</span>
  586             <span class="n">Energy</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%.*f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Precision&quot;</span><span class="p">],</span> <span class="n">CalcEnergyMap</span><span class="p">[</span><span class="n">ConfID</span><span class="p">])</span>
  587             <span class="n">SelectedConfEnergies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Energy</span><span class="p">)</span>
  588     
  589     <span class="k">return</span> <span class="p">[</span><span class="n">SelectedConfIDs</span><span class="p">,</span> <span class="n">SelectedConfEnergies</span><span class="p">]</span>
  590 
  591 <span class="k">def</span> <span class="nf">MinimizeMoleculeUsingPsi4</span><span class="p">(</span><span class="n">Psi4Handle</span><span class="p">,</span> <span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">,</span> <span class="n">ConfID</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
  592     <span class="sd">&quot;&quot;&quot;Minimize molecule using Psi4.&quot;&quot;&quot;</span>
  593 
  594     <span class="c1"># Setup a Psi4Mol...</span>
  595     <span class="n">Psi4Mol</span> <span class="o">=</span> <span class="n">SetupPsi4Mol</span><span class="p">(</span><span class="n">Psi4Handle</span><span class="p">,</span> <span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">,</span> <span class="n">ConfID</span><span class="p">)</span>
  596     <span class="k">if</span> <span class="n">Psi4Mol</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
  597         <span class="k">return</span> <span class="p">(</span><span class="bp">False</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
  598         
  599     <span class="c1">#  Setup reference wave function...</span>
  600     <span class="n">Reference</span> <span class="o">=</span> <span class="n">SetupReferenceWavefunction</span><span class="p">(</span><span class="n">Mol</span><span class="p">)</span>
  601     <span class="n">Psi4Handle</span><span class="o">.</span><span class="n">set_options</span><span class="p">({</span><span class="s1">&#39;Reference&#39;</span><span class="p">:</span> <span class="n">Reference</span><span class="p">})</span>
  602     
  603     <span class="c1"># Setup method name and basis set...</span>
  604     <span class="n">MethodName</span><span class="p">,</span> <span class="n">BasisSet</span> <span class="o">=</span> <span class="n">SetupMethodNameAndBasisSet</span><span class="p">(</span><span class="n">Mol</span><span class="p">)</span>
  605 
  606     <span class="c1"># Optimize geometry...</span>
  607     <span class="n">Status</span><span class="p">,</span> <span class="n">Energy</span><span class="p">,</span> <span class="n">WaveFunction</span> <span class="o">=</span> <span class="n">Psi4Util</span><span class="o">.</span><span class="n">PerformGeometryOptimization</span><span class="p">(</span><span class="n">Psi4Handle</span><span class="p">,</span> <span class="n">Psi4Mol</span><span class="p">,</span> <span class="n">MethodName</span><span class="p">,</span> <span class="n">BasisSet</span><span class="p">,</span> <span class="n">ReturnWaveFunction</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">Quiet</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">])</span>
  608     
  609     <span class="k">if</span> <span class="ow">not</span> <span class="n">Status</span><span class="p">:</span>
  610         <span class="n">PerformPsi4Cleanup</span><span class="p">(</span><span class="n">Psi4Handle</span><span class="p">)</span>
  611         <span class="k">return</span> <span class="p">(</span><span class="bp">False</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
  612 
  613     <span class="c1"># Update atom positions...</span>
  614     <span class="n">AtomPositions</span> <span class="o">=</span> <span class="n">Psi4Util</span><span class="o">.</span><span class="n">GetAtomPositions</span><span class="p">(</span><span class="n">Psi4Handle</span><span class="p">,</span> <span class="n">WaveFunction</span><span class="p">,</span> <span class="n">InAngstroms</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
  615     <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">SetAtomPositions</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">AtomPositions</span><span class="p">,</span> <span class="n">ConfID</span> <span class="o">=</span> <span class="n">ConfID</span><span class="p">)</span>
  616 
  617     <span class="c1"># Convert energy units...</span>
  618     <span class="k">if</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;ApplyEnergyConversionFactor&quot;</span><span class="p">]:</span>
  619         <span class="n">Energy</span> <span class="o">=</span> <span class="n">Energy</span> <span class="o">*</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;EnergyConversionFactor&quot;</span><span class="p">]</span>
  620     
  621     <span class="c1"># Clean up</span>
  622     <span class="n">PerformPsi4Cleanup</span><span class="p">(</span><span class="n">Psi4Handle</span><span class="p">)</span>
  623     
  624     <span class="k">return</span> <span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="n">Energy</span><span class="p">)</span>
  625 
  626 <span class="k">def</span> <span class="nf">MinimizeMoleculeUsingForceField</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">,</span> <span class="n">ConfID</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
  627     <span class="sd">&quot;&quot;&quot;Minimize molecule using forcefield available in RDKit.&quot;&quot;&quot;</span>
  628     
  629     <span class="k">try</span><span class="p">:</span>
  630         <span class="k">if</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;ConfGenerationParams&quot;</span><span class="p">][</span><span class="s2">&quot;UseUFF&quot;</span><span class="p">]:</span>
  631             <span class="n">ConvergeStatus</span> <span class="o">=</span> <span class="n">AllChem</span><span class="o">.</span><span class="n">UFFOptimizeMolecule</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">confId</span> <span class="o">=</span> <span class="n">ConfID</span><span class="p">,</span> <span class="n">maxIters</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;ConfGenerationParams&quot;</span><span class="p">][</span><span class="s2">&quot;MaxIters&quot;</span><span class="p">])</span>
  632         <span class="k">elif</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;ConfGenerationParams&quot;</span><span class="p">][</span><span class="s2">&quot;UseMMFF&quot;</span><span class="p">]:</span>
  633             <span class="n">ConvergeStatus</span> <span class="o">=</span> <span class="n">AllChem</span><span class="o">.</span><span class="n">MMFFOptimizeMolecule</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">confId</span> <span class="o">=</span> <span class="n">ConfID</span><span class="p">,</span> <span class="n">maxIters</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;ConfGenerationParams&quot;</span><span class="p">][</span><span class="s2">&quot;MaxIters&quot;</span><span class="p">],</span> <span class="n">mmffVariant</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;ConfGenerationParams&quot;</span><span class="p">][</span><span class="s2">&quot;MMFFVariant&quot;</span><span class="p">])</span>
  634         <span class="k">else</span><span class="p">:</span>
  635             <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintError</span><span class="p">(</span><span class="s2">&quot;Minimization couldn&#39;t be performed: Specified forcefield, </span><span class="si">%s</span><span class="s2">, is not supported&quot;</span> <span class="o">%</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;ConfGenerationParams&quot;</span><span class="p">][</span><span class="s2">&quot;ForceField&quot;</span><span class="p">])</span>
  636     <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">RuntimeError</span><span class="p">,</span> <span class="n">Chem</span><span class="o">.</span><span class="n">rdchem</span><span class="o">.</span><span class="n">KekulizeException</span><span class="p">)</span> <span class="k">as</span> <span class="n">ErrMsg</span><span class="p">:</span>
  637         <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]:</span>
  638             <span class="n">MolName</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">GetMolName</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">)</span>
  639             <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintWarning</span><span class="p">(</span><span class="s2">&quot;Minimization using forcefield couldn&#39;t be performed for molecule </span><span class="si">%s</span><span class="s2">:</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">MolName</span><span class="p">,</span> <span class="n">ErrMsg</span><span class="p">))</span>
  640         <span class="k">return</span> <span class="p">(</span><span class="bp">False</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
  641     
  642     <span class="k">return</span> <span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="n">ConvergeStatus</span><span class="p">)</span>
  643 
  644 <span class="k">def</span> <span class="nf">EmbedMolecule</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
  645     <span class="sd">&quot;&quot;&quot;Embed conformations&quot;&quot;&quot;</span>
  646 
  647     <span class="n">ConfIDs</span> <span class="o">=</span> <span class="p">[]</span>
  648     
  649     <span class="n">MaxConfs</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;ConfGenerationParams&quot;</span><span class="p">][</span><span class="s2">&quot;MaxConfs&quot;</span><span class="p">]</span>
  650     <span class="n">RandomSeed</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;ConfGenerationParams&quot;</span><span class="p">][</span><span class="s2">&quot;RandomSeed&quot;</span><span class="p">]</span>
  651     <span class="n">EnforceChirality</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;ConfGenerationParams&quot;</span><span class="p">][</span><span class="s2">&quot;EnforceChirality&quot;</span><span class="p">]</span>
  652     <span class="n">UseExpTorsionAnglePrefs</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;ConfGenerationParams&quot;</span><span class="p">][</span><span class="s2">&quot;UseExpTorsionAnglePrefs&quot;</span><span class="p">]</span>
  653     <span class="n">UseBasicKnowledge</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;ConfGenerationParams&quot;</span><span class="p">][</span><span class="s2">&quot;UseBasicKnowledge&quot;</span><span class="p">]</span>
  654     <span class="n">EmbedRMSDCutoff</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;ConfGenerationParams&quot;</span><span class="p">][</span><span class="s2">&quot;EmbedRMSDCutoff&quot;</span><span class="p">]</span>
  655 
  656     <span class="k">try</span><span class="p">:</span>
  657         <span class="n">ConfIDs</span> <span class="o">=</span> <span class="n">AllChem</span><span class="o">.</span><span class="n">EmbedMultipleConfs</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">numConfs</span> <span class="o">=</span> <span class="n">MaxConfs</span><span class="p">,</span> <span class="n">randomSeed</span> <span class="o">=</span> <span class="n">RandomSeed</span><span class="p">,</span> <span class="n">pruneRmsThresh</span> <span class="o">=</span> <span class="n">EmbedRMSDCutoff</span><span class="p">,</span> <span class="n">enforceChirality</span> <span class="o">=</span> <span class="n">EnforceChirality</span><span class="p">,</span> <span class="n">useExpTorsionAnglePrefs</span> <span class="o">=</span> <span class="n">UseExpTorsionAnglePrefs</span><span class="p">,</span> <span class="n">useBasicKnowledge</span> <span class="o">=</span> <span class="n">UseBasicKnowledge</span><span class="p">)</span>
  658     <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">ErrMsg</span><span class="p">:</span>
  659         <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]:</span>
  660             <span class="n">MolName</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">GetMolName</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">)</span>
  661             <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintWarning</span><span class="p">(</span><span class="s2">&quot;Embedding failed  for molecule </span><span class="si">%s</span><span class="s2">:</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">MolName</span><span class="p">,</span> <span class="n">ErrMsg</span><span class="p">))</span>
  662         <span class="n">ConfIDs</span> <span class="o">=</span> <span class="p">[]</span>
  663 
  664     <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]:</span>
  665         <span class="k">if</span> <span class="n">EmbedRMSDCutoff</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
  666             <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;Generating initial conformation ensemble by distance geometry for </span><span class="si">%s</span><span class="s2"> - EmbedRMSDCutoff: </span><span class="si">%s</span><span class="s2">; Size: </span><span class="si">%s</span><span class="s2">; Size after RMSD filtering: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">RDKitUtil</span><span class="o">.</span><span class="n">GetMolName</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">),</span> <span class="n">EmbedRMSDCutoff</span><span class="p">,</span> <span class="n">MaxConfs</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ConfIDs</span><span class="p">)))</span>
  667         <span class="k">else</span><span class="p">:</span>
  668             <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;Generating initial conformation ensemble by distance geometry for </span><span class="si">%s</span><span class="s2"> - EmbedRMSDCutoff: None; Size: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">RDKitUtil</span><span class="o">.</span><span class="n">GetMolName</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">ConfIDs</span><span class="p">)))</span>
  669     
  670     <span class="k">return</span> <span class="n">ConfIDs</span>
  671 
  672 <span class="k">def</span> <span class="nf">SetupPsi4Mol</span><span class="p">(</span><span class="n">Psi4Handle</span><span class="p">,</span> <span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">,</span> <span class="n">ConfID</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
  673     <span class="sd">&quot;&quot;&quot;Setup a Psi4 molecule object.&quot;&quot;&quot;</span>
  674 
  675     <span class="k">if</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;RecenterAndReorient&quot;</span><span class="p">]:</span>
  676         <span class="n">MolGeometry</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">GetPsi4XYZFormatString</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">ConfID</span> <span class="o">=</span> <span class="n">ConfID</span><span class="p">,</span> <span class="n">NoCom</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> <span class="n">NoReorient</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span>
  677     <span class="k">else</span><span class="p">:</span>
  678         <span class="n">MolGeometry</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">GetPsi4XYZFormatString</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">ConfID</span> <span class="o">=</span> <span class="n">ConfID</span><span class="p">,</span> <span class="n">NoCom</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">NoReorient</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
  679     
  680     <span class="k">try</span><span class="p">:</span>
  681         <span class="n">Psi4Mol</span> <span class="o">=</span> <span class="n">Psi4Handle</span><span class="o">.</span><span class="n">geometry</span><span class="p">(</span><span class="n">MolGeometry</span><span class="p">)</span>
  682     <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ErrMsg</span><span class="p">:</span>
  683         <span class="n">Psi4Mol</span> <span class="o">=</span> <span class="bp">None</span>
  684         <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]:</span>
  685             <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintWarning</span><span class="p">(</span><span class="s2">&quot;Failed to create Psi4 molecule from geometry string: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">ErrMsg</span><span class="p">)</span>
  686             <span class="n">MolName</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">GetMolName</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">)</span>
  687             <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintWarning</span><span class="p">(</span><span class="s2">&quot;Ignoring molecule: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">MolName</span><span class="p">)</span>
  688     
  689     <span class="k">if</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Symmetrize&quot;</span><span class="p">]:</span>
  690         <span class="n">Psi4Mol</span><span class="o">.</span><span class="n">symmetrize</span><span class="p">(</span><span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;SymmetrizeTolerance&quot;</span><span class="p">])</span>
  691     
  692     <span class="k">return</span> <span class="n">Psi4Mol</span>
  693 
  694 <span class="k">def</span> <span class="nf">PerformPsi4Cleanup</span><span class="p">(</span><span class="n">Psi4Handle</span><span class="p">):</span>
  695     <span class="sd">&quot;&quot;&quot;Perform clean up.&quot;&quot;&quot;</span>
  696 
  697     <span class="c1"># No need to perform any explicit clean by calling</span>
  698     <span class="c1"># Psi4Handle.core.opt_clean(). It&#39;s already done by Psi4 after</span>
  699     <span class="c1"># optimization...</span>
  700     
  701     <span class="c1"># Clean up any leftover scratch files...</span>
  702     <span class="k">if</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;MPMode&quot;</span><span class="p">]:</span>
  703         <span class="n">Psi4Util</span><span class="o">.</span><span class="n">RemoveScratchFiles</span><span class="p">(</span><span class="n">Psi4Handle</span><span class="p">,</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Psi4RunParams&quot;</span><span class="p">][</span><span class="s2">&quot;OutputFile&quot;</span><span class="p">])</span>
  704 
  705 <span class="k">def</span> <span class="nf">CheckAndValidateMolecule</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolCount</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
  706     <span class="sd">&quot;&quot;&quot;Validate molecule for Psi4 calculations.&quot;&quot;&quot;</span>
  707     
  708     <span class="k">if</span> <span class="n">Mol</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
  709         <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]:</span>
  710             <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Processing molecule number </span><span class="si">%s</span><span class="s2">...&quot;</span> <span class="o">%</span> <span class="n">MolCount</span><span class="p">)</span>
  711         <span class="k">return</span> <span class="bp">False</span>
  712     
  713     <span class="n">MolName</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">GetMolName</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolCount</span><span class="p">)</span>
  714     <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]:</span>
  715         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Processing molecule </span><span class="si">%s</span><span class="s2">...&quot;</span> <span class="o">%</span> <span class="n">MolName</span><span class="p">)</span>
  716     
  717     <span class="k">if</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">IsMolEmpty</span><span class="p">(</span><span class="n">Mol</span><span class="p">):</span>
  718         <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]:</span>
  719             <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintWarning</span><span class="p">(</span><span class="s2">&quot;Ignoring empty molecule: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">MolName</span><span class="p">)</span>
  720         <span class="k">return</span> <span class="bp">False</span>
  721     
  722     <span class="k">if</span> <span class="ow">not</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">ValidateElementSymbols</span><span class="p">(</span><span class="n">RDKitUtil</span><span class="o">.</span><span class="n">GetAtomSymbols</span><span class="p">(</span><span class="n">Mol</span><span class="p">)):</span>
  723         <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]:</span>
  724             <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintWarning</span><span class="p">(</span><span class="s2">&quot;Ignoring molecule containing invalid element symbols: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">MolName</span><span class="p">)</span>
  725         <span class="k">return</span> <span class="bp">False</span>
  726     
  727     <span class="k">return</span> <span class="bp">True</span>
  728 
  729 <span class="k">def</span> <span class="nf">SetupMethodNameAndBasisSet</span><span class="p">(</span><span class="n">Mol</span><span class="p">):</span>
  730     <span class="sd">&quot;&quot;&quot;Setup method name and basis set.&quot;&quot;&quot;</span>
  731     
  732     <span class="n">MethodName</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;MethodName&quot;</span><span class="p">]</span>
  733     <span class="k">if</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;MethodNameAuto&quot;</span><span class="p">]:</span>
  734         <span class="n">MethodName</span> <span class="o">=</span> <span class="s2">&quot;B3LYP&quot;</span>
  735     
  736     <span class="n">BasisSet</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;BasisSet&quot;</span><span class="p">]</span>
  737     <span class="k">if</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;BasisSetAuto&quot;</span><span class="p">]:</span>
  738         <span class="n">BasisSet</span> <span class="o">=</span> <span class="s2">&quot;6-31+G**&quot;</span> <span class="k">if</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">IsAtomSymbolPresentInMol</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="s2">&quot;S&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;6-31G**&quot;</span>
  739     
  740     <span class="k">return</span> <span class="p">(</span><span class="n">MethodName</span><span class="p">,</span> <span class="n">BasisSet</span><span class="p">)</span>
  741 
  742 <span class="k">def</span> <span class="nf">SetupReferenceWavefunction</span><span class="p">(</span><span class="n">Mol</span><span class="p">):</span>
  743     <span class="sd">&quot;&quot;&quot;Setup reference wavefunction.&quot;&quot;&quot;</span>
  744     
  745     <span class="n">Reference</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Reference&quot;</span><span class="p">]</span>
  746     <span class="k">if</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;ReferenceAuto&quot;</span><span class="p">]:</span>
  747         <span class="n">Reference</span> <span class="o">=</span> <span class="s1">&#39;UHF&#39;</span> <span class="k">if</span> <span class="p">(</span><span class="n">RDKitUtil</span><span class="o">.</span><span class="n">GetSpinMultiplicity</span><span class="p">(</span><span class="n">Mol</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;RHF&#39;</span>
  748     
  749     <span class="k">return</span> <span class="n">Reference</span>
  750 
  751 <span class="k">def</span> <span class="nf">SetupEnergyConversionFactor</span><span class="p">(</span><span class="n">Psi4Handle</span><span class="p">):</span>
  752     <span class="sd">&quot;&quot;&quot;Setup converstion factor for energt units. The Psi4 energy units are Hartrees.&quot;&quot;&quot;</span>
  753     
  754     <span class="n">EnergyUnits</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;EnergyUnits&quot;</span><span class="p">]</span>
  755     
  756     <span class="n">ApplyConversionFactor</span> <span class="o">=</span> <span class="bp">True</span>
  757     <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^kcal\/mol$&quot;</span><span class="p">,</span> <span class="n">EnergyUnits</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
  758         <span class="n">ConversionFactor</span> <span class="o">=</span> <span class="n">Psi4Handle</span><span class="o">.</span><span class="n">constants</span><span class="o">.</span><span class="n">hartree2kcalmol</span>
  759     <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^kJ\/mol$&quot;</span><span class="p">,</span> <span class="n">EnergyUnits</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
  760         <span class="n">ConversionFactor</span> <span class="o">=</span> <span class="n">Psi4Handle</span><span class="o">.</span><span class="n">constants</span><span class="o">.</span><span class="n">hartree2kJmol</span>
  761     <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^eV$&quot;</span><span class="p">,</span> <span class="n">EnergyUnits</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
  762         <span class="n">ConversionFactor</span> <span class="o">=</span> <span class="n">Psi4Handle</span><span class="o">.</span><span class="n">constants</span><span class="o">.</span><span class="n">hartree2ev</span>
  763     <span class="k">else</span><span class="p">:</span>
  764         <span class="n">ApplyConversionFactor</span> <span class="o">=</span> <span class="bp">False</span>
  765         <span class="n">ConversionFactor</span> <span class="o">=</span> <span class="mf">1.0</span>
  766     
  767     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;ApplyEnergyConversionFactor&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ApplyConversionFactor</span>
  768     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;EnergyConversionFactor&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ConversionFactor</span>
  769 
  770 <span class="k">def</span> <span class="nf">WriteMolConformers</span><span class="p">(</span><span class="n">Writer</span><span class="p">,</span> <span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">,</span> <span class="n">ConfIDs</span><span class="p">,</span> <span class="n">ConfEnergies</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
  771     <span class="sd">&quot;&quot;&quot;Write molecule coformers.&quot;&quot;&quot;</span>
  772 
  773     <span class="k">if</span> <span class="n">ConfIDs</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
  774         <span class="k">return</span> <span class="bp">True</span>
  775     
  776     <span class="n">MolName</span> <span class="o">=</span> <span class="n">RDKitUtil</span><span class="o">.</span><span class="n">GetMolName</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolNum</span><span class="p">)</span>
  777 
  778     <span class="k">for</span> <span class="n">Index</span><span class="p">,</span> <span class="n">ConfID</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ConfIDs</span><span class="p">):</span>
  779         <span class="n">SetConfMolName</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolName</span><span class="p">,</span> <span class="n">ConfID</span><span class="p">)</span>
  780         
  781         <span class="k">if</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;EnergyOut&quot;</span><span class="p">]</span>  <span class="ow">and</span> <span class="n">ConfEnergies</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
  782             <span class="n">Mol</span><span class="o">.</span><span class="n">SetProp</span><span class="p">(</span><span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;EnergyDataFieldLabel&quot;</span><span class="p">],</span> <span class="n">ConfEnergies</span><span class="p">[</span><span class="n">Index</span><span class="p">])</span>
  783             
  784             <span class="n">Writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">confId</span> <span class="o">=</span> <span class="n">ConfID</span><span class="p">)</span>
  785 
  786 <span class="k">def</span> <span class="nf">SetConfMolName</span><span class="p">(</span><span class="n">Mol</span><span class="p">,</span> <span class="n">MolName</span><span class="p">,</span> <span class="n">ConfCount</span><span class="p">):</span>
  787     <span class="sd">&quot;&quot;&quot;Set conf mol name.&quot;&quot;&quot;</span>
  788 
  789     <span class="n">ConfName</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_Conf</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">MolName</span><span class="p">,</span> <span class="n">ConfCount</span><span class="p">)</span>
  790     <span class="n">Mol</span><span class="o">.</span><span class="n">SetProp</span><span class="p">(</span><span class="s2">&quot;_Name&quot;</span><span class="p">,</span> <span class="n">ConfName</span><span class="p">)</span>
  791 
  792 
  793 <span class="k">def</span> <span class="nf">ProcessOptions</span><span class="p">():</span>
  794     <span class="sd">&quot;&quot;&quot;Process and validate command line arguments and options.&quot;&quot;&quot;</span>
  795     
  796     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s2">&quot;Processing options...&quot;</span><span class="p">)</span>
  797     
  798     <span class="c1"># Validate options...</span>
  799     <span class="n">ValidateOptions</span><span class="p">()</span>
  800     
  801     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Infile&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--infile&quot;</span><span class="p">]</span>
  802     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;SMILESInfileStatus&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span> <span class="k">if</span>  <span class="n">MiscUtil</span><span class="o">.</span><span class="n">CheckFileExt</span><span class="p">(</span><span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--infile&quot;</span><span class="p">],</span> <span class="s2">&quot;smi csv tsv txt&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="bp">False</span>
  803     <span class="n">ParamsDefaultInfoOverride</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;RemoveHydrogens&quot;</span><span class="p">:</span> <span class="bp">False</span><span class="p">}</span>
  804     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;InfileParams&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ProcessOptionInfileParameters</span><span class="p">(</span><span class="s2">&quot;--infileParams&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--infileParams&quot;</span><span class="p">],</span> <span class="n">InfileName</span> <span class="o">=</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--infile&quot;</span><span class="p">],</span> <span class="n">ParamsDefaultInfo</span> <span class="o">=</span> <span class="n">ParamsDefaultInfoOverride</span><span class="p">)</span>
  805     
  806     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Outfile&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--outfile&quot;</span><span class="p">]</span>
  807     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;OutfileParams&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ProcessOptionOutfileParameters</span><span class="p">(</span><span class="s2">&quot;--outfileParams&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--outfileParams&quot;</span><span class="p">])</span>
  808     
  809     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Overwrite&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--overwrite&quot;</span><span class="p">]</span>
  810     
  811     <span class="c1"># Method, basis set, and reference wavefunction...</span>
  812     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;BasisSet&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--basisSet&quot;</span><span class="p">]</span>
  813     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;BasisSetAuto&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^auto$&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--basisSet&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span> <span class="k">else</span> <span class="bp">False</span>
  814     
  815     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;MethodName&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--methodName&quot;</span><span class="p">]</span>
  816     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;MethodNameAuto&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^auto$&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--methodName&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span> <span class="k">else</span> <span class="bp">False</span>
  817     
  818     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Reference&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--reference&quot;</span><span class="p">]</span>
  819     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;ReferenceAuto&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^auto$&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--reference&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span> <span class="k">else</span> <span class="bp">False</span>
  820     
  821     <span class="c1"># Run and options parameters...</span>
  822     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Psi4OptionsParams&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Psi4Util</span><span class="o">.</span><span class="n">ProcessPsi4OptionsParameters</span><span class="p">(</span><span class="s2">&quot;--psi4OptionsParams&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--psi4OptionsParams&quot;</span><span class="p">])</span>
  823     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Psi4RunParams&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Psi4Util</span><span class="o">.</span><span class="n">ProcessPsi4RunParameters</span><span class="p">(</span><span class="s2">&quot;--psi4RunParams&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--psi4RunParams&quot;</span><span class="p">],</span> <span class="n">InfileName</span> <span class="o">=</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Infile&quot;</span><span class="p">])</span>
  824 
  825     <span class="c1"># Conformer generation paramaters...</span>
  826     <span class="n">ParamsDefaultInfoOverride</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;MaxConfs&quot;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span> <span class="s2">&quot;MaxIters&quot;</span><span class="p">:</span> <span class="mi">250</span><span class="p">}</span>
  827     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;ConfGenerationParams&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ProcessOptionConformerParameters</span><span class="p">(</span><span class="s2">&quot;--confParams&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--confParams&quot;</span><span class="p">],</span> <span class="n">ParamsDefaultInfoOverride</span><span class="p">)</span>
  828     
  829     <span class="c1"># Energy parameters...</span>
  830     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;EnergyOut&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^yes$&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--energyOut&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span> <span class="k">else</span> <span class="bp">False</span>
  831     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;EnergyUnits&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--energyUnits&quot;</span><span class="p">]</span>
  832     
  833     <span class="n">EnergyDataFieldLabel</span> <span class="o">=</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--energyDataFieldLabel&quot;</span><span class="p">]</span>
  834     <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^auto$&quot;</span><span class="p">,</span> <span class="n">EnergyDataFieldLabel</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
  835         <span class="n">EnergyDataFieldLabel</span> <span class="o">=</span> <span class="s2">&quot;Psi4_Energy (</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--energyUnits&quot;</span><span class="p">]</span>
  836     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;EnergyDataFieldLabel&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">EnergyDataFieldLabel</span>
  837     
  838     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;EnergyRMSDCalcMode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--energyRMSDCalcMode&quot;</span><span class="p">]</span>
  839     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;EnergyRMSDCalcModeBest&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^BestRMSD$&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--energyRMSDCalcMode&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span> <span class="k">else</span> <span class="bp">False</span>
  840     
  841     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;EnergyRMSDCutoff&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--energyRMSDCutoff&quot;</span><span class="p">])</span>
  842     
  843     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;EnergyRMSDCutoffMode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--energyRMSDCutoffMode&quot;</span><span class="p">]</span>
  844     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;EnergyRMSDCutoffModeLowest&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^Lowest$&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--energyRMSDCutoffMode&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span> <span class="k">else</span> <span class="bp">False</span>
  845     
  846     <span class="k">if</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;EnergyRMSDCutoff&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
  847         <span class="c1"># Make sure that the alignConformers option is being used...</span>
  848         <span class="k">if</span> <span class="ow">not</span> <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;ConfGenerationParams&quot;</span><span class="p">][</span><span class="s2">&quot;AlignConformers&quot;</span><span class="p">]:</span>
  849             <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintError</span><span class="p">(</span><span class="s2">&quot;The value for </span><span class="se">\&quot;</span><span class="s2">alignConformers</span><span class="se">\&quot;</span><span class="s2"> specified using </span><span class="se">\&quot;</span><span class="s2">--confParams</span><span class="se">\&quot;</span><span class="s2"> must  be set to </span><span class="se">\&quot;</span><span class="s2"> yes</span><span class="se">\&quot;</span><span class="s2"> for non-zero values of </span><span class="se">\&quot;</span><span class="s2">--energyRMSDCutoff</span><span class="se">\&quot;</span><span class="s2"> &quot;</span><span class="p">)</span>
  850     
  851     <span class="c1"># Process energy window...</span>
  852     <span class="n">EnergyWindow</span> <span class="o">=</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--energyWindow&quot;</span><span class="p">]</span>
  853     <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^auto$&quot;</span><span class="p">,</span> <span class="n">EnergyWindow</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
  854         <span class="c1"># Set default energy window based on units...</span>
  855         <span class="n">EnergyUnits</span> <span class="o">=</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--energyUnits&quot;</span><span class="p">]</span>
  856         <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^kcal\/mol$&quot;</span><span class="p">,</span> <span class="n">EnergyUnits</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
  857             <span class="n">EnergyWindow</span> <span class="o">=</span> <span class="mi">20</span>
  858         <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^kJ\/mol$&quot;</span><span class="p">,</span> <span class="n">EnergyUnits</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
  859             <span class="n">EnergyWindow</span> <span class="o">=</span> <span class="mf">83.68</span>
  860         <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^eV$&quot;</span><span class="p">,</span> <span class="n">EnergyUnits</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
  861             <span class="n">EnergyWindow</span> <span class="o">=</span> <span class="mf">0.8673</span>
  862         <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^Hartrees$&quot;</span><span class="p">,</span> <span class="n">EnergyUnits</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
  863             <span class="n">EnergyWindow</span> <span class="o">=</span> <span class="mf">0.03188</span>
  864         <span class="k">else</span><span class="p">:</span>
  865             <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintError</span><span class="p">(</span><span class="s2">&quot;Failed to set default value for </span><span class="se">\&quot;</span><span class="s2">--energyWindow</span><span class="se">\&quot;</span><span class="s2">. The value, </span><span class="si">%s</span><span class="s2">, specified for option </span><span class="se">\&quot;</span><span class="s2">--energyUnits</span><span class="se">\&quot;</span><span class="s2"> is not valid. &quot;</span> <span class="o">%</span> <span class="n">EnergyUnits</span><span class="p">)</span>
  866     <span class="k">else</span><span class="p">:</span>
  867         <span class="n">EnergyWindow</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">EnergyWindow</span><span class="p">)</span>
  868     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;EnergyWindow&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">EnergyWindow</span>
  869     
  870     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;MaxIters&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--maxIters&quot;</span><span class="p">])</span>
  871 
  872     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;MPMode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^yes$&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--mp&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span> <span class="k">else</span> <span class="bp">False</span>
  873     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;MPParams&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ProcessOptionMultiprocessingParameters</span><span class="p">(</span><span class="s2">&quot;--mpParams&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--mpParams&quot;</span><span class="p">])</span>
  874 
  875     <span class="c1"># Multiprocessing level...</span>
  876     <span class="n">MPLevelMoleculesMode</span> <span class="o">=</span> <span class="bp">False</span>
  877     <span class="n">MPLevelConformersMode</span> <span class="o">=</span> <span class="bp">False</span>
  878     <span class="n">MPLevel</span> <span class="o">=</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--mpLevel&quot;</span><span class="p">]</span>
  879     <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^Molecules$&quot;</span><span class="p">,</span> <span class="n">MPLevel</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
  880         <span class="n">MPLevelMoleculesMode</span> <span class="o">=</span> <span class="bp">True</span>
  881     <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^Conformers$&quot;</span><span class="p">,</span> <span class="n">MPLevel</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
  882         <span class="n">MPLevelConformersMode</span> <span class="o">=</span> <span class="bp">True</span>
  883     <span class="k">else</span><span class="p">:</span>
  884         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintError</span><span class="p">(</span><span class="s2">&quot;The value, </span><span class="si">%s</span><span class="s2">, specified for option </span><span class="se">\&quot;</span><span class="s2">--mpLevel</span><span class="se">\&quot;</span><span class="s2"> is not valid. &quot;</span> <span class="o">%</span> <span class="n">MPLevel</span><span class="p">)</span>
  885     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;MPLevel&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">MPLevel</span>
  886     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;MPLevelMoleculesMode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">MPLevelMoleculesMode</span>
  887     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;MPLevelConformersMode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">MPLevelConformersMode</span>
  888     
  889     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Precision&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--precision&quot;</span><span class="p">])</span>
  890     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;QuietMode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^yes$&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--quiet&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span> <span class="k">else</span> <span class="bp">False</span>
  891 
  892     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;RecenterAndReorient&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^yes$&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--recenterAndReorient&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span> <span class="k">else</span> <span class="bp">False</span>
  893     
  894     <span class="n">Symmetrize</span> <span class="o">=</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--symmetrize&quot;</span><span class="p">]</span>
  895     <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^auto$&quot;</span><span class="p">,</span> <span class="n">Symmetrize</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
  896         <span class="n">Symmetrize</span>  <span class="o">=</span> <span class="bp">True</span> <span class="k">if</span>  <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;RecenterAndReorient&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="bp">False</span>
  897     <span class="k">else</span><span class="p">:</span>
  898         <span class="n">Symmetrize</span>  <span class="o">=</span> <span class="bp">True</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^yes$&quot;</span><span class="p">,</span> <span class="n">Symmetrize</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span> <span class="k">else</span> <span class="bp">False</span>
  899     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;Symmetrize&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Symmetrize</span>
  900     
  901     <span class="n">OptionsInfo</span><span class="p">[</span><span class="s2">&quot;SymmetrizeTolerance&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--symmetrizeTolerance&quot;</span><span class="p">])</span>
  902 
  903 <span class="k">def</span> <span class="nf">RetrieveOptions</span><span class="p">():</span>
  904     <span class="sd">&quot;&quot;&quot;Retrieve command line arguments and options.&quot;&quot;&quot;</span>
  905     
  906     <span class="c1"># Get options...</span>
  907     <span class="k">global</span> <span class="n">Options</span>
  908     <span class="n">Options</span> <span class="o">=</span> <span class="n">docopt</span><span class="p">(</span><span class="n">_docoptUsage_</span><span class="p">)</span>
  909     
  910     <span class="c1"># Set current working directory to the specified directory...</span>
  911     <span class="n">WorkingDir</span> <span class="o">=</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--workingdir&quot;</span><span class="p">]</span>
  912     <span class="k">if</span> <span class="n">WorkingDir</span><span class="p">:</span>
  913         <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">WorkingDir</span><span class="p">)</span>
  914     
  915     <span class="c1"># Handle examples option...</span>
  916     <span class="k">if</span> <span class="s2">&quot;--examples&quot;</span> <span class="ow">in</span> <span class="n">Options</span> <span class="ow">and</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--examples&quot;</span><span class="p">]:</span>
  917         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="n">MiscUtil</span><span class="o">.</span><span class="n">GetExamplesTextFromDocOptText</span><span class="p">(</span><span class="n">_docoptUsage_</span><span class="p">))</span>
  918         <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
  919 
  920 <span class="k">def</span> <span class="nf">ValidateOptions</span><span class="p">():</span>
  921     <span class="sd">&quot;&quot;&quot;Validate option values.&quot;&quot;&quot;</span>
  922     
  923     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ValidateOptionTextValue</span><span class="p">(</span><span class="s2">&quot;--energyOut&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--energyOut&quot;</span><span class="p">],</span> <span class="s2">&quot;yes no&quot;</span><span class="p">)</span>
  924     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ValidateOptionTextValue</span><span class="p">(</span><span class="s2">&quot;--energyUnits&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--energyUnits&quot;</span><span class="p">],</span> <span class="s2">&quot;Hartrees kcal/mol kJ/mol eV&quot;</span><span class="p">)</span>
  925     
  926     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ValidateOptionTextValue</span><span class="p">(</span><span class="s2">&quot; --energyRMSDCalcMode&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--energyRMSDCalcMode&quot;</span><span class="p">],</span> <span class="s2">&quot;RMSD BestRMSD&quot;</span><span class="p">)</span>
  927     
  928     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ValidateOptionFloatValue</span><span class="p">(</span><span class="s2">&quot;--energyRMSDCutoff&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--energyRMSDCutoff&quot;</span><span class="p">],</span> <span class="p">{</span><span class="s2">&quot;&gt;=&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span>
  929     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ValidateOptionTextValue</span><span class="p">(</span><span class="s2">&quot; --energyRMSDCutoffMode&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--energyRMSDCutoffMode&quot;</span><span class="p">],</span> <span class="s2">&quot;All Lowest&quot;</span><span class="p">)</span>
  930     
  931     <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^auto$&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--energyWindow&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
  932         <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ValidateOptionFloatValue</span><span class="p">(</span><span class="s2">&quot;--energyWindow&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--energyWindow&quot;</span><span class="p">],</span> <span class="p">{</span><span class="s2">&quot;&gt;&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span>
  933     
  934     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ValidateOptionFilePath</span><span class="p">(</span><span class="s2">&quot;-i, --infile&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--infile&quot;</span><span class="p">])</span>
  935     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ValidateOptionFileExt</span><span class="p">(</span><span class="s2">&quot;-i, --infile&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--infile&quot;</span><span class="p">],</span> <span class="s2">&quot;sdf sd mol smi txt csv tsv&quot;</span><span class="p">)</span>
  936     
  937     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ValidateOptionIntegerValue</span><span class="p">(</span><span class="s2">&quot;--maxIters&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--maxIters&quot;</span><span class="p">],</span> <span class="p">{</span><span class="s2">&quot;&gt;&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span>
  938     
  939     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ValidateOptionFileExt</span><span class="p">(</span><span class="s2">&quot;-o, --outfile&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--outfile&quot;</span><span class="p">],</span> <span class="s2">&quot;sdf sd&quot;</span><span class="p">)</span>
  940     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ValidateOptionsOutputFileOverwrite</span><span class="p">(</span><span class="s2">&quot;-o, --outfile&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--outfile&quot;</span><span class="p">],</span> <span class="s2">&quot;--overwrite&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--overwrite&quot;</span><span class="p">])</span>
  941     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ValidateOptionsDistinctFileNames</span><span class="p">(</span><span class="s2">&quot;-i, --infile&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--infile&quot;</span><span class="p">],</span> <span class="s2">&quot;-o, --outfile&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--outfile&quot;</span><span class="p">])</span>
  942     
  943     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ValidateOptionTextValue</span><span class="p">(</span><span class="s2">&quot;--mp&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--mp&quot;</span><span class="p">],</span> <span class="s2">&quot;yes no&quot;</span><span class="p">)</span>
  944     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ValidateOptionTextValue</span><span class="p">(</span><span class="s2">&quot;--mpLevel&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--mpLevel&quot;</span><span class="p">],</span> <span class="s2">&quot;Molecules Conformers&quot;</span><span class="p">)</span>
  945     
  946     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ValidateOptionIntegerValue</span><span class="p">(</span><span class="s2">&quot;-p, --precision&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--precision&quot;</span><span class="p">],</span> <span class="p">{</span><span class="s2">&quot;&gt;&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span>
  947     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ValidateOptionTextValue</span><span class="p">(</span><span class="s2">&quot;-q, --quiet&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--quiet&quot;</span><span class="p">],</span> <span class="s2">&quot;yes no&quot;</span><span class="p">)</span>
  948     
  949     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ValidateOptionTextValue</span><span class="p">(</span><span class="s2">&quot;--recenterAndReorient&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--recenterAndReorient&quot;</span><span class="p">],</span> <span class="s2">&quot;yes no&quot;</span><span class="p">)</span>
  950     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ValidateOptionTextValue</span><span class="p">(</span><span class="s2">&quot;--symmetrize&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--symmetrize&quot;</span><span class="p">],</span> <span class="s2">&quot;yes no auto&quot;</span><span class="p">)</span>
  951     <span class="n">MiscUtil</span><span class="o">.</span><span class="n">ValidateOptionFloatValue</span><span class="p">(</span><span class="s2">&quot;--symmetrizeTolerance&quot;</span><span class="p">,</span> <span class="n">Options</span><span class="p">[</span><span class="s2">&quot;--symmetrizeTolerance&quot;</span><span class="p">],</span> <span class="p">{</span><span class="s2">&quot;&gt;&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span>
  952 
  953 <span class="c1"># Setup a usage string for docopt...</span>
  954 <span class="n">_docoptUsage_</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
  955 <span class="s2">Psi4GenerateConformers.py - Generate molecular conformations</span>
  956 
  957 <span class="s2">Usage:</span>
  958 <span class="s2">    Psi4GenerateConformers.py [--basisSet &lt;text&gt;] [--confParams &lt;Name,Value,...&gt;] [--energyOut &lt;yes or no&gt;]</span>
  959 <span class="s2">                              [--energyDataFieldLabel &lt;text&gt;] [--energyUnits &lt;text&gt;] [--energyRMSDCalcMode &lt;RMSD or BestRMSD&gt;]</span>
  960 <span class="s2">                              [--energyRMSDCutoff &lt;number&gt;] [--energyRMSDCutoffMode &lt;All or Lowest&gt;] [--energyWindow &lt;number&gt;]</span>
  961 <span class="s2">                              [--infileParams &lt;Name,Value,...&gt;] [--maxIters &lt;number&gt;]</span>
  962 <span class="s2">                              [--methodName &lt;text&gt;] [--mp &lt;yes or no&gt;] [--mpLevel &lt;Molecules or Conformers&gt;]</span>
  963 <span class="s2">                              [--mpParams &lt;Name, Value,...&gt;] [ --outfileParams &lt;Name,Value,...&gt; ] [--overwrite] [--precision &lt;number&gt;]</span>
  964 <span class="s2">                              [--psi4OptionsParams &lt;Name,Value,...&gt;] [--psi4RunParams &lt;Name,Value,...&gt;]</span>
  965 <span class="s2">                              [--quiet &lt;yes or no&gt;] [--reference &lt;text&gt;] [--recenterAndReorient &lt;yes or no&gt;]</span>
  966 <span class="s2">                              [--symmetrize &lt;yes or no&gt;] [--symmetrizeTolerance &lt;number&gt;] [-w &lt;dir&gt;] -i &lt;infile&gt; -o &lt;outfile&gt; </span>
  967 <span class="s2">    Psi4GenerateConformers.py -h | --help | -e | --examples</span>
  968 
  969 <span class="s2">Description:</span>
  970 <span class="s2">    Generate 3D conformers of molecules using a combination of distance geometry</span>
  971 <span class="s2">    and forcefield minimization followed by geometry optimization using a quantum</span>
  972 <span class="s2">    chemistry method. A set of initial 3D structures are generated for a molecule </span>
  973 <span class="s2">    employing distance geometry. The 3D structures in the conformation ensemble</span>
  974 <span class="s2">    are sequentially minimized using forcefield and a quantum chemistry method.</span>
  975 
  976 <span class="s2">    A Psi4 XYZ format geometry string is automatically generated for each molecule</span>
  977 <span class="s2">    in input file. It contains atom symbols and 3D coordinates for each atom in a</span>
  978 <span class="s2">    molecule. In addition, the formal charge and spin multiplicity are present in the</span>
  979 <span class="s2">    the geometry string. These values are either retrieved from molecule properties</span>
  980 <span class="s2">    named &#39;FormalCharge&#39; and &#39;SpinMultiplicty&#39; or dynamically calculated for a</span>
  981 <span class="s2">    molecule.</span>
  982 
  983 <span class="s2">    The supported input file formats are: Mol (.mol), SD (.sdf, .sd), SMILES (.smi,</span>
  984 <span class="s2">    .csv, .tsv .txt)</span>
  985 
  986 <span class="s2">    The supported output file formats are: SD (.sdf, .sd)</span>
  987 
  988 <span class="s2">Options:</span>
  989 <span class="s2">    -b, --basisSet &lt;text&gt;  [default: auto]</span>
  990 <span class="s2">        Basis set to use for energy minimization. Default: 6-31+G** for sulfur</span>
  991 <span class="s2">        containing molecules; Otherwise, 6-31G** [ Ref 150 ]. The specified </span>
  992 <span class="s2">        value must be a valid Psi4 basis set. No validation is performed.</span>
  993 <span class="s2">        </span>
  994 <span class="s2">        The following list shows a representative sample of basis sets available</span>
  995 <span class="s2">        in Psi4:</span>
  996 <span class="s2">            </span>
  997 <span class="s2">            STO-3G, 6-31G, 6-31+G, 6-31++G, 6-31G*, 6-31+G*,  6-31++G*, </span>
  998 <span class="s2">            6-31G**, 6-31+G**, 6-31++G**, 6-311G, 6-311+G, 6-311++G,</span>
  999 <span class="s2">            6-311G*, 6-311+G*, 6-311++G*, 6-311G**, 6-311+G**, 6-311++G**,</span>
 1000 <span class="s2">            cc-pVDZ, cc-pCVDZ, aug-cc-pVDZ, cc-pVDZ-DK, cc-pCVDZ-DK, def2-SVP,</span>
 1001 <span class="s2">            def2-SVPD, def2-TZVP, def2-TZVPD, def2-TZVPP, def2-TZVPPD</span>
 1002 <span class="s2">            </span>
 1003 <span class="s2">    --confParams &lt;Name,Value,...&gt;  [default: auto]</span>
 1004 <span class="s2">        Generate an initial 3D conformation ensemble using distance geometry and</span>
 1005 <span class="s2">        forcefield minimization before final geometry optimization by a specified</span>
 1006 <span class="s2">        method name and basis set. Possible values: yes or no.</span>
 1007 <span class="s2">        </span>
 1008 <span class="s2">        A comma delimited list of parameter name and value pairs for generating</span>
 1009 <span class="s2">        initial sets of 3D conformations for molecules. The 3D conformation ensemble</span>
 1010 <span class="s2">        is generated using distance geometry and forcefield functionality available</span>
 1011 <span class="s2">        in RDKit. The 3D structures in the conformation ensemble are subsequently</span>
 1012 <span class="s2">        minimized by a quantum chemistry method available in Psi4.</span>
 1013 <span class="s2">       </span>
 1014 <span class="s2">        The supported parameter names along with their default values are shown</span>
 1015 <span class="s2">        below:</span>
 1016 <span class="s2">            </span>
 1017 <span class="s2">            confMethod,ETKDG,</span>
 1018 <span class="s2">            forceField,MMFF, forceFieldMMFFVariant,MMFF94,</span>
 1019 <span class="s2">            enforceChirality,yes,alignConformers,yes, embedRMSDCutoff,0.5,</span>
 1020 <span class="s2">            maxConfs,50,maxIters,250,randomSeed,auto</span>
 1021 <span class="s2">            </span>
 1022 <span class="s2">            confMethod,ETKDG   [ Possible values: SDG, ETDG, KDG, ETKDG ]</span>
 1023 <span class="s2">            forceField, MMFF   [ Possible values: UFF or MMFF ]</span>
 1024 <span class="s2">            forceFieldMMFFVariant,MMFF94   [ Possible values: MMFF94 or MMFF94s ]</span>
 1025 <span class="s2">            enforceChirality,yes   [ Possible values: yes or no ]</span>
 1026 <span class="s2">            alignConformers,yes   [ Possible values: yes or no ]</span>
 1027 <span class="s2">            embedRMSDCutoff,0.5   [ Possible values: number or None]</span>
 1028 <span class="s2">            </span>
 1029 <span class="s2">        confMethod: Conformation generation methodology for generating initial 3D</span>
 1030 <span class="s2">        coordinates. Possible values: Standard Distance Geometry (SDG), Experimental</span>
 1031 <span class="s2">        Torsion-angle preference with Distance Geometry (ETDG), basic Knowledge-terms</span>
 1032 <span class="s2">        with Distance Geometry (KDG) and Experimental Torsion-angle preference</span>
 1033 <span class="s2">        along with basic Knowledge-terms with Distance Geometry (ETKDG) [Ref 129] .</span>
 1034 <span class="s2">        </span>
 1035 <span class="s2">        forceField: Forcefield method to use for energy minimization. Possible</span>
 1036 <span class="s2">        values: Universal Force Field (UFF) [ Ref 81 ] or Merck Molecular Mechanics</span>
 1037 <span class="s2">        Force Field [ Ref 83-87 ] .</span>
 1038 <span class="s2">        </span>
 1039 <span class="s2">        enforceChirality: Enforce chirality for defined chiral centers during</span>
 1040 <span class="s2">        forcefield minimization.</span>
 1041 <span class="s2">        </span>
 1042 <span class="s2">        alignConformers: Align conformers for each molecule.</span>
 1043 <span class="s2">        </span>
 1044 <span class="s2">        maxConfs: Maximum number of conformations to generate for each molecule</span>
 1045 <span class="s2">        during the generation of an initial 3D conformation ensemble using </span>
 1046 <span class="s2">        conformation generation methodology. The conformations are minimized</span>
 1047 <span class="s2">        using the specified forcefield and a quantum chemistry method. The lowest</span>
 1048 <span class="s2">        energy conformation is written to the output file.</span>
 1049 <span class="s2">        </span>
 1050 <span class="s2">        embedRMSDCutoff: RMSD cutoff for retaining initial set of conformers embedded</span>
 1051 <span class="s2">        using distance geometry and before forcefield minimization. All embedded</span>
 1052 <span class="s2">        conformers are kept for &#39;None&#39; value. Otherwise, only those conformers which</span>
 1053 <span class="s2">        are different from each other by the specified RMSD cutoff, 0.5 by default,</span>
 1054 <span class="s2">        are kept. The first embedded conformer is always retained.</span>
 1055 <span class="s2">        </span>
 1056 <span class="s2">        maxIters: Maximum number of iterations to perform for each conformation</span>
 1057 <span class="s2">        during forcefield minimization.</span>
 1058 <span class="s2">        </span>
 1059 <span class="s2">        randomSeed: Seed for the random number generator for reproducing initial</span>
 1060 <span class="s2">        3D coordinates in a conformation ensemble. Default is to use a random seed.</span>
 1061 <span class="s2">    --energyOut &lt;yes or no&gt;  [default: yes]</span>
 1062 <span class="s2">        Write out energy values.</span>
 1063 <span class="s2">    --energyDataFieldLabel &lt;text&gt;  [default: auto]</span>
 1064 <span class="s2">        Energy data field label for writing energy values. Default: Psi4_Energy (&lt;Units&gt;). </span>
 1065 <span class="s2">    --energyUnits &lt;text&gt;  [default: kcal/mol]</span>
 1066 <span class="s2">        Energy units. Possible values: Hartrees, kcal/mol, kJ/mol, or eV.</span>
 1067 <span class="s2">    --energyRMSDCalcMode &lt;RMSD or BestRMSD&gt;  [default: RMSD]</span>
 1068 <span class="s2">        Methodology for calculating RMSD values during the application of RMSD</span>
 1069 <span class="s2">        cutoff for retaining conformations after the final energy minimization. Possible</span>
 1070 <span class="s2">        values: RMSD or BestRMSD. This option is ignore during &#39;None&#39; value of</span>
 1071 <span class="s2">        &#39;--energyRMSDCutoff&#39; option.</span>
 1072 <span class="s2">        </span>
 1073 <span class="s2">        During BestRMSMode mode, the RDKit &#39;function AllChem.GetBestRMS&#39; is used to</span>
 1074 <span class="s2">        align and calculate RMSD. This function calculates optimal RMSD for aligning two</span>
 1075 <span class="s2">        molecules, taking symmetry into account. Otherwise, the RMSD value is calculated</span>
 1076 <span class="s2">        using &#39;AllChem.GetConformerRMS&#39; without changing the atom order. A word to the</span>
 1077 <span class="s2">        wise from RDKit documentation: The AllChem.GetBestRMS function will attempt to</span>
 1078 <span class="s2">        align all permutations of matching atom orders in both molecules, for some molecules</span>
 1079 <span class="s2">        it will lead to &#39;combinatorial explosion&#39;.</span>
 1080 <span class="s2">    --energyRMSDCutoff &lt;number&gt;  [default: 0.5]</span>
 1081 <span class="s2">        RMSD cutoff for retaining conformations after the final energy minimization.</span>
 1082 <span class="s2">        By default, only those conformations which are different from the lowest</span>
 1083 <span class="s2">        energy conformation by the specified RMSD cutoff and are with in the </span>
 1084 <span class="s2">        specified energy window are kept. The lowest energy conformation is always</span>
 1085 <span class="s2">        retained. A value of zero keeps all minimized conformations with in the</span>
 1086 <span class="s2">        specified energy window from the lowest energy.</span>
 1087 <span class="s2">    --energyRMSDCutoffMode &lt;All or Lowest&gt;  [default: All]</span>
 1088 <span class="s2">        RMSD cutoff mode for  retaining conformations after the final energy</span>
 1089 <span class="s2">        minimization. Possible values: All or Lowest. The RMSD values are compared</span>
 1090 <span class="s2">        against all the selected conformations or the lowest energy conformation during</span>
 1091 <span class="s2">        &#39;All&#39; and &#39;Lowest&#39; value of &#39;--energyRMSDCutoffMode&#39;. This option is ignored</span>
 1092 <span class="s2">        during &#39;None&#39; value of --energyRMSDCutoff.</span>
 1093 <span class="s2">        </span>
 1094 <span class="s2">        By default, only those conformations which all different from all selected</span>
 1095 <span class="s2">        conformations by the specified RMSD cutoff and are with in the specified</span>
 1096 <span class="s2">        energy window are kept.</span>
 1097 <span class="s2">    --energyWindow &lt;number&gt;  [default: auto]</span>
 1098 <span class="s2">        Psi4 Energy window  for selecting conformers after the final energy minimization.</span>
 1099 <span class="s2">        The default value is dependent on &#39;--energyUnits&#39;: 20 kcal/mol, 83.68 kJ/mol,</span>
 1100 <span class="s2">        0.8673 ev, or 0.03188 Hartrees. The specified value must be in &#39;--energyUnits&#39;.</span>
 1101 <span class="s2">    -e, --examples</span>
 1102 <span class="s2">        Print examples.</span>
 1103 <span class="s2">    -h, --help</span>
 1104 <span class="s2">        Print this help message.</span>
 1105 <span class="s2">    -i, --infile &lt;infile&gt;</span>
 1106 <span class="s2">        Input file name.</span>
 1107 <span class="s2">    --infileParams &lt;Name,Value,...&gt;  [default: auto]</span>
 1108 <span class="s2">        A comma delimited list of parameter name and value pairs for reading</span>
 1109 <span class="s2">        molecules from files. The supported parameter names for different file</span>
 1110 <span class="s2">        formats, along with their default values, are shown below:</span>
 1111 <span class="s2">            </span>
 1112 <span class="s2">            SD, MOL: removeHydrogens,no,sanitize,yes,strictParsing,yes</span>
 1113 <span class="s2">            SMILES: smilesColumn,1,smilesNameColumn,2,smilesDelimiter,space,</span>
 1114 <span class="s2">                smilesTitleLine,auto,sanitize,yes</span>
 1115 <span class="s2">            </span>
 1116 <span class="s2">        Possible values for smilesDelimiter: space, comma or tab.</span>
 1117 <span class="s2">    --maxIters &lt;number&gt;  [default: 50]</span>
 1118 <span class="s2">        Maximum number of iterations to perform for each molecule or conformer</span>
 1119 <span class="s2">        during energy minimization by a quantum chemistry method.</span>
 1120 <span class="s2">    -m, --methodName &lt;text&gt;  [default: auto]</span>
 1121 <span class="s2">        Method to use for energy minimization. Default: B3LYP [ Ref 150 ]. The</span>
 1122 <span class="s2">        specified value must be a valid Psi4 method name. No validation is</span>
 1123 <span class="s2">        performed.</span>
 1124 <span class="s2">        </span>
 1125 <span class="s2">        The following list shows a representative sample of methods available</span>
 1126 <span class="s2">        in Psi4:</span>
 1127 <span class="s2">            </span>
 1128 <span class="s2">            B1LYP, B2PLYP, B2PLYP-D3BJ, B2PLYP-D3MBJ, B3LYP, B3LYP-D3BJ,</span>
 1129 <span class="s2">            B3LYP-D3MBJ, CAM-B3LYP, CAM-B3LYP-D3BJ, HF, HF-D3BJ,  HF3c, M05,</span>
 1130 <span class="s2">            M06, M06-2x, M06-HF, M06-L, MN12-L, MN15, MN15-D3BJ,PBE, PBE0,</span>
 1131 <span class="s2">            PBEH3c, PW6B95, PW6B95-D3BJ, WB97, WB97X, WB97X-D, WB97X-D3BJ</span>
 1132 <span class="s2">            </span>
 1133 <span class="s2">    --mp &lt;yes or no&gt;  [default: no]</span>
 1134 <span class="s2">        Use multiprocessing.</span>
 1135 <span class="s2">         </span>
 1136 <span class="s2">        By default, input data is retrieved in a lazy manner via mp.Pool.imap()</span>
 1137 <span class="s2">        function employing lazy RDKit data iterable. This allows processing of</span>
 1138 <span class="s2">        arbitrary large data sets without any additional requirements memory.</span>
 1139 <span class="s2">        </span>
 1140 <span class="s2">        All input data may be optionally loaded into memory by mp.Pool.map()</span>
 1141 <span class="s2">        before starting worker processes in a process pool by setting the value</span>
 1142 <span class="s2">        of &#39;inputDataMode&#39; to &#39;InMemory&#39; in &#39;--mpParams&#39; option.</span>
 1143 <span class="s2">        </span>
 1144 <span class="s2">        A word to the wise: The default &#39;chunkSize&#39; value of 1 during &#39;Lazy&#39; input</span>
 1145 <span class="s2">        data mode may adversely impact the performance. The &#39;--mpParams&#39; section</span>
 1146 <span class="s2">        provides additional information to tune the value of &#39;chunkSize&#39;.</span>
 1147 <span class="s2">    --mpLevel &lt;Molecules or Conformers&gt;  [default: Molecules]</span>
 1148 <span class="s2">        Perform multiprocessing at molecules or conformers level. Possible values:</span>
 1149 <span class="s2">        Molecules or Conformers. The &#39;Molecules&#39; value starts a process pool at the</span>
 1150 <span class="s2">        molecules level. All conformers of a molecule are processed in a single</span>
 1151 <span class="s2">        process. The &#39;Conformers&#39; value, however, starts a process pool at the </span>
 1152 <span class="s2">        conformers level. Each conformer of a molecule is processed in an individual</span>
 1153 <span class="s2">        process in the process pool. The default Psi4 &#39;OutputFile&#39; is set to &#39;quiet&#39;</span>
 1154 <span class="s2">        using &#39;--psi4RunParams&#39; for &#39;Conformers&#39; level. Otherwise, it may generate</span>
 1155 <span class="s2">        a large number of Psi4 output files.</span>
 1156 <span class="s2">    --mpParams &lt;Name,Value,...&gt;  [default: auto]</span>
 1157 <span class="s2">        A comma delimited list of parameter name and value pairs to configure</span>
 1158 <span class="s2">        multiprocessing.</span>
 1159 <span class="s2">        </span>
 1160 <span class="s2">        The supported parameter names along with their default and possible</span>
 1161 <span class="s2">        values are shown below:</span>
 1162 <span class="s2">        </span>
 1163 <span class="s2">            chunkSize, auto</span>
 1164 <span class="s2">            inputDataMode, Lazy   [ Possible values: InMemory or Lazy ]</span>
 1165 <span class="s2">            numProcesses, auto   [ Default: mp.cpu_count() ]</span>
 1166 <span class="s2">        </span>
 1167 <span class="s2">        These parameters are used by the following functions to configure and</span>
 1168 <span class="s2">        control the behavior of multiprocessing: mp.Pool(), mp.Pool.map(), and</span>
 1169 <span class="s2">        mp.Pool.imap().</span>
 1170 <span class="s2">        </span>
 1171 <span class="s2">        The chunkSize determines chunks of input data passed to each worker</span>
 1172 <span class="s2">        process in a process pool by mp.Pool.map() and mp.Pool.imap() functions.</span>
 1173 <span class="s2">        The default value of chunkSize is dependent on the value of &#39;inputDataMode&#39;.</span>
 1174 <span class="s2">        </span>
 1175 <span class="s2">        The mp.Pool.map() function, invoked during &#39;InMemory&#39; input data mode,</span>
 1176 <span class="s2">        automatically converts RDKit data iterable into a list, loads all data into</span>
 1177 <span class="s2">        memory, and calculates the default chunkSize using the following method</span>
 1178 <span class="s2">        as shown in its code:</span>
 1179 <span class="s2">        </span>
 1180 <span class="s2">            chunkSize, extra = divmod(len(dataIterable), len(numProcesses) * 4)</span>
 1181 <span class="s2">            if extra: chunkSize += 1</span>
 1182 <span class="s2">        </span>
 1183 <span class="s2">        For example, the default chunkSize will be 7 for a pool of 4 worker processes</span>
 1184 <span class="s2">        and 100 data items.</span>
 1185 <span class="s2">        </span>
 1186 <span class="s2">        The mp.Pool.imap() function, invoked during &#39;Lazy&#39; input data mode, employs</span>
 1187 <span class="s2">        &#39;lazy&#39; RDKit data iterable to retrieve data as needed, without loading all the</span>
 1188 <span class="s2">        data into memory. Consequently, the size of input data is not known a priori.</span>
 1189 <span class="s2">        It&#39;s not possible to estimate an optimal value for the chunkSize. The default </span>
 1190 <span class="s2">        chunkSize is set to 1.</span>
 1191 <span class="s2">        </span>
 1192 <span class="s2">        The default value for the chunkSize during &#39;Lazy&#39; data mode may adversely</span>
 1193 <span class="s2">        impact the performance due to the overhead associated with exchanging</span>
 1194 <span class="s2">        small chunks of data. It is generally a good idea to explicitly set chunkSize to</span>
 1195 <span class="s2">        a larger value during &#39;Lazy&#39; input data mode, based on the size of your input</span>
 1196 <span class="s2">        data and number of processes in the process pool.</span>
 1197 <span class="s2">        </span>
 1198 <span class="s2">        The mp.Pool.map() function waits for all worker processes to process all</span>
 1199 <span class="s2">        the data and return the results. The mp.Pool.imap() function, however,</span>
 1200 <span class="s2">        returns the the results obtained from worker processes as soon as the</span>
 1201 <span class="s2">        results become available for specified chunks of data.</span>
 1202 <span class="s2">        </span>
 1203 <span class="s2">        The order of data in the results returned by both mp.Pool.map() and </span>
 1204 <span class="s2">        mp.Pool.imap() functions always corresponds to the input data.</span>
 1205 <span class="s2">    -o, --outfile &lt;outfile&gt;</span>
 1206 <span class="s2">        Output file name.</span>
 1207 <span class="s2">    --outfileParams &lt;Name,Value,...&gt;  [default: auto]</span>
 1208 <span class="s2">        A comma delimited list of parameter name and value pairs for writing</span>
 1209 <span class="s2">        molecules to files. The supported parameter names for different file</span>
 1210 <span class="s2">        formats, along with their default values, are shown below:</span>
 1211 <span class="s2">            </span>
 1212 <span class="s2">            SD: kekulize,yes</span>
 1213 <span class="s2">            </span>
 1214 <span class="s2">    --overwrite</span>
 1215 <span class="s2">        Overwrite existing files.</span>
 1216 <span class="s2">    --precision &lt;number&gt;  [default: 6]</span>
 1217 <span class="s2">        Floating point precision for writing energy values.</span>
 1218 <span class="s2">    --psi4OptionsParams &lt;Name,Value,...&gt;  [default: none]</span>
 1219 <span class="s2">        A comma delimited list of Psi4 option name and value pairs for setting</span>
 1220 <span class="s2">        global and module options. The names are &#39;option_name&#39; for global options</span>
 1221 <span class="s2">        and &#39;module_name__option_name&#39; for options local to a module. The</span>
 1222 <span class="s2">        specified option names must be valid Psi4 names. No validation is</span>
 1223 <span class="s2">        performed.</span>
 1224 <span class="s2">        </span>
 1225 <span class="s2">        The specified option name and  value pairs are processed and passed to</span>
 1226 <span class="s2">        psi4.set_options() as a dictionary. The supported value types are float,</span>
 1227 <span class="s2">        integer, boolean, or string. The float value string is converted into a float.</span>
 1228 <span class="s2">        The valid values for a boolean string are yes, no, true, false, on, or off. </span>
 1229 <span class="s2">    --psi4RunParams &lt;Name,Value,...&gt;  [default: auto]</span>
 1230 <span class="s2">        A comma delimited list of parameter name and value pairs for configuring</span>
 1231 <span class="s2">        Psi4 jobs.</span>
 1232 <span class="s2">        </span>
 1233 <span class="s2">        The supported parameter names along with their default and possible</span>
 1234 <span class="s2">        values are shown below:</span>
 1235 <span class="s2">             </span>
 1236 <span class="s2">            MemoryInGB, 1</span>
 1237 <span class="s2">            NumThreads, 1</span>
 1238 <span class="s2">            OutputFile, auto   [ Possible  values: stdout, quiet, or FileName ]</span>
 1239 <span class="s2">            ScratchDir, auto   [ Possivle values: DirName]</span>
 1240 <span class="s2">            RemoveOutputFile, yes   [ Possible values: yes, no, true, or false]</span>
 1241 <span class="s2">            </span>
 1242 <span class="s2">        These parameters control the runtime behavior of Psi4.</span>
 1243 <span class="s2">        </span>
 1244 <span class="s2">        The default file name for &#39;OutputFile&#39; is &lt;InFileRoot&gt;_Psi4.out. The PID</span>
 1245 <span class="s2">        is appended to output file name during multiprocessing as shown:</span>
 1246 <span class="s2">        &lt;InFileRoot&gt;_Psi4_&lt;PIDNum&gt;.out. The &#39;stdout&#39; value for &#39;OutputType&#39;</span>
 1247 <span class="s2">        sends Psi4 output to stdout. The &#39;quiet&#39; or &#39;devnull&#39; value suppresses</span>
 1248 <span class="s2">        all Psi4 output. The &#39;OutputFile&#39; is set to &#39;quiet&#39; for &#39;auto&#39; value during </span>
 1249 <span class="s2">        &#39;Conformers&#39; of &#39;--mpLevel&#39; option.</span>
 1250 <span class="s2">        </span>
 1251 <span class="s2">        The default &#39;Yes&#39; value of &#39;RemoveOutputFile&#39; option forces the removal</span>
 1252 <span class="s2">        of any existing Psi4 before creating new files to append output from</span>
 1253 <span class="s2">        multiple Psi4 runs.</span>
 1254 <span class="s2">        </span>
 1255 <span class="s2">        The option &#39;ScratchDir&#39; is a directory path to the location of scratch</span>
 1256 <span class="s2">        files. The default value corresponds to Psi4 default. It may be used to</span>
 1257 <span class="s2">        override the deafult path.</span>
 1258 <span class="s2">    -q, --quiet &lt;yes or no&gt;  [default: no]</span>
 1259 <span class="s2">        Use quiet mode. The warning and information messages will not be printed.</span>
 1260 <span class="s2">    -r, --reference &lt;text&gt;  [default: auto]</span>
 1261 <span class="s2">        Reference wave function to use for energy calculation. Default: RHF or UHF.</span>
 1262 <span class="s2">        The default values are Restricted Hartree-Fock (RHF) for closed-shell molecules</span>
 1263 <span class="s2">        with all electrons paired and Unrestricted Hartree-Fock (UHF) for open-shell</span>
 1264 <span class="s2">        molecules with unpaired electrons.</span>
 1265 <span class="s2">        </span>
 1266 <span class="s2">        The specified value must be a valid Psi4 reference wave function. No validation</span>
 1267 <span class="s2">        is performed. For example: ROHF, CUHF, RKS, etc.</span>
 1268 <span class="s2">        </span>
 1269 <span class="s2">        The spin multiplicity determines the default value of reference wave function</span>
 1270 <span class="s2">        for input molecules. It is calculated from number of free radical electrons using</span>
 1271 <span class="s2">        Hund&#39;s rule of maximum multiplicity defined as 2S + 1 where S is the total</span>
 1272 <span class="s2">        electron spin. The total spin is 1/2 the number of free radical electrons in a </span>
 1273 <span class="s2">        molecule. The value of &#39;SpinMultiplicity&#39; molecule property takes precedence</span>
 1274 <span class="s2">        over the calculated value of spin multiplicity.</span>
 1275 <span class="s2">    --recenterAndReorient &lt;yes or no&gt;  [default: yes]</span>
 1276 <span class="s2">        Recenter and reorient a molecule during creation of a Psi4 molecule from</span>
 1277 <span class="s2">        a geometry string.</span>
 1278 <span class="s2">        </span>
 1279 <span class="s2">        The &#39;No&#39; values allows the minimization of a molecule in its initial 3D</span>
 1280 <span class="s2">        coordinate space generated by RDKit.</span>
 1281 <span class="s2">    --symmetrize &lt;yes or no&gt;  [default: auto]</span>
 1282 <span class="s2">        Symmetrize molecules before energy minimization. Default: &#39;Yes&#39; during</span>
 1283 <span class="s2">        &#39;Yes&#39; value of &#39;--recenterAndReorient&#39;; Otherwise, &#39;No&#39;. The psi4 function,</span>
 1284 <span class="s2">        psi4mol.symmetrize( SymmetrizeTolerance), is called to symmetrize</span>
 1285 <span class="s2">        the molecule before calling psi4.optimize().</span>
 1286 <span class="s2">        </span>
 1287 <span class="s2">        The &#39;No&#39; value of &#39;--symmetrize&#39; during &#39;Yes&#39; value of &#39;--recenterAndReorient&#39;</span>
 1288 <span class="s2">        may cause psi4.optimize() to fail with a &#39;Point group changed...&#39; error</span>
 1289 <span class="s2">        message.</span>
 1290 <span class="s2">    --symmetrizeTolerance &lt;number&gt;  [default: 0.01]</span>
 1291 <span class="s2">        Symmetry tolerance for &#39;--symmetrize&#39;.</span>
 1292 <span class="s2">    -w, --workingdir &lt;dir&gt;</span>
 1293 <span class="s2">        Location of working directory which defaults to the current directory.</span>
 1294 
 1295 <span class="s2">Examples:</span>
 1296 <span class="s2">    To generate an initial conformer ensemble of up to 50 conformations using a</span>
 1297 <span class="s2">    combination of ETKDG distance geometry methodology, applying embed RMSD</span>
 1298 <span class="s2">    cutoff of 0.5 and MMFF forcefield minimization, followed by energy minimization</span>
 1299 <span class="s2">    using B3LYP/6-31G** or B3LYP/6-31+G** (sulfur containing), selecting a final set</span>
 1300 <span class="s2">    of minimized conformers for molecules in a SMILES file, applying energy RMSD</span>
 1301 <span class="s2">    cutoff of 0.5 and energy window value value of 20 kcal/mol, and write out a SD</span>
 1302 <span class="s2">    file containing minimized conformers, type:</span>
 1303 
 1304 <span class="s2">        % Psi4GenerateConformers.py -i Psi4Sample.smi -o Psi4SampleOut.sdf</span>
 1305 
 1306 <span class="s2">    To run the first example in a quiet mode and write out a SD file, type:</span>
 1307 
 1308 <span class="s2">        % Psi4GenerateConformers.py -q yes -i Psi4Sample.smi -o</span>
 1309 <span class="s2">          Psi4SampleOut.sdf</span>
 1310 
 1311 <span class="s2">    To run the first example in multiprocessing mode at molecules level on all</span>
 1312 <span class="s2">    available CPUs without loading all data into memory and write out a SD file,</span>
 1313 <span class="s2">    type:</span>
 1314 
 1315 <span class="s2">        % Psi4GenerateConformers.py --mp yes -i Psi4Sample.smi -o</span>
 1316 <span class="s2">          Psi4SampleOut.sdf</span>
 1317 
 1318 <span class="s2">    To run the first example in multiprocessing mode at conformers level on all</span>
 1319 <span class="s2">    available CPUs without loading all data into memory and write out a SD file,</span>
 1320 <span class="s2">    type:</span>
 1321 
 1322 <span class="s2">        % Psi4GenerateConformers.py --mp yes --mpLevel Conformers</span>
 1323 <span class="s2">          -i Psi4Sample.smi -o Psi4SampleOut.sdf</span>
 1324 
 1325 <span class="s2">    To run the first example in multiprocessing mode at molecules level on specific</span>
 1326 <span class="s2">    number of CPUs and chunk size without loading all data into memory and write</span>
 1327 <span class="s2">    out a SD file, type:</span>
 1328 
 1329 <span class="s2">        % Psi4GenerateConformers.py  --mp yes --mpParams &quot;inputDataMode,Lazy,</span>
 1330 <span class="s2">          numProcesses,4,chunkSize,8&quot; -i Psi4Sample.smi -o Psi4SampleOut.sdf</span>
 1331 
 1332 <span class="s2">    To run the first example by using an explicit set of specific parameters, and</span>
 1333 <span class="s2">    write out a SD file, type</span>
 1334 
 1335 <span class="s2">        % Psi4GenerateConformers.py --confParams &quot;confMethod,ETKDG,</span>
 1336 <span class="s2">          forceField,MMFF, forceFieldMMFFVariant,MMFF94s, maxConfs,20,</span>
 1337 <span class="s2">          embedRMSDCutoff,0.25&quot; --energyUnits &quot;kJ/mol&quot; -m B3LYP</span>
 1338 <span class="s2">          -b &quot;6-31+G**&quot; --maxIters 20 -i Psi4Sample.smi -o Psi4SampleOut.sdf</span>
 1339 
 1340 <span class="s2">    To run the first example for molecules in a CSV SMILES file, SMILES strings</span>
 1341 <span class="s2">    in column 1, name column 2, and write out a SD file, type:</span>
 1342 
 1343 <span class="s2">        % Psi4GenerateConformers.py --infileParams &quot;smilesDelimiter,comma,</span>
 1344 <span class="s2">          smilesTitleLine,yes,smilesColumn,1,smilesNameColumn,2&quot;</span>
 1345 <span class="s2">          -i Psi4Sample.csv -o Psi4SampleOut.sdf</span>
 1346 
 1347 <span class="s2">Author:</span>
 1348 
 1349 <span class="s2">    Manish Sud(msud@san.rr.com)</span>
 1350 
 1351 <span class="s2">See also:</span>
 1352 <span class="s2">    Psi4CalculateEnergy.py, Psi4CalculatePartialCharges.py, Psi4PerformMinimization.py</span>
 1353 
 1354 <span class="s2">Copyright:</span>
 1355 <span class="s2">    Copyright (C) 2022 Manish Sud. All rights reserved.</span>
 1356 
 1357 <span class="s2">    The functionality available in this script is implemented using Psi4, an</span>
 1358 <span class="s2">    open source quantum chemistry software package, and RDKit, an open</span>
 1359 <span class="s2">    source toolkit for cheminformatics developed by Greg Landrum.</span>
 1360 
 1361 <span class="s2">    This file is part of MayaChemTools.</span>
 1362 
 1363 <span class="s2">    MayaChemTools is free software; you can redistribute it and/or modify it under</span>
 1364 <span class="s2">    the terms of the GNU Lesser General Public License as published by the Free</span>
 1365 <span class="s2">    Software Foundation; either version 3 of the License, or (at your option) any</span>
 1366 <span class="s2">    later version.</span>
 1367 
 1368 <span class="s2">&quot;&quot;&quot;</span>
 1369 
 1370 <span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
 1371     <span class="n">main</span><span class="p">()</span>
</pre>
<br />
<center>
<img src="../../../images/h2o2.png">
</center>
</body>
</html>
